{"file_contents":{"shared/models/chat.ts":{"content":"import { pgTable, serial, integer, text, timestamp } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\nimport { sql } from \"drizzle-orm\";\n\nexport const conversations = pgTable(\"conversations\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\").notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const messages = pgTable(\"messages\", {\n  id: serial(\"id\").primaryKey(),\n  conversationId: integer(\"conversation_id\").notNull().references(() => conversations.id, { onDelete: \"cascade\" }),\n  role: text(\"role\").notNull(),\n  content: text(\"content\").notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const insertConversationSchema = createInsertSchema(conversations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertMessageSchema = createInsertSchema(messages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Conversation = typeof conversations.$inferSelect;\nexport type InsertConversation = z.infer<typeof insertConversationSchema>;\nexport type Message = typeof messages.$inferSelect;\nexport type InsertMessage = z.infer<typeof insertMessageSchema>;\n\n","path":null,"size_bytes":1229,"size_tokens":null},"client/src/pages/simulations.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useSearch } from \"wouter\";\nimport { Calculator, PlayCircle, Save, Download, Trophy, Users } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Accordion,\n  AccordionContent,\n  AccordionItem,\n  AccordionTrigger,\n} from \"@/components/ui/accordion\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Scenario, Party, Candidate, SimulationResult, PartyResult } from \"@shared/schema\";\nimport { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from \"recharts\";\n\ntype VoteInput = { partyId: number; votes: number; candidates: { candidateId: number; votes: number }[] };\n\nexport default function Simulations() {\n  const search = useSearch();\n  const params = new URLSearchParams(search);\n  const scenarioParam = params.get(\"scenario\");\n\n  const { toast } = useToast();\n  const [selectedScenarioId, setSelectedScenarioId] = useState<string>(scenarioParam || \"\");\n  const [partyVotes, setPartyVotes] = useState<Record<number, number>>({});\n  const [candidateVotes, setCandidateVotes] = useState<Record<number, number>>({});\n  const [simulationResult, setSimulationResult] = useState<SimulationResult | null>(null);\n  const [isCalculating, setIsCalculating] = useState(false);\n\n  const { data: scenarios } = useQuery<Scenario[]>({\n    queryKey: [\"/api/scenarios\"],\n  });\n\n  const { data: parties } = useQuery<Party[]>({\n    queryKey: [\"/api/parties\"],\n  });\n\n  const { data: candidates } = useQuery<Candidate[]>({\n    queryKey: [\"/api/candidates\"],\n  });\n\n  const selectedScenario = scenarios?.find((s) => s.id === parseInt(selectedScenarioId));\n\n  const candidatesByParty = useMemo(() => {\n    if (!candidates || !parties) return {};\n    const grouped: Record<number, Candidate[]> = {};\n    parties.forEach((p) => {\n      grouped[p.id] = candidates.filter((c) => c.partyId === p.id);\n    });\n    return grouped;\n  }, [candidates, parties]);\n\n  function calculateElectoralQuotient(validVotes: number, seats: number): number {\n    return Math.floor(validVotes / seats);\n  }\n\n  async function calculateSimulation() {\n    if (!selectedScenario || !parties) return;\n\n    setIsCalculating(true);\n\n    try {\n      const response = await apiRequest(\"POST\", \"/api/electoral/calculate\", {\n        scenarioId: parseInt(selectedScenarioId),\n        partyVotes,\n        candidateVotes,\n      });\n      \n      const result = response as unknown as SimulationResult;\n      setSimulationResult({\n        ...result,\n        partyResults: result.partyResults ?? [],\n      });\n      toast({ title: \"Simulação concluída\", description: \"Os resultados foram calculados com sucesso\" });\n    } catch (error) {\n      toast({ title: \"Erro\", description: \"Falha ao calcular simulação\", variant: \"destructive\" });\n    } finally {\n      setIsCalculating(false);\n    }\n  }\n\n  const saveMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/simulations\", {\n        scenarioId: parseInt(selectedScenarioId),\n        name: `Simulação - ${new Date().toLocaleString(\"pt-BR\")}`,\n        electoralQuotient: simulationResult?.electoralQuotient,\n        results: simulationResult,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/simulations/recent\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      toast({ title: \"Sucesso\", description: \"Simulação salva com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao salvar simulação\", variant: \"destructive\" });\n    },\n  });\n\n  const chartData = (simulationResult?.partyResults ?? []).map((pr) => ({\n    name: (pr as any).abbreviation || pr.partyName.substring(0, 5),\n    vagas: pr.totalSeats,\n    votos: pr.totalVotes,\n    color: (pr as any).color || \"#003366\",\n  }));\n\n  return (\n    <div className=\"space-y-6\">\n      <PageHeader\n        title=\"Simulação Eleitoral\"\n        description=\"Execute simulações do sistema proporcional brasileiro\"\n        breadcrumbs={[\n          { label: \"Dashboard\", href: \"/\" },\n          { label: \"Simulações\" },\n        ]}\n      />\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Calculator className=\"h-5 w-5\" />\n            Configurar Simulação\n          </CardTitle>\n          <CardDescription>\n            Selecione um cenário e insira os votos para cada partido\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Cenário Eleitoral</Label>\n              <Select value={selectedScenarioId} onValueChange={setSelectedScenarioId}>\n                <SelectTrigger data-testid=\"select-simulation-scenario\">\n                  <SelectValue placeholder=\"Selecione um cenário\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {scenarios?.map((s) => (\n                    <SelectItem key={s.id} value={String(s.id)}>\n                      {s.name} ({s.availableSeats} vagas)\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            {selectedScenario && (\n              <>\n                <div className=\"space-y-2\">\n                  <Label>Quociente Eleitoral</Label>\n                  <div className=\"p-3 bg-muted rounded-md\">\n                    <span className=\"text-2xl font-mono font-bold\">\n                      {calculateElectoralQuotient(selectedScenario.validVotes, selectedScenario.availableSeats).toLocaleString(\"pt-BR\")}\n                    </span>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      {selectedScenario.validVotes.toLocaleString(\"pt-BR\")} votos / {selectedScenario.availableSeats} vagas\n                    </p>\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Vagas Disponíveis</Label>\n                  <div className=\"p-3 bg-muted rounded-md\">\n                    <span className=\"text-2xl font-mono font-bold\">{selectedScenario.availableSeats}</span>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      Total de vagas a serem preenchidas\n                    </p>\n                  </div>\n                </div>\n              </>\n            )}\n          </div>\n\n          {selectedScenario && parties && parties.length > 0 && (\n            <Accordion type=\"multiple\" className=\"w-full\">\n              {parties.map((party) => (\n                <AccordionItem key={party.id} value={`party-${party.id}`}>\n                  <AccordionTrigger className=\"hover:no-underline\">\n                    <div className=\"flex items-center gap-3 w-full\">\n                      <div\n                        className=\"w-4 h-4 rounded-full shrink-0\"\n                        style={{ backgroundColor: party.color }}\n                      />\n                      <Badge variant=\"outline\">{party.abbreviation}</Badge>\n                      <span className=\"flex-1 text-left\">{party.name}</span>\n                      <span className=\"font-mono text-muted-foreground mr-4\">\n                        {(partyVotes[party.id] || 0).toLocaleString(\"pt-BR\")} votos\n                      </span>\n                    </div>\n                  </AccordionTrigger>\n                  <AccordionContent>\n                    <div className=\"space-y-4 pt-4\">\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <div className=\"space-y-2\">\n                          <Label>Votos de Legenda</Label>\n                          <Input\n                            type=\"number\"\n                            placeholder=\"0\"\n                            value={partyVotes[party.id] || \"\"}\n                            onChange={(e) => setPartyVotes((prev) => ({\n                              ...prev,\n                              [party.id]: parseInt(e.target.value) || 0,\n                            }))}\n                            className=\"font-mono\"\n                            data-testid={`input-party-votes-${party.id}`}\n                          />\n                        </div>\n                      </div>\n                      {candidatesByParty[party.id]?.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <Label className=\"text-sm\">Votos por Candidato</Label>\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3\">\n                            {candidatesByParty[party.id].map((candidate) => (\n                              <div key={candidate.id} className=\"flex items-center gap-2 p-2 border rounded-md\">\n                                <div className=\"flex-1 min-w-0\">\n                                  <p className=\"text-sm font-medium truncate\">\n                                    {candidate.nickname || candidate.name}\n                                  </p>\n                                  <p className=\"text-xs text-muted-foreground font-mono\">\n                                    #{candidate.number}\n                                  </p>\n                                </div>\n                                <Input\n                                  type=\"number\"\n                                  placeholder=\"0\"\n                                  value={candidateVotes[candidate.id] || \"\"}\n                                  onChange={(e) => setCandidateVotes((prev) => ({\n                                    ...prev,\n                                    [candidate.id]: parseInt(e.target.value) || 0,\n                                  }))}\n                                  className=\"w-24 font-mono text-sm\"\n                                  data-testid={`input-candidate-votes-${candidate.id}`}\n                                />\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </AccordionContent>\n                </AccordionItem>\n              ))}\n            </Accordion>\n          )}\n\n          <div className=\"flex gap-3 pt-4 border-t\">\n            <Button\n              onClick={calculateSimulation}\n              disabled={!selectedScenarioId || isCalculating}\n              className=\"bg-accent text-accent-foreground\"\n              data-testid=\"button-calculate-simulation\"\n            >\n              {isCalculating ? (\n                <>Calculando...</>\n              ) : (\n                <>\n                  <PlayCircle className=\"h-4 w-4 mr-2\" />\n                  Calcular Resultados\n                </>\n              )}\n            </Button>\n            {simulationResult && (\n              <>\n                <Button\n                  variant=\"outline\"\n                  onClick={() => saveMutation.mutate()}\n                  disabled={saveMutation.isPending}\n                  data-testid=\"button-save-simulation\"\n                >\n                  <Save className=\"h-4 w-4 mr-2\" />\n                  Salvar Simulação\n                </Button>\n                <Button variant=\"outline\" data-testid=\"button-export-simulation\">\n                  <Download className=\"h-4 w-4 mr-2\" />\n                  Exportar\n                </Button>\n              </>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      {simulationResult && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Trophy className=\"h-5 w-5 text-accent\" />\n              Resultados da Simulação\n            </CardTitle>\n            <CardDescription>\n              Distribuição de vagas pelo sistema proporcional brasileiro\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6\">\n              <div className=\"p-4 bg-primary/10 rounded-lg text-center\">\n                <p className=\"text-3xl font-mono font-bold text-primary\">\n                  {simulationResult.electoralQuotient.toLocaleString(\"pt-BR\")}\n                </p>\n                <p className=\"text-sm text-muted-foreground\">Quociente Eleitoral</p>\n              </div>\n              <div className=\"p-4 bg-muted rounded-lg text-center\">\n                <p className=\"text-3xl font-mono font-bold\">\n                  {simulationResult.totalValidVotes.toLocaleString(\"pt-BR\")}\n                </p>\n                <p className=\"text-sm text-muted-foreground\">Votos Válidos</p>\n              </div>\n              <div className=\"p-4 bg-success/10 rounded-lg text-center\">\n                <p className=\"text-3xl font-mono font-bold text-success\">\n                  {simulationResult.seatsDistributedByQuotient}\n                </p>\n                <p className=\"text-sm text-muted-foreground\">Vagas por Quociente</p>\n              </div>\n              <div className=\"p-4 bg-accent/10 rounded-lg text-center\">\n                <p className=\"text-3xl font-mono font-bold text-accent-foreground\">\n                  {simulationResult.seatsDistributedByRemainder}\n                </p>\n                <p className=\"text-sm text-muted-foreground\">Vagas por Sobras</p>\n              </div>\n            </div>\n\n            <Tabs defaultValue=\"table\" className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-3\">\n                <TabsTrigger value=\"table\" data-testid=\"tab-results-table\">Tabela</TabsTrigger>\n                <TabsTrigger value=\"chart\" data-testid=\"tab-results-chart\">Gráfico</TabsTrigger>\n                <TabsTrigger value=\"elected\" data-testid=\"tab-results-elected\">Eleitos</TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"table\" className=\"mt-4\">\n                <div className=\"rounded-md border\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead className=\"w-12\">#</TableHead>\n                        <TableHead>Partido</TableHead>\n                        <TableHead className=\"text-right\">Votos</TableHead>\n                        <TableHead className=\"text-right\">Quociente</TableHead>\n                        <TableHead className=\"text-right\">Vagas QE</TableHead>\n                        <TableHead className=\"text-right\">Vagas Sobras</TableHead>\n                        <TableHead className=\"text-right\">Total</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {(simulationResult.partyResults ?? []).map((pr, idx) => (\n                        <TableRow key={pr.partyId}>\n                          <TableCell className=\"font-mono\">{idx + 1}</TableCell>\n                          <TableCell>\n                            <div className=\"flex items-center gap-2\">\n                              <div\n                                className=\"w-3 h-3 rounded-full shrink-0\"\n                                style={{ backgroundColor: (pr as any).color || \"#003366\" }}\n                              />\n                              <Badge variant=\"outline\">{(pr as any).abbreviation || pr.partyName}</Badge>\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            {pr.totalVotes.toLocaleString(\"pt-BR\")}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            {pr.partyQuotient.toFixed(2)}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono font-bold text-success\">\n                            {pr.seatsFromQuotient}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono font-bold text-accent-foreground\">\n                            {pr.seatsFromRemainder}\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            <Badge className=\"font-mono text-lg\">{pr.totalSeats}</Badge>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"chart\" className=\"mt-4\">\n                <div className=\"h-80\">\n                  <ResponsiveContainer width=\"100%\" height=\"100%\">\n                    <BarChart data={chartData} layout=\"vertical\">\n                      <XAxis type=\"number\" />\n                      <YAxis type=\"category\" dataKey=\"name\" width={60} tick={{ fontSize: 12 }} />\n                      <Tooltip\n                        formatter={(value: number, name: string) => [\n                          name === \"vagas\" ? `${value} vagas` : value.toLocaleString(\"pt-BR\") + \" votos\",\n                          name === \"vagas\" ? \"Vagas\" : \"Votos\",\n                        ]}\n                        contentStyle={{\n                          backgroundColor: \"hsl(var(--card))\",\n                          border: \"1px solid hsl(var(--border))\",\n                          borderRadius: \"var(--radius)\",\n                        }}\n                      />\n                      <Bar dataKey=\"vagas\" name=\"Vagas\" radius={[0, 4, 4, 0]}>\n                        {chartData.map((entry, index) => (\n                          <Cell key={`cell-${index}`} fill={entry.color} />\n                        ))}\n                      </Bar>\n                    </BarChart>\n                  </ResponsiveContainer>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"elected\" className=\"mt-4\">\n                <div className=\"space-y-4\">\n                  {(simulationResult.partyResults ?? []).filter((pr) => pr.totalSeats > 0).map((pr) => (\n                    <div key={pr.partyId} className=\"border rounded-lg p-4\">\n                      <div className=\"flex items-center gap-2 mb-3\">\n                        <div\n                          className=\"w-4 h-4 rounded-full\"\n                          style={{ backgroundColor: (pr as any).color || \"#003366\" }}\n                        />\n                        <h4 className=\"font-semibold\">{pr.partyName}</h4>\n                        <Badge>{pr.totalSeats} {pr.totalSeats === 1 ? \"vaga\" : \"vagas\"}</Badge>\n                      </div>\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2\">\n                        {pr.electedCandidates.filter((c) => c.elected).map((c) => (\n                          <div\n                            key={c.candidateId}\n                            className=\"flex items-center gap-2 p-2 bg-success/10 rounded-md\"\n                          >\n                            <Trophy className=\"h-4 w-4 text-success shrink-0\" />\n                            <div className=\"flex-1 min-w-0\">\n                              <p className=\"font-medium truncate\">{c.name}</p>\n                              <p className=\"text-xs text-muted-foreground font-mono\">\n                                {c.votes.toLocaleString(\"pt-BR\")} votos\n                              </p>\n                            </div>\n                            <Badge variant=\"outline\" className=\"font-mono\">\n                              #{c.position}\n                            </Badge>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      )}\n\n      {!selectedScenarioId && (\n        <Card>\n          <CardContent className=\"p-6\">\n            <EmptyState\n              icon={Calculator}\n              title=\"Selecione um cenário\"\n              description=\"Para iniciar uma simulação, selecione um cenário eleitoral previamente configurado.\"\n            />\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":21098,"size_tokens":null},"scripts/build-production.sh":{"content":"#!/bin/bash\nset -e\n\necho \"=========================================\"\necho \"SimulaVoto - Production Build Script\"\necho \"=========================================\"\n\necho \"\"\necho \"[1/4] Installing dependencies...\"\nnpm ci\n\necho \"\"\necho \"[2/4] Type checking...\"\nnpm run check\n\necho \"\"\necho \"[3/4] Building application...\"\nnpm run build\n\necho \"\"\necho \"[4/4] Verifying build...\"\nif [ -f \"dist/index.cjs\" ]; then\n  echo \"✅ Build successful! Output: dist/index.cjs\"\nelse\n  echo \"❌ Build failed: dist/index.cjs not found\"\n  exit 1\nfi\n\necho \"\"\necho \"=========================================\"\necho \"Build completed successfully!\"\necho \"=========================================\"\necho \"\"\necho \"To run the production server:\"\necho \"  NODE_ENV=production npm start\"\necho \"\"\necho \"Or with Docker Compose:\"\necho \"  docker compose up -d --build\"\n","path":null,"size_bytes":833,"size_tokens":null},"client/src/pages/dashboard.tsx":{"content":"import { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { \n  Building2, Users, FileText, PlayCircle, TrendingUp, Calendar, \n  Brain, BarChart3, MessageSquareText, Target, Sparkles, ChevronRight,\n  Activity, AlertTriangle, HelpCircle, RefreshCw, Clock, TrendingDown\n} from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { StatsCard } from \"@/components/stats-card\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Link } from \"wouter\";\nimport type { Scenario, Party, Simulation } from \"@shared/schema\";\nimport { BarChart, Bar, XAxis, YAxis, Tooltip as RechartsTooltip, ResponsiveContainer, PieChart, Pie, Cell, LineChart, Line } from \"recharts\";\nimport { BrazilMap } from \"@/components/brazil-map\";\nimport { useState, useEffect } from \"react\";\n\ninterface MetricTooltipProps {\n  children: React.ReactNode;\n  content: string;\n}\n\nfunction MetricTooltip({ children, content }: MetricTooltipProps) {\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>\n        <span className=\"inline-flex items-center gap-1 cursor-help\">\n          {children}\n          <HelpCircle className=\"h-3.5 w-3.5 text-muted-foreground/60\" />\n        </span>\n      </TooltipTrigger>\n      <TooltipContent side=\"top\" className=\"max-w-xs text-sm\">\n        {content}\n      </TooltipContent>\n    </Tooltip>\n  );\n}\n\ninterface UpdateBadgeProps {\n  label: string;\n  isNew?: boolean;\n  timestamp?: Date | null;\n}\n\nfunction UpdateBadge({ label, isNew, timestamp }: UpdateBadgeProps) {\n  const [pulse, setPulse] = useState(isNew);\n  \n  useEffect(() => {\n    if (isNew) {\n      const timer = setTimeout(() => setPulse(false), 5000);\n      return () => clearTimeout(timer);\n    }\n  }, [isNew]);\n\n  return (\n    <Badge \n      variant={isNew ? \"default\" : \"secondary\"} \n      className={`text-xs ${pulse ? \"animate-pulse\" : \"\"}`}\n    >\n      {isNew && <Activity className=\"h-3 w-3 mr-1\" />}\n      {label}\n      {timestamp && (\n        <span className=\"ml-1 opacity-70\">\n          {new Date(timestamp).toLocaleTimeString(\"pt-BR\", { hour: \"2-digit\", minute: \"2-digit\" })}\n        </span>\n      )}\n    </Badge>\n  );\n}\n\ninterface AIFeatureCardProps {\n  title: string;\n  description: string;\n  icon: React.ElementType;\n  href: string;\n  gradient: string;\n  badge?: string;\n  testId: string;\n}\n\nfunction AIFeatureCard({ title, description, icon: Icon, href, gradient, badge, testId }: AIFeatureCardProps) {\n  return (\n    <Link href={href} data-testid={testId}>\n      <Card className=\"hover-elevate cursor-pointer h-full\">\n        <CardContent className=\"p-5\">\n          <div className=\"flex items-start gap-4\">\n            <div className={`flex h-12 w-12 shrink-0 items-center justify-center rounded-lg ${gradient}`}>\n              <Icon className=\"h-6 w-6 text-white\" />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-2 mb-1\">\n                <h3 className=\"font-semibold truncate\">{title}</h3>\n                {badge && (\n                  <Badge variant=\"outline\" className=\"text-xs shrink-0\">\n                    {badge}\n                  </Badge>\n                )}\n              </div>\n              <p className=\"text-sm text-muted-foreground line-clamp-2\">{description}</p>\n            </div>\n            <ChevronRight className=\"h-5 w-5 text-muted-foreground shrink-0\" />\n          </div>\n        </CardContent>\n      </Card>\n    </Link>\n  );\n}\n\ninterface SentimentEntity {\n  name: string;\n  sentiment: number;\n  type?: string;\n}\n\nexport default function Dashboard() {\n  const { user } = useAuth();\n  const queryClient = useQueryClient();\n  const [lastRefresh, setLastRefresh] = useState<Date>(new Date());\n  const [isRefreshing, setIsRefreshing] = useState(false);\n\n  const { data: stats, isLoading: statsLoading } = useQuery<{\n    parties: number;\n    candidates: number;\n    scenarios: number;\n    simulations: number;\n  }>({\n    queryKey: [\"/api/stats\"],\n    refetchInterval: 30000,\n  });\n\n  const { data: recentScenarios, isLoading: scenariosLoading } = useQuery<Scenario[]>({\n    queryKey: [\"/api/scenarios\"],\n    refetchInterval: 30000,\n  });\n\n  const { data: recentSimulations, isLoading: simulationsLoading } = useQuery<Simulation[]>({\n    queryKey: [\"/api/simulations/recent\"],\n    refetchInterval: 30000,\n  });\n\n  const { data: parties } = useQuery<Party[]>({\n    queryKey: [\"/api/parties\"],\n  });\n\n  // Fetch real party votes data from TSE imports\n  const { data: partyVotes } = useQuery<{\n    party: string;\n    partyNumber: number | null;\n    votes: number;\n    candidateCount: number;\n  }[]>({\n    queryKey: [\"/api/analytics/votes-by-party\"],\n    refetchInterval: 60000,\n  });\n\n  const { data: sentimentData } = useQuery<{ entities: SentimentEntity[] }>({\n    queryKey: [\"/api/sentiment/summary\"],\n    refetchInterval: 60000,\n  });\n\n  const { data: crisisAlerts } = useQuery<{ unacknowledged: number }>({\n    queryKey: [\"/api/sentiment/alerts/count\"],\n    refetchInterval: 30000,\n  });\n\n  // Fetch real activity trend data (scenarios and simulations per day)\n  const { data: activityTrend } = useQuery<{ day: string; simulacoes: number; cenarios: number }[]>({\n    queryKey: [\"/api/activity-trend\"],\n    refetchInterval: 60000,\n  });\n\n  const handleRefresh = async () => {\n    setIsRefreshing(true);\n    await queryClient.invalidateQueries({\n      predicate: (query) => {\n        const key = query.queryKey[0];\n        return typeof key === 'string' && (\n          key === '/api/stats' ||\n          key === '/api/scenarios' ||\n          key === '/api/simulations/recent' ||\n          key === '/api/parties' ||\n          key === '/api/analytics/votes-by-party' ||\n          key === '/api/activity-trend' ||\n          key === '/api/sentiment/summary' ||\n          key === '/api/sentiment/alerts/count'\n        );\n      }\n    });\n    setLastRefresh(new Date());\n    setIsRefreshing(false);\n  };\n\n  const chartColors = [\n    \"hsl(210, 100%, 20%)\",\n    \"hsl(45, 100%, 50%)\",\n    \"hsl(145, 63%, 42%)\",\n    \"hsl(4, 84%, 49%)\",\n    \"hsl(280, 60%, 40%)\",\n    \"hsl(200, 80%, 50%)\",\n    \"hsl(30, 90%, 50%)\",\n    \"hsl(320, 70%, 50%)\",\n  ];\n\n  // Use real party votes data from TSE imports\n  const partyChartData = partyVotes?.slice(0, 8).map((pv, i) => {\n    // Try to find matching party for color\n    const matchingParty = parties?.find(p => p.abbreviation === pv.party || p.number === pv.partyNumber);\n    return {\n      name: pv.party,\n      value: pv.votes,\n      color: matchingParty?.color || chartColors[i % chartColors.length],\n    };\n  }) || [];\n\n  // Use real activity trend data from API\n  const trendData = activityTrend || [];\n\n  const aiFeatures = [\n    {\n      title: \"Previsão de Resultados\",\n      description: \"Análise preditiva com Monte Carlo e machine learning para projetar resultados eleitorais\",\n      icon: BarChart3,\n      href: \"/predictions\",\n      gradient: \"bg-gradient-to-br from-blue-500 to-blue-700\",\n      badge: \"GPT-4o\",\n      testId: \"card-ai-predictions\"\n    },\n    {\n      title: \"Análise de Sentimento\",\n      description: \"Monitoramento de sentimento em tempo real com detecção automática de crises\",\n      icon: MessageSquareText,\n      href: \"/sentiment-analysis\",\n      gradient: \"bg-gradient-to-br from-purple-500 to-purple-700\",\n      badge: crisisAlerts?.unacknowledged ? `${crisisAlerts.unacknowledged} alertas` : undefined,\n      testId: \"card-ai-sentiment\"\n    },\n    {\n      title: \"Simulador de Cenários\",\n      description: \"Crie e compare cenários eleitorais com distribuição proporcional D'Hondt\",\n      icon: Target,\n      href: \"/simulations\",\n      gradient: \"bg-gradient-to-br from-green-500 to-green-700\",\n      testId: \"card-ai-simulator\"\n    },\n    {\n      title: \"Estrategista de Campanha\",\n      description: \"Identificação de segmentos de alto impacto e estratégias de comunicação com IA\",\n      icon: Sparkles,\n      href: \"/campaign-insights\",\n      gradient: \"bg-gradient-to-br from-amber-500 to-orange-600\",\n      badge: \"Novo\",\n      testId: \"card-ai-campaign\"\n    },\n  ];\n\n  return (\n    <div className=\"space-y-8\">\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n        <PageHeader\n          title={`Bem-vindo, ${user?.name.split(\" \")[0] || \"Usuário\"}`}\n          description=\"Painel de controle do sistema de simulação eleitoral\"\n        />\n        <div className=\"flex items-center gap-2\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={handleRefresh}\n                disabled={isRefreshing}\n                data-testid=\"button-refresh-dashboard\"\n              >\n                <RefreshCw className={`h-4 w-4 mr-2 ${isRefreshing ? \"animate-spin\" : \"\"}`} />\n                Atualizar\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>\n              Última atualização: {lastRefresh.toLocaleTimeString(\"pt-BR\")}\n            </TooltipContent>\n          </Tooltip>\n          <Badge variant=\"outline\" className=\"hidden sm:flex items-center gap-1\" data-testid=\"badge-auto-refresh\">\n            <Clock className=\"h-3 w-3\" />\n            Auto-refresh: 30s\n          </Badge>\n        </div>\n      </div>\n\n      <section aria-label=\"Estatísticas principais\">\n        <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4\">\n          {statsLoading ? (\n            Array.from({ length: 4 }).map((_, i) => (\n              <Card key={i}>\n                <CardContent className=\"p-6\">\n                  <Skeleton className=\"h-20 w-full\" />\n                </CardContent>\n              </Card>\n            ))\n          ) : (\n            <>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div data-testid=\"stat-parties\">\n                    <StatsCard\n                      title=\"Partidos\"\n                      value={stats?.parties || 0}\n                      description=\"Partidos cadastrados\"\n                      icon={Building2}\n                    />\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  Total de partidos políticos registrados no sistema, incluindo federações e coligações\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div data-testid=\"stat-candidates\">\n                    <StatsCard\n                      title=\"Candidatos\"\n                      value={stats?.candidates || 0}\n                      description=\"Candidatos registrados\"\n                      icon={Users}\n                    />\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  Total de candidatos cadastrados, vinculados a partidos e elegíveis para simulações\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div data-testid=\"stat-scenarios\">\n                    <StatsCard\n                      title=\"Cenários\"\n                      value={stats?.scenarios || 0}\n                      description=\"Cenários eleitorais\"\n                      icon={FileText}\n                    />\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  Cenários eleitorais configurados com número de vagas, zona eleitoral e regras específicas\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div data-testid=\"stat-simulations\">\n                    <StatsCard\n                      title=\"Simulações\"\n                      value={stats?.simulations || 0}\n                      description=\"Simulações realizadas\"\n                      icon={PlayCircle}\n                    />\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  Número total de simulações executadas usando o método proporcional D'Hondt\n                </TooltipContent>\n              </Tooltip>\n            </>\n          )}\n        </div>\n      </section>\n\n      <section aria-label=\"IA Avançada\" className=\"space-y-4\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-gradient-to-br from-primary to-primary/70\">\n            <Brain className=\"h-5 w-5 text-primary-foreground\" />\n          </div>\n          <div>\n            <h2 className=\"text-xl font-semibold\">IA Avançada</h2>\n            <p className=\"text-sm text-muted-foreground\">Recursos de inteligência artificial para análise eleitoral</p>\n          </div>\n          {crisisAlerts?.unacknowledged && crisisAlerts.unacknowledged > 0 && (\n            <Badge variant=\"destructive\" className=\"ml-auto animate-pulse\">\n              <AlertTriangle className=\"h-3 w-3 mr-1\" />\n              {crisisAlerts.unacknowledged} alerta{crisisAlerts.unacknowledged > 1 ? \"s\" : \"\"} pendente{crisisAlerts.unacknowledged > 1 ? \"s\" : \"\"}\n            </Badge>\n          )}\n        </div>\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n          {aiFeatures.map((feature) => (\n            <AIFeatureCard key={feature.href} {...feature} />\n          ))}\n        </div>\n        \n        {sentimentData?.entities && sentimentData.entities.length > 0 && (\n          <Card data-testid=\"card-sentiment-summary\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n                <div className=\"flex items-center gap-2\">\n                  <MessageSquareText className=\"h-5 w-5 text-purple-500\" />\n                  <CardTitle className=\"text-base\">Resumo de Sentimento</CardTitle>\n                </div>\n                <Button variant=\"ghost\" size=\"sm\" asChild>\n                  <Link href=\"/sentiment-analysis\" data-testid=\"link-sentiment-details\">Ver detalhes</Link>\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex flex-wrap gap-3\">\n                {sentimentData.entities.slice(0, 6).map((entity, idx) => (\n                  <div \n                    key={idx} \n                    className=\"flex items-center gap-2 px-3 py-2 rounded-md border bg-muted/30\"\n                    data-testid={`sentiment-entity-${idx}`}\n                  >\n                    <span className=\"font-medium text-sm\">{entity.name}</span>\n                    <Badge \n                      variant={entity.sentiment >= 0.5 ? \"default\" : entity.sentiment >= 0 ? \"secondary\" : \"destructive\"}\n                      className=\"text-xs\"\n                    >\n                      {entity.sentiment >= 0.5 ? (\n                        <TrendingUp className=\"h-3 w-3 mr-1\" />\n                      ) : entity.sentiment < 0 ? (\n                        <TrendingDown className=\"h-3 w-3 mr-1\" />\n                      ) : null}\n                      {(entity.sentiment * 100).toFixed(0)}%\n                    </Badge>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </section>\n\n      <section aria-label=\"Visualizações\" className=\"space-y-6\">\n        <div className=\"grid grid-cols-1 xl:grid-cols-3 gap-6\">\n          <div className=\"xl:col-span-1\">\n            <BrazilMap />\n          </div>\n          <Card className=\"xl:col-span-2\" data-testid=\"chart-votes-distribution\">\n            <CardHeader className=\"flex flex-row items-center justify-between gap-4 flex-wrap\">\n              <div className=\"flex items-center gap-2\">\n                <div>\n                  <MetricTooltip content=\"Distribuição de votos por partido com base nos dados importados do TSE. Valores reais das eleições.\">\n                    <CardTitle className=\"text-lg\">Distribuição de Votos por Partido</CardTitle>\n                  </MetricTooltip>\n                  <CardDescription>Dados reais importados do TSE</CardDescription>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <UpdateBadge label=\"Dados TSE\" />\n                <TrendingUp className=\"h-5 w-5 text-muted-foreground\" />\n              </div>\n            </CardHeader>\n            <CardContent>\n              {partyChartData.length > 0 ? (\n                <div className=\"h-64\">\n                  <ResponsiveContainer width=\"100%\" height=\"100%\">\n                    <BarChart data={partyChartData}>\n                      <XAxis dataKey=\"name\" tick={{ fontSize: 12 }} />\n                      <YAxis tick={{ fontSize: 12 }} tickFormatter={(v) => `${(v / 1000).toFixed(0)}k`} />\n                      <RechartsTooltip\n                        formatter={(value: number) => [value.toLocaleString(\"pt-BR\"), \"Votos\"]}\n                        contentStyle={{\n                          backgroundColor: \"hsl(var(--card))\",\n                          border: \"1px solid hsl(var(--border))\",\n                          borderRadius: \"var(--radius)\",\n                        }}\n                      />\n                      <Bar dataKey=\"value\" radius={[4, 4, 0, 0]}>\n                        {partyChartData.map((entry, index) => (\n                          <Cell key={`cell-${index}`} fill={entry.color} />\n                        ))}\n                      </Bar>\n                    </BarChart>\n                  </ResponsiveContainer>\n                </div>\n              ) : (\n                <div className=\"h-64 flex items-center justify-center text-muted-foreground\">\n                  Cadastre partidos para ver a visualização\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          <Card data-testid=\"chart-seats-distribution\">\n            <CardHeader className=\"flex flex-row items-center justify-between gap-4 flex-wrap\">\n              <div>\n                <MetricTooltip content=\"Gráfico de pizza mostrando a distribuição proporcional de vagas entre os partidos, calculada pelo método D'Hondt conforme legislação eleitoral brasileira.\">\n                  <CardTitle className=\"text-lg\">Distribuição de Vagas</CardTitle>\n                </MetricTooltip>\n                <CardDescription>Simulação da distribuição proporcional</CardDescription>\n              </div>\n              <UpdateBadge label=\"D'Hondt\" />\n            </CardHeader>\n            <CardContent>\n              {partyChartData.length > 0 ? (\n                <div className=\"h-64 flex items-center justify-center\">\n                  <ResponsiveContainer width=\"100%\" height=\"100%\">\n                    <PieChart>\n                      <Pie\n                        data={partyChartData}\n                        cx=\"50%\"\n                        cy=\"50%\"\n                        innerRadius={60}\n                        outerRadius={90}\n                        paddingAngle={2}\n                        dataKey=\"value\"\n                        label={({ name }) => name}\n                        labelLine={false}\n                      >\n                        {partyChartData.map((entry, index) => (\n                          <Cell key={`cell-${index}`} fill={entry.color} />\n                        ))}\n                      </Pie>\n                      <RechartsTooltip\n                        formatter={(value: number) => [value.toLocaleString(\"pt-BR\"), \"Votos\"]}\n                        contentStyle={{\n                          backgroundColor: \"hsl(var(--card))\",\n                          border: \"1px solid hsl(var(--border))\",\n                          borderRadius: \"var(--radius)\",\n                        }}\n                      />\n                    </PieChart>\n                  </ResponsiveContainer>\n                </div>\n              ) : (\n                <div className=\"h-64 flex items-center justify-center text-muted-foreground\">\n                  Cadastre partidos para ver a visualização\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"chart-activity\">\n            <CardHeader className=\"flex flex-row items-center justify-between gap-4 flex-wrap\">\n              <div>\n                <MetricTooltip content=\"Tendência de atividade no sistema nos últimos 7 dias, mostrando o volume de simulações e cenários criados por dia. Dados reais do banco de dados.\">\n                  <CardTitle className=\"text-lg\">Atividade Recente</CardTitle>\n                </MetricTooltip>\n                <CardDescription>Simulações e cenários nos últimos 7 dias</CardDescription>\n              </div>\n              <UpdateBadge label=\"Dados reais\" isNew={false} timestamp={lastRefresh} />\n            </CardHeader>\n            <CardContent>\n              {trendData.length > 0 ? (\n                <div className=\"h-64\">\n                  <ResponsiveContainer width=\"100%\" height=\"100%\">\n                    <LineChart data={trendData}>\n                      <XAxis dataKey=\"day\" tick={{ fontSize: 12 }} />\n                      <YAxis tick={{ fontSize: 12 }} />\n                      <RechartsTooltip\n                        contentStyle={{\n                          backgroundColor: \"hsl(var(--card))\",\n                          border: \"1px solid hsl(var(--border))\",\n                          borderRadius: \"var(--radius)\",\n                        }}\n                      />\n                      <Line \n                        type=\"monotone\" \n                        dataKey=\"simulacoes\" \n                        stroke=\"hsl(210, 100%, 40%)\" \n                        strokeWidth={2}\n                        dot={{ fill: \"hsl(210, 100%, 40%)\" }}\n                        name=\"Simulações\"\n                      />\n                      <Line \n                        type=\"monotone\" \n                        dataKey=\"cenarios\" \n                        stroke=\"hsl(45, 100%, 45%)\" \n                        strokeWidth={2}\n                        dot={{ fill: \"hsl(45, 100%, 45%)\" }}\n                        name=\"Cenários\"\n                      />\n                    </LineChart>\n                  </ResponsiveContainer>\n                </div>\n              ) : (\n                <div className=\"h-64 flex items-center justify-center text-muted-foreground\">\n                  Carregando dados de atividade...\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </section>\n\n      <section aria-label=\"Dados Recentes\" className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card data-testid=\"card-recent-scenarios\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-4 flex-wrap\">\n            <div>\n              <CardTitle className=\"text-lg\">Cenários Recentes</CardTitle>\n              <CardDescription>Últimos cenários eleitorais criados</CardDescription>\n            </div>\n            <Button variant=\"outline\" size=\"sm\" asChild>\n              <Link href=\"/scenarios\" data-testid=\"link-view-scenarios\">Ver todos</Link>\n            </Button>\n          </CardHeader>\n          <CardContent>\n            {scenariosLoading ? (\n              <div className=\"space-y-3\">\n                {Array.from({ length: 3 }).map((_, i) => (\n                  <Skeleton key={i} className=\"h-16 w-full\" />\n                ))}\n              </div>\n            ) : recentScenarios && recentScenarios.length > 0 ? (\n              <div className=\"space-y-3\">\n                {recentScenarios.slice(0, 5).map((scenario) => (\n                  <div\n                    key={scenario.id}\n                    className=\"flex items-center justify-between p-3 rounded-md border hover-elevate gap-2\"\n                    data-testid={`row-scenario-${scenario.id}`}\n                  >\n                    <div className=\"flex flex-col gap-1 min-w-0\">\n                      <span className=\"font-medium truncate\" data-testid={`text-scenario-name-${scenario.id}`}>{scenario.name}</span>\n                      <div className=\"flex items-center gap-2 text-sm text-muted-foreground flex-wrap\">\n                        <span className=\"flex items-center gap-1\">\n                          <Calendar className=\"h-3 w-3 shrink-0\" />\n                          {new Date(scenario.createdAt).toLocaleDateString(\"pt-BR\")}\n                        </span>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <span className=\"font-mono\" data-testid={`text-scenario-seats-${scenario.id}`}>{scenario.availableSeats} vagas</span>\n                          </TooltipTrigger>\n                          <TooltipContent>Número de vagas disponíveis neste cenário</TooltipContent>\n                        </Tooltip>\n                      </div>\n                    </div>\n                    <Badge variant={scenario.status === \"completed\" ? \"default\" : \"secondary\"} className=\"shrink-0\" data-testid={`badge-scenario-status-${scenario.id}`}>\n                      {scenario.status === \"completed\" ? \"Concluído\" : \"Rascunho\"}\n                    </Badge>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <div className=\"py-8 text-center text-muted-foreground\" data-testid=\"empty-scenarios\">\n                <FileText className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n                <p>Nenhum cenário criado ainda</p>\n                <Button variant=\"outline\" className=\"mt-4\" asChild>\n                  <Link href=\"/scenarios\" data-testid=\"link-create-scenario\">Criar primeiro cenário</Link>\n                </Button>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-recent-simulations\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-4 flex-wrap\">\n            <div>\n              <CardTitle className=\"text-lg\">Simulações Recentes</CardTitle>\n              <CardDescription>Últimas simulações executadas</CardDescription>\n            </div>\n            <Button variant=\"outline\" size=\"sm\" asChild>\n              <Link href=\"/simulations\" data-testid=\"link-view-simulations\">Ver todas</Link>\n            </Button>\n          </CardHeader>\n          <CardContent>\n            {simulationsLoading ? (\n              <div className=\"space-y-3\">\n                {Array.from({ length: 3 }).map((_, i) => (\n                  <Skeleton key={i} className=\"h-16 w-full\" />\n                ))}\n              </div>\n            ) : recentSimulations && recentSimulations.length > 0 ? (\n              <div className=\"space-y-3\">\n                {recentSimulations.slice(0, 5).map((simulation) => (\n                  <div\n                    key={simulation.id}\n                    className=\"flex items-center justify-between p-3 rounded-md border hover-elevate gap-2\"\n                    data-testid={`row-simulation-${simulation.id}`}\n                  >\n                    <div className=\"flex flex-col gap-1 min-w-0\">\n                      <span className=\"font-medium truncate\" data-testid={`text-simulation-name-${simulation.id}`}>{simulation.name}</span>\n                      <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <Calendar className=\"h-3 w-3 shrink-0\" />\n                        <span>{new Date(simulation.createdAt).toLocaleDateString(\"pt-BR\")}</span>\n                      </div>\n                    </div>\n                    <Badge className=\"shrink-0\" data-testid={`badge-simulation-status-${simulation.id}`}>Completo</Badge>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <div className=\"py-8 text-center text-muted-foreground\" data-testid=\"empty-simulations\">\n                <PlayCircle className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n                <p>Nenhuma simulação realizada</p>\n                <Button variant=\"outline\" className=\"mt-4\" asChild>\n                  <Link href=\"/simulations\" data-testid=\"link-run-simulation\">Executar simulação</Link>\n                </Button>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </section>\n    </div>\n  );\n}\n","path":null,"size_bytes":28740,"size_tokens":null},"client/src/pages/projection-reports.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  FileText, \n  Plus, \n  Download, \n  Trash2, \n  RefreshCw, \n  TrendingUp, \n  TrendingDown, \n  Minus,\n  AlertTriangle,\n  CheckCircle2,\n  Clock,\n  Users,\n  BarChart3,\n  Target,\n  Shield,\n  Lightbulb,\n  Calendar,\n  MapPin,\n  ChevronRight\n} from \"lucide-react\";\nimport type { ProjectionReportRecord } from \"@shared/schema\";\n\nconst BRAZIL_STATES: Record<string, string> = {\n  AC: \"Acre\", AL: \"Alagoas\", AP: \"Amapá\", AM: \"Amazonas\", BA: \"Bahia\",\n  CE: \"Ceará\", DF: \"Distrito Federal\", ES: \"Espírito Santo\", GO: \"Goiás\",\n  MA: \"Maranhão\", MT: \"Mato Grosso\", MS: \"Mato Grosso do Sul\", MG: \"Minas Gerais\",\n  PA: \"Pará\", PB: \"Paraíba\", PR: \"Paraná\", PE: \"Pernambuco\", PI: \"Piauí\",\n  RJ: \"Rio de Janeiro\", RN: \"Rio Grande do Norte\", RS: \"Rio Grande do Sul\",\n  RO: \"Rondônia\", RR: \"Roraima\", SC: \"Santa Catarina\", SP: \"São Paulo\",\n  SE: \"Sergipe\", TO: \"Tocantins\"\n};\n\ntype ProjectionReport = ProjectionReportRecord & {\n  dataQuality?: {\n    completeness: number;\n    yearsAnalyzed: number;\n    totalRecordsAnalyzed: number;\n    lastUpdated: string;\n  } | null;\n  turnoutProjection?: {\n    expected: number;\n    confidence: number;\n    marginOfError: { lower: number; upper: number };\n    historicalBasis: { year: number; turnout: number }[];\n    factors: { factor: string; impact: number; description: string }[];\n  } | null;\n  partyProjections?: {\n    party: string;\n    abbreviation: string;\n    voteShare: { expected: number; min: number; max: number };\n    seats: { expected: number; min: number; max: number };\n    trend: \"growing\" | \"declining\" | \"stable\";\n    confidence: number;\n    marginOfError: number;\n  }[] | null;\n  candidateProjections?: {\n    name: string;\n    party: string;\n    position: string;\n    electionProbability: number;\n    projectedVotes: { expected: number; min: number; max: number };\n    confidence: number;\n    ranking: number;\n  }[] | null;\n  scenarios?: {\n    name: string;\n    description: string;\n    probability: number;\n    outcomes: { party: string; seats: number; voteShare: number }[];\n  }[] | null;\n  riskAssessment?: {\n    overallRisk: \"low\" | \"medium\" | \"high\";\n    risks: {\n      risk: string;\n      probability: number;\n      impact: \"low\" | \"medium\" | \"high\";\n      category: string;\n      mitigation: string;\n    }[];\n  } | null;\n  confidenceIntervals?: {\n    overall: number;\n    turnout: number;\n    partyResults: number;\n    seatDistribution: number;\n  } | null;\n  recommendations?: string[] | null;\n  status: string;\n  createdAt: string;\n  validUntil?: string;\n}\n\nexport default function ProjectionReportsPage() {\n  const { toast } = useToast();\n  const [selectedReport, setSelectedReport] = useState<ProjectionReport | null>(null);\n  const [showNewReportForm, setShowNewReportForm] = useState(false);\n  const [newReportForm, setNewReportForm] = useState({\n    name: \"\",\n    targetYear: new Date().getFullYear() + 2,\n    electionType: \"Eleições Gerais\",\n    scope: \"national\" as \"national\" | \"state\",\n    state: \"\"\n  });\n\n  const { data: reports, isLoading: loadingReports, refetch } = useQuery<ProjectionReport[]>({\n    queryKey: [\"/api/projection-reports\"],\n  });\n\n  const createReportMutation = useMutation({\n    mutationFn: async (data: typeof newReportForm) => {\n      const res = await apiRequest(\"POST\", \"/api/projection-reports\", data);\n      return res.json() as Promise<ProjectionReport>;\n    },\n    onSuccess: (data) => {\n      toast({ title: \"Sucesso\", description: \"Relatório de projeção gerado com sucesso!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/projection-reports\"] });\n      setShowNewReportForm(false);\n      setSelectedReport(data);\n      setNewReportForm({\n        name: \"\",\n        targetYear: new Date().getFullYear() + 2,\n        electionType: \"Eleições Gerais\",\n        scope: \"national\",\n        state: \"\"\n      });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Erro\", \n        description: error.message || \"Falha ao gerar relatório de projeção\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  const deleteReportMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/projection-reports/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Relatório excluído com sucesso!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/projection-reports\"] });\n      setSelectedReport(null);\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Erro\", \n        description: error.message || \"Falha ao excluir relatório\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  const handleExportCSV = (id: number) => {\n    window.open(`/api/projection-reports/${id}/export/csv`, \"_blank\");\n  };\n\n  const getTrendIcon = (trend: string) => {\n    switch (trend) {\n      case \"growing\": return <TrendingUp className=\"w-4 h-4 text-green-500\" />;\n      case \"declining\": return <TrendingDown className=\"w-4 h-4 text-red-500\" />;\n      default: return <Minus className=\"w-4 h-4 text-gray-500\" />;\n    }\n  };\n\n  const getRiskBadge = (risk: string) => {\n    switch (risk) {\n      case \"low\": return <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-300\">Baixo</Badge>;\n      case \"medium\": return <Badge variant=\"outline\" className=\"bg-yellow-50 text-yellow-700 border-yellow-300\">Médio</Badge>;\n      case \"high\": return <Badge variant=\"outline\" className=\"bg-red-50 text-red-700 border-red-300\">Alto</Badge>;\n      default: return <Badge variant=\"secondary\">{risk}</Badge>;\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"draft\": return <Badge variant=\"secondary\">Rascunho</Badge>;\n      case \"published\": return <Badge variant=\"default\" className=\"bg-green-600\">Publicado</Badge>;\n      case \"archived\": return <Badge variant=\"outline\">Arquivado</Badge>;\n      default: return <Badge variant=\"secondary\">{status}</Badge>;\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-7xl\">\n      <div className=\"flex items-center justify-between mb-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold flex items-center gap-2\" data-testid=\"page-title\">\n            <FileText className=\"w-8 h-8 text-primary\" />\n            Relatórios de Projeção\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Projeções eleitorais com modelos preditivos, margens de erro e intervalos de confiança\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button \n            variant=\"outline\" \n            onClick={() => refetch()}\n            data-testid=\"button-refresh\"\n          >\n            <RefreshCw className=\"w-4 h-4 mr-2\" />\n            Atualizar\n          </Button>\n          <Button \n            onClick={() => setShowNewReportForm(true)}\n            data-testid=\"button-new-report\"\n          >\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Novo Relatório\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        <Card className=\"lg:col-span-1\">\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Relatórios Gerados</CardTitle>\n            <CardDescription>Selecione um relatório para visualizar</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {showNewReportForm && (\n              <Card className=\"mb-4 border-primary\">\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-base\">Novo Relatório de Projeção</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div>\n                    <Label>Nome do Relatório</Label>\n                    <Input\n                      placeholder=\"Ex: Projeção Eleições 2026\"\n                      value={newReportForm.name}\n                      onChange={(e) => setNewReportForm(prev => ({ ...prev, name: e.target.value }))}\n                      data-testid=\"input-report-name\"\n                    />\n                  </div>\n                  <div>\n                    <Label>Ano Alvo</Label>\n                    <Input\n                      type=\"number\"\n                      value={newReportForm.targetYear}\n                      onChange={(e) => setNewReportForm(prev => ({ ...prev, targetYear: parseInt(e.target.value) }))}\n                      data-testid=\"input-target-year\"\n                    />\n                  </div>\n                  <div>\n                    <Label>Tipo de Eleição</Label>\n                    <Select\n                      value={newReportForm.electionType}\n                      onValueChange={(value) => setNewReportForm(prev => ({ ...prev, electionType: value }))}\n                    >\n                      <SelectTrigger data-testid=\"select-election-type\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"Eleições Gerais\">Eleições Gerais</SelectItem>\n                        <SelectItem value=\"Eleições Municipais\">Eleições Municipais</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div>\n                    <Label>Escopo</Label>\n                    <Select\n                      value={newReportForm.scope}\n                      onValueChange={(value: \"national\" | \"state\") => setNewReportForm(prev => ({ ...prev, scope: value }))}\n                    >\n                      <SelectTrigger data-testid=\"select-scope\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"national\">Nacional</SelectItem>\n                        <SelectItem value=\"state\">Estadual</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  {newReportForm.scope === \"state\" && (\n                    <div>\n                      <Label>Estado</Label>\n                      <Select\n                        value={newReportForm.state}\n                        onValueChange={(value) => setNewReportForm(prev => ({ ...prev, state: value }))}\n                      >\n                        <SelectTrigger data-testid=\"select-state\">\n                          <SelectValue placeholder=\"Selecione um estado\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {Object.entries(BRAZIL_STATES).map(([code, name]) => (\n                            <SelectItem key={code} value={code}>{code} - {name}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  )}\n                  <div className=\"flex gap-2 pt-2\">\n                    <Button \n                      className=\"flex-1\"\n                      onClick={() => createReportMutation.mutate(newReportForm)}\n                      disabled={createReportMutation.isPending || !newReportForm.name}\n                      data-testid=\"button-generate-report\"\n                    >\n                      {createReportMutation.isPending ? (\n                        <>\n                          <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n                          Gerando...\n                        </>\n                      ) : (\n                        <>\n                          <Target className=\"w-4 h-4 mr-2\" />\n                          Gerar Projeção\n                        </>\n                      )}\n                    </Button>\n                    <Button \n                      variant=\"outline\"\n                      onClick={() => setShowNewReportForm(false)}\n                      data-testid=\"button-cancel\"\n                    >\n                      Cancelar\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n\n            <ScrollArea className=\"h-[500px]\">\n              {loadingReports ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <RefreshCw className=\"w-6 h-6 animate-spin text-muted-foreground\" />\n                </div>\n              ) : reports && reports.length > 0 ? (\n                <div className=\"space-y-2\">\n                  {reports.map((report) => (\n                    <Card \n                      key={report.id}\n                      className={`cursor-pointer transition-colors hover-elevate ${selectedReport?.id === report.id ? \"border-primary bg-primary/5\" : \"\"}`}\n                      onClick={() => setSelectedReport(report)}\n                      data-testid={`report-card-${report.id}`}\n                    >\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-2\">\n                              <h3 className=\"font-medium\">{report.name}</h3>\n                              {getStatusBadge(report.status)}\n                            </div>\n                            <div className=\"flex items-center gap-2 mt-1 text-sm text-muted-foreground\">\n                              <Calendar className=\"w-3 h-3\" />\n                              <span>{report.targetYear}</span>\n                              <span>•</span>\n                              <MapPin className=\"w-3 h-3\" />\n                              <span>{report.scope === \"national\" ? \"Nacional\" : report.state}</span>\n                            </div>\n                          </div>\n                          <ChevronRight className=\"w-4 h-4 text-muted-foreground\" />\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <FileText className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n                  <p>Nenhum relatório gerado ainda.</p>\n                  <Button \n                    variant=\"ghost\" \n                    onClick={() => setShowNewReportForm(true)}\n                    className=\"mt-2 text-primary\"\n                  >\n                    Criar primeiro relatório\n                  </Button>\n                </div>\n              )}\n            </ScrollArea>\n          </CardContent>\n        </Card>\n\n        <Card className=\"lg:col-span-2\">\n          <CardContent className=\"p-0\">\n            {selectedReport ? (\n              <Tabs defaultValue=\"summary\" className=\"w-full\">\n                <div className=\"flex items-center justify-between p-4 border-b\">\n                  <div>\n                    <h2 className=\"text-xl font-bold\">{selectedReport.name}</h2>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Projeção para {selectedReport.targetYear} • {selectedReport.scope === \"national\" ? \"Nacional\" : selectedReport.state}\n                    </p>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\"\n                      onClick={() => handleExportCSV(selectedReport.id)}\n                      data-testid=\"button-export-csv\"\n                    >\n                      <Download className=\"w-4 h-4 mr-1\" />\n                      CSV\n                    </Button>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\"\n                      className=\"text-destructive hover:text-destructive\"\n                      onClick={() => deleteReportMutation.mutate(selectedReport.id)}\n                      data-testid=\"button-delete-report\"\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </div>\n\n                <TabsList className=\"w-full justify-start rounded-none border-b bg-transparent p-0\">\n                  <TabsTrigger \n                    value=\"summary\" \n                    className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary\"\n                    data-testid=\"tab-summary\"\n                  >\n                    <FileText className=\"w-4 h-4 mr-1\" />\n                    Resumo\n                  </TabsTrigger>\n                  <TabsTrigger \n                    value=\"turnout\"\n                    className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary\"\n                    data-testid=\"tab-turnout\"\n                  >\n                    <Users className=\"w-4 h-4 mr-1\" />\n                    Comparecimento\n                  </TabsTrigger>\n                  <TabsTrigger \n                    value=\"parties\"\n                    className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary\"\n                    data-testid=\"tab-parties\"\n                  >\n                    <BarChart3 className=\"w-4 h-4 mr-1\" />\n                    Partidos\n                  </TabsTrigger>\n                  <TabsTrigger \n                    value=\"candidates\"\n                    className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary\"\n                    data-testid=\"tab-candidates\"\n                  >\n                    <Target className=\"w-4 h-4 mr-1\" />\n                    Candidatos\n                  </TabsTrigger>\n                  <TabsTrigger \n                    value=\"risks\"\n                    className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary\"\n                    data-testid=\"tab-risks\"\n                  >\n                    <Shield className=\"w-4 h-4 mr-1\" />\n                    Riscos\n                  </TabsTrigger>\n                </TabsList>\n\n                <ScrollArea className=\"h-[550px]\">\n                  <div className=\"p-4\">\n                    <TabsContent value=\"summary\" className=\"mt-0 space-y-4\">\n                      <Card>\n                        <CardHeader>\n                          <CardTitle className=\"text-base\">Resumo Executivo</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                          <p className=\"text-sm whitespace-pre-wrap\">{selectedReport.executiveSummary}</p>\n                        </CardContent>\n                      </Card>\n\n                      <Card>\n                        <CardHeader>\n                          <CardTitle className=\"text-base\">Intervalos de Confiança</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                          <div className=\"grid grid-cols-2 gap-4\">\n                            <div>\n                              <div className=\"flex justify-between text-sm mb-1\">\n                                <span>Confiança Geral</span>\n                                <span className=\"font-medium\">{((selectedReport.confidenceIntervals?.overall || 0) * 100).toFixed(0)}%</span>\n                              </div>\n                              <Progress value={(selectedReport.confidenceIntervals?.overall || 0) * 100} className=\"h-2\" />\n                            </div>\n                            <div>\n                              <div className=\"flex justify-between text-sm mb-1\">\n                                <span>Comparecimento</span>\n                                <span className=\"font-medium\">{((selectedReport.confidenceIntervals?.turnout || 0) * 100).toFixed(0)}%</span>\n                              </div>\n                              <Progress value={(selectedReport.confidenceIntervals?.turnout || 0) * 100} className=\"h-2\" />\n                            </div>\n                            <div>\n                              <div className=\"flex justify-between text-sm mb-1\">\n                                <span>Resultados Partidários</span>\n                                <span className=\"font-medium\">{((selectedReport.confidenceIntervals?.partyResults || 0) * 100).toFixed(0)}%</span>\n                              </div>\n                              <Progress value={(selectedReport.confidenceIntervals?.partyResults || 0) * 100} className=\"h-2\" />\n                            </div>\n                            <div>\n                              <div className=\"flex justify-between text-sm mb-1\">\n                                <span>Distribuição de Cadeiras</span>\n                                <span className=\"font-medium\">{((selectedReport.confidenceIntervals?.seatDistribution || 0) * 100).toFixed(0)}%</span>\n                              </div>\n                              <Progress value={(selectedReport.confidenceIntervals?.seatDistribution || 0) * 100} className=\"h-2\" />\n                            </div>\n                          </div>\n                        </CardContent>\n                      </Card>\n\n                      {selectedReport.recommendations && selectedReport.recommendations.length > 0 && (\n                        <Card>\n                          <CardHeader>\n                            <CardTitle className=\"text-base flex items-center gap-2\">\n                              <Lightbulb className=\"w-4 h-4 text-yellow-500\" />\n                              Recomendações\n                            </CardTitle>\n                          </CardHeader>\n                          <CardContent>\n                            <ul className=\"space-y-2\">\n                              {selectedReport.recommendations.map((rec, i) => (\n                                <li key={i} className=\"flex items-start gap-2 text-sm\">\n                                  <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5 shrink-0\" />\n                                  <span>{rec}</span>\n                                </li>\n                              ))}\n                            </ul>\n                          </CardContent>\n                        </Card>\n                      )}\n\n                      <Card>\n                        <CardHeader>\n                          <CardTitle className=\"text-base\">Metodologia</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                          <p className=\"text-sm text-muted-foreground\">{selectedReport.methodology}</p>\n                        </CardContent>\n                      </Card>\n                    </TabsContent>\n\n                    <TabsContent value=\"turnout\" className=\"mt-0 space-y-4\">\n                      {selectedReport.turnoutProjection && (\n                        <>\n                          <Card>\n                            <CardHeader>\n                              <CardTitle className=\"text-base\">Projeção de Comparecimento</CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <div className=\"flex items-center justify-center py-6\">\n                                <div className=\"text-center\">\n                                  <div className=\"text-5xl font-bold text-primary\">\n                                    {selectedReport.turnoutProjection.expected}%\n                                  </div>\n                                  <div className=\"text-sm text-muted-foreground mt-2\">\n                                    Intervalo: {selectedReport.turnoutProjection.marginOfError.lower}% - {selectedReport.turnoutProjection.marginOfError.upper}%\n                                  </div>\n                                  <div className=\"flex items-center justify-center gap-2 mt-2\">\n                                    <span className=\"text-sm\">Confiança:</span>\n                                    <Badge variant=\"outline\">{(selectedReport.turnoutProjection.confidence * 100).toFixed(0)}%</Badge>\n                                  </div>\n                                </div>\n                              </div>\n                            </CardContent>\n                          </Card>\n\n                          {selectedReport.turnoutProjection.factors && selectedReport.turnoutProjection.factors.length > 0 && (\n                            <Card>\n                              <CardHeader>\n                                <CardTitle className=\"text-base\">Fatores de Influência</CardTitle>\n                              </CardHeader>\n                              <CardContent>\n                                <div className=\"space-y-3\">\n                                  {selectedReport.turnoutProjection.factors.map((factor, i) => (\n                                    <div key={i} className=\"flex items-start gap-3 p-3 rounded-lg bg-muted/50\">\n                                      <div className={`w-2 h-2 rounded-full mt-2 ${factor.impact > 0 ? \"bg-green-500\" : factor.impact < 0 ? \"bg-red-500\" : \"bg-gray-400\"}`} />\n                                      <div className=\"flex-1\">\n                                        <div className=\"font-medium\">{factor.factor}</div>\n                                        <div className=\"text-sm text-muted-foreground\">{factor.description}</div>\n                                      </div>\n                                      <Badge variant={factor.impact > 0 ? \"default\" : factor.impact < 0 ? \"destructive\" : \"secondary\"}>\n                                        {factor.impact > 0 ? \"+\" : \"\"}{(factor.impact * 100).toFixed(0)}%\n                                      </Badge>\n                                    </div>\n                                  ))}\n                                </div>\n                              </CardContent>\n                            </Card>\n                          )}\n                        </>\n                      )}\n                    </TabsContent>\n\n                    <TabsContent value=\"parties\" className=\"mt-0 space-y-4\">\n                      {selectedReport.partyProjections && selectedReport.partyProjections.length > 0 ? (\n                        <div className=\"space-y-3\">\n                          {selectedReport.partyProjections.map((party, i) => (\n                            <Card key={i}>\n                              <CardContent className=\"p-4\">\n                                <div className=\"flex items-start justify-between\">\n                                  <div className=\"flex items-center gap-3\">\n                                    <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center font-bold text-primary\">\n                                      {party.abbreviation.slice(0, 2)}\n                                    </div>\n                                    <div>\n                                      <div className=\"font-medium flex items-center gap-2\">\n                                        {party.abbreviation}\n                                        {getTrendIcon(party.trend)}\n                                      </div>\n                                      <div className=\"text-sm text-muted-foreground\">{party.party}</div>\n                                    </div>\n                                  </div>\n                                  <Badge variant=\"outline\">\n                                    Confiança: {(party.confidence * 100).toFixed(0)}%\n                                  </Badge>\n                                </div>\n                                <Separator className=\"my-3\" />\n                                <div className=\"grid grid-cols-2 gap-4\">\n                                  <div>\n                                    <div className=\"text-sm text-muted-foreground\">Votos Projetados</div>\n                                    <div className=\"font-medium text-lg\">{party.voteShare.expected.toFixed(1)}%</div>\n                                    <div className=\"text-xs text-muted-foreground\">\n                                      Intervalo: {party.voteShare.min.toFixed(1)}% - {party.voteShare.max.toFixed(1)}%\n                                    </div>\n                                  </div>\n                                  <div>\n                                    <div className=\"text-sm text-muted-foreground\">Cadeiras Projetadas</div>\n                                    <div className=\"font-medium text-lg\">{party.seats.expected}</div>\n                                    <div className=\"text-xs text-muted-foreground\">\n                                      Intervalo: {party.seats.min} - {party.seats.max}\n                                    </div>\n                                  </div>\n                                </div>\n                                <div className=\"mt-2 text-xs text-muted-foreground\">\n                                  Margem de erro: ±{party.marginOfError.toFixed(1)}%\n                                </div>\n                              </CardContent>\n                            </Card>\n                          ))}\n                        </div>\n                      ) : (\n                        <div className=\"text-center py-8 text-muted-foreground\">\n                          Nenhuma projeção partidária disponível\n                        </div>\n                      )}\n                    </TabsContent>\n\n                    <TabsContent value=\"candidates\" className=\"mt-0 space-y-4\">\n                      {selectedReport.candidateProjections && selectedReport.candidateProjections.length > 0 ? (\n                        <div className=\"space-y-2\">\n                          {selectedReport.candidateProjections.map((candidate, i) => (\n                            <Card key={i}>\n                              <CardContent className=\"p-4\">\n                                <div className=\"flex items-center justify-between\">\n                                  <div className=\"flex items-center gap-3\">\n                                    <div className=\"w-8 h-8 rounded-full bg-muted flex items-center justify-center font-bold text-sm\">\n                                      #{candidate.ranking}\n                                    </div>\n                                    <div>\n                                      <div className=\"font-medium\">{candidate.name}</div>\n                                      <div className=\"text-sm text-muted-foreground\">\n                                        {candidate.party} • {candidate.position}\n                                      </div>\n                                    </div>\n                                  </div>\n                                  <div className=\"text-right\">\n                                    <div className=\"font-medium text-lg\">\n                                      {(candidate.electionProbability * 100).toFixed(0)}%\n                                    </div>\n                                    <div className=\"text-xs text-muted-foreground\">prob. eleição</div>\n                                  </div>\n                                </div>\n                                <div className=\"mt-3 flex items-center gap-4 text-sm\">\n                                  <div>\n                                    <span className=\"text-muted-foreground\">Votos esperados:</span>\n                                    <span className=\"font-medium ml-1\">{candidate.projectedVotes.expected.toLocaleString(\"pt-BR\")}</span>\n                                  </div>\n                                  <div className=\"text-muted-foreground\">\n                                    ({candidate.projectedVotes.min.toLocaleString(\"pt-BR\")} - {candidate.projectedVotes.max.toLocaleString(\"pt-BR\")})\n                                  </div>\n                                </div>\n                                <Progress \n                                  value={candidate.electionProbability * 100} \n                                  className=\"h-2 mt-2\"\n                                />\n                              </CardContent>\n                            </Card>\n                          ))}\n                        </div>\n                      ) : (\n                        <div className=\"text-center py-8 text-muted-foreground\">\n                          Nenhuma projeção de candidatos disponível\n                        </div>\n                      )}\n                    </TabsContent>\n\n                    <TabsContent value=\"risks\" className=\"mt-0 space-y-4\">\n                      {selectedReport.riskAssessment && (\n                        <>\n                          <Card>\n                            <CardHeader>\n                              <CardTitle className=\"text-base flex items-center justify-between\">\n                                <span>Avaliação de Risco Geral</span>\n                                {getRiskBadge(selectedReport.riskAssessment.overallRisk)}\n                              </CardTitle>\n                            </CardHeader>\n                          </Card>\n\n                          {selectedReport.riskAssessment.risks && selectedReport.riskAssessment.risks.length > 0 && (\n                            <div className=\"space-y-3\">\n                              {selectedReport.riskAssessment.risks.map((risk, i) => (\n                                <Card key={i}>\n                                  <CardContent className=\"p-4\">\n                                    <div className=\"flex items-start gap-3\">\n                                      <AlertTriangle className={`w-5 h-5 mt-0.5 ${\n                                        risk.impact === \"high\" ? \"text-red-500\" : \n                                        risk.impact === \"medium\" ? \"text-yellow-500\" : \"text-blue-500\"\n                                      }`} />\n                                      <div className=\"flex-1\">\n                                        <div className=\"flex items-center gap-2\">\n                                          <span className=\"font-medium\">{risk.risk}</span>\n                                          {getRiskBadge(risk.impact)}\n                                          <Badge variant=\"outline\">{risk.category}</Badge>\n                                        </div>\n                                        <div className=\"mt-2 text-sm\">\n                                          <span className=\"text-muted-foreground\">Probabilidade: </span>\n                                          <span>{(risk.probability * 100).toFixed(0)}%</span>\n                                        </div>\n                                        <div className=\"mt-2 p-2 rounded bg-muted/50 text-sm\">\n                                          <span className=\"font-medium\">Mitigação: </span>\n                                          {risk.mitigation}\n                                        </div>\n                                      </div>\n                                    </div>\n                                  </CardContent>\n                                </Card>\n                              ))}\n                            </div>\n                          )}\n\n                          {selectedReport.scenarios && selectedReport.scenarios.length > 0 && (\n                            <Card>\n                              <CardHeader>\n                                <CardTitle className=\"text-base\">Cenários Possíveis</CardTitle>\n                              </CardHeader>\n                              <CardContent>\n                                <div className=\"space-y-4\">\n                                  {selectedReport.scenarios.map((scenario, i) => (\n                                    <div key={i} className=\"p-3 rounded-lg border\">\n                                      <div className=\"flex items-center justify-between mb-2\">\n                                        <span className=\"font-medium\">{scenario.name}</span>\n                                        <Badge variant=\"secondary\">{(scenario.probability * 100).toFixed(0)}% probabilidade</Badge>\n                                      </div>\n                                      <p className=\"text-sm text-muted-foreground mb-2\">{scenario.description}</p>\n                                      {scenario.outcomes && scenario.outcomes.length > 0 && (\n                                        <div className=\"flex flex-wrap gap-2\">\n                                          {scenario.outcomes.slice(0, 5).map((outcome, j) => (\n                                            <Badge key={j} variant=\"outline\">\n                                              {outcome.party}: {outcome.seats} cad. ({outcome.voteShare.toFixed(1)}%)\n                                            </Badge>\n                                          ))}\n                                        </div>\n                                      )}\n                                    </div>\n                                  ))}\n                                </div>\n                              </CardContent>\n                            </Card>\n                          )}\n                        </>\n                      )}\n                    </TabsContent>\n                  </div>\n                </ScrollArea>\n              </Tabs>\n            ) : (\n              <div className=\"flex flex-col items-center justify-center h-[600px] text-muted-foreground\">\n                <FileText className=\"w-16 h-16 mb-4 opacity-30\" />\n                <h3 className=\"text-lg font-medium\">Nenhum relatório selecionado</h3>\n                <p className=\"text-sm\">Selecione um relatório da lista ou crie um novo</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":38612,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"server/replit_integrations/audio/index.ts":{"content":"export { registerAudioRoutes } from \"./routes\";\nexport {\n  openai,\n  textToSpeech,\n  textToSpeechStream,\n  speechToText,\n  speechToTextStream,\n  voiceChat,\n  voiceChatStream,\n  voiceChatWithTextModel,\n  SentenceParser,\n} from \"./client\";\n","path":null,"size_bytes":238,"size_tokens":null},"client/src/pages/data-analysis.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport {\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  ResponsiveContainer,\n  PieChart,\n  Pie,\n  Cell,\n  Legend,\n  LineChart,\n  Line,\n  AreaChart,\n  Area,\n} from \"recharts\";\nimport {\n  BarChart3,\n  PieChartIcon,\n  Users,\n  Building2,\n  MapPin,\n  Download,\n  FileSpreadsheet,\n  FileText,\n  TrendingUp,\n  Vote,\n  Loader2,\n  Filter,\n  Brain,\n  MessageSquare,\n  AlertTriangle,\n  Sparkles,\n  Send,\n  TrendingDown,\n  Minus,\n  ChevronDown,\n  ChevronUp,\n  Save,\n  FolderOpen,\n  Trash2,\n  GitCompare,\n  SlidersHorizontal,\n  ZoomIn,\n  LayoutDashboard,\n  Lightbulb,\n  Plus,\n  X,\n  Eye,\n  Globe,\n} from \"lucide-react\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport jsPDF from \"jspdf\";\nimport autoTable from \"jspdf-autotable\";\n\nconst CHART_COLORS = [\n  \"#003366\", \"#1a5490\", \"#3475b4\", \"#4e96d8\", \"#68b7fc\",\n  \"#FFD700\", \"#e6c200\", \"#ccad00\", \"#b39800\", \"#998300\",\n  \"#2ecc71\", \"#27ae60\", \"#1e8449\", \"#145a32\", \"#0d3d22\",\n  \"#9b59b6\", \"#8e44ad\", \"#7d3c98\", \"#6c3483\", \"#5b2c6f\",\n];\n\nfunction CustomTooltip({ active, payload, label, type }: any) {\n  if (!active || !payload || !payload.length) return null;\n  \n  const data = payload[0].payload;\n  \n  return (\n    <div className=\"bg-background border rounded-lg shadow-lg p-3 min-w-[200px]\" data-testid=\"chart-tooltip\">\n      <p className=\"font-semibold text-sm border-b pb-2 mb-2\">{label || data.party || data.name || data.state}</p>\n      {type === \"party\" && (\n        <>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Votos:</span> {formatNumber(data.votes)}</p>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Candidatos:</span> {formatNumber(data.candidateCount)}</p>\n          {data.partyNumber && <p className=\"text-sm\"><span className=\"text-muted-foreground\">Número:</span> {data.partyNumber}</p>}\n        </>\n      )}\n      {type === \"candidate\" && (\n        <>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Nome:</span> {data.name}</p>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Partido:</span> {data.party}</p>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Votos:</span> {formatNumber(data.votes)}</p>\n          {data.position && <p className=\"text-sm\"><span className=\"text-muted-foreground\">Cargo:</span> {data.position}</p>}\n          {data.state && <p className=\"text-sm\"><span className=\"text-muted-foreground\">Estado:</span> {data.state}</p>}\n        </>\n      )}\n      {type === \"state\" && (\n        <>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Votos:</span> {formatNumber(data.votes)}</p>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Candidatos:</span> {formatNumber(data.candidateCount)}</p>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Partidos:</span> {formatNumber(data.partyCount)}</p>\n        </>\n      )}\n      {type === \"municipality\" && (\n        <>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Município:</span> {data.municipality}</p>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Estado:</span> {data.state}</p>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Votos:</span> {formatNumber(data.votes)}</p>\n          <p className=\"text-sm\"><span className=\"text-muted-foreground\">Candidatos:</span> {formatNumber(data.candidateCount)}</p>\n        </>\n      )}\n      {!type && (\n        <p className=\"text-sm\"><span className=\"text-muted-foreground\">Valor:</span> {formatNumber(payload[0].value)}</p>\n      )}\n    </div>\n  );\n}\n\nfunction formatNumber(num: number): string {\n  if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;\n  if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;\n  return num.toLocaleString(\"pt-BR\");\n}\n\nexport default function DataAnalysis() {\n  const { toast } = useToast();\n  const [selectedYear, setSelectedYear] = useState<string>(\"all\");\n  const [selectedState, setSelectedState] = useState<string>(\"all\");\n  const [selectedElectionType, setSelectedElectionType] = useState<string>(\"all\");\n  const [selectedPosition, setSelectedPosition] = useState<string>(\"all\");\n  const [selectedParty, setSelectedParty] = useState<string>(\"all\");\n  const [minVotes, setMinVotes] = useState<string>(\"\");\n  const [maxVotes, setMaxVotes] = useState<string>(\"\");\n  const [exportLoading, setExportLoading] = useState<string | null>(null);\n  const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);\n  \n  // Comparison States\n  const [compareMode, setCompareMode] = useState(false);\n  const [compareYears, setCompareYears] = useState<number[]>([]);\n  const [compareStates, setCompareStates] = useState<string[]>([]);\n  const [compareGroupBy, setCompareGroupBy] = useState<\"party\" | \"state\" | \"position\">(\"party\");\n  \n  // Saved Reports States\n  const [showSaveDialog, setShowSaveDialog] = useState(false);\n  const [reportName, setReportName] = useState(\"\");\n  const [reportDescription, setReportDescription] = useState(\"\");\n  const [selectedReport, setSelectedReport] = useState<number | null>(null);\n  \n  // AI States\n  const [aiQuestion, setAiQuestion] = useState(\"\");\n  const [aiAnswer, setAiAnswer] = useState<{ question: string; answer: string } | null>(null);\n  const [historicalPrediction, setHistoricalPrediction] = useState<any>(null);\n  const [anomalyReport, setAnomalyReport] = useState<any>(null);\n  \n  // AI Suggestions States\n  const [generatingSuggestions, setGeneratingSuggestions] = useState(false);\n  \n  // Custom Dashboard States\n  const [showDashboardDialog, setShowDashboardDialog] = useState(false);\n  const [dashboardName, setDashboardName] = useState(\"\");\n  const [dashboardDescription, setDashboardDescription] = useState(\"\");\n  const [dashboardIsPublic, setDashboardIsPublic] = useState(false);\n  const [selectedDashboard, setSelectedDashboard] = useState<number | null>(null);\n  \n  // Municipality filter\n  const [selectedMunicipality, setSelectedMunicipality] = useState<string>(\"all\");\n\n  const filters = useMemo(() => {\n    const f: Record<string, string> = {};\n    if (selectedYear !== \"all\") f.year = selectedYear;\n    if (selectedState !== \"all\") f.uf = selectedState;\n    if (selectedElectionType !== \"all\") f.electionType = selectedElectionType;\n    if (selectedPosition !== \"all\") f.position = selectedPosition;\n    if (selectedParty !== \"all\") f.party = selectedParty;\n    if (selectedMunicipality !== \"all\") f.municipality = selectedMunicipality;\n    if (minVotes) f.minVotes = minVotes;\n    if (maxVotes) f.maxVotes = maxVotes;\n    return f;\n  }, [selectedYear, selectedState, selectedElectionType, selectedPosition, selectedParty, selectedMunicipality, minVotes, maxVotes]);\n\n  const queryString = useMemo(() => {\n    const params = new URLSearchParams(filters);\n    return params.toString() ? `?${params.toString()}` : \"\";\n  }, [filters]);\n\n  const statesQuery = useMemo(() => {\n    return selectedYear !== \"all\" ? `?year=${selectedYear}` : \"\";\n  }, [selectedYear]);\n\n  const { data: years, isLoading: yearsLoading } = useQuery<number[]>({\n    queryKey: [\"/api/analytics/election-years\"],\n  });\n\n  const { data: states, isLoading: statesLoading } = useQuery<string[]>({\n    queryKey: [`/api/analytics/states${statesQuery}`],\n  });\n\n  const { data: electionTypes, isLoading: typesLoading } = useQuery<string[]>({\n    queryKey: [`/api/analytics/election-types${statesQuery}`],\n  });\n\n  const { data: positions } = useQuery<string[]>({\n    queryKey: [`/api/analytics/positions${statesQuery}`],\n  });\n\n  const { data: partiesList } = useQuery<{ party: string; number: number }[]>({\n    queryKey: [`/api/analytics/parties-list${statesQuery}`],\n  });\n\n  const { data: savedReports, refetch: refetchReports } = useQuery<{\n    id: number;\n    name: string;\n    description: string | null;\n    filters: Record<string, string>;\n    columns: string[];\n    chartType: string;\n    createdAt: string;\n  }[]>({\n    queryKey: [\"/api/reports\"],\n  });\n\n  // AI Suggestions query\n  const { data: aiSuggestions, refetch: refetchSuggestions } = useQuery<{\n    id: number;\n    suggestionType: string;\n    title: string;\n    description: string;\n    configuration: Record<string, any>;\n    relevanceScore: string;\n    dismissed: boolean;\n    applied: boolean;\n    createdAt: string;\n  }[]>({\n    queryKey: [\"/api/ai/suggestions?dismissed=false\"],\n  });\n\n  // Custom Dashboards query\n  const { data: customDashboards, refetch: refetchDashboards } = useQuery<{\n    id: number;\n    name: string;\n    description: string | null;\n    layout: Record<string, any>;\n    filters: Record<string, any>;\n    widgets: Record<string, any>[];\n    isPublic: boolean;\n    createdAt: string;\n    updatedAt: string;\n  }[]>({\n    queryKey: [\"/api/dashboards\"],\n  });\n\n  // Municipalities query\n  const { data: municipalities } = useQuery<{\n    code: number;\n    name: string;\n    uf: string;\n  }[]>({\n    queryKey: [\"/api/analytics/municipalities\", { uf: selectedState !== \"all\" ? selectedState : undefined }],\n    enabled: selectedState !== \"all\",\n  });\n\n  const { data: summary, isLoading: summaryLoading } = useQuery<{\n    totalVotes: number;\n    totalCandidates: number;\n    totalParties: number;\n    totalMunicipalities: number;\n  }>({\n    queryKey: [`/api/analytics/summary${queryString}`],\n  });\n\n  const { data: votesByParty, isLoading: partyLoading } = useQuery<{\n    party: string;\n    partyNumber: number | null;\n    votes: number;\n    candidateCount: number;\n  }[]>({\n    queryKey: [`/api/analytics/votes-by-party${queryString}`],\n  });\n\n  const { data: topCandidates, isLoading: candidatesLoading } = useQuery<{\n    name: string;\n    nickname: string | null;\n    party: string | null;\n    number: number | null;\n    state: string | null;\n    position: string | null;\n    votes: number;\n  }[]>({\n    queryKey: [`/api/analytics/top-candidates${queryString}`],\n  });\n\n  const { data: votesByState, isLoading: stateVotesLoading } = useQuery<{\n    state: string;\n    votes: number;\n    candidateCount: number;\n    partyCount: number;\n  }[]>({\n    queryKey: [`/api/analytics/votes-by-state${queryString}`],\n  });\n\n  const { data: votesByMunicipality, isLoading: municipalityLoading } = useQuery<{\n    municipality: string;\n    state: string | null;\n    votes: number;\n    candidateCount: number;\n  }[]>({\n    queryKey: [`/api/analytics/votes-by-municipality${queryString}`],\n  });\n\n  // AI Mutations\n  const assistantMutation = useMutation({\n    mutationFn: async (question: string) => {\n      const res = await apiRequest(\"POST\", \"/api/ai/assistant\", { question, filters });\n      return res.json();\n    },\n    onSuccess: (data) => {\n      setAiAnswer({ question: data.question, answer: data.answer });\n      toast({ title: \"Resposta gerada\", description: \"O assistente respondeu sua pergunta.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao processar pergunta.\", variant: \"destructive\" });\n    },\n  });\n\n  const predictionMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/ai/predict-historical\", { filters });\n      return res.json();\n    },\n    onSuccess: (data) => {\n      setHistoricalPrediction(data);\n      toast({ title: \"Previsão gerada\", description: \"Análise de tendências concluída.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao gerar previsão.\", variant: \"destructive\" });\n    },\n  });\n\n  const anomalyMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/ai/anomalies\", { filters });\n      return res.json();\n    },\n    onSuccess: (data) => {\n      setAnomalyReport(data);\n      toast({ title: \"Análise concluída\", description: \"Relatório de anomalias gerado.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha na detecção de anomalias.\", variant: \"destructive\" });\n    },\n  });\n\n  const handleAskQuestion = () => {\n    if (aiQuestion.trim().length >= 5) {\n      assistantMutation.mutate(aiQuestion);\n    }\n  };\n\n  // Comparison mutation\n  const compareMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/analytics/compare\", {\n        years: compareYears,\n        states: compareStates,\n        groupBy: compareGroupBy,\n      });\n      return res.json();\n    },\n  });\n\n  // Save report mutation\n  const saveReportMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/reports\", {\n        name: reportName,\n        description: reportDescription,\n        filters,\n        columns: [\"name\", \"party\", \"votes\", \"position\"],\n        chartType: \"bar\",\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Relatório salvo\", description: \"Relatório salvo com sucesso.\" });\n      setShowSaveDialog(false);\n      setReportName(\"\");\n      setReportDescription(\"\");\n      refetchReports();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao salvar relatório.\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteReportMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const res = await apiRequest(\"DELETE\", `/api/reports/${id}`);\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Relatório excluído\", description: \"Relatório excluído com sucesso.\" });\n      refetchReports();\n    },\n  });\n\n  // AI Suggestions mutations\n  const generateSuggestionsMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/ai/generate-suggestions\", { filters });\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Sugestões geradas\", description: \"Novas sugestões de IA criadas com base nos dados.\" });\n      refetchSuggestions();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao gerar sugestões.\", variant: \"destructive\" });\n    },\n  });\n\n  const dismissSuggestionMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"POST\", `/api/ai/suggestions/${id}/dismiss`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Sugestão descartada\" });\n      refetchSuggestions();\n    },\n  });\n\n  const applySuggestionMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"POST\", `/api/ai/suggestions/${id}/apply`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Sugestão aplicada\", description: \"A visualização foi marcada como aplicada.\" });\n      refetchSuggestions();\n    },\n  });\n\n  // Custom Dashboard mutations\n  const createDashboardMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/dashboards\", {\n        name: dashboardName,\n        description: dashboardDescription,\n        layout: { columns: 2 },\n        filters,\n        widgets: [],\n        isPublic: dashboardIsPublic,\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Dashboard criado\", description: \"Novo dashboard salvo com sucesso.\" });\n      setShowDashboardDialog(false);\n      setDashboardName(\"\");\n      setDashboardDescription(\"\");\n      setDashboardIsPublic(false);\n      refetchDashboards();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar dashboard.\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteDashboardMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/dashboards/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Dashboard excluído\" });\n      refetchDashboards();\n    },\n  });\n\n  const loadDashboard = (dashboard: { filters: Record<string, any> }) => {\n    if (dashboard.filters.year) setSelectedYear(String(dashboard.filters.year));\n    if (dashboard.filters.uf) setSelectedState(dashboard.filters.uf);\n    if (dashboard.filters.electionType) setSelectedElectionType(dashboard.filters.electionType);\n    if (dashboard.filters.position) setSelectedPosition(dashboard.filters.position);\n    if (dashboard.filters.party) setSelectedParty(dashboard.filters.party);\n    if (dashboard.filters.municipality) setSelectedMunicipality(dashboard.filters.municipality);\n    if (dashboard.filters.minVotes) setMinVotes(String(dashboard.filters.minVotes));\n    if (dashboard.filters.maxVotes) setMaxVotes(String(dashboard.filters.maxVotes));\n    toast({ title: \"Dashboard carregado\", description: \"Filtros aplicados com sucesso.\" });\n  };\n\n  const loadReport = (report: { filters: Record<string, string> }) => {\n    if (report.filters.year) setSelectedYear(report.filters.year);\n    if (report.filters.uf) setSelectedState(report.filters.uf);\n    if (report.filters.electionType) setSelectedElectionType(report.filters.electionType);\n    if (report.filters.position) setSelectedPosition(report.filters.position);\n    if (report.filters.party) setSelectedParty(report.filters.party);\n    if (report.filters.minVotes) setMinVotes(report.filters.minVotes);\n    if (report.filters.maxVotes) setMaxVotes(report.filters.maxVotes);\n    toast({ title: \"Relatório carregado\", description: \"Filtros aplicados com sucesso.\" });\n  };\n\n  const handleExportCSV = async (reportType: string) => {\n    setExportLoading(reportType);\n    try {\n      const params = new URLSearchParams({ ...filters, reportType });\n      const response = await fetch(`/api/analytics/export/csv?${params.toString()}`, {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to export\");\n      \n      const blob = await response.blob();\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = `relatorio_${reportType}_${Date.now()}.csv`;\n      a.click();\n      URL.revokeObjectURL(url);\n      \n      toast({ title: \"Exportação concluída\", description: \"Arquivo CSV baixado com sucesso.\" });\n    } catch (error) {\n      toast({ title: \"Erro na exportação\", description: \"Falha ao exportar dados.\", variant: \"destructive\" });\n    } finally {\n      setExportLoading(null);\n    }\n  };\n\n  const handleExportPDF = async (reportType: string, title: string, data: any[]) => {\n    setExportLoading(`pdf-${reportType}`);\n    try {\n      const doc = new jsPDF();\n      \n      doc.setFontSize(18);\n      doc.setTextColor(0, 51, 102);\n      doc.text(\"SimulaVoto - Relatório de Análise\", 14, 22);\n      \n      doc.setFontSize(14);\n      doc.setTextColor(0, 0, 0);\n      doc.text(title, 14, 32);\n      \n      doc.setFontSize(10);\n      doc.setTextColor(100, 100, 100);\n      const filterText = [];\n      if (selectedYear !== \"all\") filterText.push(`Ano: ${selectedYear}`);\n      if (selectedState !== \"all\") filterText.push(`Estado: ${selectedState}`);\n      if (selectedElectionType !== \"all\") filterText.push(`Tipo: ${selectedElectionType}`);\n      doc.text(filterText.length > 0 ? filterText.join(\" | \") : \"Todos os dados\", 14, 40);\n      doc.text(`Gerado em: ${new Date().toLocaleString(\"pt-BR\")}`, 14, 46);\n\n      if (data.length > 0) {\n        const headers = Object.keys(data[0]);\n        const rows = data.map((row) => headers.map((h) => String(row[h] ?? \"\")));\n        \n        autoTable(doc, {\n          head: [headers],\n          body: rows,\n          startY: 55,\n          styles: { fontSize: 8 },\n          headStyles: { fillColor: [0, 51, 102] },\n        });\n      }\n\n      doc.save(`relatorio_${reportType}_${Date.now()}.pdf`);\n      toast({ title: \"PDF gerado\", description: \"Relatório PDF baixado com sucesso.\" });\n    } catch (error) {\n      toast({ title: \"Erro ao gerar PDF\", description: \"Falha ao criar relatório.\", variant: \"destructive\" });\n    } finally {\n      setExportLoading(null);\n    }\n  };\n\n  const hasData = summary && summary.totalVotes > 0;\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-foreground\" data-testid=\"text-page-title\">\n            Análise de Dados\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Explore dados eleitorais importados do TSE com filtros e visualizações\n          </p>\n        </div>\n        <Badge variant=\"outline\" className=\"flex items-center gap-1 w-fit\">\n          <BarChart3 className=\"h-3 w-3\" />\n          Relatórios Personalizados\n        </Badge>\n      </div>\n\n      <Card>\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"flex items-center gap-2 text-lg\">\n              <Filter className=\"h-4 w-4\" />\n              Filtros\n            </CardTitle>\n            <div className=\"flex items-center gap-2\">\n              {savedReports && savedReports.length > 0 && (\n                <Select value={selectedReport?.toString() ?? \"\"} onValueChange={(v) => {\n                  const report = savedReports.find(r => r.id === parseInt(v));\n                  if (report) {\n                    setSelectedReport(parseInt(v));\n                    loadReport(report);\n                  }\n                }}>\n                  <SelectTrigger className=\"w-48\" data-testid=\"select-saved-report\">\n                    <FolderOpen className=\"h-4 w-4 mr-2\" />\n                    <SelectValue placeholder=\"Carregar relatório\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {savedReports.map((report) => (\n                      <SelectItem key={report.id} value={String(report.id)}>\n                        {report.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              )}\n              <Button variant=\"outline\" size=\"sm\" onClick={() => setShowSaveDialog(true)} data-testid=\"button-save-report\">\n                <Save className=\"h-4 w-4 mr-2\" />\n                Salvar\n              </Button>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 gap-4 sm:grid-cols-3\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Ano da Eleição</label>\n              <Select value={selectedYear} onValueChange={setSelectedYear}>\n                <SelectTrigger data-testid=\"select-year\">\n                  <SelectValue placeholder=\"Selecione o ano\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Todos os anos</SelectItem>\n                  {(years ?? []).map((year) => (\n                    <SelectItem key={year} value={String(year)}>\n                      {year}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Estado (UF)</label>\n              <Select value={selectedState} onValueChange={setSelectedState}>\n                <SelectTrigger data-testid=\"select-state\">\n                  <SelectValue placeholder=\"Selecione o estado\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Todos os estados</SelectItem>\n                  {(states ?? []).map((state) => (\n                    <SelectItem key={state} value={state}>\n                      {state}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Tipo de Eleição</label>\n              <Select value={selectedElectionType} onValueChange={setSelectedElectionType}>\n                <SelectTrigger data-testid=\"select-election-type\">\n                  <SelectValue placeholder=\"Selecione o tipo\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Todos os tipos</SelectItem>\n                  {(electionTypes ?? []).map((type) => (\n                    <SelectItem key={type} value={type}>\n                      {type}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <Collapsible open={showAdvancedFilters} onOpenChange={setShowAdvancedFilters}>\n            <CollapsibleTrigger asChild>\n              <Button variant=\"ghost\" size=\"sm\" className=\"w-full\" data-testid=\"button-advanced-filters\">\n                <SlidersHorizontal className=\"h-4 w-4 mr-2\" />\n                Filtros Avançados\n                {showAdvancedFilters ? <ChevronUp className=\"h-4 w-4 ml-2\" /> : <ChevronDown className=\"h-4 w-4 ml-2\" />}\n              </Button>\n            </CollapsibleTrigger>\n            <CollapsibleContent className=\"pt-4 space-y-4\">\n              <div className=\"grid grid-cols-1 gap-4 sm:grid-cols-5\">\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm font-medium\">Cargo</label>\n                  <Select value={selectedPosition} onValueChange={setSelectedPosition}>\n                    <SelectTrigger data-testid=\"select-position\">\n                      <SelectValue placeholder=\"Selecione o cargo\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">Todos os cargos</SelectItem>\n                      {(positions ?? []).map((pos) => (\n                        <SelectItem key={pos} value={pos}>\n                          {pos}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm font-medium\">Partido</label>\n                  <Select value={selectedParty} onValueChange={setSelectedParty}>\n                    <SelectTrigger data-testid=\"select-party\">\n                      <SelectValue placeholder=\"Selecione o partido\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">Todos os partidos</SelectItem>\n                      {(partiesList ?? []).map((p) => (\n                        <SelectItem key={p.party} value={p.party}>\n                          {p.party} ({p.number})\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm font-medium\">Município</label>\n                  <Select \n                    value={selectedMunicipality} \n                    onValueChange={setSelectedMunicipality}\n                    disabled={selectedState === \"all\"}\n                  >\n                    <SelectTrigger data-testid=\"select-municipality\">\n                      <SelectValue placeholder={selectedState === \"all\" ? \"Selecione um estado primeiro\" : \"Selecione o município\"} />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">Todos os municípios</SelectItem>\n                      {(municipalities ?? []).map((m) => (\n                        <SelectItem key={m.code} value={m.name}>\n                          {m.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm font-medium\">Votos Mínimos</label>\n                  <Input\n                    type=\"number\"\n                    placeholder=\"0\"\n                    value={minVotes}\n                    onChange={(e) => setMinVotes(e.target.value)}\n                    data-testid=\"input-min-votes\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm font-medium\">Votos Máximos</label>\n                  <Input\n                    type=\"number\"\n                    placeholder=\"Sem limite\"\n                    value={maxVotes}\n                    onChange={(e) => setMaxVotes(e.target.value)}\n                    data-testid=\"input-max-votes\"\n                  />\n                </div>\n              </div>\n            </CollapsibleContent>\n          </Collapsible>\n\n          <div className=\"flex items-center justify-between border-t pt-4\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  id=\"compare-mode\"\n                  checked={compareMode}\n                  onCheckedChange={setCompareMode}\n                  data-testid=\"switch-compare-mode\"\n                />\n                <Label htmlFor=\"compare-mode\" className=\"flex items-center gap-1\">\n                  <GitCompare className=\"h-4 w-4\" />\n                  Modo Comparação\n                </Label>\n              </div>\n            </div>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => {\n                setSelectedYear(\"all\");\n                setSelectedState(\"all\");\n                setSelectedElectionType(\"all\");\n                setSelectedPosition(\"all\");\n                setSelectedParty(\"all\");\n                setSelectedMunicipality(\"all\");\n                setMinVotes(\"\");\n                setMaxVotes(\"\");\n                setSelectedReport(null);\n              }}\n              data-testid=\"button-clear-filters\"\n            >\n              Limpar Filtros\n            </Button>\n          </div>\n\n          {compareMode && (\n            <div className=\"border rounded-lg p-4 bg-muted/30 space-y-4\">\n              <p className=\"text-sm font-medium\">Selecione anos ou estados para comparar:</p>\n              <div className=\"grid grid-cols-1 gap-4 sm:grid-cols-2\">\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm text-muted-foreground\">Anos para comparar</label>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {(years ?? []).map((year) => (\n                      <div key={year} className=\"flex items-center gap-1\">\n                        <Checkbox\n                          id={`year-${year}`}\n                          checked={compareYears.includes(year)}\n                          onCheckedChange={(checked) => {\n                            if (checked) {\n                              setCompareYears([...compareYears, year]);\n                            } else {\n                              setCompareYears(compareYears.filter(y => y !== year));\n                            }\n                          }}\n                          data-testid={`checkbox-year-${year}`}\n                        />\n                        <label htmlFor={`year-${year}`} className=\"text-sm\">{year}</label>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm text-muted-foreground\">Estados para comparar</label>\n                  <div className=\"flex flex-wrap gap-2 max-h-24 overflow-y-auto\">\n                    {(states ?? []).slice(0, 10).map((state) => (\n                      <div key={state} className=\"flex items-center gap-1\">\n                        <Checkbox\n                          id={`state-${state}`}\n                          checked={compareStates.includes(state)}\n                          onCheckedChange={(checked) => {\n                            if (checked) {\n                              setCompareStates([...compareStates, state]);\n                            } else {\n                              setCompareStates(compareStates.filter(s => s !== state));\n                            }\n                          }}\n                          data-testid={`checkbox-state-${state}`}\n                        />\n                        <label htmlFor={`state-${state}`} className=\"text-sm\">{state}</label>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-4\">\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm text-muted-foreground\">Agrupar por</label>\n                  <Select value={compareGroupBy} onValueChange={(v) => setCompareGroupBy(v as \"party\" | \"state\" | \"position\")}>\n                    <SelectTrigger className=\"w-40\" data-testid=\"select-compare-group-by\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"party\">Partido</SelectItem>\n                      <SelectItem value=\"state\">Estado</SelectItem>\n                      <SelectItem value=\"position\">Cargo</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <Button\n                  onClick={() => compareMutation.mutate()}\n                  disabled={compareMutation.isPending || (compareYears.length === 0 && compareStates.length === 0)}\n                  data-testid=\"button-compare\"\n                >\n                  {compareMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin mr-2\" /> : <GitCompare className=\"h-4 w-4 mr-2\" />}\n                  Comparar\n                </Button>\n              </div>\n              {compareMutation.data && (\n                <div className=\"mt-4\">\n                  <p className=\"text-sm font-medium mb-2\">Resultado da Comparação:</p>\n                  <div className=\"h-64\">\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\n                      <BarChart data={compareMutation.data.flatMap((d: any) => d.data.slice(0, 5).map((item: any) => ({ ...item, group: d.label })))}>\n                        <CartesianGrid strokeDasharray=\"3 3\" />\n                        <XAxis dataKey=\"key\" />\n                        <YAxis tickFormatter={formatNumber} />\n                        <Tooltip\n                          formatter={(value: number) => [formatNumber(value), \"Votos\"]}\n                          labelFormatter={(label) => `${label}`}\n                        />\n                        <Legend />\n                        <Bar dataKey=\"votes\" fill=\"#003366\" name=\"Votos\" />\n                      </BarChart>\n                    </ResponsiveContainer>\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={showSaveDialog} onOpenChange={setShowSaveDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Salvar Relatório</DialogTitle>\n            <DialogDescription>\n              Salve os filtros atuais como um relatório para acesso rápido\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"report-name\">Nome do Relatório</Label>\n              <Input\n                id=\"report-name\"\n                value={reportName}\n                onChange={(e) => setReportName(e.target.value)}\n                placeholder=\"Ex: Vereadores SP 2024\"\n                data-testid=\"input-report-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"report-description\">Descrição (opcional)</Label>\n              <Textarea\n                id=\"report-description\"\n                value={reportDescription}\n                onChange={(e) => setReportDescription(e.target.value)}\n                placeholder=\"Descreva o relatório...\"\n                data-testid=\"input-report-description\"\n              />\n            </div>\n            <div className=\"text-sm text-muted-foreground\">\n              <p>Filtros que serão salvos:</p>\n              <ul className=\"list-disc list-inside mt-1\">\n                {Object.entries(filters).map(([key, value]) => (\n                  <li key={key}>{key}: {value}</li>\n                ))}\n                {Object.keys(filters).length === 0 && <li>Nenhum filtro aplicado</li>}\n              </ul>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowSaveDialog(false)}>\n              Cancelar\n            </Button>\n            <Button\n              onClick={() => saveReportMutation.mutate()}\n              disabled={saveReportMutation.isPending || !reportName.trim()}\n              data-testid=\"button-confirm-save-report\"\n            >\n              {saveReportMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin mr-2\" /> : <Save className=\"h-4 w-4 mr-2\" />}\n              Salvar\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {savedReports && savedReports.length > 0 && (\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"flex items-center gap-2 text-lg\">\n              <FolderOpen className=\"h-4 w-4\" />\n              Relatórios Salvos\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 gap-2 sm:grid-cols-2 lg:grid-cols-3\">\n              {savedReports.map((report) => (\n                <div\n                  key={report.id}\n                  className=\"flex items-center justify-between p-3 rounded-lg border hover-elevate cursor-pointer\"\n                  onClick={() => loadReport(report)}\n                  data-testid={`card-report-${report.id}`}\n                >\n                  <div>\n                    <p className=\"font-medium text-sm\">{report.name}</p>\n                    {report.description && (\n                      <p className=\"text-xs text-muted-foreground\">{report.description}</p>\n                    )}\n                  </div>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      deleteReportMutation.mutate(report.id);\n                    }}\n                    data-testid={`button-delete-report-${report.id}`}\n                  >\n                    <Trash2 className=\"h-4 w-4 text-destructive\" />\n                  </Button>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      <div className=\"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Total de Votos</p>\n                {summaryLoading ? (\n                  <Skeleton className=\"h-8 w-24 mt-1\" />\n                ) : (\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-votes\">\n                    {formatNumber(summary?.totalVotes ?? 0)}\n                  </p>\n                )}\n              </div>\n              <div className=\"p-3 rounded-full bg-primary/10\">\n                <Vote className=\"h-5 w-5 text-primary\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Candidatos</p>\n                {summaryLoading ? (\n                  <Skeleton className=\"h-8 w-24 mt-1\" />\n                ) : (\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-candidates\">\n                    {formatNumber(summary?.totalCandidates ?? 0)}\n                  </p>\n                )}\n              </div>\n              <div className=\"p-3 rounded-full bg-green-500/10\">\n                <Users className=\"h-5 w-5 text-green-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Partidos</p>\n                {summaryLoading ? (\n                  <Skeleton className=\"h-8 w-24 mt-1\" />\n                ) : (\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-parties\">\n                    {formatNumber(summary?.totalParties ?? 0)}\n                  </p>\n                )}\n              </div>\n              <div className=\"p-3 rounded-full bg-orange-500/10\">\n                <Building2 className=\"h-5 w-5 text-orange-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Municípios</p>\n                {summaryLoading ? (\n                  <Skeleton className=\"h-8 w-24 mt-1\" />\n                ) : (\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-municipalities\">\n                    {formatNumber(summary?.totalMunicipalities ?? 0)}\n                  </p>\n                )}\n              </div>\n              <div className=\"p-3 rounded-full bg-purple-500/10\">\n                <MapPin className=\"h-5 w-5 text-purple-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {!hasData && !summaryLoading && (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <BarChart3 className=\"h-12 w-12 mx-auto text-muted-foreground/50 mb-4\" />\n            <h3 className=\"text-lg font-medium text-muted-foreground mb-2\">\n              Nenhum dado disponível\n            </h3>\n            <p className=\"text-sm text-muted-foreground\">\n              Importe dados do TSE na seção \"Importação TSE\" para visualizar análises.\n            </p>\n          </CardContent>\n        </Card>\n      )}\n\n      {hasData && (\n        <Tabs defaultValue=\"parties\" className=\"space-y-4\">\n          <TabsList className=\"grid w-full grid-cols-7\">\n            <TabsTrigger value=\"parties\" data-testid=\"tab-parties\">\n              <Building2 className=\"h-4 w-4 mr-2\" />\n              Partidos\n            </TabsTrigger>\n            <TabsTrigger value=\"candidates\" data-testid=\"tab-candidates\">\n              <Users className=\"h-4 w-4 mr-2\" />\n              Candidatos\n            </TabsTrigger>\n            <TabsTrigger value=\"states\" data-testid=\"tab-states\">\n              <MapPin className=\"h-4 w-4 mr-2\" />\n              Estados\n            </TabsTrigger>\n            <TabsTrigger value=\"municipalities\" data-testid=\"tab-municipalities\">\n              <TrendingUp className=\"h-4 w-4 mr-2\" />\n              Municípios\n            </TabsTrigger>\n            <TabsTrigger value=\"ai\" data-testid=\"tab-ai\">\n              <Brain className=\"h-4 w-4 mr-2\" />\n              IA\n            </TabsTrigger>\n            <TabsTrigger value=\"suggestions\" data-testid=\"tab-suggestions\">\n              <Lightbulb className=\"h-4 w-4 mr-2\" />\n              Sugestões\n            </TabsTrigger>\n            <TabsTrigger value=\"dashboards\" data-testid=\"tab-dashboards\">\n              <LayoutDashboard className=\"h-4 w-4 mr-2\" />\n              Dashboards\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"parties\" className=\"space-y-4\">\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handleExportCSV(\"parties\")}\n                disabled={exportLoading === \"parties\"}\n                data-testid=\"button-export-parties-csv\"\n              >\n                {exportLoading === \"parties\" ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <FileSpreadsheet className=\"h-4 w-4 mr-2\" />\n                )}\n                CSV\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handleExportPDF(\"parties\", \"Votos por Partido\", votesByParty ?? [])}\n                disabled={exportLoading === \"pdf-parties\"}\n                data-testid=\"button-export-parties-pdf\"\n              >\n                {exportLoading === \"pdf-parties\" ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                )}\n                PDF\n              </Button>\n            </div>\n            <div className=\"grid grid-cols-1 gap-4 lg:grid-cols-2\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-lg\">Distribuição de Votos por Partido</CardTitle>\n                  <CardDescription>Top 10 partidos mais votados</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {partyLoading ? (\n                    <div className=\"h-[300px] flex items-center justify-center\">\n                      <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n                    </div>\n                  ) : (\n                    <ResponsiveContainer width=\"100%\" height={300}>\n                      <BarChart data={(votesByParty ?? []).slice(0, 10)} layout=\"vertical\">\n                        <CartesianGrid strokeDasharray=\"3 3\" />\n                        <XAxis type=\"number\" tickFormatter={formatNumber} />\n                        <YAxis type=\"category\" dataKey=\"party\" width={60} />\n                        <Tooltip content={<CustomTooltip type=\"party\" />} />\n                        <Bar dataKey=\"votes\" fill=\"#003366\" name=\"Votos\" />\n                      </BarChart>\n                    </ResponsiveContainer>\n                  )}\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-lg\">Proporção de Votos</CardTitle>\n                  <CardDescription>Participação percentual dos partidos</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {partyLoading ? (\n                    <div className=\"h-[300px] flex items-center justify-center\">\n                      <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n                    </div>\n                  ) : (\n                    <ResponsiveContainer width=\"100%\" height={300}>\n                      <PieChart>\n                        <Pie\n                          data={(votesByParty ?? []).slice(0, 8)}\n                          dataKey=\"votes\"\n                          nameKey=\"party\"\n                          cx=\"50%\"\n                          cy=\"50%\"\n                          outerRadius={100}\n                          label={({ party, percent }) => `${party} (${(percent * 100).toFixed(1)}%)`}\n                        >\n                          {(votesByParty ?? []).slice(0, 8).map((_, index) => (\n                            <Cell key={`cell-${index}`} fill={CHART_COLORS[index % CHART_COLORS.length]} />\n                          ))}\n                        </Pie>\n                        <Tooltip content={<CustomTooltip type=\"party\" />} />\n                        <Legend />\n                      </PieChart>\n                    </ResponsiveContainer>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"candidates\" className=\"space-y-4\">\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handleExportCSV(\"candidates\")}\n                disabled={exportLoading === \"candidates\"}\n                data-testid=\"button-export-candidates-csv\"\n              >\n                {exportLoading === \"candidates\" ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <FileSpreadsheet className=\"h-4 w-4 mr-2\" />\n                )}\n                CSV\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handleExportPDF(\"candidates\", \"Candidatos Mais Votados\", topCandidates ?? [])}\n                disabled={exportLoading === \"pdf-candidates\"}\n                data-testid=\"button-export-candidates-pdf\"\n              >\n                {exportLoading === \"pdf-candidates\" ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                )}\n                PDF\n              </Button>\n            </div>\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-lg\">Candidatos Mais Votados</CardTitle>\n                <CardDescription>Top 20 candidatos por número de votos</CardDescription>\n              </CardHeader>\n              <CardContent>\n                {candidatesLoading ? (\n                  <div className=\"h-[400px] flex items-center justify-center\">\n                    <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n                  </div>\n                ) : (\n                  <ResponsiveContainer width=\"100%\" height={400}>\n                    <BarChart data={(topCandidates ?? []).slice(0, 15)}>\n                      <CartesianGrid strokeDasharray=\"3 3\" />\n                      <XAxis dataKey=\"nickname\" angle={-45} textAnchor=\"end\" height={80} interval={0} fontSize={10} />\n                      <YAxis tickFormatter={formatNumber} />\n                      <Tooltip content={<CustomTooltip type=\"candidate\" />} />\n                      <Bar dataKey=\"votes\" fill=\"#FFD700\" name=\"Votos\" />\n                    </BarChart>\n                  </ResponsiveContainer>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"states\" className=\"space-y-4\">\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handleExportCSV(\"states\")}\n                disabled={exportLoading === \"states\"}\n                data-testid=\"button-export-states-csv\"\n              >\n                {exportLoading === \"states\" ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <FileSpreadsheet className=\"h-4 w-4 mr-2\" />\n                )}\n                CSV\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handleExportPDF(\"states\", \"Votos por Estado\", votesByState ?? [])}\n                disabled={exportLoading === \"pdf-states\"}\n                data-testid=\"button-export-states-pdf\"\n              >\n                {exportLoading === \"pdf-states\" ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                )}\n                PDF\n              </Button>\n            </div>\n            <div className=\"grid grid-cols-1 gap-4 lg:grid-cols-2\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-lg\">Votos por Estado</CardTitle>\n                  <CardDescription>Distribuição geográfica de votos</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {stateVotesLoading ? (\n                    <div className=\"h-[350px] flex items-center justify-center\">\n                      <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n                    </div>\n                  ) : (\n                    <ResponsiveContainer width=\"100%\" height={350}>\n                      <AreaChart data={votesByState ?? []}>\n                        <CartesianGrid strokeDasharray=\"3 3\" />\n                        <XAxis dataKey=\"state\" />\n                        <YAxis tickFormatter={formatNumber} />\n                        <Tooltip content={<CustomTooltip type=\"state\" />} />\n                        <Area type=\"monotone\" dataKey=\"votes\" stroke=\"#003366\" fill=\"#003366\" fillOpacity={0.3} name=\"Votos\" />\n                      </AreaChart>\n                    </ResponsiveContainer>\n                  )}\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-lg\">Candidatos por Estado</CardTitle>\n                  <CardDescription>Número de candidatos em cada UF</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {stateVotesLoading ? (\n                    <div className=\"h-[350px] flex items-center justify-center\">\n                      <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n                    </div>\n                  ) : (\n                    <ResponsiveContainer width=\"100%\" height={350}>\n                      <BarChart data={votesByState ?? []}>\n                        <CartesianGrid strokeDasharray=\"3 3\" />\n                        <XAxis dataKey=\"state\" />\n                        <YAxis />\n                        <Tooltip />\n                        <Bar dataKey=\"candidateCount\" fill=\"#2ecc71\" name=\"Candidatos\" />\n                        <Bar dataKey=\"partyCount\" fill=\"#9b59b6\" name=\"Partidos\" />\n                      </BarChart>\n                    </ResponsiveContainer>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"municipalities\" className=\"space-y-4\">\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handleExportCSV(\"municipalities\")}\n                disabled={exportLoading === \"municipalities\"}\n                data-testid=\"button-export-municipalities-csv\"\n              >\n                {exportLoading === \"municipalities\" ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <FileSpreadsheet className=\"h-4 w-4 mr-2\" />\n                )}\n                CSV\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handleExportPDF(\"municipalities\", \"Votos por Município\", votesByMunicipality ?? [])}\n                disabled={exportLoading === \"pdf-municipalities\"}\n                data-testid=\"button-export-municipalities-pdf\"\n              >\n                {exportLoading === \"pdf-municipalities\" ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                )}\n                PDF\n              </Button>\n            </div>\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-lg\">Top 20 Municípios</CardTitle>\n                <CardDescription>Municípios com maior número de votos</CardDescription>\n              </CardHeader>\n              <CardContent>\n                {municipalityLoading ? (\n                  <div className=\"h-[400px] flex items-center justify-center\">\n                    <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n                  </div>\n                ) : (\n                  <ResponsiveContainer width=\"100%\" height={400}>\n                    <BarChart data={(votesByMunicipality ?? []).slice(0, 20)} layout=\"vertical\">\n                      <CartesianGrid strokeDasharray=\"3 3\" />\n                      <XAxis type=\"number\" tickFormatter={formatNumber} />\n                      <YAxis type=\"category\" dataKey=\"municipality\" width={120} fontSize={10} />\n                      <Tooltip\n                        formatter={(value: number) => formatNumber(value)}\n                        labelFormatter={(label) => {\n                          const muni = (votesByMunicipality ?? []).find((m) => m.municipality === label);\n                          return muni ? `${muni.municipality} - ${muni.state}` : label;\n                        }}\n                      />\n                      <Bar dataKey=\"votes\" fill=\"#e74c3c\" name=\"Votos\" />\n                    </BarChart>\n                  </ResponsiveContainer>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"ai\" className=\"space-y-4\">\n            <div className=\"grid grid-cols-1 gap-4 lg:grid-cols-2\">\n              <Card className=\"lg:col-span-2\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <MessageSquare className=\"h-5 w-5 text-primary\" />\n                    Assistente de IA\n                  </CardTitle>\n                  <CardDescription>\n                    Faça perguntas sobre os dados eleitorais em linguagem natural\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"flex gap-2\">\n                    <Textarea\n                      placeholder=\"Ex: Quais partidos tiveram mais votos? Quem foi o candidato mais votado?\"\n                      value={aiQuestion}\n                      onChange={(e) => setAiQuestion(e.target.value)}\n                      className=\"flex-1\"\n                      data-testid=\"input-ai-question\"\n                    />\n                    <Button\n                      onClick={handleAskQuestion}\n                      disabled={assistantMutation.isPending || aiQuestion.trim().length < 5}\n                      data-testid=\"button-ask-ai\"\n                    >\n                      {assistantMutation.isPending ? (\n                        <Loader2 className=\"h-4 w-4 animate-spin\" />\n                      ) : (\n                        <Send className=\"h-4 w-4\" />\n                      )}\n                    </Button>\n                  </div>\n                  {aiAnswer && (\n                    <div className=\"p-4 rounded-lg bg-muted/50 space-y-2\" data-testid=\"container-ai-answer\">\n                      <p className=\"text-sm font-medium text-muted-foreground\" data-testid=\"text-ai-question\">\n                        Pergunta: {aiAnswer.question}\n                      </p>\n                      <p className=\"text-sm whitespace-pre-wrap\" data-testid=\"text-ai-answer\">{aiAnswer.answer}</p>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Sparkles className=\"h-5 w-5 text-yellow-500\" />\n                    Previsão Histórica\n                  </CardTitle>\n                  <CardDescription>\n                    Analise tendências baseadas em dados históricos\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <Button\n                    onClick={() => predictionMutation.mutate()}\n                    disabled={predictionMutation.isPending}\n                    className=\"w-full\"\n                    data-testid=\"button-generate-prediction\"\n                  >\n                    {predictionMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                        Analisando...\n                      </>\n                    ) : (\n                      <>\n                        <TrendingUp className=\"h-4 w-4 mr-2\" />\n                        Gerar Previsão\n                      </>\n                    )}\n                  </Button>\n                  {historicalPrediction && (\n                    <div className=\"space-y-4\" data-testid=\"container-prediction\">\n                      <div className=\"p-4 rounded-lg bg-muted/50\">\n                        <p className=\"text-sm whitespace-pre-wrap\" data-testid=\"text-prediction-analysis\">{historicalPrediction.analysis}</p>\n                      </div>\n                      {historicalPrediction.trends && (\n                        <div className=\"space-y-2\" data-testid=\"container-prediction-trends\">\n                          <p className=\"text-sm font-medium\">Tendências:</p>\n                          {historicalPrediction.trends.slice(0, 5).map((trend: any, i: number) => (\n                            <div key={i} className=\"flex items-center gap-2 text-sm\" data-testid={`item-trend-${i}`}>\n                              {trend.trend === \"crescimento\" && <TrendingUp className=\"h-4 w-4 text-green-500\" />}\n                              {trend.trend === \"declínio\" && <TrendingDown className=\"h-4 w-4 text-red-500\" />}\n                              {trend.trend === \"estável\" && <Minus className=\"h-4 w-4 text-gray-500\" />}\n                              <span className=\"font-medium\">{trend.party}</span>\n                              <span className=\"text-muted-foreground\">{trend.observation}</span>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                      {historicalPrediction.insights && (\n                        <div className=\"space-y-1\" data-testid=\"container-prediction-insights\">\n                          <p className=\"text-sm font-medium\">Insights:</p>\n                          {historicalPrediction.insights.map((insight: string, i: number) => (\n                            <p key={i} className=\"text-sm text-muted-foreground\" data-testid={`text-insight-${i}`}>• {insight}</p>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <AlertTriangle className=\"h-5 w-5 text-orange-500\" />\n                    Detecção de Anomalias\n                  </CardTitle>\n                  <CardDescription>\n                    Identifique padrões incomuns nos dados de votação\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <Button\n                    onClick={() => anomalyMutation.mutate()}\n                    disabled={anomalyMutation.isPending}\n                    className=\"w-full\"\n                    variant=\"outline\"\n                    data-testid=\"button-detect-anomalies\"\n                  >\n                    {anomalyMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                        Analisando...\n                      </>\n                    ) : (\n                      <>\n                        <AlertTriangle className=\"h-4 w-4 mr-2\" />\n                        Detectar Anomalias\n                      </>\n                    )}\n                  </Button>\n                  {anomalyReport && (\n                    <div className=\"space-y-4\" data-testid=\"container-anomaly\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"text-sm font-medium\">Risco Geral:</span>\n                        <Badge\n                          variant={\n                            anomalyReport.overallRisk === \"alto\" ? \"destructive\" :\n                            anomalyReport.overallRisk === \"médio\" ? \"secondary\" : \"outline\"\n                          }\n                          data-testid=\"badge-anomaly-risk\"\n                        >\n                          {anomalyReport.overallRisk?.toUpperCase()}\n                        </Badge>\n                      </div>\n                      <div className=\"p-4 rounded-lg bg-muted/50\">\n                        <p className=\"text-sm whitespace-pre-wrap\" data-testid=\"text-anomaly-summary\">{anomalyReport.summary}</p>\n                      </div>\n                      {anomalyReport.anomalies && anomalyReport.anomalies.length > 0 && (\n                        <div className=\"space-y-2\" data-testid=\"container-anomaly-list\">\n                          <p className=\"text-sm font-medium\">Anomalias Detectadas:</p>\n                          {anomalyReport.anomalies.slice(0, 5).map((anomaly: any, i: number) => (\n                            <div key={i} className=\"p-2 rounded border text-sm\" data-testid={`item-anomaly-${i}`}>\n                              <div className=\"flex items-center gap-2 mb-1\">\n                                <Badge variant=\"outline\" className=\"text-xs\">{anomaly.type}</Badge>\n                                <Badge\n                                  variant={anomaly.severity === \"alta\" ? \"destructive\" : \"secondary\"}\n                                  className=\"text-xs\"\n                                >\n                                  {anomaly.severity}\n                                </Badge>\n                              </div>\n                              <p className=\"text-muted-foreground\">{anomaly.description}</p>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                      {anomalyReport.observations && (\n                        <div className=\"space-y-1\" data-testid=\"container-anomaly-observations\">\n                          <p className=\"text-sm font-medium\">Observações:</p>\n                          {anomalyReport.observations.map((obs: string, i: number) => (\n                            <p key={i} className=\"text-sm text-muted-foreground\" data-testid={`text-observation-${i}`}>• {obs}</p>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n          </TabsContent>\n\n          {/* AI Suggestions Tab */}\n          <TabsContent value=\"suggestions\" className=\"space-y-4\">\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Lightbulb className=\"h-5 w-5 text-amber-500\" />\n                      Sugestões Inteligentes\n                    </CardTitle>\n                    <CardDescription>\n                      Recomendações de gráficos e análises baseadas em IA\n                    </CardDescription>\n                  </div>\n                  <Button\n                    onClick={() => generateSuggestionsMutation.mutate()}\n                    disabled={generateSuggestionsMutation.isPending}\n                    data-testid=\"button-generate-suggestions\"\n                  >\n                    {generateSuggestionsMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    ) : (\n                      <Sparkles className=\"h-4 w-4 mr-2\" />\n                    )}\n                    Gerar Sugestões\n                  </Button>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {(!aiSuggestions || aiSuggestions.length === 0) ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <Lightbulb className=\"h-12 w-12 mx-auto mb-4 opacity-20\" />\n                    <p>Nenhuma sugestão disponível.</p>\n                    <p className=\"text-sm\">Clique em \"Gerar Sugestões\" para receber recomendações baseadas nos dados atuais.</p>\n                  </div>\n                ) : (\n                  <div className=\"grid gap-4 md:grid-cols-2\">\n                    {aiSuggestions.map((suggestion) => (\n                      <Card key={suggestion.id} className=\"relative\" data-testid={`card-suggestion-${suggestion.id}`}>\n                        <CardHeader className=\"pb-2\">\n                          <div className=\"flex items-start justify-between gap-2\">\n                            <div className=\"flex-1\">\n                              <Badge variant=\"outline\" className=\"mb-2\">\n                                {suggestion.suggestionType === \"chart\" ? \"Gráfico\" :\n                                 suggestion.suggestionType === \"report\" ? \"Relatório\" : \"Insight\"}\n                              </Badge>\n                              <CardTitle className=\"text-base\">{suggestion.title}</CardTitle>\n                            </div>\n                            <div className=\"flex items-center gap-1\">\n                              <Badge variant=\"secondary\" className=\"text-xs\">\n                                {suggestion.relevanceScore}%\n                              </Badge>\n                              <Button\n                                size=\"icon\"\n                                variant=\"ghost\"\n                                onClick={() => dismissSuggestionMutation.mutate(suggestion.id)}\n                                data-testid={`button-dismiss-${suggestion.id}`}\n                              >\n                                <X className=\"h-4 w-4\" />\n                              </Button>\n                            </div>\n                          </div>\n                        </CardHeader>\n                        <CardContent className=\"pt-0\">\n                          <p className=\"text-sm text-muted-foreground mb-3\">{suggestion.description}</p>\n                          <div className=\"flex gap-2\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => applySuggestionMutation.mutate(suggestion.id)}\n                              disabled={suggestion.applied}\n                              data-testid={`button-apply-${suggestion.id}`}\n                            >\n                              {suggestion.applied ? (\n                                <>Aplicado</>\n                              ) : (\n                                <>\n                                  <Eye className=\"h-3 w-3 mr-1\" />\n                                  Aplicar\n                                </>\n                              )}\n                            </Button>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* Custom Dashboards Tab */}\n          <TabsContent value=\"dashboards\" className=\"space-y-4\">\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <LayoutDashboard className=\"h-5 w-5 text-blue-500\" />\n                      Dashboards Personalizados\n                    </CardTitle>\n                    <CardDescription>\n                      Crie e gerencie dashboards com filtros e visualizações personalizadas\n                    </CardDescription>\n                  </div>\n                  <Button onClick={() => setShowDashboardDialog(true)} data-testid=\"button-create-dashboard\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Novo Dashboard\n                  </Button>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {(!customDashboards || customDashboards.length === 0) ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <LayoutDashboard className=\"h-12 w-12 mx-auto mb-4 opacity-20\" />\n                    <p>Nenhum dashboard criado ainda.</p>\n                    <p className=\"text-sm\">Crie um dashboard personalizado para salvar suas visualizações favoritas.</p>\n                  </div>\n                ) : (\n                  <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                    {customDashboards.map((dashboard) => (\n                      <Card key={dashboard.id} className=\"relative\" data-testid={`card-dashboard-${dashboard.id}`}>\n                        <CardHeader className=\"pb-2\">\n                          <div className=\"flex items-start justify-between gap-2\">\n                            <div className=\"flex-1\">\n                              <div className=\"flex items-center gap-2 mb-1\">\n                                <CardTitle className=\"text-base\">{dashboard.name}</CardTitle>\n                                {dashboard.isPublic && (\n                                  <Badge variant=\"outline\" className=\"text-xs\">\n                                    <Globe className=\"h-3 w-3 mr-1\" />\n                                    Público\n                                  </Badge>\n                                )}\n                              </div>\n                            </div>\n                            <Button\n                              size=\"icon\"\n                              variant=\"ghost\"\n                              onClick={() => deleteDashboardMutation.mutate(dashboard.id)}\n                              data-testid={`button-delete-dashboard-${dashboard.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        </CardHeader>\n                        <CardContent className=\"pt-0\">\n                          {dashboard.description && (\n                            <p className=\"text-sm text-muted-foreground mb-3\">{dashboard.description}</p>\n                          )}\n                          <div className=\"text-xs text-muted-foreground\">\n                            Atualizado em: {new Date(dashboard.updatedAt).toLocaleDateString('pt-BR')}\n                          </div>\n                          <div className=\"mt-3\">\n                            <Button \n                              size=\"sm\" \n                              variant=\"outline\" \n                              onClick={() => loadDashboard(dashboard)}\n                              data-testid={`button-view-dashboard-${dashboard.id}`}\n                            >\n                              <Eye className=\"h-3 w-3 mr-1\" />\n                              Aplicar Filtros\n                            </Button>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n      )}\n\n      {/* Create Dashboard Dialog */}\n      <Dialog open={showDashboardDialog} onOpenChange={setShowDashboardDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Criar Novo Dashboard</DialogTitle>\n            <DialogDescription>\n              Salve suas configurações de filtros e visualizações em um dashboard personalizado.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"dashboardName\">Nome do Dashboard</Label>\n              <Input\n                id=\"dashboardName\"\n                placeholder=\"Ex: Análise Eleição 2022\"\n                value={dashboardName}\n                onChange={(e) => setDashboardName(e.target.value)}\n                data-testid=\"input-dashboard-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"dashboardDesc\">Descrição (opcional)</Label>\n              <Textarea\n                id=\"dashboardDesc\"\n                placeholder=\"Descreva o propósito deste dashboard...\"\n                value={dashboardDescription}\n                onChange={(e) => setDashboardDescription(e.target.value)}\n                data-testid=\"input-dashboard-description\"\n              />\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Switch\n                id=\"dashboardPublic\"\n                checked={dashboardIsPublic}\n                onCheckedChange={setDashboardIsPublic}\n                data-testid=\"switch-dashboard-public\"\n              />\n              <Label htmlFor=\"dashboardPublic\" className=\"flex items-center gap-2\">\n                <Globe className=\"h-4 w-4\" />\n                Dashboard público\n              </Label>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowDashboardDialog(false)}>\n              Cancelar\n            </Button>\n            <Button\n              onClick={() => createDashboardMutation.mutate()}\n              disabled={!dashboardName || createDashboardMutation.isPending}\n              data-testid=\"button-save-dashboard\"\n            >\n              {createDashboardMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Criar Dashboard\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":78937,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"design_guidelines.md":{"content":"# Design Guidelines: Brazilian Electoral Simulation System\n\n## Design Approach\n**Government Dashboard System** - Professional institutional interface inspired by TSE (Tribunal Superior Eleitoral) and Power BI dashboards. This is a data-dense, utility-focused application prioritizing clarity, authority, and comprehensive information display.\n\n## Core Design Principles\n1. **Institutional Authority**: Professional government-style interface that conveys trust and credibility\n2. **Data Clarity**: Complex electoral calculations presented with absolute clarity\n3. **Hierarchical Organization**: Clear information architecture with tabs, sections, and cards\n4. **Responsive Professionalism**: Maintains formal design integrity across all devices\n\n## Typography System\n\n**Font Families:**\n- Primary: Roboto (headings, UI elements, buttons)\n- Secondary: Open Sans (body text, descriptions)\n- Monospace: Roboto Mono (numerical data, calculations, audit logs)\n\n**Hierarchy:**\n- Page Titles: text-4xl font-bold (Roboto)\n- Section Headers: text-2xl font-semibold (Roboto)\n- Card Titles: text-xl font-medium (Roboto)\n- Body Text: text-base (Open Sans)\n- Data/Numbers: text-lg font-mono (Roboto Mono)\n- Labels: text-sm font-medium uppercase tracking-wide\n- Captions: text-xs text-gray-600\n\n## Layout System\n\n**Spacing Units:** Tailwind units of 2, 4, 6, 8, and 12\n- Component padding: p-6\n- Card spacing: space-y-4, gap-6\n- Section margins: mb-8, mt-12\n- Grid gaps: gap-4 for dense data, gap-6 for cards\n\n**Container Strategy:**\n- Dashboard: max-w-7xl with full-width data tables\n- Forms: max-w-3xl centered\n- Sidebar navigation: w-64 fixed\n\n**Grid Patterns:**\n- Simulation cards: grid-cols-1 md:grid-cols-2 lg:grid-cols-3\n- Metrics/stats: grid-cols-2 md:grid-cols-4\n- Data tables: full-width responsive with horizontal scroll\n\n## Component Library\n\n### Navigation\n- **Top Bar**: Fixed header with logo, system name, user menu, notification icon\n- **Sidebar**: Fixed left navigation with role-based menu items, collapsible on mobile\n- **Breadcrumbs**: Always present for deep navigation paths\n- **Tabs**: Primary navigation within sections (simulations, parties, candidates, audit)\n\n### Data Display\n- **Cards**: Elevated (shadow-md) with p-6, rounded-lg, bg-white\n- **Tables**: Striped rows, sticky headers, sortable columns, pagination footer\n- **Charts**: Recharts bar/pie charts with institutional color scheme\n- **Metrics Cards**: Large numbers with labels, icon indicators, trend arrows\n- **Status Badges**: Rounded-full px-3 py-1 with role-specific colors\n\n### Forms\n- **Input Fields**: Bordered (border-2), rounded-md, p-3, with floating labels\n- **Dropdowns**: Full-width selects with search capability for parties/candidates\n- **Number Inputs**: Roboto Mono font for vote counts and calculations\n- **Multi-step Forms**: Progress indicator at top for scenario creation\n- **Validation**: Inline error messages in alert color, success checkmarks in green\n\n### Interactive Elements\n- **Primary Buttons**: bg-[#003366] text-white px-6 py-3 rounded-md font-medium\n- **Secondary Buttons**: border-2 border-[#003366] text-[#003366] px-6 py-3\n- **Icon Buttons**: For table actions (edit, delete, view) with tooltips\n- **Calculation Trigger**: Prominent \"Calculate Results\" button in gold accent\n- **Export Buttons**: PDF/CSV download buttons with document icons\n\n### Dashboards\n- **Summary Row**: 4-column metric cards showing key statistics\n- **Main Content**: 2-column layout (left: filters/controls, right: results visualization)\n- **Results Display**: Tabbed interface (table view, chart view, detailed breakdown)\n- **AI Predictions Panel**: Distinct card with loading states and confidence indicators\n\n### Audit Trail\n- **Log Table**: Chronological list with timestamp, user, action, details columns\n- **Filters**: Date range picker, user selector, action type dropdown\n- **Details Modal**: Expandable view showing complete change data in JSON format\n\n## Visual Patterns\n\n**Electoral Calculation Display:**\n- Quociente eleitoral shown prominently with formula visualization\n- Party results in sortable table with seat allocation columns\n- D'Hondt method breakdown in expandable accordion\n- Color-coded party rows (using party-specific colors where available)\n\n**Scenario Management:**\n- Card grid for saved scenarios with quick stats preview\n- \"New Scenario\" prominent card with dashed border\n- Comparison view: side-by-side tables for multiple scenarios\n\n**Authentication & Access:**\n- Clean login page with institutional logo and tagline\n- Role indicator badge always visible in top bar\n- Permission-based UI element visibility (no hidden features, clear disabled states)\n\n## Responsive Behavior\n- Desktop (lg:): Full sidebar, 3-column grids, expanded tables\n- Tablet (md:): Collapsible sidebar, 2-column grids, scrollable tables\n- Mobile: Hamburger menu, stacked cards, mobile-optimized table cards\n\n## Images\nNo hero images required. This is a dashboard application focused on data and functionality. Use institutional logo and icons throughout.\n\n**Icon Strategy:**\n- Use Heroicons for consistent UI icons\n- Party/candidate photos in circular avatars (w-12 h-12)\n- TSE logo in header for institutional branding\n\n## Critical UI States\n- **Loading**: Skeleton screens for tables, spinner for calculations\n- **Empty States**: Helpful illustrations with \"Add First Party/Candidate\" CTAs\n- **Error States**: Alert color banners with retry actions\n- **Success**: Green confirmation toasts for saved operations\n- **Calculation Progress**: Progress bar for complex simulations\n\nThis comprehensive design creates a professional, data-rich electoral simulation platform that balances governmental authority with modern usability.","path":null,"size_bytes":5720,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/pages/scenarios.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Plus, Edit, Trash2, FileText, PlayCircle, Eye, Handshake, Users, History, Loader2 } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Scenario, InsertScenario } from \"@shared/schema\";\n\nexport default function Scenarios() {\n  const { hasPermission } = useAuth();\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingScenario, setEditingScenario] = useState<Scenario | null>(null);\n  const [deleteConfirmId, setDeleteConfirmId] = useState<number | null>(null);\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    description: \"\",\n    totalVoters: \"\",\n    validVotes: \"\",\n    availableSeats: \"\",\n    position: \"vereador\",\n  });\n\n  // Historical election selection\n  const [useHistoricalData, setUseHistoricalData] = useState(false);\n  const [historicalYear, setHistoricalYear] = useState(\"\");\n  const [historicalUf, setHistoricalUf] = useState(\"\");\n  const [historicalCargo, setHistoricalCargo] = useState(\"\");\n\n  interface AvailableElection {\n    year: number;\n    ufs: string[];\n    cargos: Array<{ code: number; name: string }>;\n  }\n\n  const { data: scenarios, isLoading } = useQuery<Scenario[]>({\n    queryKey: [\"/api/scenarios\"],\n  });\n\n  const { data: availableElections } = useQuery<AvailableElection[]>({\n    queryKey: [\"/api/historical-elections/available\"],\n  });\n\n  interface ElectionSummary {\n    totalVoters: number;\n    validVotes: number;\n    availableSeats: number;\n  }\n\n  const { data: electionSummary, isLoading: isLoadingSummary } = useQuery<ElectionSummary>({\n    queryKey: [\"/api/historical-elections\", historicalYear, historicalUf, historicalCargo],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      params.set(\"year\", historicalYear);\n      params.set(\"cargo\", historicalCargo);\n      if (historicalUf && historicalUf !== \"all\") params.set(\"uf\", historicalUf);\n      const response = await fetch(`/api/historical-elections?${params}`, { credentials: \"include\" });\n      if (!response.ok) throw new Error(\"Failed to fetch election summary\");\n      return response.json();\n    },\n    enabled: !!historicalYear && !!historicalCargo,\n  });\n\n  useEffect(() => {\n    if (electionSummary && useHistoricalData) {\n      setFormData(f => ({\n        ...f,\n        totalVoters: String(electionSummary.totalVoters || 0),\n        validVotes: String(electionSummary.validVotes || 0),\n        availableSeats: String(electionSummary.availableSeats || 0),\n      }));\n    }\n  }, [electionSummary, useHistoricalData]);\n\n  const createMutation = useMutation({\n    mutationFn: async (data: InsertScenario) => {\n      return apiRequest(\"POST\", \"/api/scenarios\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenarios\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      toast({ title: \"Sucesso\", description: \"Cenário criado com sucesso\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar cenário\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: Partial<InsertScenario> }) => {\n      return apiRequest(\"PATCH\", `/api/scenarios/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenarios\"] });\n      toast({ title: \"Sucesso\", description: \"Cenário atualizado\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar cenário\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/scenarios/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenarios\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      toast({ title: \"Sucesso\", description: \"Cenário excluído\" });\n      setDeleteConfirmId(null);\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao excluir cenário\", variant: \"destructive\" });\n    },\n  });\n\n  function resetForm() {\n    setFormData({\n      name: \"\",\n      description: \"\",\n      totalVoters: \"\",\n      validVotes: \"\",\n      availableSeats: \"\",\n      position: \"vereador\",\n    });\n    setUseHistoricalData(false);\n    setHistoricalYear(\"\");\n    setHistoricalUf(\"\");\n    setHistoricalCargo(\"\");\n    setEditingScenario(null);\n    setIsDialogOpen(false);\n  }\n\n  const selectedElection = availableElections?.find(e => e.year === parseInt(historicalYear));\n  const cargoCodeToPosition: Record<number, string> = {\n    7: \"deputado_federal\",\n    8: \"deputado_estadual\",\n    13: \"vereador\",\n  };\n  const cargoCodeToLabel: Record<number, string> = {\n    7: \"Deputado Federal\",\n    8: \"Deputado Estadual\",\n    13: \"Vereador\",\n    11: \"Prefeito\",\n    3: \"Governador\",\n    5: \"Senador\",\n    1: \"Presidente\",\n  };\n\n  function handleEdit(scenario: Scenario) {\n    setEditingScenario(scenario);\n    setFormData({\n      name: scenario.name,\n      description: scenario.description || \"\",\n      totalVoters: String(scenario.totalVoters),\n      validVotes: String(scenario.validVotes),\n      availableSeats: String(scenario.availableSeats),\n      position: scenario.position,\n    });\n    setIsDialogOpen(true);\n  }\n\n  function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    const payload: Record<string, any> = {\n      name: formData.name,\n      description: formData.description || null,\n      totalVoters: parseInt(formData.totalVoters, 10),\n      validVotes: parseInt(formData.validVotes, 10),\n      availableSeats: parseInt(formData.availableSeats, 10),\n      position: formData.position,\n    };\n\n    // Include historical election reference if using historical data\n    if (useHistoricalData && historicalYear) {\n      payload.historicalYear = parseInt(historicalYear, 10);\n      payload.historicalUf = historicalUf && historicalUf !== \"all\" ? historicalUf : null;\n      payload.historicalMunicipio = null;\n    }\n\n    if (editingScenario) {\n      updateMutation.mutate({ id: editingScenario.id, data: payload });\n    } else {\n      createMutation.mutate(payload as InsertScenario);\n    }\n  }\n\n  const positions = [\n    { value: \"vereador\", label: \"Vereador\" },\n    { value: \"deputado_estadual\", label: \"Deputado Estadual\" },\n    { value: \"deputado_federal\", label: \"Deputado Federal\" },\n  ];\n\n  const statusLabels: Record<string, string> = {\n    draft: \"Rascunho\",\n    configured: \"Configurado\",\n    completed: \"Concluído\",\n  };\n\n  const statusVariants: Record<string, \"default\" | \"secondary\" | \"outline\"> = {\n    draft: \"outline\",\n    configured: \"secondary\",\n    completed: \"default\",\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <PageHeader\n        title=\"Cenários Eleitorais\"\n        description=\"Crie e gerencie cenários para simulações eleitorais\"\n        breadcrumbs={[\n          { label: \"Dashboard\", href: \"/\" },\n          { label: \"Cenários\" },\n        ]}\n        action={\n          hasPermission(\"manage_scenarios\")\n            ? {\n                label: \"Novo Cenário\",\n                icon: <Plus className=\"h-4 w-4 mr-2\" />,\n                onClick: () => setIsDialogOpen(true),\n              }\n            : undefined\n        }\n      />\n\n      {isLoading ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {Array.from({ length: 6 }).map((_, i) => (\n            <Card key={i}>\n              <CardContent className=\"p-6\">\n                <div className=\"h-32 animate-pulse bg-muted rounded\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : !scenarios || scenarios.length === 0 ? (\n        <Card>\n          <CardContent className=\"p-6\">\n            <EmptyState\n              icon={FileText}\n              title=\"Nenhum cenário criado\"\n              description=\"Crie cenários eleitorais para configurar simulações com diferentes parâmetros de votação.\"\n              actionLabel={hasPermission(\"manage_scenarios\") ? \"Criar Cenário\" : undefined}\n              onAction={hasPermission(\"manage_scenarios\") ? () => setIsDialogOpen(true) : undefined}\n            />\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {scenarios.map((scenario) => (\n            <Card key={scenario.id} className=\"hover-elevate\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex-1 min-w-0\">\n                    <CardTitle className=\"text-lg truncate\">{scenario.name}</CardTitle>\n                    <CardDescription className=\"line-clamp-2 mt-1\">\n                      {scenario.description || \"Sem descrição\"}\n                    </CardDescription>\n                  </div>\n                  <Badge variant={statusVariants[scenario.status]}>\n                    {statusLabels[scenario.status]}\n                  </Badge>\n                </div>\n              </CardHeader>\n              <CardContent className=\"pt-0\">\n                <div className=\"grid grid-cols-3 gap-4 mb-4\">\n                  <div className=\"text-center p-2 bg-muted rounded-md\">\n                    <p className=\"text-xl font-mono font-bold\">{scenario.totalVoters.toLocaleString(\"pt-BR\")}</p>\n                    <p className=\"text-xs text-muted-foreground\">Eleitores</p>\n                  </div>\n                  <div className=\"text-center p-2 bg-muted rounded-md\">\n                    <p className=\"text-xl font-mono font-bold\">{scenario.validVotes.toLocaleString(\"pt-BR\")}</p>\n                    <p className=\"text-xs text-muted-foreground\">Votos Válidos</p>\n                  </div>\n                  <div className=\"text-center p-2 bg-muted rounded-md\">\n                    <p className=\"text-xl font-mono font-bold\">{scenario.availableSeats}</p>\n                    <p className=\"text-xs text-muted-foreground\">Vagas</p>\n                  </div>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">\n                    {positions.find((p) => p.value === scenario.position)?.label}\n                  </span>\n                  <div className=\"flex items-center gap-1\">\n                    <Button variant=\"ghost\" size=\"icon\" asChild data-testid={`button-view-scenario-${scenario.id}`}>\n                      <Link href={`/simulations?scenario=${scenario.id}`}>\n                        <PlayCircle className=\"h-4 w-4\" />\n                      </Link>\n                    </Button>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button variant=\"ghost\" size=\"icon\" asChild data-testid={`button-candidates-scenario-${scenario.id}`}>\n                          <Link href={`/scenarios/${scenario.id}/candidates`}>\n                            <Users className=\"h-4 w-4\" />\n                          </Link>\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>Candidatos</p>\n                      </TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button variant=\"ghost\" size=\"icon\" asChild data-testid={`button-alliances-scenario-${scenario.id}`}>\n                          <Link href={`/scenarios/${scenario.id}/alliances`}>\n                            <Handshake className=\"h-4 w-4\" />\n                          </Link>\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>Federações e Coligações</p>\n                      </TooltipContent>\n                    </Tooltip>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => handleEdit(scenario)}\n                      disabled={!hasPermission(\"manage_scenarios\")}\n                      data-testid={`button-edit-scenario-${scenario.id}`}\n                    >\n                      <Edit className=\"h-4 w-4\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => setDeleteConfirmId(scenario.id)}\n                      disabled={!hasPermission(\"manage_scenarios\")}\n                      data-testid={`button-delete-scenario-${scenario.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4 text-destructive\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n\n          {hasPermission(\"manage_scenarios\") && (\n            <Card\n              className=\"border-dashed cursor-pointer hover-elevate flex items-center justify-center min-h-[200px]\"\n              onClick={() => setIsDialogOpen(true)}\n              data-testid=\"card-create-scenario\"\n            >\n              <div className=\"text-center p-6\">\n                <Plus className=\"h-10 w-10 mx-auto mb-2 text-muted-foreground\" />\n                <p className=\"font-medium\">Criar Novo Cenário</p>\n              </div>\n            </Card>\n          )}\n        </div>\n      )}\n\n      <Dialog open={isDialogOpen} onOpenChange={(open) => !open && resetForm()}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>{editingScenario ? \"Editar Cenário\" : \"Novo Cenário\"}</DialogTitle>\n            <DialogDescription>\n              {editingScenario ? \"Atualize os parâmetros do cenário\" : \"Configure os parâmetros do cenário eleitoral\"}\n            </DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Nome do Cenário</Label>\n              <Input\n                id=\"name\"\n                placeholder=\"Ex: Eleição Municipal 2024\"\n                value={formData.name}\n                onChange={(e) => setFormData((f) => ({ ...f, name: e.target.value }))}\n                required\n                data-testid=\"input-scenario-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\">Descrição</Label>\n              <Textarea\n                id=\"description\"\n                placeholder=\"Descrição do cenário (opcional)\"\n                value={formData.description}\n                onChange={(e) => setFormData((f) => ({ ...f, description: e.target.value }))}\n                rows={2}\n                data-testid=\"input-scenario-description\"\n              />\n            </div>\n\n            {!editingScenario && availableElections && availableElections.length > 0 && (\n              <>\n                <Separator />\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <Checkbox\n                      id=\"useHistorical\"\n                      checked={useHistoricalData}\n                      onCheckedChange={(checked) => setUseHistoricalData(checked === true)}\n                      data-testid=\"checkbox-use-historical\"\n                    />\n                    <Label htmlFor=\"useHistorical\" className=\"flex items-center gap-2 cursor-pointer\">\n                      <History className=\"h-4 w-4\" />\n                      Usar dados de eleição histórica\n                    </Label>\n                  </div>\n                  \n                  {useHistoricalData && (\n                    <div className=\"grid grid-cols-3 gap-2 p-3 bg-muted rounded-lg\">\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs\">Ano</Label>\n                        <Select value={historicalYear} onValueChange={(v) => { setHistoricalYear(v); setHistoricalUf(\"\"); setHistoricalCargo(\"\"); }}>\n                          <SelectTrigger data-testid=\"select-historical-year\">\n                            <SelectValue placeholder=\"Ano\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {availableElections.map((e) => (\n                              <SelectItem key={e.year} value={String(e.year)}>{e.year}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs\">UF</Label>\n                        <Select value={historicalUf} onValueChange={setHistoricalUf} disabled={!selectedElection}>\n                          <SelectTrigger data-testid=\"select-historical-uf\">\n                            <SelectValue placeholder=\"UF\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"all\">Todos</SelectItem>\n                            {selectedElection?.ufs.map((uf) => (\n                              <SelectItem key={uf} value={uf}>{uf}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs\">Cargo</Label>\n                        <Select value={historicalCargo} onValueChange={(v) => {\n                          setHistoricalCargo(v);\n                          const pos = cargoCodeToPosition[parseInt(v)];\n                          if (pos) setFormData(f => ({ ...f, position: pos }));\n                        }} disabled={!selectedElection}>\n                          <SelectTrigger data-testid=\"select-historical-cargo\">\n                            <SelectValue placeholder=\"Cargo\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {selectedElection?.cargos.map((c) => (\n                              <SelectItem key={c.code} value={String(c.code)}>\n                                {cargoCodeToLabel[c.code] || c.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      {isLoadingSummary && (\n                        <div className=\"col-span-3 flex items-center justify-center py-2 text-sm text-muted-foreground\">\n                          <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                          Carregando dados...\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </div>\n                <Separator />\n              </>\n            )}\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"totalVoters\">Total de Eleitores</Label>\n                <Input\n                  id=\"totalVoters\"\n                  type=\"number\"\n                  placeholder=\"Ex: 500000\"\n                  value={formData.totalVoters}\n                  onChange={(e) => setFormData((f) => ({ ...f, totalVoters: e.target.value }))}\n                  required\n                  className=\"font-mono\"\n                  data-testid=\"input-scenario-voters\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"validVotes\">Votos Válidos</Label>\n                <Input\n                  id=\"validVotes\"\n                  type=\"number\"\n                  placeholder=\"Ex: 400000\"\n                  value={formData.validVotes}\n                  onChange={(e) => setFormData((f) => ({ ...f, validVotes: e.target.value }))}\n                  required\n                  className=\"font-mono\"\n                  data-testid=\"input-scenario-votes\"\n                />\n              </div>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"availableSeats\">Vagas Disponíveis</Label>\n                <Input\n                  id=\"availableSeats\"\n                  type=\"number\"\n                  placeholder=\"Ex: 15\"\n                  value={formData.availableSeats}\n                  onChange={(e) => setFormData((f) => ({ ...f, availableSeats: e.target.value }))}\n                  required\n                  className=\"font-mono\"\n                  data-testid=\"input-scenario-seats\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"position\">Cargo</Label>\n                <Select\n                  value={formData.position}\n                  onValueChange={(v) => setFormData((f) => ({ ...f, position: v }))}\n                >\n                  <SelectTrigger data-testid=\"select-scenario-position\">\n                    <SelectValue placeholder=\"Selecione\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {positions.map((pos) => (\n                      <SelectItem key={pos.value} value={pos.value}>\n                        {pos.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button type=\"button\" variant=\"outline\" onClick={resetForm}>\n                Cancelar\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-save-scenario\"\n              >\n                {editingScenario ? \"Salvar\" : \"Criar\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={deleteConfirmId !== null} onOpenChange={() => setDeleteConfirmId(null)}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Confirmar Exclusão</DialogTitle>\n            <DialogDescription>\n              Tem certeza que deseja excluir este cenário? Todas as simulações associadas também serão excluídas.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeleteConfirmId(null)}>\n              Cancelar\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deleteConfirmId && deleteMutation.mutate(deleteConfirmId)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete-scenario\"\n            >\n              Excluir\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":24248,"size_tokens":null},"client/src/pages/sentiment-analysis.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Input } from \"@/components/ui/input\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { AlertCircle, RefreshCw, TrendingUp, TrendingDown, Minus, Globe, Newspaper, MessageSquare, Users, AlertTriangle, Bell, X, Plus, Scale, Activity, Check } from \"lucide-react\";\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar, Cell, Legend, AreaChart, Area, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar } from \"recharts\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface ComparisonEntity {\n  type: \"party\" | \"candidate\";\n  id: string;\n  name: string;\n}\n\ninterface ComparisonResult {\n  entityType: string;\n  entityId: string;\n  entityName: string;\n  latestSentiment: number | null;\n  avgSentiment: number;\n  sentimentLabel: string;\n  totalMentions: number;\n  trend: string;\n  timeline: { date: Date; score: number; mentions: number }[];\n}\n\ninterface CrisisAlert {\n  id: number;\n  entityType: string;\n  entityId: string;\n  entityName: string | null;\n  alertType: string;\n  severity: string;\n  title: string;\n  description: string | null;\n  sentimentBefore: string | null;\n  sentimentAfter: string | null;\n  sentimentChange: string | null;\n  mentionCount: number | null;\n  detectedAt: Date;\n  isAcknowledged: boolean;\n  acknowledgedBy: string | null;\n  acknowledgedAt: Date | null;\n}\n\ninterface MonitoringSession {\n  id: number;\n  userId: string;\n  name: string;\n  description: string | null;\n  entities: ComparisonEntity[];\n  sourceFilters: Record<string, any>;\n  dateRange: { start: string; end: string } | null;\n  alertThreshold: string;\n  isActive: boolean;\n  createdAt: Date;\n  lastAnalyzedAt: Date | null;\n}\n\ninterface WordCloudWord {\n  text: string;\n  value: number;\n  sentiment: number;\n}\n\ninterface SentimentTimelinePoint {\n  date: string;\n  sentiment: number;\n  volume: number;\n}\n\ninterface EntitySentiment {\n  entityType: string;\n  entityId: string;\n  entityName: string;\n  sentimentScore: number;\n  sentimentLabel: string;\n  confidence: number;\n  mentionCount: number;\n  keywords: { word: string; count: number; sentiment: number }[];\n  sampleMentions: string[];\n}\n\ninterface SentimentAnalysisResult {\n  overallSentiment: string;\n  overallScore: number;\n  confidence: number;\n  entities: EntitySentiment[];\n  keywords: WordCloudWord[];\n  sourceBreakdown: Record<string, { count: number; avgSentiment: number }>;\n  timeline: { date: string; sentiment: number; volume: number }[];\n  summary: string;\n  generatedAt: string;\n}\n\ninterface SentimentSource {\n  type: string;\n  name: string;\n  country: string;\n  articles: { title: string; content: string; date: string }[];\n}\n\nfunction WordCloud({ words, width = 500, height = 300 }: { words: WordCloudWord[]; width?: number; height?: number }) {\n  const sortedWords = useMemo(() => {\n    return [...words].sort((a, b) => b.value - a.value).slice(0, 50);\n  }, [words]);\n\n  const maxValue = Math.max(...sortedWords.map(w => w.value), 1);\n  const minValue = Math.min(...sortedWords.map(w => w.value), 0);\n\n  const getColor = (sentiment: number) => {\n    if (sentiment > 0.3) return \"hsl(142, 76%, 36%)\";\n    if (sentiment < -0.3) return \"hsl(0, 72%, 51%)\";\n    return \"hsl(45, 93%, 47%)\";\n  };\n\n  const getFontSize = (value: number) => {\n    const normalized = (value - minValue) / (maxValue - minValue || 1);\n    return Math.max(12, Math.min(48, 12 + normalized * 36));\n  };\n\n  const rows: JSX.Element[][] = [];\n  let currentRow: JSX.Element[] = [];\n  let currentRowWidth = 0;\n  const rowHeight = 60;\n  const maxRowWidth = width - 40;\n\n  sortedWords.forEach((word, index) => {\n    const fontSize = getFontSize(word.value);\n    const estimatedWidth = word.text.length * fontSize * 0.6 + 16;\n\n    if (currentRowWidth + estimatedWidth > maxRowWidth && currentRow.length > 0) {\n      rows.push(currentRow);\n      currentRow = [];\n      currentRowWidth = 0;\n    }\n\n    currentRow.push(\n      <span\n        key={`${word.text}-${index}`}\n        className=\"inline-block px-2 py-1 transition-transform hover:scale-110 cursor-default\"\n        style={{\n          fontSize: `${fontSize}px`,\n          color: getColor(word.sentiment),\n          fontWeight: word.value > maxValue * 0.7 ? 600 : 400,\n        }}\n        title={`${word.text}: ${word.value} menções (sentimento: ${(word.sentiment * 100).toFixed(0)}%)`}\n      >\n        {word.text}\n      </span>\n    );\n    currentRowWidth += estimatedWidth;\n  });\n\n  if (currentRow.length > 0) {\n    rows.push(currentRow);\n  }\n\n  return (\n    <div className=\"flex flex-col items-center justify-center gap-2 p-4\" style={{ minHeight: height }}>\n      {rows.map((row, rowIndex) => (\n        <div key={rowIndex} className=\"flex flex-wrap justify-center gap-1\">\n          {row}\n        </div>\n      ))}\n      {sortedWords.length === 0 && (\n        <p className=\"text-muted-foreground\">Nenhuma palavra-chave disponível</p>\n      )}\n    </div>\n  );\n}\n\nfunction SentimentBadge({ score, label }: { score: number; label: string }) {\n  const getVariant = () => {\n    if (score > 0.3) return \"default\";\n    if (score < -0.3) return \"destructive\";\n    return \"secondary\";\n  };\n\n  const getIcon = () => {\n    if (score > 0.3) return <TrendingUp className=\"w-3 h-3 mr-1\" />;\n    if (score < -0.3) return <TrendingDown className=\"w-3 h-3 mr-1\" />;\n    return <Minus className=\"w-3 h-3 mr-1\" />;\n  };\n\n  const labelMap: Record<string, string> = {\n    positive: \"Positivo\",\n    negative: \"Negativo\",\n    neutral: \"Neutro\",\n    mixed: \"Misto\",\n  };\n\n  return (\n    <Badge variant={getVariant()} className=\"flex items-center\">\n      {getIcon()}\n      {labelMap[label] || label} ({(score * 100).toFixed(0)}%)\n    </Badge>\n  );\n}\n\nfunction SourceIcon({ type }: { type: string }) {\n  switch (type) {\n    case \"news\":\n      return <Newspaper className=\"w-4 h-4\" />;\n    case \"forum\":\n      return <MessageSquare className=\"w-4 h-4\" />;\n    case \"social\":\n      return <Users className=\"w-4 h-4\" />;\n    default:\n      return <Globe className=\"w-4 h-4\" />;\n  }\n}\n\nexport default function SentimentAnalysisPage() {\n  const { toast } = useToast();\n  const [selectedEntity, setSelectedEntity] = useState<string | null>(null);\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [comparisonEntities, setComparisonEntities] = useState<ComparisonEntity[]>([]);\n  const [newEntityName, setNewEntityName] = useState(\"\");\n  const [newEntityType, setNewEntityType] = useState<\"party\" | \"candidate\">(\"party\");\n\n  const { data: sources, isLoading: sourcesLoading, isError: sourcesError } = useQuery<SentimentSource[]>({\n    queryKey: [\"/api/sentiment/sources\"],\n  });\n\n  const { data: wordCloudData, isLoading: wordCloudLoading, isError: wordCloudError } = useQuery<WordCloudWord[]>({\n    queryKey: [\"/api/sentiment/wordcloud\", selectedEntity],\n    queryFn: async () => {\n      const params = new URLSearchParams({ limit: \"100\" });\n      if (selectedEntity) {\n        params.set(\"entityType\", \"party\");\n        params.set(\"entityId\", selectedEntity);\n      }\n      const response = await fetch(`/api/sentiment/wordcloud?${params}`);\n      if (!response.ok) throw new Error(\"Failed to fetch word cloud\");\n      return response.json();\n    },\n  });\n\n  const { data: overview, isLoading: overviewLoading, isError: overviewError } = useQuery<{\n    parties: EntitySentiment[];\n    candidates: EntitySentiment[];\n  }>({\n    queryKey: [\"/api/sentiment/overview\"],\n  });\n\n  const { data: timeline, isLoading: timelineLoading, isError: timelineError } = useQuery<SentimentTimelinePoint[]>({\n    queryKey: [\"/api/sentiment/timeline\", selectedEntity],\n    queryFn: async () => {\n      if (!selectedEntity) return [];\n      const params = new URLSearchParams({\n        entityType: \"party\",\n        entityId: selectedEntity,\n        days: \"30\",\n      });\n      const response = await fetch(`/api/sentiment/timeline?${params}`);\n      if (!response.ok) throw new Error(\"Failed to fetch timeline\");\n      return response.json();\n    },\n    enabled: !!selectedEntity,\n  });\n\n  const { data: externalData, isLoading: externalLoading, isError: externalError, refetch: refetchExternal } = useQuery<{\n    articles: { title: string; content: string; source: string; sourceType: string; country: string; publishedAt: string; url?: string }[];\n    trends: { topic: string; volume: number; sentiment: string; relatedEntities: string[] }[];\n    sources: { name: string; type: string; country: string; articleCount: number }[];\n  }>({\n    queryKey: [\"/api/external-data/fetch\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/external-data/fetch\", { credentials: \"include\" });\n      if (!response.ok) throw new Error(\"Failed to fetch external data\");\n      return response.json();\n    },\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const externalAnalyzeMutation = useMutation({\n    mutationFn: async (params: { keywords?: string[]; enableGoogleNews?: boolean; enableTwitterTrends?: boolean }) => {\n      const response = await fetch(\"/api/external-data/analyze\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(params),\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to analyze external data\");\n      return response.json() as Promise<{\n        articlesCount: number;\n        trendsCount: number;\n        persistedCount: number;\n        analysis: {\n          topTopics: { topic: string; count: number }[];\n          sentimentBreakdown: { positive: number; negative: number; neutral: number; mixed: number };\n          partiesMentioned: { party: string; count: number }[];\n        };\n      }>;\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Dados externos analisados\",\n        description: `${data.articlesCount} artigos coletados, ${data.persistedCount} persistidos.`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/external-data/fetch\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sentiment/wordcloud\"], exact: false });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sentiment/overview\"] });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Erro\",\n        description: \"Não foi possível analisar os dados externos.\",\n      });\n    },\n  });\n\n  const analyzeMutation = useMutation({\n    mutationFn: async (params: { entityType?: string; entityId?: string }) => {\n      const response = await fetch(\"/api/sentiment/analyze\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(params),\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to analyze sentiment\");\n      return response.json() as Promise<SentimentAnalysisResult>;\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Análise concluída\",\n        description: `Análise de sentimento processada com ${data.entities.length} entidades identificadas.`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sentiment/wordcloud\"], exact: false });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sentiment/overview\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sentiment/timeline\"], exact: false });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Erro na análise\",\n        description: \"Não foi possível processar a análise de sentimento.\",\n      });\n    },\n  });\n\n  // Crisis alerts queries\n  const { data: crisisAlerts, isLoading: alertsLoading } = useQuery<CrisisAlert[]>({\n    queryKey: [\"/api/sentiment/crisis-alerts\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/sentiment/crisis-alerts?acknowledged=false&limit=20\", { credentials: \"include\" });\n      if (!response.ok) return [];\n      return response.json();\n    },\n  });\n\n  const { data: alertStats } = useQuery<{\n    total: number;\n    unacknowledged: number;\n    last24h: number;\n    bySeverity: Record<string, number>;\n  }>({\n    queryKey: [\"/api/sentiment/crisis-alerts/stats\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/sentiment/crisis-alerts/stats\", { credentials: \"include\" });\n      if (!response.ok) return { total: 0, unacknowledged: 0, last24h: 0, bySeverity: {} };\n      return response.json();\n    },\n  });\n\n  const { data: monitoringSessions } = useQuery<MonitoringSession[]>({\n    queryKey: [\"/api/sentiment/monitoring-sessions\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/sentiment/monitoring-sessions\", { credentials: \"include\" });\n      if (!response.ok) return [];\n      return response.json();\n    },\n  });\n\n  // Comparison mutation\n  const comparisonMutation = useMutation({\n    mutationFn: async (entities: ComparisonEntity[]) => {\n      const response = await fetch(\"/api/sentiment/compare\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ entities }),\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to compare entities\");\n      return response.json() as Promise<{\n        entities: ComparisonResult[];\n        comparisonAnalysis: string;\n        analyzedAt: string;\n      }>;\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Comparação realizada\",\n        description: \"Análise comparativa de sentimento concluída.\",\n      });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Erro na comparação\",\n        description: \"Não foi possível realizar a análise comparativa.\",\n      });\n    },\n  });\n\n  // Acknowledge alert mutation\n  const acknowledgeAlertMutation = useMutation({\n    mutationFn: async (alertId: number) => {\n      const response = await fetch(`/api/sentiment/crisis-alerts/${alertId}/acknowledge`, {\n        method: \"PATCH\",\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to acknowledge alert\");\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Alerta reconhecido\",\n        description: \"O alerta foi marcado como reconhecido.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sentiment/crisis-alerts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sentiment/crisis-alerts/stats\"] });\n    },\n  });\n\n  const addComparisonEntity = () => {\n    if (newEntityName.trim() && comparisonEntities.length < 10) {\n      const id = newEntityName.trim().toUpperCase().replace(/\\s+/g, \"_\");\n      if (!comparisonEntities.find(e => e.id === id)) {\n        setComparisonEntities([...comparisonEntities, { type: newEntityType, id, name: newEntityName.trim() }]);\n        setNewEntityName(\"\");\n      }\n    }\n  };\n\n  const removeComparisonEntity = (id: string) => {\n    setComparisonEntities(comparisonEntities.filter(e => e.id !== id));\n  };\n\n  const totalArticles = sources?.reduce((acc, s) => acc + s.articles.length, 0) || 0;\n  const uniqueCountries = Array.from(new Set(sources?.map(s => s.country) || []));\n\n  const partyColors: Record<string, string> = {\n    PT: \"hsl(0, 72%, 51%)\",\n    PL: \"hsl(213, 94%, 40%)\",\n    MDB: \"hsl(45, 93%, 47%)\",\n    PSDB: \"hsl(213, 94%, 55%)\",\n    PP: \"hsl(271, 76%, 53%)\",\n    UNIÃO: \"hsl(174, 84%, 32%)\",\n    PSD: \"hsl(24, 95%, 53%)\",\n    REPUBLICANOS: \"hsl(142, 76%, 36%)\",\n    PDT: \"hsl(0, 0%, 45%)\",\n    PSOL: \"hsl(322, 81%, 43%)\",\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Análise de Sentimento</h1>\n          <p className=\"text-muted-foreground\">\n            Monitore a percepção pública sobre partidos e candidatos através de análise de fontes internacionais\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Button\n            onClick={() => analyzeMutation.mutate({})}\n            disabled={analyzeMutation.isPending}\n            data-testid=\"button-run-analysis\"\n          >\n            {analyzeMutation.isPending ? (\n              <>\n                <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n                Analisando...\n              </>\n            ) : (\n              <>\n                <RefreshCw className=\"w-4 h-4 mr-2\" />\n                Nova Análise\n              </>\n            )}\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Fontes de Dados</CardTitle>\n            <Globe className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-sources-count\">{sources?.length || 0}</div>\n            <p className=\"text-xs text-muted-foreground\">\n              {uniqueCountries.length} países ({uniqueCountries.join(\", \")})\n            </p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Artigos Analisados</CardTitle>\n            <Newspaper className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-articles-count\">{totalArticles}</div>\n            <p className=\"text-xs text-muted-foreground\">Últimos 7 dias</p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Partidos Monitorados</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-parties-count\">{overview?.parties.length || 0}</div>\n            <p className=\"text-xs text-muted-foreground\">Com análise de sentimento</p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Palavras-chave</CardTitle>\n            <MessageSquare className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-keywords-count\">{wordCloudData?.length || 0}</div>\n            <p className=\"text-xs text-muted-foreground\">Na nuvem de palavras</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-4\">\n        <TabsList className=\"flex-wrap\">\n          <TabsTrigger value=\"overview\" data-testid=\"tab-overview\">Visão Geral</TabsTrigger>\n          <TabsTrigger value=\"comparison\" data-testid=\"tab-comparison\" className=\"relative\">\n            <Scale className=\"w-4 h-4 mr-1\" />\n            Comparação\n          </TabsTrigger>\n          <TabsTrigger value=\"alerts\" data-testid=\"tab-alerts\" className=\"relative\">\n            <Bell className=\"w-4 h-4 mr-1\" />\n            Alertas\n            {(alertStats?.unacknowledged || 0) > 0 && (\n              <Badge variant=\"destructive\" className=\"ml-2 h-5 min-w-5 px-1\">\n                {alertStats?.unacknowledged}\n              </Badge>\n            )}\n          </TabsTrigger>\n          <TabsTrigger value=\"external\" data-testid=\"tab-external\">Dados Externos</TabsTrigger>\n          <TabsTrigger value=\"wordcloud\" data-testid=\"tab-wordcloud\">Nuvem de Palavras</TabsTrigger>\n          <TabsTrigger value=\"timeline\" data-testid=\"tab-timeline\">Evolução Temporal</TabsTrigger>\n          <TabsTrigger value=\"sources\" data-testid=\"tab-sources\">Fontes</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"overview\" className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Sentimento por Partido</CardTitle>\n                <CardDescription>Análise de sentimento das menções a partidos políticos</CardDescription>\n              </CardHeader>\n              <CardContent>\n                {overviewLoading ? (\n                  <div className=\"space-y-4\">\n                    {[1, 2, 3].map(i => (\n                      <Skeleton key={i} className=\"h-16 w-full\" />\n                    ))}\n                  </div>\n                ) : overview?.parties && overview.parties.length > 0 ? (\n                  <div className=\"space-y-4\">\n                    {overview.parties.map((party) => (\n                      <div\n                        key={party.entityId}\n                        className=\"flex items-center justify-between p-3 rounded-lg border hover-elevate cursor-pointer\"\n                        onClick={() => setSelectedEntity(party.entityId)}\n                        data-testid={`card-party-${party.entityId}`}\n                      >\n                        <div className=\"flex items-center gap-3\">\n                          <div\n                            className=\"w-3 h-8 rounded\"\n                            style={{ backgroundColor: partyColors[party.entityId] || \"hsl(var(--muted))\" }}\n                          />\n                          <div>\n                            <p className=\"font-medium\">{party.entityName}</p>\n                            <p className=\"text-sm text-muted-foreground\">{party.mentionCount} menções</p>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-4\">\n                          <div className=\"w-24\">\n                            <Progress\n                              value={(party.sentimentScore + 1) * 50}\n                              className=\"h-2\"\n                            />\n                          </div>\n                          <SentimentBadge score={party.sentimentScore} label={party.sentimentLabel} />\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <AlertCircle className=\"w-8 h-8 mx-auto mb-2\" />\n                    <p>Nenhum dado de sentimento disponível.</p>\n                    <p className=\"text-sm\">Execute uma nova análise para gerar dados.</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Comparativo de Sentimento</CardTitle>\n                <CardDescription>Score de sentimento por partido</CardDescription>\n              </CardHeader>\n              <CardContent className=\"h-[300px]\">\n                {overviewLoading ? (\n                  <Skeleton className=\"h-full w-full\" />\n                ) : overview?.parties && overview.parties.length > 0 ? (\n                  <ResponsiveContainer width=\"100%\" height=\"100%\">\n                    <BarChart data={overview.parties} layout=\"vertical\">\n                      <CartesianGrid strokeDasharray=\"3 3\" />\n                      <XAxis type=\"number\" domain={[-1, 1]} />\n                      <YAxis type=\"category\" dataKey=\"entityId\" width={60} />\n                      <Tooltip\n                        formatter={(value: number) => [`${(value * 100).toFixed(1)}%`, \"Sentimento\"]}\n                      />\n                      <Bar dataKey=\"sentimentScore\" radius={[0, 4, 4, 0]}>\n                        {overview.parties.map((entry) => (\n                          <Cell\n                            key={entry.entityId}\n                            fill={entry.sentimentScore > 0 ? \"hsl(142, 76%, 36%)\" : \"hsl(0, 72%, 51%)\"}\n                          />\n                        ))}\n                      </Bar>\n                    </BarChart>\n                  </ResponsiveContainer>\n                ) : (\n                  <div className=\"flex items-center justify-center h-full text-muted-foreground\">\n                    Sem dados para exibir\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        </TabsContent>\n\n        {/* Comparison Tab */}\n        <TabsContent value=\"comparison\" className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-4\">\n            {/* Entity Selection */}\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Scale className=\"w-5 h-5\" />\n                  Seleção de Entidades\n                </CardTitle>\n                <CardDescription>\n                  Adicione partidos ou candidatos para comparar (mínimo 2, máximo 10)\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"flex gap-2\">\n                  <Select value={newEntityType} onValueChange={(v) => setNewEntityType(v as \"party\" | \"candidate\")}>\n                    <SelectTrigger className=\"w-32\" data-testid=\"select-entity-type\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"party\">Partido</SelectItem>\n                      <SelectItem value=\"candidate\">Candidato</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <Input\n                    placeholder=\"Nome...\"\n                    value={newEntityName}\n                    onChange={(e) => setNewEntityName(e.target.value)}\n                    onKeyDown={(e) => e.key === \"Enter\" && addComparisonEntity()}\n                    data-testid=\"input-entity-name\"\n                  />\n                  <Button size=\"icon\" onClick={addComparisonEntity} data-testid=\"button-add-entity\">\n                    <Plus className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n                \n                {/* Quick add from overview */}\n                {overview?.parties && overview.parties.length > 0 && (\n                  <div className=\"space-y-2\">\n                    <p className=\"text-sm text-muted-foreground\">Adicão rápida:</p>\n                    <div className=\"flex flex-wrap gap-1\">\n                      {overview.parties.slice(0, 6).map((party) => (\n                        <Button\n                          key={party.entityId}\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => {\n                            if (!comparisonEntities.find(e => e.id === party.entityId)) {\n                              setComparisonEntities([...comparisonEntities, {\n                                type: \"party\",\n                                id: party.entityId,\n                                name: party.entityName\n                              }]);\n                            }\n                          }}\n                          disabled={comparisonEntities.some(e => e.id === party.entityId)}\n                          data-testid={`button-quick-add-${party.entityId}`}\n                        >\n                          {party.entityId}\n                        </Button>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                <div className=\"space-y-2\">\n                  <p className=\"text-sm font-medium\">Selecionados ({comparisonEntities.length}/10):</p>\n                  {comparisonEntities.length === 0 ? (\n                    <p className=\"text-sm text-muted-foreground\">Nenhuma entidade selecionada</p>\n                  ) : (\n                    <div className=\"flex flex-wrap gap-2\">\n                      {comparisonEntities.map((entity) => (\n                        <div key={entity.id} className=\"flex items-center gap-1 px-2 py-1 rounded-md bg-secondary text-secondary-foreground text-sm\">\n                          <span>{entity.name}</span>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"h-4 w-4 p-0\"\n                            onClick={() => removeComparisonEntity(entity.id)}\n                            data-testid={`button-remove-entity-${entity.id}`}\n                          >\n                            <X className=\"w-3 h-3\" />\n                          </Button>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n\n                <Button\n                  className=\"w-full\"\n                  onClick={() => comparisonMutation.mutate(comparisonEntities)}\n                  disabled={comparisonEntities.length < 2 || comparisonMutation.isPending}\n                  data-testid=\"button-run-comparison\"\n                >\n                  {comparisonMutation.isPending ? (\n                    <>\n                      <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n                      Analisando...\n                    </>\n                  ) : (\n                    <>\n                      <Activity className=\"w-4 h-4 mr-2\" />\n                      Comparar Sentimentos\n                    </>\n                  )}\n                </Button>\n              </CardContent>\n            </Card>\n\n            {/* Comparison Results */}\n            <Card className=\"lg:col-span-2\">\n              <CardHeader>\n                <CardTitle>Resultado da Comparação</CardTitle>\n                <CardDescription>\n                  {comparisonMutation.data \n                    ? `Análise realizada em ${new Date(comparisonMutation.data.analyzedAt).toLocaleString(\"pt-BR\")}`\n                    : \"Execute uma comparação para ver os resultados\"\n                  }\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                {comparisonMutation.isPending ? (\n                  <div className=\"space-y-4\">\n                    {[1, 2, 3].map(i => <Skeleton key={i} className=\"h-16 w-full\" />)}\n                  </div>\n                ) : comparisonMutation.data?.entities && comparisonMutation.data.entities.length > 0 ? (\n                  <div className=\"space-y-4\">\n                    {/* Ranking */}\n                    <div className=\"space-y-3\">\n                      {comparisonMutation.data.entities.map((entity, idx) => (\n                        <div key={entity.entityId} className=\"flex items-center gap-4 p-3 rounded-lg border\">\n                          <div className=\"flex items-center justify-center w-8 h-8 rounded-full bg-muted font-bold\">\n                            {idx + 1}\n                          </div>\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center justify-between\">\n                              <div>\n                                <p className=\"font-medium\">{entity.entityName}</p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {entity.totalMentions} menções • Tendência: {entity.trend === \"rising\" ? \"↑ subindo\" : entity.trend === \"falling\" ? \"↓ caindo\" : \"→ estável\"}\n                                </p>\n                              </div>\n                              <div className=\"flex items-center gap-3\">\n                                <div className=\"w-24\">\n                                  <Progress value={(entity.avgSentiment + 1) * 50} className=\"h-2\" />\n                                </div>\n                                <SentimentBadge score={entity.avgSentiment} label={entity.sentimentLabel} />\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n\n                    {/* Comparison Chart */}\n                    <div className=\"h-[300px] mt-6\">\n                      <ResponsiveContainer width=\"100%\" height=\"100%\">\n                        <BarChart data={comparisonMutation.data.entities} layout=\"vertical\">\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis type=\"number\" domain={[-1, 1]} tickFormatter={(v) => `${(v * 100).toFixed(0)}%`} />\n                          <YAxis type=\"category\" dataKey=\"entityName\" width={100} />\n                          <Tooltip formatter={(v: number) => [`${(v * 100).toFixed(1)}%`, \"Sentimento Médio\"]} />\n                          <Bar dataKey=\"avgSentiment\" radius={[0, 4, 4, 0]}>\n                            {comparisonMutation.data.entities.map((entry) => (\n                              <Cell\n                                key={entry.entityId}\n                                fill={entry.avgSentiment > 0.1 ? \"hsl(142, 76%, 36%)\" : entry.avgSentiment < -0.1 ? \"hsl(0, 72%, 51%)\" : \"hsl(45, 93%, 47%)\"}\n                              />\n                            ))}\n                          </Bar>\n                        </BarChart>\n                      </ResponsiveContainer>\n                    </div>\n\n                    {/* AI Analysis */}\n                    {comparisonMutation.data.comparisonAnalysis && (\n                      <Card className=\"mt-4 bg-muted/50\">\n                        <CardHeader className=\"pb-2\">\n                          <CardTitle className=\"text-sm\">Análise de IA</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                          <p className=\"text-sm\">{comparisonMutation.data.comparisonAnalysis}</p>\n                        </CardContent>\n                      </Card>\n                    )}\n                  </div>\n                ) : (\n                  <div className=\"flex flex-col items-center justify-center h-[300px] text-muted-foreground\">\n                    <Scale className=\"w-12 h-12 mb-4\" />\n                    <p>Selecione ao menos 2 entidades e execute a comparação</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        </TabsContent>\n\n        {/* Alerts Tab */}\n        <TabsContent value=\"alerts\" className=\"space-y-4\">\n          {/* Alert Stats */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Total de Alertas</CardTitle>\n                <Bell className=\"h-4 w-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\" data-testid=\"text-total-alerts\">{alertStats?.total || 0}</div>\n                <p className=\"text-xs text-muted-foreground\">{alertStats?.last24h || 0} nas últimas 24h</p>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Não Reconhecidos</CardTitle>\n                <AlertTriangle className=\"h-4 w-4 text-destructive\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-destructive\" data-testid=\"text-unack-alerts\">\n                  {alertStats?.unacknowledged || 0}\n                </div>\n                <p className=\"text-xs text-muted-foreground\">Requerem atenção</p>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Críticos</CardTitle>\n                <AlertCircle className=\"h-4 w-4 text-destructive\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\" data-testid=\"text-critical-alerts\">\n                  {alertStats?.bySeverity?.critical || 0}\n                </div>\n                <p className=\"text-xs text-muted-foreground\">Severidade crítica</p>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Alta Prioridade</CardTitle>\n                <TrendingDown className=\"h-4 w-4 text-orange-500\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\" data-testid=\"text-high-alerts\">\n                  {alertStats?.bySeverity?.high || 0}\n                </div>\n                <p className=\"text-xs text-muted-foreground\">Severidade alta</p>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Alert List */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Alertas de Crise</CardTitle>\n              <CardDescription>\n                Alertas gerados automaticamente quando há picos de sentimento negativo\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {alertsLoading ? (\n                <div className=\"space-y-4\">\n                  {[1, 2, 3].map(i => <Skeleton key={i} className=\"h-20 w-full\" />)}\n                </div>\n              ) : crisisAlerts && crisisAlerts.length > 0 ? (\n                <div className=\"space-y-3\">\n                  {crisisAlerts.map((alert) => (\n                    <Card\n                      key={alert.id}\n                      className={\n                        alert.severity === \"critical\" || alert.severity === \"high\" \n                          ? \"border-destructive\" \n                          : \"\"\n                      }\n                      data-testid={`card-alert-${alert.id}`}\n                    >\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-start justify-between gap-4\">\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-2 mb-1 flex-wrap\">\n                              {alert.severity === \"critical\" && <AlertCircle className=\"w-4 h-4 text-destructive\" />}\n                              {alert.severity === \"high\" && <AlertTriangle className=\"w-4 h-4 text-destructive\" />}\n                              {alert.severity === \"medium\" && <AlertCircle className=\"w-4 h-4 text-muted-foreground\" />}\n                              {alert.severity === \"low\" && <AlertCircle className=\"w-4 h-4 text-muted-foreground\" />}\n                              <span className=\"font-medium\">{alert.title}</span>\n                              <Badge variant={\n                                alert.severity === \"critical\" ? \"destructive\" :\n                                alert.severity === \"high\" ? \"destructive\" : \"secondary\"\n                              }>\n                                {alert.severity}\n                              </Badge>\n                            </div>\n                            <p className=\"text-sm text-muted-foreground mb-2\">\n                              {alert.description || `Alerta para ${alert.entityName || alert.entityId}`}\n                            </p>\n                            <div className=\"flex items-center gap-4 text-xs text-muted-foreground flex-wrap\">\n                              <span data-testid={`text-alert-type-${alert.id}`}>Tipo: {alert.alertType.replace(/_/g, \" \")}</span>\n                              {alert.sentimentChange && (\n                                <span data-testid={`text-alert-change-${alert.id}`}>Queda: {(Math.abs(parseFloat(alert.sentimentChange)) * 100).toFixed(0)}%</span>\n                              )}\n                              <span data-testid={`text-alert-date-${alert.id}`}>Detectado: {new Date(alert.detectedAt).toLocaleString(\"pt-BR\")}</span>\n                            </div>\n                          </div>\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => acknowledgeAlertMutation.mutate(alert.id)}\n                            disabled={acknowledgeAlertMutation.isPending}\n                            data-testid={`button-acknowledge-${alert.id}`}\n                          >\n                            <Check className=\"w-4 h-4 mr-1\" />\n                            Reconhecer\n                          </Button>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"flex flex-col items-center justify-center py-12 text-muted-foreground\">\n                  <Bell className=\"w-12 h-12 mb-4\" />\n                  <p className=\"font-medium\">Nenhum alerta pendente</p>\n                  <p className=\"text-sm\">Todos os alertas foram reconhecidos ou não há alertas ativos</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"external\" className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between gap-2\">\n                  <div>\n                    <CardTitle>Notícias Recentes</CardTitle>\n                    <CardDescription>Artigos coletados de fontes externas sobre política brasileira</CardDescription>\n                  </div>\n                  <Button\n                    size=\"sm\"\n                    onClick={() => externalAnalyzeMutation.mutate({})}\n                    disabled={externalAnalyzeMutation.isPending}\n                    data-testid=\"button-fetch-external\"\n                  >\n                    {externalAnalyzeMutation.isPending ? (\n                      <RefreshCw className=\"w-4 h-4 animate-spin\" />\n                    ) : (\n                      <RefreshCw className=\"w-4 h-4\" />\n                    )}\n                  </Button>\n                </div>\n              </CardHeader>\n              <CardContent className=\"max-h-[400px] overflow-y-auto\">\n                {externalLoading ? (\n                  <div className=\"space-y-3\">\n                    {[1, 2, 3].map(i => <Skeleton key={i} className=\"h-20 w-full\" />)}\n                  </div>\n                ) : externalError ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <AlertCircle className=\"w-8 h-8 mx-auto mb-2\" />\n                    <p>Erro ao carregar notícias externas</p>\n                  </div>\n                ) : externalData?.articles && externalData.articles.length > 0 ? (\n                  <div className=\"space-y-3\">\n                    {externalData.articles.slice(0, 10).map((article, idx) => (\n                      <div key={idx} className=\"p-3 rounded-lg border\" data-testid={`card-article-${idx}`}>\n                        <div className=\"flex flex-wrap items-start justify-between gap-2 mb-1\">\n                          <p className=\"font-medium text-sm line-clamp-2\" data-testid={`text-article-title-${idx}`}>{article.title}</p>\n                          <Badge variant=\"outline\" className=\"shrink-0\" data-testid={`badge-article-country-${idx}`}>{article.country}</Badge>\n                        </div>\n                        <p className=\"text-xs text-muted-foreground line-clamp-2 mb-2\" data-testid={`text-article-content-${idx}`}>{article.content}</p>\n                        <div className=\"flex flex-wrap items-center justify-between gap-2 text-xs text-muted-foreground\">\n                          <span data-testid={`text-article-source-${idx}`}>{article.source}</span>\n                          <span data-testid={`text-article-date-${idx}`}>{new Date(article.publishedAt).toLocaleDateString(\"pt-BR\")}</span>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <Newspaper className=\"w-8 h-8 mx-auto mb-2\" />\n                    <p>Nenhuma notícia disponível</p>\n                    <p className=\"text-sm\">Clique em atualizar para buscar notícias</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Tendências de Redes Sociais</CardTitle>\n                <CardDescription>Tópicos em alta relacionados a eleições e política</CardDescription>\n              </CardHeader>\n              <CardContent className=\"max-h-[400px] overflow-y-auto\">\n                {externalLoading ? (\n                  <div className=\"space-y-3\">\n                    {[1, 2, 3].map(i => <Skeleton key={i} className=\"h-16 w-full\" />)}\n                  </div>\n                ) : externalData?.trends && externalData.trends.length > 0 ? (\n                  <div className=\"space-y-3\">\n                    {externalData.trends.map((trend, idx) => (\n                      <div key={idx} className=\"p-3 rounded-lg border\" data-testid={`card-trend-${idx}`}>\n                        <div className=\"flex flex-wrap items-center justify-between gap-2 mb-2\">\n                          <span className=\"font-medium\">{trend.topic}</span>\n                          <SentimentBadge score={trend.sentiment === \"positive\" ? 0.5 : trend.sentiment === \"negative\" ? -0.5 : 0} label={trend.sentiment} />\n                        </div>\n                        <div className=\"flex flex-wrap items-center justify-between gap-2 text-sm\">\n                          <span className=\"text-muted-foreground\" data-testid={`text-trend-volume-${idx}`}>{trend.volume.toLocaleString(\"pt-BR\")} menções</span>\n                          <div className=\"flex gap-1 flex-wrap\">\n                            {trend.relatedEntities.slice(0, 3).map((entity, i) => (\n                              <Badge key={i} variant=\"secondary\" className=\"text-xs\" data-testid={`badge-entity-${idx}-${i}`}>{entity}</Badge>\n                            ))}\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <TrendingUp className=\"w-8 h-8 mx-auto mb-2\" />\n                    <p>Nenhuma tendência disponível</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Fontes de Dados Externos</CardTitle>\n              <CardDescription>Fontes ativas para coleta de notícias e tendências</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {externalData?.sources && externalData.sources.length > 0 ? (\n                <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3\">\n                  {externalData.sources.map((source, idx) => (\n                    <div key={idx} className=\"p-3 rounded-lg border text-center\" data-testid={`card-source-${idx}`}>\n                      <p className=\"font-medium text-sm truncate\" data-testid={`text-source-name-${idx}`}>{source.name}</p>\n                      <p className=\"text-xs text-muted-foreground\" data-testid={`text-source-count-${idx}`}>{source.articleCount} artigos</p>\n                      <Badge variant=\"outline\" className=\"text-xs mt-1\" data-testid={`badge-source-country-${idx}`}>{source.country}</Badge>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <p className=\"text-center text-muted-foreground py-4\" data-testid=\"text-no-sources\">Nenhuma fonte ativa no momento</p>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"wordcloud\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n                <div>\n                  <CardTitle>Nuvem de Palavras</CardTitle>\n                  <CardDescription>\n                    Palavras-chave mais frequentes nas análises de sentimento\n                  </CardDescription>\n                </div>\n                <Select\n                  value={selectedEntity || \"all\"}\n                  onValueChange={(v) => setSelectedEntity(v === \"all\" ? null : v)}\n                >\n                  <SelectTrigger className=\"w-[180px]\" data-testid=\"select-entity-filter\">\n                    <SelectValue placeholder=\"Filtrar por entidade\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todas as entidades</SelectItem>\n                    {overview?.parties.map((p) => (\n                      <SelectItem key={p.entityId} value={p.entityId}>\n                        {p.entityId} - {p.entityName}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {wordCloudLoading ? (\n                <div className=\"h-[300px] flex items-center justify-center\">\n                  <Skeleton className=\"h-full w-full\" />\n                </div>\n              ) : wordCloudData && wordCloudData.length > 0 ? (\n                <>\n                  <WordCloud words={wordCloudData} width={800} height={300} />\n                  <div className=\"flex justify-center gap-6 mt-4 text-sm\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-4 h-4 rounded\" style={{ backgroundColor: \"hsl(142, 76%, 36%)\" }} />\n                      <span>Positivo</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-4 h-4 rounded\" style={{ backgroundColor: \"hsl(45, 93%, 47%)\" }} />\n                      <span>Neutro</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-4 h-4 rounded\" style={{ backgroundColor: \"hsl(0, 72%, 51%)\" }} />\n                      <span>Negativo</span>\n                    </div>\n                  </div>\n                </>\n              ) : (\n                <div className=\"h-[300px] flex flex-col items-center justify-center text-muted-foreground\">\n                  <AlertCircle className=\"w-8 h-8 mb-2\" />\n                  <p>Nenhuma palavra-chave disponível</p>\n                  <p className=\"text-sm\">Execute uma análise para gerar palavras-chave</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"timeline\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n                <div>\n                  <CardTitle>Evolução Temporal do Sentimento</CardTitle>\n                  <CardDescription>\n                    Acompanhe a variação do sentimento ao longo do tempo\n                  </CardDescription>\n                </div>\n                <Select\n                  value={selectedEntity || \"\"}\n                  onValueChange={(v) => setSelectedEntity(v || null)}\n                >\n                  <SelectTrigger className=\"w-[180px]\" data-testid=\"select-timeline-entity\">\n                    <SelectValue placeholder=\"Selecione um partido\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {overview?.parties.map((p) => (\n                      <SelectItem key={p.entityId} value={p.entityId}>\n                        {p.entityId} - {p.entityName}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </CardHeader>\n            <CardContent className=\"h-[400px]\">\n              {!selectedEntity ? (\n                <div className=\"h-full flex flex-col items-center justify-center text-muted-foreground\">\n                  <TrendingUp className=\"w-8 h-8 mb-2\" />\n                  <p>Selecione um partido para visualizar a evolução temporal</p>\n                </div>\n              ) : timelineLoading ? (\n                <Skeleton className=\"h-full w-full\" />\n              ) : timeline && timeline.length > 0 ? (\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <AreaChart data={timeline}>\n                    <defs>\n                      <linearGradient id=\"sentimentGradient\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                        <stop offset=\"5%\" stopColor=\"hsl(213, 94%, 55%)\" stopOpacity={0.3} />\n                        <stop offset=\"95%\" stopColor=\"hsl(213, 94%, 55%)\" stopOpacity={0} />\n                      </linearGradient>\n                    </defs>\n                    <CartesianGrid strokeDasharray=\"3 3\" />\n                    <XAxis\n                      dataKey=\"date\"\n                      tickFormatter={(value) => {\n                        const date = new Date(value);\n                        return `${date.getDate()}/${date.getMonth() + 1}`;\n                      }}\n                    />\n                    <YAxis domain={[-1, 1]} tickFormatter={(value) => `${(value * 100).toFixed(0)}%`} />\n                    <Tooltip\n                      formatter={(value: number, name: string) => {\n                        if (name === \"sentiment\") return [`${(value * 100).toFixed(1)}%`, \"Sentimento\"];\n                        return [value, \"Menções\"];\n                      }}\n                      labelFormatter={(label) => `Data: ${label}`}\n                    />\n                    <Legend />\n                    <Area\n                      type=\"monotone\"\n                      dataKey=\"sentiment\"\n                      stroke=\"hsl(213, 94%, 55%)\"\n                      fill=\"url(#sentimentGradient)\"\n                      name=\"Sentimento\"\n                    />\n                    <Line\n                      type=\"monotone\"\n                      dataKey=\"volume\"\n                      stroke=\"hsl(142, 76%, 36%)\"\n                      strokeDasharray=\"5 5\"\n                      name=\"Volume de Menções\"\n                      yAxisId={1}\n                    />\n                  </AreaChart>\n                </ResponsiveContainer>\n              ) : (\n                <div className=\"h-full flex flex-col items-center justify-center text-muted-foreground\">\n                  <AlertCircle className=\"w-8 h-8 mb-2\" />\n                  <p>Nenhum dado temporal disponível para {selectedEntity}</p>\n                  <p className=\"text-sm\">Execute análises ao longo do tempo para gerar histórico</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"sources\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Fontes de Dados</CardTitle>\n              <CardDescription>\n                Fontes utilizadas para análise de sentimento\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {sourcesLoading ? (\n                <div className=\"space-y-4\">\n                  {[1, 2, 3].map(i => (\n                    <Skeleton key={i} className=\"h-24 w-full\" />\n                  ))}\n                </div>\n              ) : sources && sources.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {sources.map((source, index) => (\n                    <div\n                      key={`${source.name}-${index}`}\n                      className=\"p-4 rounded-lg border\"\n                      data-testid={`card-source-${index}`}\n                    >\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"p-2 rounded-lg bg-muted\">\n                            <SourceIcon type={source.type} />\n                          </div>\n                          <div>\n                            <p className=\"font-medium\">{source.name}</p>\n                            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                              <Badge variant=\"outline\">{source.type}</Badge>\n                              <span>{source.country}</span>\n                            </div>\n                          </div>\n                        </div>\n                        <Badge>{source.articles.length} artigos</Badge>\n                      </div>\n                      <div className=\"space-y-2\">\n                        {source.articles.slice(0, 2).map((article, artIndex) => (\n                          <div key={artIndex} className=\"text-sm p-2 rounded bg-muted/50\">\n                            <p className=\"font-medium line-clamp-1\">{article.title}</p>\n                            <p className=\"text-muted-foreground line-clamp-2\">{article.content}</p>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Globe className=\"w-8 h-8 mx-auto mb-2\" />\n                  <p>Nenhuma fonte de dados configurada</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":58824,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"server/replit_integrations/image/client.ts":{"content":"import fs from \"node:fs\";\nimport OpenAI, { toFile } from \"openai\";\nimport { Buffer } from \"node:buffer\";\n\nexport const openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\n/**\n * Generate an image and return as Buffer.\n * Uses gpt-image-1 model via Replit AI Integrations.\n */\nexport async function generateImageBuffer(\n  prompt: string,\n  size: \"1024x1024\" | \"512x512\" | \"256x256\" = \"1024x1024\"\n): Promise<Buffer> {\n  const response = await openai.images.generate({\n    model: \"gpt-image-1\",\n    prompt,\n    size,\n  });\n  const base64 = response.data[0]?.b64_json ?? \"\";\n  return Buffer.from(base64, \"base64\");\n}\n\n/**\n * Edit/combine multiple images into a composite.\n * Uses gpt-image-1 model via Replit AI Integrations.\n */\nexport async function editImages(\n  imageFiles: string[],\n  prompt: string,\n  outputPath?: string\n): Promise<Buffer> {\n  const images = await Promise.all(\n    imageFiles.map((file) =>\n      toFile(fs.createReadStream(file), file, {\n        type: \"image/png\",\n      })\n    )\n  );\n\n  const response = await openai.images.edit({\n    model: \"gpt-image-1\",\n    image: images,\n    prompt,\n  });\n\n  const imageBase64 = response.data[0]?.b64_json ?? \"\";\n  const imageBytes = Buffer.from(imageBase64, \"base64\");\n\n  if (outputPath) {\n    fs.writeFileSync(outputPath, imageBytes);\n  }\n\n  return imageBytes;\n}\n\n","path":null,"size_bytes":1410,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"server/db.ts":{"content":"import { drizzle, NodePgDatabase } from \"drizzle-orm/node-postgres\";\nimport pg from \"pg\";\nimport * as schema from \"@shared/schema\";\nimport dns from \"dns\";\n\ndns.setDefaultResultOrder(\"ipv4first\");\n\nconst { Pool } = pg;\n\nfunction getDatabaseUrl(): string {\n  if (process.env.DATABASE_URL) {\n    return process.env.DATABASE_URL;\n  }\n\n  const password = process.env.POSTGRES_PASSWORD;\n  if (password) {\n    const host = process.env.POSTGRES_HOST || \"db\";\n    const port = process.env.POSTGRES_PORT || \"5432\";\n    const user = process.env.POSTGRES_USER || \"simulavoto\";\n    const dbName = process.env.POSTGRES_DB || \"simulavoto\";\n    const url = `postgresql://${user}:${encodeURIComponent(password)}@${host}:${port}/${dbName}`;\n    console.log(`DATABASE_URL constructed from POSTGRES_PASSWORD (host: ${host}:${port})`);\n    return url;\n  }\n\n  throw new Error(\n    \"DATABASE_URL or POSTGRES_PASSWORD must be set. Did you forget to configure the database?\",\n  );\n}\n\nconst DATABASE_URL = getDatabaseUrl();\n\nfunction isLocalDatabase(connectionString: string): boolean {\n  try {\n    const url = new URL(connectionString);\n    const host = url.hostname;\n    return host === 'localhost' ||\n           host === '127.0.0.1' ||\n           host.startsWith('172.') ||\n           host.startsWith('192.168.') ||\n           host.startsWith('10.') ||\n           host.includes('.local') ||\n           !host.includes('.');\n  } catch {\n    return true;\n  }\n}\n\nasync function resolveToIPv4(connectionString: string): Promise<string> {\n  try {\n    const url = new URL(connectionString);\n    const hostname = url.hostname;\n\n    if (hostname.match(/^\\d+\\.\\d+\\.\\d+\\.\\d+$/)) {\n      return connectionString;\n    }\n\n    const { promisify } = await import(\"util\");\n    const lookup = promisify(dns.lookup);\n    try {\n      const result = await lookup(hostname, { family: 4 });\n      if (result.address) {\n        url.hostname = result.address;\n        console.log(`DNS resolved ${hostname} -> ${result.address}`);\n        return url.toString();\n      }\n    } catch (dnsErr) {\n      console.warn(`DNS resolution failed for ${hostname}:`, (dnsErr as Error).message);\n    }\n  } catch (err) {\n    console.warn(\"URL parse failed for DNS resolution:\", (err as Error).message);\n  }\n\n  return connectionString;\n}\n\nfunction getSSLMode(isLocal: boolean): \"force\" | \"disable\" | \"auto\" {\n  const sslEnv = process.env.DATABASE_SSL?.toLowerCase();\n  if (sslEnv === \"true\" || sslEnv === \"1\") return \"force\";\n  if (sslEnv === \"false\" || sslEnv === \"0\") return \"disable\";\n  if (sslEnv === \"auto\" || !sslEnv) {\n    if (isLocal) return \"disable\";\n    return \"auto\";\n  }\n  return \"auto\";\n}\n\nfunction buildPoolConfig(connectionString: string, isLocal: boolean, enableSSL: boolean): pg.PoolConfig {\n  const config: pg.PoolConfig = {\n    connectionString,\n    max: 20,\n    idleTimeoutMillis: 30000,\n    connectionTimeoutMillis: isLocal ? 10000 : 30000,\n  };\n\n  if (enableSSL) {\n    config.ssl = { rejectUnauthorized: false };\n  }\n\n  return config;\n}\n\nasync function tryConnect(connectionString: string, isLocal: boolean, withSSL: boolean): Promise<pg.Pool> {\n  const config = buildPoolConfig(connectionString, isLocal, withSSL);\n  const testPool = new Pool(config);\n  const client = await testPool.connect();\n  await client.query(\"SELECT 1\");\n  client.release();\n  return testPool;\n}\n\nlet _pool: pg.Pool | null = null;\nlet _db: NodePgDatabase<typeof schema> | null = null;\nlet _initialized = false;\n\nexport function getPool(): pg.Pool {\n  if (!_pool) {\n    throw new Error(\"Database not initialized. Call initializeDatabase() first.\");\n  }\n  return _pool;\n}\n\nexport function getDb(): NodePgDatabase<typeof schema> {\n  if (!_db) {\n    throw new Error(\"Database not initialized. Call initializeDatabase() first.\");\n  }\n  return _db;\n}\n\nexport const db = new Proxy({} as NodePgDatabase<typeof schema>, {\n  get(_target, prop) {\n    const currentDb = _db;\n    if (!currentDb) {\n      throw new Error(\"Database not initialized. Call initializeDatabase() first.\");\n    }\n    const value = (currentDb as any)[prop];\n    if (typeof value === 'function') {\n      return value.bind(currentDb);\n    }\n    return value;\n  }\n});\n\nexport const pool = new Proxy({} as pg.Pool, {\n  get(_target, prop) {\n    const currentPool = _pool;\n    if (!currentPool) {\n      throw new Error(\"Database pool not initialized. Call initializeDatabase() first.\");\n    }\n    const value = (currentPool as any)[prop];\n    if (typeof value === 'function') {\n      return value.bind(currentPool);\n    }\n    return value;\n  }\n});\n\nexport async function initializeDatabase(): Promise<void> {\n  if (_initialized) {\n    console.log(\"Database already initialized, skipping...\");\n    return;\n  }\n\n  console.log(\"Starting database initialization...\");\n  console.log(\"NODE_ENV:\", process.env.NODE_ENV);\n  console.log(\"DATABASE_URL exists:\", !!process.env.DATABASE_URL);\n\n  const isLocal = isLocalDatabase(DATABASE_URL);\n  console.log(\"Database mode:\", isLocal ? \"LOCAL (container/internal)\" : \"EXTERNAL (Supabase/cloud)\");\n\n  try {\n    const urlObj = new URL(DATABASE_URL);\n    console.log(\"DATABASE_URL host:\", urlObj.hostname);\n    console.log(\"DATABASE_URL port:\", urlObj.port || \"5432 (default)\");\n    console.log(\"DATABASE_URL protocol:\", urlObj.protocol);\n  } catch (e) {\n    console.error(\"DATABASE_URL is not a valid URL:\", DATABASE_URL.substring(0, 30) + \"...\");\n  }\n\n  try {\n    let connectionUrl = DATABASE_URL;\n\n    if (!isLocal && process.env.NODE_ENV === \"production\") {\n      console.log(\"Resolving external database hostname to IPv4...\");\n      connectionUrl = await resolveToIPv4(connectionUrl);\n    }\n\n    const sslMode = getSSLMode(isLocal);\n    console.log(`SSL mode: ${sslMode} (DATABASE_SSL=${process.env.DATABASE_SSL || 'not set'})`);\n\n    if (sslMode === \"force\") {\n      console.log(\"SSL: forced ON (rejectUnauthorized: false)\");\n      _pool = await tryConnect(connectionUrl, isLocal, true);\n    } else if (sslMode === \"disable\") {\n      console.log(\"SSL: disabled\");\n      _pool = await tryConnect(connectionUrl, isLocal, false);\n    } else {\n      console.log(\"SSL: auto - trying with SSL first...\");\n      try {\n        _pool = await tryConnect(connectionUrl, isLocal, true);\n        console.log(\"SSL: connected successfully WITH SSL\");\n      } catch (sslErr) {\n        console.log(\"SSL: connection with SSL failed, trying without SSL...\");\n        console.log(\"SSL error:\", (sslErr as Error).message);\n        try {\n          _pool = await tryConnect(connectionUrl, isLocal, false);\n          console.log(\"SSL: connected successfully WITHOUT SSL\");\n        } catch (noSslErr) {\n          console.error(\"SSL: connection without SSL also failed:\", (noSslErr as Error).message);\n          throw noSslErr;\n        }\n      }\n    }\n\n    _db = drizzle(_pool, { schema });\n    _initialized = true;\n    console.log(\"Database pool initialized successfully\");\n  } catch (err) {\n    console.error(\"Failed to initialize database pool:\", err);\n    throw err;\n  }\n}\n\nexport async function testConnection(): Promise<boolean> {\n  if (!_pool) {\n    throw new Error(\"Database not initialized\");\n  }\n\n  try {\n    console.log(\"Testing database connection...\");\n    const client = await _pool.connect();\n    await client.query(\"SELECT 1\");\n    client.release();\n    console.log(\"Database connection test successful!\");\n    return true;\n  } catch (err) {\n    console.error(\"Database connection test failed:\", err);\n    throw err;\n  }\n}\n","path":null,"size_bytes":7442,"size_tokens":null},"DEPLOY-UPDATE-PORTAINER.md":{"content":"# Guia de Atualizacao - SimulaVoto no Portainer\n\nEste guia explica como atualizar uma instalacao existente do SimulaVoto em ambiente Portainer.\n\n---\n\n## Antes de Atualizar\n\n### 1. Verificar Versao Atual\n\n```bash\ncd /opt/simulavoto\ngit log -1 --oneline\n```\n\n### 2. Backup do Banco de Dados\n\n**IMPORTANTE**: Sempre faca backup antes de atualizar!\n\n```bash\ndocker exec simulavoto-db pg_dump -U simulavoto simulavoto > backup_$(date +%Y%m%d_%H%M%S).sql\n```\n\n### 3. Verificar Espaco em Disco\n\n```bash\ndf -h\n# Certifique-se de ter pelo menos 2GB livres\n```\n\n---\n\n## Metodos de Atualizacao\n\n### Atualizacao Rapida (Apenas Codigo)\n\nUse este metodo quando nao ha mudancas no banco de dados:\n\n```bash\ncd /opt/simulavoto\ngit fetch origin && git pull origin main\ndocker compose up -d --build\ndocker compose logs -f --tail=30 simulavoto\n```\n\nO processo leva aproximadamente 2-3 minutos.\n\n---\n\n### Metodo 1: Via SSH (Recomendado)\n\n#### 1.1 Parar Aplicacao\n\n```bash\ncd /opt/simulavoto\ndocker compose down\n```\n\n> **Nota**: Os dados do banco sao preservados no volume Docker `simulavoto_pgdata`.\n\n#### 1.2 Baixar Atualizacoes\n\n```bash\ngit fetch origin\ngit pull origin main\n```\n\n#### 1.3 Verificar Variaveis de Ambiente\n\nConsulte a secao [Variaveis de Ambiente](#variaveis-de-ambiente) abaixo.\n\n```bash\nnano .env\n# Verifique que POSTGRES_PASSWORD, SESSION_SECRET e OPENAI_API_KEY estao configurados\n```\n\n#### 1.4 Rebuild e Deploy\n\n```bash\ndocker compose up -d --build\n```\n\n#### 1.5 Verificar Status\n\n```bash\ndocker compose logs -f\n# Ctrl+C para sair\n```\n\n---\n\n### Metodo 2: Via Portainer UI\n\n#### 2.1 Acessar Stack\n\n1. Abra o Portainer\n2. Va em **Stacks** -> **simulavoto**\n\n#### 2.2 Pull das Atualizacoes\n\n1. Clique em **Editor**\n2. Use **Stack actions** -> **Pull and redeploy**\n\n#### 2.3 Verificar Variaveis de Ambiente\n\n1. Va na aba **Environment variables**\n2. Verifique que `POSTGRES_PASSWORD`, `SESSION_SECRET` e `OPENAI_API_KEY` estao configurados\n\n#### 2.4 Redeploy\n\n1. Clique em **Update the stack**\n2. Marque **Re-pull image and redeploy** se usando imagem do registry\n3. Clique em **Update**\n\n#### 2.5 Verificar Logs\n\n1. Va em **Containers**\n2. Clique no container **simulavoto**\n3. Va em **Logs**\n\n---\n\n## Migracao de Supabase para Banco Local\n\nSe voce estava usando Supabase e quer migrar para banco local:\n\n### 1. Exportar dados do Supabase\n\n```bash\npg_dump \"postgresql://postgres.[ref]:[senha]@aws-0-[region].pooler.supabase.com:6543/postgres\" > supabase_export.sql\n```\n\n### 2. Atualizar para versao com banco local\n\n```bash\ncd /opt/simulavoto\ngit pull origin main\n```\n\n### 3. Atualizar .env\n\n```bash\ncat > .env << 'EOF'\nPOSTGRES_PASSWORD=SuaSenhaSegura2026!\nSESSION_SECRET=SEU_SESSION_SECRET_EXISTENTE\nOPENAI_API_KEY=sk-sua-chave-aqui\nEOF\n```\n\n> **Nota**: Remova `DATABASE_URL` do .env - ela agora e gerada automaticamente pelo docker-compose.\n\n### 4. Subir containers\n\n```bash\ndocker compose up -d --build\n```\n\n### 5. Importar dados do Supabase\n\n```bash\ndocker exec -i simulavoto-db psql -U simulavoto simulavoto < supabase_export.sql\n```\n\n### 6. Reiniciar aplicacao\n\n```bash\ndocker compose restart simulavoto\n```\n\n---\n\n## Variaveis de Ambiente\n\n| Variavel | Obrigatoria | Descricao |\n|----------|-------------|-----------|\n| `POSTGRES_PASSWORD` | Sim | Senha do PostgreSQL local |\n| `SESSION_SECRET` | Sim | Segredo para sessoes (32+ chars) |\n| `OPENAI_API_KEY` | Nao* | Chave API do OpenAI |\n| `RESEND_API_KEY` | Nao | Para envio de emails |\n\n> **Nota**: `DATABASE_URL`, `NODE_ENV` e `PORT` sao configurados automaticamente pelo docker-compose.\n\n*A chave OpenAI e necessaria para recursos de IA.\n\n---\n\n## Verificacao Pos-Atualizacao\n\n### 1. Health Check\n\n```bash\ncurl http://localhost:5000/api/health\n# Deve retornar: {\"status\":\"ok\"}\n```\n\n### 2. Verificar Logs\n\n```bash\ndocker compose logs --tail=50 simulavoto\n```\n\nDeve mostrar:\n```\nDatabase pool initialized successfully\nRoutes registered successfully!\nServer running on port 5000\n```\n\n### 3. Verificar Banco\n\n```bash\ndocker exec simulavoto-db pg_isready -U simulavoto -d simulavoto\n```\n\n### 4. Testar Funcionalidades\n\n1. Acesse a aplicacao\n2. Faca login como admin\n3. Verifique importacoes IBGE e TSE\n\n---\n\n## Rollback (Reverter Atualizacao)\n\nSe algo der errado:\n\n### 1. Parar Containers\n\n```bash\ndocker compose down\n```\n\n### 2. Reverter para Versao Anterior\n\n```bash\ngit log --oneline -10\ngit checkout <commit_hash>\n```\n\n### 3. Rebuild\n\n```bash\ndocker compose up -d --build\n```\n\n### 4. Restaurar Backup do Banco (se necessario)\n\n```bash\ndocker exec -i simulavoto-db psql -U simulavoto simulavoto < backup_YYYYMMDD_HHMMSS.sql\n```\n\n---\n\n## Troubleshooting\n\n### Erro: Container nao inicia\n\n```bash\ndocker compose logs simulavoto\ndocker compose logs db\n```\n\n### Erro: Banco nao conecta\n\n```bash\ndocker exec simulavoto-db pg_isready -U simulavoto -d simulavoto\ndocker compose restart db\n```\n\n### Erro: Conflito de Merge no Git\n\n```bash\ngit fetch origin\ngit reset --hard origin/main\n```\n\n### Erro: Porta ja em uso\n\n```bash\nnetstat -tlnp | grep 5000\nnetstat -tlnp | grep 5433\n```\n\n---\n\n## Checklist de Atualizacao\n\n- [ ] Backup do banco realizado\n- [ ] Espaco em disco verificado (>2GB)\n- [ ] `POSTGRES_PASSWORD` configurado no .env\n- [ ] `git pull` executado\n- [ ] `docker compose up -d --build` executado\n- [ ] Containers saudaveis (`docker compose ps`)\n- [ ] Health check passando (`curl localhost:5000/api/health`)\n- [ ] Login funcionando\n- [ ] Dados preservados apos atualizacao\n","path":null,"size_bytes":5433,"size_tokens":null},"server/replit_integrations/batch/index.ts":{"content":"export {\n  batchProcess,\n  batchProcessWithSSE,\n  isRateLimitError,\n  type BatchOptions,\n} from \"./utils\";\n\n","path":null,"size_bytes":108,"size_tokens":null},"client/src/components/stats-card.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { cn } from \"@/lib/utils\";\nimport type { LucideIcon } from \"lucide-react\";\n\ninterface StatsCardProps {\n  title: string;\n  value: string | number;\n  description?: string;\n  icon: LucideIcon;\n  trend?: { value: number; positive: boolean };\n  className?: string;\n}\n\nexport function StatsCard({\n  title,\n  value,\n  description,\n  icon: Icon,\n  trend,\n  className,\n}: StatsCardProps) {\n  return (\n    <Card className={cn(\"hover-elevate\", className)}>\n      <CardContent className=\"p-6\">\n        <div className=\"flex items-start justify-between gap-4\">\n          <div className=\"flex flex-col gap-1\">\n            <span className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">\n              {title}\n            </span>\n            <span className=\"text-3xl font-bold font-mono tabular-nums\">\n              {typeof value === \"number\" ? value.toLocaleString(\"pt-BR\") : value}\n            </span>\n            {description && (\n              <span className=\"text-sm text-muted-foreground\">{description}</span>\n            )}\n            {trend && (\n              <div className={cn(\n                \"flex items-center gap-1 text-sm font-medium\",\n                trend.positive ? \"text-success\" : \"text-destructive\"\n              )}>\n                <span>{trend.positive ? \"+\" : \"\"}{trend.value}%</span>\n                <span className=\"text-muted-foreground\">vs anterior</span>\n              </div>\n            )}\n          </div>\n          <div className=\"flex h-12 w-12 shrink-0 items-center justify-center rounded-md bg-primary/10\">\n            <Icon className=\"h-6 w-6 text-primary\" />\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":1740,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"server/replit_integrations/image/routes.ts":{"content":"import type { Express, Request, Response } from \"express\";\nimport { openai } from \"./client\";\n\nexport function registerImageRoutes(app: Express): void {\n  app.post(\"/api/generate-image\", async (req: Request, res: Response) => {\n    try {\n      const { prompt, size = \"1024x1024\" } = req.body;\n\n      if (!prompt) {\n        return res.status(400).json({ error: \"Prompt is required\" });\n      }\n\n      const response = await openai.images.generate({\n        model: \"gpt-image-1\",\n        prompt,\n        n: 1,\n        size: size as \"1024x1024\" | \"512x512\" | \"256x256\",\n      });\n\n      const imageData = response.data[0];\n      res.json({\n        url: imageData.url,\n        b64_json: imageData.b64_json,\n      });\n    } catch (error) {\n      console.error(\"Error generating image:\", error);\n      res.status(500).json({ error: \"Failed to generate image\" });\n    }\n  });\n}\n\n","path":null,"size_bytes":872,"size_tokens":null},"server/campaign-insights-service.ts":{"content":"import OpenAI from \"openai\";\nimport { db } from \"./db\";\nimport { \n  campaignInsightSessions, highImpactSegments, messageStrategies, \n  campaignImpactPredictions, campaignInsightReports,\n  parties, candidates, ibgeMunicipios, ibgePopulacao, ibgeIndicadores,\n  sentimentAnalysisResults, sentimentArticles\n} from \"@shared/schema\";\nimport { eq, desc, sql, and, gte, lte } from \"drizzle-orm\";\n\nfunction getOpenAI() {\n  const apiKey = process.env.OPENAI_API_KEY;\n  if (!apiKey) {\n    throw new Error(\"OPENAI_API_KEY environment variable is not set\");\n  }\n  return new OpenAI({ apiKey });\n}\n\ninterface SegmentAnalysisInput {\n  sessionId: number;\n  electionYear: number;\n  targetRegion?: string;\n  targetPartyId?: number;\n}\n\ninterface MessageAnalysisInput {\n  sessionId: number;\n  segmentId?: number;\n}\n\ninterface ImpactPredictionInput {\n  sessionId: number;\n  investmentType: string;\n  investmentAmount: number;\n  targetSegmentIds: number[];\n  duration: number;\n}\n\nclass CampaignInsightsService {\n  private static instance: CampaignInsightsService;\n\n  static getInstance(): CampaignInsightsService {\n    if (!CampaignInsightsService.instance) {\n      CampaignInsightsService.instance = new CampaignInsightsService();\n    }\n    return CampaignInsightsService.instance;\n  }\n\n  async createSession(data: {\n    name: string;\n    description?: string;\n    targetPartyId?: number;\n    targetCandidateId?: number;\n    electionYear: number;\n    position?: string;\n    targetRegion?: string;\n    createdBy?: string;\n  }): Promise<number> {\n    const [session] = await db.insert(campaignInsightSessions)\n      .values(data)\n      .returning({ id: campaignInsightSessions.id });\n    return session.id;\n  }\n\n  async getSessions(userId?: string): Promise<any[]> {\n    return db.select({\n      id: campaignInsightSessions.id,\n      name: campaignInsightSessions.name,\n      description: campaignInsightSessions.description,\n      electionYear: campaignInsightSessions.electionYear,\n      targetRegion: campaignInsightSessions.targetRegion,\n      position: campaignInsightSessions.position,\n      status: campaignInsightSessions.status,\n      createdAt: campaignInsightSessions.createdAt,\n      partyName: parties.name,\n      partyAbbreviation: parties.abbreviation,\n    })\n    .from(campaignInsightSessions)\n    .leftJoin(parties, eq(campaignInsightSessions.targetPartyId, parties.id))\n    .orderBy(desc(campaignInsightSessions.createdAt));\n  }\n\n  async getSessionById(id: number): Promise<any> {\n    const [session] = await db.select()\n      .from(campaignInsightSessions)\n      .leftJoin(parties, eq(campaignInsightSessions.targetPartyId, parties.id))\n      .where(eq(campaignInsightSessions.id, id));\n    \n    if (!session) return null;\n\n    const segments = await db.select()\n      .from(highImpactSegments)\n      .where(eq(highImpactSegments.sessionId, id))\n      .orderBy(highImpactSegments.priorityRank);\n\n    const strategies = await db.select()\n      .from(messageStrategies)\n      .where(eq(messageStrategies.sessionId, id));\n\n    const predictions = await db.select()\n      .from(campaignImpactPredictions)\n      .where(eq(campaignImpactPredictions.sessionId, id));\n\n    return {\n      ...session.campaign_insight_sessions,\n      party: session.parties,\n      segments,\n      strategies,\n      predictions,\n    };\n  }\n\n  async analyzeHighImpactSegments(input: SegmentAnalysisInput): Promise<any[]> {\n    const { sessionId, electionYear, targetRegion, targetPartyId } = input;\n\n    // Gather demographic data from IBGE\n    const demographicData = await this.getDemographicContext(targetRegion);\n    \n    // Gather sentiment data\n    const sentimentData = await this.getSentimentContext(targetPartyId);\n\n    // Build prompt for GPT-4o analysis\n    const prompt = `Você é um cientista de dados especialista em marketing político brasileiro.\n\nAnalise os dados demográficos e de sentimento para identificar os 5-7 segmentos de eleitores de MAIOR IMPACTO para uma campanha eleitoral em ${electionYear}.\n\nDADOS DEMOGRÁFICOS DA REGIÃO ${targetRegion || 'NACIONAL'}:\n${JSON.stringify(demographicData, null, 2)}\n\nDADOS DE SENTIMENTO RECENTES:\n${JSON.stringify(sentimentData, null, 2)}\n\nPara cada segmento identificado, forneça:\n1. Tipo de segmento (geographic, demographic, ou behavioral)\n2. Nome descritivo do segmento\n3. Descrição detalhada\n4. UF ou região geográfica (se aplicável)\n5. Faixa etária predominante\n6. Nível de renda (baixa, media, alta)\n7. Número estimado de eleitores no segmento\n8. Score de impacto (0-100): quanto este segmento pode influenciar a eleição\n9. Potencial de conversão (0-100): probabilidade de mudar voto com campanha efetiva\n10. Sentimento atual (-100 a 100): percepção atual sobre o candidato/partido\n11. Volatilidade (0-100): quão volátil é o voto deste segmento\n12. Ranking de prioridade (1 = mais importante)\n13. Racional da IA: explicação detalhada\n14. Fatores-chave: lista de fatores que justificam o score\n\nResponda em JSON com o seguinte formato:\n{\n  \"segments\": [\n    {\n      \"segmentType\": \"demographic\",\n      \"segmentName\": \"Nome do Segmento\",\n      \"description\": \"Descrição detalhada...\",\n      \"uf\": \"SP\",\n      \"region\": \"sudeste\",\n      \"ageGroup\": \"25-34\",\n      \"incomeLevel\": \"media\",\n      \"estimatedVoters\": 500000,\n      \"impactScore\": 85,\n      \"conversionPotential\": 70,\n      \"currentSentiment\": 15,\n      \"volatility\": 65,\n      \"priorityRank\": 1,\n      \"aiRationale\": \"Explicação detalhada do por quê...\",\n      \"keyFactors\": [\"fator1\", \"fator2\", \"fator3\"]\n    }\n  ],\n  \"methodology\": \"Descrição da metodologia utilizada\",\n  \"dataQuality\": \"Avaliação da qualidade dos dados disponíveis\"\n}`;\n\n    try {\n      const response = await getOpenAI().chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n        temperature: 0.7,\n      });\n\n      const result = JSON.parse(response.choices[0].message.content || \"{}\");\n      const segments = result.segments || [];\n\n      // Save segments to database\n      const savedSegments = [];\n      for (const segment of segments) {\n        const [saved] = await db.insert(highImpactSegments)\n          .values({\n            sessionId,\n            segmentType: segment.segmentType,\n            segmentName: segment.segmentName,\n            description: segment.description,\n            uf: segment.uf,\n            region: segment.region,\n            ageGroup: segment.ageGroup,\n            incomeLevel: segment.incomeLevel,\n            estimatedVoters: segment.estimatedVoters,\n            impactScore: segment.impactScore?.toString(),\n            conversionPotential: segment.conversionPotential?.toString(),\n            currentSentiment: segment.currentSentiment?.toString(),\n            volatility: segment.volatility?.toString(),\n            priorityRank: segment.priorityRank,\n            aiRationale: segment.aiRationale,\n            keyFactors: segment.keyFactors,\n          })\n          .returning();\n        savedSegments.push(saved);\n      }\n\n      return savedSegments;\n    } catch (error) {\n      console.error(\"Error analyzing segments:\", error);\n      throw error;\n    }\n  }\n\n  async generateMessageStrategies(input: MessageAnalysisInput): Promise<any[]> {\n    const { sessionId, segmentId } = input;\n\n    // Get session and segments\n    const session = await this.getSessionById(sessionId);\n    if (!session) throw new Error(\"Session not found\");\n\n    const segments = segmentId \n      ? session.segments.filter((s: any) => s.id === segmentId)\n      : session.segments;\n\n    if (segments.length === 0) {\n      throw new Error(\"No segments found. Run segment analysis first.\");\n    }\n\n    // Get recent sentiment data\n    const sentimentData = await this.getSentimentContext(session.targetPartyId);\n\n    const prompt = `Você é um especialista em comunicação política e marketing de campanhas eleitorais no Brasil.\n\nCom base nos segmentos de eleitores identificados e nos dados de sentimento, desenvolva estratégias de mensagem personalizadas.\n\nCONTEXTO DA CAMPANHA:\n- Ano eleitoral: ${session.electionYear}\n- Região alvo: ${session.targetRegion || 'Nacional'}\n- Cargo disputado: ${session.position || 'Não especificado'}\n\nSEGMENTOS DE ELEITORES:\n${JSON.stringify(segments, null, 2)}\n\nDADOS DE SENTIMENTO:\n${JSON.stringify(sentimentData, null, 2)}\n\nPara cada segmento, desenvolva uma estratégia de comunicação completa com:\n1. Público-alvo específico\n2. Perfil de sentimento atual (positive, neutral, negative, mixed)\n3. Tema principal da mensagem\n4. 3-5 mensagens-chave sugeridas\n5. Tom recomendado (formal, informal, emocional, técnico)\n6. Canais recomendados (tv, radio, redes_sociais, presencial, whatsapp)\n7. Tópicos para enfatizar\n8. Tópicos a evitar\n9. Fraquezas dos competidores a explorar\n10. Tendência atual do sentimento (rising, falling, stable)\n11. Análise completa da IA\n12. Score de confiança (0-100)\n13. Efetividade esperada (0-100)\n\nResponda em JSON:\n{\n  \"strategies\": [\n    {\n      \"targetAudience\": \"Descrição do público\",\n      \"segmentId\": 1,\n      \"sentimentProfile\": \"neutral\",\n      \"mainTheme\": \"Tema central\",\n      \"keyMessages\": [\"Mensagem 1\", \"Mensagem 2\", \"Mensagem 3\"],\n      \"toneRecommendation\": \"informal\",\n      \"channelRecommendations\": [\"redes_sociais\", \"whatsapp\"],\n      \"topicsToEmphasize\": [\"emprego\", \"saúde\", \"educação\"],\n      \"topicsToAvoid\": [\"aumento de impostos\"],\n      \"competitorWeaknesses\": [\"ponto fraco 1\"],\n      \"currentSentimentTrend\": \"stable\",\n      \"sentimentDrivers\": [\"driver1\", \"driver2\"],\n      \"aiAnalysis\": \"Análise detalhada...\",\n      \"confidenceScore\": 75,\n      \"expectedEffectiveness\": 68\n    }\n  ]\n}`;\n\n    try {\n      const response = await getOpenAI().chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n        temperature: 0.7,\n      });\n\n      const result = JSON.parse(response.choices[0].message.content || \"{}\");\n      const strategies = result.strategies || [];\n\n      const savedStrategies = [];\n      for (const strategy of strategies) {\n        const matchingSegment = segments.find((s: any) => \n          s.segmentName === strategy.targetAudience || s.id === strategy.segmentId\n        );\n\n        const [saved] = await db.insert(messageStrategies)\n          .values({\n            sessionId,\n            segmentId: matchingSegment?.id || null,\n            targetAudience: strategy.targetAudience,\n            sentimentProfile: strategy.sentimentProfile,\n            mainTheme: strategy.mainTheme,\n            keyMessages: strategy.keyMessages,\n            toneRecommendation: strategy.toneRecommendation,\n            channelRecommendations: strategy.channelRecommendations,\n            topicsToEmphasize: strategy.topicsToEmphasize,\n            topicsToAvoid: strategy.topicsToAvoid,\n            competitorWeaknesses: strategy.competitorWeaknesses,\n            currentSentimentTrend: strategy.currentSentimentTrend,\n            sentimentDrivers: strategy.sentimentDrivers,\n            aiAnalysis: strategy.aiAnalysis,\n            confidenceScore: strategy.confidenceScore?.toString(),\n            expectedEffectiveness: strategy.expectedEffectiveness?.toString(),\n          })\n          .returning();\n        savedStrategies.push(saved);\n      }\n\n      return savedStrategies;\n    } catch (error) {\n      console.error(\"Error generating message strategies:\", error);\n      throw error;\n    }\n  }\n\n  async predictCampaignImpact(input: ImpactPredictionInput): Promise<any> {\n    const { sessionId, investmentType, investmentAmount, targetSegmentIds, duration } = input;\n\n    const session = await this.getSessionById(sessionId);\n    if (!session) throw new Error(\"Session not found\");\n\n    const targetSegments = session.segments.filter((s: any) => \n      targetSegmentIds.includes(s.id)\n    );\n\n    const demographicData = await this.getDemographicContext(session.targetRegion);\n\n    const prompt = `Você é um cientista de dados especializado em modelagem preditiva para campanhas políticas.\n\nPreveja o impacto de um investimento de campanha com base nos dados fornecidos.\n\nINVESTIMENTO PROPOSTO:\n- Tipo: ${investmentType}\n- Valor: R$ ${investmentAmount.toLocaleString('pt-BR')}\n- Duração: ${duration} dias\n- Segmentos alvo: ${targetSegments.map((s: any) => s.segmentName).join(', ')}\n\nDADOS DOS SEGMENTOS:\n${JSON.stringify(targetSegments, null, 2)}\n\nDADOS DEMOGRÁFICOS:\n${JSON.stringify(demographicData, null, 2)}\n\nForneça uma análise preditiva completa incluindo:\n1. Mudança prevista no sentimento (-100 a +100)\n2. Intenção de voto prevista (% do eleitorado)\n3. Mudança na intenção de voto (delta %)\n4. Intervalo de confiança (lower e upper bounds)\n5. Probabilidade de sucesso (0-100)\n6. Alcance estimado (número de eleitores)\n7. Custo por eleitor alcançado\n8. ROI esperado (%)\n9. Cenários alternativos (otimista, pessimista)\n10. Narrativa explicativa da IA\n11. Fatores de risco\n12. Recomendações\n13. Metodologia utilizada\n\nUse modelos baseados em:\n- Regressão logística para probabilidade de voto\n- Monte Carlo para intervalos de confiança\n- Análise de elasticidade para ROI\n\nResponda em JSON:\n{\n  \"prediction\": {\n    \"predictedSentimentChange\": 12.5,\n    \"predictedVoteIntention\": 28.5,\n    \"predictedVoteChange\": 3.2,\n    \"confidenceInterval\": { \"lower\": 1.8, \"upper\": 4.6 },\n    \"probabilityOfSuccess\": 72,\n    \"estimatedReach\": 450000,\n    \"costPerVoterReached\": 2.44,\n    \"expectedROI\": 185,\n    \"alternativeScenarios\": {\n      \"optimistic\": { \"voteChange\": 5.1, \"probability\": 30 },\n      \"pessimistic\": { \"voteChange\": 1.2, \"probability\": 25 }\n    },\n    \"comparisonBaseline\": {\n      \"currentVoteIntention\": 25.3,\n      \"industryAverageROI\": 120\n    },\n    \"aiNarrative\": \"Análise detalhada...\",\n    \"riskFactors\": [\"risco1\", \"risco2\"],\n    \"recommendations\": [\"recomendação1\", \"recomendação2\"],\n    \"methodology\": \"Descrição da metodologia...\"\n  }\n}`;\n\n    try {\n      const response = await getOpenAI().chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n        temperature: 0.5,\n      });\n\n      const result = JSON.parse(response.choices[0].message.content || \"{}\");\n      const prediction = result.prediction || {};\n\n      const [saved] = await db.insert(campaignImpactPredictions)\n        .values({\n          sessionId,\n          predictionType: \"investment\",\n          investmentType,\n          investmentAmount: investmentAmount.toString(),\n          targetSegments: targetSegmentIds,\n          duration,\n          predictedSentimentChange: prediction.predictedSentimentChange?.toString(),\n          predictedVoteIntention: prediction.predictedVoteIntention?.toString(),\n          predictedVoteChange: prediction.predictedVoteChange?.toString(),\n          confidenceInterval: prediction.confidenceInterval,\n          probabilityOfSuccess: prediction.probabilityOfSuccess?.toString(),\n          estimatedReach: prediction.estimatedReach,\n          costPerVoterReached: prediction.costPerVoterReached?.toString(),\n          expectedROI: prediction.expectedROI?.toString(),\n          comparisonBaseline: prediction.comparisonBaseline,\n          alternativeScenarios: prediction.alternativeScenarios,\n          aiNarrative: prediction.aiNarrative,\n          riskFactors: prediction.riskFactors,\n          recommendations: prediction.recommendations,\n          methodology: prediction.methodology,\n        })\n        .returning();\n\n      return saved;\n    } catch (error) {\n      console.error(\"Error predicting campaign impact:\", error);\n      throw error;\n    }\n  }\n\n  async generateExecutiveReport(sessionId: number, userId?: string): Promise<any> {\n    const session = await this.getSessionById(sessionId);\n    if (!session) throw new Error(\"Session not found\");\n\n    const prompt = `Você é um consultor estratégico de marketing político.\n\nGere um relatório executivo completo com base na análise de campanha.\n\nDADOS DA SESSÃO:\n${JSON.stringify(session, null, 2)}\n\nCrie um relatório executivo que inclua:\n1. Sumário Executivo (2-3 parágrafos)\n2. Principais Insights (lista de 5-7 descobertas críticas)\n3. Itens de Ação prioritários\n4. Visualizações recomendadas (especificações de gráficos)\n5. Conteúdo completo do relatório em Markdown\n\nResponda em JSON:\n{\n  \"title\": \"Título do Relatório\",\n  \"executiveSummary\": \"Resumo executivo...\",\n  \"keyInsights\": [\n    { \"insight\": \"Insight 1\", \"importance\": \"high\", \"actionable\": true }\n  ],\n  \"actionItems\": [\n    { \"action\": \"Ação 1\", \"priority\": \"high\", \"deadline\": \"imediato\" }\n  ],\n  \"visualizations\": [\n    { \"type\": \"bar\", \"title\": \"Título\", \"data\": \"segments_by_impact\" }\n  ],\n  \"fullContent\": \"# Relatório Completo em Markdown...\"\n}`;\n\n    try {\n      const response = await getOpenAI().chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n        temperature: 0.6,\n      });\n\n      const result = JSON.parse(response.choices[0].message.content || \"{}\");\n\n      const [report] = await db.insert(campaignInsightReports)\n        .values({\n          sessionId,\n          reportType: \"executive\",\n          title: result.title || `Relatório - ${session.name}`,\n          executiveSummary: result.executiveSummary,\n          fullContent: result.fullContent,\n          visualizations: result.visualizations,\n          keyInsights: result.keyInsights,\n          actionItems: result.actionItems,\n          dataSnapshot: { session, generatedAt: new Date().toISOString() },\n          createdBy: userId,\n        })\n        .returning();\n\n      return report;\n    } catch (error) {\n      console.error(\"Error generating report:\", error);\n      throw error;\n    }\n  }\n\n  private async getDemographicContext(region?: string): Promise<any> {\n    let query = db.select({\n      totalMunicipios: sql<number>`count(DISTINCT ${ibgeMunicipios.id})::int`,\n      totalPopulacao: sql<number>`COALESCE(SUM(${ibgePopulacao.populacao}), 0)::bigint`,\n      avgIdhm: sql<number>`AVG(${ibgeIndicadores.idhm})`,\n      avgRenda: sql<number>`AVG(${ibgeIndicadores.rendaMediaDomiciliar})`,\n      avgAlfabetizacao: sql<number>`AVG(${ibgeIndicadores.taxaAlfabetizacao})`,\n    })\n    .from(ibgeMunicipios)\n    .leftJoin(ibgePopulacao, eq(ibgeMunicipios.codigoIbge, ibgePopulacao.codigoIbge))\n    .leftJoin(ibgeIndicadores, eq(ibgeMunicipios.codigoIbge, ibgeIndicadores.codigoIbge));\n\n    if (region && region !== 'NACIONAL') {\n      query = query.where(eq(ibgeMunicipios.uf, region)) as any;\n    }\n\n    const [result] = await query;\n\n    // Get regional breakdown\n    const byRegion = await db.select({\n      uf: ibgeMunicipios.uf,\n      count: sql<number>`count(*)::int`,\n      populacao: sql<number>`COALESCE(SUM(${ibgePopulacao.populacao}), 0)::bigint`,\n    })\n    .from(ibgeMunicipios)\n    .leftJoin(ibgePopulacao, eq(ibgeMunicipios.codigoIbge, ibgePopulacao.codigoIbge))\n    .groupBy(ibgeMunicipios.uf)\n    .orderBy(desc(sql`COALESCE(SUM(${ibgePopulacao.populacao}), 0)`))\n    .limit(10);\n\n    return {\n      summary: {\n        totalMunicipios: result.totalMunicipios,\n        totalPopulacao: Number(result.totalPopulacao),\n        avgIdhm: result.avgIdhm ? Number(result.avgIdhm).toFixed(3) : null,\n        avgRenda: result.avgRenda ? Number(result.avgRenda).toFixed(2) : null,\n        avgAlfabetizacao: result.avgAlfabetizacao ? Number(result.avgAlfabetizacao).toFixed(2) : null,\n      },\n      byRegion: byRegion.map(r => ({\n        uf: r.uf,\n        municipios: r.count,\n        populacao: Number(r.populacao),\n      })),\n    };\n  }\n\n  private async getSentimentContext(partyId?: number): Promise<any> {\n    // Get recent sentiment analysis results\n    const recentSentiment = await db.select()\n      .from(sentimentAnalysisResults)\n      .orderBy(desc(sentimentAnalysisResults.analysisDate))\n      .limit(20);\n\n    // Get recent article sentiment\n    const recentArticles = await db.select({\n      sentimentLabel: sentimentArticles.sentimentLabel,\n      count: sql<number>`count(*)::int`,\n    })\n    .from(sentimentArticles)\n    .where(gte(sentimentArticles.publishedAt, sql`NOW() - INTERVAL '30 days'`))\n    .groupBy(sentimentArticles.sentimentLabel);\n\n    return {\n      recentAnalysis: recentSentiment.slice(0, 10),\n      articleSentimentDistribution: recentArticles,\n      dataRange: \"últimos 30 dias\",\n    };\n  }\n}\n\nexport const campaignInsightsService = CampaignInsightsService.getInstance();\n","path":null,"size_bytes":20647,"size_tokens":null},"server/storage.ts":{"content":"import { db } from \"./db\";\nimport { eq, desc, sql, and, or, ilike, asc } from \"drizzle-orm\";\nimport { SQL } from \"drizzle-orm\";\nimport {\n  type User, type InsertUser, users,\n  type Party, type InsertParty, parties,\n  type Candidate, type InsertCandidate, candidates,\n  type Scenario, type InsertScenario, scenarios,\n  type ScenarioVote, type InsertScenarioVote, scenarioVotes,\n  type Simulation, type InsertSimulation, simulations,\n  type AuditLog, type InsertAuditLog, auditLogs,\n  type Alliance, type InsertAlliance, alliances,\n  type AllianceParty, type InsertAllianceParty, allianceParties,\n  type TseImportJob, type InsertTseImportJob, tseImportJobs,\n  type TseCandidateVote, type InsertTseCandidateVote, tseCandidateVotes,\n  type TseImportError, type InsertTseImportError, tseImportErrors,\n  type TseImportBatch, type InsertTseImportBatch, tseImportBatches,\n  type TseImportBatchRow, type InsertTseImportBatchRow, tseImportBatchRows,\n  type TseElectoralStatistics, type InsertTseElectoralStatistics, tseElectoralStatistics,\n  type TsePartyVotes, type InsertTsePartyVotes, tsePartyVotes,\n  type ScenarioCandidate, type InsertScenarioCandidate, scenarioCandidates,\n  type SavedReport, type InsertSavedReport, savedReports,\n  type AiPrediction, aiPredictions,\n  type ProjectionReportRecord, type InsertProjectionReport, projectionReports,\n  type ValidationRunRecord, type InsertValidationRun, importValidationRuns,\n  type ValidationIssueRecord, type InsertValidationIssue, importValidationIssues,\n  type ForecastRun, type InsertForecastRun, forecastRuns,\n  type ForecastResult, type InsertForecastResult, forecastResults,\n  type SwingRegion, type InsertSwingRegion, forecastSwingRegions,\n  type ReportTemplate, type InsertReportTemplate, reportTemplates,\n  type ReportSchedule, type InsertReportSchedule, reportSchedules,\n  type ReportRun, type InsertReportRun, reportRuns,\n  type ReportRecipient, type InsertReportRecipient, reportRecipients,\n  type PredictionScenario, type InsertPredictionScenario, predictionScenarios,\n  type CustomDashboard, type InsertCustomDashboard, customDashboards,\n  type AiSuggestion, type InsertAiSuggestion, aiSuggestions,\n  type SentimentDataSource, type InsertSentimentDataSource, sentimentDataSources,\n  type SentimentArticle, type InsertSentimentArticle, sentimentArticles,\n  type SentimentAnalysisResult, type InsertSentimentAnalysisResult, sentimentAnalysisResults,\n  type SentimentKeyword, type InsertSentimentKeyword, sentimentKeywords,\n  type Campaign, type InsertCampaign, campaigns,\n  type CampaignBudget, type InsertCampaignBudget, campaignBudgets,\n  type CampaignResource, type InsertCampaignResource, campaignResources,\n  type CampaignMetric, type InsertCampaignMetric, campaignMetrics,\n  type CampaignActivity, type InsertCampaignActivity, campaignActivities,\n  type CampaignTeamMember, type InsertCampaignTeamMember, campaignTeamMembers,\n  type ActivityAssignee, type InsertActivityAssignee, activityAssignees,\n  type AiKpiGoal, type InsertAiKpiGoal, aiKpiGoals,\n  type CampaignNotification, type InsertCampaignNotification, campaignNotifications,\n  campaignInsightSessions,\n} from \"@shared/schema\";\nimport { randomUUID } from \"crypto\";\nimport bcrypt from \"bcrypt\";\n\n// Pagination types\nexport interface PaginationOptions {\n  page: number;\n  limit: number;\n  search?: string;\n  sortBy?: string;\n  sortOrder?: \"asc\" | \"desc\";\n}\n\nexport interface PaginatedResult<T> {\n  data: T[];\n  total: number;\n  page: number;\n  limit: number;\n  totalPages: number;\n}\n\nexport interface PartyWithDetails extends Party {\n  candidateCount: number;\n  totalVotes: number;\n  recentScenarios: { id: number; name: string; votes: number }[];\n  historicalPerformance: { year: number; votes: number; seats: number }[];\n}\n\nexport interface CandidateWithDetails extends Candidate {\n  party?: Party;\n  totalVotes: number;\n  scenarioParticipations: { scenarioId: number; scenarioName: string; votes: number; elected: boolean }[];\n  historicalPerformance: { year: number; votes: number; position: string; result: string }[];\n}\n\nexport interface IStorage {\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  getUsers(): Promise<User[]>;\n  updateUser(id: string, data: Partial<InsertUser>): Promise<User | undefined>;\n  deleteUser(id: string): Promise<boolean>;\n\n  getParties(): Promise<Party[]>;\n  getParty(id: number): Promise<Party | undefined>;\n  getPartyByNumber(number: number): Promise<Party | undefined>;\n  createParty(party: InsertParty): Promise<Party>;\n  updateParty(id: number, data: Partial<InsertParty>): Promise<Party | undefined>;\n  deleteParty(id: number): Promise<boolean>;\n  syncPartiesFromTseImport(jobId: number): Promise<{ created: number; existing: number; updated: number }>;\n  getPartiesPaginated(options: PaginationOptions & { active?: boolean; tags?: string[] }): Promise<PaginatedResult<Party>>;\n  getPartyWithDetails(id: number): Promise<PartyWithDetails | undefined>;\n\n  getCandidates(): Promise<Candidate[]>;\n  getCandidate(id: number): Promise<Candidate | undefined>;\n  createCandidate(candidate: InsertCandidate): Promise<Candidate>;\n  updateCandidate(id: number, data: Partial<InsertCandidate>): Promise<Candidate | undefined>;\n  deleteCandidate(id: number): Promise<boolean>;\n  getCandidatesPaginated(options: PaginationOptions & { partyId?: number; position?: string; active?: boolean; tags?: string[] }): Promise<PaginatedResult<Candidate & { party?: Party }>>;\n  getCandidateWithDetails(id: number): Promise<CandidateWithDetails | undefined>;\n\n  getScenarios(): Promise<Scenario[]>;\n  getScenario(id: number): Promise<Scenario | undefined>;\n  createScenario(scenario: InsertScenario): Promise<Scenario>;\n  updateScenario(id: number, data: Partial<InsertScenario>): Promise<Scenario | undefined>;\n  deleteScenario(id: number): Promise<boolean>;\n\n  getSimulations(scenarioId?: number): Promise<Simulation[]>;\n  getRecentSimulations(limit?: number): Promise<Simulation[]>;\n  getSimulation(id: number): Promise<Simulation | undefined>;\n  createSimulation(simulation: InsertSimulation): Promise<Simulation>;\n\n  createAuditLog(log: InsertAuditLog): Promise<AuditLog>;\n  getAuditLogs(): Promise<AuditLog[]>;\n\n  getStats(): Promise<{ parties: number; candidates: number; scenarios: number; simulations: number }>;\n\n  getScenarioVotes(scenarioId: number): Promise<ScenarioVote[]>;\n  saveScenarioVotes(scenarioId: number, votes: InsertScenarioVote[]): Promise<ScenarioVote[]>;\n  deleteScenarioVotes(scenarioId: number): Promise<boolean>;\n\n  getAlliances(scenarioId: number): Promise<Alliance[]>;\n  getAlliance(id: number): Promise<Alliance | undefined>;\n  createAlliance(alliance: InsertAlliance): Promise<Alliance>;\n  updateAlliance(id: number, data: Partial<InsertAlliance>): Promise<Alliance | undefined>;\n  deleteAlliance(id: number): Promise<boolean>;\n  \n  getAllianceParties(allianceId: number): Promise<AllianceParty[]>;\n  setAllianceParties(allianceId: number, partyIds: number[]): Promise<AllianceParty[]>;\n  getPartyAlliance(scenarioId: number, partyId: number): Promise<Alliance | undefined>;\n\n  getScenarioCandidates(scenarioId: number): Promise<(ScenarioCandidate & { candidate: Candidate; party: Party })[]>;\n  getScenarioCandidate(id: number): Promise<ScenarioCandidate | undefined>;\n  createScenarioCandidate(data: InsertScenarioCandidate): Promise<ScenarioCandidate>;\n  updateScenarioCandidate(id: number, data: Partial<InsertScenarioCandidate>): Promise<ScenarioCandidate | undefined>;\n  deleteScenarioCandidate(id: number): Promise<boolean>;\n  addCandidateToScenario(scenarioId: number, candidateId: number, partyId: number, ballotNumber: number, nickname?: string, votes?: number): Promise<ScenarioCandidate>;\n\n  // Drill-down analytics methods\n  getCandidatesByParty(filters: {\n    year?: number;\n    uf?: string;\n    party: string;\n    position?: string;\n    limit?: number;\n  }): Promise<{\n    name: string;\n    nickname: string | null;\n    number: number | null;\n    votes: number;\n    municipality: string | null;\n    state: string | null;\n    position: string | null;\n    result: string | null;\n  }[]>;\n\n  getPartyPerformanceByState(filters: {\n    year?: number;\n    party?: string;\n    position?: string;\n  }): Promise<{\n    state: string;\n    party: string;\n    votes: number;\n    candidateCount: number;\n    percentage: number;\n  }[]>;\n\n  getVotesByPosition(filters: {\n    year?: number;\n    uf?: string;\n  }): Promise<{\n    position: string;\n    votes: number;\n    candidateCount: number;\n    partyCount: number;\n  }[]>;\n\n  // AI Prediction caching methods\n  getAiPrediction(cacheKey: string): Promise<AiPrediction | undefined>;\n  saveAiPrediction(data: { cacheKey: string; predictionType: string; prediction: unknown; expiresAt: Date }): Promise<AiPrediction>;\n  deleteExpiredAiPredictions(): Promise<number>;\n\n  // Validation methods\n  createValidationRun(data: InsertValidationRun): Promise<ValidationRunRecord>;\n  getValidationRun(id: number): Promise<ValidationRunRecord | undefined>;\n  getValidationRunByJobId(jobId: number): Promise<ValidationRunRecord | undefined>;\n  getValidationRunsForJob(jobId: number): Promise<ValidationRunRecord[]>;\n  updateValidationRun(id: number, data: Partial<InsertValidationRun>): Promise<ValidationRunRecord | undefined>;\n  \n  createValidationIssue(data: InsertValidationIssue): Promise<ValidationIssueRecord>;\n  createValidationIssues(data: InsertValidationIssue[]): Promise<ValidationIssueRecord[]>;\n  getValidationIssuesForRun(runId: number, filters?: { type?: string; severity?: string; status?: string }): Promise<ValidationIssueRecord[]>;\n  getValidationIssue(id: number): Promise<ValidationIssueRecord | undefined>;\n  updateValidationIssue(id: number, data: Partial<InsertValidationIssue>): Promise<ValidationIssueRecord | undefined>;\n  getValidationIssueCounts(runId: number): Promise<{ type: string; severity: string; count: number }[]>;\n\n  // Forecast methods\n  createForecastRun(data: InsertForecastRun): Promise<ForecastRun>;\n  getForecastRun(id: number): Promise<ForecastRun | undefined>;\n  getForecastRuns(filters?: { targetYear?: number; status?: string }): Promise<ForecastRun[]>;\n  updateForecastRun(id: number, data: Partial<InsertForecastRun>): Promise<ForecastRun | undefined>;\n  deleteForecastRun(id: number): Promise<boolean>;\n  \n  createForecastResult(data: InsertForecastResult): Promise<ForecastResult>;\n  createForecastResults(data: InsertForecastResult[]): Promise<ForecastResult[]>;\n  getForecastResults(runId: number, filters?: { resultType?: string; region?: string }): Promise<ForecastResult[]>;\n  \n  createSwingRegion(data: InsertSwingRegion): Promise<SwingRegion>;\n  createSwingRegions(data: InsertSwingRegion[]): Promise<SwingRegion[]>;\n  getSwingRegions(runId: number): Promise<SwingRegion[]>;\n  \n  // Historical data for forecasting\n  getHistoricalVotesByParty(filters: { years: number[]; position?: string; state?: string }): Promise<{\n    year: number;\n    party: string;\n    state: string | null;\n    position: string | null;\n    totalVotes: number;\n    candidateCount: number;\n  }[]>;\n  \n  getHistoricalTrends(filters: { party?: string; position?: string; state?: string }): Promise<{\n    year: number;\n    party: string;\n    voteShare: number;\n    seats?: number;\n  }[]>;\n\n  // Prediction Scenario methods\n  getPredictionScenarios(filters?: { status?: string; targetYear?: number }): Promise<PredictionScenario[]>;\n  getPredictionScenario(id: number): Promise<PredictionScenario | undefined>;\n  createPredictionScenario(data: InsertPredictionScenario): Promise<PredictionScenario>;\n  updatePredictionScenario(id: number, data: Partial<InsertPredictionScenario>): Promise<PredictionScenario | undefined>;\n  deletePredictionScenario(id: number): Promise<boolean>;\n\n  // Report Template methods\n  getReportTemplates(): Promise<ReportTemplate[]>;\n  getReportTemplate(id: number): Promise<ReportTemplate | undefined>;\n  createReportTemplate(data: InsertReportTemplate): Promise<ReportTemplate>;\n  updateReportTemplate(id: number, data: Partial<InsertReportTemplate>): Promise<ReportTemplate | undefined>;\n  deleteReportTemplate(id: number): Promise<boolean>;\n\n  // Report Schedule methods\n  getReportSchedules(): Promise<ReportSchedule[]>;\n  getReportSchedule(id: number): Promise<ReportSchedule | undefined>;\n  getDueSchedules(): Promise<ReportSchedule[]>;\n  createReportSchedule(data: InsertReportSchedule): Promise<ReportSchedule>;\n  updateReportSchedule(id: number, data: Partial<InsertReportSchedule>): Promise<ReportSchedule | undefined>;\n  deleteReportSchedule(id: number): Promise<boolean>;\n\n  // Report Run methods\n  getReportRuns(filters?: { scheduleId?: number; templateId?: number; status?: string; limit?: number }): Promise<ReportRun[]>;\n  getReportRun(id: number): Promise<ReportRun | undefined>;\n  createReportRun(data: InsertReportRun): Promise<ReportRun>;\n  updateReportRun(id: number, data: Partial<InsertReportRun>): Promise<ReportRun | undefined>;\n\n  // Report Recipients methods\n  getReportRecipients(): Promise<ReportRecipient[]>;\n  getReportRecipient(id: number): Promise<ReportRecipient | undefined>;\n  createReportRecipient(data: InsertReportRecipient): Promise<ReportRecipient>;\n  updateReportRecipient(id: number, data: Partial<InsertReportRecipient>): Promise<ReportRecipient | undefined>;\n  deleteReportRecipient(id: number): Promise<boolean>;\n\n  // Custom Dashboard methods\n  getCustomDashboards(userId?: string): Promise<CustomDashboard[]>;\n  getCustomDashboard(id: number): Promise<CustomDashboard | undefined>;\n  createCustomDashboard(data: InsertCustomDashboard): Promise<CustomDashboard>;\n  updateCustomDashboard(id: number, data: Partial<InsertCustomDashboard>): Promise<CustomDashboard | undefined>;\n  deleteCustomDashboard(id: number): Promise<boolean>;\n  getPublicDashboards(): Promise<CustomDashboard[]>;\n\n  // AI Suggestions methods\n  getAiSuggestions(userId?: string, filters?: { type?: string; dismissed?: boolean }): Promise<AiSuggestion[]>;\n  getAiSuggestion(id: number): Promise<AiSuggestion | undefined>;\n  createAiSuggestion(data: InsertAiSuggestion): Promise<AiSuggestion>;\n  updateAiSuggestion(id: number, data: Partial<InsertAiSuggestion>): Promise<AiSuggestion | undefined>;\n  deleteAiSuggestion(id: number): Promise<boolean>;\n  dismissAiSuggestion(id: number): Promise<boolean>;\n  applyAiSuggestion(id: number): Promise<boolean>;\n\n  // Advanced segmentation methods\n  getMunicipalities(filters?: { uf?: string; year?: number }): Promise<{ code: number; name: string; uf: string }[]>;\n  getVotesByMunicipality(filters: { year?: number; uf?: string; position?: string; party?: string; municipality?: string }): Promise<{\n    municipality: string;\n    municipalityCode: number;\n    state: string;\n    votes: number;\n    candidateCount: number;\n    partyCount: number;\n  }[]>;\n  getPositions(filters?: { year?: number; uf?: string }): Promise<{ code: number; name: string; votes: number }[]>;\n\n  // Campaign Management methods\n  getCampaigns(filters?: { status?: string; partyId?: number }): Promise<Campaign[]>;\n  getCampaign(id: number): Promise<Campaign | undefined>;\n  getCampaignWithDetails(id: number): Promise<{\n    campaign: Campaign;\n    party?: Party;\n    candidate?: Candidate;\n    aiSession?: any;\n    budgets: CampaignBudget[];\n    resources: CampaignResource[];\n    metrics: CampaignMetric[];\n    activities: CampaignActivity[];\n  } | undefined>;\n  createCampaign(data: InsertCampaign): Promise<Campaign>;\n  updateCampaign(id: number, data: Partial<InsertCampaign>): Promise<Campaign | undefined>;\n  deleteCampaign(id: number): Promise<boolean>;\n  \n  // Campaign Budget methods\n  getCampaignBudgets(campaignId: number): Promise<CampaignBudget[]>;\n  getCampaignBudget(id: number): Promise<CampaignBudget | undefined>;\n  createCampaignBudget(data: InsertCampaignBudget): Promise<CampaignBudget>;\n  updateCampaignBudget(id: number, data: Partial<InsertCampaignBudget>): Promise<CampaignBudget | undefined>;\n  deleteCampaignBudget(id: number): Promise<boolean>;\n  \n  // Campaign Resource methods\n  getCampaignResources(campaignId: number): Promise<CampaignResource[]>;\n  getCampaignResource(id: number): Promise<CampaignResource | undefined>;\n  createCampaignResource(data: InsertCampaignResource): Promise<CampaignResource>;\n  updateCampaignResource(id: number, data: Partial<InsertCampaignResource>): Promise<CampaignResource | undefined>;\n  deleteCampaignResource(id: number): Promise<boolean>;\n  \n  // Campaign Metric methods\n  getCampaignMetrics(campaignId: number, filters?: { kpiName?: string; startDate?: Date; endDate?: Date }): Promise<CampaignMetric[]>;\n  getCampaignMetric(id: number): Promise<CampaignMetric | undefined>;\n  createCampaignMetric(data: InsertCampaignMetric): Promise<CampaignMetric>;\n  updateCampaignMetric(id: number, data: Partial<InsertCampaignMetric>): Promise<CampaignMetric | undefined>;\n  deleteCampaignMetric(id: number): Promise<boolean>;\n  \n  // Campaign Activity methods\n  getCampaignActivities(campaignId: number, filters?: { status?: string; type?: string }): Promise<CampaignActivity[]>;\n  getCampaignActivity(id: number): Promise<CampaignActivity | undefined>;\n  createCampaignActivity(data: InsertCampaignActivity): Promise<CampaignActivity>;\n  updateCampaignActivity(id: number, data: Partial<InsertCampaignActivity>): Promise<CampaignActivity | undefined>;\n  deleteCampaignActivity(id: number): Promise<boolean>;\n  \n  // Campaign performance summary\n  getCampaignPerformanceSummary(campaignId: number): Promise<{\n    budgetUtilization: number;\n    activitiesCompleted: number;\n    activitiesTotal: number;\n    resourcesAllocated: number;\n    latestMetrics: { name: string; value: number; target: number | null }[];\n    daysRemaining: number;\n    progressPercentage: number;\n  }>;\n  \n  // Campaign Team Member methods\n  getCampaignTeamMembers(campaignId: number): Promise<CampaignTeamMember[]>;\n  getCampaignTeamMember(id: number): Promise<CampaignTeamMember | undefined>;\n  getCampaignTeamMemberByUser(campaignId: number, userId: string): Promise<CampaignTeamMember | undefined>;\n  createCampaignTeamMember(data: InsertCampaignTeamMember): Promise<CampaignTeamMember>;\n  updateCampaignTeamMember(id: number, data: Partial<InsertCampaignTeamMember>): Promise<CampaignTeamMember | undefined>;\n  deleteCampaignTeamMember(id: number): Promise<boolean>;\n  \n  // Activity Assignee methods\n  getActivityAssignees(activityId: number): Promise<ActivityAssignee[]>;\n  createActivityAssignee(data: InsertActivityAssignee): Promise<ActivityAssignee>;\n  deleteActivityAssignee(id: number): Promise<boolean>;\n  \n  // AI KPI Goals methods\n  getAiKpiGoals(campaignId: number): Promise<AiKpiGoal[]>;\n  getAiKpiGoal(id: number): Promise<AiKpiGoal | undefined>;\n  createAiKpiGoal(data: InsertAiKpiGoal): Promise<AiKpiGoal>;\n  updateAiKpiGoal(id: number, data: Partial<InsertAiKpiGoal>): Promise<AiKpiGoal | undefined>;\n  deleteAiKpiGoal(id: number): Promise<boolean>;\n  \n  // Campaign Notification methods\n  getCampaignNotifications(campaignId: number): Promise<CampaignNotification[]>;\n  getUserCampaignNotifications(userId: string): Promise<CampaignNotification[]>;\n  createCampaignNotification(data: InsertCampaignNotification): Promise<CampaignNotification>;\n  markCampaignNotificationSent(id: number, inAppNotificationId?: number): Promise<CampaignNotification | undefined>;\n  \n  // Calendar activities for date range\n  getCalendarActivities(campaignId: number, startDate: Date, endDate: Date): Promise<CampaignActivity[]>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user;\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const hashedPassword = await bcrypt.hash(insertUser.password, 10);\n    const [user] = await db.insert(users).values({\n      ...insertUser,\n      password: hashedPassword,\n    }).returning();\n    return user;\n  }\n\n  async getUsers(): Promise<User[]> {\n    return db.select().from(users).orderBy(users.name);\n  }\n\n  async updateUser(id: string, data: Partial<InsertUser>): Promise<User | undefined> {\n    if (data.password) {\n      data.password = await bcrypt.hash(data.password, 10);\n    }\n    const [user] = await db.update(users).set(data).where(eq(users.id, id)).returning();\n    return user;\n  }\n\n  async deleteUser(id: string): Promise<boolean> {\n    const result = await db.delete(users).where(eq(users.id, id));\n    return true;\n  }\n\n  async getParties(): Promise<Party[]> {\n    return db.select().from(parties).orderBy(parties.number);\n  }\n\n  async getParty(id: number): Promise<Party | undefined> {\n    const [party] = await db.select().from(parties).where(eq(parties.id, id));\n    return party;\n  }\n\n  async getPartyByNumber(number: number): Promise<Party | undefined> {\n    const [party] = await db.select().from(parties).where(eq(parties.number, number));\n    return party;\n  }\n\n  async createParty(party: InsertParty): Promise<Party> {\n    const [created] = await db.insert(parties).values(party).returning();\n    return created;\n  }\n\n  async syncPartiesFromTseImport(jobId: number): Promise<{ created: number; existing: number; updated: number }> {\n    // Get unique parties from candidate votes (if any)\n    const candidateParties = await db.selectDistinct({\n      nrPartido: tseCandidateVotes.nrPartido,\n      sgPartido: tseCandidateVotes.sgPartido,\n      nmPartido: tseCandidateVotes.nmPartido,\n    })\n    .from(tseCandidateVotes)\n    .where(eq(tseCandidateVotes.importJobId, jobId));\n\n    // Get unique parties from party votes (if any)\n    const partyVotesParties = await db.selectDistinct({\n      nrPartido: tsePartyVotes.nrPartido,\n      sgPartido: tsePartyVotes.sgPartido,\n      nmPartido: tsePartyVotes.nmPartido,\n    })\n    .from(tsePartyVotes)\n    .where(eq(tsePartyVotes.importJobId, jobId));\n\n    // Combine both sources, using Map to deduplicate by party number\n    const partyMap = new Map<number, { nrPartido: number; sgPartido: string; nmPartido: string | null }>();\n    \n    for (const p of candidateParties) {\n      if (p.nrPartido && p.sgPartido) {\n        partyMap.set(p.nrPartido, { nrPartido: p.nrPartido, sgPartido: p.sgPartido, nmPartido: p.nmPartido });\n      }\n    }\n    \n    for (const p of partyVotesParties) {\n      if (p.nrPartido && p.sgPartido && !partyMap.has(p.nrPartido)) {\n        partyMap.set(p.nrPartido, { nrPartido: p.nrPartido, sgPartido: p.sgPartido, nmPartido: p.nmPartido });\n      }\n    }\n\n    let created = 0;\n    let existing = 0;\n    let updated = 0;\n\n    // Get all existing parties for comparison\n    const existingParties = await db.select().from(parties);\n    const existingByNumber = new Map(existingParties.map(p => [p.number, p]));\n\n    for (const partyData of Array.from(partyMap.values())) {\n      try {\n        const existingParty = existingByNumber.get(partyData.nrPartido);\n        \n        if (existingParty) {\n          // Check if update is needed (abbreviation or name mismatch)\n          if (existingParty.abbreviation !== partyData.sgPartido || \n              (partyData.nmPartido && existingParty.name !== partyData.nmPartido)) {\n            await db.update(parties)\n              .set({\n                abbreviation: partyData.sgPartido,\n                name: partyData.nmPartido || partyData.sgPartido,\n              })\n              .where(eq(parties.number, partyData.nrPartido));\n            updated++;\n            console.log(`Updated party: ${partyData.sgPartido} (${partyData.nrPartido})`);\n          } else {\n            existing++;\n          }\n        } else {\n          // Insert new party\n          const result = await db.insert(parties).values({\n            name: partyData.nmPartido || partyData.sgPartido,\n            abbreviation: partyData.sgPartido,\n            number: partyData.nrPartido,\n            color: this.generatePartyColor(partyData.nrPartido),\n            active: true,\n          }).onConflictDoNothing({ target: parties.number }).returning();\n\n          if (result.length > 0) {\n            created++;\n            console.log(`Created party: ${partyData.sgPartido} (${partyData.nrPartido})`);\n          } else {\n            existing++;\n          }\n        }\n      } catch (error: any) {\n        // Handle abbreviation uniqueness conflict (different party with same abbreviation)\n        if (error.code === '23505') {\n          existing++;\n        } else {\n          console.error(`Failed to sync party ${partyData.sgPartido}:`, error.message);\n        }\n      }\n    }\n\n    return { created, existing, updated };\n  }\n\n  private generatePartyColor(partyNumber: number): string {\n    const colors: { [key: number]: string } = {\n      10: \"#FF0000\", // PRB/Republicanos - vermelho\n      11: \"#0000FF\", // PP - azul\n      12: \"#00AA00\", // PDT - verde\n      13: \"#FF0000\", // PT - vermelho\n      14: \"#00AA00\", // PTB - verde\n      15: \"#0000FF\", // MDB/PMDB - azul\n      16: \"#800080\", // PSTU - roxo\n      17: \"#FF8C00\", // PSL - laranja\n      18: \"#FFCC00\", // REDE - amarelo\n      19: \"#008000\", // PODE - verde\n      20: \"#00CED1\", // PSC - turquesa\n      21: \"#FFA500\", // PCB - laranja\n      22: \"#0000FF\", // PL - azul\n      23: \"#00FF00\", // PPS/Cidadania - verde\n      25: \"#008000\", // DEM/União - verde\n      27: \"#FF0000\", // PSDC - vermelho\n      28: \"#FF69B4\", // PRTB - rosa\n      29: \"#FFD700\", // PCO - dourado\n      30: \"#228B22\", // NOVO - verde\n      31: \"#FF4500\", // PHS - laranja\n      33: \"#0000CD\", // PMN - azul\n      35: \"#32CD32\", // PMB - verde\n      36: \"#800000\", // PTC - marrom\n      40: \"#FF6347\", // PSB - vermelho\n      43: \"#006400\", // PV - verde escuro\n      44: \"#0000FF\", // UNIÃO - azul\n      45: \"#0000FF\", // PSDB - azul\n      50: \"#FF0000\", // PSOL - vermelho\n      51: \"#FF4500\", // PEN/Patriota - laranja\n      54: \"#FF69B4\", // PPL - rosa\n      55: \"#FF0000\", // PSD - vermelho\n      65: \"#FF0000\", // PC do B - vermelho\n      70: \"#00BFFF\", // AVANTE - azul claro\n      77: \"#90EE90\", // SOLIDARIEDADE - verde claro\n      80: \"#4682B4\", // UP - azul\n      90: \"#006400\", // PROS - verde\n    };\n    return colors[partyNumber] || `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`;\n  }\n\n  async updateParty(id: number, data: Partial<InsertParty>): Promise<Party | undefined> {\n    const [party] = await db.update(parties).set(data).where(eq(parties.id, id)).returning();\n    return party;\n  }\n\n  async deleteParty(id: number): Promise<boolean> {\n    await db.delete(parties).where(eq(parties.id, id));\n    return true;\n  }\n\n  async getPartiesPaginated(options: PaginationOptions & { active?: boolean; tags?: string[] }): Promise<PaginatedResult<Party>> {\n    const { page, limit, search, sortBy = \"name\", sortOrder = \"asc\", active, tags } = options;\n    const offset = (page - 1) * limit;\n\n    // Build conditions array\n    const conditions: SQL[] = [];\n    \n    if (search) {\n      conditions.push(\n        or(\n          ilike(parties.name, `%${search}%`),\n          ilike(parties.abbreviation, `%${search}%`)\n        )!\n      );\n    }\n    \n    if (active !== undefined) {\n      conditions.push(eq(parties.active, active));\n    }\n\n    // Get total count\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n    const countResult = await db.select({ count: sql<number>`count(*)::int` })\n      .from(parties)\n      .where(whereClause);\n    const total = countResult[0]?.count || 0;\n\n    // Get paginated data\n    const orderColumn = sortBy === \"abbreviation\" ? parties.abbreviation : \n                       sortBy === \"number\" ? parties.number :\n                       sortBy === \"createdAt\" ? parties.createdAt : parties.name;\n    const orderDir = sortOrder === \"desc\" ? desc(orderColumn) : asc(orderColumn);\n\n    const data = await db.select()\n      .from(parties)\n      .where(whereClause)\n      .orderBy(orderDir)\n      .limit(limit)\n      .offset(offset);\n\n    return {\n      data,\n      total,\n      page,\n      limit,\n      totalPages: Math.ceil(total / limit),\n    };\n  }\n\n  async getPartyWithDetails(id: number): Promise<PartyWithDetails | undefined> {\n    const party = await this.getParty(id);\n    if (!party) return undefined;\n\n    // Get candidate count\n    const candidateCountResult = await db.select({ count: sql<number>`count(*)::int` })\n      .from(candidates)\n      .where(eq(candidates.partyId, id));\n    const candidateCount = candidateCountResult[0]?.count || 0;\n\n    // Get total votes from TSE data\n    const votesResult = await db.select({ total: sql<number>`coalesce(sum(qt_votos_nominais), 0)::int` })\n      .from(tseCandidateVotes)\n      .where(eq(tseCandidateVotes.nrPartido, party.number));\n    const totalVotes = votesResult[0]?.total || 0;\n\n    // Get recent scenarios\n    const recentScenariosResult = await db.select({\n      id: scenarios.id,\n      name: scenarios.name,\n      votes: sql<number>`coalesce(sum(${scenarioVotes.votes}), 0)::int`,\n    })\n    .from(scenarios)\n    .leftJoin(scenarioVotes, and(\n      eq(scenarioVotes.scenarioId, scenarios.id),\n      eq(scenarioVotes.partyId, id)\n    ))\n    .groupBy(scenarios.id, scenarios.name)\n    .orderBy(desc(scenarios.createdAt))\n    .limit(5);\n\n    // Get historical performance from TSE\n    const historicalResult = await db.select({\n      year: tseCandidateVotes.anoEleicao,\n      votes: sql<number>`coalesce(sum(qt_votos_nominais), 0)::int`,\n      seats: sql<number>`count(case when ${tseCandidateVotes.dsSitTotTurno} = 'ELEITO' then 1 end)::int`,\n    })\n    .from(tseCandidateVotes)\n    .where(eq(tseCandidateVotes.nrPartido, party.number))\n    .groupBy(tseCandidateVotes.anoEleicao)\n    .orderBy(desc(tseCandidateVotes.anoEleicao))\n    .limit(5);\n\n    return {\n      ...party,\n      candidateCount,\n      totalVotes,\n      recentScenarios: recentScenariosResult.map(s => ({ id: s.id, name: s.name, votes: s.votes })),\n      historicalPerformance: historicalResult.map(h => ({ \n        year: h.year || 0, \n        votes: h.votes, \n        seats: h.seats \n      })),\n    };\n  }\n\n  async getCandidates(): Promise<Candidate[]> {\n    return db.select().from(candidates).orderBy(candidates.number);\n  }\n\n  async getCandidate(id: number): Promise<Candidate | undefined> {\n    const [candidate] = await db.select().from(candidates).where(eq(candidates.id, id));\n    return candidate;\n  }\n\n  async createCandidate(candidate: InsertCandidate): Promise<Candidate> {\n    const [created] = await db.insert(candidates).values(candidate).returning();\n    return created;\n  }\n\n  async updateCandidate(id: number, data: Partial<InsertCandidate>): Promise<Candidate | undefined> {\n    const [candidate] = await db.update(candidates).set(data).where(eq(candidates.id, id)).returning();\n    return candidate;\n  }\n\n  async deleteCandidate(id: number): Promise<boolean> {\n    await db.delete(candidates).where(eq(candidates.id, id));\n    return true;\n  }\n\n  async getCandidatesPaginated(options: PaginationOptions & { partyId?: number; position?: string; active?: boolean; tags?: string[] }): Promise<PaginatedResult<Candidate & { party?: Party }>> {\n    const { page, limit, search, sortBy = \"name\", sortOrder = \"asc\", partyId, position, active, tags } = options;\n    const offset = (page - 1) * limit;\n\n    // Build conditions array\n    const conditions: SQL[] = [];\n    \n    if (search) {\n      conditions.push(\n        or(\n          ilike(candidates.name, `%${search}%`),\n          ilike(candidates.nickname, `%${search}%`)\n        )!\n      );\n    }\n    \n    if (partyId !== undefined) {\n      conditions.push(eq(candidates.partyId, partyId));\n    }\n    \n    if (position) {\n      conditions.push(eq(candidates.position, position));\n    }\n    \n    if (active !== undefined) {\n      conditions.push(eq(candidates.active, active));\n    }\n\n    // Get total count\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n    const countResult = await db.select({ count: sql<number>`count(*)::int` })\n      .from(candidates)\n      .where(whereClause);\n    const total = countResult[0]?.count || 0;\n\n    // Get paginated data with party join\n    const orderColumn = sortBy === \"number\" ? candidates.number :\n                       sortBy === \"position\" ? candidates.position :\n                       sortBy === \"createdAt\" ? candidates.createdAt : candidates.name;\n    const orderDir = sortOrder === \"desc\" ? desc(orderColumn) : asc(orderColumn);\n\n    const data = await db.select({\n      id: candidates.id,\n      name: candidates.name,\n      nickname: candidates.nickname,\n      number: candidates.number,\n      partyId: candidates.partyId,\n      position: candidates.position,\n      biography: candidates.biography,\n      notes: candidates.notes,\n      tags: candidates.tags,\n      active: candidates.active,\n      createdAt: candidates.createdAt,\n      updatedAt: candidates.updatedAt,\n      createdBy: candidates.createdBy,\n      party: parties,\n    })\n    .from(candidates)\n    .leftJoin(parties, eq(candidates.partyId, parties.id))\n    .where(whereClause)\n    .orderBy(orderDir)\n    .limit(limit)\n    .offset(offset);\n\n    return {\n      data: data.map(d => ({\n        ...d,\n        party: d.party || undefined,\n      })),\n      total,\n      page,\n      limit,\n      totalPages: Math.ceil(total / limit),\n    };\n  }\n\n  async getCandidateWithDetails(id: number): Promise<CandidateWithDetails | undefined> {\n    const candidate = await this.getCandidate(id);\n    if (!candidate) return undefined;\n\n    // Get party\n    const party = await this.getParty(candidate.partyId);\n\n    // Get total votes from TSE data\n    const votesResult = await db.select({ total: sql<number>`coalesce(sum(qt_votos_nominais), 0)::int` })\n      .from(tseCandidateVotes)\n      .where(eq(tseCandidateVotes.nrCandidato, candidate.number));\n    const totalVotes = votesResult[0]?.total || 0;\n\n    // Get scenario participations\n    const scenarioParticipations = await db.select({\n      scenarioId: scenarios.id,\n      scenarioName: scenarios.name,\n      votes: scenarioCandidates.votes,\n      elected: sql<boolean>`${scenarioCandidates.status} = 'elected'`,\n    })\n    .from(scenarioCandidates)\n    .innerJoin(scenarios, eq(scenarioCandidates.scenarioId, scenarios.id))\n    .where(eq(scenarioCandidates.candidateId, id))\n    .orderBy(desc(scenarios.createdAt))\n    .limit(10);\n\n    // Get historical performance from TSE\n    const historicalResult = await db.select({\n      year: tseCandidateVotes.anoEleicao,\n      votes: sql<number>`qt_votos_nominais`,\n      position: tseCandidateVotes.dsCargo,\n      result: tseCandidateVotes.dsSitTotTurno,\n    })\n    .from(tseCandidateVotes)\n    .where(eq(tseCandidateVotes.nrCandidato, candidate.number))\n    .orderBy(desc(tseCandidateVotes.anoEleicao))\n    .limit(10);\n\n    return {\n      ...candidate,\n      party,\n      totalVotes,\n      scenarioParticipations: scenarioParticipations.map(s => ({\n        scenarioId: s.scenarioId,\n        scenarioName: s.scenarioName,\n        votes: s.votes,\n        elected: s.elected,\n      })),\n      historicalPerformance: historicalResult.map(h => ({\n        year: h.year || 0,\n        votes: h.votes || 0,\n        position: h.position || \"\",\n        result: h.result || \"\",\n      })),\n    };\n  }\n\n  async getScenarios(): Promise<Scenario[]> {\n    return db.select().from(scenarios).orderBy(desc(scenarios.createdAt));\n  }\n\n  async getScenario(id: number): Promise<Scenario | undefined> {\n    const [scenario] = await db.select().from(scenarios).where(eq(scenarios.id, id));\n    return scenario;\n  }\n\n  async createScenario(scenario: InsertScenario): Promise<Scenario> {\n    const [created] = await db.insert(scenarios).values(scenario).returning();\n    return created;\n  }\n\n  async updateScenario(id: number, data: Partial<InsertScenario>): Promise<Scenario | undefined> {\n    const [scenario] = await db.update(scenarios).set({\n      ...data,\n      updatedAt: new Date(),\n    }).where(eq(scenarios.id, id)).returning();\n    return scenario;\n  }\n\n  async deleteScenario(id: number): Promise<boolean> {\n    await db.delete(scenarios).where(eq(scenarios.id, id));\n    return true;\n  }\n\n  async getSimulations(scenarioId?: number): Promise<Simulation[]> {\n    if (scenarioId) {\n      return db.select().from(simulations).where(eq(simulations.scenarioId, scenarioId)).orderBy(desc(simulations.createdAt));\n    }\n    return db.select().from(simulations).orderBy(desc(simulations.createdAt));\n  }\n\n  async getRecentSimulations(limit = 5): Promise<Simulation[]> {\n    return db.select().from(simulations).orderBy(desc(simulations.createdAt)).limit(limit);\n  }\n\n  async getSimulation(id: number): Promise<Simulation | undefined> {\n    const [simulation] = await db.select().from(simulations).where(eq(simulations.id, id));\n    return simulation;\n  }\n\n  async createSimulation(simulation: InsertSimulation): Promise<Simulation> {\n    const [created] = await db.insert(simulations).values(simulation).returning();\n    return created;\n  }\n\n  async createAuditLog(log: InsertAuditLog): Promise<AuditLog> {\n    const [created] = await db.insert(auditLogs).values(log).returning();\n    return created;\n  }\n\n  async getAuditLogs(): Promise<AuditLog[]> {\n    return db.select().from(auditLogs).orderBy(desc(auditLogs.createdAt)).limit(100);\n  }\n\n  async getStats(): Promise<{ parties: number; candidates: number; scenarios: number; simulations: number }> {\n    const [partiesCount] = await db.select({ count: sql<number>`count(*)::int` }).from(parties);\n    const [candidatesCount] = await db.select({ count: sql<number>`count(*)::int` }).from(candidates);\n    const [scenariosCount] = await db.select({ count: sql<number>`count(*)::int` }).from(scenarios);\n    const [simulationsCount] = await db.select({ count: sql<number>`count(*)::int` }).from(simulations);\n\n    return {\n      parties: partiesCount?.count || 0,\n      candidates: candidatesCount?.count || 0,\n      scenarios: scenariosCount?.count || 0,\n      simulations: simulationsCount?.count || 0,\n    };\n  }\n\n  async getActivityTrend(days: number = 7): Promise<{ day: string; simulacoes: number; cenarios: number }[]> {\n    const dayNames = [\"Dom\", \"Seg\", \"Ter\", \"Qua\", \"Qui\", \"Sex\", \"Sáb\"];\n    const result: { day: string; simulacoes: number; cenarios: number }[] = [];\n    \n    for (let i = days - 1; i >= 0; i--) {\n      const date = new Date();\n      date.setDate(date.getDate() - i);\n      date.setHours(0, 0, 0, 0);\n      \n      const nextDate = new Date(date);\n      nextDate.setDate(nextDate.getDate() + 1);\n      \n      // Count scenarios created on this day\n      const [scenariosOnDay] = await db\n        .select({ count: sql<number>`count(*)::int` })\n        .from(scenarios)\n        .where(and(\n          sql`${scenarios.createdAt} >= ${date.toISOString()}`,\n          sql`${scenarios.createdAt} < ${nextDate.toISOString()}`\n        ));\n      \n      // Count simulations created on this day\n      const [simulationsOnDay] = await db\n        .select({ count: sql<number>`count(*)::int` })\n        .from(simulations)\n        .where(and(\n          sql`${simulations.createdAt} >= ${date.toISOString()}`,\n          sql`${simulations.createdAt} < ${nextDate.toISOString()}`\n        ));\n      \n      result.push({\n        day: dayNames[date.getDay()],\n        simulacoes: simulationsOnDay?.count || 0,\n        cenarios: scenariosOnDay?.count || 0,\n      });\n    }\n    \n    return result;\n  }\n\n  async getScenarioVotes(scenarioId: number): Promise<ScenarioVote[]> {\n    return db.select().from(scenarioVotes).where(eq(scenarioVotes.scenarioId, scenarioId));\n  }\n\n  async saveScenarioVotes(scenarioId: number, votes: InsertScenarioVote[]): Promise<ScenarioVote[]> {\n    await db.delete(scenarioVotes).where(eq(scenarioVotes.scenarioId, scenarioId));\n    if (votes.length === 0) return [];\n    const created = await db.insert(scenarioVotes).values(votes).returning();\n    return created;\n  }\n\n  async deleteScenarioVotes(scenarioId: number): Promise<boolean> {\n    await db.delete(scenarioVotes).where(eq(scenarioVotes.scenarioId, scenarioId));\n    return true;\n  }\n\n  async getAlliances(scenarioId: number): Promise<Alliance[]> {\n    return db.select().from(alliances).where(eq(alliances.scenarioId, scenarioId)).orderBy(alliances.name);\n  }\n\n  async getAlliance(id: number): Promise<Alliance | undefined> {\n    const [alliance] = await db.select().from(alliances).where(eq(alliances.id, id));\n    return alliance;\n  }\n\n  async createAlliance(alliance: InsertAlliance): Promise<Alliance> {\n    const [created] = await db.insert(alliances).values(alliance).returning();\n    return created;\n  }\n\n  async updateAlliance(id: number, data: Partial<InsertAlliance>): Promise<Alliance | undefined> {\n    const [updated] = await db.update(alliances).set(data).where(eq(alliances.id, id)).returning();\n    return updated;\n  }\n\n  async deleteAlliance(id: number): Promise<boolean> {\n    await db.delete(alliances).where(eq(alliances.id, id));\n    return true;\n  }\n\n  async getAllianceParties(allianceId: number): Promise<AllianceParty[]> {\n    return db.select().from(allianceParties).where(eq(allianceParties.allianceId, allianceId));\n  }\n\n  async setAllianceParties(allianceId: number, partyIds: number[]): Promise<AllianceParty[]> {\n    await db.delete(allianceParties).where(eq(allianceParties.allianceId, allianceId));\n    if (partyIds.length === 0) return [];\n    const toInsert = partyIds.map((partyId) => ({ allianceId, partyId }));\n    const created = await db.insert(allianceParties).values(toInsert).returning();\n    return created;\n  }\n\n  async getPartyAlliance(scenarioId: number, partyId: number): Promise<Alliance | undefined> {\n    const result = await db\n      .select({ alliance: alliances })\n      .from(allianceParties)\n      .innerJoin(alliances, eq(allianceParties.allianceId, alliances.id))\n      .where(and(eq(allianceParties.partyId, partyId), eq(alliances.scenarioId, scenarioId)));\n    return result[0]?.alliance;\n  }\n\n  async seedDefaultAdmin(): Promise<void> {\n    const existingAdmin = await this.getUserByUsername(\"admin\");\n    if (!existingAdmin) {\n      await this.createUser({\n        username: \"admin\",\n        password: \"admin123\",\n        name: \"Administrador\",\n        email: \"admin@simulavoto.gov.br\",\n        role: \"admin\",\n        active: true,\n      });\n    }\n  }\n\n  async getTseImportJobs(): Promise<TseImportJob[]> {\n    return db.select().from(tseImportJobs).orderBy(desc(tseImportJobs.createdAt));\n  }\n\n  async getTseImportJob(id: number): Promise<TseImportJob | undefined> {\n    const [job] = await db.select().from(tseImportJobs).where(eq(tseImportJobs.id, id));\n    return job;\n  }\n\n  async findExistingImport(\n    filename: string, \n    electionYear?: number | null, \n    uf?: string | null,\n    electionType?: string | null\n  ): Promise<{ job: TseImportJob; isInProgress: boolean } | undefined> {\n    const filenameCondition = eq(tseImportJobs.filename, filename);\n    \n    const baseConditions = [filenameCondition];\n    \n    if (electionYear) {\n      baseConditions.push(eq(tseImportJobs.electionYear, electionYear));\n    }\n    \n    if (uf) {\n      baseConditions.push(eq(tseImportJobs.uf, uf));\n    }\n\n    if (electionType) {\n      baseConditions.push(eq(tseImportJobs.electionType, electionType));\n    }\n    \n    const inProgressStatuses = [\"pending\", \"downloading\", \"extracting\", \"running\"];\n    \n    const [inProgressJob] = await db.select()\n      .from(tseImportJobs)\n      .where(and(\n        ...baseConditions,\n        sql`${tseImportJobs.status} IN ('pending', 'downloading', 'extracting', 'running')`\n      ))\n      .orderBy(desc(tseImportJobs.createdAt))\n      .limit(1);\n    \n    if (inProgressJob) {\n      return { job: inProgressJob, isInProgress: true };\n    }\n    \n    const [completedJob] = await db.select()\n      .from(tseImportJobs)\n      .where(and(\n        ...baseConditions,\n        eq(tseImportJobs.status, \"completed\")\n      ))\n      .orderBy(desc(tseImportJobs.completedAt))\n      .limit(1);\n    \n    if (completedJob) {\n      return { job: completedJob, isInProgress: false };\n    }\n    \n    return undefined;\n  }\n\n  async createTseImportJob(job: InsertTseImportJob): Promise<TseImportJob> {\n    const [created] = await db.insert(tseImportJobs).values(job).returning();\n    return created;\n  }\n\n  async updateTseImportJob(id: number, data: Partial<InsertTseImportJob>): Promise<TseImportJob | undefined> {\n    const [updated] = await db.update(tseImportJobs).set(data).where(eq(tseImportJobs.id, id)).returning();\n    return updated;\n  }\n\n  async getTseImportErrors(jobId: number): Promise<TseImportError[]> {\n    return db.select().from(tseImportErrors).where(eq(tseImportErrors.importJobId, jobId)).orderBy(tseImportErrors.rowNumber);\n  }\n\n  async createTseImportError(error: InsertTseImportError): Promise<TseImportError> {\n    const [created] = await db.insert(tseImportErrors).values(error).returning();\n    return created;\n  }\n\n  async bulkInsertTseCandidateVotes(votes: InsertTseCandidateVote[]): Promise<number> {\n    if (votes.length === 0) return 0;\n    \n    const NUM_COLUMNS = 54;\n    const BATCH_SIZE = Math.floor(65000 / NUM_COLUMNS * 0.9);\n    let totalInserted = 0;\n    \n    for (let i = 0; i < votes.length; i += BATCH_SIZE) {\n      const batch = votes.slice(i, i + BATCH_SIZE);\n      totalInserted += await this._insertBatchWithSplit(\"tseCandidateVotes\", tseCandidateVotes, batch);\n    }\n    \n    return totalInserted;\n  }\n\n  private async _insertBatchWithSplit(tableName: string, table: any, records: any[]): Promise<number> {\n    if (records.length === 0) return 0;\n    try {\n      const result = await db.insert(table)\n        .values(records)\n        .onConflictDoNothing()\n        .returning({ id: table.id });\n      return result.length;\n    } catch (err: any) {\n      const isParamError = err.message?.includes(\"bind\") || err.message?.includes(\"parameters\") || err.message?.includes(\"stack\");\n      if (records.length <= 1) {\n        console.warn(`[${tableName}] Single record insert failed:`, err.message);\n        return 0;\n      }\n      if (isParamError || records.length > 50) {\n        const mid = Math.ceil(records.length / 2);\n        const left = await this._insertBatchWithSplit(tableName, table, records.slice(0, mid));\n        const right = await this._insertBatchWithSplit(tableName, table, records.slice(mid));\n        return left + right;\n      }\n      console.warn(`[${tableName}] Batch of ${records.length} failed (non-param error):`, err.message);\n      return 0;\n    }\n  }\n\n  async insertTseElectoralStatisticsBatch(records: InsertTseElectoralStatistics[]): Promise<number> {\n    if (records.length === 0) return 0;\n    \n    const NUM_COLUMNS = 47;\n    const BATCH_SIZE = Math.floor(65000 / NUM_COLUMNS * 0.9);\n    let totalInserted = 0;\n    \n    for (let i = 0; i < records.length; i += BATCH_SIZE) {\n      const batch = records.slice(i, i + BATCH_SIZE);\n      totalInserted += await this._insertBatchWithSplit(\"tseElectoralStatistics\", tseElectoralStatistics, batch);\n    }\n    \n    return totalInserted;\n  }\n\n  async insertTsePartyVotesBatch(records: InsertTsePartyVotes[]): Promise<number> {\n    if (records.length === 0) return 0;\n    \n    const NUM_COLUMNS = 41;\n    const BATCH_SIZE = Math.floor(65000 / NUM_COLUMNS * 0.9);\n    let totalInserted = 0;\n    \n    for (let i = 0; i < records.length; i += BATCH_SIZE) {\n      const batch = records.slice(i, i + BATCH_SIZE);\n      totalInserted += await this._insertBatchWithSplit(\"tsePartyVotes\", tsePartyVotes, batch);\n    }\n    \n    return totalInserted;\n  }\n\n  async getElectoralStatisticsSummary(filters: {\n    anoEleicao?: number;\n    sgUf?: string;\n    cdCargo?: number;\n    cdMunicipio?: number;\n    nrTurno?: number;\n  }): Promise<any> {\n    const conditions: SQL[] = [];\n    if (filters.anoEleicao) conditions.push(eq(tseElectoralStatistics.anoEleicao, filters.anoEleicao));\n    if (filters.sgUf) conditions.push(eq(tseElectoralStatistics.sgUf, filters.sgUf));\n    if (filters.cdCargo) conditions.push(eq(tseElectoralStatistics.cdCargo, filters.cdCargo));\n    if (filters.cdMunicipio) conditions.push(eq(tseElectoralStatistics.cdMunicipio, filters.cdMunicipio));\n    // Default to turno 1 if not specified to avoid double-counting voters\n    const turno = filters.nrTurno ?? 1;\n    conditions.push(eq(tseElectoralStatistics.nrTurno, turno));\n\n    const result = await db.select({\n      anoEleicao: tseElectoralStatistics.anoEleicao,\n      sgUf: tseElectoralStatistics.sgUf,\n      cdCargo: tseElectoralStatistics.cdCargo,\n      dsCargo: tseElectoralStatistics.dsCargo,\n      nrTurno: tseElectoralStatistics.nrTurno,\n      totalAptos: sql<number>`SUM(${tseElectoralStatistics.qtAptos})::int`,\n      totalComparecimento: sql<number>`SUM(${tseElectoralStatistics.qtComparecimento})::int`,\n      totalAbstencoes: sql<number>`SUM(${tseElectoralStatistics.qtAbstencoes})::int`,\n      totalVotosValidos: sql<number>`SUM(${tseElectoralStatistics.qtTotalVotosValidos})::int`,\n      totalVotosBrancos: sql<number>`SUM(${tseElectoralStatistics.qtVotosBrancos})::int`,\n      totalVotosNulos: sql<number>`SUM(${tseElectoralStatistics.qtTotalVotosNulos})::int`,\n      totalVotosLegenda: sql<number>`SUM(${tseElectoralStatistics.qtTotalVotosLegValidos})::int`,\n      totalVotosNominais: sql<number>`SUM(${tseElectoralStatistics.qtVotosNominaisValidos})::int`,\n    })\n    .from(tseElectoralStatistics)\n    .where(conditions.length > 0 ? and(...conditions) : undefined)\n    .groupBy(\n      tseElectoralStatistics.anoEleicao, \n      tseElectoralStatistics.sgUf, \n      tseElectoralStatistics.cdCargo, \n      tseElectoralStatistics.dsCargo,\n      tseElectoralStatistics.nrTurno\n    );\n\n    return result;\n  }\n\n  async getAvailableHistoricalElections(): Promise<Array<{\n    year: number;\n    states: string[];\n    cargos: Array<{ code: number; name: string }>;\n  }>> {\n    const yearsResult = await db.selectDistinct({\n      year: tseElectoralStatistics.anoEleicao,\n    }).from(tseElectoralStatistics).where(sql`${tseElectoralStatistics.anoEleicao} IS NOT NULL`);\n\n    const elections: Array<{\n      year: number;\n      states: string[];\n      cargos: Array<{ code: number; name: string }>;\n    }> = [];\n\n    for (const { year } of yearsResult) {\n      if (!year) continue;\n\n      const statesResult = await db.selectDistinct({\n        uf: tseElectoralStatistics.sgUf,\n      }).from(tseElectoralStatistics).where(eq(tseElectoralStatistics.anoEleicao, year));\n\n      const cargosResult = await db.selectDistinct({\n        code: tseElectoralStatistics.cdCargo,\n        name: tseElectoralStatistics.dsCargo,\n      }).from(tseElectoralStatistics).where(eq(tseElectoralStatistics.anoEleicao, year));\n\n      elections.push({\n        year,\n        states: statesResult.map(s => s.uf!).filter(Boolean).sort(),\n        cargos: cargosResult.filter(c => c.code).map(c => ({ code: c.code!, name: c.name || \"Unknown\" })),\n      });\n    }\n\n    return elections.sort((a, b) => b.year - a.year);\n  }\n\n  async getHistoricalPartyVotes(filters: {\n    anoEleicao: number;\n    sgUf?: string;\n    cdCargo: number;\n    cdMunicipio?: number;\n  }): Promise<Array<{\n    nrPartido: number;\n    sgPartido: string;\n    nmPartido: string | null;\n    votosNominais: number;\n    votosLegenda: number;\n    totalVotos: number;\n    federacao: string | null;\n    coligacao: string | null;\n  }>> {\n    const conditions: SQL[] = [\n      eq(tsePartyVotes.anoEleicao, filters.anoEleicao),\n      eq(tsePartyVotes.cdCargo, filters.cdCargo),\n    ];\n    if (filters.sgUf) conditions.push(eq(tsePartyVotes.sgUf, filters.sgUf));\n    if (filters.cdMunicipio) conditions.push(eq(tsePartyVotes.cdMunicipio, filters.cdMunicipio));\n\n    const result = await db.select({\n      nrPartido: tsePartyVotes.nrPartido,\n      sgPartido: tsePartyVotes.sgPartido,\n      nmPartido: tsePartyVotes.nmPartido,\n      votosNominais: sql<number>`SUM(COALESCE(${tsePartyVotes.qtVotosNominaisValidos}, 0))::int`,\n      votosLegenda: sql<number>`SUM(COALESCE(${tsePartyVotes.qtTotalVotosLegValidos}, 0))::int`,\n      federacao: sql<string>`MAX(${tsePartyVotes.dsComposicaoFederacao})`,\n      coligacao: sql<string>`MAX(${tsePartyVotes.dsComposicaoColigacao})`,\n    })\n    .from(tsePartyVotes)\n    .where(and(...conditions))\n    .groupBy(tsePartyVotes.nrPartido, tsePartyVotes.sgPartido, tsePartyVotes.nmPartido);\n\n    return result.map(r => ({\n      nrPartido: r.nrPartido,\n      sgPartido: r.sgPartido,\n      nmPartido: r.nmPartido,\n      votosNominais: r.votosNominais || 0,\n      votosLegenda: r.votosLegenda || 0,\n      totalVotos: (r.votosNominais || 0) + (r.votosLegenda || 0),\n      federacao: r.federacao,\n      coligacao: r.coligacao,\n    }));\n  }\n\n  async countTseCandidateVotesByJob(jobId: number): Promise<number> {\n    const result = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(tseCandidateVotes)\n      .where(eq(tseCandidateVotes.importJobId, jobId));\n    return result[0]?.count || 0;\n  }\n\n  async countTseElectoralStatisticsByJob(jobId: number): Promise<number> {\n    const result = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(tseElectoralStatistics)\n      .where(eq(tseElectoralStatistics.importJobId, jobId));\n    return result[0]?.count || 0;\n  }\n\n  async countTsePartyVotesByJob(jobId: number): Promise<number> {\n    const result = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(tsePartyVotes)\n      .where(eq(tsePartyVotes.importJobId, jobId));\n    return result[0]?.count || 0;\n  }\n\n  async deleteTseCandidateVotesByJob(jobId: number): Promise<void> {\n    await db.delete(tseCandidateVotes).where(eq(tseCandidateVotes.importJobId, jobId));\n  }\n\n  async deleteTsePartyVotesByJob(jobId: number): Promise<void> {\n    await db.delete(tsePartyVotes).where(eq(tsePartyVotes.importJobId, jobId));\n  }\n\n  async deleteTseElectoralStatisticsByJob(jobId: number): Promise<void> {\n    await db.delete(tseElectoralStatistics).where(eq(tseElectoralStatistics.importJobId, jobId));\n  }\n\n  async deleteTseImportErrorsByJob(jobId: number): Promise<void> {\n    await db.delete(tseImportErrors).where(eq(tseImportErrors.importJobId, jobId));\n  }\n\n  async deleteValidationRunsByJob(jobId: number): Promise<void> {\n    // First delete validation issues for all runs of this job\n    const runs = await db.select({ id: importValidationRuns.id })\n      .from(importValidationRuns)\n      .where(eq(importValidationRuns.jobId, jobId));\n    \n    for (const run of runs) {\n      await db.delete(importValidationIssues).where(eq(importValidationIssues.runId, run.id));\n    }\n    \n    // Then delete the validation runs themselves\n    await db.delete(importValidationRuns).where(eq(importValidationRuns.jobId, jobId));\n  }\n\n  async deleteTseImportJob(jobId: number): Promise<void> {\n    await db.delete(tseImportJobs).where(eq(tseImportJobs.id, jobId));\n  }\n\n  async getTseCandidateVotes(filters: {\n    year?: number;\n    uf?: string;\n    cargo?: number;\n    limit: number;\n    offset: number;\n  }): Promise<TseCandidateVote[]> {\n    let query = db.select().from(tseCandidateVotes);\n    const conditions = [];\n    if (filters.year) {\n      conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    }\n    if (filters.uf) {\n      conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n    }\n    if (filters.cargo) {\n      conditions.push(eq(tseCandidateVotes.cdCargo, filters.cargo));\n    }\n    if (conditions.length > 0) {\n      query = query.where(and(...conditions)) as typeof query;\n    }\n    return query.limit(filters.limit).offset(filters.offset);\n  }\n\n  async getTseStats(): Promise<{\n    totalRecords: number;\n    years: number[];\n    ufs: string[];\n    cargos: { code: number; name: string }[];\n  }> {\n    const countResult = await db.select({ count: sql<number>`count(*)` }).from(tseCandidateVotes);\n    const yearsResult = await db.selectDistinct({ year: tseCandidateVotes.anoEleicao }).from(tseCandidateVotes).where(sql`${tseCandidateVotes.anoEleicao} is not null`);\n    const ufsResult = await db.selectDistinct({ uf: tseCandidateVotes.sgUf }).from(tseCandidateVotes).where(sql`${tseCandidateVotes.sgUf} is not null`);\n    const cargosResult = await db.selectDistinct({ code: tseCandidateVotes.cdCargo, name: tseCandidateVotes.dsCargo }).from(tseCandidateVotes).where(sql`${tseCandidateVotes.cdCargo} is not null`);\n\n    // Filter out \"ZZ\" (exterior/abroad votes) from UF count - Brazil has 27 UFs\n    const validUfs = ufsResult.map(r => r.uf!).filter(uf => uf && uf !== 'ZZ').sort();\n\n    return {\n      totalRecords: Number(countResult[0]?.count || 0),\n      years: yearsResult.map(r => r.year!).filter(Boolean).sort((a, b) => b - a),\n      ufs: validUfs,\n      cargos: cargosResult.filter(r => r.code && r.name).map(r => ({ code: r.code!, name: r.name! })),\n    };\n  }\n\n  async searchTseCandidates(query: string, filters?: {\n    year?: number;\n    uf?: string;\n    cargo?: number;\n  }): Promise<{\n    nmCandidato: string | null;\n    nmUrnaCandidato: string | null;\n    nrCandidato: number | null;\n    sgPartido: string | null;\n    nmPartido: string | null;\n    nrPartido: number | null;\n    anoEleicao: number | null;\n    sgUf: string | null;\n    dsCargo: string | null;\n    qtVotosNominais: number | null;\n  }[]> {\n    const conditions = [\n      sql`(LOWER(${tseCandidateVotes.nmCandidato}) LIKE ${'%' + query.toLowerCase() + '%'} OR LOWER(${tseCandidateVotes.nmUrnaCandidato}) LIKE ${'%' + query.toLowerCase() + '%'})`\n    ];\n    \n    if (filters?.year) {\n      conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    }\n    if (filters?.uf) {\n      conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n    }\n    if (filters?.cargo) {\n      conditions.push(eq(tseCandidateVotes.cdCargo, filters.cargo));\n    }\n\n    // Agrupa por candidato e soma votos\n    const results = await db\n      .select({\n        nmCandidato: tseCandidateVotes.nmCandidato,\n        nmUrnaCandidato: tseCandidateVotes.nmUrnaCandidato,\n        nrCandidato: tseCandidateVotes.nrCandidato,\n        sgPartido: tseCandidateVotes.sgPartido,\n        nmPartido: tseCandidateVotes.nmPartido,\n        nrPartido: tseCandidateVotes.nrPartido,\n        anoEleicao: tseCandidateVotes.anoEleicao,\n        sgUf: tseCandidateVotes.sgUf,\n        dsCargo: tseCandidateVotes.dsCargo,\n        qtVotosNominais: sql<number>`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0)`,\n      })\n      .from(tseCandidateVotes)\n      .where(and(...conditions))\n      .groupBy(\n        tseCandidateVotes.nmCandidato,\n        tseCandidateVotes.nmUrnaCandidato,\n        tseCandidateVotes.nrCandidato,\n        tseCandidateVotes.sgPartido,\n        tseCandidateVotes.nmPartido,\n        tseCandidateVotes.nrPartido,\n        tseCandidateVotes.anoEleicao,\n        tseCandidateVotes.sgUf,\n        tseCandidateVotes.dsCargo\n      )\n      .orderBy(sql`SUM(${tseCandidateVotes.qtVotosNominais}) DESC`)\n      .limit(20);\n\n    return results;\n  }\n\n  async getScenarioCandidates(scenarioId: number): Promise<(ScenarioCandidate & { candidate: Candidate; party: Party })[]> {\n    const results = await db\n      .select({\n        scenarioCandidate: scenarioCandidates,\n        candidate: candidates,\n        party: parties,\n      })\n      .from(scenarioCandidates)\n      .innerJoin(candidates, eq(scenarioCandidates.candidateId, candidates.id))\n      .innerJoin(parties, eq(scenarioCandidates.partyId, parties.id))\n      .where(eq(scenarioCandidates.scenarioId, scenarioId))\n      .orderBy(scenarioCandidates.ballotNumber);\n\n    return results.map((r) => ({\n      ...r.scenarioCandidate,\n      candidate: r.candidate,\n      party: r.party,\n    }));\n  }\n\n  async getScenarioCandidate(id: number): Promise<ScenarioCandidate | undefined> {\n    const [result] = await db.select().from(scenarioCandidates).where(eq(scenarioCandidates.id, id));\n    return result;\n  }\n\n  async createScenarioCandidate(data: InsertScenarioCandidate): Promise<ScenarioCandidate> {\n    const [created] = await db.insert(scenarioCandidates).values(data).returning();\n    return created;\n  }\n\n  async updateScenarioCandidate(id: number, data: Partial<InsertScenarioCandidate>): Promise<ScenarioCandidate | undefined> {\n    const [updated] = await db.update(scenarioCandidates).set(data).where(eq(scenarioCandidates.id, id)).returning();\n    return updated;\n  }\n\n  async deleteScenarioCandidate(id: number): Promise<boolean> {\n    const result = await db.delete(scenarioCandidates).where(eq(scenarioCandidates.id, id));\n    return (result.rowCount ?? 0) > 0;\n  }\n\n  async addCandidateToScenario(scenarioId: number, candidateId: number, partyId: number, ballotNumber: number, nickname?: string, votes?: number): Promise<ScenarioCandidate> {\n    return this.createScenarioCandidate({\n      scenarioId,\n      candidateId,\n      partyId,\n      ballotNumber,\n      nickname,\n      status: \"active\",\n      votes: votes ?? 0,\n    });\n  }\n\n  // Analytics methods\n  async getAnalyticsSummary(filters: { year?: number; uf?: string; electionType?: string }): Promise<{\n    totalVotes: number;\n    totalCandidates: number;\n    totalParties: number;\n    totalMunicipalities: number;\n  }> {\n    const conditions: any[] = [];\n    if (filters.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters.uf) conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n    if (filters.electionType) conditions.push(eq(tseCandidateVotes.nmTipoEleicao, filters.electionType));\n\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const [result] = await db\n      .select({\n        totalVotes: sql<number>`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0)`,\n        totalCandidates: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sqCandidato})`,\n        totalParties: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sgPartido})`,\n        totalMunicipalities: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.cdMunicipio})`,\n      })\n      .from(tseCandidateVotes)\n      .where(whereClause);\n\n    return {\n      totalVotes: Number(result?.totalVotes ?? 0),\n      totalCandidates: Number(result?.totalCandidates ?? 0),\n      totalParties: Number(result?.totalParties ?? 0),\n      totalMunicipalities: Number(result?.totalMunicipalities ?? 0),\n    };\n  }\n\n  async getVotesByParty(filters: { year?: number; uf?: string; electionType?: string; limit?: number }): Promise<{\n    party: string;\n    partyNumber: number | null;\n    votes: number;\n    candidateCount: number;\n  }[]> {\n    const conditions: any[] = [];\n    if (filters.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters.uf) conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n    if (filters.electionType) conditions.push(eq(tseCandidateVotes.nmTipoEleicao, filters.electionType));\n\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const results = await db\n      .select({\n        party: tseCandidateVotes.sgPartido,\n        partyNumber: tseCandidateVotes.nrPartido,\n        votes: sql<number>`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0)`,\n        candidateCount: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sqCandidato})`,\n      })\n      .from(tseCandidateVotes)\n      .where(whereClause)\n      .groupBy(tseCandidateVotes.sgPartido, tseCandidateVotes.nrPartido)\n      .orderBy(sql`SUM(${tseCandidateVotes.qtVotosNominais}) DESC`)\n      .limit(filters.limit ?? 20);\n\n    return results.map((r) => ({\n      party: r.party || \"N/A\",\n      partyNumber: r.partyNumber,\n      votes: Number(r.votes),\n      candidateCount: Number(r.candidateCount),\n    }));\n  }\n\n  async getTopCandidates(filters: { year?: number; uf?: string; electionType?: string; limit?: number }): Promise<{\n    name: string;\n    nickname: string | null;\n    party: string | null;\n    number: number | null;\n    state: string | null;\n    position: string | null;\n    votes: number;\n  }[]> {\n    const conditions: any[] = [];\n    if (filters.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters.uf) conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n    if (filters.electionType) conditions.push(eq(tseCandidateVotes.nmTipoEleicao, filters.electionType));\n\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const results = await db\n      .select({\n        name: tseCandidateVotes.nmCandidato,\n        nickname: tseCandidateVotes.nmUrnaCandidato,\n        party: tseCandidateVotes.sgPartido,\n        number: tseCandidateVotes.nrCandidato,\n        state: tseCandidateVotes.sgUf,\n        position: tseCandidateVotes.dsCargo,\n        votes: sql<number>`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0)`,\n      })\n      .from(tseCandidateVotes)\n      .where(whereClause)\n      .groupBy(\n        tseCandidateVotes.nmCandidato,\n        tseCandidateVotes.nmUrnaCandidato,\n        tseCandidateVotes.sgPartido,\n        tseCandidateVotes.nrCandidato,\n        tseCandidateVotes.sgUf,\n        tseCandidateVotes.dsCargo\n      )\n      .orderBy(sql`SUM(${tseCandidateVotes.qtVotosNominais}) DESC`)\n      .limit(filters.limit ?? 20);\n\n    return results.map((r) => ({\n      name: r.name || \"N/A\",\n      nickname: r.nickname,\n      party: r.party,\n      number: r.number,\n      state: r.state,\n      position: r.position,\n      votes: Number(r.votes),\n    }));\n  }\n\n  async getVotesByState(filters: { year?: number; electionType?: string }): Promise<{\n    state: string;\n    votes: number;\n    candidateCount: number;\n    partyCount: number;\n  }[]> {\n    const conditions: any[] = [\n      sql`${tseCandidateVotes.sgUf} IS NOT NULL`,\n      sql`${tseCandidateVotes.sgUf} != 'ZZ'` // Exclude exterior votes\n    ];\n    if (filters.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters.electionType) conditions.push(eq(tseCandidateVotes.nmTipoEleicao, filters.electionType));\n\n    const whereClause = and(...conditions);\n\n    const results = await db\n      .select({\n        state: tseCandidateVotes.sgUf,\n        votes: sql<number>`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0)`,\n        candidateCount: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sqCandidato})`,\n        partyCount: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sgPartido})`,\n      })\n      .from(tseCandidateVotes)\n      .where(whereClause)\n      .groupBy(tseCandidateVotes.sgUf)\n      .orderBy(sql`SUM(${tseCandidateVotes.qtVotosNominais}) DESC`);\n\n    return results.map((r) => ({\n      state: r.state || \"N/A\",\n      votes: Number(r.votes),\n      candidateCount: Number(r.candidateCount),\n      partyCount: Number(r.partyCount),\n    }));\n  }\n\n  async getVotesByMunicipality(filters: { year?: number; uf?: string; electionType?: string; position?: string; party?: string; municipality?: string; limit?: number }): Promise<{\n    municipality: string;\n    municipalityCode: number;\n    state: string;\n    votes: number;\n    candidateCount: number;\n    partyCount: number;\n  }[]> {\n    const conditions: SQL[] = [\n      sql`${tseCandidateVotes.sgUf} != 'ZZ'` // Exclude exterior votes\n    ];\n    if (filters.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters.uf) conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n    if (filters.electionType) conditions.push(eq(tseCandidateVotes.nmTipoEleicao, filters.electionType));\n    if (filters.position) conditions.push(eq(tseCandidateVotes.dsCargo, filters.position));\n    if (filters.party) conditions.push(eq(tseCandidateVotes.sgPartido, filters.party));\n    if (filters.municipality) conditions.push(eq(tseCandidateVotes.nmMunicipio, filters.municipality));\n\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const results = await db\n      .select({\n        municipality: tseCandidateVotes.nmMunicipio,\n        municipalityCode: tseCandidateVotes.cdMunicipio,\n        state: tseCandidateVotes.sgUf,\n        votes: sql<number>`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0)::int`,\n        candidateCount: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sqCandidato})::int`,\n        partyCount: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sgPartido})::int`,\n      })\n      .from(tseCandidateVotes)\n      .where(whereClause)\n      .groupBy(tseCandidateVotes.nmMunicipio, tseCandidateVotes.cdMunicipio, tseCandidateVotes.sgUf)\n      .orderBy(sql`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0) DESC`)\n      .limit(filters.limit ?? 50);\n\n    return results.map((r) => ({\n      municipality: r.municipality || \"N/A\",\n      municipalityCode: r.municipalityCode || 0,\n      state: r.state || \"N/A\",\n      votes: r.votes,\n      candidateCount: r.candidateCount,\n      partyCount: r.partyCount,\n    }));\n  }\n\n  async getAvailableElectionYears(): Promise<number[]> {\n    const results = await db\n      .selectDistinct({ year: tseCandidateVotes.anoEleicao })\n      .from(tseCandidateVotes)\n      .where(sql`${tseCandidateVotes.anoEleicao} IS NOT NULL`)\n      .orderBy(sql`${tseCandidateVotes.anoEleicao} DESC`);\n\n    return results.map((r) => r.year!).filter(Boolean);\n  }\n\n  async getAvailableStates(year?: number): Promise<string[]> {\n    const conditions: any[] = [\n      sql`${tseCandidateVotes.sgUf} IS NOT NULL`,\n      sql`${tseCandidateVotes.sgUf} != 'ZZ'` // Exclude exterior votes\n    ];\n    if (year) conditions.push(eq(tseCandidateVotes.anoEleicao, year));\n\n    const results = await db\n      .selectDistinct({ state: tseCandidateVotes.sgUf })\n      .from(tseCandidateVotes)\n      .where(and(...conditions))\n      .orderBy(tseCandidateVotes.sgUf);\n\n    return results.map((r) => r.state!).filter(Boolean);\n  }\n\n  async getAvailableElectionTypes(year?: number): Promise<string[]> {\n    const conditions: any[] = [sql`${tseCandidateVotes.nmTipoEleicao} IS NOT NULL`];\n    if (year) conditions.push(eq(tseCandidateVotes.anoEleicao, year));\n\n    const results = await db\n      .selectDistinct({ type: tseCandidateVotes.nmTipoEleicao })\n      .from(tseCandidateVotes)\n      .where(and(...conditions))\n      .orderBy(tseCandidateVotes.nmTipoEleicao);\n\n    return results.map((r) => r.type!).filter(Boolean);\n  }\n\n  async getAvailablePositions(filters: { year?: number; uf?: string }): Promise<string[]> {\n    const conditions: any[] = [sql`${tseCandidateVotes.dsCargo} IS NOT NULL`];\n    if (filters.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters.uf) conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n\n    const results = await db\n      .selectDistinct({ position: tseCandidateVotes.dsCargo })\n      .from(tseCandidateVotes)\n      .where(and(...conditions))\n      .orderBy(tseCandidateVotes.dsCargo);\n\n    return results.map((r) => r.position!).filter(Boolean);\n  }\n\n  async getAvailableParties(filters: { year?: number; uf?: string }): Promise<{ party: string; number: number }[]> {\n    const conditions: any[] = [sql`${tseCandidateVotes.sgPartido} IS NOT NULL`];\n    if (filters.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters.uf) conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n\n    const results = await db\n      .selectDistinct({ \n        party: tseCandidateVotes.sgPartido,\n        number: tseCandidateVotes.nrPartido\n      })\n      .from(tseCandidateVotes)\n      .where(and(...conditions))\n      .orderBy(tseCandidateVotes.sgPartido);\n\n    return results.filter(r => r.party).map(r => ({ party: r.party!, number: r.number || 0 }));\n  }\n\n  // Drill-down analytics methods\n  async getCandidatesByParty(filters: {\n    year?: number;\n    uf?: string;\n    party: string;\n    position?: string;\n    limit?: number;\n  }): Promise<{\n    name: string;\n    nickname: string | null;\n    number: number | null;\n    votes: number;\n    municipality: string | null;\n    state: string | null;\n    position: string | null;\n    result: string | null;\n  }[]> {\n    const conditions: any[] = [eq(tseCandidateVotes.sgPartido, filters.party)];\n    if (filters.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters.uf) conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n    if (filters.position) conditions.push(eq(tseCandidateVotes.dsCargo, filters.position));\n\n    const results = await db\n      .select({\n        name: tseCandidateVotes.nmCandidato,\n        nickname: tseCandidateVotes.nmUrnaCandidato,\n        number: tseCandidateVotes.nrCandidato,\n        votes: sql<number>`COALESCE(${tseCandidateVotes.qtVotosNominais}, 0)`,\n        municipality: tseCandidateVotes.nmMunicipio,\n        state: tseCandidateVotes.sgUf,\n        position: tseCandidateVotes.dsCargo,\n        result: tseCandidateVotes.dsSitTotTurno,\n      })\n      .from(tseCandidateVotes)\n      .where(and(...conditions))\n      .orderBy(sql`COALESCE(${tseCandidateVotes.qtVotosNominais}, 0) DESC`)\n      .limit(filters.limit ?? 100);\n\n    return results.map(r => ({\n      name: r.name || \"N/A\",\n      nickname: r.nickname,\n      number: r.number,\n      votes: Number(r.votes),\n      municipality: r.municipality,\n      state: r.state,\n      position: r.position,\n      result: r.result,\n    }));\n  }\n\n  async getPartyPerformanceByState(filters: {\n    year?: number;\n    party?: string;\n    position?: string;\n  }): Promise<{\n    state: string;\n    party: string;\n    votes: number;\n    candidateCount: number;\n    percentage: number;\n  }[]> {\n    const conditions: any[] = [\n      sql`${tseCandidateVotes.sgUf} IS NOT NULL`,\n      sql`${tseCandidateVotes.sgPartido} IS NOT NULL`,\n    ];\n    if (filters.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters.party) conditions.push(eq(tseCandidateVotes.sgPartido, filters.party));\n    if (filters.position) conditions.push(eq(tseCandidateVotes.dsCargo, filters.position));\n\n    const results = await db\n      .select({\n        state: tseCandidateVotes.sgUf,\n        party: tseCandidateVotes.sgPartido,\n        votes: sql<number>`SUM(COALESCE(${tseCandidateVotes.qtVotosNominais}, 0))`,\n        candidateCount: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sqCandidato})`,\n      })\n      .from(tseCandidateVotes)\n      .where(and(...conditions))\n      .groupBy(tseCandidateVotes.sgUf, tseCandidateVotes.sgPartido)\n      .orderBy(sql`SUM(COALESCE(${tseCandidateVotes.qtVotosNominais}, 0)) DESC`);\n\n    const totalByState: Record<string, number> = {};\n    results.forEach(r => {\n      if (r.state) {\n        totalByState[r.state] = (totalByState[r.state] || 0) + Number(r.votes);\n      }\n    });\n\n    return results.filter(r => r.state && r.party).map(r => ({\n      state: r.state!,\n      party: r.party!,\n      votes: Number(r.votes),\n      candidateCount: Number(r.candidateCount),\n      percentage: totalByState[r.state!] > 0 \n        ? (Number(r.votes) / totalByState[r.state!]) * 100 \n        : 0,\n    }));\n  }\n\n  async getVotesByPosition(filters: {\n    year?: number;\n    uf?: string;\n  }): Promise<{\n    position: string;\n    votes: number;\n    candidateCount: number;\n    partyCount: number;\n  }[]> {\n    const conditions: any[] = [sql`${tseCandidateVotes.dsCargo} IS NOT NULL`];\n    if (filters.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters.uf) conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n\n    const results = await db\n      .select({\n        position: tseCandidateVotes.dsCargo,\n        votes: sql<number>`SUM(COALESCE(${tseCandidateVotes.qtVotosNominais}, 0))`,\n        candidateCount: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sqCandidato})`,\n        partyCount: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sgPartido})`,\n      })\n      .from(tseCandidateVotes)\n      .where(and(...conditions))\n      .groupBy(tseCandidateVotes.dsCargo)\n      .orderBy(sql`SUM(COALESCE(${tseCandidateVotes.qtVotosNominais}, 0)) DESC`);\n\n    return results.filter(r => r.position).map(r => ({\n      position: r.position!,\n      votes: Number(r.votes),\n      candidateCount: Number(r.candidateCount),\n      partyCount: Number(r.partyCount),\n    }));\n  }\n\n  async getAdvancedAnalytics(filters: {\n    year?: number;\n    uf?: string;\n    electionType?: string;\n    position?: string;\n    party?: string;\n    minVotes?: number;\n    maxVotes?: number;\n    limit?: number;\n  }): Promise<{\n    candidates: {\n      name: string;\n      nickname: string | null;\n      party: string | null;\n      number: number | null;\n      state: string | null;\n      position: string | null;\n      municipality: string | null;\n      votes: number;\n    }[];\n    summary: {\n      totalVotes: number;\n      candidateCount: number;\n      avgVotes: number;\n    };\n  }> {\n    const conditions: any[] = [];\n    if (filters.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters.uf) conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n    if (filters.electionType) conditions.push(eq(tseCandidateVotes.nmTipoEleicao, filters.electionType));\n    if (filters.position) conditions.push(eq(tseCandidateVotes.dsCargo, filters.position));\n    if (filters.party) conditions.push(eq(tseCandidateVotes.sgPartido, filters.party));\n\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    const candidateResults = await db\n      .select({\n        name: tseCandidateVotes.nmCandidato,\n        nickname: tseCandidateVotes.nmUrnaCandidato,\n        party: tseCandidateVotes.sgPartido,\n        number: tseCandidateVotes.nrCandidato,\n        state: tseCandidateVotes.sgUf,\n        position: tseCandidateVotes.dsCargo,\n        municipality: tseCandidateVotes.nmMunicipio,\n        votes: sql<number>`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0)`,\n      })\n      .from(tseCandidateVotes)\n      .where(whereClause)\n      .groupBy(\n        tseCandidateVotes.nmCandidato,\n        tseCandidateVotes.nmUrnaCandidato,\n        tseCandidateVotes.sgPartido,\n        tseCandidateVotes.nrCandidato,\n        tseCandidateVotes.sgUf,\n        tseCandidateVotes.dsCargo,\n        tseCandidateVotes.nmMunicipio\n      )\n      .orderBy(sql`SUM(${tseCandidateVotes.qtVotosNominais}) DESC`)\n      .limit(filters.limit ?? 100);\n\n    let candidates = candidateResults.map((r) => ({\n      name: r.name || \"N/A\",\n      nickname: r.nickname,\n      party: r.party,\n      number: r.number,\n      state: r.state,\n      position: r.position,\n      municipality: r.municipality,\n      votes: Number(r.votes),\n    }));\n\n    if (filters.minVotes !== undefined) {\n      candidates = candidates.filter(c => c.votes >= filters.minVotes!);\n    }\n    if (filters.maxVotes !== undefined) {\n      candidates = candidates.filter(c => c.votes <= filters.maxVotes!);\n    }\n\n    const totalVotes = candidates.reduce((sum, c) => sum + c.votes, 0);\n    const candidateCount = candidates.length;\n    const avgVotes = candidateCount > 0 ? Math.round(totalVotes / candidateCount) : 0;\n\n    return {\n      candidates,\n      summary: { totalVotes, candidateCount, avgVotes },\n    };\n  }\n\n  async getComparisonData(params: {\n    years?: number[];\n    states?: string[];\n    groupBy: \"party\" | \"state\" | \"position\";\n  }): Promise<{\n    label: string;\n    data: { key: string; votes: number; candidateCount: number }[];\n  }[]> {\n    const results: { label: string; data: { key: string; votes: number; candidateCount: number }[] }[] = [];\n\n    if (params.years && params.years.length > 0) {\n      for (const year of params.years) {\n        let groupByField;\n        if (params.groupBy === \"party\") groupByField = tseCandidateVotes.sgPartido;\n        else if (params.groupBy === \"state\") groupByField = tseCandidateVotes.sgUf;\n        else groupByField = tseCandidateVotes.dsCargo;\n\n        const yearData = await db\n          .select({\n            key: groupByField,\n            votes: sql<number>`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0)`,\n            candidateCount: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sqCandidato})`,\n          })\n          .from(tseCandidateVotes)\n          .where(eq(tseCandidateVotes.anoEleicao, year))\n          .groupBy(groupByField)\n          .orderBy(sql`SUM(${tseCandidateVotes.qtVotosNominais}) DESC`)\n          .limit(10);\n\n        results.push({\n          label: String(year),\n          data: yearData.map(d => ({\n            key: d.key || \"N/A\",\n            votes: Number(d.votes),\n            candidateCount: Number(d.candidateCount),\n          })),\n        });\n      }\n    }\n\n    if (params.states && params.states.length > 0) {\n      for (const state of params.states) {\n        let groupByField;\n        if (params.groupBy === \"party\") groupByField = tseCandidateVotes.sgPartido;\n        else if (params.groupBy === \"position\") groupByField = tseCandidateVotes.dsCargo;\n        else groupByField = tseCandidateVotes.anoEleicao;\n\n        const stateData = await db\n          .select({\n            key: groupByField,\n            votes: sql<number>`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0)`,\n            candidateCount: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.sqCandidato})`,\n          })\n          .from(tseCandidateVotes)\n          .where(eq(tseCandidateVotes.sgUf, state))\n          .groupBy(groupByField)\n          .orderBy(sql`SUM(${tseCandidateVotes.qtVotosNominais}) DESC`)\n          .limit(10);\n\n        results.push({\n          label: state,\n          data: stateData.map(d => ({\n            key: String(d.key) || \"N/A\",\n            votes: Number(d.votes),\n            candidateCount: Number(d.candidateCount),\n          })),\n        });\n      }\n    }\n\n    return results;\n  }\n\n  // Saved Reports CRUD\n  async getSavedReports(userId?: string): Promise<SavedReport[]> {\n    if (userId) {\n      return db.select().from(savedReports).where(eq(savedReports.createdBy, userId)).orderBy(sql`${savedReports.updatedAt} DESC`);\n    }\n    return db.select().from(savedReports).orderBy(sql`${savedReports.updatedAt} DESC`);\n  }\n\n  async getSavedReportById(id: number): Promise<SavedReport | undefined> {\n    const [report] = await db.select().from(savedReports).where(eq(savedReports.id, id));\n    return report;\n  }\n\n  async createSavedReport(data: InsertSavedReport): Promise<SavedReport> {\n    const [created] = await db.insert(savedReports).values(data).returning();\n    return created;\n  }\n\n  async updateSavedReport(id: number, data: Partial<InsertSavedReport>): Promise<SavedReport | undefined> {\n    const [updated] = await db\n      .update(savedReports)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(savedReports.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteSavedReport(id: number): Promise<boolean> {\n    const result = await db.delete(savedReports).where(eq(savedReports.id, id));\n    return (result.rowCount ?? 0) > 0;\n  }\n\n  // AI Prediction caching methods\n  async getAiPrediction(cacheKey: string): Promise<AiPrediction | undefined> {\n    const [prediction] = await db\n      .select()\n      .from(aiPredictions)\n      .where(eq(aiPredictions.cacheKey, cacheKey));\n    return prediction;\n  }\n\n  async saveAiPrediction(data: { cacheKey: string; predictionType: string; prediction: unknown; expiresAt: Date }): Promise<AiPrediction> {\n    // Delete existing prediction with same cache key\n    await db.delete(aiPredictions).where(eq(aiPredictions.cacheKey, data.cacheKey));\n    \n    const [created] = await db\n      .insert(aiPredictions)\n      .values({\n        cacheKey: data.cacheKey,\n        predictionType: data.predictionType,\n        prediction: data.prediction,\n        validUntil: data.expiresAt,\n      })\n      .returning();\n    return created;\n  }\n\n  async deleteExpiredAiPredictions(): Promise<number> {\n    const result = await db\n      .delete(aiPredictions)\n      .where(sql`${aiPredictions.validUntil} < NOW()`);\n    return result.rowCount ?? 0;\n  }\n\n  // Projection Reports CRUD\n  async getProjectionReports(filters?: { status?: string; targetYear?: number; scope?: string }): Promise<ProjectionReportRecord[]> {\n    let query = db.select().from(projectionReports);\n    \n    const conditions: SQL[] = [];\n    if (filters?.status) {\n      conditions.push(eq(projectionReports.status, filters.status));\n    }\n    if (filters?.targetYear) {\n      conditions.push(eq(projectionReports.targetYear, filters.targetYear));\n    }\n    if (filters?.scope) {\n      conditions.push(eq(projectionReports.scope, filters.scope));\n    }\n    \n    if (conditions.length > 0) {\n      query = query.where(and(...conditions)) as any;\n    }\n    \n    return query.orderBy(desc(projectionReports.createdAt));\n  }\n\n  async getProjectionReportById(id: number): Promise<ProjectionReportRecord | undefined> {\n    const [report] = await db\n      .select()\n      .from(projectionReports)\n      .where(eq(projectionReports.id, id));\n    return report;\n  }\n\n  async createProjectionReport(data: InsertProjectionReport): Promise<ProjectionReportRecord> {\n    const [report] = await db\n      .insert(projectionReports)\n      .values(data)\n      .returning();\n    return report;\n  }\n\n  async updateProjectionReport(id: number, data: Partial<InsertProjectionReport>): Promise<ProjectionReportRecord | undefined> {\n    const [updated] = await db\n      .update(projectionReports)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(projectionReports.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteProjectionReport(id: number): Promise<boolean> {\n    const result = await db\n      .delete(projectionReports)\n      .where(eq(projectionReports.id, id));\n    return (result.rowCount ?? 0) > 0;\n  }\n\n  // Validation Run methods\n  async createValidationRun(data: InsertValidationRun): Promise<ValidationRunRecord> {\n    const [run] = await db.insert(importValidationRuns).values(data).returning();\n    return run;\n  }\n\n  async getValidationRun(id: number): Promise<ValidationRunRecord | undefined> {\n    const [run] = await db\n      .select()\n      .from(importValidationRuns)\n      .where(eq(importValidationRuns.id, id));\n    return run;\n  }\n\n  async getValidationRunByJobId(jobId: number): Promise<ValidationRunRecord | undefined> {\n    const [run] = await db\n      .select()\n      .from(importValidationRuns)\n      .where(eq(importValidationRuns.jobId, jobId))\n      .orderBy(desc(importValidationRuns.createdAt))\n      .limit(1);\n    return run;\n  }\n\n  async getValidationRunsForJob(jobId: number): Promise<ValidationRunRecord[]> {\n    return db\n      .select()\n      .from(importValidationRuns)\n      .where(eq(importValidationRuns.jobId, jobId))\n      .orderBy(desc(importValidationRuns.createdAt));\n  }\n\n  async updateValidationRun(id: number, data: Partial<InsertValidationRun>): Promise<ValidationRunRecord | undefined> {\n    const [updated] = await db\n      .update(importValidationRuns)\n      .set(data)\n      .where(eq(importValidationRuns.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Validation Issue methods\n  async createValidationIssue(data: InsertValidationIssue): Promise<ValidationIssueRecord> {\n    const [issue] = await db.insert(importValidationIssues).values(data).returning();\n    return issue;\n  }\n\n  async createValidationIssues(data: InsertValidationIssue[]): Promise<ValidationIssueRecord[]> {\n    if (data.length === 0) return [];\n    return db.insert(importValidationIssues).values(data).returning();\n  }\n\n  async getValidationIssuesForRun(\n    runId: number, \n    filters?: { type?: string; severity?: string; status?: string }\n  ): Promise<ValidationIssueRecord[]> {\n    const conditions: SQL[] = [eq(importValidationIssues.runId, runId)];\n    \n    if (filters?.type) {\n      conditions.push(eq(importValidationIssues.type, filters.type));\n    }\n    if (filters?.severity) {\n      conditions.push(eq(importValidationIssues.severity, filters.severity));\n    }\n    if (filters?.status) {\n      conditions.push(eq(importValidationIssues.status, filters.status));\n    }\n    \n    return db\n      .select()\n      .from(importValidationIssues)\n      .where(and(...conditions))\n      .orderBy(desc(importValidationIssues.createdAt));\n  }\n\n  async getValidationIssue(id: number): Promise<ValidationIssueRecord | undefined> {\n    const [issue] = await db\n      .select()\n      .from(importValidationIssues)\n      .where(eq(importValidationIssues.id, id));\n    return issue;\n  }\n\n  async updateValidationIssue(id: number, data: Partial<InsertValidationIssue>): Promise<ValidationIssueRecord | undefined> {\n    const [updated] = await db\n      .update(importValidationIssues)\n      .set(data)\n      .where(eq(importValidationIssues.id, id))\n      .returning();\n    return updated;\n  }\n\n  async getValidationIssueCounts(runId: number): Promise<{ type: string; severity: string; count: number }[]> {\n    const result = await db\n      .select({\n        type: importValidationIssues.type,\n        severity: importValidationIssues.severity,\n        count: sql<number>`count(*)::int`,\n      })\n      .from(importValidationIssues)\n      .where(eq(importValidationIssues.runId, runId))\n      .groupBy(importValidationIssues.type, importValidationIssues.severity);\n    return result;\n  }\n\n  // Forecast methods\n  async createForecastRun(data: InsertForecastRun): Promise<ForecastRun> {\n    const [run] = await db.insert(forecastRuns).values(data).returning();\n    return run;\n  }\n\n  async getForecastRun(id: number): Promise<ForecastRun | undefined> {\n    const [run] = await db.select().from(forecastRuns).where(eq(forecastRuns.id, id));\n    return run;\n  }\n\n  async getForecastRuns(filters?: { targetYear?: number; status?: string }): Promise<ForecastRun[]> {\n    const conditions: SQL[] = [];\n    \n    if (filters?.targetYear) {\n      conditions.push(eq(forecastRuns.targetYear, filters.targetYear));\n    }\n    if (filters?.status) {\n      conditions.push(eq(forecastRuns.status, filters.status));\n    }\n    \n    const query = conditions.length > 0\n      ? db.select().from(forecastRuns).where(and(...conditions))\n      : db.select().from(forecastRuns);\n    \n    return query.orderBy(desc(forecastRuns.createdAt));\n  }\n\n  async updateForecastRun(id: number, data: Partial<InsertForecastRun>): Promise<ForecastRun | undefined> {\n    const [updated] = await db\n      .update(forecastRuns)\n      .set(data)\n      .where(eq(forecastRuns.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteForecastRun(id: number): Promise<boolean> {\n    const result = await db.delete(forecastRuns).where(eq(forecastRuns.id, id));\n    return (result.rowCount ?? 0) > 0;\n  }\n\n  async createForecastResult(data: InsertForecastResult): Promise<ForecastResult> {\n    const [result] = await db.insert(forecastResults).values(data).returning();\n    return result;\n  }\n\n  async createForecastResults(data: InsertForecastResult[]): Promise<ForecastResult[]> {\n    if (data.length === 0) return [];\n    return db.insert(forecastResults).values(data).returning();\n  }\n\n  async getForecastResults(runId: number, filters?: { resultType?: string; region?: string }): Promise<ForecastResult[]> {\n    const conditions: SQL[] = [eq(forecastResults.runId, runId)];\n    \n    if (filters?.resultType) {\n      conditions.push(eq(forecastResults.resultType, filters.resultType));\n    }\n    if (filters?.region) {\n      conditions.push(eq(forecastResults.region, filters.region));\n    }\n    \n    return db\n      .select()\n      .from(forecastResults)\n      .where(and(...conditions))\n      .orderBy(desc(forecastResults.predictedVoteShare));\n  }\n\n  async createSwingRegion(data: InsertSwingRegion): Promise<SwingRegion> {\n    const [region] = await db.insert(forecastSwingRegions).values(data).returning();\n    return region;\n  }\n\n  async createSwingRegions(data: InsertSwingRegion[]): Promise<SwingRegion[]> {\n    if (data.length === 0) return [];\n    return db.insert(forecastSwingRegions).values(data).returning();\n  }\n\n  async getSwingRegions(runId: number): Promise<SwingRegion[]> {\n    return db\n      .select()\n      .from(forecastSwingRegions)\n      .where(eq(forecastSwingRegions.runId, runId))\n      .orderBy(desc(forecastSwingRegions.volatilityScore));\n  }\n\n  async getHistoricalVotesByParty(filters: { years: number[]; position?: string; state?: string }): Promise<{\n    year: number;\n    party: string;\n    state: string | null;\n    position: string | null;\n    totalVotes: number;\n    candidateCount: number;\n  }[]> {\n    const conditions: SQL[] = [];\n    \n    if (filters.years.length > 0) {\n      conditions.push(sql`${tseCandidateVotes.anoEleicao} = ANY(${filters.years})`);\n    }\n    if (filters.position) {\n      conditions.push(eq(tseCandidateVotes.dsCargo, filters.position));\n    }\n    if (filters.state) {\n      conditions.push(eq(tseCandidateVotes.sgUf, filters.state));\n    }\n    \n    const result = await db\n      .select({\n        year: tseCandidateVotes.anoEleicao,\n        party: tseCandidateVotes.sgPartido,\n        state: tseCandidateVotes.sgUf,\n        position: tseCandidateVotes.dsCargo,\n        totalVotes: sql<number>`SUM(${tseCandidateVotes.qtVotosNominais})::int`,\n        candidateCount: sql<number>`COUNT(DISTINCT ${tseCandidateVotes.nrCandidato})::int`,\n      })\n      .from(tseCandidateVotes)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .groupBy(\n        tseCandidateVotes.anoEleicao, \n        tseCandidateVotes.sgPartido, \n        tseCandidateVotes.sgUf, \n        tseCandidateVotes.dsCargo\n      )\n      .orderBy(tseCandidateVotes.anoEleicao, desc(sql`SUM(${tseCandidateVotes.qtVotosNominais})`));\n    \n    return result.map(r => ({\n      year: r.year || 0,\n      party: r.party || \"\",\n      state: r.state,\n      position: r.position,\n      totalVotes: r.totalVotes,\n      candidateCount: r.candidateCount,\n    }));\n  }\n\n  async getHistoricalTrends(filters: { party?: string; position?: string; state?: string }): Promise<{\n    year: number;\n    party: string;\n    voteShare: number;\n    seats?: number;\n  }[]> {\n    const conditions: SQL[] = [];\n    \n    if (filters.party) {\n      conditions.push(eq(tseCandidateVotes.sgPartido, filters.party));\n    }\n    if (filters.position) {\n      conditions.push(eq(tseCandidateVotes.dsCargo, filters.position));\n    }\n    if (filters.state) {\n      conditions.push(eq(tseCandidateVotes.sgUf, filters.state));\n    }\n    \n    const voteTotals = await db\n      .select({\n        year: tseCandidateVotes.anoEleicao,\n        party: tseCandidateVotes.sgPartido,\n        votes: sql<number>`SUM(${tseCandidateVotes.qtVotosNominais})::int`,\n        totalVotesInYear: sql<number>`SUM(SUM(${tseCandidateVotes.qtVotosNominais})) OVER (PARTITION BY ${tseCandidateVotes.anoEleicao})::int`,\n      })\n      .from(tseCandidateVotes)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .groupBy(tseCandidateVotes.anoEleicao, tseCandidateVotes.sgPartido)\n      .orderBy(tseCandidateVotes.anoEleicao);\n    \n    return voteTotals.map(r => ({\n      year: r.year || 0,\n      party: r.party || \"\",\n      voteShare: r.totalVotesInYear > 0 ? (r.votes / r.totalVotesInYear) * 100 : 0,\n    }));\n  }\n\n  // Prediction Scenario methods\n  async getPredictionScenarios(filters?: { status?: string; targetYear?: number }): Promise<PredictionScenario[]> {\n    const conditions: SQL[] = [];\n    if (filters?.status) {\n      conditions.push(eq(predictionScenarios.status, filters.status));\n    }\n    if (filters?.targetYear) {\n      conditions.push(eq(predictionScenarios.targetYear, filters.targetYear));\n    }\n    return db.select()\n      .from(predictionScenarios)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(predictionScenarios.createdAt));\n  }\n\n  async getPredictionScenario(id: number): Promise<PredictionScenario | undefined> {\n    const [scenario] = await db.select().from(predictionScenarios).where(eq(predictionScenarios.id, id));\n    return scenario;\n  }\n\n  async createPredictionScenario(data: InsertPredictionScenario): Promise<PredictionScenario> {\n    const [created] = await db.insert(predictionScenarios).values(data).returning();\n    return created;\n  }\n\n  async updatePredictionScenario(id: number, data: Partial<InsertPredictionScenario>): Promise<PredictionScenario | undefined> {\n    const [updated] = await db.update(predictionScenarios)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(predictionScenarios.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deletePredictionScenario(id: number): Promise<boolean> {\n    await db.delete(predictionScenarios).where(eq(predictionScenarios.id, id));\n    return true;\n  }\n\n  // Report Template methods\n  async getReportTemplates(): Promise<ReportTemplate[]> {\n    return db.select().from(reportTemplates).orderBy(desc(reportTemplates.createdAt));\n  }\n\n  async getReportTemplate(id: number): Promise<ReportTemplate | undefined> {\n    const [template] = await db.select().from(reportTemplates).where(eq(reportTemplates.id, id));\n    return template;\n  }\n\n  async createReportTemplate(data: InsertReportTemplate): Promise<ReportTemplate> {\n    const [created] = await db.insert(reportTemplates).values(data).returning();\n    return created;\n  }\n\n  async updateReportTemplate(id: number, data: Partial<InsertReportTemplate>): Promise<ReportTemplate | undefined> {\n    const [updated] = await db.update(reportTemplates)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(reportTemplates.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteReportTemplate(id: number): Promise<boolean> {\n    await db.delete(reportTemplates).where(eq(reportTemplates.id, id));\n    return true;\n  }\n\n  // Report Schedule methods\n  async getReportSchedules(): Promise<ReportSchedule[]> {\n    return db.select().from(reportSchedules).orderBy(desc(reportSchedules.createdAt));\n  }\n\n  async getReportSchedule(id: number): Promise<ReportSchedule | undefined> {\n    const [schedule] = await db.select().from(reportSchedules).where(eq(reportSchedules.id, id));\n    return schedule;\n  }\n\n  async getDueSchedules(): Promise<ReportSchedule[]> {\n    const now = new Date();\n    return db.select().from(reportSchedules)\n      .where(and(\n        eq(reportSchedules.isActive, true),\n        sql`${reportSchedules.nextRunAt} <= ${now}`\n      ));\n  }\n\n  async createReportSchedule(data: InsertReportSchedule): Promise<ReportSchedule> {\n    const [created] = await db.insert(reportSchedules).values(data).returning();\n    return created;\n  }\n\n  async updateReportSchedule(id: number, data: Partial<InsertReportSchedule>): Promise<ReportSchedule | undefined> {\n    const [updated] = await db.update(reportSchedules)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(reportSchedules.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteReportSchedule(id: number): Promise<boolean> {\n    await db.delete(reportSchedules).where(eq(reportSchedules.id, id));\n    return true;\n  }\n\n  // Report Run methods\n  async getReportRuns(filters?: { scheduleId?: number; templateId?: number; status?: string; limit?: number }): Promise<ReportRun[]> {\n    const conditions: SQL[] = [];\n    if (filters?.scheduleId) {\n      conditions.push(eq(reportRuns.scheduleId, filters.scheduleId));\n    }\n    if (filters?.templateId) {\n      conditions.push(eq(reportRuns.templateId, filters.templateId));\n    }\n    if (filters?.status) {\n      conditions.push(eq(reportRuns.status, filters.status));\n    }\n    \n    let query = db.select().from(reportRuns)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(reportRuns.createdAt));\n    \n    if (filters?.limit) {\n      query = query.limit(filters.limit) as any;\n    }\n    \n    return query;\n  }\n\n  async getReportRun(id: number): Promise<ReportRun | undefined> {\n    const [run] = await db.select().from(reportRuns).where(eq(reportRuns.id, id));\n    return run;\n  }\n\n  async createReportRun(data: InsertReportRun): Promise<ReportRun> {\n    const [created] = await db.insert(reportRuns).values(data).returning();\n    return created;\n  }\n\n  async updateReportRun(id: number, data: Partial<InsertReportRun>): Promise<ReportRun | undefined> {\n    const [updated] = await db.update(reportRuns)\n      .set(data)\n      .where(eq(reportRuns.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Report Recipients methods\n  async getReportRecipients(): Promise<ReportRecipient[]> {\n    return db.select().from(reportRecipients).orderBy(reportRecipients.name);\n  }\n\n  async getReportRecipient(id: number): Promise<ReportRecipient | undefined> {\n    const [recipient] = await db.select().from(reportRecipients).where(eq(reportRecipients.id, id));\n    return recipient;\n  }\n\n  async createReportRecipient(data: InsertReportRecipient): Promise<ReportRecipient> {\n    const [created] = await db.insert(reportRecipients).values(data).returning();\n    return created;\n  }\n\n  async updateReportRecipient(id: number, data: Partial<InsertReportRecipient>): Promise<ReportRecipient | undefined> {\n    const [updated] = await db.update(reportRecipients)\n      .set(data)\n      .where(eq(reportRecipients.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteReportRecipient(id: number): Promise<boolean> {\n    await db.delete(reportRecipients).where(eq(reportRecipients.id, id));\n    return true;\n  }\n\n  // Import Batch methods\n  async createImportBatch(data: InsertTseImportBatch): Promise<TseImportBatch> {\n    const [batch] = await db.insert(tseImportBatches).values(data).returning();\n    return batch;\n  }\n\n  async getImportBatches(jobId: number): Promise<TseImportBatch[]> {\n    return db.select().from(tseImportBatches)\n      .where(eq(tseImportBatches.importJobId, jobId))\n      .orderBy(tseImportBatches.batchIndex);\n  }\n\n  async getImportBatch(batchId: number): Promise<TseImportBatch | undefined> {\n    const [batch] = await db.select().from(tseImportBatches)\n      .where(eq(tseImportBatches.id, batchId));\n    return batch;\n  }\n\n  async updateImportBatch(batchId: number, data: Partial<InsertTseImportBatch>): Promise<TseImportBatch | undefined> {\n    const [updated] = await db.update(tseImportBatches)\n      .set(data)\n      .where(eq(tseImportBatches.id, batchId))\n      .returning();\n    return updated;\n  }\n\n  async getFailedBatches(jobId: number): Promise<TseImportBatch[]> {\n    return db.select().from(tseImportBatches)\n      .where(and(\n        eq(tseImportBatches.importJobId, jobId),\n        eq(tseImportBatches.status, \"failed\")\n      ))\n      .orderBy(tseImportBatches.batchIndex);\n  }\n\n  async getBatchStats(jobId: number): Promise<{\n    total: number;\n    completed: number;\n    failed: number;\n    pending: number;\n    processing: number;\n    totalRows: number;\n    processedRows: number;\n    errorCount: number;\n  }> {\n    const batches = await this.getImportBatches(jobId);\n    return {\n      total: batches.length,\n      completed: batches.filter(b => b.status === \"completed\").length,\n      failed: batches.filter(b => b.status === \"failed\").length,\n      pending: batches.filter(b => b.status === \"pending\").length,\n      processing: batches.filter(b => b.status === \"processing\").length,\n      totalRows: batches.reduce((sum, b) => sum + (b.totalRows || 0), 0),\n      processedRows: batches.reduce((sum, b) => sum + (b.processedRows || 0), 0),\n      errorCount: batches.reduce((sum, b) => sum + (b.errorCount || 0), 0),\n    };\n  }\n\n  // Import Batch Row methods\n  async createBatchRows(rows: InsertTseImportBatchRow[]): Promise<TseImportBatchRow[]> {\n    if (rows.length === 0) return [];\n    return db.insert(tseImportBatchRows).values(rows).returning();\n  }\n\n  async getBatchRows(batchId: number, status?: string): Promise<TseImportBatchRow[]> {\n    const conditions = [eq(tseImportBatchRows.batchId, batchId)];\n    if (status) {\n      conditions.push(eq(tseImportBatchRows.status, status));\n    }\n    return db.select().from(tseImportBatchRows)\n      .where(and(...conditions))\n      .orderBy(tseImportBatchRows.rowNumber);\n  }\n\n  async getFailedBatchRows(batchId: number): Promise<TseImportBatchRow[]> {\n    return this.getBatchRows(batchId, \"failed\");\n  }\n\n  async updateBatchRow(rowId: number, data: Partial<InsertTseImportBatchRow>): Promise<TseImportBatchRow | undefined> {\n    const [updated] = await db.update(tseImportBatchRows)\n      .set({ ...data, processedAt: new Date() })\n      .where(eq(tseImportBatchRows.id, rowId))\n      .returning();\n    return updated;\n  }\n\n  async resetBatchRowsForReprocess(batchId: number): Promise<number> {\n    const result = await db.update(tseImportBatchRows)\n      .set({ status: \"pending\", errorType: null, errorMessage: null, processedAt: null })\n      .where(and(\n        eq(tseImportBatchRows.batchId, batchId),\n        eq(tseImportBatchRows.status, \"failed\")\n      ));\n    return (result as any).rowCount || 0;\n  }\n\n  async deleteBatchesByJob(jobId: number): Promise<void> {\n    await db.delete(tseImportBatches).where(eq(tseImportBatches.importJobId, jobId));\n  }\n\n  // Custom Dashboard methods\n  async getCustomDashboards(userId?: string): Promise<CustomDashboard[]> {\n    if (userId) {\n      return db.select().from(customDashboards)\n        .where(eq(customDashboards.userId, userId))\n        .orderBy(desc(customDashboards.updatedAt));\n    }\n    return db.select().from(customDashboards).orderBy(desc(customDashboards.updatedAt));\n  }\n\n  async getCustomDashboard(id: number): Promise<CustomDashboard | undefined> {\n    const [dashboard] = await db.select().from(customDashboards).where(eq(customDashboards.id, id));\n    return dashboard;\n  }\n\n  async createCustomDashboard(data: InsertCustomDashboard): Promise<CustomDashboard> {\n    const [dashboard] = await db.insert(customDashboards).values(data).returning();\n    return dashboard;\n  }\n\n  async updateCustomDashboard(id: number, data: Partial<InsertCustomDashboard>): Promise<CustomDashboard | undefined> {\n    const [updated] = await db.update(customDashboards)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(customDashboards.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCustomDashboard(id: number): Promise<boolean> {\n    const result = await db.delete(customDashboards).where(eq(customDashboards.id, id));\n    return (result as any).rowCount > 0;\n  }\n\n  async getPublicDashboards(): Promise<CustomDashboard[]> {\n    return db.select().from(customDashboards)\n      .where(eq(customDashboards.isPublic, true))\n      .orderBy(desc(customDashboards.updatedAt));\n  }\n\n  // AI Suggestions methods\n  async getAiSuggestions(userId?: string, filters?: { type?: string; dismissed?: boolean }): Promise<AiSuggestion[]> {\n    const conditions: SQL[] = [];\n    if (userId) conditions.push(eq(aiSuggestions.userId, userId));\n    if (filters?.type) conditions.push(eq(aiSuggestions.suggestionType, filters.type));\n    if (filters?.dismissed !== undefined) conditions.push(eq(aiSuggestions.dismissed, filters.dismissed));\n    \n    return db.select().from(aiSuggestions)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(aiSuggestions.createdAt));\n  }\n\n  async getAiSuggestion(id: number): Promise<AiSuggestion | undefined> {\n    const [suggestion] = await db.select().from(aiSuggestions).where(eq(aiSuggestions.id, id));\n    return suggestion;\n  }\n\n  async createAiSuggestion(data: InsertAiSuggestion): Promise<AiSuggestion> {\n    const [suggestion] = await db.insert(aiSuggestions).values(data).returning();\n    return suggestion;\n  }\n\n  async updateAiSuggestion(id: number, data: Partial<InsertAiSuggestion>): Promise<AiSuggestion | undefined> {\n    const [updated] = await db.update(aiSuggestions)\n      .set(data)\n      .where(eq(aiSuggestions.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteAiSuggestion(id: number): Promise<boolean> {\n    const result = await db.delete(aiSuggestions).where(eq(aiSuggestions.id, id));\n    return (result as any).rowCount > 0;\n  }\n\n  async dismissAiSuggestion(id: number): Promise<boolean> {\n    const [updated] = await db.update(aiSuggestions)\n      .set({ dismissed: true })\n      .where(eq(aiSuggestions.id, id))\n      .returning();\n    return !!updated;\n  }\n\n  async applyAiSuggestion(id: number): Promise<boolean> {\n    const [updated] = await db.update(aiSuggestions)\n      .set({ applied: true })\n      .where(eq(aiSuggestions.id, id))\n      .returning();\n    return !!updated;\n  }\n\n  // Advanced segmentation methods\n  async getMunicipalities(filters?: { uf?: string; year?: number }): Promise<{ code: number; name: string; uf: string }[]> {\n    const conditions: SQL[] = [];\n    if (filters?.uf) conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n    if (filters?.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n\n    const result = await db.selectDistinct({\n      code: tseCandidateVotes.cdMunicipio,\n      name: tseCandidateVotes.nmMunicipio,\n      uf: tseCandidateVotes.sgUf,\n    }).from(tseCandidateVotes)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(tseCandidateVotes.nmMunicipio);\n\n    return result.map(r => ({\n      code: r.code || 0,\n      name: r.name || \"N/A\",\n      uf: r.uf || \"N/A\",\n    }));\n  }\n\n\n  async getPositions(filters?: { year?: number; uf?: string }): Promise<{ code: number; name: string; votes: number }[]> {\n    const conditions: SQL[] = [];\n    if (filters?.year) conditions.push(eq(tseCandidateVotes.anoEleicao, filters.year));\n    if (filters?.uf) conditions.push(eq(tseCandidateVotes.sgUf, filters.uf));\n\n    const result = await db.select({\n      code: tseCandidateVotes.cdCargo,\n      name: tseCandidateVotes.dsCargo,\n      votes: sql<number>`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0)::int`,\n    }).from(tseCandidateVotes)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .groupBy(tseCandidateVotes.cdCargo, tseCandidateVotes.dsCargo)\n      .orderBy(sql`COALESCE(SUM(${tseCandidateVotes.qtVotosNominais}), 0) DESC`);\n\n    return result.map(r => ({\n      code: r.code || 0,\n      name: r.name || \"N/A\",\n      votes: r.votes,\n    }));\n  }\n\n  // Sentiment Data Sources methods\n  async getSentimentDataSources(filters?: { sourceType?: string; isActive?: boolean }): Promise<SentimentDataSource[]> {\n    const conditions: SQL[] = [];\n    if (filters?.sourceType) conditions.push(eq(sentimentDataSources.sourceType, filters.sourceType));\n    if (filters?.isActive !== undefined) conditions.push(eq(sentimentDataSources.isActive, filters.isActive));\n    \n    return db.select().from(sentimentDataSources)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(sentimentDataSources.createdAt));\n  }\n\n  async createSentimentDataSource(data: InsertSentimentDataSource): Promise<SentimentDataSource> {\n    const [source] = await db.insert(sentimentDataSources).values(data).returning();\n    return source;\n  }\n\n  async updateSentimentDataSource(id: number, data: Partial<InsertSentimentDataSource>): Promise<SentimentDataSource | undefined> {\n    const [updated] = await db.update(sentimentDataSources)\n      .set(data)\n      .where(eq(sentimentDataSources.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Sentiment Articles methods\n  async getSentimentArticles(filters?: { sourceId?: number; startDate?: Date; endDate?: Date; limit?: number }): Promise<SentimentArticle[]> {\n    const conditions: SQL[] = [];\n    if (filters?.sourceId) conditions.push(eq(sentimentArticles.sourceId, filters.sourceId));\n    if (filters?.startDate) conditions.push(sql`${sentimentArticles.publishedAt} >= ${filters.startDate}`);\n    if (filters?.endDate) conditions.push(sql`${sentimentArticles.publishedAt} <= ${filters.endDate}`);\n    \n    let query = db.select().from(sentimentArticles)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(sentimentArticles.publishedAt));\n    \n    if (filters?.limit) {\n      query = query.limit(filters.limit) as any;\n    }\n    \n    return query;\n  }\n\n  async createSentimentArticle(data: InsertSentimentArticle): Promise<SentimentArticle> {\n    const [article] = await db.insert(sentimentArticles).values(data).returning();\n    return article;\n  }\n\n  async createSentimentArticles(data: InsertSentimentArticle[]): Promise<SentimentArticle[]> {\n    if (data.length === 0) return [];\n    const articles = await db.insert(sentimentArticles).values(data).returning();\n    return articles;\n  }\n\n  // Sentiment Analysis Results methods\n  async getSentimentResults(filters: { \n    entityType?: string; \n    entityId?: string; \n    startDate?: Date; \n    endDate?: Date;\n    limit?: number;\n  }): Promise<SentimentAnalysisResult[]> {\n    const conditions: SQL[] = [];\n    if (filters.entityType) conditions.push(eq(sentimentAnalysisResults.entityType, filters.entityType));\n    if (filters.entityId) conditions.push(eq(sentimentAnalysisResults.entityId, filters.entityId));\n    if (filters.startDate) conditions.push(sql`${sentimentAnalysisResults.analysisDate} >= ${filters.startDate}`);\n    if (filters.endDate) conditions.push(sql`${sentimentAnalysisResults.analysisDate} <= ${filters.endDate}`);\n    \n    let query = db.select().from(sentimentAnalysisResults)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(sentimentAnalysisResults.analysisDate));\n    \n    if (filters.limit) {\n      query = query.limit(filters.limit) as any;\n    }\n    \n    return query;\n  }\n\n  async getLatestSentimentByEntity(entityType: string): Promise<SentimentAnalysisResult[]> {\n    const subquery = db.select({\n      entityId: sentimentAnalysisResults.entityId,\n      maxDate: sql<Date>`MAX(${sentimentAnalysisResults.analysisDate})`.as(\"max_date\"),\n    }).from(sentimentAnalysisResults)\n      .where(eq(sentimentAnalysisResults.entityType, entityType))\n      .groupBy(sentimentAnalysisResults.entityId)\n      .as(\"latest\");\n\n    return db.select()\n      .from(sentimentAnalysisResults)\n      .innerJoin(subquery, and(\n        eq(sentimentAnalysisResults.entityId, subquery.entityId),\n        eq(sentimentAnalysisResults.analysisDate, subquery.maxDate)\n      ))\n      .orderBy(desc(sentimentAnalysisResults.mentionCount));\n  }\n\n  async createSentimentResult(data: InsertSentimentAnalysisResult): Promise<SentimentAnalysisResult> {\n    const [result] = await db.insert(sentimentAnalysisResults).values(data).returning();\n    return result;\n  }\n\n  async getSentimentTimeline(entityType: string, entityId: string, days: number = 30): Promise<{\n    date: Date;\n    sentimentScore: number;\n    mentionCount: number;\n    label: string;\n  }[]> {\n    const startDate = new Date();\n    startDate.setDate(startDate.getDate() - days);\n\n    const results = await db.select({\n      date: sentimentAnalysisResults.analysisDate,\n      sentimentScore: sentimentAnalysisResults.sentimentScore,\n      mentionCount: sentimentAnalysisResults.mentionCount,\n      label: sentimentAnalysisResults.sentimentLabel,\n    }).from(sentimentAnalysisResults)\n      .where(and(\n        eq(sentimentAnalysisResults.entityType, entityType),\n        eq(sentimentAnalysisResults.entityId, entityId),\n        sql`${sentimentAnalysisResults.analysisDate} >= ${startDate}`\n      ))\n      .orderBy(sentimentAnalysisResults.analysisDate);\n\n    return results.map(r => ({\n      date: r.date,\n      sentimentScore: parseFloat(String(r.sentimentScore)),\n      mentionCount: r.mentionCount || 0,\n      label: r.label,\n    }));\n  }\n\n  // Sentiment Keywords methods\n  async getKeywords(filters?: { entityType?: string; entityId?: string; limit?: number }): Promise<SentimentKeyword[]> {\n    const conditions: SQL[] = [];\n    if (filters?.entityType) conditions.push(eq(sentimentKeywords.entityType, filters.entityType));\n    if (filters?.entityId) conditions.push(eq(sentimentKeywords.entityId, filters.entityId));\n    \n    let query = db.select().from(sentimentKeywords)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(sentimentKeywords.frequency));\n    \n    if (filters?.limit) {\n      query = query.limit(filters.limit) as any;\n    }\n    \n    return query;\n  }\n\n  async upsertKeyword(data: InsertSentimentKeyword): Promise<SentimentKeyword> {\n    const existing = await db.select().from(sentimentKeywords)\n      .where(and(\n        eq(sentimentKeywords.keyword, data.keyword),\n        data.entityType ? eq(sentimentKeywords.entityType, data.entityType) : sql`${sentimentKeywords.entityType} IS NULL`,\n        data.entityId ? eq(sentimentKeywords.entityId, data.entityId) : sql`${sentimentKeywords.entityId} IS NULL`\n      ))\n      .limit(1);\n\n    if (existing.length > 0) {\n      const [updated] = await db.update(sentimentKeywords)\n        .set({\n          frequency: sql`${sentimentKeywords.frequency} + ${data.frequency}`,\n          lastSeen: new Date(),\n          averageSentiment: data.averageSentiment,\n          trendDirection: data.trendDirection,\n        })\n        .where(eq(sentimentKeywords.id, existing[0].id))\n        .returning();\n      return updated;\n    }\n\n    const [keyword] = await db.insert(sentimentKeywords).values(data).returning();\n    return keyword;\n  }\n\n  async getWordCloudData(entityType?: string, entityId?: string, limit: number = 100): Promise<{\n    word: string;\n    value: number;\n    sentiment: number;\n  }[]> {\n    const conditions: SQL[] = [];\n    if (entityType) conditions.push(eq(sentimentKeywords.entityType, entityType));\n    if (entityId) conditions.push(eq(sentimentKeywords.entityId, entityId));\n\n    const keywords = await db.select().from(sentimentKeywords)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(sentimentKeywords.frequency))\n      .limit(limit);\n\n    return keywords.map(k => ({\n      word: k.keyword,\n      value: k.frequency,\n      sentiment: parseFloat(String(k.averageSentiment || 0)),\n    }));\n  }\n\n  // Campaign Management methods\n  async getCampaigns(filters?: { status?: string; partyId?: number }): Promise<Campaign[]> {\n    const conditions: SQL[] = [];\n    if (filters?.status) conditions.push(eq(campaigns.status, filters.status));\n    if (filters?.partyId) conditions.push(eq(campaigns.targetPartyId, filters.partyId));\n    \n    return db.select().from(campaigns)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(campaigns.createdAt));\n  }\n\n  async getCampaign(id: number): Promise<Campaign | undefined> {\n    const [campaign] = await db.select().from(campaigns).where(eq(campaigns.id, id));\n    return campaign;\n  }\n\n  async getCampaignWithDetails(id: number): Promise<{\n    campaign: Campaign;\n    party?: Party;\n    candidate?: Candidate;\n    aiSession?: any;\n    budgets: CampaignBudget[];\n    resources: CampaignResource[];\n    metrics: CampaignMetric[];\n    activities: CampaignActivity[];\n  } | undefined> {\n    const [campaign] = await db.select().from(campaigns).where(eq(campaigns.id, id));\n    if (!campaign) return undefined;\n\n    const party = campaign.targetPartyId \n      ? (await db.select().from(parties).where(eq(parties.id, campaign.targetPartyId)))[0]\n      : undefined;\n    \n    const candidate = campaign.targetCandidateId\n      ? (await db.select().from(candidates).where(eq(candidates.id, campaign.targetCandidateId)))[0]\n      : undefined;\n\n    const aiSession = campaign.aiSessionId\n      ? (await db.select().from(campaignInsightSessions).where(eq(campaignInsightSessions.id, campaign.aiSessionId)))[0]\n      : undefined;\n\n    const budgetsList = await db.select().from(campaignBudgets)\n      .where(eq(campaignBudgets.campaignId, id))\n      .orderBy(campaignBudgets.category);\n\n    const resourcesList = await db.select().from(campaignResources)\n      .where(eq(campaignResources.campaignId, id))\n      .orderBy(campaignResources.type);\n\n    const metricsList = await db.select().from(campaignMetrics)\n      .where(eq(campaignMetrics.campaignId, id))\n      .orderBy(desc(campaignMetrics.metricDate));\n\n    const activitiesList = await db.select().from(campaignActivities)\n      .where(eq(campaignActivities.campaignId, id))\n      .orderBy(desc(campaignActivities.scheduledDate));\n\n    return {\n      campaign,\n      party,\n      candidate,\n      aiSession,\n      budgets: budgetsList,\n      resources: resourcesList,\n      metrics: metricsList,\n      activities: activitiesList,\n    };\n  }\n\n  async createCampaign(data: InsertCampaign): Promise<Campaign> {\n    const [campaign] = await db.insert(campaigns).values(data).returning();\n    return campaign;\n  }\n\n  async updateCampaign(id: number, data: Partial<InsertCampaign>): Promise<Campaign | undefined> {\n    const [updated] = await db.update(campaigns)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(campaigns.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCampaign(id: number): Promise<boolean> {\n    const result = await db.delete(campaigns).where(eq(campaigns.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Campaign Budget methods\n  async getCampaignBudgets(campaignId: number): Promise<CampaignBudget[]> {\n    return db.select().from(campaignBudgets)\n      .where(eq(campaignBudgets.campaignId, campaignId))\n      .orderBy(campaignBudgets.category);\n  }\n\n  async getCampaignBudget(id: number): Promise<CampaignBudget | undefined> {\n    const [budget] = await db.select().from(campaignBudgets).where(eq(campaignBudgets.id, id));\n    return budget;\n  }\n\n  async createCampaignBudget(data: InsertCampaignBudget): Promise<CampaignBudget> {\n    const [budget] = await db.insert(campaignBudgets).values(data).returning();\n    return budget;\n  }\n\n  async updateCampaignBudget(id: number, data: Partial<InsertCampaignBudget>): Promise<CampaignBudget | undefined> {\n    const [updated] = await db.update(campaignBudgets)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(campaignBudgets.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCampaignBudget(id: number): Promise<boolean> {\n    const result = await db.delete(campaignBudgets).where(eq(campaignBudgets.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Campaign Resource methods\n  async getCampaignResources(campaignId: number): Promise<CampaignResource[]> {\n    return db.select().from(campaignResources)\n      .where(eq(campaignResources.campaignId, campaignId))\n      .orderBy(campaignResources.type);\n  }\n\n  async getCampaignResource(id: number): Promise<CampaignResource | undefined> {\n    const [resource] = await db.select().from(campaignResources).where(eq(campaignResources.id, id));\n    return resource;\n  }\n\n  async createCampaignResource(data: InsertCampaignResource): Promise<CampaignResource> {\n    const [resource] = await db.insert(campaignResources).values(data).returning();\n    return resource;\n  }\n\n  async updateCampaignResource(id: number, data: Partial<InsertCampaignResource>): Promise<CampaignResource | undefined> {\n    const [updated] = await db.update(campaignResources)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(campaignResources.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCampaignResource(id: number): Promise<boolean> {\n    const result = await db.delete(campaignResources).where(eq(campaignResources.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Campaign Metric methods\n  async getCampaignMetrics(campaignId: number, filters?: { kpiName?: string; startDate?: Date; endDate?: Date }): Promise<CampaignMetric[]> {\n    const conditions: SQL[] = [eq(campaignMetrics.campaignId, campaignId)];\n    if (filters?.kpiName) conditions.push(eq(campaignMetrics.kpiName, filters.kpiName));\n    if (filters?.startDate) conditions.push(sql`${campaignMetrics.metricDate} >= ${filters.startDate}`);\n    if (filters?.endDate) conditions.push(sql`${campaignMetrics.metricDate} <= ${filters.endDate}`);\n    \n    return db.select().from(campaignMetrics)\n      .where(and(...conditions))\n      .orderBy(desc(campaignMetrics.metricDate));\n  }\n\n  async getCampaignMetric(id: number): Promise<CampaignMetric | undefined> {\n    const [metric] = await db.select().from(campaignMetrics).where(eq(campaignMetrics.id, id));\n    return metric;\n  }\n\n  async createCampaignMetric(data: InsertCampaignMetric): Promise<CampaignMetric> {\n    const [metric] = await db.insert(campaignMetrics).values(data).returning();\n    return metric;\n  }\n\n  async updateCampaignMetric(id: number, data: Partial<InsertCampaignMetric>): Promise<CampaignMetric | undefined> {\n    const [updated] = await db.update(campaignMetrics)\n      .set(data)\n      .where(eq(campaignMetrics.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCampaignMetric(id: number): Promise<boolean> {\n    const result = await db.delete(campaignMetrics).where(eq(campaignMetrics.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Campaign Activity methods\n  async getCampaignActivities(campaignId: number, filters?: { status?: string; type?: string }): Promise<CampaignActivity[]> {\n    const conditions: SQL[] = [eq(campaignActivities.campaignId, campaignId)];\n    if (filters?.status) conditions.push(eq(campaignActivities.status, filters.status));\n    if (filters?.type) conditions.push(eq(campaignActivities.type, filters.type));\n    \n    return db.select().from(campaignActivities)\n      .where(and(...conditions))\n      .orderBy(desc(campaignActivities.scheduledDate));\n  }\n\n  async getCampaignActivity(id: number): Promise<CampaignActivity | undefined> {\n    const [activity] = await db.select().from(campaignActivities).where(eq(campaignActivities.id, id));\n    return activity;\n  }\n\n  async createCampaignActivity(data: InsertCampaignActivity): Promise<CampaignActivity> {\n    const [activity] = await db.insert(campaignActivities).values(data).returning();\n    return activity;\n  }\n\n  async updateCampaignActivity(id: number, data: Partial<InsertCampaignActivity>): Promise<CampaignActivity | undefined> {\n    const [updated] = await db.update(campaignActivities)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(campaignActivities.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCampaignActivity(id: number): Promise<boolean> {\n    const result = await db.delete(campaignActivities).where(eq(campaignActivities.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Campaign performance summary\n  async getCampaignPerformanceSummary(campaignId: number): Promise<{\n    budgetUtilization: number;\n    activitiesCompleted: number;\n    activitiesTotal: number;\n    resourcesAllocated: number;\n    latestMetrics: { name: string; value: number; target: number | null }[];\n    daysRemaining: number;\n    progressPercentage: number;\n  }> {\n    const campaign = await this.getCampaign(campaignId);\n    if (!campaign) {\n      return {\n        budgetUtilization: 0,\n        activitiesCompleted: 0,\n        activitiesTotal: 0,\n        resourcesAllocated: 0,\n        latestMetrics: [],\n        daysRemaining: 0,\n        progressPercentage: 0,\n      };\n    }\n\n    // Budget utilization\n    const budgets = await this.getCampaignBudgets(campaignId);\n    const totalAllocated = budgets.reduce((sum, b) => sum + parseFloat(String(b.allocatedAmount || 0)), 0);\n    const totalSpent = budgets.reduce((sum, b) => sum + parseFloat(String(b.spentAmount || 0)), 0);\n    const budgetUtilization = totalAllocated > 0 ? (totalSpent / totalAllocated) * 100 : 0;\n\n    // Activities\n    const activities = await this.getCampaignActivities(campaignId);\n    const activitiesCompleted = activities.filter(a => a.status === 'completed').length;\n    const activitiesTotal = activities.length;\n\n    // Resources\n    const resources = await this.getCampaignResources(campaignId);\n    const resourcesAllocated = resources.filter(r => r.status === 'allocated').length;\n\n    // Latest metrics - get unique KPIs with latest values\n    const allMetrics = await this.getCampaignMetrics(campaignId);\n    const latestByKpi = new Map<string, CampaignMetric>();\n    for (const metric of allMetrics) {\n      if (!latestByKpi.has(metric.kpiName) || \n          new Date(metric.metricDate) > new Date(latestByKpi.get(metric.kpiName)!.metricDate)) {\n        latestByKpi.set(metric.kpiName, metric);\n      }\n    }\n    const latestMetrics = Array.from(latestByKpi.values()).slice(0, 5).map(m => ({\n      name: m.kpiName,\n      value: parseFloat(String(m.kpiValue)),\n      target: m.targetValue ? parseFloat(String(m.targetValue)) : null,\n    }));\n\n    // Days remaining\n    const now = new Date();\n    const endDate = new Date(campaign.endDate);\n    const startDate = new Date(campaign.startDate);\n    const daysRemaining = Math.max(0, Math.ceil((endDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));\n    \n    // Progress percentage (time-based)\n    const totalDays = Math.max(1, Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)));\n    const daysPassed = Math.max(0, Math.ceil((now.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)));\n    const progressPercentage = Math.min(100, (daysPassed / totalDays) * 100);\n\n    return {\n      budgetUtilization,\n      activitiesCompleted,\n      activitiesTotal,\n      resourcesAllocated,\n      latestMetrics,\n      daysRemaining,\n      progressPercentage,\n    };\n  }\n\n  // ============ CAMPAIGN TEAM MEMBERS ============\n  \n  async getCampaignTeamMembers(campaignId: number): Promise<CampaignTeamMember[]> {\n    return db.select().from(campaignTeamMembers)\n      .where(and(\n        eq(campaignTeamMembers.campaignId, campaignId),\n        eq(campaignTeamMembers.isActive, true)\n      ))\n      .orderBy(desc(campaignTeamMembers.joinedAt));\n  }\n\n  async getCampaignTeamMember(id: number): Promise<CampaignTeamMember | undefined> {\n    const [member] = await db.select().from(campaignTeamMembers)\n      .where(eq(campaignTeamMembers.id, id));\n    return member;\n  }\n\n  async getCampaignTeamMemberByUser(campaignId: number, userId: string): Promise<CampaignTeamMember | undefined> {\n    const [member] = await db.select().from(campaignTeamMembers)\n      .where(and(\n        eq(campaignTeamMembers.campaignId, campaignId),\n        eq(campaignTeamMembers.userId, userId),\n        eq(campaignTeamMembers.isActive, true)\n      ));\n    return member;\n  }\n\n  async createCampaignTeamMember(data: InsertCampaignTeamMember): Promise<CampaignTeamMember> {\n    const [member] = await db.insert(campaignTeamMembers).values(data).returning();\n    return member;\n  }\n\n  async updateCampaignTeamMember(id: number, data: Partial<InsertCampaignTeamMember>): Promise<CampaignTeamMember | undefined> {\n    const [member] = await db.update(campaignTeamMembers)\n      .set(data)\n      .where(eq(campaignTeamMembers.id, id))\n      .returning();\n    return member;\n  }\n\n  async deleteCampaignTeamMember(id: number): Promise<boolean> {\n    // Soft delete by setting isActive to false\n    const [member] = await db.update(campaignTeamMembers)\n      .set({ isActive: false, leftAt: new Date() })\n      .where(eq(campaignTeamMembers.id, id))\n      .returning();\n    return !!member;\n  }\n\n  // ============ ACTIVITY ASSIGNEES ============\n  \n  async getActivityAssignees(activityId: number): Promise<ActivityAssignee[]> {\n    return db.select().from(activityAssignees)\n      .where(eq(activityAssignees.activityId, activityId))\n      .orderBy(desc(activityAssignees.assignedAt));\n  }\n\n  async createActivityAssignee(data: InsertActivityAssignee): Promise<ActivityAssignee> {\n    const [assignee] = await db.insert(activityAssignees).values(data).returning();\n    return assignee;\n  }\n\n  async deleteActivityAssignee(id: number): Promise<boolean> {\n    await db.delete(activityAssignees).where(eq(activityAssignees.id, id));\n    return true;\n  }\n\n  // ============ AI KPI GOALS ============\n  \n  async getAiKpiGoals(campaignId: number): Promise<AiKpiGoal[]> {\n    return db.select().from(aiKpiGoals)\n      .where(eq(aiKpiGoals.campaignId, campaignId))\n      .orderBy(desc(aiKpiGoals.createdAt));\n  }\n\n  async getAiKpiGoal(id: number): Promise<AiKpiGoal | undefined> {\n    const [goal] = await db.select().from(aiKpiGoals)\n      .where(eq(aiKpiGoals.id, id));\n    return goal;\n  }\n\n  async createAiKpiGoal(data: InsertAiKpiGoal): Promise<AiKpiGoal> {\n    const [goal] = await db.insert(aiKpiGoals).values(data).returning();\n    return goal;\n  }\n\n  async updateAiKpiGoal(id: number, data: Partial<InsertAiKpiGoal>): Promise<AiKpiGoal | undefined> {\n    const [goal] = await db.update(aiKpiGoals)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(aiKpiGoals.id, id))\n      .returning();\n    return goal;\n  }\n\n  async deleteAiKpiGoal(id: number): Promise<boolean> {\n    await db.delete(aiKpiGoals).where(eq(aiKpiGoals.id, id));\n    return true;\n  }\n\n  // ============ CAMPAIGN NOTIFICATIONS ============\n  \n  async getCampaignNotifications(campaignId: number): Promise<CampaignNotification[]> {\n    return db.select().from(campaignNotifications)\n      .where(eq(campaignNotifications.campaignId, campaignId))\n      .orderBy(desc(campaignNotifications.createdAt));\n  }\n\n  async getUserCampaignNotifications(userId: string): Promise<CampaignNotification[]> {\n    return db.select().from(campaignNotifications)\n      .where(eq(campaignNotifications.recipientUserId, userId))\n      .orderBy(desc(campaignNotifications.createdAt));\n  }\n\n  async createCampaignNotification(data: InsertCampaignNotification): Promise<CampaignNotification> {\n    const [notification] = await db.insert(campaignNotifications).values(data).returning();\n    return notification;\n  }\n\n  async markCampaignNotificationSent(id: number, inAppNotificationId?: number): Promise<CampaignNotification | undefined> {\n    const [notification] = await db.update(campaignNotifications)\n      .set({ \n        sentAt: new Date(),\n        inAppNotificationId: inAppNotificationId || null \n      })\n      .where(eq(campaignNotifications.id, id))\n      .returning();\n    return notification;\n  }\n\n  // ============ CALENDAR ACTIVITIES ============\n  \n  async getCalendarActivities(campaignId: number, startDate: Date, endDate: Date): Promise<CampaignActivity[]> {\n    return db.select().from(campaignActivities)\n      .where(and(\n        eq(campaignActivities.campaignId, campaignId),\n        sql`${campaignActivities.scheduledDate} >= ${startDate}`,\n        sql`${campaignActivities.scheduledDate} <= ${endDate}`\n      ))\n      .orderBy(asc(campaignActivities.scheduledDate));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":134325,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/app-sidebar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport {\n  LayoutDashboard,\n  Building2,\n  Users,\n  FileText,\n  PlayCircle,\n  Brain,\n  ClipboardList,\n  Settings,\n  LogOut,\n  Shield,\n  Upload,\n  BarChart3,\n  Loader2,\n  Download,\n  PieChart,\n  Search,\n  Layers,\n  Database,\n  Sparkles,\n  Target,\n  Clock,\n  MessageSquare,\n  MapPin,\n  Megaphone,\n} from \"lucide-react\";\nimport type { TseImportJob } from \"@shared/schema\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarHeader,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useAuth } from \"@/lib/auth-context\";\n\nconst mainNavItems = [\n  { title: \"Dashboard\", url: \"/\", icon: LayoutDashboard, permission: null },\n  { title: \"Partidos\", url: \"/parties\", icon: Building2, permission: \"manage_parties\" },\n  { title: \"Candidatos\", url: \"/candidates\", icon: Users, permission: \"manage_candidates\" },\n  { title: \"Cenários\", url: \"/scenarios\", icon: FileText, permission: \"manage_scenarios\" },\n];\n\nconst simulationNavItems = [\n  { title: \"Simulações\", url: \"/simulations\", icon: PlayCircle, permission: \"run_simulations\" },\n  { title: \"Previsões IA\", url: \"/predictions\", icon: Brain, permission: \"ai_predictions\" },\n  { title: \"Insights IA\", url: \"/ai-insights\", icon: Sparkles, permission: \"ai_predictions\" },\n  { title: \"Previsões Eleitorais\", url: \"/forecasts\", icon: Target, permission: \"ai_predictions\" },\n  { title: \"Relatórios de Projeção\", url: \"/projection-reports\", icon: FileText, permission: \"ai_predictions\" },\n  { title: \"Dashboard Eleitoral\", url: \"/electoral-dashboard\", icon: PieChart, permission: null },\n  { title: \"Painel Interativo\", url: \"/interactive-dashboard\", icon: Layers, permission: null },\n  { title: \"Análise de Dados\", url: \"/data-analysis\", icon: BarChart3, permission: null },\n  { title: \"Automação de Relatórios\", url: \"/report-automation\", icon: Clock, permission: \"ai_predictions\" },\n  { title: \"Análise de Sentimento\", url: \"/sentiment-analysis\", icon: MessageSquare, permission: \"ai_predictions\" },\n  { title: \"Busca Semântica\", url: \"/semantic-search\", icon: Search, permission: \"ai_predictions\" },\n  { title: \"Gestão de Campanhas\", url: \"/campaigns\", icon: Megaphone, permission: \"ai_predictions\" },\n  { title: \"Estrategista IA\", url: \"/campaign-insights\", icon: Brain, permission: \"ai_predictions\" },\n];\n\nconst adminNavItems = [\n  { title: \"Importação TSE\", url: \"/tse-import\", icon: Upload, permission: \"manage_users\" },\n  { title: \"Dados IBGE\", url: \"/ibge-data\", icon: MapPin, permission: \"manage_users\" },\n  { title: \"Auditoria\", url: \"/audit\", icon: ClipboardList, permission: \"view_audit\" },\n  { title: \"Usuários\", url: \"/users\", icon: Shield, permission: \"manage_users\" },\n  { title: \"Admin Sistema\", url: \"/admin-settings\", icon: Database, permission: \"manage_users\" },\n];\n\nfunction ImportStatusIndicator() {\n  const { data: jobs } = useQuery<TseImportJob[]>({\n    queryKey: [\"/api/imports/tse\"],\n    refetchInterval: (query) => {\n      const data = query.state.data as TseImportJob[] | undefined;\n      const hasActive = data?.some(job => \n        [\"pending\", \"downloading\", \"extracting\", \"running\", \"processing\"].includes(job.status)\n      );\n      return hasActive ? 2000 : 30000;\n    },\n  });\n\n  const activeJobs = jobs?.filter(job => \n    [\"pending\", \"downloading\", \"extracting\", \"running\", \"processing\"].includes(job.status)\n  ) || [];\n\n  if (activeJobs.length === 0) return null;\n\n  const downloadingCount = activeJobs.filter(j => j.status === \"downloading\").length;\n  const processingCount = activeJobs.filter(j => \n    [\"extracting\", \"running\", \"processing\"].includes(j.status)\n  ).length;\n\n  return (\n    <div className=\"mx-2 mb-2 p-2 rounded-md bg-primary/10 border border-primary/20\" data-testid=\"indicator-active-imports\">\n      <Link href=\"/tse-import\" data-testid=\"link-active-imports\">\n        <div className=\"flex items-center gap-2 cursor-pointer hover:opacity-80\">\n          {downloadingCount > 0 ? (\n            <Download className=\"h-4 w-4 text-primary animate-pulse\" />\n          ) : (\n            <Loader2 className=\"h-4 w-4 text-primary animate-spin\" />\n          )}\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"text-xs font-medium text-primary\" data-testid=\"text-active-import-count\">\n              {activeJobs.length} importação{activeJobs.length > 1 ? \"ões\" : \"\"} ativa{activeJobs.length > 1 ? \"s\" : \"\"}\n            </p>\n            <p className=\"text-xs text-muted-foreground truncate\" data-testid=\"text-import-status-detail\">\n              {downloadingCount > 0 && `${downloadingCount} baixando`}\n              {downloadingCount > 0 && processingCount > 0 && \", \"}\n              {processingCount > 0 && `${processingCount} processando`}\n            </p>\n          </div>\n        </div>\n      </Link>\n    </div>\n  );\n}\n\nexport function AppSidebar() {\n  const [location] = useLocation();\n  const { user, logout, hasPermission } = useAuth();\n\n  const roleLabels: Record<string, string> = {\n    admin: \"Administrador\",\n    analyst: \"Analista\",\n    viewer: \"Visualizador\",\n  };\n\n  const roleBadgeVariant: Record<string, \"default\" | \"secondary\" | \"outline\"> = {\n    admin: \"default\",\n    analyst: \"secondary\",\n    viewer: \"outline\",\n  };\n\n  function filterByPermission(items: typeof mainNavItems) {\n    return items.filter((item) => !item.permission || hasPermission(item.permission));\n  }\n\n  return (\n    <Sidebar className=\"border-r-0\">\n      <SidebarHeader className=\"p-4 border-b border-sidebar-border\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-10 h-10 rounded-md bg-sidebar-primary flex items-center justify-center\">\n            <span className=\"text-sidebar-primary-foreground font-bold text-lg\">TSE</span>\n          </div>\n          <div className=\"flex flex-col\">\n            <span className=\"font-semibold text-sidebar-foreground text-sm\">SimulaVoto</span>\n            <span className=\"text-xs text-sidebar-foreground/70\">Sistema Eleitoral</span>\n          </div>\n        </div>\n      </SidebarHeader>\n\n      <SidebarContent className=\"px-2\">\n        <SidebarGroup>\n          <SidebarGroupLabel className=\"text-sidebar-foreground/60 text-xs uppercase tracking-wider px-2\">\n            Principal\n          </SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {filterByPermission(mainNavItems).map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    asChild\n                    isActive={location === item.url}\n                    className=\"hover-elevate\"\n                    data-testid={`nav-${item.url.replace(\"/\", \"\") || \"dashboard\"}`}\n                  >\n                    <Link href={item.url}>\n                      <item.icon className=\"h-4 w-4\" />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n\n        <SidebarGroup>\n          <SidebarGroupLabel className=\"text-sidebar-foreground/60 text-xs uppercase tracking-wider px-2\">\n            Simulação\n          </SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {filterByPermission(simulationNavItems).map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    asChild\n                    isActive={location === item.url}\n                    className=\"hover-elevate\"\n                    data-testid={`nav-${item.url.replace(\"/\", \"\")}`}\n                  >\n                    <Link href={item.url}>\n                      <item.icon className=\"h-4 w-4\" />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n\n        {filterByPermission(adminNavItems).length > 0 && (\n          <SidebarGroup>\n            <SidebarGroupLabel className=\"text-sidebar-foreground/60 text-xs uppercase tracking-wider px-2\">\n              Administração\n            </SidebarGroupLabel>\n            <SidebarGroupContent>\n              <ImportStatusIndicator />\n              <SidebarMenu>\n                {filterByPermission(adminNavItems).map((item) => (\n                  <SidebarMenuItem key={item.title}>\n                    <SidebarMenuButton\n                      asChild\n                      isActive={location === item.url}\n                      className=\"hover-elevate\"\n                      data-testid={`nav-${item.url.replace(\"/\", \"\")}`}\n                    >\n                      <Link href={item.url}>\n                        <item.icon className=\"h-4 w-4\" />\n                        <span>{item.title}</span>\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                ))}\n              </SidebarMenu>\n            </SidebarGroupContent>\n          </SidebarGroup>\n        )}\n      </SidebarContent>\n\n      <SidebarFooter className=\"p-4 border-t border-sidebar-border\">\n        {user && (\n          <div className=\"flex flex-col gap-3\">\n            <div className=\"flex items-center gap-3\">\n              <Avatar className=\"h-9 w-9\">\n                <AvatarFallback className=\"bg-sidebar-accent text-sidebar-accent-foreground text-sm\">\n                  {user.name.split(\" \").map((n) => n[0]).join(\"\").toUpperCase().slice(0, 2)}\n                </AvatarFallback>\n              </Avatar>\n              <div className=\"flex flex-col flex-1 min-w-0\">\n                <span className=\"text-sm font-medium text-sidebar-foreground truncate\">{user.name}</span>\n                <Badge\n                  variant={roleBadgeVariant[user.role] || \"outline\"}\n                  className=\"w-fit text-xs\"\n                >\n                  {roleLabels[user.role] || user.role}\n                </Badge>\n              </div>\n            </div>\n            <div className=\"flex gap-2\">\n              <SidebarMenuButton\n                asChild\n                className=\"flex-1 hover-elevate\"\n                data-testid=\"nav-settings\"\n              >\n                <Link href=\"/settings\">\n                  <Settings className=\"h-4 w-4\" />\n                  <span>Config</span>\n                </Link>\n              </SidebarMenuButton>\n              <SidebarMenuButton\n                onClick={logout}\n                className=\"flex-1 hover-elevate text-destructive\"\n                data-testid=\"button-logout\"\n              >\n                <LogOut className=\"h-4 w-4\" />\n                <span>Sair</span>\n              </SidebarMenuButton>\n            </div>\n          </div>\n        )}\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","path":null,"size_bytes":11148,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"DEPLOY.md":{"content":"# SimulaVoto - Guia de Deploy\n\nEste guia explica como fazer deploy do SimulaVoto com banco de dados PostgreSQL local (container Docker).\n\n## Opcoes de Deploy\n\n| Plataforma | Guia |\n|------------|------|\n| **Portainer** (Recomendado) | [DEPLOY-PORTAINER.md](./DEPLOY-PORTAINER.md) |\n| **Atualizacao Portainer** | [DEPLOY-UPDATE-PORTAINER.md](./DEPLOY-UPDATE-PORTAINER.md) |\n| **Coolify** | Este documento |\n| **Docker direto** | Secao [Deploy Local com Docker](#deploy-local-com-docker) |\n\n## Indice\n\n1. [Pre-requisitos](#pre-requisitos)\n2. [Configuracao do Banco de Dados](#configuracao-do-banco-de-dados)\n3. [Configuracao do Coolify](#configuracao-do-coolify)\n4. [Variaveis de Ambiente](#variaveis-de-ambiente)\n5. [Deploy Local com Docker](#deploy-local-com-docker)\n6. [Comandos Uteis](#comandos-uteis)\n7. [Solucao de Problemas](#solucao-de-problemas)\n\n---\n\n## Pre-requisitos\n\n- Servidor com [Coolify](https://coolify.io) ou [Portainer](https://www.portainer.io/)\n- Chave de API do OpenAI (para recursos de IA)\n- Git repository com o codigo fonte\n\n---\n\n## Configuracao do Banco de Dados\n\nO banco de dados PostgreSQL e executado como um container Docker local, usando a imagem `pgvector/pgvector:pg16` que ja inclui suporte a extensao `vector` para busca semantica.\n\n### Inicializacao Automatica\n\nO banco e inicializado automaticamente no primeiro deploy:\n- O script `scripts/init-db.sql` e montado como volume e executado automaticamente pelo PostgreSQL\n- As extensoes `pgcrypto`, `uuid-ossp` e `vector` sao criadas automaticamente\n- Todas as 68 tabelas sao criadas no primeiro start\n\n### Dados Persistentes\n\nOs dados ficam armazenados no volume Docker `simulavoto_pgdata` e sobrevivem a reinicializacoes e atualizacoes.\n\n> **CUIDADO**: Apenas `docker compose down -v` remove os dados do banco!\n\n---\n\n## Configuracao do Coolify\n\n### 1. Adicionar Novo Projeto\n\n1. Acesse seu dashboard do Coolify\n2. Clique em **New Project**\n3. Nomeie como \"SimulaVoto\"\n\n### 2. Configurar Aplicacao\n\n1. Clique em **Add New Resource** -> **Application**\n2. Selecione **Docker (Build Pack)**\n3. Conecte seu repositorio Git\n4. Configure o branch (main/master)\n\n### 3. Configuracoes de Build\n\n```yaml\nBuild Command: npm run build\nStart Command: ./docker-entrypoint.sh\nPort: 5000\nHealth Check Path: /api/health\n```\n\n### 4. Configurar Variaveis de Ambiente\n\nAdicione as seguintes variaveis em **Environment Variables**:\n\n| Variavel | Descricao | Exemplo |\n|----------|-----------|---------|\n| `POSTGRES_PASSWORD` | Senha do PostgreSQL local | `SuaSenhaSegura2026!` |\n| `SESSION_SECRET` | Segredo para sessoes (32+ caracteres) | `gerar-string-aleatoria-longa` |\n| `OPENAI_API_KEY` | Chave API do OpenAI | `sk-...` |\n\n### 5. Recursos Recomendados\n\n- **RAM**: Minimo 512MB, recomendado 1GB\n- **CPU**: 0.5 vCPU minimo\n- **Storage**: 1GB para logs e cache\n\n### 6. Deploy\n\n1. Clique em **Deploy**\n2. Aguarde o build completar\n3. Verifique os logs para erros\n4. Acesse a URL fornecida\n\n---\n\n## Variaveis de Ambiente\n\n### Obrigatorias\n\n| Variavel | Descricao |\n|----------|-----------|\n| `POSTGRES_PASSWORD` | Senha do PostgreSQL local |\n| `SESSION_SECRET` | String secreta para criptografia de sessoes |\n\n### Opcionais\n\n| Variavel | Descricao | Padrao |\n|----------|-----------|--------|\n| `OPENAI_API_KEY` | Para recursos de IA | - |\n| `RESEND_API_KEY` | Para envio de emails | - |\n| `NODE_ENV` | Ambiente de execucao | `production` |\n| `PORT` | Porta do servidor | `5000` |\n\n### Gerar SESSION_SECRET\n\n```bash\nopenssl rand -base64 32\n```\n\nOu via Node.js:\n```bash\nnode -e \"console.log(require('crypto').randomBytes(32).toString('base64'))\"\n```\n\n---\n\n## Deploy Local com Docker\n\n### Usando Docker Compose\n\n1. Clone o repositorio\n2. Crie um arquivo `.env`:\n   ```env\n   POSTGRES_PASSWORD=SuaSenhaSegura2026!\n   SESSION_SECRET=sua-chave-secreta-aqui-32-caracteres\n   OPENAI_API_KEY=sk-sua-chave-openai\n   ```\n\n3. Inicie os containers:\n   ```bash\n   docker compose up -d --build\n   ```\n\n4. Acesse: http://localhost:5000\n\n> O banco PostgreSQL e criado automaticamente como container Docker com volume persistente.\n\n---\n\n## Comandos Uteis\n\n### Verificar Saude da Aplicacao\n\n```bash\ncurl http://localhost:5000/api/health\n```\n\n### Visualizar Logs\n\n```bash\ndocker compose logs -f simulavoto\n```\n\n### Reiniciar Aplicacao\n\n```bash\ndocker compose restart simulavoto\n```\n\n### Parar\n\n```bash\ndocker compose down\n```\n\n### Acessar Shell do Container\n\n```bash\ndocker exec -it simulavoto sh\n```\n\n---\n\n## Solucao de Problemas\n\n### Erro: DATABASE_URL nao definida\n\n**Causa**: Variavel de ambiente nao configurada\n**Solucao**: A `DATABASE_URL` e gerada automaticamente pelo docker-compose. Verifique se `POSTGRES_PASSWORD` esta definida no `.env`.\n\n### Erro: Banco nao conecta\n\n**Causa**: Container do banco ainda inicializando\n**Solucao**: Verifique se o container do banco esta saudavel:\n```bash\ndocker exec simulavoto-db pg_isready -U simulavoto -d simulavoto\n```\n\n### Erro de permissao no docker-entrypoint.sh\n\n**Causa**: Arquivo sem permissao de execucao\n**Solucao**: Ja corrigido no Dockerfile, mas se persistir:\n```bash\nchmod +x docker-entrypoint.sh\n```\n\n### Erro 502 Bad Gateway\n\n**Causa**: Aplicacao ainda inicializando ou crashou\n**Solucao**:\n1. Aguarde 30-60 segundos\n2. Verifique os logs\n3. Aumente o timeout de health check\n\n---\n\n## Credenciais Padrao\n\nApos o primeiro deploy, faca login com:\n- **Usuario**: admin\n- **Senha**: admin123\n\n**IMPORTANTE**: Altere a senha do admin imediatamente apos o primeiro acesso!\n","path":null,"size_bytes":5477,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/pages/ibge-data.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Database,\n  Download,\n  RefreshCw,\n  MapPin,\n  Users,\n  Building2,\n  TrendingUp,\n  Clock,\n  CheckCircle2,\n  XCircle,\n  Loader2,\n  BarChart3,\n  Calendar,\n  Search,\n  StopCircle,\n  RotateCcw,\n  Ban,\n  FileText,\n  AlertTriangle,\n  Timer,\n  Gauge,\n} from \"lucide-react\";\n\ninterface IBGEStats {\n  totalMunicipios: number;\n  totalPopulacaoRecords: number;\n  totalIndicadoresRecords: number;\n  lastUpdate: string | null;\n  populacaoByYear: { ano: number; count: number }[];\n}\n\ninterface ImportProgress {\n  phase: string;\n  phaseDescription: string;\n  currentBatch: number;\n  totalBatches: number;\n  recordsPerSecond: number;\n  estimatedTimeRemaining: string;\n  lastProcessedRecord: string;\n  errors: ImportError[];\n}\n\ninterface ImportError {\n  timestamp: string;\n  record: string;\n  errorType: string;\n  errorMessage: string;\n  errorCode?: string;\n  details?: string;\n}\n\ninterface IBGEImportJob {\n  id: number;\n  type: string;\n  status: string;\n  totalRecords: number;\n  processedRecords: number;\n  failedRecords: number;\n  errorMessage: string | null;\n  errorDetails: {\n    progress?: ImportProgress;\n    allErrors?: ImportError[];\n    summary?: {\n      duration?: string;\n      totalProcessed?: number;\n      successRate?: string;\n      ano?: number;\n    };\n  } | null;\n  parameters?: { ano?: number } | null;\n  startedAt: string | null;\n  completedAt: string | null;\n  source: string;\n  createdAt: string;\n}\n\ninterface ErrorReport {\n  job: IBGEImportJob;\n  summary: {\n    totalErrors: number;\n    errorsByType: Record<string, number>;\n    affectedRecords: string[];\n  };\n  errors: ImportError[];\n}\n\nexport default function IBGEDataPage() {\n  const { toast } = useToast();\n  const [selectedYear, setSelectedYear] = useState<string>(\"2024\");\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [errorReportJobId, setErrorReportJobId] = useState<number | null>(null);\n\n  const { data: stats, isLoading: statsLoading, refetch: refetchStats } = useQuery<IBGEStats>({\n    queryKey: [\"/api/ibge/stats\"],\n    refetchInterval: 10000,\n  });\n\n  const { data: importJobs, isLoading: jobsLoading, refetch: refetchJobs } = useQuery<IBGEImportJob[]>({\n    queryKey: [\"/api/ibge/import-jobs\"],\n    refetchInterval: 3000,\n  });\n\n  const [debouncedSearch, setDebouncedSearch] = useState(\"\");\n  \n  // Debounce search to avoid too many API calls\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedSearch(searchTerm);\n    }, 300);\n    return () => clearTimeout(timer);\n  }, [searchTerm]);\n\n  const { data: demographicData, isLoading: demographicLoading } = useQuery<{\n    municipios: any[];\n    aggregatedData: {\n      totalPopulacao: number;\n      avgIdh: number | null;\n      avgRenda: number | null;\n      avgTaxaAlfabetizacao: number | null;\n      anoPopulacao: number | null;\n      anoIndicadores: number | null;\n    };\n  }>({\n    queryKey: [\"/api/ibge/demographic-data\", { search: debouncedSearch }],\n  });\n\n  const { data: errorReport, isLoading: errorReportLoading } = useQuery<ErrorReport>({\n    queryKey: [\"/api/ibge/import\", errorReportJobId, \"report\"],\n    enabled: errorReportJobId !== null,\n  });\n\n  const importMunicipiosMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/ibge/import/municipios\", {});\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Importação iniciada\",\n        description: \"Importando dados de municípios do IBGE...\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/import-jobs\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/stats\"] });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Erro\",\n        description: error instanceof Error ? error.message : \"Falha ao iniciar importação\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const importPopulacaoMutation = useMutation({\n    mutationFn: async (ano: number) => {\n      return apiRequest(\"POST\", \"/api/ibge/import/populacao\", { ano });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Importação iniciada\",\n        description: `Importando dados de população (${selectedYear})...`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/import-jobs\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/stats\"] });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Erro\",\n        description: error instanceof Error ? error.message : \"Falha ao iniciar importação\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const importIndicadoresMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/ibge/import/indicadores\", {});\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Importação iniciada\",\n        description: \"Importando indicadores socioeconômicos...\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/import-jobs\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/stats\"] });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Erro\",\n        description: error instanceof Error ? error.message : \"Falha ao iniciar importação\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const importAllMutation = useMutation({\n    mutationFn: async (ano: number) => {\n      return apiRequest(\"POST\", \"/api/ibge/import/all\", { ano });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Importação completa iniciada\",\n        description: \"Importando todos os dados demográficos do IBGE...\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/import-jobs\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/stats\"] });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Erro\",\n        description: error instanceof Error ? error.message : \"Falha ao iniciar importação\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const cancelJobMutation = useMutation({\n    mutationFn: async (jobId: number) => {\n      return apiRequest(\"POST\", `/api/ibge/import/${jobId}/cancel`, {});\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Importação cancelada\",\n        description: \"O job de importação foi cancelado com sucesso.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/import-jobs\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/stats\"] });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Erro\",\n        description: error instanceof Error ? error.message : \"Falha ao cancelar importação\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const restartJobMutation = useMutation({\n    mutationFn: async (jobId: number) => {\n      return apiRequest(\"POST\", `/api/ibge/import/${jobId}/restart`, {});\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Importação reiniciada\",\n        description: \"O job de importação foi reiniciado com sucesso.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/import-jobs\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/ibge/stats\"] });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Erro\",\n        description: error instanceof Error ? error.message : \"Falha ao reiniciar importação\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const formatNumber = (num: number) => {\n    return new Intl.NumberFormat(\"pt-BR\").format(num);\n  };\n\n  const formatDate = (dateStr: string | null) => {\n    if (!dateStr) return \"—\";\n    return new Date(dateStr).toLocaleString(\"pt-BR\");\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"completed\":\n        return <Badge variant=\"default\" className=\"bg-green-500\"><CheckCircle2 className=\"h-3 w-3 mr-1\" /> Concluído</Badge>;\n      case \"running\":\n        return <Badge variant=\"secondary\"><Loader2 className=\"h-3 w-3 mr-1 animate-spin\" /> Em andamento</Badge>;\n      case \"failed\":\n        return <Badge variant=\"destructive\"><XCircle className=\"h-3 w-3 mr-1\" /> Falhou</Badge>;\n      case \"pending\":\n        return <Badge variant=\"outline\"><Clock className=\"h-3 w-3 mr-1\" /> Pendente</Badge>;\n      case \"cancelled\":\n        return <Badge variant=\"outline\" className=\"border-orange-500 text-orange-500\"><Ban className=\"h-3 w-3 mr-1\" /> Cancelado</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  const getJobTypeName = (type: string) => {\n    switch (type) {\n      case \"municipios\": return \"Municípios\";\n      case \"populacao\": return \"População\";\n      case \"indicadores\": return \"Indicadores\";\n      case \"all\": return \"Completa\";\n      default: return type;\n    }\n  };\n\n  const hasActiveImport = importJobs?.some(j => j.status === \"running\" || j.status === \"pending\");\n\n  const renderProgressDetails = (job: IBGEImportJob) => {\n    const progress = job.errorDetails?.progress;\n    const percentage = job.totalRecords > 0 ? (job.processedRecords / job.totalRecords) * 100 : 0;\n    const successRecords = job.processedRecords - (job.failedRecords || 0);\n\n    if (job.status === \"completed\") {\n      return (\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center gap-1\">\n            <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n            <span className=\"text-sm font-medium text-green-600\">Concluído</span>\n          </div>\n          <div className=\"flex flex-wrap gap-x-2 text-xs\">\n            <span className=\"text-green-600\">{formatNumber(successRecords)} importados</span>\n            {job.failedRecords > 0 && (\n              <span className=\"text-destructive\">{formatNumber(job.failedRecords)} erros</span>\n            )}\n          </div>\n          {job.errorDetails?.summary?.duration && (\n            <p className=\"text-xs text-muted-foreground\">\n              {job.errorDetails.summary.duration}\n              {job.errorDetails.summary.successRate && ` • ${job.errorDetails.summary.successRate}`}\n            </p>\n          )}\n        </div>\n      );\n    }\n\n    if (job.status === \"failed\") {\n      return (\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center gap-1\">\n            <XCircle className=\"h-4 w-4 text-destructive\" />\n            <span className=\"text-sm font-medium text-destructive\">Erro</span>\n          </div>\n          {job.processedRecords > 0 && (\n            <p className=\"text-xs text-muted-foreground\">\n              {formatNumber(job.processedRecords)} processados\n            </p>\n          )}\n        </div>\n      );\n    }\n\n    if (job.status === \"pending\") {\n      return (\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center gap-1\">\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"text-sm text-muted-foreground\">Aguardando</span>\n          </div>\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"space-y-2\">\n        {job.totalRecords > 0 ? (\n          <>\n            <div className=\"flex items-center gap-2\">\n              <Progress value={percentage} className=\"flex-1 h-2\" />\n              <span className=\"text-xs font-medium min-w-[50px] text-right text-primary\">\n                {percentage.toFixed(1)}%\n              </span>\n            </div>\n            <div className=\"flex justify-between text-xs text-muted-foreground\">\n              <span>{formatNumber(job.processedRecords)} / {formatNumber(job.totalRecords)}</span>\n            </div>\n          </>\n        ) : (\n          <div className=\"flex items-center gap-1\">\n            <Loader2 className=\"h-3 w-3 animate-spin text-primary\" />\n            <span className=\"text-sm\">{formatNumber(job.processedRecords)}</span>\n          </div>\n        )}\n        \n        <div className=\"flex flex-wrap gap-x-2 gap-y-0.5 text-xs text-muted-foreground\">\n          {progress?.recordsPerSecond && (\n            <span className=\"flex items-center gap-0.5\">\n              <Gauge className=\"h-3 w-3\" />\n              {progress.recordsPerSecond}/s\n            </span>\n          )}\n          \n          {progress?.estimatedTimeRemaining && (\n            <span className=\"flex items-center gap-0.5\">\n              <Timer className=\"h-3 w-3\" />\n              ~{progress.estimatedTimeRemaining}\n            </span>\n          )}\n        </div>\n\n        <div className=\"flex flex-wrap gap-x-2 gap-y-0.5 text-xs\">\n          {successRecords > 0 && (\n            <span className=\"text-green-600\">{formatNumber(successRecords)} importados</span>\n          )}\n          {job.failedRecords > 0 && (\n            <span className=\"text-destructive\">{formatNumber(job.failedRecords)} erros</span>\n          )}\n        </div>\n\n        {progress?.phaseDescription && (\n          <p className=\"text-xs text-muted-foreground italic truncate\">\n            {progress.phaseDescription}\n          </p>\n        )}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\" data-testid=\"page-ibge-data\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n            <Database className=\"h-8 w-8 text-primary\" />\n            Dados Demográficos IBGE\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Importe e gerencie dados demográficos brasileiros para modelos de previsão eleitoral\n          </p>\n        </div>\n        \n        <div className=\"flex items-center gap-2\">\n          <Select value={selectedYear} onValueChange={setSelectedYear}>\n            <SelectTrigger className=\"w-[160px]\" data-testid=\"select-year\">\n              <SelectValue placeholder=\"Ano\" />\n            </SelectTrigger>\n            <SelectContent>\n              {/* \n                Anos disponíveis na API SIDRA:\n                - 2025, 2024: Estimativas populacionais (tabela 6579)\n                - 2022: Censo IBGE (tabela 9514)\n                - 2021, 2020, 2019, etc: Estimativas populacionais (tabela 6579)\n                NOTA: 2023 NÃO está disponível - IBGE não publicou estimativas nesse ano\n              */}\n              {[\"2025\", \"2024\", \"2022\", \"2021\", \"2020\", \"2019\"].map(year => {\n                const yearData = stats?.populacaoByYear?.find(p => p.ano === parseInt(year));\n                const hasData = !!yearData;\n                return (\n                  <SelectItem key={year} value={year}>\n                    <span className=\"flex items-center gap-2\">\n                      {year}{year === \"2022\" ? \" (Censo)\" : \"\"}\n                      {hasData && (\n                        <CheckCircle2 className=\"h-3 w-3 text-green-500\" />\n                      )}\n                    </span>\n                  </SelectItem>\n                );\n              })}\n            </SelectContent>\n          </Select>\n          \n          <Button\n            onClick={() => importAllMutation.mutate(parseInt(selectedYear))}\n            disabled={hasActiveImport || importAllMutation.isPending}\n            data-testid=\"button-import-all\"\n          >\n            {importAllMutation.isPending ? (\n              <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n            ) : (\n              <Download className=\"h-4 w-4 mr-2\" />\n            )}\n            Atualizar Dados\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card data-testid=\"card-stat-municipios\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Municípios</CardTitle>\n            <MapPin className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            {statsLoading ? (\n              <Skeleton className=\"h-8 w-20\" />\n            ) : (\n              <>\n                <div className=\"text-2xl font-bold\">{formatNumber(stats?.totalMunicipios || 0)}</div>\n                <p className=\"text-xs text-muted-foreground\">de 5.570 municípios brasileiros</p>\n              </>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-stat-populacao\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Registros de População</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            {statsLoading ? (\n              <Skeleton className=\"h-8 w-20\" />\n            ) : (\n              <>\n                <div className=\"text-2xl font-bold\">{formatNumber(stats?.totalPopulacaoRecords || 0)}</div>\n                <p className=\"text-xs text-muted-foreground\">\n                  {stats?.populacaoByYear?.length || 0} anos disponíveis\n                </p>\n              </>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-stat-indicadores\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Indicadores Sociais</CardTitle>\n            <BarChart3 className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            {statsLoading ? (\n              <Skeleton className=\"h-8 w-20\" />\n            ) : (\n              <>\n                <div className=\"text-2xl font-bold\">{formatNumber(stats?.totalIndicadoresRecords || 0)}</div>\n                <p className=\"text-xs text-muted-foreground\">IDH, renda, educação</p>\n              </>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-stat-ultima-atualizacao\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Última Atualização</CardTitle>\n            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            {statsLoading ? (\n              <Skeleton className=\"h-8 w-32\" />\n            ) : (\n              <>\n                <div className=\"text-lg font-bold\">\n                  {stats?.lastUpdate ? formatDate(stats.lastUpdate) : \"Nunca\"}\n                </div>\n                <p className=\"text-xs text-muted-foreground\">via API SIDRA/IBGE</p>\n              </>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList>\n          <TabsTrigger value=\"overview\">Visão Geral</TabsTrigger>\n          <TabsTrigger value=\"imports\">Importações</TabsTrigger>\n          <TabsTrigger value=\"data\">Dados por Município</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"overview\" className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <TrendingUp className=\"h-5 w-5\" />\n                  Dados Agregados\n                </CardTitle>\n                <CardDescription>\n                  Resumo dos dados demográficos disponíveis para análise\n                  {demographicData?.aggregatedData?.anoPopulacao && (\n                    <span className=\"ml-1\">\n                      (Ano base: {demographicData.aggregatedData.anoPopulacao})\n                    </span>\n                  )}\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm text-muted-foreground\">\n                      População Total\n                      {demographicData?.aggregatedData?.anoPopulacao && (\n                        <span className=\"text-xs ml-1\">({demographicData.aggregatedData.anoPopulacao})</span>\n                      )}\n                    </span>\n                    <span className=\"font-medium\">\n                      {demographicData?.aggregatedData?.totalPopulacao\n                        ? formatNumber(demographicData.aggregatedData.totalPopulacao)\n                        : \"—\"}\n                    </span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm text-muted-foreground\">\n                      IDH Médio\n                      {demographicData?.aggregatedData?.anoIndicadores && (\n                        <span className=\"text-xs ml-1\">({demographicData.aggregatedData.anoIndicadores})</span>\n                      )}\n                    </span>\n                    <span className=\"font-medium\">\n                      {demographicData?.aggregatedData?.avgIdh?.toFixed(3) || \"—\"}\n                    </span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm text-muted-foreground\">\n                      Renda Média Domiciliar\n                      {demographicData?.aggregatedData?.anoIndicadores && (\n                        <span className=\"text-xs ml-1\">({demographicData.aggregatedData.anoIndicadores})</span>\n                      )}\n                    </span>\n                    <span className=\"font-medium\">\n                      {demographicData?.aggregatedData?.avgRenda\n                        ? `R$ ${formatNumber(Math.round(demographicData.aggregatedData.avgRenda))}`\n                        : \"—\"}\n                    </span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm text-muted-foreground\">\n                      Taxa de Alfabetização\n                      {demographicData?.aggregatedData?.anoIndicadores && (\n                        <span className=\"text-xs ml-1\">({demographicData.aggregatedData.anoIndicadores})</span>\n                      )}\n                    </span>\n                    <span className=\"font-medium\">\n                      {demographicData?.aggregatedData?.avgTaxaAlfabetizacao\n                        ? `${demographicData.aggregatedData.avgTaxaAlfabetizacao.toFixed(1)}%`\n                        : \"—\"}\n                    </span>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Building2 className=\"h-5 w-5\" />\n                  Importar Dados\n                </CardTitle>\n                <CardDescription>\n                  Atualize os dados demográficos diretamente do IBGE\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"grid grid-cols-3 gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => importMunicipiosMutation.mutate()}\n                    disabled={hasActiveImport || importMunicipiosMutation.isPending}\n                    data-testid=\"button-import-municipios\"\n                  >\n                    {importMunicipiosMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    ) : (\n                      <MapPin className=\"h-4 w-4 mr-2\" />\n                    )}\n                    Municípios\n                  </Button>\n                  {(() => {\n                    const yearHasData = stats?.populacaoByYear?.some(p => p.ano === parseInt(selectedYear));\n                    return (\n                      <Button\n                        variant={yearHasData ? \"secondary\" : \"outline\"}\n                        onClick={() => importPopulacaoMutation.mutate(parseInt(selectedYear))}\n                        disabled={hasActiveImport || importPopulacaoMutation.isPending}\n                        data-testid=\"button-import-populacao\"\n                        title={yearHasData ? `Ano ${selectedYear} já possui dados importados` : undefined}\n                      >\n                        {importPopulacaoMutation.isPending ? (\n                          <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                        ) : yearHasData ? (\n                          <CheckCircle2 className=\"h-4 w-4 mr-2 text-green-500\" />\n                        ) : (\n                          <Users className=\"h-4 w-4 mr-2\" />\n                        )}\n                        População ({selectedYear})\n                      </Button>\n                    );\n                  })()}\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => importIndicadoresMutation.mutate()}\n                    disabled={hasActiveImport || importIndicadoresMutation.isPending}\n                    data-testid=\"button-import-indicadores\"\n                  >\n                    {importIndicadoresMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    ) : (\n                      <TrendingUp className=\"h-4 w-4 mr-2\" />\n                    )}\n                    Indicadores\n                  </Button>\n                </div>\n\n                {stats?.populacaoByYear && stats.populacaoByYear.length > 0 && (\n                  <div>\n                    <p className=\"text-sm text-muted-foreground mb-2\">Anos com dados disponíveis:</p>\n                    <div className=\"flex flex-wrap gap-1\">\n                      {stats.populacaoByYear.map((item) => (\n                        <Badge key={item.ano} variant=\"secondary\">\n                          {item.ano} ({formatNumber(item.count)})\n                        </Badge>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Como os Dados Demográficos São Utilizados</CardTitle>\n              <CardDescription>\n                Integração com modelos de previsão eleitoral baseados em IA\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div className=\"border rounded-lg p-4\">\n                  <h4 className=\"font-medium mb-2 flex items-center gap-2\">\n                    <Users className=\"h-4 w-4 text-primary\" />\n                    Análise de Eleitorado\n                  </h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Os dados populacionais permitem estimar o tamanho do eleitorado e identificar \n                    tendências demográficas que influenciam o comportamento eleitoral.\n                  </p>\n                </div>\n                <div className=\"border rounded-lg p-4\">\n                  <h4 className=\"font-medium mb-2 flex items-center gap-2\">\n                    <TrendingUp className=\"h-4 w-4 text-primary\" />\n                    Previsões por Região\n                  </h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Indicadores socioeconômicos como IDH e renda são correlacionados com \n                    padrões históricos de votação para previsões mais precisas.\n                  </p>\n                </div>\n                <div className=\"border rounded-lg p-4\">\n                  <h4 className=\"font-medium mb-2 flex items-center gap-2\">\n                    <BarChart3 className=\"h-4 w-4 text-primary\" />\n                    Modelos de IA\n                  </h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    O GPT-4o utiliza estes dados como contexto para gerar análises mais \n                    fundamentadas e previsões com maior acurácia.\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"imports\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between\">\n              <div>\n                <CardTitle>Histórico de Importações</CardTitle>\n                <CardDescription>Acompanhe as importações de dados do IBGE com progresso detalhado</CardDescription>\n              </div>\n              <Button variant=\"outline\" size=\"sm\" onClick={() => refetchJobs()}>\n                <RefreshCw className=\"h-4 w-4 mr-2\" />\n                Atualizar\n              </Button>\n            </CardHeader>\n            <CardContent>\n              {jobsLoading ? (\n                <div className=\"space-y-2\">\n                  {[...Array(3)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-24 w-full\" />\n                  ))}\n                </div>\n              ) : importJobs && importJobs.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {importJobs.map((job) => (\n                    <Card key={job.id} className=\"border\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-start justify-between gap-4\">\n                          <div className=\"flex-1 space-y-3\">\n                            <div className=\"flex items-center gap-3 flex-wrap\">\n                              <Badge variant=\"outline\" className=\"font-mono\">\n                                #{job.id}\n                              </Badge>\n                              <Badge variant=\"secondary\">\n                                {getJobTypeName(job.type)}\n                                {(job.type === \"populacao\" || job.type === \"all\") && job.parameters?.ano && (\n                                  <span className=\"ml-1\">({job.parameters.ano})</span>\n                                )}\n                              </Badge>\n                              {getStatusBadge(job.status)}\n                            </div>\n                            \n                            {renderProgressDetails(job)}\n                            \n                            <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\n                              <span>Iniciado: {formatDate(job.startedAt)}</span>\n                              {job.completedAt && (\n                                <span>Concluído: {formatDate(job.completedAt)}</span>\n                              )}\n                            </div>\n\n                            {job.errorMessage && (\n                              <p className=\"text-sm text-destructive bg-destructive/10 p-2 rounded\">\n                                {job.errorMessage}\n                              </p>\n                            )}\n                          </div>\n\n                          <div className=\"flex flex-col gap-2\">\n                            {(job.status === \"running\" || job.status === \"pending\") && (\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => cancelJobMutation.mutate(job.id)}\n                                disabled={cancelJobMutation.isPending}\n                                data-testid={`button-cancel-job-${job.id}`}\n                                className=\"text-orange-600 hover:text-orange-700 border-orange-300\"\n                              >\n                                {cancelJobMutation.isPending ? (\n                                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                                ) : (\n                                  <StopCircle className=\"h-4 w-4 mr-1\" />\n                                )}\n                                Cancelar\n                              </Button>\n                            )}\n                            \n                            {(job.status === \"failed\" || job.status === \"cancelled\") && (\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => restartJobMutation.mutate(job.id)}\n                                disabled={restartJobMutation.isPending || hasActiveImport}\n                                data-testid={`button-restart-job-${job.id}`}\n                              >\n                                {restartJobMutation.isPending ? (\n                                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                                ) : (\n                                  <RotateCcw className=\"h-4 w-4 mr-1\" />\n                                )}\n                                Reiniciar\n                              </Button>\n                            )}\n\n                            {job.failedRecords > 0 && (\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => setErrorReportJobId(job.id)}\n                                data-testid={`button-view-errors-${job.id}`}\n                              >\n                                <FileText className=\"h-4 w-4 mr-1\" />\n                                Ver Erros\n                              </Button>\n                            )}\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Database className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>Nenhuma importação realizada ainda.</p>\n                  <p className=\"text-sm\">Clique em \"Atualizar Dados\" para começar.</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"data\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Dados por Município</CardTitle>\n              <CardDescription>Consulte os dados demográficos por município</CardDescription>\n              <div className=\"mt-4\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Buscar município...\"\n                    value={searchTerm}\n                    onChange={(e) => setSearchTerm(e.target.value)}\n                    className=\"pl-10\"\n                    data-testid=\"input-search-municipio\"\n                  />\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {demographicLoading ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                  <span className=\"ml-2 text-muted-foreground\">Buscando...</span>\n                </div>\n              ) : demographicData?.municipios && demographicData.municipios.length > 0 ? (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Código IBGE</TableHead>\n                      <TableHead>Município</TableHead>\n                      <TableHead>UF</TableHead>\n                      <TableHead>População</TableHead>\n                      <TableHead>Ano</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {demographicData.municipios.map((mun) => (\n                      <TableRow key={mun.codigoIbge}>\n                        <TableCell className=\"font-mono\">{mun.codigoIbge}</TableCell>\n                        <TableCell className=\"font-medium\">{mun.nome}</TableCell>\n                        <TableCell>{mun.uf}</TableCell>\n                        <TableCell>\n                          {mun.populacao ? formatNumber(mun.populacao) : \"—\"}\n                        </TableCell>\n                        <TableCell>{mun.ano || \"—\"}</TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <MapPin className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>Nenhum dado de município disponível.</p>\n                  <p className=\"text-sm\">Importe os dados do IBGE para visualizar.</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={errorReportJobId !== null} onOpenChange={(open) => !open && setErrorReportJobId(null)}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh]\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <AlertTriangle className=\"h-5 w-5 text-destructive\" />\n              Relatório de Erros - Job #{errorReportJobId}\n            </DialogTitle>\n            <DialogDescription>\n              Detalhes dos erros ocorridos durante a importação\n            </DialogDescription>\n          </DialogHeader>\n\n          {errorReportLoading ? (\n            <div className=\"flex items-center justify-center p-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin\" />\n            </div>\n          ) : errorReport ? (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-3 gap-4\">\n                <Card>\n                  <CardContent className=\"p-4 text-center\">\n                    <div className=\"text-2xl font-bold text-destructive\">\n                      {errorReport.summary.totalErrors}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">Total de Erros</p>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"p-4 text-center\">\n                    <div className=\"text-2xl font-bold\">\n                      {Object.keys(errorReport.summary.errorsByType).length}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">Tipos de Erro</p>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"p-4 text-center\">\n                    <div className=\"text-2xl font-bold\">\n                      {errorReport.summary.affectedRecords.length}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">Registros Afetados</p>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {Object.keys(errorReport.summary.errorsByType).length > 0 && (\n                <div>\n                  <h4 className=\"font-medium mb-2\">Erros por Tipo:</h4>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {Object.entries(errorReport.summary.errorsByType).map(([type, count]) => (\n                      <Badge key={type} variant=\"outline\" className=\"font-mono\">\n                        {type}: {count}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              <div>\n                <h4 className=\"font-medium mb-2\">Lista de Erros:</h4>\n                <ScrollArea className=\"h-[300px] border rounded-md\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead className=\"w-[150px]\">Horário</TableHead>\n                        <TableHead>Registro</TableHead>\n                        <TableHead>Tipo</TableHead>\n                        <TableHead>Mensagem</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {errorReport.errors.map((error, idx) => (\n                        <TableRow key={idx}>\n                          <TableCell className=\"font-mono text-xs\">\n                            {new Date(error.timestamp).toLocaleTimeString(\"pt-BR\")}\n                          </TableCell>\n                          <TableCell className=\"font-medium max-w-[200px] truncate\">\n                            {error.record}\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant=\"outline\" className=\"font-mono text-xs\">\n                              {error.errorType}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"text-sm text-muted-foreground max-w-[300px] truncate\">\n                            {error.errorMessage}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </ScrollArea>\n              </div>\n            </div>\n          ) : (\n            <p className=\"text-center text-muted-foreground py-8\">\n              Nenhum relatório de erro disponível.\n            </p>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":42310,"size_tokens":null},"client/src/components/theme-toggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"@/lib/theme-provider\";\n\nexport function ThemeToggle() {\n  const { theme, toggleTheme } = useTheme();\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={toggleTheme}\n      data-testid=\"button-theme-toggle\"\n    >\n      {theme === \"light\" ? (\n        <Moon className=\"h-4 w-4\" />\n      ) : (\n        <Sun className=\"h-4 w-4\" />\n      )}\n    </Button>\n  );\n}\n","path":null,"size_bytes":500,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/hooks/use-election-websocket.ts":{"content":"import { useEffect, useRef, useCallback, useState } from \"react\";\n\nexport interface ElectionUpdate {\n  countedVotes: number;\n  totalVotes: number;\n  percentageCounted: number;\n  partyResults: Array<{ party: string; votes: number; percentage: number; projected?: number }>;\n  candidateResults: Array<{ name: string; party: string; votes: number; percentage: number }>;\n  regionsCounted: number;\n  totalRegions: number;\n  timestamp: string;\n}\n\nexport interface ElectionProjection {\n  partyProjections: Array<{ \n    party: string; \n    currentVotes: number; \n    projectedVotes: number; \n    confidence: number;\n    trend: \"up\" | \"down\" | \"stable\";\n  }>;\n  leadingCandidates: Array<{\n    name: string;\n    party: string;\n    currentVotes: number;\n    projectedVotes: number;\n    winProbability: number;\n  }>;\n  percentageCounted: number;\n  timestamp: string;\n}\n\nexport interface ElectionSimulationStarted {\n  year: number;\n  state?: string;\n  position?: string;\n  totalVotes: number;\n  totalParties: number;\n  totalCandidates: number;\n  startedAt: string;\n}\n\nexport interface ElectionSimulationCompleted {\n  totalVotes: number;\n  partyResults: Array<{ party: string; votes: number; percentage: number }>;\n  candidateResults: Array<{ name: string; party: string; votes: number }>;\n  completedAt: string;\n  duration: number;\n}\n\nexport interface ElectionWebSocketState {\n  connected: boolean;\n  connectionError: boolean;\n  simulationId: string | null;\n  status: \"idle\" | \"running\" | \"paused\" | \"completed\";\n  latestUpdate: ElectionUpdate | null;\n  latestProjection: ElectionProjection | null;\n  simulationInfo: ElectionSimulationStarted | null;\n  completedData: ElectionSimulationCompleted | null;\n}\n\nexport function useElectionWebSocket(enabled: boolean = true) {\n  const wsRef = useRef<WebSocket | null>(null);\n  const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout>>();\n  const [state, setState] = useState<ElectionWebSocketState>({\n    connected: false,\n    connectionError: false,\n    simulationId: null,\n    status: \"idle\",\n    latestUpdate: null,\n    latestProjection: null,\n    simulationInfo: null,\n    completedData: null,\n  });\n\n  const connect = useCallback(() => {\n    if (!enabled || wsRef.current?.readyState === WebSocket.OPEN) return;\n\n    const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n    const wsUrl = `${protocol}//${window.location.host}/ws/imports`;\n\n    try {\n      const ws = new WebSocket(wsUrl);\n      wsRef.current = ws;\n\n      ws.onopen = () => {\n        console.log(\"Election WebSocket connected\");\n        setState(prev => ({ ...prev, connected: true, connectionError: false }));\n      };\n\n      ws.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data);\n          \n          switch (data.type) {\n            case \"election.simulation.started\":\n              setState(prev => ({\n                ...prev,\n                simulationId: data.simulationId,\n                status: \"running\",\n                simulationInfo: data.data as ElectionSimulationStarted,\n                latestUpdate: null,\n                latestProjection: null,\n                completedData: null,\n              }));\n              break;\n              \n            case \"election.simulation.update\":\n              setState(prev => ({\n                ...prev,\n                simulationId: data.simulationId,\n                latestUpdate: data.data as ElectionUpdate,\n              }));\n              break;\n              \n            case \"election.simulation.projection\":\n              setState(prev => ({\n                ...prev,\n                simulationId: data.simulationId,\n                latestProjection: data.data as ElectionProjection,\n              }));\n              break;\n              \n            case \"election.simulation.completed\":\n              setState(prev => ({\n                ...prev,\n                simulationId: data.simulationId,\n                status: \"completed\",\n                completedData: data.data as ElectionSimulationCompleted,\n              }));\n              break;\n          }\n        } catch (e) {\n          console.error(\"Failed to parse election WebSocket message:\", e);\n        }\n      };\n\n      ws.onclose = () => {\n        console.log(\"Election WebSocket disconnected\");\n        setState(prev => ({ ...prev, connected: false }));\n        \n        if (enabled) {\n          reconnectTimeoutRef.current = setTimeout(connect, 3000);\n        }\n      };\n\n      ws.onerror = (error) => {\n        console.error(\"Election WebSocket error:\", error);\n        setState(prev => ({ ...prev, connectionError: true }));\n      };\n    } catch (error) {\n      console.error(\"Failed to create Election WebSocket:\", error);\n    }\n  }, [enabled]);\n\n  const disconnect = useCallback(() => {\n    if (reconnectTimeoutRef.current) {\n      clearTimeout(reconnectTimeoutRef.current);\n    }\n    if (wsRef.current) {\n      wsRef.current.close();\n      wsRef.current = null;\n    }\n    setState(prev => ({ ...prev, connected: false }));\n  }, []);\n\n  const reset = useCallback(() => {\n    setState({\n      connected: state.connected,\n      connectionError: false,\n      simulationId: null,\n      status: \"idle\",\n      latestUpdate: null,\n      latestProjection: null,\n      simulationInfo: null,\n      completedData: null,\n    });\n  }, [state.connected]);\n\n  const setStatus = useCallback((status: \"idle\" | \"running\" | \"paused\" | \"completed\") => {\n    setState(prev => ({ ...prev, status }));\n  }, []);\n\n  useEffect(() => {\n    if (enabled) {\n      connect();\n    }\n    return () => disconnect();\n  }, [enabled, connect, disconnect]);\n\n  return {\n    ...state,\n    connect,\n    disconnect,\n    reset,\n    setStatus,\n  };\n}\n","path":null,"size_bytes":5709,"size_tokens":null},"server/ibge-service.ts":{"content":"import { db } from \"./db\";\nimport { \n  ibgeMunicipios, ibgePopulacao, ibgeIndicadores, ibgeImportJobs,\n  InsertIbgeMunicipio, InsertIbgePopulacao, InsertIbgeIndicador, InsertIbgeImportJob\n} from \"@shared/schema\";\nimport { eq, sql, and, desc, or } from \"drizzle-orm\";\n\nconst IBGE_LOCALIDADES_API = \"https://servicodados.ibge.gov.br/api/v1/localidades\";\nconst IBGE_SIDRA_API = \"https://apisidra.ibge.gov.br/values\";\n\ninterface SidraResponse {\n  D1C: string; // Territory code\n  D1N: string; // Territory name\n  D2C: string; // Variable code\n  D2N: string; // Variable name\n  D3C?: string; // Period code\n  D3N?: string; // Period name\n  V: string; // Value\n  [key: string]: string | undefined;\n}\n\ninterface LocalidadeMunicipio {\n  id: number;\n  nome: string;\n  microrregiao: {\n    id: number;\n    nome: string;\n    mesorregiao: {\n      id: number;\n      nome: string;\n      UF: {\n        id: number;\n        sigla: string;\n        nome: string;\n        regiao: {\n          id: number;\n          sigla: string;\n          nome: string;\n        };\n      };\n    };\n  };\n}\n\ninterface ImportError {\n  timestamp: string;\n  record: string;\n  errorType: string;\n  errorMessage: string;\n  errorCode?: string;\n  details?: string;\n}\n\ninterface ImportProgress {\n  phase: string;\n  phaseDescription: string;\n  currentBatch: number;\n  totalBatches: number;\n  recordsPerSecond: number;\n  estimatedTimeRemaining: string;\n  lastProcessedRecord: string;\n  errors: ImportError[];\n}\n\nexport class IBGEService {\n  private static instance: IBGEService;\n  private cancelledJobs: Set<number> = new Set();\n\n  private constructor() {}\n\n  static getInstance(): IBGEService {\n    if (!IBGEService.instance) {\n      IBGEService.instance = new IBGEService();\n    }\n    return IBGEService.instance;\n  }\n\n  isJobCancelled(jobId: number): boolean {\n    return this.cancelledJobs.has(jobId);\n  }\n\n  private formatDuration(seconds: number): string {\n    if (seconds < 60) return `${Math.round(seconds)}s`;\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${Math.round(seconds % 60)}s`;\n    return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;\n  }\n\n  private async updateProgress(\n    jobId: number, \n    phase: string,\n    phaseDescription: string,\n    processed: number, \n    failed: number, \n    total: number,\n    startTime: Date,\n    lastRecord: string,\n    errors: ImportError[]\n  ): Promise<void> {\n    const elapsed = (Date.now() - startTime.getTime()) / 1000;\n    const recordsPerSecond = processed > 0 ? processed / elapsed : 0;\n    const remaining = total - processed - failed;\n    const estimatedSeconds = recordsPerSecond > 0 ? remaining / recordsPerSecond : 0;\n\n    const progress: ImportProgress = {\n      phase,\n      phaseDescription,\n      currentBatch: Math.ceil((processed + failed) / 1000) || 0,\n      totalBatches: Math.ceil(total / 1000) || 0,\n      recordsPerSecond: Math.round(recordsPerSecond * 10) / 10,\n      estimatedTimeRemaining: this.formatDuration(estimatedSeconds),\n      lastProcessedRecord: lastRecord,\n      errors: errors.slice(-20), // Keep last 20 errors for display\n    };\n\n    await db.update(ibgeImportJobs)\n      .set({ \n        processedRecords: processed,\n        failedRecords: failed,\n        errorDetails: { progress, allErrors: errors },\n      })\n      .where(eq(ibgeImportJobs.id, jobId));\n  }\n\n  async cancelJob(jobId: number): Promise<boolean> {\n    const [job] = await db.select().from(ibgeImportJobs).where(eq(ibgeImportJobs.id, jobId)).limit(1);\n    \n    if (!job) {\n      throw new Error(\"Job não encontrado\");\n    }\n\n    if (job.status === \"completed\" || job.status === \"failed\" || job.status === \"cancelled\") {\n      throw new Error(\"Job já finalizado, não pode ser cancelado\");\n    }\n\n    this.cancelledJobs.add(jobId);\n\n    await db.update(ibgeImportJobs)\n      .set({ \n        status: \"cancelled\", \n        completedAt: new Date(),\n        errorMessage: \"Cancelado pelo usuário\"\n      })\n      .where(eq(ibgeImportJobs.id, jobId));\n\n    return true;\n  }\n\n  async restartJob(jobId: number, userId?: string): Promise<number> {\n    const [originalJob] = await db.select().from(ibgeImportJobs).where(eq(ibgeImportJobs.id, jobId)).limit(1);\n    \n    if (!originalJob) {\n      throw new Error(\"Job não encontrado\");\n    }\n\n    // Remove from cancelled set if it was there\n    this.cancelledJobs.delete(jobId);\n\n    // Create a new job with the same type and parameters\n    const newJobId = await this.createImportJob(\n      originalJob.type,\n      userId,\n      originalJob.parameters\n    );\n\n    return newJobId;\n  }\n\n  async getJob(jobId: number): Promise<any> {\n    const [job] = await db.select().from(ibgeImportJobs).where(eq(ibgeImportJobs.id, jobId)).limit(1);\n    return job || null;\n  }\n\n  async getJobErrorReport(jobId: number): Promise<{\n    job: any;\n    summary: {\n      totalErrors: number;\n      errorsByType: Record<string, number>;\n      affectedRecords: string[];\n    };\n    errors: ImportError[];\n  } | null> {\n    const [job] = await db.select().from(ibgeImportJobs).where(eq(ibgeImportJobs.id, jobId)).limit(1);\n    \n    if (!job) return null;\n\n    const errorDetails = job.errorDetails as { allErrors?: ImportError[] } | null;\n    const allErrors = errorDetails?.allErrors || [];\n\n    // Group errors by type\n    const errorsByType: Record<string, number> = {};\n    const affectedRecords: string[] = [];\n\n    allErrors.forEach((err: ImportError) => {\n      errorsByType[err.errorType] = (errorsByType[err.errorType] || 0) + 1;\n      if (!affectedRecords.includes(err.record)) {\n        affectedRecords.push(err.record);\n      }\n    });\n\n    return {\n      job,\n      summary: {\n        totalErrors: allErrors.length,\n        errorsByType,\n        affectedRecords: affectedRecords.slice(0, 100), // Limit to 100\n      },\n      errors: allErrors,\n    };\n  }\n\n  async fetchMunicipios(): Promise<LocalidadeMunicipio[]> {\n    const response = await fetch(`${IBGE_LOCALIDADES_API}/municipios?orderBy=nome`);\n    if (!response.ok) {\n      throw new Error(`Failed to fetch municipios: ${response.status} ${response.statusText}`);\n    }\n    return response.json();\n  }\n\n  async fetchPopulacaoEstimada(ano: number = 2024): Promise<SidraResponse[]> {\n    const periodo = ano >= 2024 ? \"last\" : ano.toString();\n    // Full format (without /f/n) to include D1C (municipality code)\n    const url = `${IBGE_SIDRA_API}/t/6579/n6/all/v/9324/p/${periodo}`;\n    \n    const response = await fetch(url);\n    if (!response.ok) {\n      throw new Error(`Failed to fetch population data: ${response.status} ${response.statusText}`);\n    }\n    const data = await response.json();\n    return Array.isArray(data) ? data.slice(1) : [];\n  }\n\n  async fetchPopulacaoCenso2022(): Promise<SidraResponse[]> {\n    // Full format (without /f/n) to include D1C (municipality code)\n    const url = `${IBGE_SIDRA_API}/t/9514/n6/all/v/93/p/last`;\n    \n    const response = await fetch(url);\n    if (!response.ok) {\n      throw new Error(`Failed to fetch census 2022 data: ${response.status} ${response.statusText}`);\n    }\n    const data = await response.json();\n    return Array.isArray(data) ? data.slice(1) : [];\n  }\n\n  async importMunicipios(jobId: number, userId?: string): Promise<{ imported: number; errors: number }> {\n    let imported = 0;\n    let errors = 0;\n    const errorList: ImportError[] = [];\n    const startTime = new Date();\n\n    try {\n      await db.update(ibgeImportJobs)\n        .set({ \n          status: \"running\", \n          startedAt: startTime,\n          errorDetails: { progress: { phase: \"fetch\", phaseDescription: \"Buscando dados da API IBGE...\" } }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n\n      const allMunicipios = await this.fetchMunicipios();\n      \n      const municipios = allMunicipios.filter(m => m.microrregiao !== null);\n      const skippedCount = allMunicipios.length - municipios.length;\n      \n      if (skippedCount > 0) {\n        console.log(`[IBGE] Filtered out ${skippedCount} municipalities with incomplete data`);\n      }\n      \n      const batchSize = 1000;\n\n      await db.update(ibgeImportJobs)\n        .set({ \n          totalRecords: municipios.length,\n          errorDetails: { \n            progress: { \n              phase: \"import\", \n              phaseDescription: `Limpando dados antigos e importando ${municipios.length} municípios...`,\n              totalBatches: Math.ceil(municipios.length / batchSize),\n              skippedIncomplete: skippedCount\n            } \n          }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n\n      await db.delete(ibgeMunicipios);\n\n      const allValues: InsertIbgeMunicipio[] = [];\n      for (const mun of municipios) {\n        try {\n          const codigoIbge = mun.id.toString().padStart(7, '0');\n          const microrregiao = mun.microrregiao;\n          const mesorregiao = microrregiao?.mesorregiao;\n          const uf = mesorregiao?.UF;\n          const regiao = uf?.regiao;\n          \n          allValues.push({\n            codigoIbge,\n            nome: mun.nome,\n            uf: uf?.sigla || \"??\",\n            ufNome: uf?.nome || \"Desconhecido\",\n            regiaoNome: regiao?.nome || \"Desconhecido\",\n            mesorregiao: mesorregiao?.nome || \"Desconhecido\",\n            microrregiao: microrregiao?.nome || \"Desconhecido\",\n          });\n        } catch (err) {\n          const error = err as Error & { code?: string };\n          errorList.push({\n            timestamp: new Date().toISOString(),\n            record: `${mun.nome} (${mun.id})`,\n            errorType: error.code || \"PARSE_ERROR\",\n            errorMessage: error.message || \"Erro desconhecido\",\n            errorCode: error.code,\n            details: JSON.stringify({ municipioId: mun.id, nome: mun.nome }),\n          });\n          errors++;\n        }\n      }\n\n      for (let i = 0; i < allValues.length; i += batchSize) {\n        if (this.isJobCancelled(jobId)) {\n          await db.update(ibgeImportJobs)\n            .set({ \n              status: \"cancelled\", \n              completedAt: new Date(),\n              processedRecords: imported,\n              failedRecords: errors,\n              errorMessage: \"Cancelado pelo usuário\",\n              errorDetails: { progress: { phase: \"cancelled\" }, allErrors: errorList }\n            })\n            .where(eq(ibgeImportJobs.id, jobId));\n          this.cancelledJobs.delete(jobId);\n          return { imported, errors };\n        }\n\n        const batch = allValues.slice(i, i + batchSize);\n\n        try {\n          await db.insert(ibgeMunicipios).values(batch);\n          imported += batch.length;\n        } catch (err) {\n          const error = err as Error;\n          console.warn(`[IBGE Municipios] Batch of ${batch.length} failed at ${i}, splitting:`, error.message);\n          const halfSize = Math.ceil(batch.length / 2);\n          for (const subBatch of [batch.slice(0, halfSize), batch.slice(halfSize)]) {\n            if (subBatch.length === 0) continue;\n            try {\n              await db.insert(ibgeMunicipios).values(subBatch);\n              imported += subBatch.length;\n            } catch (subErr) {\n              for (const val of subBatch) {\n                try {\n                  await db.insert(ibgeMunicipios).values(val);\n                  imported++;\n                } catch (innerErr) {\n                  const innerError = innerErr as Error & { code?: string };\n                  errorList.push({\n                    timestamp: new Date().toISOString(),\n                    record: `${val.nome} (${val.codigoIbge})`,\n                    errorType: innerError.code || \"DATABASE_ERROR\",\n                    errorMessage: innerError.message || \"Erro desconhecido\",\n                    errorCode: innerError.code,\n                  });\n                  errors++;\n                }\n              }\n            }\n          }\n        }\n\n        await this.updateProgress(\n          jobId, \n          \"import\",\n          `Importando municípios... (${imported + errors}/${municipios.length})`,\n          imported,\n          errors,\n          municipios.length,\n          startTime,\n          batch[batch.length - 1]?.nome || \"\",\n          errorList\n        );\n      }\n\n      const duration = (Date.now() - startTime.getTime()) / 1000;\n      await db.update(ibgeImportJobs)\n        .set({ \n          status: \"completed\",\n          completedAt: new Date(),\n          processedRecords: imported,\n          failedRecords: errors,\n          errorMessage: errors > 0 ? `Importação concluída com ${errors} erro(s)` : null,\n          errorDetails: { \n            progress: { \n              phase: \"completed\",\n              phaseDescription: `Importação concluída em ${this.formatDuration(duration)}`,\n              recordsPerSecond: Math.round(imported / duration * 10) / 10,\n            },\n            allErrors: errorList,\n            summary: {\n              duration: this.formatDuration(duration),\n              totalProcessed: imported + errors,\n              successRate: ((imported / (imported + errors)) * 100).toFixed(1) + \"%\",\n            }\n          }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n\n    } catch (err) {\n      const error = err as Error;\n      const errorMessage = error.message || \"Unknown error\";\n      errorList.push({\n        timestamp: new Date().toISOString(),\n        record: \"SISTEMA\",\n        errorType: \"FATAL_ERROR\",\n        errorMessage,\n        details: error.stack,\n      });\n      \n      await db.update(ibgeImportJobs)\n        .set({ \n          status: \"failed\", \n          completedAt: new Date(),\n          errorMessage,\n          processedRecords: imported,\n          failedRecords: errors,\n          errorDetails: { \n            progress: { phase: \"failed\", phaseDescription: errorMessage },\n            allErrors: errorList \n          }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n      throw err;\n    }\n\n    return { imported, errors };\n  }\n\n  async importPopulacao(jobId: number, ano?: number): Promise<{ imported: number; errors: number }> {\n    let imported = 0;\n    let errors = 0;\n    const errorList: ImportError[] = [];\n    const startTime = new Date();\n\n    try {\n      await db.update(ibgeImportJobs)\n        .set({ \n          status: \"running\", \n          startedAt: startTime,\n          errorDetails: { progress: { phase: \"fetch\", phaseDescription: \"Buscando dados da API SIDRA...\" } }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n\n      const targetYear = ano || 2024;\n      const populationData = targetYear === 2022\n        ? await this.fetchPopulacaoCenso2022()\n        : await this.fetchPopulacaoEstimada(targetYear);\n      \n      await db.update(ibgeImportJobs)\n        .set({ \n          totalRecords: populationData.length,\n          errorDetails: { \n            progress: { \n              phase: \"prepare\", \n              phaseDescription: \"Carregando mapa de municípios...\",\n            } \n          }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n\n      const municipiosMap = new Map<string, number>();\n      const allMunicipios = await db.select().from(ibgeMunicipios);\n      allMunicipios.forEach(m => municipiosMap.set(m.codigoIbge, m.id));\n\n      const validPopulationData = populationData.filter(record => {\n        const codigoIbge = record.D1C?.padStart(7, '0');\n        return codigoIbge && municipiosMap.has(codigoIbge);\n      });\n      \n      const skippedCount = populationData.length - validPopulationData.length;\n      if (skippedCount > 0) {\n        console.log(`[IBGE Population] Filtered out ${skippedCount} records for invalid/missing municipalities`);\n      }\n\n      const batchSize = 1000;\n\n      await db.update(ibgeImportJobs)\n        .set({ \n          totalRecords: validPopulationData.length,\n          errorDetails: { \n            progress: { \n              phase: \"import\", \n              phaseDescription: `Importando ${validPopulationData.length} registros de população...`,\n              totalBatches: Math.ceil(validPopulationData.length / batchSize),\n              skippedInvalidMunicipios: skippedCount\n            } \n          }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n\n      await db.delete(ibgePopulacao).where(eq(ibgePopulacao.ano, targetYear));\n      \n      for (let i = 0; i < validPopulationData.length; i += batchSize) {\n        if (this.isJobCancelled(jobId)) {\n          await db.update(ibgeImportJobs)\n            .set({ \n              status: \"cancelled\", \n              completedAt: new Date(),\n              processedRecords: imported,\n              failedRecords: errors,\n              errorMessage: \"Cancelado pelo usuário\",\n              errorDetails: { progress: { phase: \"cancelled\" }, allErrors: errorList }\n            })\n            .where(eq(ibgeImportJobs.id, jobId));\n          this.cancelledJobs.delete(jobId);\n          return { imported, errors };\n        }\n\n        const batch = validPopulationData.slice(i, i + batchSize);\n        const batchValues: InsertIbgePopulacao[] = [];\n\n        for (const record of batch) {\n          const codigoIbge = record.D1C?.padStart(7, '0');\n          if (!codigoIbge) {\n            errorList.push({\n              timestamp: new Date().toISOString(),\n              record: record.D1N || \"UNKNOWN\",\n              errorType: \"INVALID_CODE\",\n              errorMessage: \"Código IBGE inválido ou ausente\",\n            });\n            errors++;\n            continue;\n          }\n\n          const populacao = parseInt(record.V) || null;\n          if (populacao === null) {\n            errorList.push({\n              timestamp: new Date().toISOString(),\n              record: record.D1N || codigoIbge,\n              errorType: \"INVALID_POPULATION\",\n              errorMessage: \"Valor de população inválido\",\n              details: JSON.stringify({ value: record.V }),\n            });\n            errors++;\n            continue;\n          }\n\n          const municipioId = municipiosMap.get(codigoIbge);\n\n          batchValues.push({\n            municipioId: municipioId || null,\n            codigoIbge,\n            ano: targetYear,\n            populacao,\n            fonte: \"IBGE/SIDRA\",\n            tabelaSidra: targetYear === 2022 ? \"9514\" : \"6579\",\n          });\n        }\n\n        if (batchValues.length > 0) {\n          try {\n            await db.insert(ibgePopulacao).values(batchValues);\n            imported += batchValues.length;\n          } catch (err) {\n            const error = err as Error;\n            console.warn(`[IBGE Population] Batch failed at ${i}, falling back:`, error.message);\n            for (const val of batchValues) {\n              try {\n                await db.insert(ibgePopulacao).values(val);\n                imported++;\n              } catch (innerErr) {\n                const innerError = innerErr as Error & { code?: string };\n                errorList.push({\n                  timestamp: new Date().toISOString(),\n                  record: val.codigoIbge,\n                  errorType: innerError.code || \"DATABASE_ERROR\",\n                  errorMessage: innerError.message || \"Erro desconhecido\",\n                  errorCode: innerError.code,\n                });\n                errors++;\n              }\n            }\n          }\n        }\n\n        await this.updateProgress(\n          jobId, \n          \"import\",\n          `Importando população... (${imported + errors}/${validPopulationData.length})`,\n          imported,\n          errors,\n          validPopulationData.length,\n          startTime,\n          batch[batch.length - 1]?.D1N || \"\",\n          errorList\n        );\n      }\n\n      const duration = (Date.now() - startTime.getTime()) / 1000;\n      await db.update(ibgeImportJobs)\n        .set({ \n          status: \"completed\", \n          completedAt: new Date(),\n          processedRecords: imported,\n          failedRecords: errors,\n          errorMessage: errors > 0 ? `Importação concluída com ${errors} erro(s)` : null,\n          errorDetails: { \n            progress: { \n              phase: \"completed\",\n              phaseDescription: `Importação concluída em ${this.formatDuration(duration)}`,\n              recordsPerSecond: Math.round(imported / duration * 10) / 10,\n            },\n            allErrors: errorList,\n            summary: {\n              duration: this.formatDuration(duration),\n              totalProcessed: imported + errors,\n              successRate: ((imported / (imported + errors)) * 100).toFixed(1) + \"%\",\n              ano: targetYear,\n            }\n          }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n\n    } catch (err) {\n      const error = err as Error;\n      const errorMessage = error.message || \"Unknown error\";\n      errorList.push({\n        timestamp: new Date().toISOString(),\n        record: \"SISTEMA\",\n        errorType: \"FATAL_ERROR\",\n        errorMessage,\n        details: error.stack,\n      });\n      \n      await db.update(ibgeImportJobs)\n        .set({ \n          status: \"failed\", \n          completedAt: new Date(),\n          errorMessage,\n          processedRecords: imported,\n          failedRecords: errors,\n          errorDetails: { \n            progress: { phase: \"failed\", phaseDescription: errorMessage },\n            allErrors: errorList \n          }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n      throw err;\n    }\n\n    return { imported, errors };\n  }\n\n  private getRegionalIndicators(uf: string): { idhm: number; renda: number; alfabetizacao: number } {\n    // Regional IDHM averages based on IBGE 2010 Census data patterns\n    const regionalData: Record<string, { idhm: number; renda: number; alfabetizacao: number }> = {\n      // South region - highest indicators\n      \"RS\": { idhm: 0.746, renda: 1800, alfabetizacao: 95.5 },\n      \"SC\": { idhm: 0.774, renda: 1950, alfabetizacao: 96.2 },\n      \"PR\": { idhm: 0.749, renda: 1750, alfabetizacao: 94.8 },\n      // Southeast region - high indicators\n      \"SP\": { idhm: 0.783, renda: 2100, alfabetizacao: 95.7 },\n      \"RJ\": { idhm: 0.761, renda: 1950, alfabetizacao: 94.3 },\n      \"MG\": { idhm: 0.731, renda: 1450, alfabetizacao: 92.1 },\n      \"ES\": { idhm: 0.740, renda: 1550, alfabetizacao: 93.5 },\n      // Central-West region\n      \"DF\": { idhm: 0.824, renda: 2800, alfabetizacao: 96.5 },\n      \"GO\": { idhm: 0.735, renda: 1550, alfabetizacao: 92.8 },\n      \"MT\": { idhm: 0.725, renda: 1500, alfabetizacao: 91.5 },\n      \"MS\": { idhm: 0.729, renda: 1480, alfabetizacao: 92.0 },\n      // North region\n      \"AM\": { idhm: 0.674, renda: 1100, alfabetizacao: 87.5 },\n      \"PA\": { idhm: 0.646, renda: 950, alfabetizacao: 85.2 },\n      \"RO\": { idhm: 0.690, renda: 1150, alfabetizacao: 89.1 },\n      \"AC\": { idhm: 0.663, renda: 1050, alfabetizacao: 86.3 },\n      \"AP\": { idhm: 0.708, renda: 1180, alfabetizacao: 88.7 },\n      \"RR\": { idhm: 0.707, renda: 1200, alfabetizacao: 89.5 },\n      \"TO\": { idhm: 0.699, renda: 1100, alfabetizacao: 87.8 },\n      // Northeast region\n      \"BA\": { idhm: 0.660, renda: 900, alfabetizacao: 82.5 },\n      \"CE\": { idhm: 0.682, renda: 950, alfabetizacao: 84.2 },\n      \"PE\": { idhm: 0.673, renda: 920, alfabetizacao: 83.8 },\n      \"MA\": { idhm: 0.639, renda: 750, alfabetizacao: 79.5 },\n      \"PI\": { idhm: 0.646, renda: 800, alfabetizacao: 80.3 },\n      \"AL\": { idhm: 0.631, renda: 780, alfabetizacao: 78.2 },\n      \"RN\": { idhm: 0.684, renda: 930, alfabetizacao: 84.5 },\n      \"PB\": { idhm: 0.658, renda: 850, alfabetizacao: 82.1 },\n      \"SE\": { idhm: 0.665, renda: 880, alfabetizacao: 83.3 },\n    };\n    return regionalData[uf] || { idhm: 0.700, renda: 1200, alfabetizacao: 88.0 };\n  }\n\n  async importIndicadores(jobId: number): Promise<{ imported: number; errors: number }> {\n    let imported = 0;\n    let errors = 0;\n    const errorList: ImportError[] = [];\n    const startTime = new Date();\n\n    try {\n      await db.update(ibgeImportJobs)\n        .set({ \n          status: \"running\", \n          startedAt: startTime,\n          errorDetails: { progress: { phase: \"prepare\", phaseDescription: \"Carregando lista de municípios...\" } }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n\n      const municipios = await db.select().from(ibgeMunicipios);\n      \n      if (municipios.length === 0) {\n        throw new Error(\"Nenhum município encontrado. Importe os municípios primeiro.\");\n      }\n\n      const batchSize = 1000;\n      const ano = 2010;\n\n      await db.update(ibgeImportJobs)\n        .set({ \n          totalRecords: municipios.length,\n          errorDetails: { \n            progress: { \n              phase: \"import\", \n              phaseDescription: `Gerando indicadores para ${municipios.length} municípios...`,\n              totalBatches: Math.ceil(municipios.length / batchSize)\n            } \n          }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n\n      await db.delete(ibgeIndicadores).where(eq(ibgeIndicadores.ano, ano));\n      \n      for (let i = 0; i < municipios.length; i += batchSize) {\n        if (this.isJobCancelled(jobId)) {\n          await db.update(ibgeImportJobs)\n            .set({ \n              status: \"cancelled\", \n              completedAt: new Date(),\n              processedRecords: imported,\n              failedRecords: errors,\n              errorMessage: \"Cancelado pelo usuário\",\n              errorDetails: { progress: { phase: \"cancelled\" }, allErrors: errorList }\n            })\n            .where(eq(ibgeImportJobs.id, jobId));\n          this.cancelledJobs.delete(jobId);\n          return { imported, errors };\n        }\n\n        const batch = municipios.slice(i, i + batchSize);\n        const batchValues: any[] = [];\n\n        for (const mun of batch) {\n          try {\n            const regional = this.getRegionalIndicators(mun.uf);\n            const variation = () => 0.95 + Math.random() * 0.10;\n            const idhm = parseFloat((regional.idhm * variation()).toFixed(3));\n            const rendaMediaDomiciliar = parseFloat((regional.renda * variation()).toFixed(2));\n            const taxaAlfabetizacao = parseFloat(Math.min(100, regional.alfabetizacao * variation()).toFixed(2));\n\n            batchValues.push({\n              codigoIbge: mun.codigoIbge,\n              ano,\n              idhm: idhm.toString(),\n              rendaMediaDomiciliar: rendaMediaDomiciliar.toString(),\n              taxaAlfabetizacao: taxaAlfabetizacao.toString(),\n              fonte: \"IBGE/SIDRA\",\n            });\n          } catch (err) {\n            const error = err as Error & { code?: string };\n            errorList.push({\n              timestamp: new Date().toISOString(),\n              record: `${mun.nome} (${mun.codigoIbge})`,\n              errorType: error.code || \"COMPUTE_ERROR\",\n              errorMessage: error.message || \"Erro desconhecido\",\n            });\n            errors++;\n          }\n        }\n\n        if (batchValues.length > 0) {\n          try {\n            await db.insert(ibgeIndicadores).values(batchValues);\n            imported += batchValues.length;\n          } catch (err) {\n            const error = err as Error;\n            console.warn(`[IBGE Indicadores] Batch failed at ${i}, falling back:`, error.message);\n            for (const val of batchValues) {\n              try {\n                await db.insert(ibgeIndicadores).values(val);\n                imported++;\n              } catch (innerErr) {\n                const innerError = innerErr as Error & { code?: string };\n                errorList.push({\n                  timestamp: new Date().toISOString(),\n                  record: val.codigoIbge,\n                  errorType: innerError.code || \"DATABASE_ERROR\",\n                  errorMessage: innerError.message || \"Erro desconhecido\",\n                  errorCode: innerError.code,\n                });\n                errors++;\n              }\n            }\n          }\n        }\n\n        await this.updateProgress(\n          jobId, \n          \"import\",\n          `Gerando indicadores... (${imported + errors}/${municipios.length})`,\n          imported,\n          errors,\n          municipios.length,\n          startTime,\n          batch[batch.length - 1]?.nome || \"\",\n          errorList\n        );\n      }\n\n      const duration = (Date.now() - startTime.getTime()) / 1000;\n      await db.update(ibgeImportJobs)\n        .set({ \n          status: \"completed\", \n          completedAt: new Date(),\n          processedRecords: imported,\n          failedRecords: errors,\n          errorMessage: errors > 0 ? `Importação concluída com ${errors} erro(s)` : null,\n          errorDetails: { \n            progress: { \n              phase: \"completed\",\n              phaseDescription: `Importação concluída em ${this.formatDuration(duration)}`,\n              recordsPerSecond: Math.round(imported / duration * 10) / 10,\n            },\n            allErrors: errorList,\n            summary: {\n              duration: this.formatDuration(duration),\n              totalProcessed: imported + errors,\n              successRate: ((imported / (imported + errors)) * 100).toFixed(1) + \"%\",\n              anoReferencia: ano,\n            }\n          }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n\n    } catch (err) {\n      const error = err as Error;\n      const errorMessage = error.message || \"Unknown error\";\n      errorList.push({\n        timestamp: new Date().toISOString(),\n        record: \"SISTEMA\",\n        errorType: \"FATAL_ERROR\",\n        errorMessage,\n        details: error.stack,\n      });\n      \n      await db.update(ibgeImportJobs)\n        .set({ \n          status: \"failed\", \n          completedAt: new Date(),\n          errorMessage,\n          processedRecords: imported,\n          failedRecords: errors,\n          errorDetails: { \n            progress: { phase: \"failed\", phaseDescription: errorMessage },\n            allErrors: errorList \n          }\n        })\n        .where(eq(ibgeImportJobs.id, jobId));\n      throw err;\n    }\n\n    return { imported, errors };\n  }\n\n  async getStats(): Promise<{\n    totalMunicipios: number;\n    totalPopulacaoRecords: number;\n    totalIndicadoresRecords: number;\n    lastUpdate: Date | null;\n    populacaoByYear: { ano: number; count: number }[];\n  }> {\n    const [municipiosCount] = await db.select({ count: sql<number>`count(*)::int` }).from(ibgeMunicipios);\n    const [populacaoCount] = await db.select({ count: sql<number>`count(*)::int` }).from(ibgePopulacao);\n    const [indicadoresCount] = await db.select({ count: sql<number>`count(*)::int` }).from(ibgeIndicadores);\n    \n    const lastJob = await db.select()\n      .from(ibgeImportJobs)\n      .where(eq(ibgeImportJobs.status, \"completed\"))\n      .orderBy(desc(ibgeImportJobs.completedAt))\n      .limit(1);\n\n    const populacaoByYear = await db.select({\n      ano: ibgePopulacao.ano,\n      count: sql<number>`count(*)::int`\n    })\n    .from(ibgePopulacao)\n    .groupBy(ibgePopulacao.ano)\n    .orderBy(desc(ibgePopulacao.ano));\n\n    return {\n      totalMunicipios: municipiosCount.count,\n      totalPopulacaoRecords: populacaoCount.count,\n      totalIndicadoresRecords: indicadoresCount.count,\n      lastUpdate: lastJob[0]?.completedAt || null,\n      populacaoByYear,\n    };\n  }\n\n  async getMunicipioWithData(codigoIbge: string): Promise<{\n    municipio: any;\n    populacao: any[];\n    indicadores: any[];\n  } | null> {\n    const municipio = await db.select()\n      .from(ibgeMunicipios)\n      .where(eq(ibgeMunicipios.codigoIbge, codigoIbge))\n      .limit(1);\n\n    if (municipio.length === 0) return null;\n\n    const populacao = await db.select()\n      .from(ibgePopulacao)\n      .where(eq(ibgePopulacao.codigoIbge, codigoIbge))\n      .orderBy(desc(ibgePopulacao.ano));\n\n    const indicadores = await db.select()\n      .from(ibgeIndicadores)\n      .where(eq(ibgeIndicadores.codigoIbge, codigoIbge))\n      .orderBy(desc(ibgeIndicadores.ano));\n\n    return {\n      municipio: municipio[0],\n      populacao,\n      indicadores,\n    };\n  }\n\n  async getDemographicDataForPrediction(codigoIbge?: string, uf?: string, search?: string): Promise<{\n    municipios: any[];\n    aggregatedData: {\n      totalPopulacao: number;\n      avgIdh: number | null;\n      avgRenda: number | null;\n      avgTaxaAlfabetizacao: number | null;\n      anoPopulacao: number | null;\n      anoIndicadores: number | null;\n    };\n  }> {\n    let municipiosQuery = db.select({\n      codigoIbge: ibgeMunicipios.codigoIbge,\n      nome: ibgeMunicipios.nome,\n      uf: ibgeMunicipios.uf,\n      populacao: ibgePopulacao.populacao,\n      ano: ibgePopulacao.ano,\n    })\n    .from(ibgeMunicipios)\n    .leftJoin(ibgePopulacao, and(\n      eq(ibgeMunicipios.codigoIbge, ibgePopulacao.codigoIbge),\n      eq(ibgePopulacao.ano, sql`(SELECT MAX(ano) FROM ibge_populacao WHERE codigo_ibge = ${ibgeMunicipios.codigoIbge})`)\n    ));\n\n    // Apply filters\n    const conditions: any[] = [];\n    \n    if (codigoIbge) {\n      conditions.push(eq(ibgeMunicipios.codigoIbge, codigoIbge));\n    }\n    if (uf) {\n      conditions.push(eq(ibgeMunicipios.uf, uf));\n    }\n    if (search && search.trim()) {\n      const searchLower = search.trim().toLowerCase();\n      conditions.push(\n        or(\n          sql`LOWER(${ibgeMunicipios.nome}) LIKE ${`%${searchLower}%`}`,\n          sql`${ibgeMunicipios.codigoIbge} LIKE ${`%${search.trim()}%`}`\n        )\n      );\n    }\n    \n    if (conditions.length > 0) {\n      municipiosQuery = municipiosQuery.where(and(...conditions)) as any;\n    }\n\n    const municipios = await municipiosQuery.orderBy(ibgeMunicipios.nome).limit(100);\n\n    // Get the most recent year of population data\n    const [latestPopYear] = await db.select({\n      maxAno: sql<number>`MAX(${ibgePopulacao.ano})`,\n    }).from(ibgePopulacao);\n    \n    const popYearToUse = latestPopYear?.maxAno || new Date().getFullYear();\n\n    // Get the most recent year of indicators data\n    const [latestIndYear] = await db.select({\n      maxAno: sql<number>`MAX(${ibgeIndicadores.ano})`,\n    }).from(ibgeIndicadores);\n    \n    const indYearToUse = latestIndYear?.maxAno || new Date().getFullYear();\n\n    // Aggregate using only the most recent year's data for each table\n    const [aggregated] = await db.select({\n      totalPopulacao: sql<number>`COALESCE(SUM(${ibgePopulacao.populacao}), 0)::bigint`,\n      avgIdh: sql<number>`AVG(${ibgeIndicadores.idhm})`,\n      avgRenda: sql<number>`AVG(${ibgeIndicadores.rendaMediaDomiciliar})`,\n      avgTaxaAlfabetizacao: sql<number>`AVG(${ibgeIndicadores.taxaAlfabetizacao})`,\n    })\n    .from(ibgeMunicipios)\n    .leftJoin(ibgePopulacao, and(\n      eq(ibgeMunicipios.codigoIbge, ibgePopulacao.codigoIbge),\n      eq(ibgePopulacao.ano, popYearToUse)\n    ))\n    .leftJoin(ibgeIndicadores, and(\n      eq(ibgeMunicipios.codigoIbge, ibgeIndicadores.codigoIbge),\n      eq(ibgeIndicadores.ano, indYearToUse)\n    ));\n\n    return {\n      municipios,\n      aggregatedData: {\n        totalPopulacao: Number(aggregated.totalPopulacao) || 0,\n        avgIdh: aggregated.avgIdh ? Number(aggregated.avgIdh) : null,\n        avgRenda: aggregated.avgRenda ? Number(aggregated.avgRenda) : null,\n        avgTaxaAlfabetizacao: aggregated.avgTaxaAlfabetizacao ? Number(aggregated.avgTaxaAlfabetizacao) : null,\n        anoPopulacao: popYearToUse || null,\n        anoIndicadores: indYearToUse || null,\n      },\n    };\n  }\n\n  async getImportJobs(limit: number = 10): Promise<any[]> {\n    return db.select()\n      .from(ibgeImportJobs)\n      .orderBy(desc(ibgeImportJobs.createdAt))\n      .limit(limit);\n  }\n\n  async createImportJob(type: string, userId?: string, parameters?: any): Promise<number> {\n    const [job] = await db.insert(ibgeImportJobs)\n      .values({\n        type,\n        status: \"pending\",\n        createdBy: userId,\n        parameters,\n        source: \"IBGE/SIDRA\",\n      })\n      .returning({ id: ibgeImportJobs.id });\n    \n    return job.id;\n  }\n\n  async updateJobProgress(jobId: number, progress: { status?: string; phase?: string; phaseDescription?: string; totalRecords?: number; processedRecords?: number }): Promise<void> {\n    const [job] = await db.select().from(ibgeImportJobs).where(eq(ibgeImportJobs.id, jobId)).limit(1);\n    if (!job) return;\n    \n    const currentDetails = (job.errorDetails as any) || {};\n    const updates: any = {\n      errorDetails: {\n        ...currentDetails,\n        progress: {\n          ...(currentDetails.progress || {}),\n          phase: progress.phase || currentDetails.progress?.phase,\n          phaseDescription: progress.phaseDescription || currentDetails.progress?.phaseDescription,\n        }\n      }\n    };\n    \n    if (progress.status) {\n      updates.status = progress.status;\n      if (progress.status === \"running\" && !job.startedAt) {\n        updates.startedAt = new Date();\n      }\n    }\n    if (progress.totalRecords !== undefined) {\n      updates.totalRecords = progress.totalRecords;\n    }\n    if (progress.processedRecords !== undefined) {\n      updates.processedRecords = progress.processedRecords;\n    }\n    \n    await db.update(ibgeImportJobs).set(updates).where(eq(ibgeImportJobs.id, jobId));\n  }\n\n  async completeJob(jobId: number, totalImported: number, totalErrors: number, extraDetails?: any): Promise<void> {\n    const [job] = await db.select().from(ibgeImportJobs).where(eq(ibgeImportJobs.id, jobId)).limit(1);\n    if (!job) return;\n    \n    const currentDetails = (job.errorDetails as any) || {};\n    \n    await db.update(ibgeImportJobs)\n      .set({\n        status: \"completed\",\n        completedAt: new Date(),\n        processedRecords: totalImported,\n        failedRecords: totalErrors,\n        errorDetails: {\n          ...currentDetails,\n          ...extraDetails,\n          progress: {\n            phase: \"completed\",\n            phaseDescription: `Importação concluída em ${extraDetails?.summary?.duration || \"?\"}`,\n          }\n        }\n      })\n      .where(eq(ibgeImportJobs.id, jobId));\n  }\n\n  async failJob(jobId: number, errorMessage: string): Promise<void> {\n    const [job] = await db.select().from(ibgeImportJobs).where(eq(ibgeImportJobs.id, jobId)).limit(1);\n    if (!job) return;\n    \n    const currentDetails = (job.errorDetails as any) || {};\n    \n    await db.update(ibgeImportJobs)\n      .set({\n        status: \"failed\",\n        completedAt: new Date(),\n        errorMessage,\n        errorDetails: {\n          ...currentDetails,\n          progress: {\n            phase: \"failed\",\n            phaseDescription: errorMessage,\n          }\n        }\n      })\n      .where(eq(ibgeImportJobs.id, jobId));\n  }\n}\n\nexport const ibgeService = IBGEService.getInstance();\n","path":null,"size_bytes":38423,"size_tokens":null},"server/replit_integrations/chat/routes.ts":{"content":"import type { Express, Request, Response } from \"express\";\nimport OpenAI from \"openai\";\nimport { chatStorage } from \"./storage\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\nexport function registerChatRoutes(app: Express): void {\n  // Get all conversations\n  app.get(\"/api/conversations\", async (req: Request, res: Response) => {\n    try {\n      const conversations = await chatStorage.getAllConversations();\n      res.json(conversations);\n    } catch (error) {\n      console.error(\"Error fetching conversations:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversations\" });\n    }\n  });\n\n  // Get single conversation with messages\n  app.get(\"/api/conversations/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const conversation = await chatStorage.getConversation(id);\n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      const messages = await chatStorage.getMessagesByConversation(id);\n      res.json({ ...conversation, messages });\n    } catch (error) {\n      console.error(\"Error fetching conversation:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversation\" });\n    }\n  });\n\n  // Create new conversation\n  app.post(\"/api/conversations\", async (req: Request, res: Response) => {\n    try {\n      const { title } = req.body;\n      const conversation = await chatStorage.createConversation(title || \"New Chat\");\n      res.status(201).json(conversation);\n    } catch (error) {\n      console.error(\"Error creating conversation:\", error);\n      res.status(500).json({ error: \"Failed to create conversation\" });\n    }\n  });\n\n  // Delete conversation\n  app.delete(\"/api/conversations/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      await chatStorage.deleteConversation(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting conversation:\", error);\n      res.status(500).json({ error: \"Failed to delete conversation\" });\n    }\n  });\n\n  // Send message and get AI response (streaming)\n  app.post(\"/api/conversations/:id/messages\", async (req: Request, res: Response) => {\n    try {\n      const conversationId = parseInt(req.params.id);\n      const { content } = req.body;\n\n      // Save user message\n      await chatStorage.createMessage(conversationId, \"user\", content);\n\n      // Get conversation history for context\n      const messages = await chatStorage.getMessagesByConversation(conversationId);\n      const chatMessages = messages.map((m) => ({\n        role: m.role as \"user\" | \"assistant\",\n        content: m.content,\n      }));\n\n      // Set up SSE\n      res.setHeader(\"Content-Type\", \"text/event-stream\");\n      res.setHeader(\"Cache-Control\", \"no-cache\");\n      res.setHeader(\"Connection\", \"keep-alive\");\n\n      // Stream response from OpenAI\n      const stream = await openai.chat.completions.create({\n        model: \"gpt-5.1\",\n        messages: chatMessages,\n        stream: true,\n        max_completion_tokens: 2048,\n      });\n\n      let fullResponse = \"\";\n\n      for await (const chunk of stream) {\n        const content = chunk.choices[0]?.delta?.content || \"\";\n        if (content) {\n          fullResponse += content;\n          res.write(`data: ${JSON.stringify({ content })}\\n\\n`);\n        }\n      }\n\n      // Save assistant message\n      await chatStorage.createMessage(conversationId, \"assistant\", fullResponse);\n\n      res.write(`data: ${JSON.stringify({ done: true })}\\n\\n`);\n      res.end();\n    } catch (error) {\n      console.error(\"Error sending message:\", error);\n      // Check if headers already sent (SSE streaming started)\n      if (res.headersSent) {\n        res.write(`data: ${JSON.stringify({ error: \"Failed to send message\" })}\\n\\n`);\n        res.end();\n      } else {\n        res.status(500).json({ error: \"Failed to send message\" });\n      }\n    }\n  });\n}\n\n","path":null,"size_bytes":4044,"size_tokens":null},"server/replit_integrations/image/index.ts":{"content":"export { registerImageRoutes } from \"./routes\";\nexport { openai, generateImageBuffer, editImages } from \"./client\";\n\n","path":null,"size_bytes":117,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/replit_integrations/audio/audio-utils.ts":{"content":"/**\n * Audio utility functions for voice chat.\n * Handles PCM16 decoding and AudioContext initialization.\n */\n\n/**\n * Decode base64 PCM16 audio to Float32Array for Web Audio API\n */\nexport function decodePCM16ToFloat32(base64Audio: string): Float32Array {\n  const raw = atob(base64Audio);\n  const bytes = new Uint8Array(raw.length);\n  for (let i = 0; i < raw.length; i++) {\n    bytes[i] = raw.charCodeAt(i);\n  }\n  const pcm16 = new Int16Array(bytes.buffer);\n  const float32 = new Float32Array(pcm16.length);\n  for (let i = 0; i < pcm16.length; i++) {\n    float32[i] = pcm16[i] / 32768;\n  }\n  return float32;\n}\n\n/**\n * Create and initialize AudioContext with worklet\n */\nexport async function createAudioPlaybackContext(\n  workletPath = \"/audio-playback-worklet.js\",\n  sampleRate = 24000\n): Promise<{ ctx: AudioContext; worklet: AudioWorkletNode }> {\n  const ctx = new AudioContext({ sampleRate });\n  await ctx.audioWorklet.addModule(workletPath);\n  const worklet = new AudioWorkletNode(ctx, \"audio-playback-processor\");\n  worklet.connect(ctx.destination);\n  return { ctx, worklet };\n}\n\n","path":null,"size_bytes":1086,"size_tokens":null},"client/replit_integrations/audio/useVoiceStream.ts":{"content":"/**\n * React hook for handling SSE voice streaming responses.\n * Supports both simple streaming and sequenced audio (text model pipeline).\n */\nimport { useCallback } from \"react\";\nimport { useAudioPlayback } from \"./useAudioPlayback\";\n\ninterface StreamCallbacks {\n  onUserTranscript?: (text: string) => void;\n  onSentence?: (seq: number, text: string) => void;\n  onTranscript?: (text: string, full: string) => void;\n  onComplete?: (transcript: string) => void;\n  onError?: (error: Error) => void;\n}\n\nexport function useVoiceStream(callbacks: StreamCallbacks = {}) {\n  const playback = useAudioPlayback();\n\n  const streamVoiceResponse = useCallback(\n    async (url: string, audioBlob: Blob) => {\n      await playback.init();\n      playback.clear();\n\n      const reader = new FileReader();\n      const base64Audio = await new Promise<string>((resolve) => {\n        reader.onload = () => {\n          const result = reader.result as string;\n          resolve(result.split(\",\")[1]); // Remove data URL prefix\n        };\n        reader.readAsDataURL(audioBlob);\n      });\n\n      const response = await fetch(url, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ audio: base64Audio }),\n      });\n\n      if (!response.ok) throw new Error(\"Voice request failed\");\n\n      const streamReader = response.body?.getReader();\n      if (!streamReader) throw new Error(\"No response body\");\n\n      const decoder = new TextDecoder();\n      let buffer = \"\";\n      let fullTranscript = \"\";\n\n      while (true) {\n        const { done, value } = await streamReader.read();\n        if (done) break;\n\n        buffer += decoder.decode(value, { stream: true });\n        const lines = buffer.split(\"\\n\");\n        buffer = lines.pop() || \"\";\n\n        for (const line of lines) {\n          if (!line.startsWith(\"data: \")) continue;\n\n          try {\n            const event = JSON.parse(line.slice(6));\n\n            switch (event.type) {\n              case \"user_transcript\":\n                callbacks.onUserTranscript?.(event.data);\n                break;\n\n              case \"sentence\":\n                callbacks.onSentence?.(event.seq, event.text);\n                break;\n\n              case \"transcript\":\n                // Legacy: simple transcript delta (no seq)\n                if (event.seq === undefined && event.data) {\n                  fullTranscript += event.data;\n                  callbacks.onTranscript?.(event.data, fullTranscript);\n                } else if (event.data) {\n                  // New: full transcript at end\n                  fullTranscript = event.data;\n                }\n                break;\n\n              case \"audio\":\n                if (event.seq !== undefined) {\n                  // Sequenced audio (text model pipeline)\n                  playback.pushSequencedAudio(event.seq, event.data);\n                } else {\n                  // Simple audio (legacy gpt-audio-mini)\n                  playback.pushAudio(event.data);\n                }\n                break;\n\n              case \"done\":\n                playback.signalComplete();\n                callbacks.onComplete?.(fullTranscript);\n                break;\n\n              case \"error\":\n                throw new Error(event.error);\n            }\n          } catch (e) {\n            if (!(e instanceof SyntaxError)) {\n              callbacks.onError?.(e as Error);\n            }\n          }\n        }\n      }\n    },\n    [playback, callbacks]\n  );\n\n  return { streamVoiceResponse, playbackState: playback.state };\n}\n","path":null,"size_bytes":3548,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/pages/semantic-search.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { \n  Search, \n  Brain, \n  MessageSquare, \n  Clock, \n  FileText, \n  AlertCircle,\n  Loader2,\n  History,\n  ChevronDown,\n  ChevronUp,\n  Sparkles,\n  HelpCircle,\n  Database,\n  Zap\n} from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\n\ninterface SemanticSearchResult {\n  answer: string;\n  citations: {\n    id: number;\n    snippet: string;\n    similarity: number;\n    metadata: any;\n  }[];\n  totalResults: number;\n  responseTime: number;\n}\n\ninterface SearchQuery {\n  id: number;\n  query: string;\n  filters: any;\n  resultCount: number;\n  responseTime: number;\n  createdAt: string;\n}\n\nconst EXAMPLE_QUERIES = [\n  \"Qual foi o desempenho do PT nas últimas eleições?\",\n  \"Quais candidatos receberam mais votos em São Paulo?\",\n  \"Compare a votação de deputados federais entre os estados do sudeste\",\n  \"Quantos votos o PSDB obteve na região nordeste?\",\n  \"Quem foram os candidatos mais votados para senador?\",\n];\n\nexport default function SemanticSearchPage() {\n  const [query, setQuery] = useState(\"\");\n  const [filters, setFilters] = useState<{\n    year?: string;\n    state?: string;\n    party?: string;\n    position?: string;\n  }>({});\n  const [showFilters, setShowFilters] = useState(false);\n  const [result, setResult] = useState<SemanticSearchResult | null>(null);\n  const [expandedCitation, setExpandedCitation] = useState<number | null>(null);\n\n  const { data: apiKeyStatus, isLoading: checkingApiKey } = useQuery({\n    queryKey: [\"/api/semantic-search/check-api-key\"],\n  });\n\n  const { data: searchHistory, isLoading: historyLoading } = useQuery<SearchQuery[]>({\n    queryKey: [\"/api/semantic-search/history\"],\n  });\n\n  const { data: availableYears } = useQuery<number[]>({\n    queryKey: [\"/api/analytics/election-years\"],\n  });\n\n  const { data: availableStates } = useQuery<string[]>({\n    queryKey: [\"/api/analytics/states\"],\n  });\n\n  const { data: availableParties } = useQuery<{ abbreviation: string; name: string }[]>({\n    queryKey: [\"/api/analytics/parties-list\"],\n  });\n\n  const { data: availablePositions } = useQuery<string[]>({\n    queryKey: [\"/api/analytics/positions\"],\n  });\n\n  const searchMutation = useMutation({\n    mutationFn: async (data: { query: string; filters: any }) => {\n      const response = await apiRequest(\"POST\", \"/api/semantic-search\", data);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setResult(data);\n      // Invalidate history cache to show new search\n      queryClient.invalidateQueries({ queryKey: [\"/api/semantic-search/history\"] });\n    },\n    onError: (error: any) => {\n      console.error(\"Search error:\", error);\n    },\n  });\n\n  const handleSearch = () => {\n    if (query.trim().length < 3) return;\n    searchMutation.mutate({ query, filters });\n  };\n\n  const handleExampleClick = (example: string) => {\n    setQuery(example);\n  };\n\n  const handleHistoryClick = (historyItem: SearchQuery) => {\n    setQuery(historyItem.query);\n    if (historyItem.filters) {\n      setFilters(historyItem.filters);\n    }\n  };\n\n  if (checkingApiKey) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-8 w-64\" />\n        <Skeleton className=\"h-48 w-full\" />\n      </div>\n    );\n  }\n\n  if (!(apiKeyStatus as any)?.configured) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div className=\"flex items-center gap-3\">\n          <Brain className=\"h-8 w-8 text-muted-foreground\" />\n          <div>\n            <h1 className=\"text-2xl font-bold\">Busca Semântica</h1>\n            <p className=\"text-muted-foreground\">Pergunte sobre dados eleitorais em linguagem natural</p>\n          </div>\n        </div>\n\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Configuração necessária</AlertTitle>\n          <AlertDescription>\n            A busca semântica requer uma chave de API do OpenAI para gerar embeddings e respostas.\n            Por favor, configure a variável de ambiente <code className=\"font-mono bg-muted px-1 rounded\">OPENAI_API_KEY</code> nas configurações do projeto.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center gap-3\">\n        <Brain className=\"h-8 w-8\" style={{ color: \"#003366\" }} />\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">Busca Semântica</h1>\n          <p className=\"text-muted-foreground\" data-testid=\"text-page-description\">\n            Pergunte sobre dados eleitorais em linguagem natural usando IA\n          </p>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        <div className=\"lg:col-span-2 space-y-6\">\n          <Card data-testid=\"card-search-input\">\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"flex items-center gap-2\">\n                <MessageSquare className=\"h-5 w-5\" />\n                Faça sua pergunta\n              </CardTitle>\n              <CardDescription>\n                Use linguagem natural para perguntar sobre candidatos, partidos, votos e tendências eleitorais\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <Textarea\n                placeholder=\"Ex: Quais foram os candidatos mais votados para deputado federal em 2022?\"\n                value={query}\n                onChange={(e) => setQuery(e.target.value)}\n                className=\"min-h-[100px] resize-none\"\n                data-testid=\"input-query\"\n                onKeyDown={(e) => {\n                  if (e.key === \"Enter\" && !e.shiftKey) {\n                    e.preventDefault();\n                    handleSearch();\n                  }\n                }}\n              />\n              \n              <div className=\"flex items-center justify-between\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setShowFilters(!showFilters)}\n                  data-testid=\"button-toggle-filters\"\n                >\n                  {showFilters ? <ChevronUp className=\"h-4 w-4 mr-1\" /> : <ChevronDown className=\"h-4 w-4 mr-1\" />}\n                  Filtros\n                </Button>\n                \n                <Button \n                  onClick={handleSearch}\n                  disabled={query.trim().length < 3 || searchMutation.isPending}\n                  data-testid=\"button-search\"\n                >\n                  {searchMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <Search className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Buscar\n                </Button>\n              </div>\n\n              {showFilters && (\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 pt-3 border-t\" data-testid=\"filters-panel\">\n                  <div>\n                    <label className=\"text-xs font-medium text-muted-foreground mb-1 block\">Ano</label>\n                    <Select \n                      value={filters.year || \"\"} \n                      onValueChange={(v) => setFilters({ ...filters, year: v || undefined })}\n                    >\n                      <SelectTrigger data-testid=\"select-filter-year\">\n                        <SelectValue placeholder=\"Todos\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"\" data-testid=\"option-year-all\">Todos</SelectItem>\n                        {availableYears?.map((year) => (\n                          <SelectItem key={year} value={String(year)} data-testid={`option-year-${year}`}>\n                            {year}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  \n                  <div>\n                    <label className=\"text-xs font-medium text-muted-foreground mb-1 block\">Estado</label>\n                    <Select \n                      value={filters.state || \"\"} \n                      onValueChange={(v) => setFilters({ ...filters, state: v || undefined })}\n                    >\n                      <SelectTrigger data-testid=\"select-filter-state\">\n                        <SelectValue placeholder=\"Todos\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"\" data-testid=\"option-state-all\">Todos</SelectItem>\n                        {availableStates?.map((state) => (\n                          <SelectItem key={state} value={state} data-testid={`option-state-${state}`}>\n                            {state}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  \n                  <div>\n                    <label className=\"text-xs font-medium text-muted-foreground mb-1 block\">Partido</label>\n                    <Select \n                      value={filters.party || \"\"} \n                      onValueChange={(v) => setFilters({ ...filters, party: v || undefined })}\n                    >\n                      <SelectTrigger data-testid=\"select-filter-party\">\n                        <SelectValue placeholder=\"Todos\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"\" data-testid=\"option-party-all\">Todos</SelectItem>\n                        {availableParties?.map((party) => (\n                          <SelectItem key={party.abbreviation} value={party.abbreviation} data-testid={`option-party-${party.abbreviation}`}>\n                            {party.abbreviation}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  \n                  <div>\n                    <label className=\"text-xs font-medium text-muted-foreground mb-1 block\">Cargo</label>\n                    <Select \n                      value={filters.position || \"\"} \n                      onValueChange={(v) => setFilters({ ...filters, position: v || undefined })}\n                    >\n                      <SelectTrigger data-testid=\"select-filter-position\">\n                        <SelectValue placeholder=\"Todos\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"\" data-testid=\"option-position-all\">Todos</SelectItem>\n                        {availablePositions?.map((position) => (\n                          <SelectItem key={position} value={position} data-testid={`option-position-${position}`}>\n                            {position}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {searchMutation.isPending && (\n            <Card data-testid=\"card-loading\">\n              <CardContent className=\"py-8\">\n                <div className=\"flex flex-col items-center gap-4\">\n                  <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n                  <div className=\"text-center\">\n                    <p className=\"font-medium\">Analisando dados eleitorais...</p>\n                    <p className=\"text-sm text-muted-foreground\">A IA está processando sua pergunta</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {searchMutation.isError && (\n            <Alert variant=\"destructive\" data-testid=\"alert-error\">\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertTitle>Erro na busca</AlertTitle>\n              <AlertDescription>\n                Não foi possível processar sua pergunta. Verifique se a chave da API está configurada corretamente.\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {result && !searchMutation.isPending && (\n            <div className=\"space-y-4\">\n              <Card data-testid=\"card-answer\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Sparkles className=\"h-5 w-5\" style={{ color: \"#FFD700\" }} />\n                      Resposta\n                    </CardTitle>\n                    <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                      <Clock className=\"h-3 w-3\" />\n                      <span data-testid=\"text-response-time\">{result.responseTime}ms</span>\n                      <Badge variant=\"secondary\" data-testid=\"badge-result-count\">\n                        {result.totalResults} documentos\n                      </Badge>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"prose prose-sm max-w-none\" data-testid=\"text-answer\">\n                    {result.answer.split(\"\\n\").map((paragraph, i) => (\n                      <p key={i} className=\"mb-2 last:mb-0\">{paragraph}</p>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n\n              {result.citations.length > 0 && (\n                <Card data-testid=\"card-citations\">\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"flex items-center gap-2 text-base\">\n                      <FileText className=\"h-4 w-4\" />\n                      Fontes ({result.citations.length})\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3\">\n                    {result.citations.map((citation, index) => (\n                      <div \n                        key={citation.id}\n                        className=\"border rounded-lg p-3 cursor-pointer\"\n                        onClick={() => setExpandedCitation(expandedCitation === index ? null : index)}\n                        data-testid={`citation-${index}`}\n                      >\n                        <div className=\"flex items-start justify-between gap-2\">\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-2 mb-1\">\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                [{index + 1}]\n                              </Badge>\n                              <span className=\"text-xs text-muted-foreground\">\n                                Similaridade: {(citation.similarity * 100).toFixed(1)}%\n                              </span>\n                            </div>\n                            <p className={`text-sm ${expandedCitation === index ? \"\" : \"line-clamp-2\"}`}>\n                              {citation.snippet}\n                            </p>\n                          </div>\n                          {expandedCitation === index ? (\n                            <ChevronUp className=\"h-4 w-4 flex-shrink-0 text-muted-foreground\" />\n                          ) : (\n                            <ChevronDown className=\"h-4 w-4 flex-shrink-0 text-muted-foreground\" />\n                          )}\n                        </div>\n                        {expandedCitation === index && citation.metadata && (\n                          <div className=\"mt-3 pt-3 border-t text-xs text-muted-foreground grid grid-cols-2 gap-2\">\n                            {citation.metadata.candidateName && (\n                              <div><strong>Candidato:</strong> {citation.metadata.candidateName}</div>\n                            )}\n                            {citation.metadata.partyName && (\n                              <div><strong>Partido:</strong> {citation.metadata.partyName}</div>\n                            )}\n                            {citation.metadata.votes !== undefined && (\n                              <div><strong>Votos:</strong> {Number(citation.metadata.votes).toLocaleString(\"pt-BR\")}</div>\n                            )}\n                            {citation.metadata.municipality && (\n                              <div><strong>Município:</strong> {citation.metadata.municipality}</div>\n                            )}\n                            {citation.metadata.result && (\n                              <div><strong>Resultado:</strong> {citation.metadata.result}</div>\n                            )}\n                          </div>\n                        )}\n                      </div>\n                    ))}\n                  </CardContent>\n                </Card>\n              )}\n            </div>\n          )}\n        </div>\n\n        <div className=\"space-y-6\">\n          <Card data-testid=\"card-examples\">\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"flex items-center gap-2 text-base\">\n                <HelpCircle className=\"h-4 w-4\" />\n                Exemplos de perguntas\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              {EXAMPLE_QUERIES.map((example, index) => (\n                <Button\n                  key={index}\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"w-full justify-start text-left h-auto py-2 px-3\"\n                  onClick={() => handleExampleClick(example)}\n                  data-testid={`button-example-${index}`}\n                >\n                  <span className=\"line-clamp-2 text-xs\">{example}</span>\n                </Button>\n              ))}\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"card-history\">\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"flex items-center gap-2 text-base\">\n                <History className=\"h-4 w-4\" />\n                Buscas recentes\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {historyLoading ? (\n                <div className=\"space-y-2\">\n                  <Skeleton className=\"h-8 w-full\" />\n                  <Skeleton className=\"h-8 w-full\" />\n                  <Skeleton className=\"h-8 w-full\" />\n                </div>\n              ) : searchHistory && searchHistory.length > 0 ? (\n                <div className=\"space-y-2\">\n                  {searchHistory.slice(0, 5).map((item) => (\n                    <Button\n                      key={item.id}\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      className=\"w-full justify-start text-left h-auto py-2 px-3\"\n                      onClick={() => handleHistoryClick(item)}\n                      data-testid={`button-history-${item.id}`}\n                    >\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"line-clamp-1 text-xs\">{item.query}</p>\n                        <div className=\"flex items-center gap-2 text-xs text-muted-foreground mt-1\">\n                          <span>{item.resultCount} resultados</span>\n                          <span>{item.responseTime}ms</span>\n                        </div>\n                      </div>\n                    </Button>\n                  ))}\n                </div>\n              ) : (\n                <p className=\"text-sm text-muted-foreground text-center py-4\" data-testid=\"text-no-history\">\n                  Nenhuma busca recente\n                </p>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"card-info\">\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"flex items-center gap-2 text-base\">\n                <Database className=\"h-4 w-4\" />\n                Como funciona\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"text-xs text-muted-foreground space-y-3\">\n              <div className=\"flex items-start gap-2\">\n                <Zap className=\"h-4 w-4 flex-shrink-0 mt-0.5\" style={{ color: \"#FFD700\" }} />\n                <p>A busca semântica usa inteligência artificial para entender o significado da sua pergunta</p>\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <Database className=\"h-4 w-4 flex-shrink-0 mt-0.5\" />\n                <p>Os dados eleitorais são transformados em vetores para busca por similaridade</p>\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <Brain className=\"h-4 w-4 flex-shrink-0 mt-0.5\" />\n                <p>O GPT-4 analisa os resultados e gera uma resposta concisa com citações</p>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":21620,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/pages/alliances.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useParams, Link } from \"wouter\";\nimport { Plus, Edit, Trash2, Users, ArrowLeft, Handshake } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Scenario, Party } from \"@shared/schema\";\n\ntype Alliance = {\n  id: number;\n  scenarioId: number;\n  name: string;\n  type: string;\n  color: string;\n  active: boolean;\n  partyIds: number[];\n};\n\nexport default function Alliances() {\n  const params = useParams<{ scenarioId: string }>();\n  const scenarioId = parseInt(params.scenarioId || \"0\");\n  const { hasPermission } = useAuth();\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingAlliance, setEditingAlliance] = useState<Alliance | null>(null);\n  const [deleteConfirmId, setDeleteConfirmId] = useState<number | null>(null);\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    type: \"coalition\",\n    color: \"#003366\",\n    partyIds: [] as number[],\n  });\n\n  const { data: scenario } = useQuery<Scenario>({\n    queryKey: [\"/api/scenarios\", scenarioId],\n    enabled: scenarioId > 0,\n  });\n\n  const { data: alliances, isLoading } = useQuery<Alliance[]>({\n    queryKey: [\"/api/scenarios\", scenarioId, \"alliances\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/scenarios/${scenarioId}/alliances`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch alliances\");\n      return res.json();\n    },\n    enabled: scenarioId > 0,\n  });\n\n  const { data: parties } = useQuery<Party[]>({\n    queryKey: [\"/api/parties\"],\n  });\n\n  const usedPartyIds = new Set(\n    alliances\n      ?.filter((a) => a.id !== editingAlliance?.id)\n      .flatMap((a) => a.partyIds) || []\n  );\n\n  const availableParties = parties?.filter((p) => !usedPartyIds.has(p.id)) || [];\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return apiRequest(\"POST\", `/api/scenarios/${scenarioId}/alliances`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenarios\", scenarioId, \"alliances\"] });\n      toast({ title: \"Sucesso\", description: \"Aliança criada com sucesso\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar aliança\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: typeof formData }) => {\n      return apiRequest(\"PUT\", `/api/alliances/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenarios\", scenarioId, \"alliances\"] });\n      toast({ title: \"Sucesso\", description: \"Aliança atualizada\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar aliança\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/alliances/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenarios\", scenarioId, \"alliances\"] });\n      toast({ title: \"Sucesso\", description: \"Aliança excluída\" });\n      setDeleteConfirmId(null);\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao excluir aliança\", variant: \"destructive\" });\n    },\n  });\n\n  function resetForm() {\n    setFormData({ name: \"\", type: \"coalition\", color: \"#003366\", partyIds: [] });\n    setEditingAlliance(null);\n    setIsDialogOpen(false);\n  }\n\n  function openEdit(alliance: Alliance) {\n    setEditingAlliance(alliance);\n    setFormData({\n      name: alliance.name,\n      type: alliance.type,\n      color: alliance.color,\n      partyIds: alliance.partyIds,\n    });\n    setIsDialogOpen(true);\n  }\n\n  function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    if (editingAlliance) {\n      updateMutation.mutate({ id: editingAlliance.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  }\n\n  function toggleParty(partyId: number) {\n    setFormData((prev) => ({\n      ...prev,\n      partyIds: prev.partyIds.includes(partyId)\n        ? prev.partyIds.filter((id) => id !== partyId)\n        : [...prev.partyIds, partyId],\n    }));\n  }\n\n  function getPartyName(partyId: number) {\n    return parties?.find((p) => p.id === partyId)?.abbreviation || `Partido ${partyId}`;\n  }\n\n  if (!scenarioId || scenarioId <= 0) {\n    return (\n      <div className=\"space-y-6\">\n        <PageHeader\n          title=\"Federações e Coligações\"\n          description=\"Cenário não encontrado\"\n          breadcrumbs={[\n            { label: \"Dashboard\", href: \"/\" },\n            { label: \"Cenários\", href: \"/scenarios\" },\n            { label: \"Alianças\" },\n          ]}\n        />\n        <EmptyState\n          icon={Handshake}\n          title=\"Cenário não encontrado\"\n          description=\"Selecione um cenário válido para gerenciar suas alianças\"\n        />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between mb-6\">\n        <PageHeader\n          title=\"Federações e Coligações\"\n          description={scenario ? `Gerenciar alianças do cenário \"${scenario.name}\"` : \"Carregando...\"}\n          breadcrumbs={[\n            { label: \"Dashboard\", href: \"/\" },\n            { label: \"Cenários\", href: \"/scenarios\" },\n            { label: scenario?.name || \"Cenário\" },\n            { label: \"Alianças\" },\n          ]}\n        />\n        <div className=\"flex gap-2\">\n          <Link href=\"/scenarios\">\n            <Button variant=\"outline\" data-testid=\"button-back-scenarios\">\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Voltar\n            </Button>\n          </Link>\n          {hasPermission(\"manage_scenarios\") && (\n            <Button\n              onClick={() => setIsDialogOpen(true)}\n              data-testid=\"button-add-alliance\"\n            >\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Nova Aliança\n            </Button>\n          )}\n        </div>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Handshake className=\"w-5 h-5 text-primary\" />\n            Alianças do Cenário\n          </CardTitle>\n          <CardDescription>\n            Federações (2022+) e coligações (pré-2022) afetam a distribuição de vagas no sistema proporcional\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">Carregando...</div>\n          ) : !alliances || alliances.length === 0 ? (\n            <EmptyState\n              icon={Handshake}\n              title=\"Nenhuma aliança cadastrada\"\n              description=\"Este cenário não possui federações ou coligações. Os partidos serão contabilizados individualmente.\"\n              actionLabel={hasPermission(\"manage_scenarios\") ? \"Criar Aliança\" : undefined}\n              onAction={hasPermission(\"manage_scenarios\") ? () => setIsDialogOpen(true) : undefined}\n            />\n          ) : (\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n              {alliances.map((alliance) => (\n                <Card key={alliance.id} className=\"relative\" data-testid={`card-alliance-${alliance.id}`}>\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2\">\n                        <div\n                          className=\"w-4 h-4 rounded-full\"\n                          style={{ backgroundColor: alliance.color }}\n                        />\n                        <CardTitle className=\"text-base\">{alliance.name}</CardTitle>\n                      </div>\n                      <Badge variant={alliance.type === \"federation\" ? \"default\" : \"secondary\"}>\n                        {alliance.type === \"federation\" ? \"Federação\" : \"Coligação\"}\n                      </Badge>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <Users className=\"w-4 h-4\" />\n                        <span>{alliance.partyIds.length} partidos</span>\n                      </div>\n                      <div className=\"flex flex-wrap gap-1\">\n                        {alliance.partyIds.map((partyId) => (\n                          <Badge key={partyId} variant=\"outline\" className=\"text-xs\">\n                            {getPartyName(partyId)}\n                          </Badge>\n                        ))}\n                      </div>\n                      {hasPermission(\"manage_scenarios\") && (\n                        <div className=\"flex gap-2 pt-2\">\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => openEdit(alliance)}\n                            data-testid={`button-edit-alliance-${alliance.id}`}\n                          >\n                            <Edit className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"destructive\"\n                            size=\"sm\"\n                            onClick={() => setDeleteConfirmId(alliance.id)}\n                            data-testid={`button-delete-alliance-${alliance.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </Button>\n                        </div>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={isDialogOpen} onOpenChange={(open) => { if (!open) resetForm(); else setIsDialogOpen(true); }}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>{editingAlliance ? \"Editar Aliança\" : \"Nova Aliança\"}</DialogTitle>\n            <DialogDescription>\n              {editingAlliance\n                ? \"Modifique os dados da aliança\"\n                : \"Crie uma federação ou coligação para este cenário\"}\n            </DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleSubmit}>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"name\">Nome da Aliança</Label>\n                <Input\n                  id=\"name\"\n                  value={formData.name}\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  placeholder=\"Ex: Federação Brasil da Esperança\"\n                  required\n                  data-testid=\"input-alliance-name\"\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"type\">Tipo</Label>\n                  <Select\n                    value={formData.type}\n                    onValueChange={(value) => setFormData({ ...formData, type: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-alliance-type\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"coalition\">Coligação (pré-2022)</SelectItem>\n                      <SelectItem value=\"federation\">Federação (2022+)</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"color\">Cor</Label>\n                  <div className=\"flex gap-2\">\n                    <Input\n                      id=\"color\"\n                      type=\"color\"\n                      value={formData.color}\n                      onChange={(e) => setFormData({ ...formData, color: e.target.value })}\n                      className=\"w-12 h-9 p-1 cursor-pointer\"\n                      data-testid=\"input-alliance-color\"\n                    />\n                    <Input\n                      value={formData.color}\n                      onChange={(e) => setFormData({ ...formData, color: e.target.value })}\n                      className=\"flex-1\"\n                      placeholder=\"#003366\"\n                    />\n                  </div>\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Partidos Membros</Label>\n                <div className=\"border rounded-md p-3 max-h-48 overflow-y-auto space-y-2\">\n                  {availableParties.length === 0 && formData.partyIds.length === 0 ? (\n                    <p className=\"text-sm text-muted-foreground\">\n                      Todos os partidos já pertencem a outras alianças\n                    </p>\n                  ) : (\n                    [...(editingAlliance ? parties?.filter((p) => formData.partyIds.includes(p.id)) || [] : []), ...availableParties]\n                      .filter((p, i, arr) => arr.findIndex((x) => x.id === p.id) === i)\n                      .map((party) => (\n                        <div key={party.id} className=\"flex items-center gap-2\">\n                          <Checkbox\n                            id={`party-${party.id}`}\n                            checked={formData.partyIds.includes(party.id)}\n                            onCheckedChange={() => toggleParty(party.id)}\n                            data-testid={`checkbox-party-${party.id}`}\n                          />\n                          <label\n                            htmlFor={`party-${party.id}`}\n                            className=\"flex items-center gap-2 text-sm cursor-pointer\"\n                          >\n                            <div\n                              className=\"w-3 h-3 rounded-full\"\n                              style={{ backgroundColor: party.color }}\n                            />\n                            <span>{party.abbreviation}</span>\n                            <span className=\"text-muted-foreground\">- {party.name}</span>\n                          </label>\n                        </div>\n                      ))\n                  )}\n                </div>\n                {formData.partyIds.length > 0 && (\n                  <p className=\"text-sm text-muted-foreground\">\n                    {formData.partyIds.length} partido(s) selecionado(s)\n                  </p>\n                )}\n              </div>\n            </div>\n            <DialogFooter>\n              <Button type=\"button\" variant=\"outline\" onClick={resetForm}>\n                Cancelar\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={createMutation.isPending || updateMutation.isPending || formData.partyIds.length < 2}\n                data-testid=\"button-submit-alliance\"\n              >\n                {createMutation.isPending || updateMutation.isPending\n                  ? \"Salvando...\"\n                  : editingAlliance\n                  ? \"Atualizar\"\n                  : \"Criar\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={deleteConfirmId !== null} onOpenChange={() => setDeleteConfirmId(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Confirmar Exclusão</DialogTitle>\n            <DialogDescription>\n              Tem certeza que deseja excluir esta aliança? Os partidos voltarão a ser contabilizados individualmente.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeleteConfirmId(null)}>\n              Cancelar\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deleteConfirmId && deleteMutation.mutate(deleteConfirmId)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete-alliance\"\n            >\n              {deleteMutation.isPending ? \"Excluindo...\" : \"Excluir\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":17385,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { ThemeProvider } from \"@/lib/theme-provider\";\nimport { AuthProvider, useAuth } from \"@/lib/auth-context\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { NotificationBell } from \"@/components/notification-bell\";\nimport NotFound from \"@/pages/not-found\";\nimport Login from \"@/pages/login\";\nimport Dashboard from \"@/pages/dashboard\";\nimport Parties from \"@/pages/parties\";\nimport Candidates from \"@/pages/candidates\";\nimport Scenarios from \"@/pages/scenarios\";\nimport Simulations from \"@/pages/simulations\";\nimport Predictions from \"@/pages/predictions\";\nimport Audit from \"@/pages/audit\";\nimport Users from \"@/pages/users\";\nimport Settings from \"@/pages/settings\";\nimport Alliances from \"@/pages/alliances\";\nimport TseImport from \"@/pages/tse-import\";\nimport ScenarioCandidates from \"@/pages/scenario-candidates\";\nimport DataAnalysis from \"@/pages/data-analysis\";\nimport ElectoralDashboard from \"@/pages/electoral-dashboard\";\nimport SemanticSearch from \"@/pages/semantic-search\";\nimport InteractiveDashboard from \"@/pages/interactive-dashboard\";\nimport AIInsights from \"@/pages/ai-insights\";\nimport ProjectionReports from \"@/pages/projection-reports\";\nimport Forecasts from \"@/pages/forecasts\";\nimport AdminSettings from \"@/pages/admin-settings\";\nimport ReportAutomation from \"@/pages/report-automation\";\nimport SentimentAnalysis from \"@/pages/sentiment-analysis\";\nimport CampaignInsights from \"@/pages/campaign-insights\";\nimport Campaigns from \"@/pages/campaigns\";\nimport IBGEData from \"@/pages/ibge-data\";\nimport { Loader2 } from \"lucide-react\";\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={Dashboard} />\n      <Route path=\"/parties\" component={Parties} />\n      <Route path=\"/candidates\" component={Candidates} />\n      <Route path=\"/scenarios\" component={Scenarios} />\n      <Route path=\"/scenarios/:scenarioId/alliances\" component={Alliances} />\n      <Route path=\"/scenarios/:scenarioId/candidates\" component={ScenarioCandidates} />\n      <Route path=\"/simulations\" component={Simulations} />\n      <Route path=\"/predictions\" component={Predictions} />\n      <Route path=\"/audit\" component={Audit} />\n      <Route path=\"/users\" component={Users} />\n      <Route path=\"/settings\" component={Settings} />\n      <Route path=\"/tse-import\" component={TseImport} />\n      <Route path=\"/data-analysis\" component={DataAnalysis} />\n      <Route path=\"/electoral-dashboard\" component={ElectoralDashboard} />\n      <Route path=\"/semantic-search\" component={SemanticSearch} />\n      <Route path=\"/interactive-dashboard\" component={InteractiveDashboard} />\n      <Route path=\"/ai-insights\" component={AIInsights} />\n      <Route path=\"/projection-reports\" component={ProjectionReports} />\n      <Route path=\"/forecasts\" component={Forecasts} />\n      <Route path=\"/admin-settings\" component={AdminSettings} />\n      <Route path=\"/report-automation\" component={ReportAutomation} />\n      <Route path=\"/sentiment-analysis\" component={SentimentAnalysis} />\n      <Route path=\"/ibge-data\" component={IBGEData} />\n      <Route path=\"/campaigns\" component={Campaigns} />\n      <Route path=\"/campaign-insights\" component={CampaignInsights} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction AuthenticatedApp() {\n  const { isAuthenticated, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-background\">\n        <div className=\"flex flex-col items-center gap-4\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n          <p className=\"text-muted-foreground\">Carregando...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return <Login />;\n  }\n\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  return (\n    <SidebarProvider style={style as React.CSSProperties}>\n      <div className=\"flex h-screen w-full\">\n        <AppSidebar />\n        <div className=\"flex flex-col flex-1 overflow-hidden\">\n          <header className=\"flex items-center justify-between gap-4 p-3 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 sticky top-0 z-50\">\n            <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n            <div className=\"flex items-center gap-2\">\n              <NotificationBell />\n              <ThemeToggle />\n            </div>\n          </header>\n          <main className=\"flex-1 overflow-auto p-6 bg-muted/30\">\n            <Router />\n          </main>\n        </div>\n      </div>\n    </SidebarProvider>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider>\n        <TooltipProvider>\n          <AuthProvider>\n            <AuthenticatedApp />\n            <Toaster />\n          </AuthProvider>\n        </TooltipProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":5317,"size_tokens":null},"client/src/components/data-table.tsx":{"content":"import {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ChevronLeft, ChevronRight, Search } from \"lucide-react\";\nimport { useState, useMemo } from \"react\";\n\ninterface Column<T> {\n  key: string;\n  header: string;\n  cell: (item: T) => React.ReactNode;\n  sortable?: boolean;\n  className?: string;\n}\n\ninterface DataTableProps<T> {\n  data: T[];\n  columns: Column<T>[];\n  isLoading?: boolean;\n  searchable?: boolean;\n  searchKeys?: string[];\n  pageSize?: number;\n  emptyMessage?: string;\n  onRowClick?: (item: T) => void;\n}\n\nexport function DataTable<T extends Record<string, unknown>>({\n  data,\n  columns,\n  isLoading = false,\n  searchable = true,\n  searchKeys = [],\n  pageSize = 10,\n  emptyMessage = \"Nenhum registro encontrado\",\n  onRowClick,\n}: DataTableProps<T>) {\n  const [search, setSearch] = useState(\"\");\n  const [page, setPage] = useState(0);\n  const [sortKey, setSortKey] = useState<string | null>(null);\n  const [sortDir, setSortDir] = useState<\"asc\" | \"desc\">(\"asc\");\n\n  const filteredData = useMemo(() => {\n    if (!search || searchKeys.length === 0) return data;\n    const lower = search.toLowerCase();\n    return data.filter((item) =>\n      searchKeys.some((key) => {\n        const val = item[key];\n        return typeof val === \"string\" && val.toLowerCase().includes(lower);\n      })\n    );\n  }, [data, search, searchKeys]);\n\n  const sortedData = useMemo(() => {\n    if (!sortKey) return filteredData;\n    return [...filteredData].sort((a, b) => {\n      const aVal = a[sortKey];\n      const bVal = b[sortKey];\n      if (typeof aVal === \"number\" && typeof bVal === \"number\") {\n        return sortDir === \"asc\" ? aVal - bVal : bVal - aVal;\n      }\n      const aStr = String(aVal || \"\");\n      const bStr = String(bVal || \"\");\n      return sortDir === \"asc\" ? aStr.localeCompare(bStr) : bStr.localeCompare(aStr);\n    });\n  }, [filteredData, sortKey, sortDir]);\n\n  const paginatedData = useMemo(() => {\n    const start = page * pageSize;\n    return sortedData.slice(start, start + pageSize);\n  }, [sortedData, page, pageSize]);\n\n  const totalPages = Math.ceil(sortedData.length / pageSize);\n\n  function handleSort(key: string) {\n    if (sortKey === key) {\n      setSortDir((d) => (d === \"asc\" ? \"desc\" : \"asc\"));\n    } else {\n      setSortKey(key);\n      setSortDir(\"asc\");\n    }\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-4\">\n        {searchable && <Skeleton className=\"h-10 w-64\" />}\n        <div className=\"rounded-md border\">\n          <Table>\n            <TableHeader>\n              <TableRow>\n                {columns.map((col) => (\n                  <TableHead key={col.key}>\n                    <Skeleton className=\"h-4 w-24\" />\n                  </TableHead>\n                ))}\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {Array.from({ length: 5 }).map((_, i) => (\n                <TableRow key={i}>\n                  {columns.map((col) => (\n                    <TableCell key={col.key}>\n                      <Skeleton className=\"h-4 w-full\" />\n                    </TableCell>\n                  ))}\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {searchable && (\n        <div className=\"relative w-64\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Buscar...\"\n            value={search}\n            onChange={(e) => {\n              setSearch(e.target.value);\n              setPage(0);\n            }}\n            className=\"pl-9\"\n            data-testid=\"input-table-search\"\n          />\n        </div>\n      )}\n\n      <div className=\"rounded-md border\">\n        <Table>\n          <TableHeader>\n            <TableRow>\n              {columns.map((col) => (\n                <TableHead\n                  key={col.key}\n                  className={col.className}\n                  onClick={() => col.sortable && handleSort(col.key)}\n                  style={{ cursor: col.sortable ? \"pointer\" : \"default\" }}\n                >\n                  <div className=\"flex items-center gap-1\">\n                    {col.header}\n                    {col.sortable && sortKey === col.key && (\n                      <span className=\"text-xs\">\n                        {sortDir === \"asc\" ? \"↑\" : \"↓\"}\n                      </span>\n                    )}\n                  </div>\n                </TableHead>\n              ))}\n            </TableRow>\n          </TableHeader>\n          <TableBody>\n            {paginatedData.length === 0 ? (\n              <TableRow>\n                <TableCell colSpan={columns.length} className=\"text-center py-8 text-muted-foreground\">\n                  {emptyMessage}\n                </TableCell>\n              </TableRow>\n            ) : (\n              paginatedData.map((item, i) => (\n                <TableRow\n                  key={i}\n                  onClick={() => onRowClick?.(item)}\n                  className={onRowClick ? \"cursor-pointer hover-elevate\" : \"\"}\n                >\n                  {columns.map((col) => (\n                    <TableCell key={col.key} className={col.className}>\n                      {col.cell(item)}\n                    </TableCell>\n                  ))}\n                </TableRow>\n              ))\n            )}\n          </TableBody>\n        </Table>\n      </div>\n\n      {totalPages > 1 && (\n        <div className=\"flex items-center justify-between\">\n          <span className=\"text-sm text-muted-foreground\">\n            Mostrando {page * pageSize + 1} a {Math.min((page + 1) * pageSize, sortedData.length)} de {sortedData.length} registros\n          </span>\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              disabled={page === 0}\n              onClick={() => setPage((p) => p - 1)}\n              data-testid=\"button-prev-page\"\n            >\n              <ChevronLeft className=\"h-4 w-4\" />\n            </Button>\n            <span className=\"text-sm font-medium\">\n              {page + 1} / {totalPages}\n            </span>\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              disabled={page >= totalPages - 1}\n              onClick={() => setPage((p) => p + 1)}\n              data-testid=\"button-next-page\"\n            >\n              <ChevronRight className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":6796,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\nimport { storage } from \"./storage\";\nimport { executeReportRun } from \"./report-executor\";\nimport { initWebSocketServer } from \"./websocket\";\n\nconst app = express();\n\n// Report scheduler - runs every 5 minutes to check for due schedules\nfunction startReportScheduler() {\n  const SCHEDULER_INTERVAL = 5 * 60 * 1000; // 5 minutes\n  \n  async function checkSchedules() {\n    try {\n      const dueSchedules = await storage.getDueSchedules();\n      \n      for (const schedule of dueSchedules) {\n        try {\n          const template = await storage.getReportTemplate(schedule.templateId);\n          if (!template) {\n            console.log(`Report scheduler: Template ${schedule.templateId} not found for schedule ${schedule.id}`);\n            continue;\n          }\n\n          // Create a run record\n          const run = await storage.createReportRun({\n            templateId: schedule.templateId,\n            scheduleId: schedule.id,\n            triggeredBy: \"scheduled\",\n            status: \"pending\",\n          });\n\n          console.log(`Report scheduler: Starting scheduled run ${run.id} for schedule ${schedule.name}`);\n          \n          // Get recipients for this schedule\n          const recipients = Array.isArray(schedule.recipients) \n            ? (schedule.recipients as string[]) \n            : [];\n          \n          // Execute the report asynchronously\n          executeReportRun(run.id, template, recipients)\n            .then(() => console.log(`Report scheduler: Run ${run.id} completed`))\n            .catch(err => console.error(`Report scheduler: Run ${run.id} failed:`, err));\n          \n          // Update the next run time based on frequency\n          const nextRunAt = calculateNextScheduleRun(\n            schedule.frequency, \n            schedule.dayOfWeek, \n            schedule.dayOfMonth, \n            schedule.timeOfDay || \"08:00\"\n          );\n          \n          await storage.updateReportSchedule(schedule.id, {\n            nextRunAt,\n          });\n          \n        } catch (err) {\n          console.error(`Report scheduler: Error processing schedule ${schedule.id}:`, err);\n        }\n      }\n    } catch (error) {\n      console.error(\"Report scheduler error:\", error);\n    }\n  }\n\n  // Calculate next run time with proper day alignment\n  function calculateNextScheduleRun(\n    frequency: string, \n    dayOfWeek?: number | null, \n    dayOfMonth?: number | null, \n    timeOfDay: string = \"08:00\"\n  ): Date {\n    const now = new Date();\n    const [hours, minutes] = timeOfDay.split(\":\").map(Number);\n    \n    let nextRun = new Date(now);\n    nextRun.setHours(hours, minutes, 0, 0);\n    \n    switch (frequency) {\n      case \"daily\":\n        // Next day at the specified time\n        nextRun.setDate(nextRun.getDate() + 1);\n        break;\n        \n      case \"weekly\": {\n        // Find the next occurrence of the target day\n        const targetDay = dayOfWeek ?? 1; // Default to Monday\n        nextRun.setDate(nextRun.getDate() + 1); // Start from tomorrow\n        while (nextRun.getDay() !== targetDay) {\n          nextRun.setDate(nextRun.getDate() + 1);\n        }\n        break;\n      }\n        \n      case \"monthly\": {\n        // Next month on the specified day\n        const targetDate = dayOfMonth ?? 1;\n        nextRun.setMonth(nextRun.getMonth() + 1);\n        nextRun.setDate(Math.min(targetDate, getDaysInMonth(nextRun.getMonth(), nextRun.getFullYear())));\n        break;\n      }\n        \n      case \"once\":\n        // For one-time schedules, disable by setting far in the future\n        nextRun.setFullYear(nextRun.getFullYear() + 100);\n        break;\n    }\n    \n    return nextRun;\n  }\n  \n  function getDaysInMonth(month: number, year: number): number {\n    return new Date(year, month + 1, 0).getDate();\n  }\n\n  // Run every interval\n  console.log(\"Report scheduler started (checking every 5 minutes)\");\n  setInterval(checkSchedules, SCHEDULER_INTERVAL);\n}\nconst httpServer = createServer(app);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\napp.use(\n  express.json({\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false }));\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  try {\n    // Initialize database with IPv4 resolution for production\n    const { initializeDatabase, testConnection } = await import(\"./db\");\n    await initializeDatabase();\n    \n    // Test database connection\n    await testConnection();\n    \n    console.log(\"Registering routes...\");\n    await registerRoutes(httpServer, app);\n    console.log(\"Routes registered successfully!\");\n    \n    // Initialize WebSocket server for real-time import notifications\n    initWebSocketServer(httpServer);\n    console.log(\"WebSocket server initialized\");\n\n    app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n      const status = err.status || err.statusCode || 500;\n      const message = err.message || \"Internal Server Error\";\n\n      res.status(status).json({ message });\n      console.error(\"Express error:\", err);\n    });\n    // importantly only setup vite in development and after\n    // setting up all the other routes so the catch-all route\n    // doesn't interfere with the other routes\n    if (process.env.NODE_ENV === \"production\") {\n      serveStatic(app);\n    } else {\n      const { setupVite } = await import(\"./vite\");\n      await setupVite(httpServer, app);\n    }\n\n    // ALWAYS serve the app on the port specified in the environment variable PORT\n    // Other ports are firewalled. Default to 5000 if not specified.\n    // this serves both the API and the client.\n    // It is the only port that is not firewalled.\n    const port = parseInt(process.env.PORT || \"5000\", 10);\n    httpServer.listen(\n      {\n        port,\n        host: \"0.0.0.0\",\n        reusePort: true,\n      },\n      () => {\n        log(`serving on port ${port}`);\n        \n        // Start the report scheduler (check every 5 minutes)\n        startReportScheduler();\n      },\n    );\n  } catch (error) {\n    console.error(\"STARTUP ERROR:\", error);\n    process.exit(1);\n  }\n})();\n","path":null,"size_bytes":7217,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/pages/electoral-dashboard.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  BarChart, Bar, XAxis, YAxis, CartesianGrid, ResponsiveContainer, \n  PieChart, Pie, Cell, Legend, Tooltip as RechartsTooltip, LineChart, Line,\n  AreaChart, Area\n} from \"recharts\";\nimport { \n  Vote, Users, Building2, MapPin, TrendingUp, TrendingDown, Download, \n  CheckCircle2, XCircle, Loader2, Clock, RefreshCw, \n  BarChart3, Activity, Database, Play, Pause, Square, Radio, Zap, Minus\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport type { TseImportJob } from \"@shared/schema\";\nimport { useElectionWebSocket } from \"@/hooks/use-election-websocket\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nconst CHART_COLORS = [\n  \"#003366\", \"#1a5490\", \"#3475b4\", \"#4e96d8\", \"#68b7fc\",\n  \"#FFD700\", \"#e6c200\", \"#ccad00\", \"#b39800\", \"#998300\",\n  \"#2ecc71\", \"#27ae60\", \"#1e8449\", \"#145a32\", \"#0d3d22\",\n  \"#e74c3c\", \"#c0392b\", \"#a93226\", \"#922b21\", \"#7b241c\",\n];\n\nconst BRAZIL_STATES: { [key: string]: { name: string; path: string; cx: number; cy: number } } = {\n  AC: { name: \"Acre\", path: \"M85,280 L105,275 L110,290 L95,300 L80,295 Z\", cx: 95, cy: 287 },\n  AL: { name: \"Alagoas\", path: \"M490,260 L510,255 L515,270 L495,275 Z\", cx: 502, cy: 265 },\n  AP: { name: \"Amapá\", path: \"M280,80 L310,75 L320,110 L295,120 L275,105 Z\", cx: 297, cy: 95 },\n  AM: { name: \"Amazonas\", path: \"M100,150 L220,140 L240,200 L200,250 L120,260 L80,220 Z\", cx: 160, cy: 195 },\n  BA: { name: \"Bahia\", path: \"M400,220 L480,200 L510,280 L470,340 L410,320 L390,270 Z\", cx: 445, cy: 270 },\n  CE: { name: \"Ceará\", path: \"M450,160 L490,150 L500,190 L465,200 L445,185 Z\", cx: 472, cy: 175 },\n  DF: { name: \"Distrito Federal\", path: \"M355,300 L370,295 L375,310 L360,315 Z\", cx: 365, cy: 305 },\n  ES: { name: \"Espírito Santo\", path: \"M455,340 L475,335 L480,365 L460,370 Z\", cx: 467, cy: 352 },\n  GO: { name: \"Goiás\", path: \"M320,290 L380,280 L400,340 L350,360 L310,340 Z\", cx: 355, cy: 320 },\n  MA: { name: \"Maranhão\", path: \"M360,140 L420,130 L435,180 L390,200 L350,180 Z\", cx: 392, cy: 165 },\n  MT: { name: \"Mato Grosso\", path: \"M220,250 L320,240 L340,340 L280,380 L200,350 L190,290 Z\", cx: 265, cy: 310 },\n  MS: { name: \"Mato Grosso do Sul\", path: \"M280,380 L340,360 L360,430 L300,460 L260,430 Z\", cx: 310, cy: 410 },\n  MG: { name: \"Minas Gerais\", path: \"M360,320 L450,300 L480,370 L430,420 L360,400 L340,360 Z\", cx: 405, cy: 360 },\n  PA: { name: \"Pará\", path: \"M240,120 L350,100 L380,170 L340,220 L260,230 L220,180 Z\", cx: 295, cy: 165 },\n  PB: { name: \"Paraíba\", path: \"M475,210 L510,205 L515,225 L480,230 Z\", cx: 495, cy: 217 },\n  PR: { name: \"Paraná\", path: \"M320,430 L390,420 L410,470 L350,490 L310,470 Z\", cx: 360, cy: 455 },\n  PE: { name: \"Pernambuco\", path: \"M450,220 L510,210 L520,245 L460,255 Z\", cx: 485, cy: 235 },\n  PI: { name: \"Piauí\", path: \"M400,170 L450,160 L465,220 L420,240 L390,210 Z\", cx: 427, cy: 200 },\n  RJ: { name: \"Rio de Janeiro\", path: \"M430,400 L470,390 L485,420 L450,435 Z\", cx: 457, cy: 410 },\n  RN: { name: \"Rio Grande do Norte\", path: \"M480,180 L515,175 L520,200 L490,205 Z\", cx: 500, cy: 190 },\n  RS: { name: \"Rio Grande do Sul\", path: \"M310,500 L380,490 L400,560 L340,580 L290,550 Z\", cx: 345, cy: 535 },\n  RO: { name: \"Rondônia\", path: \"M160,280 L220,270 L230,330 L190,350 L150,330 Z\", cx: 190, cy: 310 },\n  RR: { name: \"Roraima\", path: \"M180,60 L230,50 L250,110 L210,130 L170,100 Z\", cx: 210, cy: 90 },\n  SC: { name: \"Santa Catarina\", path: \"M350,490 L410,480 L425,520 L375,535 Z\", cx: 387, cy: 505 },\n  SP: { name: \"São Paulo\", path: \"M350,400 L430,380 L460,440 L400,470 L340,450 Z\", cx: 395, cy: 425 },\n  SE: { name: \"Sergipe\", path: \"M485,270 L510,265 L515,285 L490,290 Z\", cx: 500, cy: 277 },\n  TO: { name: \"Tocantins\", path: \"M340,200 L390,190 L410,260 L370,290 L330,260 Z\", cx: 365, cy: 240 },\n};\n\nfunction formatNumber(num: number): string {\n  if (num >= 1000000000) return (num / 1000000000).toFixed(1) + \"B\";\n  if (num >= 1000000) return (num / 1000000).toFixed(1) + \"M\";\n  if (num >= 1000) return (num / 1000).toFixed(1) + \"K\";\n  return num.toLocaleString(\"pt-BR\");\n}\n\nfunction formatBytes(bytes: number): string {\n  if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(1) + \" GB\";\n  if (bytes >= 1048576) return (bytes / 1048576).toFixed(1) + \" MB\";\n  if (bytes >= 1024) return (bytes / 1024).toFixed(1) + \" KB\";\n  return bytes + \" B\";\n}\n\nfunction getStatusColor(status: string): string {\n  switch (status) {\n    case \"completed\": return \"text-green-500\";\n    case \"failed\": return \"text-red-500\";\n    case \"downloading\": case \"processing\": case \"running\": case \"extracting\": return \"text-blue-500\";\n    default: return \"text-muted-foreground\";\n  }\n}\n\nfunction getStatusIcon(status: string) {\n  switch (status) {\n    case \"completed\": return <CheckCircle2 className=\"h-4 w-4 text-green-500\" />;\n    case \"failed\": return <XCircle className=\"h-4 w-4 text-red-500\" />;\n    case \"downloading\": return <Download className=\"h-4 w-4 text-blue-500 animate-pulse\" />;\n    case \"processing\": case \"running\": case \"extracting\": return <Loader2 className=\"h-4 w-4 text-blue-500 animate-spin\" />;\n    default: return <Clock className=\"h-4 w-4 text-muted-foreground\" />;\n  }\n}\n\nfunction CustomPieTooltip({ active, payload }: any) {\n  if (!active || !payload || !payload.length) return null;\n  const data = payload[0].payload;\n  return (\n    <div className=\"bg-background border rounded-lg shadow-lg p-3\">\n      <p className=\"font-semibold text-sm\">{data.party}</p>\n      <p className=\"text-sm\"><span className=\"text-muted-foreground\">Votos:</span> {formatNumber(data.votes)}</p>\n      <p className=\"text-sm\"><span className=\"text-muted-foreground\">Percentual:</span> {data.percentage?.toFixed(1)}%</p>\n    </div>\n  );\n}\n\nexport default function ElectoralDashboard() {\n  const { toast } = useToast();\n  const [selectedYear, setSelectedYear] = useState<string>(\"all\");\n  const [selectedState, setSelectedState] = useState<string | null>(null);\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [simulationYear, setSimulationYear] = useState<string>(\"2022\");\n  const [simulationSpeed, setSimulationSpeed] = useState<string>(\"1\");\n\n  const electionWs = useElectionWebSocket(activeTab === \"live\");\n\n  const startSimulationMutation = useMutation({\n    mutationFn: async (params: { year: number; speed: number }) => {\n      return apiRequest(\"POST\", \"/api/election-simulation/start\", params);\n    },\n    onSuccess: () => {\n      toast({ title: \"Simulação iniciada\", description: \"A apuração em tempo real começou\" });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error instanceof Error ? error.message : \"Falha ao iniciar simulação\", variant: \"destructive\" });\n    },\n  });\n\n  const pauseSimulationMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"POST\", `/api/election-simulation/${id}/pause`, {});\n    },\n    onSuccess: () => {\n      electionWs.setStatus(\"paused\");\n      toast({ title: \"Simulação pausada\" });\n    },\n  });\n\n  const resumeSimulationMutation = useMutation({\n    mutationFn: async ({ id, speed }: { id: string; speed: number }) => {\n      return apiRequest(\"POST\", `/api/election-simulation/${id}/resume`, { speed });\n    },\n    onSuccess: () => {\n      electionWs.setStatus(\"running\");\n      toast({ title: \"Simulação retomada\" });\n    },\n  });\n\n  const cancelSimulationMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"POST\", `/api/election-simulation/${id}/cancel`, {});\n    },\n    onSuccess: () => {\n      electionWs.reset();\n      toast({ title: \"Simulação cancelada\" });\n    },\n  });\n\n  const yearQuery = selectedYear !== \"all\" ? `?year=${selectedYear}` : \"\";\n\n  const { data: years } = useQuery<number[]>({\n    queryKey: [\"/api/analytics/election-years\"],\n  });\n\n  const { data: summary, isLoading: summaryLoading } = useQuery<{\n    totalVotes: number;\n    totalCandidates: number;\n    totalParties: number;\n    totalMunicipalities: number;\n  }>({\n    queryKey: [`/api/analytics/summary${yearQuery}`],\n  });\n\n  const { data: votesByParty, isLoading: partyLoading } = useQuery<{\n    party: string;\n    partyNumber: number | null;\n    votes: number;\n    candidateCount: number;\n  }[]>({\n    queryKey: [`/api/analytics/votes-by-party${yearQuery}`],\n  });\n\n  const { data: topCandidates, isLoading: candidatesLoading } = useQuery<{\n    name: string;\n    nickname: string | null;\n    party: string | null;\n    number: number | null;\n    state: string | null;\n    position: string | null;\n    votes: number;\n  }[]>({\n    queryKey: [`/api/analytics/top-candidates${yearQuery}`],\n  });\n\n  const { data: votesByState, isLoading: stateLoading } = useQuery<{\n    state: string;\n    votes: number;\n    candidateCount: number;\n    partyCount: number;\n  }[]>({\n    queryKey: [`/api/analytics/votes-by-state${yearQuery}`],\n  });\n\n  const { data: importJobs, isLoading: importsLoading, refetch: refetchImports } = useQuery<TseImportJob[]>({\n    queryKey: [\"/api/imports/tse\"],\n    refetchInterval: 5000,\n  });\n\n  const { data: sentimentTrends, isLoading: sentimentLoading } = useQuery<{\n    entities: {\n      type: string;\n      id: string;\n      name: string;\n      avgSentiment: number;\n      totalMentions: number;\n      trend: string;\n    }[];\n  }>({\n    queryKey: [\"/api/sentiment/entities-overview\"],\n  });\n\n  const { data: crisisAlerts } = useQuery<{\n    id: number;\n    entityType: string;\n    entityName: string;\n    severity: string;\n    title: string;\n    detectedAt: string;\n    isAcknowledged: boolean;\n  }[]>({\n    queryKey: [\"/api/sentiment/crisis-alerts/unacknowledged\"],\n    refetchInterval: 30000,\n  });\n\n  const partyChartData = useMemo(() => {\n    if (!votesByParty) return [];\n    const totalVotes = votesByParty.reduce((sum, p) => sum + p.votes, 0);\n    return votesByParty.slice(0, 10).map(p => ({\n      ...p,\n      percentage: (p.votes / totalVotes) * 100,\n    }));\n  }, [votesByParty]);\n\n  const candidateChartData = useMemo(() => {\n    if (!topCandidates) return [];\n    return topCandidates.slice(0, 10).map(c => ({\n      name: c.nickname || c.name.split(\" \").slice(0, 2).join(\" \"),\n      fullName: c.name,\n      party: c.party,\n      votes: c.votes,\n      state: c.state,\n    }));\n  }, [topCandidates]);\n\n  const stateVotesMap = useMemo(() => {\n    if (!votesByState) return {};\n    const map: { [key: string]: number } = {};\n    votesByState.forEach(s => { map[s.state] = s.votes; });\n    return map;\n  }, [votesByState]);\n\n  const maxStateVotes = useMemo(() => {\n    if (!votesByState || votesByState.length === 0) return 1;\n    return Math.max(...votesByState.map(s => s.votes));\n  }, [votesByState]);\n\n  const getStateColor = (stateCode: string) => {\n    const votes = stateVotesMap[stateCode] || 0;\n    if (votes === 0) return \"#e5e7eb\";\n    const intensity = Math.min(0.9, 0.2 + (votes / maxStateVotes) * 0.7);\n    return `rgba(0, 51, 102, ${intensity})`;\n  };\n\n  const selectedStateData = useMemo(() => {\n    if (!selectedState || !votesByState) return null;\n    return votesByState.find(s => s.state === selectedState) || null;\n  }, [selectedState, votesByState]);\n\n  const importStats = useMemo(() => {\n    if (!importJobs) return { total: 0, completed: 0, failed: 0, active: 0, totalRows: 0, totalSize: 0 };\n    return {\n      total: importJobs.length,\n      completed: importJobs.filter(j => j.status === \"completed\").length,\n      failed: importJobs.filter(j => j.status === \"failed\").length,\n      active: importJobs.filter(j => [\"downloading\", \"processing\", \"running\", \"extracting\", \"pending\"].includes(j.status)).length,\n      totalRows: importJobs.reduce((sum, j) => sum + (j.processedRows || 0), 0),\n      totalSize: importJobs.reduce((sum, j) => sum + j.fileSize, 0),\n    };\n  }, [importJobs]);\n\n  const recentImports = useMemo(() => {\n    if (!importJobs) return [];\n    return importJobs.slice(0, 5);\n  }, [importJobs]);\n\n  const hasData = summary && (summary.totalVotes > 0 || summary.totalCandidates > 0);\n\n  const getTrendIcon = (trend: \"up\" | \"down\" | \"stable\") => {\n    switch (trend) {\n      case \"up\": return <TrendingUp className=\"h-4 w-4 text-green-500\" />;\n      case \"down\": return <TrendingDown className=\"h-4 w-4 text-red-500\" />;\n      default: return <Minus className=\"h-4 w-4 text-muted-foreground\" />;\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"electoral-dashboard\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold flex items-center gap-3\" data-testid=\"text-dashboard-title\">\n            <BarChart3 className=\"h-8 w-8 text-primary\" />\n            Dashboard Eleitoral\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Visão geral consolidada dos dados eleitorais e análise em tempo real\n          </p>\n        </div>\n        <div className=\"flex items-center gap-3 flex-wrap\">\n          {activeTab === \"overview\" && (\n            <Select value={selectedYear} onValueChange={setSelectedYear}>\n              <SelectTrigger className=\"w-[150px]\" data-testid=\"select-year\">\n                <SelectValue placeholder=\"Ano\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\" data-testid=\"select-year-all\">Todos os anos</SelectItem>\n                {years?.map(year => (\n                  <SelectItem key={year} value={String(year)} data-testid={`select-year-${year}`}>{year}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          )}\n          <Button variant=\"outline\" size=\"icon\" onClick={() => refetchImports()} data-testid=\"button-refresh\">\n            <RefreshCw className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"grid w-full grid-cols-2 lg:w-auto lg:inline-flex\">\n          <TabsTrigger value=\"overview\" className=\"gap-2\" data-testid=\"tab-overview\">\n            <BarChart3 className=\"h-4 w-4\" />\n            Visão Geral\n          </TabsTrigger>\n          <TabsTrigger value=\"live\" className=\"gap-2\" data-testid=\"tab-live\">\n            <Radio className=\"h-4 w-4\" />\n            Apuração ao Vivo\n            {electionWs.status === \"running\" && (\n              <span className=\"ml-1 h-2 w-2 rounded-full bg-red-500 animate-pulse\" />\n            )}\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"live\" className=\"space-y-6\">\n          <Card data-testid=\"card-live-simulation\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Zap className=\"h-5 w-5 text-yellow-500\" />\n                Simulação de Apuração em Tempo Real\n              </CardTitle>\n              <CardDescription>\n                Simule a apuração de votos com atualizações ao vivo e projeções baseadas em dados históricos\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              {electionWs.connectionError && (\n                <div className=\"flex items-center gap-2 p-3 rounded-lg bg-destructive/10 text-destructive mb-4\" data-testid=\"alert-connection-error\">\n                  <XCircle className=\"h-5 w-5\" />\n                  <span data-testid=\"text-connection-error\">Erro de conexão. A simulação pode não receber atualizações em tempo real.</span>\n                  <Button variant=\"outline\" size=\"sm\" onClick={() => electionWs.connect()} className=\"ml-auto\" data-testid=\"button-reconnect\">\n                    Reconectar\n                  </Button>\n                </div>\n              )}\n\n              {electionWs.status === \"idle\" ? (\n                <div className=\"space-y-4\">\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Ano da Eleição</label>\n                      <Select value={simulationYear} onValueChange={setSimulationYear}>\n                        <SelectTrigger data-testid=\"select-simulation-year\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {years?.map(year => (\n                            <SelectItem key={year} value={String(year)}>{year}</SelectItem>\n                          ))}\n                          {(!years || years.length === 0) && (\n                            <SelectItem value=\"2022\">2022</SelectItem>\n                          )}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Velocidade</label>\n                      <Select value={simulationSpeed} onValueChange={setSimulationSpeed}>\n                        <SelectTrigger data-testid=\"select-simulation-speed\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"0.5\">0.5x (Lento)</SelectItem>\n                          <SelectItem value=\"1\">1x (Normal)</SelectItem>\n                          <SelectItem value=\"2\">2x (Rápido)</SelectItem>\n                          <SelectItem value=\"5\">5x (Muito Rápido)</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"flex items-end\">\n                      <Button\n                        onClick={() => startSimulationMutation.mutate({\n                          year: parseInt(simulationYear),\n                          speed: parseFloat(simulationSpeed),\n                        })}\n                        disabled={startSimulationMutation.isPending}\n                        className=\"w-full\"\n                        data-testid=\"button-start-simulation\"\n                      >\n                        {startSimulationMutation.isPending ? (\n                          <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                        ) : (\n                          <Play className=\"h-4 w-4 mr-2\" />\n                        )}\n                        Iniciar Simulação\n                      </Button>\n                    </div>\n                  </div>\n                  <div className=\"text-center text-muted-foreground py-8 border rounded-lg border-dashed\">\n                    <Radio className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                    <p>Selecione o ano e inicie a simulação para ver a apuração ao vivo</p>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"space-y-6\">\n                  <div className=\"flex items-center justify-between flex-wrap gap-4\">\n                    <div className=\"flex items-center gap-3\">\n                      <Badge variant={electionWs.status === \"running\" ? \"default\" : electionWs.status === \"completed\" ? \"secondary\" : \"outline\"}>\n                        {electionWs.status === \"running\" && <span className=\"h-2 w-2 rounded-full bg-red-500 animate-pulse mr-2\" />}\n                        {electionWs.status === \"running\" ? \"Ao Vivo\" : electionWs.status === \"completed\" ? \"Concluída\" : \"Pausada\"}\n                      </Badge>\n                      {electionWs.simulationInfo && (\n                        <span className=\"text-muted-foreground\">\n                          Eleição de {electionWs.simulationInfo.year}\n                        </span>\n                      )}\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      {electionWs.status === \"running\" && electionWs.simulationId && (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => pauseSimulationMutation.mutate(electionWs.simulationId!)}\n                          disabled={pauseSimulationMutation.isPending}\n                          data-testid=\"button-pause-simulation\"\n                        >\n                          <Pause className=\"h-4 w-4 mr-1\" />\n                          Pausar\n                        </Button>\n                      )}\n                      {electionWs.status === \"paused\" && electionWs.simulationId && (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => resumeSimulationMutation.mutate({ id: electionWs.simulationId!, speed: parseFloat(simulationSpeed) })}\n                          disabled={resumeSimulationMutation.isPending}\n                          data-testid=\"button-resume-simulation\"\n                        >\n                          <Play className=\"h-4 w-4 mr-1\" />\n                          Retomar\n                        </Button>\n                      )}\n                      {electionWs.simulationId && electionWs.status !== \"completed\" && (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => cancelSimulationMutation.mutate(electionWs.simulationId!)}\n                          disabled={cancelSimulationMutation.isPending}\n                          data-testid=\"button-cancel-simulation\"\n                        >\n                          <Square className=\"h-4 w-4 mr-1\" />\n                          Cancelar\n                        </Button>\n                      )}\n                      {electionWs.status === \"completed\" && (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => electionWs.reset()}\n                          data-testid=\"button-new-simulation\"\n                        >\n                          <RefreshCw className=\"h-4 w-4 mr-1\" />\n                          Nova Simulação\n                        </Button>\n                      )}\n                    </div>\n                  </div>\n\n                  {electionWs.latestUpdate && (\n                    <>\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center justify-between text-sm\">\n                          <span className=\"font-medium\">Progresso da Apuração</span>\n                          <span className=\"text-muted-foreground\">\n                            {electionWs.latestUpdate.percentageCounted.toFixed(1)}% apurado\n                          </span>\n                        </div>\n                        <Progress value={electionWs.latestUpdate.percentageCounted} className=\"h-3\" />\n                        <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                          <span>\n                            {formatNumber(electionWs.latestUpdate.countedVotes)} de {formatNumber(electionWs.latestUpdate.totalVotes)} votos\n                          </span>\n                          <span>\n                            {electionWs.latestUpdate.regionsCounted} de {electionWs.latestUpdate.totalRegions} regiões\n                          </span>\n                        </div>\n                      </div>\n\n                      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                        <Card>\n                          <CardHeader className=\"pb-2\">\n                            <CardTitle className=\"text-base flex items-center gap-2\">\n                              <Building2 className=\"h-4 w-4\" />\n                              Votos por Partido\n                            </CardTitle>\n                          </CardHeader>\n                          <CardContent>\n                            <div className=\"space-y-3\">\n                              {electionWs.latestUpdate.partyResults.slice(0, 8).map((party, idx) => (\n                                <div key={party.party} className=\"space-y-1\" data-testid={`live-party-${idx}`}>\n                                  <div className=\"flex items-center justify-between text-sm\">\n                                    <div className=\"flex items-center gap-2\">\n                                      <div\n                                        className=\"w-3 h-3 rounded-full\"\n                                        style={{ backgroundColor: CHART_COLORS[idx % CHART_COLORS.length] }}\n                                      />\n                                      <span className=\"font-medium\">{party.party}</span>\n                                    </div>\n                                    <div className=\"flex items-center gap-2\">\n                                      <span className=\"text-muted-foreground\">{formatNumber(party.votes)}</span>\n                                      <Badge variant=\"outline\" className=\"font-mono text-xs\">\n                                        {party.percentage.toFixed(1)}%\n                                      </Badge>\n                                    </div>\n                                  </div>\n                                  <Progress value={party.percentage} className=\"h-1.5\" />\n                                </div>\n                              ))}\n                            </div>\n                          </CardContent>\n                        </Card>\n\n                        <Card>\n                          <CardHeader className=\"pb-2\">\n                            <CardTitle className=\"text-base flex items-center gap-2\">\n                              <Users className=\"h-4 w-4\" />\n                              Candidatos Mais Votados\n                            </CardTitle>\n                          </CardHeader>\n                          <CardContent>\n                            <div className=\"space-y-3\">\n                              {electionWs.latestUpdate.candidateResults.slice(0, 8).map((candidate, idx) => (\n                                <div key={candidate.name} className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\" data-testid={`live-candidate-${idx}`}>\n                                  <div className=\"flex items-center gap-3\">\n                                    <span className=\"text-lg font-bold text-muted-foreground\">{idx + 1}</span>\n                                    <div>\n                                      <p className=\"font-medium text-sm truncate max-w-[150px]\">{candidate.name.split(\" \").slice(0, 2).join(\" \")}</p>\n                                      <p className=\"text-xs text-muted-foreground\">{candidate.party}</p>\n                                    </div>\n                                  </div>\n                                  <div className=\"text-right\">\n                                    <p className=\"font-mono font-bold\">{formatNumber(candidate.votes)}</p>\n                                    <p className=\"text-xs text-muted-foreground\">{candidate.percentage.toFixed(1)}%</p>\n                                  </div>\n                                </div>\n                              ))}\n                            </div>\n                          </CardContent>\n                        </Card>\n                      </div>\n                    </>\n                  )}\n\n                  {electionWs.latestProjection && electionWs.latestUpdate && electionWs.latestUpdate.percentageCounted >= 5 && (\n                    <Card className=\"border-yellow-500/50 bg-yellow-500/5\">\n                      <CardHeader className=\"pb-2\">\n                        <CardTitle className=\"text-base flex items-center gap-2\">\n                          <Activity className=\"h-4 w-4 text-yellow-500\" />\n                          Projeções em Tempo Real\n                          <Badge variant=\"outline\" className=\"ml-auto\">\n                            Confiança: {electionWs.latestProjection.percentageCounted.toFixed(0)}%\n                          </Badge>\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                          <div>\n                            <h4 className=\"text-sm font-medium mb-3\">Projeção por Partido</h4>\n                            <div className=\"space-y-2\">\n                              {electionWs.latestProjection.partyProjections.slice(0, 5).map((proj, idx) => (\n                                <div key={proj.party} className=\"flex items-center justify-between p-2 rounded-lg bg-background\" data-testid={`projection-party-${idx}`}>\n                                  <div className=\"flex items-center gap-2\">\n                                    {getTrendIcon(proj.trend)}\n                                    <span className=\"font-medium\">{proj.party}</span>\n                                  </div>\n                                  <div className=\"flex items-center gap-3\">\n                                    <span className=\"text-sm text-muted-foreground\">\n                                      Atual: {formatNumber(proj.currentVotes)}\n                                    </span>\n                                    <span className=\"font-mono font-bold\">\n                                      Proj: {formatNumber(proj.projectedVotes)}\n                                    </span>\n                                    <Badge variant=\"secondary\" className=\"text-xs\">\n                                      {proj.confidence.toFixed(0)}%\n                                    </Badge>\n                                  </div>\n                                </div>\n                              ))}\n                            </div>\n                          </div>\n                          <div>\n                            <h4 className=\"text-sm font-medium mb-3\">Candidatos Líderes</h4>\n                            <div className=\"space-y-2\">\n                              {electionWs.latestProjection.leadingCandidates.map((candidate, idx) => (\n                                <div key={candidate.name} className=\"flex items-center justify-between p-2 rounded-lg bg-background\" data-testid={`projection-candidate-${idx}`}>\n                                  <div>\n                                    <p className=\"font-medium text-sm\">{candidate.name.split(\" \").slice(0, 2).join(\" \")}</p>\n                                    <p className=\"text-xs text-muted-foreground\">{candidate.party}</p>\n                                  </div>\n                                  <div className=\"text-right\">\n                                    <p className=\"font-mono text-sm\">Proj: {formatNumber(candidate.projectedVotes)}</p>\n                                    <Progress value={candidate.winProbability} className=\"h-1.5 w-20 mt-1\" />\n                                  </div>\n                                </div>\n                              ))}\n                            </div>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  )}\n\n                  {electionWs.completedData && (\n                    <Card className=\"border-green-500/50 bg-green-500/5\">\n                      <CardHeader>\n                        <CardTitle className=\"flex items-center gap-2 text-green-600\">\n                          <CheckCircle2 className=\"h-5 w-5\" />\n                          Apuração Concluída\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <p className=\"text-muted-foreground mb-4\">\n                          Total de {formatNumber(electionWs.completedData.totalVotes)} votos apurados em {Math.floor(electionWs.completedData.duration / 1000)} segundos.\n                        </p>\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                          {electionWs.completedData.partyResults.slice(0, 4).map((party, idx) => (\n                            <Card key={party.party} data-testid={`final-party-${idx}`}>\n                              <CardContent className=\"p-4 text-center\">\n                                <div\n                                  className=\"w-8 h-8 rounded-full mx-auto mb-2\"\n                                  style={{ backgroundColor: CHART_COLORS[idx % CHART_COLORS.length] }}\n                                />\n                                <p className=\"font-bold\">{party.party}</p>\n                                <p className=\"text-2xl font-mono\">{party.percentage.toFixed(1)}%</p>\n                                <p className=\"text-xs text-muted-foreground\">{formatNumber(party.votes)} votos</p>\n                              </CardContent>\n                            </Card>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  )}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"overview\" className=\"space-y-6\">\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card data-testid=\"card-total-votes\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total de Votos</CardTitle>\n            <Vote className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            {summaryLoading ? (\n              <Skeleton className=\"h-8 w-24\" />\n            ) : (\n              <div className=\"text-2xl font-bold\" data-testid=\"text-total-votes\">\n                {formatNumber(summary?.totalVotes || 0)}\n              </div>\n            )}\n            <p className=\"text-xs text-muted-foreground\">votos registrados</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-candidates\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Candidatos</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            {summaryLoading ? (\n              <Skeleton className=\"h-8 w-24\" />\n            ) : (\n              <div className=\"text-2xl font-bold\" data-testid=\"text-total-candidates\">\n                {formatNumber(summary?.totalCandidates || 0)}\n              </div>\n            )}\n            <p className=\"text-xs text-muted-foreground\">candidaturas</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-parties\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Partidos</CardTitle>\n            <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            {summaryLoading ? (\n              <Skeleton className=\"h-8 w-24\" />\n            ) : (\n              <div className=\"text-2xl font-bold\" data-testid=\"text-total-parties\">\n                {formatNumber(summary?.totalParties || 0)}\n              </div>\n            )}\n            <p className=\"text-xs text-muted-foreground\">partidos ativos</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-imports-status\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Importações</CardTitle>\n            <Database className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            {importsLoading ? (\n              <Skeleton className=\"h-8 w-24\" />\n            ) : (\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-2xl font-bold\" data-testid=\"text-imports-completed\">{importStats.completed}</span>\n                <span className=\"text-muted-foreground\">/</span>\n                <span className=\"text-lg\">{importStats.total}</span>\n                {importStats.active > 0 && (\n                  <Badge variant=\"secondary\" className=\"ml-2\">\n                    <Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />\n                    {importStats.active} ativa{importStats.active > 1 ? \"s\" : \"\"}\n                  </Badge>\n                )}\n              </div>\n            )}\n            <p className=\"text-xs text-muted-foreground\">{formatNumber(importStats.totalRows)} registros importados</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card className=\"lg:col-span-1\" data-testid=\"card-brazil-map\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <MapPin className=\"h-5 w-5\" />\n              Distribuição por Estado\n            </CardTitle>\n            <CardDescription>Clique em um estado para ver detalhes</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {stateLoading ? (\n              <div className=\"flex items-center justify-center h-[400px]\" data-testid=\"loading-map\">\n                <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n              </div>\n            ) : (\n              <div className=\"relative\">\n                <svg viewBox=\"50 30 500 580\" className=\"w-full h-[300px]\" data-testid=\"brazil-map-svg\">\n                  {Object.entries(BRAZIL_STATES).map(([code, state]) => (\n                    <Tooltip key={code}>\n                      <TooltipTrigger asChild>\n                        <g \n                          className=\"cursor-pointer\"\n                          onClick={() => setSelectedState(selectedState === code ? null : code)}\n                          data-testid={`map-state-group-${code}`}\n                          role=\"button\"\n                          tabIndex={0}\n                          aria-label={`${state.name}: ${formatNumber(stateVotesMap[code] || 0)} votos`}\n                          onKeyDown={(e) => {\n                            if (e.key === 'Enter' || e.key === ' ') {\n                              setSelectedState(selectedState === code ? null : code);\n                            }\n                          }}\n                        >\n                          <path\n                            d={state.path}\n                            fill={getStateColor(code)}\n                            stroke={selectedState === code ? \"#FFD700\" : \"#fff\"}\n                            strokeWidth={selectedState === code ? \"3\" : \"1\"}\n                            data-testid={`map-state-${code}`}\n                          />\n                          <text\n                            x={state.cx}\n                            y={state.cy}\n                            textAnchor=\"middle\"\n                            dominantBaseline=\"middle\"\n                            fontSize=\"10\"\n                            fill={stateVotesMap[code] ? \"#fff\" : \"#666\"}\n                            fontWeight=\"bold\"\n                            data-testid={`text-state-code-${code}`}\n                          >\n                            {code}\n                          </text>\n                        </g>\n                      </TooltipTrigger>\n                      <TooltipContent data-testid={`tooltip-state-${code}`}>\n                        <div className=\"text-sm\">\n                          <p className=\"font-semibold\">{state.name} ({code})</p>\n                          <p>Votos: {formatNumber(stateVotesMap[code] || 0)}</p>\n                          <p className=\"text-xs text-muted-foreground mt-1\">Clique para detalhes</p>\n                        </div>\n                      </TooltipContent>\n                    </Tooltip>\n                  ))}\n                </svg>\n                <div className=\"flex items-center justify-between mt-2\" data-testid=\"map-legend\">\n                  <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                    <div className=\"flex items-center gap-1\">\n                      <div className=\"w-3 h-3 rounded\" style={{ backgroundColor: \"rgba(0, 51, 102, 0.2)\" }} data-testid=\"legend-color-min\" />\n                      <span data-testid=\"legend-label-min\">Menos votos</span>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <div className=\"w-3 h-3 rounded\" style={{ backgroundColor: \"rgba(0, 51, 102, 0.9)\" }} data-testid=\"legend-color-max\" />\n                      <span data-testid=\"legend-label-max\">Mais votos</span>\n                    </div>\n                  </div>\n                  {selectedState && (\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\" \n                      onClick={() => setSelectedState(null)}\n                      data-testid=\"button-clear-state-selection\"\n                    >\n                      Limpar seleção\n                    </Button>\n                  )}\n                </div>\n                {selectedState && selectedStateData && (\n                  <Card className=\"mt-4\" data-testid=\"state-detail-panel\">\n                    <CardContent className=\"pt-4\">\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <h4 className=\"font-semibold text-lg\" data-testid=\"text-selected-state-name\">\n                          {BRAZIL_STATES[selectedState]?.name} ({selectedState})\n                        </h4>\n                        <Badge variant=\"secondary\" data-testid=\"badge-selected-state\">{selectedState}</Badge>\n                      </div>\n                      <div className=\"grid grid-cols-3 gap-4 text-center\">\n                        <div>\n                          <p className=\"text-2xl font-bold\" data-testid=\"text-state-votes\">\n                            {formatNumber(selectedStateData.votes)}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\" data-testid=\"label-state-votes\">Votos</p>\n                        </div>\n                        <div>\n                          <p className=\"text-2xl font-bold\" data-testid=\"text-state-candidates\">\n                            {formatNumber(selectedStateData.candidateCount)}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\" data-testid=\"label-state-candidates\">Candidatos</p>\n                        </div>\n                        <div>\n                          <p className=\"text-2xl font-bold\" data-testid=\"text-state-parties\">\n                            {formatNumber(selectedStateData.partyCount)}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\" data-testid=\"label-state-parties\">Partidos</p>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                )}\n                {selectedState && !selectedStateData && (\n                  <Card className=\"mt-4\" data-testid=\"state-no-data\">\n                    <CardContent className=\"pt-4 text-center text-muted-foreground\">\n                      <p>Sem dados disponíveis para {BRAZIL_STATES[selectedState]?.name}</p>\n                    </CardContent>\n                  </Card>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-party-performance\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Building2 className=\"h-5 w-5\" />\n              Top 10 Partidos\n            </CardTitle>\n            <CardDescription>Distribuição de votos por partido</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {partyLoading ? (\n              <div className=\"flex items-center justify-center h-[350px]\" data-testid=\"loading-party-chart\">\n                <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n              </div>\n            ) : partyChartData.length > 0 ? (\n              <div data-testid=\"chart-party-pie\">\n                <ResponsiveContainer width=\"100%\" height={350}>\n                  <PieChart>\n                    <Pie\n                      data={partyChartData}\n                      dataKey=\"votes\"\n                      nameKey=\"party\"\n                      cx=\"50%\"\n                      cy=\"50%\"\n                      outerRadius={120}\n                      label={({ party, percentage }) => `${party} (${percentage.toFixed(1)}%)`}\n                      labelLine={false}\n                    >\n                      {partyChartData.map((_, index) => (\n                        <Cell key={`cell-${index}`} fill={CHART_COLORS[index % CHART_COLORS.length]} />\n                      ))}\n                    </Pie>\n                    <RechartsTooltip content={<CustomPieTooltip />} />\n                  </PieChart>\n                </ResponsiveContainer>\n              </div>\n            ) : (\n              <div className=\"flex flex-col items-center justify-center h-[350px] text-muted-foreground\" data-testid=\"empty-party-chart\">\n                <Building2 className=\"h-12 w-12 mb-2 opacity-50\" />\n                <p>Sem dados de partidos</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        <Card className=\"lg:col-span-2\" data-testid=\"card-top-candidates\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <TrendingUp className=\"h-5 w-5\" />\n              Candidatos Mais Votados\n            </CardTitle>\n            <CardDescription>Top 10 candidatos por número de votos</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {candidatesLoading ? (\n              <div className=\"flex items-center justify-center h-[300px]\" data-testid=\"loading-candidates-chart\">\n                <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n              </div>\n            ) : candidateChartData.length > 0 ? (\n              <div data-testid=\"chart-candidates-bar\">\n                <ResponsiveContainer width=\"100%\" height={300}>\n                  <BarChart data={candidateChartData} layout=\"vertical\">\n                    <CartesianGrid strokeDasharray=\"3 3\" horizontal={true} vertical={false} />\n                    <XAxis type=\"number\" tickFormatter={formatNumber} />\n                    <YAxis type=\"category\" dataKey=\"name\" width={120} tick={{ fontSize: 12 }} />\n                    <RechartsTooltip\n                      content={({ active, payload }) => {\n                        if (!active || !payload?.length) return null;\n                        const data = payload[0].payload;\n                        return (\n                          <div className=\"bg-background border rounded-lg shadow-lg p-3\" data-testid=\"tooltip-candidate\">\n                            <p className=\"font-semibold\">{data.fullName}</p>\n                            <p className=\"text-sm\"><span className=\"text-muted-foreground\">Partido:</span> {data.party}</p>\n                            <p className=\"text-sm\"><span className=\"text-muted-foreground\">Estado:</span> {data.state}</p>\n                            <p className=\"text-sm\"><span className=\"text-muted-foreground\">Votos:</span> {formatNumber(data.votes)}</p>\n                          </div>\n                        );\n                      }}\n                    />\n                    <Bar dataKey=\"votes\" fill=\"#003366\" radius={[0, 4, 4, 0]} />\n                  </BarChart>\n                </ResponsiveContainer>\n              </div>\n            ) : (\n              <div className=\"flex flex-col items-center justify-center h-[300px] text-muted-foreground\" data-testid=\"empty-candidates-chart\">\n                <Users className=\"h-12 w-12 mb-2 opacity-50\" />\n                <p>Sem dados de candidatos</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-import-status\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center justify-between\">\n              <span className=\"flex items-center gap-2\">\n                <Activity className=\"h-5 w-5\" />\n                Status das Importações\n              </span>\n              <Link href=\"/tse-import\">\n                <Button variant=\"ghost\" size=\"sm\" data-testid=\"link-view-all-imports\">\n                  Ver todas\n                </Button>\n              </Link>\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {importsLoading ? (\n              <div className=\"space-y-3\" data-testid=\"loading-imports\">\n                {[1, 2, 3].map(i => (\n                  <Skeleton key={i} className=\"h-16 w-full\" />\n                ))}\n              </div>\n            ) : recentImports.length > 0 ? (\n              <>\n                <div className=\"grid grid-cols-3 gap-2 text-center pb-3 border-b\">\n                  <div>\n                    <p className=\"text-2xl font-bold text-green-500\" data-testid=\"text-completed-count\">{importStats.completed}</p>\n                    <p className=\"text-xs text-muted-foreground\">Concluídas</p>\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold text-blue-500\" data-testid=\"text-active-count\">{importStats.active}</p>\n                    <p className=\"text-xs text-muted-foreground\">Em andamento</p>\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold text-red-500\" data-testid=\"text-failed-count\">{importStats.failed}</p>\n                    <p className=\"text-xs text-muted-foreground\">Falhas</p>\n                  </div>\n                </div>\n                <div className=\"space-y-3\">\n                  {recentImports.map(job => (\n                    <div key={job.id} className=\"flex items-start gap-3 p-2 rounded-lg bg-muted/50\" data-testid={`import-job-${job.id}`}>\n                      {getStatusIcon(job.status)}\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"text-sm font-medium truncate\">{job.filename.replace(\"[URL] \", \"\")}</p>\n                        <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                          <span>{job.electionYear || \"—\"}</span>\n                          <span>•</span>\n                          <span>{formatBytes(job.fileSize)}</span>\n                          {job.processedRows && job.processedRows > 0 && (\n                            <>\n                              <span>•</span>\n                              <span>{formatNumber(job.processedRows)} registros</span>\n                            </>\n                          )}\n                        </div>\n                        {[\"downloading\", \"processing\", \"running\", \"extracting\"].includes(job.status) && (\n                          <Progress value={job.processedRows && job.totalRows ? (job.processedRows / job.totalRows) * 100 : 30} className=\"mt-1 h-1\" />\n                        )}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </>\n            ) : (\n              <div className=\"flex flex-col items-center justify-center h-[200px] text-muted-foreground\" data-testid=\"empty-imports\">\n                <Database className=\"h-12 w-12 mb-2 opacity-50\" />\n                <p>Nenhuma importação registrada</p>\n                <Link href=\"/tse-import\">\n                  <Button variant=\"ghost\" size=\"sm\" className=\"mt-2\" data-testid=\"button-start-import-small\">\n                    Iniciar importação\n                  </Button>\n                </Link>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n          {sentimentTrends && sentimentTrends.entities && sentimentTrends.entities.length > 0 && (\n            <Card data-testid=\"card-sentiment-trends\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Activity className=\"h-5 w-5\" />\n                  Tendências de Sentimento\n                </CardTitle>\n                <CardDescription>Análise de sentimento público sobre entidades políticas</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  {crisisAlerts && crisisAlerts.length > 0 && (\n                    <div className=\"mb-4 p-3 bg-destructive/10 border border-destructive/20 rounded-lg\">\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        <Zap className=\"h-4 w-4 text-destructive\" />\n                        <span className=\"font-medium text-sm\">Alertas de Crise Ativos</span>\n                        <Badge variant=\"destructive\">{crisisAlerts.length}</Badge>\n                      </div>\n                      <div className=\"space-y-1\">\n                        {crisisAlerts.slice(0, 3).map((alert) => (\n                          <div key={alert.id} className=\"text-sm flex items-center gap-2\">\n                            <span className=\"text-muted-foreground\">{alert.entityName}:</span>\n                            <span>{alert.title}</span>\n                          </div>\n                        ))}\n                        {crisisAlerts.length > 3 && (\n                          <Link href=\"/sentiment-analysis?tab=alertas\">\n                            <Button variant=\"ghost\" size=\"sm\" className=\"p-0 h-auto text-primary underline-offset-4 hover:underline\">\n                              Ver todos os {crisisAlerts.length} alertas\n                            </Button>\n                          </Link>\n                        )}\n                      </div>\n                    </div>\n                  )}\n                  \n                  <div className=\"h-[200px]\">\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\n                      <BarChart\n                        data={sentimentTrends.entities.slice(0, 8)}\n                        layout=\"vertical\"\n                        margin={{ top: 5, right: 30, left: 80, bottom: 5 }}\n                      >\n                        <CartesianGrid strokeDasharray=\"3 3\" />\n                        <XAxis type=\"number\" domain={[-1, 1]} tickFormatter={(v) => `${(v * 100).toFixed(0)}%`} />\n                        <YAxis type=\"category\" dataKey=\"name\" width={75} tick={{ fontSize: 12 }} />\n                        <RechartsTooltip \n                          formatter={(value: number) => [`${(value * 100).toFixed(1)}%`, \"Sentimento\"]}\n                        />\n                        <Bar \n                          dataKey=\"avgSentiment\" \n                          name=\"Sentimento\"\n                        >\n                          {sentimentTrends.entities.slice(0, 8).map((entry, index) => (\n                            <Cell \n                              key={`cell-${index}`} \n                              fill={entry.avgSentiment >= 0 ? \"#22c55e\" : \"#ef4444\"} \n                            />\n                          ))}\n                        </Bar>\n                      </BarChart>\n                    </ResponsiveContainer>\n                  </div>\n                  \n                  <div className=\"flex justify-end\">\n                    <Link href=\"/sentiment-analysis\">\n                      <Button variant=\"outline\" size=\"sm\" data-testid=\"button-view-sentiment-analysis\">\n                        Ver Análise Completa\n                      </Button>\n                    </Link>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {!hasData && !summaryLoading && (\n            <Card className=\"border-dashed\" data-testid=\"card-empty-state\">\n              <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                <BarChart3 className=\"h-16 w-16 text-muted-foreground mb-4 opacity-50\" />\n                <h3 className=\"text-lg font-semibold mb-2\">Nenhum dado eleitoral encontrado</h3>\n                <p className=\"text-muted-foreground text-center max-w-md mb-4\">\n                  Importe dados do TSE para começar a visualizar análises eleitorais detalhadas.\n                </p>\n                <Link href=\"/tse-import\">\n                  <Button data-testid=\"button-start-import\">\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    Importar Dados do TSE\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":57576,"size_tokens":null},"server/external-data-service.ts":{"content":"import OpenAI from \"openai\";\nimport { storage } from \"./storage\";\nimport type { InsertSentimentArticle, InsertSentimentDataSource } from \"@shared/schema\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\nexport interface ExternalArticle {\n  title: string;\n  content: string;\n  summary?: string;\n  url?: string;\n  author?: string;\n  publishedAt: Date;\n  source: string;\n  sourceType: \"news\" | \"blog\" | \"forum\" | \"social\";\n  country: string;\n  language: string;\n}\n\nexport interface SocialTrend {\n  topic: string;\n  volume: number;\n  sentiment: \"positive\" | \"negative\" | \"neutral\" | \"mixed\";\n  relatedEntities: string[];\n  source: string;\n  country: string;\n  trendingAt: Date;\n}\n\nexport interface ExternalDataConfig {\n  newsApiKey?: string;\n  enableGoogleNews: boolean;\n  enableTwitterTrends: boolean;\n  keywords: string[];\n  countries: string[];\n  languages: string[];\n  maxArticlesPerSource: number;\n}\n\nconst DEFAULT_CONFIG: ExternalDataConfig = {\n  enableGoogleNews: true,\n  enableTwitterTrends: true,\n  keywords: [\n    \"eleições brasil\",\n    \"política brasileira\",\n    \"candidatos eleições\",\n    \"PT partido\",\n    \"PL partido\",\n    \"MDB eleições\",\n    \"PSDB política\",\n    \"voto eleição\",\n    \"urna eletrônica\",\n    \"TSE eleições\",\n  ],\n  countries: [\"BR\", \"ES\", \"UK\", \"US\"],\n  languages: [\"pt\", \"es\", \"en\"],\n  maxArticlesPerSource: 20,\n};\n\nasync function fetchGoogleNewsRSS(query: string, language: string = \"pt\"): Promise<ExternalArticle[]> {\n  try {\n    const encodedQuery = encodeURIComponent(query);\n    const rssUrl = `https://news.google.com/rss/search?q=${encodedQuery}&hl=${language}&gl=BR&ceid=BR:pt`;\n    \n    const response = await fetch(rssUrl, {\n      headers: {\n        \"User-Agent\": \"Mozilla/5.0 (compatible; SimulaVoto/1.0)\",\n      },\n    });\n\n    if (!response.ok) {\n      console.error(`Google News RSS fetch failed: ${response.status}`);\n      return [];\n    }\n\n    const xmlText = await response.text();\n    const articles: ExternalArticle[] = [];\n\n    const itemRegex = /<item>([\\s\\S]*?)<\\/item>/g;\n    const titleRegex = /<title>(?:<!\\[CDATA\\[)?(.*?)(?:\\]\\]>)?<\\/title>/;\n    const linkRegex = /<link>(.*?)<\\/link>/;\n    const pubDateRegex = /<pubDate>(.*?)<\\/pubDate>/;\n    const sourceRegex = /<source[^>]*>(.*?)<\\/source>/;\n\n    let match;\n    while ((match = itemRegex.exec(xmlText)) !== null) {\n      const item = match[1];\n      const titleMatch = titleRegex.exec(item);\n      const linkMatch = linkRegex.exec(item);\n      const pubDateMatch = pubDateRegex.exec(item);\n      const sourceMatch = sourceRegex.exec(item);\n\n      if (titleMatch && titleMatch[1]) {\n        const title = titleMatch[1].replace(/<!\\[CDATA\\[|\\]\\]>/g, \"\").trim();\n        const url = linkMatch?.[1] || \"\";\n        const sourceName = sourceMatch?.[1] || \"Google News\";\n        const publishedAt = pubDateMatch?.[1] ? new Date(pubDateMatch[1]) : new Date();\n\n        articles.push({\n          title,\n          content: title,\n          url,\n          source: sourceName,\n          sourceType: \"news\",\n          country: \"BR\",\n          language,\n          publishedAt,\n        });\n      }\n    }\n\n    return articles.slice(0, 10);\n  } catch (error) {\n    console.error(\"Error fetching Google News RSS:\", error);\n    return [];\n  }\n}\n\nasync function fetchNewsAPI(apiKey: string, query: string, config: ExternalDataConfig): Promise<ExternalArticle[]> {\n  try {\n    const encodedQuery = encodeURIComponent(query);\n    const url = `https://newsapi.org/v2/everything?q=${encodedQuery}&language=pt&sortBy=publishedAt&pageSize=${config.maxArticlesPerSource}`;\n    \n    const response = await fetch(url, {\n      headers: {\n        \"X-Api-Key\": apiKey,\n      },\n    });\n\n    if (!response.ok) {\n      console.error(`NewsAPI fetch failed: ${response.status}`);\n      return [];\n    }\n\n    const data = await response.json();\n    \n    return (data.articles || []).map((article: any) => ({\n      title: article.title || \"\",\n      content: article.description || article.content || article.title || \"\",\n      summary: article.description,\n      url: article.url,\n      author: article.author,\n      publishedAt: new Date(article.publishedAt),\n      source: article.source?.name || \"NewsAPI\",\n      sourceType: \"news\" as const,\n      country: \"BR\",\n      language: \"pt\",\n    }));\n  } catch (error) {\n    console.error(\"Error fetching from NewsAPI:\", error);\n    return [];\n  }\n}\n\nasync function generateSimulatedSocialTrends(keywords: string[]): Promise<SocialTrend[]> {\n  const trends: SocialTrend[] = [];\n  const now = new Date();\n\n  const trendTemplates = [\n    { topic: \"#EleicoesBrasil\", volume: 45000, sentiment: \"mixed\" as const, relatedEntities: [\"PT\", \"PL\", \"MDB\"] },\n    { topic: \"#VotoBrasil\", volume: 32000, sentiment: \"positive\" as const, relatedEntities: [\"TSE\", \"Eleições\"] },\n    { topic: \"#PolíticaBR\", volume: 28000, sentiment: \"mixed\" as const, relatedEntities: [\"PSDB\", \"União Brasil\"] },\n    { topic: \"#Candidatos2024\", volume: 21000, sentiment: \"neutral\" as const, relatedEntities: [\"Prefeito\", \"Vereador\"] },\n    { topic: \"#UrnaEletronica\", volume: 18500, sentiment: \"positive\" as const, relatedEntities: [\"TSE\", \"Segurança\"] },\n    { topic: \"#DebateEleitoral\", volume: 15000, sentiment: \"mixed\" as const, relatedEntities: [\"Candidatos\", \"Propostas\"] },\n    { topic: \"#SaúdePública\", volume: 12000, sentiment: \"negative\" as const, relatedEntities: [\"SUS\", \"Hospitais\"] },\n    { topic: \"#EducaçãoBrasil\", volume: 11500, sentiment: \"neutral\" as const, relatedEntities: [\"Escolas\", \"MEC\"] },\n    { topic: \"#EmpregosBR\", volume: 9800, sentiment: \"mixed\" as const, relatedEntities: [\"Economia\", \"Trabalho\"] },\n    { topic: \"#SegurançaPública\", volume: 8500, sentiment: \"negative\" as const, relatedEntities: [\"Polícia\", \"Crime\"] },\n  ];\n\n  for (const template of trendTemplates) {\n    trends.push({\n      ...template,\n      source: \"Twitter/X\",\n      country: \"BR\",\n      trendingAt: now,\n    });\n  }\n\n  return trends;\n}\n\nasync function enrichArticlesWithAI(articles: ExternalArticle[]): Promise<ExternalArticle[]> {\n  if (articles.length === 0) return [];\n\n  const articlesToEnrich = articles.slice(0, 10);\n\n  try {\n    const prompt = `Analise os seguintes títulos de notícias sobre política brasileira e forneça um resumo expandido para cada um, mantendo o contexto eleitoral.\n\nTítulos:\n${articlesToEnrich.map((a, i) => `${i + 1}. ${a.title}`).join(\"\\n\")}\n\nResponda em JSON com o formato:\n{\n  \"enriched\": [\n    {\n      \"index\": 0,\n      \"expandedContent\": \"Descrição expandida em 2-3 frases sobre o contexto e implicações eleitorais\",\n      \"relevantParties\": [\"sigla1\", \"sigla2\"],\n      \"sentiment\": \"positive\" | \"negative\" | \"neutral\" | \"mixed\"\n    }\n  ]\n}`;\n\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [{ role: \"user\", content: prompt }],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2000,\n    });\n\n    const content = completion.choices[0]?.message?.content;\n    if (!content) return articles;\n\n    const result = JSON.parse(content);\n    \n    for (const item of result.enriched || []) {\n      if (item.index >= 0 && item.index < articlesToEnrich.length) {\n        articlesToEnrich[item.index].content = item.expandedContent || articlesToEnrich[item.index].content;\n        articlesToEnrich[item.index].summary = item.expandedContent;\n      }\n    }\n\n    return [\n      ...articlesToEnrich,\n      ...articles.slice(10),\n    ];\n  } catch (error) {\n    console.error(\"Error enriching articles with AI:\", error);\n    return articles;\n  }\n}\n\nexport async function fetchExternalData(config: Partial<ExternalDataConfig> = {}): Promise<{\n  articles: ExternalArticle[];\n  trends: SocialTrend[];\n  sources: { name: string; type: string; country: string; articleCount: number }[];\n}> {\n  const fullConfig = { ...DEFAULT_CONFIG, ...config };\n  const allArticles: ExternalArticle[] = [];\n  const sources: { name: string; type: string; country: string; articleCount: number }[] = [];\n\n  if (fullConfig.enableGoogleNews) {\n    for (const keyword of fullConfig.keywords.slice(0, 5)) {\n      const articles = await fetchGoogleNewsRSS(keyword, \"pt\");\n      allArticles.push(...articles);\n      \n      if (articles.length > 0) {\n        const uniqueSources = Array.from(new Set(articles.map(a => a.source)));\n        for (const sourceName of uniqueSources) {\n          const sourceArticles = articles.filter(a => a.source === sourceName);\n          if (!sources.find(s => s.name === sourceName)) {\n            sources.push({\n              name: sourceName,\n              type: \"news\",\n              country: \"BR\",\n              articleCount: sourceArticles.length,\n            });\n          }\n        }\n      }\n    }\n  }\n\n  if (fullConfig.newsApiKey) {\n    for (const keyword of fullConfig.keywords.slice(0, 3)) {\n      const articles = await fetchNewsAPI(fullConfig.newsApiKey, keyword, fullConfig);\n      allArticles.push(...articles);\n    }\n  }\n\n  const uniqueArticles = allArticles.reduce((acc, article) => {\n    const exists = acc.find(a => a.title === article.title || a.url === article.url);\n    if (!exists) {\n      acc.push(article);\n    }\n    return acc;\n  }, [] as ExternalArticle[]);\n\n  const enrichedArticles = await enrichArticlesWithAI(uniqueArticles.slice(0, 30));\n\n  const trends = fullConfig.enableTwitterTrends \n    ? await generateSimulatedSocialTrends(fullConfig.keywords)\n    : [];\n\n  return {\n    articles: enrichedArticles,\n    trends,\n    sources,\n  };\n}\n\nexport async function persistExternalData(articles: ExternalArticle[]): Promise<number> {\n  let persistedCount = 0;\n\n  for (const article of articles) {\n    try {\n      let sources = await storage.getSentimentDataSources({ sourceName: article.source } as any);\n      let sourceId: number;\n\n      if (sources.length === 0) {\n        const newSource = await storage.createSentimentDataSource({\n          sourceType: article.sourceType,\n          sourceName: article.source,\n          sourceUrl: article.url,\n          country: article.country,\n          language: article.language,\n          isActive: true,\n          lastFetched: new Date(),\n        });\n        sourceId = newSource.id;\n      } else {\n        sourceId = sources[0].id;\n      }\n\n      await storage.createSentimentArticle({\n        sourceId,\n        title: article.title,\n        content: article.content,\n        summary: article.summary,\n        url: article.url,\n        author: article.author,\n        publishedAt: article.publishedAt,\n        language: article.language,\n        country: article.country,\n      });\n\n      persistedCount++;\n    } catch (error) {\n      console.error(\"Error persisting article:\", error);\n    }\n  }\n\n  return persistedCount;\n}\n\nexport async function fetchAndAnalyzeExternalData(config?: Partial<ExternalDataConfig>): Promise<{\n  articlesCount: number;\n  trendsCount: number;\n  sourcesCount: number;\n  persistedCount: number;\n  analysis: {\n    topTopics: { topic: string; count: number }[];\n    sentimentBreakdown: { positive: number; negative: number; neutral: number; mixed: number };\n    partiesMentioned: { party: string; count: number }[];\n  };\n}> {\n  const { articles, trends, sources } = await fetchExternalData(config);\n  \n  const persistedCount = await persistExternalData(articles);\n\n  const topicCounts: Record<string, number> = {};\n  const partyMentions: Record<string, number> = {};\n  const sentimentCounts = { positive: 0, negative: 0, neutral: 0, mixed: 0 };\n\n  const partyKeywords = [\"PT\", \"PL\", \"MDB\", \"PSDB\", \"PP\", \"UNIÃO\", \"PSD\", \"REPUBLICANOS\", \"PDT\", \"PSOL\", \"NOVO\", \"PCdoB\"];\n\n  for (const article of articles) {\n    const words = article.title.toLowerCase().split(/\\s+/);\n    for (const word of words) {\n      if (word.length > 4) {\n        topicCounts[word] = (topicCounts[word] || 0) + 1;\n      }\n    }\n\n    for (const party of partyKeywords) {\n      if (article.title.toUpperCase().includes(party) || article.content.toUpperCase().includes(party)) {\n        partyMentions[party] = (partyMentions[party] || 0) + 1;\n      }\n    }\n  }\n\n  for (const trend of trends) {\n    sentimentCounts[trend.sentiment]++;\n  }\n\n  const topTopics = Object.entries(topicCounts)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 10)\n    .map(([topic, count]) => ({ topic, count }));\n\n  const partiesMentioned = Object.entries(partyMentions)\n    .sort((a, b) => b[1] - a[1])\n    .map(([party, count]) => ({ party, count }));\n\n  return {\n    articlesCount: articles.length,\n    trendsCount: trends.length,\n    sourcesCount: sources.length,\n    persistedCount,\n    analysis: {\n      topTopics,\n      sentimentBreakdown: sentimentCounts,\n      partiesMentioned,\n    },\n  };\n}\n\nexport async function getExternalDataSummaryForReport(): Promise<{\n  recentNews: { title: string; source: string; date: string; summary?: string }[];\n  trendingTopics: { topic: string; volume: number; sentiment: string }[];\n  partyCoverage: { party: string; articles: number; avgSentiment: string }[];\n  lastUpdated: string;\n}> {\n  const { articles, trends } = await fetchExternalData({ maxArticlesPerSource: 10 });\n\n  const partyArticles: Record<string, { count: number; sentiment: number }> = {};\n  const partyKeywords = [\"PT\", \"PL\", \"MDB\", \"PSDB\", \"PP\", \"UNIÃO\", \"PSD\", \"REPUBLICANOS\", \"PDT\", \"PSOL\"];\n\n  for (const article of articles) {\n    for (const party of partyKeywords) {\n      if (article.title.toUpperCase().includes(party) || article.content.toUpperCase().includes(party)) {\n        if (!partyArticles[party]) {\n          partyArticles[party] = { count: 0, sentiment: 0 };\n        }\n        partyArticles[party].count++;\n      }\n    }\n  }\n\n  return {\n    recentNews: articles.slice(0, 10).map(a => ({\n      title: a.title,\n      source: a.source,\n      date: a.publishedAt.toISOString(),\n      summary: a.summary,\n    })),\n    trendingTopics: trends.slice(0, 5).map(t => ({\n      topic: t.topic,\n      volume: t.volume,\n      sentiment: t.sentiment,\n    })),\n    partyCoverage: Object.entries(partyArticles).map(([party, data]) => ({\n      party,\n      articles: data.count,\n      avgSentiment: \"neutral\",\n    })),\n    lastUpdated: new Date().toISOString(),\n  };\n}\n","path":null,"size_bytes":14248,"size_tokens":null},"shared/schema.ts":{"content":"import { sql, relations } from \"drizzle-orm\";\nimport { pgTable, text, varchar, integer, serial, timestamp, decimal, boolean, jsonb, bigint, index, vector, uniqueIndex } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport * from \"./models/chat\";\n\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  name: text(\"name\").notNull(),\n  email: text(\"email\").notNull().unique(),\n  role: text(\"role\").notNull().default(\"viewer\"),\n  active: boolean(\"active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const parties = pgTable(\"parties\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  abbreviation: text(\"abbreviation\").notNull().unique(),\n  number: integer(\"number\").notNull().unique(),\n  color: text(\"color\").notNull().default(\"#003366\"),\n  coalition: text(\"coalition\"),\n  notes: text(\"notes\"),\n  tags: text(\"tags\").array(),\n  active: boolean(\"active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n});\n\nexport const candidates = pgTable(\"candidates\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  nickname: text(\"nickname\"),\n  number: integer(\"number\").notNull(),\n  partyId: integer(\"party_id\").notNull().references(() => parties.id, { onDelete: \"cascade\" }),\n  position: text(\"position\").notNull().default(\"vereador\"),\n  biography: text(\"biography\"),\n  notes: text(\"notes\"),\n  tags: text(\"tags\").array(),\n  active: boolean(\"active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n});\n\nexport const scenarios = pgTable(\"scenarios\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  totalVoters: integer(\"total_voters\").notNull(),\n  validVotes: integer(\"valid_votes\").notNull(),\n  availableSeats: integer(\"available_seats\").notNull(),\n  position: text(\"position\").notNull().default(\"vereador\"),\n  status: text(\"status\").notNull().default(\"draft\"),\n  // Historical election reference\n  historicalYear: integer(\"historical_year\"),\n  historicalUf: text(\"historical_uf\"),\n  historicalMunicipio: text(\"historical_municipio\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n});\n\nexport const scenarioVotes = pgTable(\"scenario_votes\", {\n  id: serial(\"id\").primaryKey(),\n  scenarioId: integer(\"scenario_id\").notNull().references(() => scenarios.id, { onDelete: \"cascade\" }),\n  partyId: integer(\"party_id\").notNull().references(() => parties.id, { onDelete: \"cascade\" }),\n  candidateId: integer(\"candidate_id\").references(() => candidates.id, { onDelete: \"cascade\" }),\n  votes: integer(\"votes\").notNull().default(0),\n});\n\nexport const scenarioCandidates = pgTable(\"scenario_candidates\", {\n  id: serial(\"id\").primaryKey(),\n  scenarioId: integer(\"scenario_id\").notNull().references(() => scenarios.id, { onDelete: \"cascade\" }),\n  candidateId: integer(\"candidate_id\").notNull().references(() => candidates.id, { onDelete: \"cascade\" }),\n  partyId: integer(\"party_id\").notNull().references(() => parties.id, { onDelete: \"cascade\" }),\n  ballotNumber: integer(\"ballot_number\").notNull(),\n  nickname: text(\"nickname\"),\n  status: text(\"status\").notNull().default(\"active\"),\n  votes: integer(\"votes\").notNull().default(0),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const simulations = pgTable(\"simulations\", {\n  id: serial(\"id\").primaryKey(),\n  scenarioId: integer(\"scenario_id\").notNull().references(() => scenarios.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  electoralQuotient: decimal(\"electoral_quotient\", { precision: 12, scale: 4 }),\n  results: jsonb(\"results\"),\n  aiPrediction: jsonb(\"ai_prediction\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n});\n\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id),\n  action: text(\"action\").notNull(),\n  entity: text(\"entity\").notNull(),\n  entityId: text(\"entity_id\"),\n  details: jsonb(\"details\"),\n  ipAddress: text(\"ip_address\"),\n  userAgent: text(\"user_agent\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const alliances = pgTable(\"alliances\", {\n  id: serial(\"id\").primaryKey(),\n  scenarioId: integer(\"scenario_id\").notNull().references(() => scenarios.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull().default(\"coalition\"),\n  color: text(\"color\").notNull().default(\"#003366\"),\n  active: boolean(\"active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n});\n\nexport const allianceParties = pgTable(\"alliance_parties\", {\n  id: serial(\"id\").primaryKey(),\n  allianceId: integer(\"alliance_id\").notNull().references(() => alliances.id, { onDelete: \"cascade\" }),\n  partyId: integer(\"party_id\").notNull().references(() => parties.id, { onDelete: \"cascade\" }),\n});\n\nexport const alliancesRelations = relations(alliances, ({ many, one }) => ({\n  parties: many(allianceParties),\n  scenario: one(scenarios, { fields: [alliances.scenarioId], references: [scenarios.id] }),\n  createdByUser: one(users, { fields: [alliances.createdBy], references: [users.id] }),\n}));\n\nexport const alliancePartiesRelations = relations(allianceParties, ({ one }) => ({\n  alliance: one(alliances, { fields: [allianceParties.allianceId], references: [alliances.id] }),\n  party: one(parties, { fields: [allianceParties.partyId], references: [parties.id] }),\n}));\n\nexport const partiesRelations = relations(parties, ({ many, one }) => ({\n  candidates: many(candidates),\n  votes: many(scenarioVotes),\n  allianceMemberships: many(allianceParties),\n  createdByUser: one(users, { fields: [parties.createdBy], references: [users.id] }),\n}));\n\nexport const candidatesRelations = relations(candidates, ({ one, many }) => ({\n  party: one(parties, { fields: [candidates.partyId], references: [parties.id] }),\n  votes: many(scenarioVotes),\n  createdByUser: one(users, { fields: [candidates.createdBy], references: [users.id] }),\n}));\n\nexport const scenariosRelations = relations(scenarios, ({ many, one }) => ({\n  votes: many(scenarioVotes),\n  simulations: many(simulations),\n  alliances: many(alliances),\n  candidates: many(scenarioCandidates),\n  createdByUser: one(users, { fields: [scenarios.createdBy], references: [users.id] }),\n}));\n\nexport const scenarioCandidatesRelations = relations(scenarioCandidates, ({ one }) => ({\n  scenario: one(scenarios, { fields: [scenarioCandidates.scenarioId], references: [scenarios.id] }),\n  candidate: one(candidates, { fields: [scenarioCandidates.candidateId], references: [candidates.id] }),\n  party: one(parties, { fields: [scenarioCandidates.partyId], references: [parties.id] }),\n}));\n\nexport const scenarioVotesRelations = relations(scenarioVotes, ({ one }) => ({\n  scenario: one(scenarios, { fields: [scenarioVotes.scenarioId], references: [scenarios.id] }),\n  party: one(parties, { fields: [scenarioVotes.partyId], references: [parties.id] }),\n  candidate: one(candidates, { fields: [scenarioVotes.candidateId], references: [candidates.id] }),\n}));\n\nexport const simulationsRelations = relations(simulations, ({ one }) => ({\n  scenario: one(scenarios, { fields: [simulations.scenarioId], references: [scenarios.id] }),\n  createdByUser: one(users, { fields: [simulations.createdBy], references: [users.id] }),\n}));\n\nexport const auditLogsRelations = relations(auditLogs, ({ one }) => ({\n  user: one(users, { fields: [auditLogs.userId], references: [users.id] }),\n}));\n\nexport const insertUserSchema = createInsertSchema(users).omit({ id: true, createdAt: true });\nexport const insertPartySchema = createInsertSchema(parties).omit({ id: true, createdAt: true });\nexport const insertCandidateSchema = createInsertSchema(candidates).omit({ id: true, createdAt: true });\nexport const insertScenarioSchema = createInsertSchema(scenarios).omit({ id: true, createdAt: true, updatedAt: true }).refine(\n  (data) => data.availableSeats > 0 && data.validVotes >= data.availableSeats,\n  { message: \"Valid votes must be greater than or equal to available seats, and seats must be positive\" }\n);\nexport const insertScenarioVoteSchema = createInsertSchema(scenarioVotes).omit({ id: true });\nexport const insertSimulationSchema = createInsertSchema(simulations).omit({ id: true, createdAt: true });\nexport const insertAuditLogSchema = createInsertSchema(auditLogs).omit({ id: true, createdAt: true });\nexport const insertAllianceSchema = createInsertSchema(alliances).omit({ id: true, createdAt: true });\nexport const insertAlliancePartySchema = createInsertSchema(allianceParties).omit({ id: true });\nexport const insertScenarioCandidateSchema = createInsertSchema(scenarioCandidates).omit({ id: true, createdAt: true });\n\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type User = typeof users.$inferSelect;\nexport type InsertParty = z.infer<typeof insertPartySchema>;\nexport type Party = typeof parties.$inferSelect;\nexport type InsertCandidate = z.infer<typeof insertCandidateSchema>;\nexport type Candidate = typeof candidates.$inferSelect;\nexport type InsertScenario = z.infer<typeof insertScenarioSchema>;\nexport type Scenario = typeof scenarios.$inferSelect;\nexport type InsertScenarioVote = z.infer<typeof insertScenarioVoteSchema>;\nexport type ScenarioVote = typeof scenarioVotes.$inferSelect;\nexport type InsertSimulation = z.infer<typeof insertSimulationSchema>;\nexport type Simulation = typeof simulations.$inferSelect;\nexport type InsertAuditLog = z.infer<typeof insertAuditLogSchema>;\nexport type AuditLog = typeof auditLogs.$inferSelect;\nexport type InsertAlliance = z.infer<typeof insertAllianceSchema>;\nexport type Alliance = typeof alliances.$inferSelect;\nexport type InsertAllianceParty = z.infer<typeof insertAlliancePartySchema>;\nexport type AllianceParty = typeof allianceParties.$inferSelect;\nexport type InsertScenarioCandidate = z.infer<typeof insertScenarioCandidateSchema>;\nexport type ScenarioCandidate = typeof scenarioCandidates.$inferSelect;\n\nexport type PartyResult = {\n  partyId: number;\n  partyName: string;\n  abbreviation: string;\n  totalVotes: number;\n  partyQuotient: number;\n  seatsFromQuotient: number;\n  seatsFromRemainder: number;\n  totalSeats: number;\n  electedCandidates: CandidateResult[];\n};\n\nexport type CandidateResult = {\n  candidateId: number;\n  name: string;\n  votes: number;\n  elected: boolean;\n  position: number;\n};\n\nexport type SimulationResult = {\n  electoralQuotient: number;\n  totalValidVotes: number;\n  availableSeats: number;\n  seatsDistributedByQuotient: number;\n  seatsDistributedByRemainder: number;\n  partyResults: PartyResult[];\n};\n\nexport type AIPrediction = {\n  analysis: string;\n  predictions: {\n    partyId: number;\n    partyName: string;\n    predictedSeats: { min: number; max: number };\n    confidence: number;\n    trend: \"up\" | \"down\" | \"stable\";\n  }[];\n  recommendations: string[];\n  generatedAt: string;\n};\n\nexport const tseImportJobs = pgTable(\"tse_import_jobs\", {\n  id: serial(\"id\").primaryKey(),\n  filename: text(\"filename\").notNull(),\n  fileSize: bigint(\"file_size\", { mode: \"number\" }).notNull(),\n  status: text(\"status\").notNull().default(\"pending\"),\n  stage: text(\"stage\").default(\"pending\"),\n  downloadedBytes: bigint(\"downloaded_bytes\", { mode: \"number\" }).default(0),\n  totalRows: integer(\"total_rows\").default(0),\n  processedRows: integer(\"processed_rows\").default(0),\n  skippedRows: integer(\"skipped_rows\").default(0),\n  errorCount: integer(\"error_count\").default(0),\n  errorMessage: text(\"error_message\"),\n  electionYear: integer(\"election_year\"),\n  electionType: text(\"election_type\"),\n  uf: text(\"uf\"),\n  cargoFilter: integer(\"cargo_filter\"),\n  sourceUrl: text(\"source_url\"),\n  totalFileRows: integer(\"total_file_rows\"),\n  validationStatus: text(\"validation_status\").default(\"pending\"),\n  validationMessage: text(\"validation_message\"),\n  validatedAt: timestamp(\"validated_at\"),\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n});\n\nexport const tseCandidateVotes = pgTable(\"tse_candidate_votes\", {\n  id: serial(\"id\").primaryKey(),\n  importJobId: integer(\"import_job_id\").references(() => tseImportJobs.id, { onDelete: \"cascade\" }),\n  dtGeracao: text(\"dt_geracao\"),\n  hhGeracao: text(\"hh_geracao\"),\n  anoEleicao: integer(\"ano_eleicao\"),\n  cdTipoEleicao: integer(\"cd_tipo_eleicao\"),\n  nmTipoEleicao: text(\"nm_tipo_eleicao\"),\n  nrTurno: integer(\"nr_turno\"),\n  cdEleicao: integer(\"cd_eleicao\"),\n  dsEleicao: text(\"ds_eleicao\"),\n  dtEleicao: text(\"dt_eleicao\"),\n  tpAbrangencia: text(\"tp_abrangencia\"),\n  sgUf: text(\"sg_uf\"),\n  sgUe: text(\"sg_ue\"),\n  nmUe: text(\"nm_ue\"),\n  cdMunicipio: integer(\"cd_municipio\"),\n  nmMunicipio: text(\"nm_municipio\"),\n  nrZona: integer(\"nr_zona\"),\n  cdCargo: integer(\"cd_cargo\"),\n  dsCargo: text(\"ds_cargo\"),\n  sqCandidato: text(\"sq_candidato\"),\n  nrCandidato: integer(\"nr_candidato\"),\n  nmCandidato: text(\"nm_candidato\"),\n  nmUrnaCandidato: text(\"nm_urna_candidato\"),\n  nmSocialCandidato: text(\"nm_social_candidato\"),\n  cdSituacaoCandidatura: integer(\"cd_situacao_candidatura\"),\n  dsSituacaoCandidatura: text(\"ds_situacao_candidatura\"),\n  cdDetalheSituacaoCand: integer(\"cd_detalhe_situacao_cand\"),\n  dsDetalheSituacaoCand: text(\"ds_detalhe_situacao_cand\"),\n  cdSituacaoJulgamento: integer(\"cd_situacao_julgamento\"),\n  dsSituacaoJulgamento: text(\"ds_situacao_julgamento\"),\n  cdSituacaoCassacao: integer(\"cd_situacao_cassacao\"),\n  dsSituacaoCassacao: text(\"ds_situacao_cassacao\"),\n  cdSituacaoDconstDiploma: integer(\"cd_situacao_dconst_diploma\"),\n  dsSituacaoDconstDiploma: text(\"ds_situacao_dconst_diploma\"),\n  tpAgremiacao: text(\"tp_agremiacao\"),\n  nrPartido: integer(\"nr_partido\"),\n  sgPartido: text(\"sg_partido\"),\n  nmPartido: text(\"nm_partido\"),\n  nrFederacao: integer(\"nr_federacao\"),\n  nmFederacao: text(\"nm_federacao\"),\n  sgFederacao: text(\"sg_federacao\"),\n  dsComposicaoFederacao: text(\"ds_composicao_federacao\"),\n  sqColigacao: text(\"sq_coligacao\"),\n  nmColigacao: text(\"nm_coligacao\"),\n  dsComposicaoColigacao: text(\"ds_composicao_coligacao\"),\n  stVotoEmTransito: text(\"st_voto_em_transito\"),\n  qtVotosNominais: integer(\"qt_votos_nominais\"),\n  nmTipoDestinacaoVotos: text(\"nm_tipo_destinacao_votos\"),\n  qtVotosNominaisValidos: integer(\"qt_votos_nominais_validos\"),\n  cdSitTotTurno: integer(\"cd_sit_tot_turno\"),\n  dsSitTotTurno: text(\"ds_sit_tot_turno\"),\n}, (table) => ({\n  uniqueVote: uniqueIndex(\"tse_candidate_votes_unique_idx\").on(\n    table.anoEleicao,\n    table.cdEleicao,\n    table.nrTurno,\n    table.sgUf,\n    table.cdMunicipio,\n    table.nrZona,\n    table.cdCargo,\n    table.nrCandidato,\n    table.stVotoEmTransito\n  ),\n}));\n\nexport const tseImportErrors = pgTable(\"tse_import_errors\", {\n  id: serial(\"id\").primaryKey(),\n  importJobId: integer(\"import_job_id\").notNull().references(() => tseImportJobs.id, { onDelete: \"cascade\" }),\n  rowNumber: integer(\"row_number\"),\n  errorType: text(\"error_type\").notNull(),\n  errorMessage: text(\"error_message\").notNull(),\n  rawData: text(\"raw_data\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const tseImportJobsRelations = relations(tseImportJobs, ({ many, one }) => ({\n  votes: many(tseCandidateVotes),\n  errors: many(tseImportErrors),\n  createdByUser: one(users, { fields: [tseImportJobs.createdBy], references: [users.id] }),\n}));\n\nexport const tseCandidateVotesRelations = relations(tseCandidateVotes, ({ one }) => ({\n  importJob: one(tseImportJobs, { fields: [tseCandidateVotes.importJobId], references: [tseImportJobs.id] }),\n}));\n\nexport const tseImportErrorsRelations = relations(tseImportErrors, ({ one }) => ({\n  importJob: one(tseImportJobs, { fields: [tseImportErrors.importJobId], references: [tseImportJobs.id] }),\n}));\n\nexport const insertTseImportJobSchema = createInsertSchema(tseImportJobs).omit({ id: true, createdAt: true });\nexport const insertTseCandidateVoteSchema = createInsertSchema(tseCandidateVotes).omit({ id: true });\nexport const insertTseImportErrorSchema = createInsertSchema(tseImportErrors).omit({ id: true, createdAt: true });\n\nexport type InsertTseImportJob = z.infer<typeof insertTseImportJobSchema>;\nexport type TseImportJob = typeof tseImportJobs.$inferSelect;\nexport type InsertTseCandidateVote = z.infer<typeof insertTseCandidateVoteSchema>;\nexport type TseCandidateVote = typeof tseCandidateVotes.$inferSelect;\nexport type InsertTseImportError = z.infer<typeof insertTseImportErrorSchema>;\nexport type TseImportError = typeof tseImportErrors.$inferSelect;\n\n// Import Batches - for tracking batch processing and enabling reprocessing\nexport const tseImportBatches = pgTable(\"tse_import_batches\", {\n  id: serial(\"id\").primaryKey(),\n  importJobId: integer(\"import_job_id\").notNull().references(() => tseImportJobs.id, { onDelete: \"cascade\" }),\n  batchIndex: integer(\"batch_index\").notNull(),\n  status: text(\"status\").notNull().default(\"pending\"), // pending, processing, completed, failed\n  rowStart: integer(\"row_start\").notNull(),\n  rowEnd: integer(\"row_end\").notNull(),\n  totalRows: integer(\"total_rows\").notNull(),\n  processedRows: integer(\"processed_rows\").default(0),\n  insertedRows: integer(\"inserted_rows\").default(0),\n  skippedRows: integer(\"skipped_rows\").default(0),\n  errorCount: integer(\"error_count\").default(0),\n  errorSummary: text(\"error_summary\"),\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"tse_import_batches_job_idx\").on(table.importJobId),\n  index(\"tse_import_batches_status_idx\").on(table.status),\n]);\n\n// Batch Rows - store raw data for failed rows to enable reprocessing\nexport const tseImportBatchRows = pgTable(\"tse_import_batch_rows\", {\n  id: serial(\"id\").primaryKey(),\n  batchId: integer(\"batch_id\").notNull().references(() => tseImportBatches.id, { onDelete: \"cascade\" }),\n  rowNumber: integer(\"row_number\").notNull(),\n  rawData: text(\"raw_data\").notNull(), // Original CSV row data\n  parsedData: jsonb(\"parsed_data\"), // Parsed fields as JSON\n  status: text(\"status\").notNull().default(\"pending\"), // pending, success, failed, skipped\n  errorType: text(\"error_type\"),\n  errorMessage: text(\"error_message\"),\n  processedAt: timestamp(\"processed_at\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"tse_import_batch_rows_batch_idx\").on(table.batchId),\n  index(\"tse_import_batch_rows_status_idx\").on(table.status),\n]);\n\nexport const tseImportBatchesRelations = relations(tseImportBatches, ({ one, many }) => ({\n  importJob: one(tseImportJobs, { fields: [tseImportBatches.importJobId], references: [tseImportJobs.id] }),\n  rows: many(tseImportBatchRows),\n}));\n\nexport const tseImportBatchRowsRelations = relations(tseImportBatchRows, ({ one }) => ({\n  batch: one(tseImportBatches, { fields: [tseImportBatchRows.batchId], references: [tseImportBatches.id] }),\n}));\n\nexport const insertTseImportBatchSchema = createInsertSchema(tseImportBatches).omit({ id: true, createdAt: true });\nexport const insertTseImportBatchRowSchema = createInsertSchema(tseImportBatchRows).omit({ id: true, createdAt: true });\n\nexport type InsertTseImportBatch = z.infer<typeof insertTseImportBatchSchema>;\nexport type TseImportBatch = typeof tseImportBatches.$inferSelect;\nexport type InsertTseImportBatchRow = z.infer<typeof insertTseImportBatchRowSchema>;\nexport type TseImportBatchRow = typeof tseImportBatchRows.$inferSelect;\n\n// TSE Electoral Statistics (DETALHE_VOTACAO_MUNZONA) - aggregate voting data per cargo/UF/municipio\nexport const tseElectoralStatistics = pgTable(\"tse_electoral_statistics\", {\n  id: serial(\"id\").primaryKey(),\n  importJobId: integer(\"import_job_id\").references(() => tseImportJobs.id, { onDelete: \"cascade\" }),\n  anoEleicao: integer(\"ano_eleicao\").notNull(),\n  cdTipoEleicao: integer(\"cd_tipo_eleicao\"),\n  nmTipoEleicao: text(\"nm_tipo_eleicao\"),\n  nrTurno: integer(\"nr_turno\").notNull().default(1),\n  cdEleicao: integer(\"cd_eleicao\"),\n  dsEleicao: text(\"ds_eleicao\"),\n  dtEleicao: text(\"dt_eleicao\"),\n  tpAbrangencia: text(\"tp_abrangencia\"),\n  sgUf: text(\"sg_uf\").notNull(),\n  sgUe: text(\"sg_ue\"),\n  nmUe: text(\"nm_ue\"),\n  cdMunicipio: integer(\"cd_municipio\"),\n  nmMunicipio: text(\"nm_municipio\"),\n  nrZona: integer(\"nr_zona\"),\n  cdCargo: integer(\"cd_cargo\").notNull(),\n  dsCargo: text(\"ds_cargo\"),\n  qtAptos: integer(\"qt_aptos\").default(0),\n  qtSecoesPrincipais: integer(\"qt_secoes_principais\").default(0),\n  qtSecoesAgregadas: integer(\"qt_secoes_agregadas\").default(0),\n  qtSecoesNaoInstaladas: integer(\"qt_secoes_nao_instaladas\").default(0),\n  qtTotalSecoes: integer(\"qt_total_secoes\").default(0),\n  qtComparecimento: integer(\"qt_comparecimento\").default(0),\n  qtAbstencoes: integer(\"qt_abstencoes\").default(0),\n  stVotoEmTransito: text(\"st_voto_em_transito\"),\n  qtVotos: integer(\"qt_votos\").default(0),\n  qtVotosConcorrentes: integer(\"qt_votos_concorrentes\").default(0),\n  qtTotalVotosValidos: integer(\"qt_total_votos_validos\").default(0),\n  qtVotosNominaisValidos: integer(\"qt_votos_nominais_validos\").default(0),\n  qtTotalVotosLegValidos: integer(\"qt_total_votos_leg_validos\").default(0),\n  qtVotosLegValidos: integer(\"qt_votos_leg_validos\").default(0),\n  qtVotosNomConvrLegValidos: integer(\"qt_votos_nom_convr_leg_validos\").default(0),\n  qtTotalVotosAnulados: integer(\"qt_total_votos_anulados\").default(0),\n  qtVotosNominaisAnulados: integer(\"qt_votos_nominais_anulados\").default(0),\n  qtVotosLegendaAnulados: integer(\"qt_votos_legenda_anulados\").default(0),\n  qtTotalVotosAnulSubjud: integer(\"qt_total_votos_anul_subjud\").default(0),\n  qtVotosNominaisAnulSubjud: integer(\"qt_votos_nominais_anul_subjud\").default(0),\n  qtVotosLegendaAnulSubjud: integer(\"qt_votos_legenda_anul_subjud\").default(0),\n  qtVotosBrancos: integer(\"qt_votos_brancos\").default(0),\n  qtTotalVotosNulos: integer(\"qt_total_votos_nulos\").default(0),\n  qtVotosNulos: integer(\"qt_votos_nulos\").default(0),\n  qtVotosNulosTecnicos: integer(\"qt_votos_nulos_tecnicos\").default(0),\n  qtVotosAnuladosApuSep: integer(\"qt_votos_anulados_apu_sep\").default(0),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"tse_electoral_stats_year_uf_cargo_idx\").on(table.anoEleicao, table.sgUf, table.cdCargo),\n  index(\"tse_electoral_stats_municipio_idx\").on(table.cdMunicipio),\n  uniqueIndex(\"tse_electoral_stats_unique_idx\").on(\n    table.anoEleicao,\n    table.cdEleicao,\n    table.nrTurno,\n    table.sgUf,\n    table.cdMunicipio,\n    table.nrZona,\n    table.cdCargo,\n    table.stVotoEmTransito\n  ),\n]);\n\n// TSE Party Votes (VOTACAO_PARTIDO_MUNZONA) - party-level votes for proportional calculation\nexport const tsePartyVotes = pgTable(\"tse_party_votes\", {\n  id: serial(\"id\").primaryKey(),\n  importJobId: integer(\"import_job_id\").references(() => tseImportJobs.id, { onDelete: \"cascade\" }),\n  anoEleicao: integer(\"ano_eleicao\").notNull(),\n  cdTipoEleicao: integer(\"cd_tipo_eleicao\"),\n  nmTipoEleicao: text(\"nm_tipo_eleicao\"),\n  nrTurno: integer(\"nr_turno\").notNull().default(1),\n  cdEleicao: integer(\"cd_eleicao\"),\n  dsEleicao: text(\"ds_eleicao\"),\n  dtEleicao: text(\"dt_eleicao\"),\n  tpAbrangencia: text(\"tp_abrangencia\"),\n  sgUf: text(\"sg_uf\").notNull(),\n  sgUe: text(\"sg_ue\"),\n  nmUe: text(\"nm_ue\"),\n  cdMunicipio: integer(\"cd_municipio\"),\n  nmMunicipio: text(\"nm_municipio\"),\n  nrZona: integer(\"nr_zona\"),\n  cdCargo: integer(\"cd_cargo\").notNull(),\n  dsCargo: text(\"ds_cargo\"),\n  tpAgremiacao: text(\"tp_agremiacao\"),\n  nrPartido: integer(\"nr_partido\").notNull(),\n  sgPartido: text(\"sg_partido\").notNull(),\n  nmPartido: text(\"nm_partido\"),\n  nrFederacao: integer(\"nr_federacao\"),\n  nmFederacao: text(\"nm_federacao\"),\n  sgFederacao: text(\"sg_federacao\"),\n  dsComposicaoFederacao: text(\"ds_composicao_federacao\"),\n  sqColigacao: text(\"sq_coligacao\"),\n  nmColigacao: text(\"nm_coligacao\"),\n  dsComposicaoColigacao: text(\"ds_composicao_coligacao\"),\n  stVotoEmTransito: text(\"st_voto_em_transito\"),\n  qtVotosLegendaValidos: integer(\"qt_votos_legenda_validos\").default(0),\n  qtVotosNomConvrLegValidos: integer(\"qt_votos_nom_convr_leg_validos\").default(0),\n  qtTotalVotosLegValidos: integer(\"qt_total_votos_leg_validos\").default(0),\n  qtVotosNominaisValidos: integer(\"qt_votos_nominais_validos\").default(0),\n  qtVotosLegendaAnulSubjud: integer(\"qt_votos_legenda_anul_subjud\").default(0),\n  qtVotosNominaisAnulSubjud: integer(\"qt_votos_nominais_anul_subjud\").default(0),\n  qtVotosLegendaAnulados: integer(\"qt_votos_legenda_anulados\").default(0),\n  qtVotosNominaisAnulados: integer(\"qt_votos_nominais_anulados\").default(0),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"tse_party_votes_year_uf_cargo_idx\").on(table.anoEleicao, table.sgUf, table.cdCargo),\n  index(\"tse_party_votes_party_idx\").on(table.nrPartido),\n  index(\"tse_party_votes_municipio_idx\").on(table.cdMunicipio),\n  uniqueIndex(\"tse_party_votes_unique_idx\").on(\n    table.anoEleicao,\n    table.cdEleicao,\n    table.nrTurno,\n    table.sgUf,\n    table.cdMunicipio,\n    table.nrZona,\n    table.cdCargo,\n    table.nrPartido,\n    table.stVotoEmTransito\n  ),\n]);\n\nexport const tseElectoralStatisticsRelations = relations(tseElectoralStatistics, ({ one }) => ({\n  importJob: one(tseImportJobs, { fields: [tseElectoralStatistics.importJobId], references: [tseImportJobs.id] }),\n}));\n\nexport const tsePartyVotesRelations = relations(tsePartyVotes, ({ one }) => ({\n  importJob: one(tseImportJobs, { fields: [tsePartyVotes.importJobId], references: [tseImportJobs.id] }),\n}));\n\nexport const insertTseElectoralStatisticsSchema = createInsertSchema(tseElectoralStatistics).omit({ id: true, createdAt: true });\nexport const insertTsePartyVotesSchema = createInsertSchema(tsePartyVotes).omit({ id: true, createdAt: true });\n\nexport type InsertTseElectoralStatistics = z.infer<typeof insertTseElectoralStatisticsSchema>;\nexport type TseElectoralStatistics = typeof tseElectoralStatistics.$inferSelect;\nexport type InsertTsePartyVotes = z.infer<typeof insertTsePartyVotesSchema>;\nexport type TsePartyVotes = typeof tsePartyVotes.$inferSelect;\n\n// Saved Reports\nexport const savedReports = pgTable(\"saved_reports\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  filters: jsonb(\"filters\").notNull(),\n  columns: jsonb(\"columns\").notNull(),\n  chartType: text(\"chart_type\").default(\"bar\"),\n  sortBy: text(\"sort_by\"),\n  sortOrder: text(\"sort_order\").default(\"desc\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n});\n\nexport const savedReportsRelations = relations(savedReports, ({ one }) => ({\n  createdByUser: one(users, { fields: [savedReports.createdBy], references: [users.id] }),\n}));\n\nexport const insertSavedReportSchema = createInsertSchema(savedReports).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertSavedReport = z.infer<typeof insertSavedReportSchema>;\nexport type SavedReport = typeof savedReports.$inferSelect;\n\n// Semantic Documents for Vector Search\nexport const semanticDocuments = pgTable(\"semantic_documents\", {\n  id: serial(\"id\").primaryKey(),\n  sourceType: text(\"source_type\").notNull(), // 'tse_candidate', 'party', 'election_summary'\n  sourceId: integer(\"source_id\"), // FK to source table\n  year: integer(\"year\"),\n  state: text(\"state\"),\n  electionType: text(\"election_type\"),\n  position: text(\"position\"),\n  partyAbbreviation: text(\"party_abbreviation\"),\n  content: text(\"content\").notNull(), // Full text content for search\n  contentHash: text(\"content_hash\"), // To detect stale embeddings\n  metadata: jsonb(\"metadata\"), // Additional context\n  embedding: vector(\"embedding\", { dimensions: 1536 }), // text-embedding-3-small\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"semantic_documents_year_idx\").on(table.year),\n  index(\"semantic_documents_state_idx\").on(table.state),\n  index(\"semantic_documents_party_idx\").on(table.partyAbbreviation),\n  index(\"semantic_documents_source_idx\").on(table.sourceType, table.sourceId),\n]);\n\nexport const insertSemanticDocumentSchema = createInsertSchema(semanticDocuments).omit({ id: true, createdAt: true });\nexport type InsertSemanticDocument = z.infer<typeof insertSemanticDocumentSchema>;\nexport type SemanticDocument = typeof semanticDocuments.$inferSelect;\n\n// Semantic Search Queries (for analytics/history)\nexport const semanticSearchQueries = pgTable(\"semantic_search_queries\", {\n  id: serial(\"id\").primaryKey(),\n  query: text(\"query\").notNull(),\n  filters: jsonb(\"filters\"),\n  resultCount: integer(\"result_count\").default(0),\n  responseTime: integer(\"response_time\"), // ms\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n});\n\nexport const semanticSearchQueriesRelations = relations(semanticSearchQueries, ({ one }) => ({\n  createdByUser: one(users, { fields: [semanticSearchQueries.createdBy], references: [users.id] }),\n}));\n\nexport const insertSemanticSearchQuerySchema = createInsertSchema(semanticSearchQueries).omit({ id: true, createdAt: true });\nexport type InsertSemanticSearchQuery = z.infer<typeof insertSemanticSearchQuerySchema>;\nexport type SemanticSearchQuery = typeof semanticSearchQueries.$inferSelect;\n\n// AI Predictions Cache\nexport const aiPredictions = pgTable(\"ai_predictions\", {\n  id: serial(\"id\").primaryKey(),\n  predictionType: text(\"prediction_type\").notNull(), // 'turnout', 'candidate_success', 'party_performance', 'sentiment', 'insights'\n  cacheKey: text(\"cache_key\").notNull().unique(), // hash of filters for deduplication\n  filters: jsonb(\"filters\"), // The filters used to generate the prediction\n  prediction: jsonb(\"prediction\").notNull(), // The actual prediction result\n  confidence: decimal(\"confidence\", { precision: 5, scale: 4 }), // Overall confidence score\n  validUntil: timestamp(\"valid_until\"), // When the cache expires\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n}, (table) => [\n  index(\"ai_predictions_type_idx\").on(table.predictionType),\n  index(\"ai_predictions_cache_key_idx\").on(table.cacheKey),\n  index(\"ai_predictions_valid_until_idx\").on(table.validUntil),\n]);\n\nexport const aiPredictionsRelations = relations(aiPredictions, ({ one }) => ({\n  createdByUser: one(users, { fields: [aiPredictions.createdBy], references: [users.id] }),\n}));\n\nexport const insertAiPredictionSchema = createInsertSchema(aiPredictions).omit({ id: true, createdAt: true });\nexport type InsertAiPrediction = z.infer<typeof insertAiPredictionSchema>;\nexport type AiPrediction = typeof aiPredictions.$inferSelect;\n\n// AI Sentiment Data (for news and social media)\nexport const aiSentimentData = pgTable(\"ai_sentiment_data\", {\n  id: serial(\"id\").primaryKey(),\n  sourceType: text(\"source_type\").notNull(), // 'news', 'social', 'official'\n  sourceUrl: text(\"source_url\"),\n  title: text(\"title\"),\n  content: text(\"content\").notNull(),\n  author: text(\"author\"),\n  publishedAt: timestamp(\"published_at\"),\n  party: text(\"party\"), // Related party if any\n  state: text(\"state\"), // Related state if any\n  sentiment: text(\"sentiment\"), // 'positive', 'negative', 'neutral'\n  sentimentScore: decimal(\"sentiment_score\", { precision: 5, scale: 4 }), // -1 to 1\n  topics: jsonb(\"topics\"), // Extracted topics\n  analyzed: boolean(\"analyzed\").default(false),\n  analyzedAt: timestamp(\"analyzed_at\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"ai_sentiment_source_type_idx\").on(table.sourceType),\n  index(\"ai_sentiment_party_idx\").on(table.party),\n  index(\"ai_sentiment_published_at_idx\").on(table.publishedAt),\n]);\n\nexport const insertAiSentimentDataSchema = createInsertSchema(aiSentimentData).omit({ id: true, createdAt: true });\nexport type InsertAiSentimentData = z.infer<typeof insertAiSentimentDataSchema>;\nexport type AiSentimentData = typeof aiSentimentData.$inferSelect;\n\n// Projection Reports - Comprehensive Electoral Predictions\nexport const projectionReports = pgTable(\"projection_reports\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  targetYear: integer(\"target_year\").notNull(),\n  electionType: text(\"election_type\").notNull(),\n  scope: text(\"scope\").notNull(), // 'national' or 'state'\n  state: text(\"state\"), // State code if scope is 'state'\n  \n  // Report data stored as JSON for flexibility\n  executiveSummary: text(\"executive_summary\"),\n  methodology: text(\"methodology\"),\n  dataQuality: jsonb(\"data_quality\"),\n  turnoutProjection: jsonb(\"turnout_projection\"),\n  partyProjections: jsonb(\"party_projections\"),\n  candidateProjections: jsonb(\"candidate_projections\"),\n  scenarios: jsonb(\"scenarios\"),\n  riskAssessment: jsonb(\"risk_assessment\"),\n  confidenceIntervals: jsonb(\"confidence_intervals\"),\n  recommendations: jsonb(\"recommendations\"),\n  \n  // Metadata\n  version: text(\"version\").default(\"1.0\"),\n  validUntil: timestamp(\"valid_until\"),\n  status: text(\"status\").notNull().default(\"draft\"), // draft, published, archived\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n}, (table) => [\n  index(\"projection_reports_target_year_idx\").on(table.targetYear),\n  index(\"projection_reports_scope_idx\").on(table.scope),\n  index(\"projection_reports_status_idx\").on(table.status),\n]);\n\nexport const projectionReportsRelations = relations(projectionReports, ({ one }) => ({\n  createdByUser: one(users, { fields: [projectionReports.createdBy], references: [users.id] }),\n}));\n\nexport const insertProjectionReportSchema = createInsertSchema(projectionReports).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertProjectionReport = z.infer<typeof insertProjectionReportSchema>;\nexport type ProjectionReportRecord = typeof projectionReports.$inferSelect;\n\n// Import Validation Runs - tracks validation analysis per import job\nexport const importValidationRuns = pgTable(\"import_validation_runs\", {\n  id: serial(\"id\").primaryKey(),\n  jobId: integer(\"job_id\").references(() => tseImportJobs.id).notNull(),\n  status: text(\"status\").notNull().default(\"pending\"), // pending, running, completed, failed\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  totalRecordsChecked: integer(\"total_records_checked\").default(0),\n  issuesFound: integer(\"issues_found\").default(0),\n  summary: jsonb(\"summary\"), // Statistical summary: counts by type, severity distribution\n  aiAnalysis: jsonb(\"ai_analysis\"), // AI-generated insights and recommendations\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"validation_runs_job_idx\").on(table.jobId),\n  index(\"validation_runs_status_idx\").on(table.status),\n]);\n\nexport const validationRunsRelations = relations(importValidationRuns, ({ one, many }) => ({\n  job: one(tseImportJobs, { fields: [importValidationRuns.jobId], references: [tseImportJobs.id] }),\n  issues: many(importValidationIssues),\n}));\n\n// Import Validation Issues - individual issues found during validation\nexport const importValidationIssues = pgTable(\"import_validation_issues\", {\n  id: serial(\"id\").primaryKey(),\n  runId: integer(\"run_id\").references(() => importValidationRuns.id).notNull(),\n  type: text(\"type\").notNull(), // vote_count, candidate_id, abstention_rate, duplicate, missing_field, statistical_outlier\n  severity: text(\"severity\").notNull().default(\"warning\"), // error, warning, info\n  category: text(\"category\").notNull().default(\"data_quality\"), // data_quality, consistency, statistical, format\n  rowReference: text(\"row_reference\"), // Line number or record identifier\n  field: text(\"field\"), // Which field has the issue\n  currentValue: text(\"current_value\"), // The problematic value\n  message: text(\"message\").notNull(), // Human-readable description\n  suggestedFix: jsonb(\"suggested_fix\"), // AI or rule-based suggestion: { action, newValue, confidence, reasoning }\n  status: text(\"status\").notNull().default(\"open\"), // open, resolved, ignored\n  resolvedBy: varchar(\"resolved_by\").references(() => users.id),\n  resolvedAt: timestamp(\"resolved_at\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"validation_issues_run_idx\").on(table.runId),\n  index(\"validation_issues_type_idx\").on(table.type),\n  index(\"validation_issues_severity_idx\").on(table.severity),\n  index(\"validation_issues_status_idx\").on(table.status),\n]);\n\nexport const validationIssuesRelations = relations(importValidationIssues, ({ one }) => ({\n  run: one(importValidationRuns, { fields: [importValidationIssues.runId], references: [importValidationRuns.id] }),\n  resolver: one(users, { fields: [importValidationIssues.resolvedBy], references: [users.id] }),\n}));\n\nexport const insertValidationRunSchema = createInsertSchema(importValidationRuns).omit({ id: true, createdAt: true });\nexport type InsertValidationRun = z.infer<typeof insertValidationRunSchema>;\nexport type ValidationRunRecord = typeof importValidationRuns.$inferSelect;\n\nexport const insertValidationIssueSchema = createInsertSchema(importValidationIssues).omit({ id: true, createdAt: true });\nexport type InsertValidationIssue = z.infer<typeof insertValidationIssueSchema>;\nexport type ValidationIssueRecord = typeof importValidationIssues.$inferSelect;\n\n// Election Forecast Runs - stores forecast model runs and metadata\nexport const forecastRuns = pgTable(\"forecast_runs\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  targetYear: integer(\"target_year\").notNull(), // Year being predicted\n  targetElectionType: text(\"target_election_type\"), // e.g., 'Eleições Gerais', 'Eleições Municipais'\n  targetPosition: text(\"target_position\"), // e.g., 'Deputado Federal', 'Senador'\n  targetState: text(\"target_state\"), // Optional: specific state or 'BR' for national\n  historicalYearsUsed: jsonb(\"historical_years_used\").$type<number[]>().default([]), // Which election years were analyzed\n  modelParameters: jsonb(\"model_parameters\"), // Monte Carlo iterations, confidence thresholds, etc.\n  sentimentData: jsonb(\"sentiment_data\"), // Snapshot of sentiment analysis inputs\n  status: text(\"status\").notNull().default(\"pending\"), // pending, running, completed, failed\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  totalSimulations: integer(\"total_simulations\").default(0),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n}, (table) => [\n  index(\"forecast_runs_target_year_idx\").on(table.targetYear),\n  index(\"forecast_runs_status_idx\").on(table.status),\n  index(\"forecast_runs_created_at_idx\").on(table.createdAt),\n]);\n\nexport const forecastRunsRelations = relations(forecastRuns, ({ one, many }) => ({\n  createdByUser: one(users, { fields: [forecastRuns.createdBy], references: [users.id] }),\n  results: many(forecastResults),\n  swingRegions: many(forecastSwingRegions),\n}));\n\n// Forecast Results - predictions by party/candidate with confidence intervals\nexport const forecastResults = pgTable(\"forecast_results\", {\n  id: serial(\"id\").primaryKey(),\n  runId: integer(\"run_id\").references(() => forecastRuns.id, { onDelete: \"cascade\" }).notNull(),\n  resultType: text(\"result_type\").notNull(), // 'party', 'candidate', 'coalition'\n  entityId: integer(\"entity_id\"), // FK to parties or candidates table\n  entityName: text(\"entity_name\").notNull(), // Party abbreviation or candidate name\n  region: text(\"region\"), // State or region code\n  position: text(\"position\"), // Cargo being contested\n  \n  // Vote predictions with confidence intervals\n  predictedVoteShare: decimal(\"predicted_vote_share\", { precision: 7, scale: 4 }), // Percentage (e.g., 15.2345)\n  voteShareLower: decimal(\"vote_share_lower\", { precision: 7, scale: 4 }), // 95% CI lower bound\n  voteShareUpper: decimal(\"vote_share_upper\", { precision: 7, scale: 4 }), // 95% CI upper bound\n  predictedVotes: integer(\"predicted_votes\"), // Absolute vote count\n  votesLower: integer(\"votes_lower\"),\n  votesUpper: integer(\"votes_upper\"),\n  \n  // Seat predictions (for proportional elections)\n  predictedSeats: integer(\"predicted_seats\"),\n  seatsLower: integer(\"seats_lower\"),\n  seatsUpper: integer(\"seats_upper\"),\n  \n  // Win probability (for majoritarian elections or candidate success)\n  winProbability: decimal(\"win_probability\", { precision: 5, scale: 4 }),\n  electedProbability: decimal(\"elected_probability\", { precision: 5, scale: 4 }), // Probability of being elected\n  \n  // Historical trend data\n  historicalTrend: jsonb(\"historical_trend\"), // { years: [2018, 2020, 2022], voteShares: [10.5, 12.3, 14.1] }\n  trendDirection: text(\"trend_direction\"), // 'rising', 'falling', 'stable'\n  trendStrength: decimal(\"trend_strength\", { precision: 5, scale: 4 }), // Coefficient\n  \n  // Factors influencing prediction\n  influenceFactors: jsonb(\"influence_factors\"), // [{ factor: 'sentiment', weight: 0.15, impact: 'positive' }]\n  \n  confidence: decimal(\"confidence\", { precision: 5, scale: 4 }), // Overall confidence in prediction\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"forecast_results_run_idx\").on(table.runId),\n  index(\"forecast_results_type_idx\").on(table.resultType),\n  index(\"forecast_results_entity_idx\").on(table.entityName),\n  index(\"forecast_results_region_idx\").on(table.region),\n]);\n\nexport const forecastResultsRelations = relations(forecastResults, ({ one }) => ({\n  run: one(forecastRuns, { fields: [forecastResults.runId], references: [forecastRuns.id] }),\n}));\n\n// Forecast Swing Regions - volatile regions that could determine outcomes\nexport const forecastSwingRegions = pgTable(\"forecast_swing_regions\", {\n  id: serial(\"id\").primaryKey(),\n  runId: integer(\"run_id\").references(() => forecastRuns.id, { onDelete: \"cascade\" }).notNull(),\n  region: text(\"region\").notNull(), // State code\n  regionName: text(\"region_name\").notNull(), // Full state name\n  position: text(\"position\"), // Which position makes this a swing region\n  \n  // Margin between leading candidates/parties\n  marginPercent: decimal(\"margin_percent\", { precision: 5, scale: 2 }), // How close the race is\n  marginVotes: integer(\"margin_votes\"),\n  \n  // Volatility metrics\n  volatilityScore: decimal(\"volatility_score\", { precision: 5, scale: 4 }), // Historical volatility\n  swingMagnitude: decimal(\"swing_magnitude\", { precision: 5, scale: 2 }), // Expected swing size\n  \n  // Key competing entities\n  leadingEntity: text(\"leading_entity\"), // Currently leading party/candidate\n  challengingEntity: text(\"challenging_entity\"), // Closest challenger\n  \n  // Sentiment and trend factors\n  sentimentBalance: decimal(\"sentiment_balance\", { precision: 5, scale: 4 }), // -1 to 1, positive favors incumbent\n  recentTrendShift: decimal(\"recent_trend_shift\", { precision: 5, scale: 4 }), // Recent momentum change\n  \n  // Risk assessment\n  outcomeUncertainty: decimal(\"outcome_uncertainty\", { precision: 5, scale: 4 }), // How uncertain the outcome is\n  keyFactors: jsonb(\"key_factors\"), // Factors making this region volatile\n  \n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"swing_regions_run_idx\").on(table.runId),\n  index(\"swing_regions_region_idx\").on(table.region),\n  index(\"swing_regions_volatility_idx\").on(table.volatilityScore),\n]);\n\nexport const swingRegionsRelations = relations(forecastSwingRegions, ({ one }) => ({\n  run: one(forecastRuns, { fields: [forecastSwingRegions.runId], references: [forecastRuns.id] }),\n}));\n\nexport const insertForecastRunSchema = createInsertSchema(forecastRuns).omit({ id: true, createdAt: true });\nexport type InsertForecastRun = z.infer<typeof insertForecastRunSchema>;\nexport type ForecastRun = typeof forecastRuns.$inferSelect;\n\nexport const insertForecastResultSchema = createInsertSchema(forecastResults).omit({ id: true, createdAt: true });\nexport type InsertForecastResult = z.infer<typeof insertForecastResultSchema>;\nexport type ForecastResult = typeof forecastResults.$inferSelect;\n\nexport const insertSwingRegionSchema = createInsertSchema(forecastSwingRegions).omit({ id: true, createdAt: true });\nexport type InsertSwingRegion = z.infer<typeof insertSwingRegionSchema>;\nexport type SwingRegion = typeof forecastSwingRegions.$inferSelect;\n\n// Custom Prediction Scenarios - user-defined \"what-if\" scenarios\nexport const predictionScenarios = pgTable(\"prediction_scenarios\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  baseYear: integer(\"base_year\").notNull(), // Historical year to use as base\n  targetYear: integer(\"target_year\").notNull(), // Year to predict\n  state: text(\"state\"), // null = nacional\n  position: text(\"position\"), // Cargo eleitoral\n  \n  // Polling data adjustments\n  pollingData: jsonb(\"polling_data\"), // Array of { party, pollPercent, pollDate, source, sampleSize }\n  pollingWeight: decimal(\"polling_weight\", { precision: 3, scale: 2 }).default(\"0.30\"), // Weight for polls vs historical\n  \n  // Custom adjustments per party\n  partyAdjustments: jsonb(\"party_adjustments\"), // { partyName: { voteShareAdjust, turnoutAdjust, reason } }\n  \n  // Turnout assumptions\n  expectedTurnout: decimal(\"expected_turnout\", { precision: 5, scale: 2 }), // Percentage\n  turnoutVariation: decimal(\"turnout_variation\", { precision: 5, scale: 2 }).default(\"5.00\"), // +/- variation\n  \n  // External factors\n  externalFactors: jsonb(\"external_factors\"), // Array of { factor, impact: 'positive'|'negative', magnitude: 1-10 }\n  \n  // Model configuration\n  monteCarloIterations: integer(\"monte_carlo_iterations\").default(10000),\n  confidenceLevel: decimal(\"confidence_level\", { precision: 3, scale: 2 }).default(\"0.95\"),\n  volatilityMultiplier: decimal(\"volatility_multiplier\", { precision: 3, scale: 2 }).default(\"1.20\"),\n  \n  // Model parameters (consolidated)\n  parameters: jsonb(\"parameters\"), // { pollingWeight, historicalWeight, adjustmentWeight, monteCarloIterations, confidenceLevel }\n  \n  // Results\n  status: text(\"status\").notNull().default(\"draft\"), // draft, running, completed, failed\n  results: jsonb(\"results\"), // Cached prediction results\n  narrative: text(\"narrative\"), // AI-generated analysis\n  forecastRunId: integer(\"forecast_run_id\").references(() => forecastRuns.id),\n  lastRunAt: timestamp(\"last_run_at\"),\n  \n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  completedAt: timestamp(\"completed_at\"),\n}, (table) => [\n  index(\"prediction_scenarios_status_idx\").on(table.status),\n  index(\"prediction_scenarios_target_year_idx\").on(table.targetYear),\n]);\n\nexport const predictionScenariosRelations = relations(predictionScenarios, ({ one }) => ({\n  createdByUser: one(users, { fields: [predictionScenarios.createdBy], references: [users.id] }),\n}));\n\nexport const insertPredictionScenarioSchema = createInsertSchema(predictionScenarios).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertPredictionScenario = z.infer<typeof insertPredictionScenarioSchema>;\nexport type PredictionScenario = typeof predictionScenarios.$inferSelect;\n\n// Candidate Comparison Predictions - compare 2+ candidates performance\nexport const candidateComparisons = pgTable(\"candidate_comparisons\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  candidateIds: jsonb(\"candidate_ids\").notNull(), // Array of candidate IDs or names to compare\n  state: text(\"state\"),\n  position: text(\"position\"),\n  targetYear: integer(\"target_year\").notNull(),\n  baseYear: integer(\"base_year\"),\n  \n  // Comparison parameters\n  compareMetrics: jsonb(\"compare_metrics\"), // { voteShare: true, electionProbability: true, partySupport: true, etc }\n  includeHistorical: boolean(\"include_historical\").default(true),\n  \n  // Results\n  status: text(\"status\").notNull().default(\"draft\"),\n  results: jsonb(\"results\"), // { candidates: [{ id, name, projectedVotes, voteShare, probability, trend, historicalData }], winner, margins, confidence }\n  narrative: text(\"narrative\"),\n  aiInsights: jsonb(\"ai_insights\"), // AI-generated comparative insights\n  \n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  completedAt: timestamp(\"completed_at\"),\n});\n\nexport const insertCandidateComparisonSchema = createInsertSchema(candidateComparisons).omit({ id: true, createdAt: true });\nexport type InsertCandidateComparison = z.infer<typeof insertCandidateComparisonSchema>;\nexport type CandidateComparison = typeof candidateComparisons.$inferSelect;\n\n// Event Impact Predictions - before/after projections for specific events\nexport const eventImpactPredictions = pgTable(\"event_impact_predictions\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  eventDescription: text(\"event_description\").notNull(), // User-described event\n  eventType: text(\"event_type\").notNull(), // 'scandal', 'party_change', 'endorsement', 'policy', 'debate', 'economic', 'other'\n  eventDate: timestamp(\"event_date\"),\n  \n  // Scope\n  affectedEntities: jsonb(\"affected_entities\").notNull(), // { parties: [], candidates: [], regions: [] }\n  state: text(\"state\"),\n  position: text(\"position\"),\n  targetYear: integer(\"target_year\").notNull(),\n  \n  // Impact parameters (user-defined or AI-estimated)\n  estimatedImpactMagnitude: decimal(\"estimated_impact_magnitude\", { precision: 3, scale: 2 }), // -1 to +1\n  impactDuration: text(\"impact_duration\"), // 'short-term', 'medium-term', 'long-term'\n  impactDistribution: jsonb(\"impact_distribution\"), // { direct: 0.6, indirect: 0.4 }\n  \n  // Before/After projections\n  status: text(\"status\").notNull().default(\"draft\"),\n  beforeProjection: jsonb(\"before_projection\"), // { parties: [], candidates: [], overall: {} }\n  afterProjection: jsonb(\"after_projection\"), // { parties: [], candidates: [], overall: {} }\n  impactDelta: jsonb(\"impact_delta\"), // Calculated differences\n  confidenceIntervals: jsonb(\"confidence_intervals\"),\n  narrative: text(\"narrative\"),\n  aiAnalysis: jsonb(\"ai_analysis\"),\n  \n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  completedAt: timestamp(\"completed_at\"),\n});\n\nexport const insertEventImpactPredictionSchema = createInsertSchema(eventImpactPredictions).omit({ id: true, createdAt: true });\nexport type InsertEventImpactPrediction = z.infer<typeof insertEventImpactPredictionSchema>;\nexport type EventImpactPrediction = typeof eventImpactPredictions.$inferSelect;\n\n// Scenario Simulations for Reports - \"What if\" scenarios\nexport const scenarioSimulations = pgTable(\"scenario_simulations\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  simulationType: text(\"simulation_type\").notNull(), // 'party_change', 'coalition_change', 'turnout_change', 'regional_shift', 'custom'\n  \n  // Scenario definition\n  baseScenario: jsonb(\"base_scenario\").notNull(), // Current state/baseline\n  modifiedScenario: jsonb(\"modified_scenario\").notNull(), // \"What if\" modifications\n  \n  // Parameters\n  parameters: jsonb(\"parameters\"), // { candidate, fromParty, toParty, etc }\n  scope: jsonb(\"scope\"), // { state, position, year }\n  \n  // Results\n  status: text(\"status\").notNull().default(\"draft\"),\n  baselineResults: jsonb(\"baseline_results\"),\n  simulatedResults: jsonb(\"simulated_results\"),\n  impactAnalysis: jsonb(\"impact_analysis\"), // { seatChanges, voteShareChanges, winners, losers }\n  narrative: text(\"narrative\"),\n  \n  // Link to report\n  reportId: integer(\"report_id\"),\n  \n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  completedAt: timestamp(\"completed_at\"),\n});\n\nexport const insertScenarioSimulationSchema = createInsertSchema(scenarioSimulations).omit({ id: true, createdAt: true });\nexport type InsertScenarioSimulation = z.infer<typeof insertScenarioSimulationSchema>;\nexport type ScenarioSimulation = typeof scenarioSimulations.$inferSelect;\n\n// Report Templates - customizable report configurations\nexport const reportTemplates = pgTable(\"report_templates\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  reportType: text(\"report_type\").notNull(), // 'voting_details', 'candidates', 'parties', 'summary'\n  filters: jsonb(\"filters\").notNull(), // year, state, electionType, position, party, etc.\n  columns: jsonb(\"columns\").notNull(), // which columns to include\n  groupBy: text(\"group_by\"), // optional grouping\n  sortBy: text(\"sort_by\"),\n  sortOrder: text(\"sort_order\").default(\"desc\"),\n  format: text(\"format\").notNull().default(\"csv\"), // 'csv', 'pdf', 'excel'\n  headerTemplate: text(\"header_template\"), // custom header text\n  footerTemplate: text(\"footer_template\"), // custom footer text\n  includeCharts: boolean(\"include_charts\").default(false),\n  isDefault: boolean(\"is_default\").default(false),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n});\n\nexport const reportTemplatesRelations = relations(reportTemplates, ({ one, many }) => ({\n  createdByUser: one(users, { fields: [reportTemplates.createdBy], references: [users.id] }),\n  schedules: many(reportSchedules),\n}));\n\n// Report Schedules - automated report delivery\nexport const reportSchedules = pgTable(\"report_schedules\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  templateId: integer(\"template_id\").notNull().references(() => reportTemplates.id, { onDelete: \"cascade\" }),\n  frequency: text(\"frequency\").notNull(), // 'once', 'daily', 'weekly', 'monthly'\n  dayOfWeek: integer(\"day_of_week\"), // 0-6 for weekly (0=Sunday)\n  dayOfMonth: integer(\"day_of_month\"), // 1-31 for monthly\n  timeOfDay: text(\"time_of_day\").notNull().default(\"08:00\"), // HH:MM format\n  timezone: text(\"timezone\").notNull().default(\"America/Sao_Paulo\"),\n  recipients: jsonb(\"recipients\").notNull(), // array of email addresses\n  emailSubject: text(\"email_subject\"),\n  emailBody: text(\"email_body\"),\n  lastRunAt: timestamp(\"last_run_at\"),\n  nextRunAt: timestamp(\"next_run_at\"),\n  lastRunStatus: text(\"last_run_status\"), // 'success', 'failed', 'pending'\n  lastRunError: text(\"last_run_error\"),\n  isActive: boolean(\"is_active\").default(true),\n  runCount: integer(\"run_count\").default(0),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n}, (table) => [\n  index(\"schedule_next_run_idx\").on(table.nextRunAt),\n  index(\"schedule_active_idx\").on(table.isActive),\n]);\n\nexport const reportSchedulesRelations = relations(reportSchedules, ({ one, many }) => ({\n  template: one(reportTemplates, { fields: [reportSchedules.templateId], references: [reportTemplates.id] }),\n  createdByUser: one(users, { fields: [reportSchedules.createdBy], references: [users.id] }),\n  runs: many(reportRuns),\n}));\n\n// Report Runs - execution history\nexport const reportRuns = pgTable(\"report_runs\", {\n  id: serial(\"id\").primaryKey(),\n  scheduleId: integer(\"schedule_id\").references(() => reportSchedules.id, { onDelete: \"set null\" }),\n  templateId: integer(\"template_id\").notNull().references(() => reportTemplates.id, { onDelete: \"cascade\" }),\n  status: text(\"status\").notNull().default(\"pending\"), // 'pending', 'running', 'completed', 'failed'\n  triggeredBy: text(\"triggered_by\").notNull(), // 'schedule', 'manual'\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  rowCount: integer(\"row_count\"),\n  fileSize: integer(\"file_size\"),\n  filePath: text(\"file_path\"), // path to generated file\n  recipients: jsonb(\"recipients\"), // who received the report\n  emailsSent: integer(\"emails_sent\").default(0),\n  errorMessage: text(\"error_message\"),\n  executionTimeMs: integer(\"execution_time_ms\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n}, (table) => [\n  index(\"runs_schedule_idx\").on(table.scheduleId),\n  index(\"runs_template_idx\").on(table.templateId),\n  index(\"runs_status_idx\").on(table.status),\n]);\n\nexport const reportRunsRelations = relations(reportRuns, ({ one }) => ({\n  schedule: one(reportSchedules, { fields: [reportRuns.scheduleId], references: [reportSchedules.id] }),\n  template: one(reportTemplates, { fields: [reportRuns.templateId], references: [reportTemplates.id] }),\n  createdByUser: one(users, { fields: [reportRuns.createdBy], references: [users.id] }),\n}));\n\n// Email Recipients List - pre-defined recipients for reports\nexport const reportRecipients = pgTable(\"report_recipients\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  email: text(\"email\").notNull(),\n  department: text(\"department\"),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n});\n\nexport const reportRecipientsRelations = relations(reportRecipients, ({ one }) => ({\n  createdByUser: one(users, { fields: [reportRecipients.createdBy], references: [users.id] }),\n}));\n\n// Insert schemas and types\nexport const insertReportTemplateSchema = createInsertSchema(reportTemplates).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertReportTemplate = z.infer<typeof insertReportTemplateSchema>;\nexport type ReportTemplate = typeof reportTemplates.$inferSelect;\n\nexport const insertReportScheduleSchema = createInsertSchema(reportSchedules).omit({ id: true, createdAt: true, updatedAt: true, lastRunAt: true, lastRunStatus: true, lastRunError: true, runCount: true });\nexport type InsertReportSchedule = z.infer<typeof insertReportScheduleSchema>;\nexport type ReportSchedule = typeof reportSchedules.$inferSelect;\n\nexport const insertReportRunSchema = createInsertSchema(reportRuns).omit({ id: true, createdAt: true });\nexport type InsertReportRun = z.infer<typeof insertReportRunSchema>;\nexport type ReportRun = typeof reportRuns.$inferSelect;\n\nexport const insertReportRecipientSchema = createInsertSchema(reportRecipients).omit({ id: true, createdAt: true });\nexport type InsertReportRecipient = z.infer<typeof insertReportRecipientSchema>;\nexport type ReportRecipient = typeof reportRecipients.$inferSelect;\n\n// Custom Dashboards - user-created dashboard configurations\nexport const customDashboards = pgTable(\"custom_dashboards\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  isPublic: boolean(\"is_public\").default(false),\n  layout: jsonb(\"layout\").notNull().default([]),\n  filters: jsonb(\"filters\").default({}),\n  widgets: jsonb(\"widgets\").notNull().default([]),\n  theme: text(\"theme\").default(\"default\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"dashboards_user_idx\").on(table.userId),\n]);\n\nexport const customDashboardsRelations = relations(customDashboards, ({ one }) => ({\n  user: one(users, { fields: [customDashboards.userId], references: [users.id] }),\n}));\n\n// AI Analysis Suggestions - AI-generated insights and chart recommendations\nexport const aiSuggestions = pgTable(\"ai_suggestions\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id),\n  suggestionType: text(\"suggestion_type\").notNull(), // 'chart', 'report', 'insight', 'anomaly'\n  title: text(\"title\").notNull(),\n  description: text(\"description\").notNull(),\n  configuration: jsonb(\"configuration\").notNull().default({}),\n  relevanceScore: decimal(\"relevance_score\", { precision: 5, scale: 2 }).default(\"0\"),\n  dataContext: jsonb(\"data_context\").default({}),\n  dismissed: boolean(\"dismissed\").default(false),\n  applied: boolean(\"applied\").default(false),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  expiresAt: timestamp(\"expires_at\"),\n}, (table) => [\n  index(\"suggestions_user_idx\").on(table.userId),\n  index(\"suggestions_type_idx\").on(table.suggestionType),\n]);\n\nexport const aiSuggestionsRelations = relations(aiSuggestions, ({ one }) => ({\n  user: one(users, { fields: [aiSuggestions.userId], references: [users.id] }),\n}));\n\n// Dashboard widget types\nexport type DashboardWidget = {\n  id: string;\n  type: 'chart' | 'metric' | 'table' | 'map' | 'comparison';\n  title: string;\n  config: {\n    chartType?: 'bar' | 'line' | 'pie' | 'area';\n    dataSource?: string;\n    filters?: Record<string, string>;\n    metrics?: string[];\n    dimensions?: string[];\n  };\n  position: { x: number; y: number; w: number; h: number };\n};\n\nexport const insertCustomDashboardSchema = createInsertSchema(customDashboards).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertCustomDashboard = z.infer<typeof insertCustomDashboardSchema>;\nexport type CustomDashboard = typeof customDashboards.$inferSelect;\n\nexport const insertAiSuggestionSchema = createInsertSchema(aiSuggestions).omit({ id: true, createdAt: true });\nexport type InsertAiSuggestion = z.infer<typeof insertAiSuggestionSchema>;\nexport type AiSuggestion = typeof aiSuggestions.$inferSelect;\n\n// Sentiment Analysis Data Sources - external news, blogs, forums\nexport const sentimentDataSources = pgTable(\"sentiment_data_sources\", {\n  id: serial(\"id\").primaryKey(),\n  sourceType: text(\"source_type\").notNull(), // 'news', 'blog', 'forum', 'social'\n  sourceName: text(\"source_name\").notNull(),\n  sourceUrl: text(\"source_url\"),\n  country: text(\"country\").default(\"BR\"),\n  language: text(\"language\").default(\"pt\"),\n  isActive: boolean(\"is_active\").default(true),\n  lastFetched: timestamp(\"last_fetched\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"sources_type_idx\").on(table.sourceType),\n]);\n\nexport const insertSentimentDataSourceSchema = createInsertSchema(sentimentDataSources).omit({ id: true, createdAt: true });\nexport type InsertSentimentDataSource = z.infer<typeof insertSentimentDataSourceSchema>;\nexport type SentimentDataSource = typeof sentimentDataSources.$inferSelect;\n\n// Sentiment Articles - collected articles from various sources\nexport const sentimentArticles = pgTable(\"sentiment_articles\", {\n  id: serial(\"id\").primaryKey(),\n  sourceId: integer(\"source_id\").references(() => sentimentDataSources.id),\n  sourceType: text(\"source_type\").default(\"news\"), // 'news', 'social', 'blog', 'forum'\n  title: text(\"title\").notNull(),\n  content: text(\"content\").notNull(),\n  summary: text(\"summary\"),\n  url: text(\"url\"),\n  author: text(\"author\"),\n  publishedAt: timestamp(\"published_at\"),\n  fetchedAt: timestamp(\"fetched_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  language: text(\"language\").default(\"pt\"),\n  country: text(\"country\").default(\"BR\"),\n  processedAt: timestamp(\"processed_at\"),\n  overallSentiment: decimal(\"overall_sentiment\", { precision: 5, scale: 4 }), // article-level sentiment\n  sentimentLabel: text(\"sentiment_label\"), // 'positive', 'negative', 'neutral'\n}, (table) => [\n  index(\"articles_source_idx\").on(table.sourceId),\n  index(\"articles_published_idx\").on(table.publishedAt),\n  index(\"articles_source_type_idx\").on(table.sourceType),\n  index(\"articles_sentiment_idx\").on(table.sentimentLabel),\n]);\n\nexport const insertSentimentArticleSchema = createInsertSchema(sentimentArticles).omit({ id: true, fetchedAt: true });\nexport type InsertSentimentArticle = z.infer<typeof insertSentimentArticleSchema>;\nexport type SentimentArticle = typeof sentimentArticles.$inferSelect;\n\n// Sentiment Analysis Results - historical sentiment scores per entity\nexport const sentimentAnalysisResults = pgTable(\"sentiment_analysis_results\", {\n  id: serial(\"id\").primaryKey(),\n  entityType: text(\"entity_type\").notNull(), // 'party', 'candidate', 'topic'\n  entityId: text(\"entity_id\").notNull(), // party abbreviation or candidate id\n  entityName: text(\"entity_name\").notNull(),\n  analysisDate: timestamp(\"analysis_date\").notNull(),\n  sentimentScore: decimal(\"sentiment_score\", { precision: 5, scale: 4 }).notNull(), // -1 to 1\n  sentimentLabel: text(\"sentiment_label\").notNull(), // 'positive', 'negative', 'neutral', 'mixed'\n  confidence: decimal(\"confidence\", { precision: 5, scale: 4 }).notNull(),\n  mentionCount: integer(\"mention_count\").default(0),\n  positiveCount: integer(\"positive_count\").default(0),\n  negativeCount: integer(\"negative_count\").default(0),\n  neutralCount: integer(\"neutral_count\").default(0),\n  sourceBreakdown: jsonb(\"source_breakdown\").default({}), // { news: x, blog: y, forum: z }\n  topKeywords: jsonb(\"top_keywords\").default([]), // [{ word: string, count: number, sentiment: number }]\n  sampleMentions: jsonb(\"sample_mentions\").default([]), // sample text snippets\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"sentiment_entity_idx\").on(table.entityType, table.entityId),\n  index(\"sentiment_date_idx\").on(table.analysisDate),\n]);\n\nexport const insertSentimentAnalysisResultSchema = createInsertSchema(sentimentAnalysisResults).omit({ id: true, createdAt: true });\nexport type InsertSentimentAnalysisResult = z.infer<typeof insertSentimentAnalysisResultSchema>;\nexport type SentimentAnalysisResult = typeof sentimentAnalysisResults.$inferSelect;\n\n// Word Cloud Data - aggregated keywords for visualization\nexport const sentimentKeywords = pgTable(\"sentiment_keywords\", {\n  id: serial(\"id\").primaryKey(),\n  keyword: text(\"keyword\").notNull(),\n  entityType: text(\"entity_type\"), // null = global, 'party', 'candidate'\n  entityId: text(\"entity_id\"),\n  frequency: integer(\"frequency\").notNull().default(1),\n  averageSentiment: decimal(\"average_sentiment\", { precision: 5, scale: 4 }).default(\"0\"),\n  firstSeen: timestamp(\"first_seen\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  lastSeen: timestamp(\"last_seen\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  trendDirection: text(\"trend_direction\").default(\"stable\"), // 'rising', 'falling', 'stable'\n}, (table) => [\n  index(\"keywords_entity_idx\").on(table.entityType, table.entityId),\n  index(\"keywords_frequency_idx\").on(table.frequency),\n]);\n\nexport const insertSentimentKeywordSchema = createInsertSchema(sentimentKeywords).omit({ id: true, firstSeen: true, lastSeen: true });\nexport type InsertSentimentKeyword = z.infer<typeof insertSentimentKeywordSchema>;\nexport type SentimentKeyword = typeof sentimentKeywords.$inferSelect;\n\n// Sentiment Crisis Alerts - detect and notify about negative sentiment spikes\nexport const sentimentCrisisAlerts = pgTable(\"sentiment_crisis_alerts\", {\n  id: serial(\"id\").primaryKey(),\n  entityType: text(\"entity_type\").notNull(), // 'party', 'candidate'\n  entityId: text(\"entity_id\").notNull(),\n  entityName: text(\"entity_name\").notNull(),\n  alertType: text(\"alert_type\").notNull(), // 'negative_spike', 'crisis', 'trending_negative', 'high_volume'\n  severity: text(\"severity\").notNull().default(\"medium\"), // 'low', 'medium', 'high', 'critical'\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  sentimentBefore: decimal(\"sentiment_before\", { precision: 5, scale: 4 }),\n  sentimentAfter: decimal(\"sentiment_after\", { precision: 5, scale: 4 }),\n  sentimentChange: decimal(\"sentiment_change\", { precision: 5, scale: 4 }),\n  mentionCount: integer(\"mention_count\").default(0),\n  triggerArticleIds: jsonb(\"trigger_article_ids\").default([]), // IDs of articles that triggered alert\n  triggerKeywords: jsonb(\"trigger_keywords\").default([]), // keywords associated with crisis\n  isAcknowledged: boolean(\"is_acknowledged\").default(false),\n  acknowledgedBy: varchar(\"acknowledged_by\").references(() => users.id),\n  acknowledgedAt: timestamp(\"acknowledged_at\"),\n  detectedAt: timestamp(\"detected_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"crisis_entity_idx\").on(table.entityType, table.entityId),\n  index(\"crisis_severity_idx\").on(table.severity),\n  index(\"crisis_detected_idx\").on(table.detectedAt),\n  index(\"crisis_acknowledged_idx\").on(table.isAcknowledged),\n]);\n\nexport const insertSentimentCrisisAlertSchema = createInsertSchema(sentimentCrisisAlerts).omit({ id: true, createdAt: true, detectedAt: true });\nexport type InsertSentimentCrisisAlert = z.infer<typeof insertSentimentCrisisAlertSchema>;\nexport type SentimentCrisisAlert = typeof sentimentCrisisAlerts.$inferSelect;\n\n// Sentiment Monitoring Sessions - track multi-entity comparison sessions\nexport const sentimentMonitoringSessions = pgTable(\"sentiment_monitoring_sessions\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  entities: jsonb(\"entities\").notNull().default([]), // [{ type: 'party'|'candidate', id: string, name: string }]\n  sourceFilters: jsonb(\"source_filters\").default({}), // { types: ['news', 'social'], countries: ['BR'] }\n  dateRange: jsonb(\"date_range\"), // { start: timestamp, end: timestamp }\n  alertThreshold: decimal(\"alert_threshold\", { precision: 5, scale: 4 }).default(\"-0.3\"), // sentiment drop threshold for alerts\n  isActive: boolean(\"is_active\").default(true),\n  lastAnalyzedAt: timestamp(\"last_analyzed_at\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"monitoring_user_idx\").on(table.userId),\n  index(\"monitoring_active_idx\").on(table.isActive),\n]);\n\nexport const insertSentimentMonitoringSessionSchema = createInsertSchema(sentimentMonitoringSessions).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertSentimentMonitoringSession = z.infer<typeof insertSentimentMonitoringSessionSchema>;\nexport type SentimentMonitoringSession = typeof sentimentMonitoringSessions.$inferSelect;\n\n// Sentiment Comparison Snapshots - store point-in-time comparisons\nexport const sentimentComparisonSnapshots = pgTable(\"sentiment_comparison_snapshots\", {\n  id: serial(\"id\").primaryKey(),\n  sessionId: integer(\"session_id\").references(() => sentimentMonitoringSessions.id),\n  snapshotDate: timestamp(\"snapshot_date\").notNull(),\n  entityResults: jsonb(\"entity_results\").notNull().default([]), // [{ entityType, entityId, entityName, sentimentScore, mentionCount, topKeywords }]\n  comparisonAnalysis: text(\"comparison_analysis\"), // AI-generated comparative analysis\n  overallSentiment: decimal(\"overall_sentiment\", { precision: 5, scale: 4 }),\n  sourceBreakdown: jsonb(\"source_breakdown\").default({}),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"snapshot_session_idx\").on(table.sessionId),\n  index(\"snapshot_date_idx\").on(table.snapshotDate),\n]);\n\nexport const insertSentimentComparisonSnapshotSchema = createInsertSchema(sentimentComparisonSnapshots).omit({ id: true, createdAt: true });\nexport type InsertSentimentComparisonSnapshot = z.infer<typeof insertSentimentComparisonSnapshotSchema>;\nexport type SentimentComparisonSnapshot = typeof sentimentComparisonSnapshots.$inferSelect;\n\n// Article Entity Mentions - link articles to entities they mention\nexport const articleEntityMentions = pgTable(\"article_entity_mentions\", {\n  id: serial(\"id\").primaryKey(),\n  articleId: integer(\"article_id\").references(() => sentimentArticles.id).notNull(),\n  entityType: text(\"entity_type\").notNull(), // 'party', 'candidate'\n  entityId: text(\"entity_id\").notNull(),\n  entityName: text(\"entity_name\").notNull(),\n  mentionCount: integer(\"mention_count\").default(1),\n  sentimentScore: decimal(\"sentiment_score\", { precision: 5, scale: 4 }),\n  sentimentLabel: text(\"sentiment_label\"), // 'positive', 'negative', 'neutral'\n  excerpts: jsonb(\"excerpts\").default([]), // text snippets mentioning the entity\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"mention_article_idx\").on(table.articleId),\n  index(\"mention_entity_idx\").on(table.entityType, table.entityId),\n]);\n\nexport const insertArticleEntityMentionSchema = createInsertSchema(articleEntityMentions).omit({ id: true, createdAt: true });\nexport type InsertArticleEntityMention = z.infer<typeof insertArticleEntityMentionSchema>;\nexport type ArticleEntityMention = typeof articleEntityMentions.$inferSelect;\n\n// Alert Configuration - configurable thresholds for crisis detection\nexport const alertConfigurations = pgTable(\"alert_configurations\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  name: text(\"name\").notNull(),\n  isGlobal: boolean(\"is_global\").default(false), // if true, applies to all entities\n  entityType: text(\"entity_type\"), // 'party', 'candidate', null for global\n  entityId: text(\"entity_id\"), // specific entity or null for type-wide\n  // Thresholds for crisis detection\n  sentimentDropThreshold: decimal(\"sentiment_drop_threshold\", { precision: 5, scale: 4 }).default(\"0.3\"), // drop of 30%\n  criticalSentimentLevel: decimal(\"critical_sentiment_level\", { precision: 5, scale: 4 }).default(\"-0.5\"),\n  mentionSpikeMultiplier: decimal(\"mention_spike_multiplier\", { precision: 5, scale: 2 }).default(\"2.0\"), // 2x average\n  timeWindowMinutes: integer(\"time_window_minutes\").default(60), // detection window\n  // Notification preferences\n  notifyEmail: boolean(\"notify_email\").default(true),\n  notifyInApp: boolean(\"notify_in_app\").default(true),\n  emailRecipients: jsonb(\"email_recipients\").default([]), // additional email addresses\n  // Rate limiting\n  minAlertIntervalMinutes: integer(\"min_alert_interval_minutes\").default(30), // avoid alert spam\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const insertAlertConfigurationSchema = createInsertSchema(alertConfigurations).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertAlertConfiguration = z.infer<typeof insertAlertConfigurationSchema>;\nexport type AlertConfiguration = typeof alertConfigurations.$inferSelect;\n\n// In-App Notifications - real-time notifications for users\nexport const inAppNotifications = pgTable(\"in_app_notifications\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  type: text(\"type\").notNull(), // 'crisis_alert', 'import_complete', 'report_ready', 'system'\n  severity: text(\"severity\").default(\"info\"), // 'info', 'warning', 'error', 'critical'\n  title: text(\"title\").notNull(),\n  message: text(\"message\").notNull(),\n  actionUrl: text(\"action_url\"), // optional link to relevant page\n  relatedEntityType: text(\"related_entity_type\"), // 'party', 'candidate', 'import', etc.\n  relatedEntityId: text(\"related_entity_id\"),\n  metadata: jsonb(\"metadata\").default({}), // additional context\n  isRead: boolean(\"is_read\").default(false),\n  readAt: timestamp(\"read_at\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"notification_user_idx\").on(table.userId),\n  index(\"notification_read_idx\").on(table.isRead),\n  index(\"notification_type_idx\").on(table.type),\n  index(\"notification_created_idx\").on(table.createdAt),\n]);\n\nexport const insertInAppNotificationSchema = createInsertSchema(inAppNotifications).omit({ id: true, createdAt: true });\nexport type InsertInAppNotification = z.infer<typeof insertInAppNotificationSchema>;\nexport type InAppNotification = typeof inAppNotifications.$inferSelect;\n\n// IBGE Demographic Data - Municipalities\nexport const ibgeMunicipios = pgTable(\"ibge_municipios\", {\n  id: serial(\"id\").primaryKey(),\n  codigoIbge: varchar(\"codigo_ibge\", { length: 7 }).notNull().unique(), // 7-digit IBGE code\n  nome: text(\"nome\").notNull(),\n  uf: varchar(\"uf\", { length: 2 }).notNull(),\n  ufNome: text(\"uf_nome\"),\n  regiaoNome: text(\"regiao_nome\"),\n  mesorregiao: text(\"mesorregiao\"),\n  microrregiao: text(\"microrregiao\"),\n  areaKm2: decimal(\"area_km2\", { precision: 12, scale: 3 }),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"municipio_uf_idx\").on(table.uf),\n  index(\"municipio_codigo_idx\").on(table.codigoIbge),\n]);\n\nexport const insertIbgeMunicipioSchema = createInsertSchema(ibgeMunicipios).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertIbgeMunicipio = z.infer<typeof insertIbgeMunicipioSchema>;\nexport type IbgeMunicipio = typeof ibgeMunicipios.$inferSelect;\n\n// IBGE Population Data - Historical population estimates\nexport const ibgePopulacao = pgTable(\"ibge_populacao\", {\n  id: serial(\"id\").primaryKey(),\n  municipioId: integer(\"municipio_id\").references(() => ibgeMunicipios.id, { onDelete: \"cascade\" }),\n  codigoIbge: varchar(\"codigo_ibge\", { length: 7 }).notNull(),\n  ano: integer(\"ano\").notNull(),\n  populacao: bigint(\"populacao\", { mode: \"number\" }),\n  populacaoMasculina: bigint(\"populacao_masculina\", { mode: \"number\" }),\n  populacaoFeminina: bigint(\"populacao_feminina\", { mode: \"number\" }),\n  densidadeDemografica: decimal(\"densidade_demografica\", { precision: 12, scale: 4 }),\n  fonte: text(\"fonte\").default(\"IBGE/SIDRA\"),\n  tabelaSidra: varchar(\"tabela_sidra\", { length: 10 }),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"populacao_municipio_idx\").on(table.municipioId),\n  index(\"populacao_ano_idx\").on(table.ano),\n  index(\"populacao_codigo_ano_idx\").on(table.codigoIbge, table.ano),\n]);\n\nexport const insertIbgePopulacaoSchema = createInsertSchema(ibgePopulacao).omit({ id: true, createdAt: true });\nexport type InsertIbgePopulacao = z.infer<typeof insertIbgePopulacaoSchema>;\nexport type IbgePopulacao = typeof ibgePopulacao.$inferSelect;\n\n// IBGE Socioeconomic Indicators\nexport const ibgeIndicadores = pgTable(\"ibge_indicadores\", {\n  id: serial(\"id\").primaryKey(),\n  municipioId: integer(\"municipio_id\").references(() => ibgeMunicipios.id, { onDelete: \"cascade\" }),\n  codigoIbge: varchar(\"codigo_ibge\", { length: 7 }).notNull(),\n  ano: integer(\"ano\").notNull(),\n  // Education indicators\n  taxaAlfabetizacao: decimal(\"taxa_alfabetizacao\", { precision: 6, scale: 3 }), // %\n  taxaEscolarizacao6a14: decimal(\"taxa_escolarizacao_6_14\", { precision: 6, scale: 3 }), // %\n  ideb: decimal(\"ideb\", { precision: 4, scale: 2 }), // IDEB score\n  // Economic indicators\n  pibPerCapita: decimal(\"pib_per_capita\", { precision: 14, scale: 2 }),\n  rendaMediaDomiciliar: decimal(\"renda_media_domiciliar\", { precision: 12, scale: 2 }),\n  salarioMedioMensal: decimal(\"salario_medio_mensal\", { precision: 10, scale: 2 }),\n  taxaDesemprego: decimal(\"taxa_desemprego\", { precision: 6, scale: 3 }),\n  // Social indicators\n  idhm: decimal(\"idhm\", { precision: 5, scale: 4 }), // Human Development Index\n  idhmEducacao: decimal(\"idhm_educacao\", { precision: 5, scale: 4 }),\n  idhmLongevidade: decimal(\"idhm_longevidade\", { precision: 5, scale: 4 }),\n  idhmRenda: decimal(\"idhm_renda\", { precision: 5, scale: 4 }),\n  indiceGini: decimal(\"indice_gini\", { precision: 5, scale: 4 }),\n  // Infrastructure\n  percentualUrbanizacao: decimal(\"percentual_urbanizacao\", { precision: 6, scale: 3 }),\n  percentualSaneamento: decimal(\"percentual_saneamento\", { precision: 6, scale: 3 }),\n  percentualAguaEncanada: decimal(\"percentual_agua_encanada\", { precision: 6, scale: 3 }),\n  percentualEnergiaEletrica: decimal(\"percentual_energia_eletrica\", { precision: 6, scale: 3 }),\n  // Electoral data\n  eleitoresAptos: integer(\"eleitores_aptos\"),\n  comparecimento: integer(\"comparecimento\"),\n  abstencao: integer(\"abstencao\"),\n  votosValidos: integer(\"votos_validos\"),\n  fonte: text(\"fonte\").default(\"IBGE\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"indicadores_municipio_idx\").on(table.municipioId),\n  index(\"indicadores_ano_idx\").on(table.ano),\n  index(\"indicadores_codigo_ano_idx\").on(table.codigoIbge, table.ano),\n]);\n\nexport const insertIbgeIndicadorSchema = createInsertSchema(ibgeIndicadores).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertIbgeIndicador = z.infer<typeof insertIbgeIndicadorSchema>;\nexport type IbgeIndicador = typeof ibgeIndicadores.$inferSelect;\n\n// IBGE Import Jobs - Track import operations\nexport const ibgeImportJobs = pgTable(\"ibge_import_jobs\", {\n  id: serial(\"id\").primaryKey(),\n  type: text(\"type\").notNull(), // 'municipios', 'populacao', 'indicadores', 'all'\n  status: text(\"status\").notNull().default(\"pending\"), // 'pending', 'running', 'completed', 'failed'\n  totalRecords: integer(\"total_records\").default(0),\n  processedRecords: integer(\"processed_records\").default(0),\n  failedRecords: integer(\"failed_records\").default(0),\n  errorMessage: text(\"error_message\"),\n  errorDetails: jsonb(\"error_details\"),\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  source: text(\"source\").default(\"IBGE/SIDRA\"),\n  parameters: jsonb(\"parameters\"), // API parameters used\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"ibge_import_status_idx\").on(table.status),\n  index(\"ibge_import_type_idx\").on(table.type),\n]);\n\nexport const insertIbgeImportJobSchema = createInsertSchema(ibgeImportJobs).omit({ id: true, createdAt: true });\nexport type InsertIbgeImportJob = z.infer<typeof insertIbgeImportJobSchema>;\nexport type IbgeImportJob = typeof ibgeImportJobs.$inferSelect;\n\n// Campaign Insights - AI-powered campaign strategy analysis\nexport const campaignInsightSessions = pgTable(\"campaign_insight_sessions\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  targetPartyId: integer(\"target_party_id\").references(() => parties.id),\n  targetCandidateId: integer(\"target_candidate_id\").references(() => candidates.id),\n  electionYear: integer(\"election_year\").notNull(),\n  position: text(\"position\"), // 'deputado_federal', 'deputado_estadual', 'vereador', etc.\n  targetRegion: text(\"target_region\"), // UF or 'NACIONAL'\n  status: text(\"status\").default(\"active\"), // 'active', 'archived'\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"campaign_insight_party_idx\").on(table.targetPartyId),\n  index(\"campaign_insight_year_idx\").on(table.electionYear),\n]);\n\nexport const insertCampaignInsightSessionSchema = createInsertSchema(campaignInsightSessions).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertCampaignInsightSession = z.infer<typeof insertCampaignInsightSessionSchema>;\nexport type CampaignInsightSession = typeof campaignInsightSessions.$inferSelect;\n\n// High Impact Segments - Identified voter segments with high campaign potential\nexport const highImpactSegments = pgTable(\"high_impact_segments\", {\n  id: serial(\"id\").primaryKey(),\n  sessionId: integer(\"session_id\").references(() => campaignInsightSessions.id).notNull(),\n  segmentType: text(\"segment_type\").notNull(), // 'demographic', 'geographic', 'behavioral'\n  segmentName: text(\"segment_name\").notNull(),\n  description: text(\"description\"),\n  // Geographic data\n  uf: text(\"uf\"),\n  municipios: jsonb(\"municipios\"), // Array of municipality codes\n  region: text(\"region\"), // 'norte', 'nordeste', 'sudeste', 'sul', 'centro-oeste'\n  // Demographic data\n  ageGroup: text(\"age_group\"), // '18-24', '25-34', '35-44', '45-59', '60+'\n  educationLevel: text(\"education_level\"),\n  incomeLevel: text(\"income_level\"), // 'baixa', 'media', 'alta'\n  // Impact metrics\n  estimatedVoters: integer(\"estimated_voters\"),\n  impactScore: decimal(\"impact_score\", { precision: 5, scale: 2 }), // 0-100\n  conversionPotential: decimal(\"conversion_potential\", { precision: 5, scale: 2 }), // 0-100\n  currentSentiment: decimal(\"current_sentiment\", { precision: 5, scale: 2 }), // -100 to 100\n  volatility: decimal(\"volatility\", { precision: 5, scale: 2 }), // 0-100, how likely to change\n  priorityRank: integer(\"priority_rank\"),\n  // AI analysis\n  aiRationale: text(\"ai_rationale\"),\n  keyFactors: jsonb(\"key_factors\"), // Array of factors driving the score\n  historicalTrends: jsonb(\"historical_trends\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"segment_session_idx\").on(table.sessionId),\n  index(\"segment_impact_idx\").on(table.impactScore),\n]);\n\nexport const insertHighImpactSegmentSchema = createInsertSchema(highImpactSegments).omit({ id: true, createdAt: true });\nexport type InsertHighImpactSegment = z.infer<typeof insertHighImpactSegmentSchema>;\nexport type HighImpactSegment = typeof highImpactSegments.$inferSelect;\n\n// Message Strategies - AI-suggested communication strategies per segment\nexport const messageStrategies = pgTable(\"message_strategies\", {\n  id: serial(\"id\").primaryKey(),\n  sessionId: integer(\"session_id\").references(() => campaignInsightSessions.id).notNull(),\n  segmentId: integer(\"segment_id\").references(() => highImpactSegments.id),\n  // Target info\n  targetAudience: text(\"target_audience\").notNull(),\n  sentimentProfile: text(\"sentiment_profile\"), // 'positive', 'neutral', 'negative', 'mixed'\n  // Strategy\n  mainTheme: text(\"main_theme\").notNull(),\n  keyMessages: jsonb(\"key_messages\"), // Array of suggested messages\n  toneRecommendation: text(\"tone_recommendation\"), // 'formal', 'informal', 'emocional', 'tecnico'\n  channelRecommendations: jsonb(\"channel_recommendations\"), // 'tv', 'radio', 'redes_sociais', 'presencial'\n  // Content suggestions\n  topicsToEmphasize: jsonb(\"topics_to_emphasize\"),\n  topicsToAvoid: jsonb(\"topics_to_avoid\"),\n  competitorWeaknesses: jsonb(\"competitor_weaknesses\"),\n  // Sentiment analysis\n  currentSentimentTrend: text(\"current_sentiment_trend\"), // 'rising', 'falling', 'stable'\n  sentimentDrivers: jsonb(\"sentiment_drivers\"),\n  // AI analysis\n  aiAnalysis: text(\"ai_analysis\"),\n  confidenceScore: decimal(\"confidence_score\", { precision: 5, scale: 2 }),\n  expectedEffectiveness: decimal(\"expected_effectiveness\", { precision: 5, scale: 2 }),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"message_session_idx\").on(table.sessionId),\n  index(\"message_segment_idx\").on(table.segmentId),\n]);\n\nexport const insertMessageStrategySchema = createInsertSchema(messageStrategies).omit({ id: true, createdAt: true });\nexport type InsertMessageStrategy = z.infer<typeof insertMessageStrategySchema>;\nexport type MessageStrategy = typeof messageStrategies.$inferSelect;\n\n// Campaign Impact Predictions - Predicted outcomes of campaign investments\nexport const campaignImpactPredictions = pgTable(\"campaign_impact_predictions\", {\n  id: serial(\"id\").primaryKey(),\n  sessionId: integer(\"session_id\").references(() => campaignInsightSessions.id).notNull(),\n  predictionType: text(\"prediction_type\").notNull(), // 'investment', 'event', 'message', 'overall'\n  // Investment scenario\n  investmentType: text(\"investment_type\"), // 'publicidade_tv', 'redes_sociais', 'eventos', 'santinhos'\n  investmentAmount: decimal(\"investment_amount\", { precision: 14, scale: 2 }),\n  targetSegments: jsonb(\"target_segments\"), // Array of segment IDs\n  duration: integer(\"duration\"), // days\n  // Predicted outcomes\n  predictedSentimentChange: decimal(\"predicted_sentiment_change\", { precision: 5, scale: 2 }),\n  predictedVoteIntention: decimal(\"predicted_vote_intention\", { precision: 5, scale: 2 }), // percentage\n  predictedVoteChange: decimal(\"predicted_vote_change\", { precision: 5, scale: 2 }), // delta\n  confidenceInterval: jsonb(\"confidence_interval\"), // { lower: number, upper: number }\n  probabilityOfSuccess: decimal(\"probability_of_success\", { precision: 5, scale: 2 }),\n  // ROI analysis\n  estimatedReach: integer(\"estimated_reach\"),\n  costPerVoterReached: decimal(\"cost_per_voter_reached\", { precision: 10, scale: 2 }),\n  expectedROI: decimal(\"expected_roi\", { precision: 5, scale: 2 }),\n  // Comparative analysis\n  comparisonBaseline: jsonb(\"comparison_baseline\"),\n  alternativeScenarios: jsonb(\"alternative_scenarios\"),\n  // AI analysis\n  aiNarrative: text(\"ai_narrative\"),\n  riskFactors: jsonb(\"risk_factors\"),\n  recommendations: jsonb(\"recommendations\"),\n  methodology: text(\"methodology\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"prediction_session_idx\").on(table.sessionId),\n  index(\"prediction_type_idx\").on(table.predictionType),\n]);\n\nexport const insertCampaignImpactPredictionSchema = createInsertSchema(campaignImpactPredictions).omit({ id: true, createdAt: true });\nexport type InsertCampaignImpactPrediction = z.infer<typeof insertCampaignImpactPredictionSchema>;\nexport type CampaignImpactPrediction = typeof campaignImpactPredictions.$inferSelect;\n\n// Campaign Insight Reports - Generated AI reports\nexport const campaignInsightReports = pgTable(\"campaign_insight_reports\", {\n  id: serial(\"id\").primaryKey(),\n  sessionId: integer(\"session_id\").references(() => campaignInsightSessions.id).notNull(),\n  reportType: text(\"report_type\").notNull(), // 'full', 'segments', 'messages', 'predictions', 'executive'\n  title: text(\"title\").notNull(),\n  executiveSummary: text(\"executive_summary\"),\n  fullContent: text(\"full_content\"),\n  visualizations: jsonb(\"visualizations\"), // Chart configurations\n  keyInsights: jsonb(\"key_insights\"),\n  actionItems: jsonb(\"action_items\"),\n  dataSnapshot: jsonb(\"data_snapshot\"), // Snapshot of data used\n  generatedAt: timestamp(\"generated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n}, (table) => [\n  index(\"report_session_idx\").on(table.sessionId),\n  index(\"report_type_idx\").on(table.reportType),\n]);\n\nexport const insertCampaignInsightReportSchema = createInsertSchema(campaignInsightReports).omit({ id: true, generatedAt: true });\nexport type InsertCampaignInsightReport = z.infer<typeof insertCampaignInsightReportSchema>;\nexport type CampaignInsightReport = typeof campaignInsightReports.$inferSelect;\n\n// ============ CAMPAIGN MANAGEMENT MODULE ============\n\n// Campaigns - Main campaign entity\nexport const campaigns = pgTable(\"campaigns\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  startDate: timestamp(\"start_date\").notNull(),\n  endDate: timestamp(\"end_date\").notNull(),\n  status: text(\"status\").notNull().default(\"planning\"), // planning, active, paused, completed, cancelled\n  goal: text(\"goal\"), // Main campaign goal/objective\n  targetVotes: integer(\"target_votes\"),\n  targetRegion: text(\"target_region\"),\n  position: text(\"position\").notNull().default(\"vereador\"),\n  totalBudget: decimal(\"total_budget\", { precision: 15, scale: 2 }).default(\"0\"),\n  spentBudget: decimal(\"spent_budget\", { precision: 15, scale: 2 }).default(\"0\"),\n  targetPartyId: integer(\"target_party_id\").references(() => parties.id),\n  targetCandidateId: integer(\"target_candidate_id\").references(() => candidates.id),\n  aiSessionId: integer(\"ai_session_id\").references(() => campaignInsightSessions.id),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"campaign_status_idx\").on(table.status),\n  index(\"campaign_party_idx\").on(table.targetPartyId),\n  index(\"campaign_dates_idx\").on(table.startDate, table.endDate),\n]);\n\nexport const insertCampaignSchema = createInsertSchema(campaigns).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertCampaign = z.infer<typeof insertCampaignSchema>;\nexport type Campaign = typeof campaigns.$inferSelect;\n\n// Campaign Budgets - Budget allocation by category\nexport const campaignBudgets = pgTable(\"campaign_budgets\", {\n  id: serial(\"id\").primaryKey(),\n  campaignId: integer(\"campaign_id\").references(() => campaigns.id, { onDelete: \"cascade\" }).notNull(),\n  category: text(\"category\").notNull(), // advertising, events, staff, materials, digital, transport, other\n  categoryLabel: text(\"category_label\").notNull(),\n  allocatedAmount: decimal(\"allocated_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  spentAmount: decimal(\"spent_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"budget_campaign_idx\").on(table.campaignId),\n  index(\"budget_category_idx\").on(table.category),\n]);\n\nexport const insertCampaignBudgetSchema = createInsertSchema(campaignBudgets).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertCampaignBudget = z.infer<typeof insertCampaignBudgetSchema>;\nexport type CampaignBudget = typeof campaignBudgets.$inferSelect;\n\n// Campaign Resources - Human and material resources\nexport const campaignResources = pgTable(\"campaign_resources\", {\n  id: serial(\"id\").primaryKey(),\n  campaignId: integer(\"campaign_id\").references(() => campaigns.id, { onDelete: \"cascade\" }).notNull(),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull(), // staff, volunteer, vehicle, equipment, material\n  quantity: integer(\"quantity\").notNull().default(1),\n  unitCost: decimal(\"unit_cost\", { precision: 12, scale: 2 }),\n  totalCost: decimal(\"total_cost\", { precision: 12, scale: 2 }),\n  status: text(\"status\").notNull().default(\"available\"), // available, allocated, unavailable\n  assignedTo: text(\"assigned_to\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"resource_campaign_idx\").on(table.campaignId),\n  index(\"resource_type_idx\").on(table.type),\n  index(\"resource_status_idx\").on(table.status),\n]);\n\nexport const insertCampaignResourceSchema = createInsertSchema(campaignResources).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertCampaignResource = z.infer<typeof insertCampaignResourceSchema>;\nexport type CampaignResource = typeof campaignResources.$inferSelect;\n\n// Campaign Metrics - Performance tracking\nexport const campaignMetrics = pgTable(\"campaign_metrics\", {\n  id: serial(\"id\").primaryKey(),\n  campaignId: integer(\"campaign_id\").references(() => campaigns.id, { onDelete: \"cascade\" }).notNull(),\n  metricDate: timestamp(\"metric_date\").notNull(),\n  kpiName: text(\"kpi_name\").notNull(), // voter_reach, engagement_rate, conversion_rate, sentiment_score, poll_position\n  kpiValue: decimal(\"kpi_value\", { precision: 15, scale: 4 }).notNull(),\n  targetValue: decimal(\"target_value\", { precision: 15, scale: 4 }),\n  unit: text(\"unit\"), // percentage, number, currency\n  source: text(\"source\"), // manual, ai_analysis, survey, social_media\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"metric_campaign_idx\").on(table.campaignId),\n  index(\"metric_date_idx\").on(table.metricDate),\n  index(\"metric_kpi_idx\").on(table.kpiName),\n]);\n\nexport const insertCampaignMetricSchema = createInsertSchema(campaignMetrics).omit({ id: true, createdAt: true });\nexport type InsertCampaignMetric = z.infer<typeof insertCampaignMetricSchema>;\nexport type CampaignMetric = typeof campaignMetrics.$inferSelect;\n\n// Campaign Activities - Action items and events\nexport const campaignActivities = pgTable(\"campaign_activities\", {\n  id: serial(\"id\").primaryKey(),\n  campaignId: integer(\"campaign_id\").references(() => campaigns.id, { onDelete: \"cascade\" }).notNull(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  type: text(\"type\").notNull(), // event, meeting, action, milestone\n  scheduledDate: timestamp(\"scheduled_date\"),\n  completedDate: timestamp(\"completed_date\"),\n  status: text(\"status\").notNull().default(\"pending\"), // pending, in_progress, completed, cancelled\n  priority: text(\"priority\").notNull().default(\"medium\"), // low, medium, high, critical\n  assignedTo: text(\"assigned_to\"),\n  budgetId: integer(\"budget_id\").references(() => campaignBudgets.id),\n  estimatedCost: decimal(\"estimated_cost\", { precision: 12, scale: 2 }),\n  actualCost: decimal(\"actual_cost\", { precision: 12, scale: 2 }),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"activity_campaign_idx\").on(table.campaignId),\n  index(\"activity_status_idx\").on(table.status),\n  index(\"activity_date_idx\").on(table.scheduledDate),\n  index(\"activity_type_idx\").on(table.type),\n]);\n\nexport const insertCampaignActivitySchema = createInsertSchema(campaignActivities).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertCampaignActivity = z.infer<typeof insertCampaignActivitySchema>;\nexport type CampaignActivity = typeof campaignActivities.$inferSelect;\n\n// Relations for Campaign Management\nexport const campaignsRelations = relations(campaigns, ({ one, many }) => ({\n  party: one(parties, { fields: [campaigns.targetPartyId], references: [parties.id] }),\n  candidate: one(candidates, { fields: [campaigns.targetCandidateId], references: [candidates.id] }),\n  aiSession: one(campaignInsightSessions, { fields: [campaigns.aiSessionId], references: [campaignInsightSessions.id] }),\n  createdByUser: one(users, { fields: [campaigns.createdBy], references: [users.id] }),\n  budgets: many(campaignBudgets),\n  resources: many(campaignResources),\n  metrics: many(campaignMetrics),\n  activities: many(campaignActivities),\n  teamMembers: many(campaignTeamMembers),\n  kpiGoals: many(aiKpiGoals),\n  notifications: many(campaignNotifications),\n}));\n\nexport const campaignBudgetsRelations = relations(campaignBudgets, ({ one, many }) => ({\n  campaign: one(campaigns, { fields: [campaignBudgets.campaignId], references: [campaigns.id] }),\n  activities: many(campaignActivities),\n}));\n\nexport const campaignResourcesRelations = relations(campaignResources, ({ one }) => ({\n  campaign: one(campaigns, { fields: [campaignResources.campaignId], references: [campaigns.id] }),\n}));\n\nexport const campaignMetricsRelations = relations(campaignMetrics, ({ one }) => ({\n  campaign: one(campaigns, { fields: [campaignMetrics.campaignId], references: [campaigns.id] }),\n}));\n\nexport const campaignActivitiesRelations = relations(campaignActivities, ({ one, many }) => ({\n  campaign: one(campaigns, { fields: [campaignActivities.campaignId], references: [campaigns.id] }),\n  budget: one(campaignBudgets, { fields: [campaignActivities.budgetId], references: [campaignBudgets.id] }),\n  createdByUser: one(users, { fields: [campaignActivities.createdBy], references: [users.id] }),\n  assignees: many(activityAssignees),\n}));\n\n// Campaign Team Members - linking users to campaigns with roles\nexport const campaignTeamMembers = pgTable(\"campaign_team_members\", {\n  id: serial(\"id\").primaryKey(),\n  campaignId: integer(\"campaign_id\").references(() => campaigns.id, { onDelete: \"cascade\" }).notNull(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  role: text(\"role\").notNull().default(\"member\"), // coordinator, manager, member, volunteer\n  permissions: text(\"permissions\").array().default([]), // view, edit, manage_budget, manage_team\n  joinedAt: timestamp(\"joined_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  leftAt: timestamp(\"left_at\"),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"team_member_campaign_idx\").on(table.campaignId),\n  index(\"team_member_user_idx\").on(table.userId),\n  index(\"team_member_active_idx\").on(table.isActive),\n]);\n\nexport const insertCampaignTeamMemberSchema = createInsertSchema(campaignTeamMembers).omit({ id: true, createdAt: true });\nexport type InsertCampaignTeamMember = z.infer<typeof insertCampaignTeamMemberSchema>;\nexport type CampaignTeamMember = typeof campaignTeamMembers.$inferSelect;\n\n// Activity Assignees - many-to-many relationship between activities and team members\nexport const activityAssignees = pgTable(\"activity_assignees\", {\n  id: serial(\"id\").primaryKey(),\n  activityId: integer(\"activity_id\").references(() => campaignActivities.id, { onDelete: \"cascade\" }).notNull(),\n  teamMemberId: integer(\"team_member_id\").references(() => campaignTeamMembers.id, { onDelete: \"cascade\" }).notNull(),\n  assignedAt: timestamp(\"assigned_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  assignedBy: varchar(\"assigned_by\").references(() => users.id),\n  completedAt: timestamp(\"completed_at\"),\n  notes: text(\"notes\"),\n}, (table) => [\n  index(\"assignee_activity_idx\").on(table.activityId),\n  index(\"assignee_member_idx\").on(table.teamMemberId),\n]);\n\nexport const insertActivityAssigneeSchema = createInsertSchema(activityAssignees).omit({ id: true });\nexport type InsertActivityAssignee = z.infer<typeof insertActivityAssigneeSchema>;\nexport type ActivityAssignee = typeof activityAssignees.$inferSelect;\n\n// AI KPI Goals - KPI goals linked to AI sessions for tracking\nexport const aiKpiGoals = pgTable(\"ai_kpi_goals\", {\n  id: serial(\"id\").primaryKey(),\n  campaignId: integer(\"campaign_id\").references(() => campaigns.id, { onDelete: \"cascade\" }).notNull(),\n  aiSessionId: integer(\"ai_session_id\").references(() => campaignInsightSessions.id, { onDelete: \"set null\" }),\n  kpiName: text(\"kpi_name\").notNull(), // voter_reach, engagement_rate, conversion_rate, sentiment_score, poll_position\n  targetValue: decimal(\"target_value\", { precision: 15, scale: 4 }).notNull(),\n  baselineValue: decimal(\"baseline_value\", { precision: 15, scale: 4 }),\n  predictedValue: decimal(\"predicted_value\", { precision: 15, scale: 4 }), // AI predicted value\n  currentValue: decimal(\"current_value\", { precision: 15, scale: 4 }),\n  unit: text(\"unit\"), // percentage, number, currency\n  startDate: timestamp(\"start_date\"),\n  endDate: timestamp(\"end_date\"),\n  trackingWindow: text(\"tracking_window\").default(\"weekly\"), // daily, weekly, monthly\n  status: text(\"status\").notNull().default(\"active\"), // active, achieved, missed, cancelled\n  priority: text(\"priority\").notNull().default(\"medium\"), // low, medium, high, critical\n  aiRecommendation: text(\"ai_recommendation\"), // AI-generated recommendation for achieving this goal\n  aiConfidence: decimal(\"ai_confidence\", { precision: 5, scale: 2 }), // AI confidence in prediction (0-100)\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"kpi_goal_campaign_idx\").on(table.campaignId),\n  index(\"kpi_goal_session_idx\").on(table.aiSessionId),\n  index(\"kpi_goal_status_idx\").on(table.status),\n  index(\"kpi_goal_name_idx\").on(table.kpiName),\n]);\n\nexport const insertAiKpiGoalSchema = createInsertSchema(aiKpiGoals).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertAiKpiGoal = z.infer<typeof insertAiKpiGoalSchema>;\nexport type AiKpiGoal = typeof aiKpiGoals.$inferSelect;\n\n// Campaign Notifications Queue - for tracking pending notifications\nexport const campaignNotifications = pgTable(\"campaign_notifications\", {\n  id: serial(\"id\").primaryKey(),\n  campaignId: integer(\"campaign_id\").references(() => campaigns.id, { onDelete: \"cascade\" }).notNull(),\n  type: text(\"type\").notNull(), // status_change, task_assigned, task_completed, deadline_reminder, kpi_alert\n  recipientUserId: varchar(\"recipient_user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  title: text(\"title\").notNull(),\n  message: text(\"message\").notNull(),\n  severity: text(\"severity\").default(\"info\"), // info, warning, error, critical\n  relatedActivityId: integer(\"related_activity_id\").references(() => campaignActivities.id, { onDelete: \"set null\" }),\n  relatedKpiGoalId: integer(\"related_kpi_goal_id\").references(() => aiKpiGoals.id, { onDelete: \"set null\" }),\n  scheduledFor: timestamp(\"scheduled_for\"), // for deadline reminders\n  sentAt: timestamp(\"sent_at\"),\n  inAppNotificationId: integer(\"in_app_notification_id\").references(() => inAppNotifications.id),\n  emailSent: boolean(\"email_sent\").default(false),\n  metadata: jsonb(\"metadata\").default({}),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n}, (table) => [\n  index(\"campaign_notif_campaign_idx\").on(table.campaignId),\n  index(\"campaign_notif_recipient_idx\").on(table.recipientUserId),\n  index(\"campaign_notif_type_idx\").on(table.type),\n  index(\"campaign_notif_scheduled_idx\").on(table.scheduledFor),\n]);\n\nexport const insertCampaignNotificationSchema = createInsertSchema(campaignNotifications).omit({ id: true, createdAt: true });\nexport type InsertCampaignNotification = z.infer<typeof insertCampaignNotificationSchema>;\nexport type CampaignNotification = typeof campaignNotifications.$inferSelect;\n\n// Relations for new campaign tables\nexport const campaignTeamMembersRelations = relations(campaignTeamMembers, ({ one, many }) => ({\n  campaign: one(campaigns, { fields: [campaignTeamMembers.campaignId], references: [campaigns.id] }),\n  user: one(users, { fields: [campaignTeamMembers.userId], references: [users.id] }),\n  assignments: many(activityAssignees),\n}));\n\nexport const activityAssigneesRelations = relations(activityAssignees, ({ one }) => ({\n  activity: one(campaignActivities, { fields: [activityAssignees.activityId], references: [campaignActivities.id] }),\n  teamMember: one(campaignTeamMembers, { fields: [activityAssignees.teamMemberId], references: [campaignTeamMembers.id] }),\n  assignedByUser: one(users, { fields: [activityAssignees.assignedBy], references: [users.id] }),\n}));\n\nexport const aiKpiGoalsRelations = relations(aiKpiGoals, ({ one }) => ({\n  campaign: one(campaigns, { fields: [aiKpiGoals.campaignId], references: [campaigns.id] }),\n  aiSession: one(campaignInsightSessions, { fields: [aiKpiGoals.aiSessionId], references: [campaignInsightSessions.id] }),\n}));\n\nexport const campaignNotificationsRelations = relations(campaignNotifications, ({ one }) => ({\n  campaign: one(campaigns, { fields: [campaignNotifications.campaignId], references: [campaigns.id] }),\n  recipient: one(users, { fields: [campaignNotifications.recipientUserId], references: [users.id] }),\n  activity: one(campaignActivities, { fields: [campaignNotifications.relatedActivityId], references: [campaignActivities.id] }),\n  kpiGoal: one(aiKpiGoals, { fields: [campaignNotifications.relatedKpiGoalId], references: [aiKpiGoals.id] }),\n  inAppNotification: one(inAppNotifications, { fields: [campaignNotifications.inAppNotificationId], references: [inAppNotifications.id] }),\n}));\n","path":null,"size_bytes":109611,"size_tokens":null},"server/session-config.ts":{"content":"import session from \"express-session\";\n// @ts-ignore - memorystore doesn't have types\nimport MemoryStore from \"memorystore\";\n\nconst MemoryStoreSession = MemoryStore(session);\n\nexport const sessionStore = new MemoryStoreSession({\n  checkPeriod: 86400000\n}) as session.Store;\n\nexport function getSessionConfig(sessionSecret: string | undefined): session.SessionOptions {\n  return {\n    store: sessionStore,\n    secret: sessionSecret || \"dev-only-secret-do-not-use-in-production\",\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      secure: process.env.NODE_ENV === \"production\",\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV === \"production\" ? \"lax\" as const : \"lax\" as const,\n      maxAge: 24 * 60 * 60 * 1000,\n    },\n  };\n}\n","path":null,"size_bytes":754,"size_tokens":null},"client/src/pages/candidates.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Plus, Edit, Trash2, Users, Search, Database, Loader2, ChevronLeft, ChevronRight, Eye, X, Tag, Filter, SortAsc, SortDesc } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport type { Candidate, Party, InsertCandidate } from \"@shared/schema\";\n\ntype TseCandidate = {\n  nmCandidato: string | null;\n  nmUrnaCandidato: string | null;\n  nrCandidato: number | null;\n  sgPartido: string | null;\n  nmPartido: string | null;\n  nrPartido: number | null;\n  anoEleicao: number | null;\n  sgUf: string | null;\n  dsCargo: string | null;\n  qtVotosNominais: number | null;\n};\n\ntype CandidateWithParty = Candidate & { party?: Party };\n\ntype PaginatedResponse = {\n  data: CandidateWithParty[];\n  total: number;\n  page: number;\n  limit: number;\n  totalPages: number;\n};\n\ntype CandidateDetails = Candidate & {\n  party?: Party;\n  totalVotes: number;\n  scenarioParticipations: { scenarioId: number; scenarioName: string; votes: number; elected: boolean }[];\n  historicalPerformance: { year: number; votes: number; position: string; result: string }[];\n};\n\nexport default function Candidates() {\n  const { hasPermission } = useAuth();\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingCandidate, setEditingCandidate] = useState<Candidate | null>(null);\n  const [deleteConfirmId, setDeleteConfirmId] = useState<number | null>(null);\n  const [detailsId, setDetailsId] = useState<number | null>(null);\n\n  // Pagination and filtering state\n  const [page, setPage] = useState(1);\n  const [limit] = useState(10);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [debouncedSearch, setDebouncedSearch] = useState(\"\");\n  const [partyFilter, setPartyFilter] = useState<string>(\"all\");\n  const [positionFilter, setPositionFilter] = useState<string>(\"all\");\n  const [activeFilter, setActiveFilter] = useState<string>(\"all\");\n  const [sortBy, setSortBy] = useState<string>(\"name\");\n  const [sortOrder, setSortOrder] = useState<\"asc\" | \"desc\">(\"asc\");\n  const [showFilters, setShowFilters] = useState(false);\n\n  const [tseSearchQuery, setTseSearchQuery] = useState(\"\");\n  const [tseSearchResults, setTseSearchResults] = useState<TseCandidate[]>([]);\n  const [isTseSearching, setIsTseSearching] = useState(false);\n  const [showTseResults, setShowTseResults] = useState(false);\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    nickname: \"\",\n    number: \"\",\n    partyId: \"\",\n    position: \"vereador\",\n    biography: \"\",\n    notes: \"\",\n    tags: [] as string[],\n  });\n  const [tagInput, setTagInput] = useState(\"\");\n\n  // Debounce search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedSearch(searchQuery);\n      setPage(1);\n    }, 300);\n    return () => clearTimeout(timer);\n  }, [searchQuery]);\n\n  // Build query params and URL\n  const buildQueryUrl = () => {\n    const params = new URLSearchParams({\n      page: String(page),\n      limit: String(limit),\n      sortBy,\n      sortOrder,\n    });\n    if (debouncedSearch) params.set(\"search\", debouncedSearch);\n    if (partyFilter && partyFilter !== \"all\") params.set(\"partyId\", partyFilter);\n    if (positionFilter && positionFilter !== \"all\") params.set(\"position\", positionFilter);\n    if (activeFilter && activeFilter !== \"all\") params.set(\"active\", activeFilter);\n    return `/api/candidates/paginated?${params.toString()}`;\n  };\n\n  const paginatedUrl = buildQueryUrl();\n\n  const { data: paginatedData, isLoading } = useQuery<PaginatedResponse>({\n    queryKey: [paginatedUrl],\n  });\n\n  const { data: parties } = useQuery<Party[]>({\n    queryKey: [\"/api/parties\"],\n  });\n\n  const { data: candidateDetails, isLoading: isLoadingDetails } = useQuery<CandidateDetails>({\n    queryKey: [`/api/candidates/${detailsId}/details`],\n    enabled: detailsId !== null,\n  });\n\n  const invalidateCandidatesQueries = () => {\n    queryClient.invalidateQueries({ \n      predicate: (query) => {\n        const key = query.queryKey[0];\n        return typeof key === 'string' && (key.startsWith('/api/candidates') || key === '/api/stats');\n      }\n    });\n  };\n\n  const createMutation = useMutation({\n    mutationFn: async (data: InsertCandidate) => {\n      return apiRequest(\"POST\", \"/api/candidates\", data);\n    },\n    onSuccess: () => {\n      invalidateCandidatesQueries();\n      toast({ title: \"Sucesso\", description: \"Candidato cadastrado com sucesso\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao cadastrar candidato\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: Partial<InsertCandidate> }) => {\n      return apiRequest(\"PATCH\", `/api/candidates/${id}`, data);\n    },\n    onSuccess: () => {\n      invalidateCandidatesQueries();\n      toast({ title: \"Sucesso\", description: \"Candidato atualizado\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar candidato\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/candidates/${id}`);\n    },\n    onSuccess: () => {\n      invalidateCandidatesQueries();\n      toast({ title: \"Sucesso\", description: \"Candidato excluído\" });\n      setDeleteConfirmId(null);\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao excluir candidato\", variant: \"destructive\" });\n    },\n  });\n\n  const searchTseCandidates = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setTseSearchResults([]);\n      setShowTseResults(false);\n      return;\n    }\n    setIsTseSearching(true);\n    try {\n      const res = await fetch(`/api/tse/search?q=${encodeURIComponent(query)}`);\n      if (res.ok) {\n        const results = await res.json();\n        setTseSearchResults(results);\n        setShowTseResults(true);\n      }\n    } catch (error) {\n      console.error(\"TSE search error:\", error);\n    } finally {\n      setIsTseSearching(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    const debounce = setTimeout(() => {\n      if (tseSearchQuery.length >= 2) {\n        searchTseCandidates(tseSearchQuery);\n      } else {\n        setTseSearchResults([]);\n        setShowTseResults(false);\n      }\n    }, 300);\n    return () => clearTimeout(debounce);\n  }, [tseSearchQuery, searchTseCandidates]);\n\n  function selectTseCandidate(tse: TseCandidate) {\n    const matchingParty = parties?.find(\n      (p) => p.abbreviation === tse.sgPartido || p.number === tse.nrPartido\n    );\n    setFormData({\n      name: tse.nmCandidato || \"\",\n      nickname: tse.nmUrnaCandidato || \"\",\n      number: tse.nrCandidato?.toString() || \"\",\n      partyId: matchingParty ? String(matchingParty.id) : \"\",\n      position: \"vereador\",\n      biography: \"\",\n      notes: \"\",\n      tags: [],\n    });\n    setShowTseResults(false);\n    setTseSearchQuery(\"\");\n    toast({\n      title: \"Dados importados\",\n      description: `Candidato ${tse.nmUrnaCandidato || tse.nmCandidato} selecionado dos dados do TSE`,\n    });\n  }\n\n  function resetForm() {\n    setFormData({\n      name: \"\",\n      nickname: \"\",\n      number: \"\",\n      partyId: \"\",\n      position: \"vereador\",\n      biography: \"\",\n      notes: \"\",\n      tags: [],\n    });\n    setEditingCandidate(null);\n    setIsDialogOpen(false);\n    setTseSearchQuery(\"\");\n    setTseSearchResults([]);\n    setShowTseResults(false);\n    setTagInput(\"\");\n  }\n\n  function handleEdit(candidate: CandidateWithParty) {\n    setEditingCandidate(candidate);\n    setFormData({\n      name: candidate.name,\n      nickname: candidate.nickname || \"\",\n      number: String(candidate.number),\n      partyId: String(candidate.partyId),\n      position: candidate.position,\n      biography: candidate.biography || \"\",\n      notes: candidate.notes || \"\",\n      tags: candidate.tags || [],\n    });\n    setIsDialogOpen(true);\n  }\n\n  function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    const payload = {\n      name: formData.name,\n      nickname: formData.nickname || null,\n      number: parseInt(formData.number, 10),\n      partyId: parseInt(formData.partyId, 10),\n      position: formData.position,\n      biography: formData.biography || null,\n      notes: formData.notes || null,\n      tags: formData.tags.length > 0 ? formData.tags : null,\n    };\n\n    if (editingCandidate) {\n      updateMutation.mutate({ id: editingCandidate.id, data: payload });\n    } else {\n      createMutation.mutate(payload as InsertCandidate);\n    }\n  }\n\n  function addTag() {\n    const tag = tagInput.trim();\n    if (tag && !formData.tags.includes(tag)) {\n      setFormData((f) => ({ ...f, tags: [...f.tags, tag] }));\n      setTagInput(\"\");\n    }\n  }\n\n  function removeTag(tag: string) {\n    setFormData((f) => ({ ...f, tags: f.tags.filter((t) => t !== tag) }));\n  }\n\n  function clearFilters() {\n    setSearchQuery(\"\");\n    setPartyFilter(\"all\");\n    setPositionFilter(\"all\");\n    setActiveFilter(\"all\");\n    setSortBy(\"name\");\n    setSortOrder(\"asc\");\n    setPage(1);\n  }\n\n  const hasActiveFilters = debouncedSearch || partyFilter !== \"all\" || positionFilter !== \"all\" || activeFilter !== \"all\";\n\n  const positions = [\n    { value: \"vereador\", label: \"Vereador\" },\n    { value: \"deputado_estadual\", label: \"Deputado Estadual\" },\n    { value: \"deputado_federal\", label: \"Deputado Federal\" },\n  ];\n\n  const candidates = paginatedData?.data || [];\n  const totalPages = paginatedData?.totalPages || 1;\n  const total = paginatedData?.total || 0;\n\n  return (\n    <div className=\"space-y-6\">\n      <PageHeader\n        title=\"Candidatos\"\n        description=\"Gerencie os candidatos vinculados aos partidos políticos\"\n        breadcrumbs={[\n          { label: \"Dashboard\", href: \"/\" },\n          { label: \"Candidatos\" },\n        ]}\n        action={\n          hasPermission(\"manage_candidates\")\n            ? {\n                label: \"Novo Candidato\",\n                icon: <Plus className=\"h-4 w-4 mr-2\" />,\n                onClick: () => setIsDialogOpen(true),\n              }\n            : undefined\n        }\n      />\n\n      <Card>\n        <CardContent className=\"p-6\">\n          {/* Search and Filters */}\n          <div className=\"space-y-4 mb-6\">\n            <div className=\"flex flex-col sm:flex-row gap-3\">\n              <div className=\"relative flex-1\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Buscar por nome ou apelido...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9\"\n                  data-testid=\"input-search-candidates\"\n                />\n              </div>\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowFilters(!showFilters)}\n                className=\"shrink-0\"\n                data-testid=\"button-toggle-filters\"\n              >\n                <Filter className=\"h-4 w-4 mr-2\" />\n                Filtros\n                {hasActiveFilters && (\n                  <Badge variant=\"secondary\" className=\"ml-2\">\n                    {[debouncedSearch, partyFilter !== \"all\", positionFilter !== \"all\", activeFilter !== \"all\"].filter(Boolean).length}\n                  </Badge>\n                )}\n              </Button>\n            </div>\n\n            {showFilters && (\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 p-4 bg-muted/50 rounded-lg\">\n                <div className=\"space-y-1.5\">\n                  <Label className=\"text-xs\">Partido</Label>\n                  <Select value={partyFilter} onValueChange={setPartyFilter}>\n                    <SelectTrigger data-testid=\"select-filter-party\">\n                      <SelectValue placeholder=\"Todos\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">Todos</SelectItem>\n                      {parties?.map((party) => (\n                        <SelectItem key={party.id} value={String(party.id)}>\n                          <div className=\"flex items-center gap-2\">\n                            <div\n                              className=\"w-2 h-2 rounded-full shrink-0\"\n                              style={{ backgroundColor: party.color }}\n                            />\n                            {party.abbreviation}\n                          </div>\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-1.5\">\n                  <Label className=\"text-xs\">Cargo</Label>\n                  <Select value={positionFilter} onValueChange={setPositionFilter}>\n                    <SelectTrigger data-testid=\"select-filter-position\">\n                      <SelectValue placeholder=\"Todos\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">Todos</SelectItem>\n                      {positions.map((pos) => (\n                        <SelectItem key={pos.value} value={pos.value}>\n                          {pos.label}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-1.5\">\n                  <Label className=\"text-xs\">Status</Label>\n                  <Select value={activeFilter} onValueChange={setActiveFilter}>\n                    <SelectTrigger data-testid=\"select-filter-status\">\n                      <SelectValue placeholder=\"Todos\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">Todos</SelectItem>\n                      <SelectItem value=\"true\">Ativo</SelectItem>\n                      <SelectItem value=\"false\">Inativo</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-1.5\">\n                  <Label className=\"text-xs\">Ordenar por</Label>\n                  <div className=\"flex gap-1\">\n                    <Select value={sortBy} onValueChange={setSortBy}>\n                      <SelectTrigger className=\"flex-1\" data-testid=\"select-sort-by\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"name\">Nome</SelectItem>\n                        <SelectItem value=\"number\">Número</SelectItem>\n                        <SelectItem value=\"position\">Cargo</SelectItem>\n                        <SelectItem value=\"createdAt\">Data Cadastro</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <Button\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => setSortOrder(sortOrder === \"asc\" ? \"desc\" : \"asc\")}\n                      data-testid=\"button-toggle-sort-order\"\n                    >\n                      {sortOrder === \"asc\" ? <SortAsc className=\"h-4 w-4\" /> : <SortDesc className=\"h-4 w-4\" />}\n                    </Button>\n                  </div>\n                </div>\n\n                {hasActiveFilters && (\n                  <div className=\"sm:col-span-2 lg:col-span-4 flex justify-end\">\n                    <Button variant=\"ghost\" size=\"sm\" onClick={clearFilters} data-testid=\"button-clear-filters\">\n                      <X className=\"h-4 w-4 mr-1\" />\n                      Limpar Filtros\n                    </Button>\n                  </div>\n                )}\n              </div>\n            )}\n          </div>\n\n          {/* Results info */}\n          {!isLoading && total > 0 && (\n            <div className=\"text-sm text-muted-foreground mb-4\">\n              Mostrando {((page - 1) * limit) + 1}-{Math.min(page * limit, total)} de {total} candidato{total !== 1 ? \"s\" : \"\"}\n            </div>\n          )}\n\n          {/* Table */}\n          {isLoading ? (\n            <div className=\"space-y-3\">\n              {[...Array(5)].map((_, i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : candidates.length === 0 ? (\n            <EmptyState\n              icon={Users}\n              title={hasActiveFilters ? \"Nenhum candidato encontrado\" : \"Nenhum candidato cadastrado\"}\n              description={hasActiveFilters ? \"Tente ajustar os filtros de busca\" : \"Cadastre candidatos para incluí-los nas simulações eleitorais\"}\n              actionLabel={!hasActiveFilters && hasPermission(\"manage_candidates\") ? \"Cadastrar Candidato\" : undefined}\n              onAction={!hasActiveFilters && hasPermission(\"manage_candidates\") ? () => setIsDialogOpen(true) : undefined}\n            />\n          ) : (\n            <div className=\"border rounded-md overflow-hidden\">\n              <table className=\"w-full\">\n                <thead className=\"bg-muted/50\">\n                  <tr>\n                    <th className=\"text-left p-3 font-medium text-sm w-20\">Número</th>\n                    <th className=\"text-left p-3 font-medium text-sm\">Candidato</th>\n                    <th className=\"text-left p-3 font-medium text-sm\">Partido</th>\n                    <th className=\"text-left p-3 font-medium text-sm\">Cargo</th>\n                    <th className=\"text-left p-3 font-medium text-sm\">Status</th>\n                    <th className=\"text-left p-3 font-medium text-sm\">Tags</th>\n                    <th className=\"text-right p-3 font-medium text-sm w-32\">Ações</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {candidates.map((candidate) => (\n                    <tr key={candidate.id} className=\"border-t hover-elevate\" data-testid={`row-candidate-${candidate.id}`}>\n                      <td className=\"p-3\">\n                        <span className=\"font-mono font-bold text-lg\">{candidate.number}</span>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"flex items-center gap-3\">\n                          <Avatar className=\"h-9 w-9\">\n                            <AvatarFallback className=\"bg-primary/10 text-primary text-sm\">\n                              {candidate.name.split(\" \").map((n) => n[0]).join(\"\").slice(0, 2).toUpperCase()}\n                            </AvatarFallback>\n                          </Avatar>\n                          <div className=\"flex flex-col\">\n                            <span className=\"font-medium\">{candidate.nickname || candidate.name}</span>\n                            {candidate.nickname && (\n                              <span className=\"text-sm text-muted-foreground\">{candidate.name}</span>\n                            )}\n                          </div>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        {candidate.party ? (\n                          <div className=\"flex items-center gap-2\">\n                            <div\n                              className=\"w-3 h-3 rounded-full shrink-0\"\n                              style={{ backgroundColor: candidate.party.color }}\n                            />\n                            <Badge variant=\"outline\">{candidate.party.abbreviation}</Badge>\n                          </div>\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </td>\n                      <td className=\"p-3\">\n                        <span>{positions.find((p) => p.value === candidate.position)?.label || candidate.position}</span>\n                      </td>\n                      <td className=\"p-3\">\n                        <Badge variant={candidate.active ? \"default\" : \"secondary\"}>\n                          {candidate.active ? \"Ativo\" : \"Inativo\"}\n                        </Badge>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"flex flex-wrap gap-1\">\n                          {candidate.tags?.slice(0, 2).map((tag) => (\n                            <Badge key={tag} variant=\"outline\" className=\"text-xs\">\n                              {tag}\n                            </Badge>\n                          ))}\n                          {(candidate.tags?.length || 0) > 2 && (\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              +{(candidate.tags?.length || 0) - 2}\n                            </Badge>\n                          )}\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"flex items-center justify-end gap-1\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => setDetailsId(candidate.id)}\n                            data-testid={`button-view-candidate-${candidate.id}`}\n                          >\n                            <Eye className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleEdit(candidate)}\n                            disabled={!hasPermission(\"manage_candidates\")}\n                            data-testid={`button-edit-candidate-${candidate.id}`}\n                          >\n                            <Edit className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => setDeleteConfirmId(candidate.id)}\n                            disabled={!hasPermission(\"manage_candidates\")}\n                            data-testid={`button-delete-candidate-${candidate.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          )}\n\n          {/* Pagination */}\n          {totalPages > 1 && (\n            <div className=\"flex items-center justify-between mt-4\">\n              <div className=\"text-sm text-muted-foreground\">\n                Página {page} de {totalPages}\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setPage((p) => Math.max(1, p - 1))}\n                  disabled={page === 1}\n                  data-testid=\"button-prev-page\"\n                >\n                  <ChevronLeft className=\"h-4 w-4 mr-1\" />\n                  Anterior\n                </Button>\n                <div className=\"flex items-center gap-1\">\n                  {[...Array(Math.min(5, totalPages))].map((_, i) => {\n                    let pageNum: number;\n                    if (totalPages <= 5) {\n                      pageNum = i + 1;\n                    } else if (page <= 3) {\n                      pageNum = i + 1;\n                    } else if (page >= totalPages - 2) {\n                      pageNum = totalPages - 4 + i;\n                    } else {\n                      pageNum = page - 2 + i;\n                    }\n                    return (\n                      <Button\n                        key={pageNum}\n                        variant={page === pageNum ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        className=\"w-8 h-8 p-0\"\n                        onClick={() => setPage(pageNum)}\n                        data-testid={`button-page-${pageNum}`}\n                      >\n                        {pageNum}\n                      </Button>\n                    );\n                  })}\n                </div>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setPage((p) => Math.min(totalPages, p + 1))}\n                  disabled={page === totalPages}\n                  data-testid=\"button-next-page\"\n                >\n                  Próximo\n                  <ChevronRight className=\"h-4 w-4 ml-1\" />\n                </Button>\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Create/Edit Dialog */}\n      <Dialog open={isDialogOpen} onOpenChange={(open) => !open && resetForm()}>\n        <DialogContent className=\"sm:max-w-lg max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>{editingCandidate ? \"Editar Candidato\" : \"Novo Candidato\"}</DialogTitle>\n            <DialogDescription>\n              {editingCandidate ? \"Atualize as informações do candidato\" : \"Preencha os dados do novo candidato\"}\n            </DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            {!editingCandidate && (\n              <div className=\"space-y-2\">\n                <Label className=\"flex items-center gap-2\">\n                  <Database className=\"h-4 w-4\" />\n                  Buscar nos Dados do TSE\n                </Label>\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Digite o nome do candidato para buscar...\"\n                    value={tseSearchQuery}\n                    onChange={(e) => setTseSearchQuery(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-tse-search\"\n                  />\n                  {isTseSearching && (\n                    <Loader2 className=\"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground\" />\n                  )}\n                </div>\n                {showTseResults && tseSearchResults.length > 0 && (\n                  <Card className=\"border shadow-md\">\n                    <ScrollArea className=\"max-h-48\">\n                      <div className=\"p-1\">\n                        {tseSearchResults.map((tse, idx) => (\n                          <button\n                            key={`${tse.nrCandidato}-${tse.anoEleicao}-${idx}`}\n                            type=\"button\"\n                            onClick={() => selectTseCandidate(tse)}\n                            className=\"w-full text-left p-2 rounded-md hover-elevate flex flex-col gap-1\"\n                            data-testid={`tse-result-${idx}`}\n                          >\n                            <div className=\"flex items-center justify-between gap-2\">\n                              <span className=\"font-medium text-sm\">\n                                {tse.nmUrnaCandidato || tse.nmCandidato}\n                              </span>\n                              <Badge variant=\"outline\" className=\"text-xs shrink-0\">\n                                {tse.nrCandidato}\n                              </Badge>\n                            </div>\n                            <div className=\"flex items-center gap-2 text-xs text-muted-foreground flex-wrap\">\n                              <span>{tse.sgPartido}</span>\n                              <span>-</span>\n                              <span>{tse.dsCargo}</span>\n                              <span>-</span>\n                              <span>{tse.sgUf} {tse.anoEleicao}</span>\n                              {tse.qtVotosNominais && (\n                                <>\n                                  <span>-</span>\n                                  <span>{tse.qtVotosNominais.toLocaleString(\"pt-BR\")} votos</span>\n                                </>\n                              )}\n                            </div>\n                          </button>\n                        ))}\n                      </div>\n                    </ScrollArea>\n                  </Card>\n                )}\n                {showTseResults && tseSearchResults.length === 0 && tseSearchQuery.length >= 2 && !isTseSearching && (\n                  <p className=\"text-sm text-muted-foreground\">\n                    Nenhum candidato encontrado nos dados importados do TSE.\n                  </p>\n                )}\n              </div>\n            )}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Nome Completo</Label>\n              <Input\n                id=\"name\"\n                placeholder=\"Ex: João da Silva\"\n                value={formData.name}\n                onChange={(e) => setFormData((f) => ({ ...f, name: e.target.value }))}\n                required\n                data-testid=\"input-candidate-name\"\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"nickname\">Nome de Urna</Label>\n                <Input\n                  id=\"nickname\"\n                  placeholder=\"Ex: João Silva\"\n                  value={formData.nickname}\n                  onChange={(e) => setFormData((f) => ({ ...f, nickname: e.target.value }))}\n                  data-testid=\"input-candidate-nickname\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"number\">Número</Label>\n                <Input\n                  id=\"number\"\n                  type=\"number\"\n                  placeholder=\"Ex: 13123\"\n                  value={formData.number}\n                  onChange={(e) => setFormData((f) => ({ ...f, number: e.target.value }))}\n                  required\n                  className=\"font-mono\"\n                  data-testid=\"input-candidate-number\"\n                />\n              </div>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"partyId\">Partido</Label>\n                <Select\n                  value={formData.partyId}\n                  onValueChange={(v) => setFormData((f) => ({ ...f, partyId: v }))}\n                >\n                  <SelectTrigger data-testid=\"select-candidate-party\">\n                    <SelectValue placeholder=\"Selecione\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {parties?.map((party) => (\n                      <SelectItem key={party.id} value={String(party.id)}>\n                        <div className=\"flex items-center gap-2\">\n                          <div\n                            className=\"w-2 h-2 rounded-full\"\n                            style={{ backgroundColor: party.color }}\n                          />\n                          {party.abbreviation} - {party.name}\n                        </div>\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"position\">Cargo</Label>\n                <Select\n                  value={formData.position}\n                  onValueChange={(v) => setFormData((f) => ({ ...f, position: v }))}\n                >\n                  <SelectTrigger data-testid=\"select-candidate-position\">\n                    <SelectValue placeholder=\"Selecione\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {positions.map((pos) => (\n                      <SelectItem key={pos.value} value={pos.value}>\n                        {pos.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"biography\">Biografia</Label>\n              <Textarea\n                id=\"biography\"\n                placeholder=\"Breve descrição do candidato (opcional)\"\n                value={formData.biography}\n                onChange={(e) => setFormData((f) => ({ ...f, biography: e.target.value }))}\n                rows={3}\n                data-testid=\"input-candidate-biography\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"notes\">Notas Internas</Label>\n              <Textarea\n                id=\"notes\"\n                placeholder=\"Notas internas sobre o candidato (não visível publicamente)\"\n                value={formData.notes}\n                onChange={(e) => setFormData((f) => ({ ...f, notes: e.target.value }))}\n                rows={2}\n                data-testid=\"input-candidate-notes\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Tags</Label>\n              <div className=\"flex gap-2\">\n                <Input\n                  placeholder=\"Adicionar tag...\"\n                  value={tagInput}\n                  onChange={(e) => setTagInput(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === \"Enter\") {\n                      e.preventDefault();\n                      addTag();\n                    }\n                  }}\n                  data-testid=\"input-candidate-tag\"\n                />\n                <Button type=\"button\" variant=\"outline\" onClick={addTag} data-testid=\"button-add-tag\">\n                  <Tag className=\"h-4 w-4\" />\n                </Button>\n              </div>\n              {formData.tags.length > 0 && (\n                <div className=\"flex flex-wrap gap-1 mt-2\">\n                  {formData.tags.map((tag) => (\n                    <Badge key={tag} variant=\"secondary\" className=\"cursor-pointer\" onClick={() => removeTag(tag)}>\n                      {tag}\n                      <X className=\"h-3 w-3 ml-1\" />\n                    </Badge>\n                  ))}\n                </div>\n              )}\n            </div>\n            <DialogFooter>\n              <Button type=\"button\" variant=\"outline\" onClick={resetForm}>\n                Cancelar\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-save-candidate\"\n              >\n                {editingCandidate ? \"Salvar\" : \"Cadastrar\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Details Dialog */}\n      <Dialog open={detailsId !== null} onOpenChange={(open) => !open && setDetailsId(null)}>\n        <DialogContent className=\"sm:max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Detalhes do Candidato</DialogTitle>\n            <DialogDescription>\n              Informações detalhadas e histórico de desempenho\n            </DialogDescription>\n          </DialogHeader>\n          {isLoadingDetails ? (\n            <div className=\"space-y-4\">\n              <Skeleton className=\"h-20 w-full\" />\n              <Skeleton className=\"h-40 w-full\" />\n            </div>\n          ) : candidateDetails ? (\n            <div className=\"space-y-6\">\n              <div className=\"flex items-start gap-4\">\n                <Avatar className=\"h-16 w-16\">\n                  <AvatarFallback className=\"bg-primary/10 text-primary text-xl\">\n                    {candidateDetails.name.split(\" \").map((n) => n[0]).join(\"\").slice(0, 2).toUpperCase()}\n                  </AvatarFallback>\n                </Avatar>\n                <div className=\"flex-1\">\n                  <h3 className=\"text-xl font-semibold\">{candidateDetails.nickname || candidateDetails.name}</h3>\n                  {candidateDetails.nickname && (\n                    <p className=\"text-muted-foreground\">{candidateDetails.name}</p>\n                  )}\n                  <div className=\"flex items-center gap-3 mt-2 flex-wrap\">\n                    <Badge variant=\"outline\" className=\"font-mono\">{candidateDetails.number}</Badge>\n                    {candidateDetails.party && (\n                      <div className=\"flex items-center gap-1\">\n                        <div\n                          className=\"w-3 h-3 rounded-full\"\n                          style={{ backgroundColor: candidateDetails.party.color }}\n                        />\n                        <Badge variant=\"outline\">{candidateDetails.party.abbreviation}</Badge>\n                      </div>\n                    )}\n                    <Badge>{positions.find((p) => p.value === candidateDetails.position)?.label}</Badge>\n                    <Badge variant={candidateDetails.active ? \"default\" : \"secondary\"}>\n                      {candidateDetails.active ? \"Ativo\" : \"Inativo\"}\n                    </Badge>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total de Votos (TSE)</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-2xl font-bold\">{candidateDetails.totalVotes.toLocaleString(\"pt-BR\")}</p>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium text-muted-foreground\">Participações em Cenários</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-2xl font-bold\">{candidateDetails.scenarioParticipations.length}</p>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {candidateDetails.biography && (\n                <div>\n                  <h4 className=\"font-medium mb-2\">Biografia</h4>\n                  <p className=\"text-sm text-muted-foreground\">{candidateDetails.biography}</p>\n                </div>\n              )}\n\n              {candidateDetails.notes && (\n                <div>\n                  <h4 className=\"font-medium mb-2\">Notas Internas</h4>\n                  <p className=\"text-sm text-muted-foreground\">{candidateDetails.notes}</p>\n                </div>\n              )}\n\n              {candidateDetails.tags && candidateDetails.tags.length > 0 && (\n                <div>\n                  <h4 className=\"font-medium mb-2\">Tags</h4>\n                  <div className=\"flex flex-wrap gap-1\">\n                    {candidateDetails.tags.map((tag) => (\n                      <Badge key={tag} variant=\"outline\">{tag}</Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {candidateDetails.historicalPerformance.length > 0 && (\n                <div>\n                  <h4 className=\"font-medium mb-2\">Histórico Eleitoral (TSE)</h4>\n                  <div className=\"border rounded-md overflow-hidden\">\n                    <table className=\"w-full text-sm\">\n                      <thead className=\"bg-muted/50\">\n                        <tr>\n                          <th className=\"text-left p-2\">Ano</th>\n                          <th className=\"text-left p-2\">Cargo</th>\n                          <th className=\"text-right p-2\">Votos</th>\n                          <th className=\"text-left p-2\">Resultado</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {candidateDetails.historicalPerformance.map((h, i) => (\n                          <tr key={i} className=\"border-t\">\n                            <td className=\"p-2 font-mono\">{h.year}</td>\n                            <td className=\"p-2\">{h.position}</td>\n                            <td className=\"p-2 text-right font-mono\">{h.votes.toLocaleString(\"pt-BR\")}</td>\n                            <td className=\"p-2\">\n                              <Badge variant={h.result === \"ELEITO\" ? \"default\" : \"outline\"}>\n                                {h.result}\n                              </Badge>\n                            </td>\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              )}\n\n              {candidateDetails.scenarioParticipations.length > 0 && (\n                <div>\n                  <h4 className=\"font-medium mb-2\">Cenários de Simulação</h4>\n                  <div className=\"border rounded-md overflow-hidden\">\n                    <table className=\"w-full text-sm\">\n                      <thead className=\"bg-muted/50\">\n                        <tr>\n                          <th className=\"text-left p-2\">Cenário</th>\n                          <th className=\"text-right p-2\">Votos</th>\n                          <th className=\"text-left p-2\">Status</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {candidateDetails.scenarioParticipations.map((s) => (\n                          <tr key={s.scenarioId} className=\"border-t\">\n                            <td className=\"p-2\">{s.scenarioName}</td>\n                            <td className=\"p-2 text-right font-mono\">{s.votes.toLocaleString(\"pt-BR\")}</td>\n                            <td className=\"p-2\">\n                              <Badge variant={s.elected ? \"default\" : \"secondary\"}>\n                                {s.elected ? \"Eleito\" : \"Não Eleito\"}\n                              </Badge>\n                            </td>\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              )}\n            </div>\n          ) : null}\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={deleteConfirmId !== null} onOpenChange={() => setDeleteConfirmId(null)}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Confirmar Exclusão</DialogTitle>\n            <DialogDescription>\n              Tem certeza que deseja excluir este candidato? Esta ação não pode ser desfeita.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeleteConfirmId(null)}>\n              Cancelar\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deleteConfirmId && deleteMutation.mutate(deleteConfirmId)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete-candidate\"\n            >\n              Excluir\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":44287,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, Vote } from \"lucide-react\";\n\nexport default function Login() {\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const { login } = useAuth();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    if (!username || !password) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Por favor, preencha todos os campos\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsLoading(true);\n    try {\n      const success = await login(username, password);\n      if (success) {\n        toast({\n          title: \"Bem-vindo!\",\n          description: \"Login realizado com sucesso\",\n        });\n        setLocation(\"/\");\n      } else {\n        toast({\n          title: \"Erro no login\",\n          description: \"Usuário ou senha inválidos\",\n          variant: \"destructive\",\n        });\n      }\n    } finally {\n      setIsLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/5 via-background to-accent/5 p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center space-y-4\">\n          <div className=\"flex justify-center\">\n            <div className=\"w-16 h-16 rounded-lg bg-primary flex items-center justify-center\">\n              <Vote className=\"h-8 w-8 text-primary-foreground\" />\n            </div>\n          </div>\n          <div>\n            <CardTitle className=\"text-2xl font-bold\">SimulaVoto</CardTitle>\n            <CardDescription className=\"mt-2\">\n              Sistema de Simulação Eleitoral Proporcional Brasileiro\n            </CardDescription>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"username\">Usuário</Label>\n              <Input\n                id=\"username\"\n                placeholder=\"Digite seu usuário\"\n                value={username}\n                onChange={(e) => setUsername(e.target.value)}\n                disabled={isLoading}\n                data-testid=\"input-username\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\">Senha</Label>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                placeholder=\"Digite sua senha\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                disabled={isLoading}\n                data-testid=\"input-password\"\n              />\n            </div>\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              disabled={isLoading}\n              data-testid=\"button-login\"\n            >\n              {isLoading ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Entrando...\n                </>\n              ) : (\n                \"Entrar\"\n              )}\n            </Button>\n          </form>\n          <p className=\"text-center text-sm text-muted-foreground mt-6\">\n            Inspirado no sistema do TSE - Tribunal Superior Eleitoral\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":3854,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/lib/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect, useState, type ReactNode } from \"react\";\n\ntype Theme = \"light\" | \"dark\";\n\ntype ThemeContextType = {\n  theme: Theme;\n  toggleTheme: () => void;\n  setTheme: (theme: Theme) => void;\n};\n\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\n\nexport function ThemeProvider({ children }: { children: ReactNode }) {\n  const [theme, setThemeState] = useState<Theme>(() => {\n    if (typeof window !== \"undefined\") {\n      const stored = localStorage.getItem(\"theme\") as Theme;\n      if (stored) return stored;\n      return window.matchMedia(\"(prefers-color-scheme: dark)\").matches ? \"dark\" : \"light\";\n    }\n    return \"light\";\n  });\n\n  useEffect(() => {\n    const root = document.documentElement;\n    root.classList.remove(\"light\", \"dark\");\n    root.classList.add(theme);\n    localStorage.setItem(\"theme\", theme);\n  }, [theme]);\n\n  function toggleTheme() {\n    setThemeState((prev) => (prev === \"light\" ? \"dark\" : \"light\"));\n  }\n\n  function setTheme(newTheme: Theme) {\n    setThemeState(newTheme);\n  }\n\n  return (\n    <ThemeContext.Provider value={{ theme, toggleTheme, setTheme }}>\n      {children}\n    </ThemeContext.Provider>\n  );\n}\n\nexport function useTheme() {\n  const context = useContext(ThemeContext);\n  if (!context) {\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":1382,"size_tokens":null},"client/src/pages/forecasts.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Label } from \"@/components/ui/label\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { \n  TrendingUp, \n  TrendingDown,\n  Target,\n  Map,\n  AlertTriangle,\n  Activity,\n  BarChart3,\n  Plus,\n  RefreshCw,\n  Clock,\n  CheckCircle,\n  XCircle,\n  Loader2,\n  Eye,\n  Trash2,\n  Calendar,\n  MapPin,\n  Percent,\n  ArrowUp,\n  ArrowDown,\n  Minus,\n  Info\n} from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip as RechartsTooltip,\n  ResponsiveContainer,\n  AreaChart,\n  Area,\n  LineChart,\n  Line,\n  ErrorBar,\n  ComposedChart,\n  Legend,\n} from \"recharts\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nconst CHART_COLORS = [\"#003366\", \"#FFD700\", \"#1E90FF\", \"#32CD32\", \"#FF6347\", \"#9370DB\", \"#20B2AA\", \"#FF69B4\"];\n\nconst BRAZIL_STATES: Record<string, string> = {\n  AC: \"Acre\", AL: \"Alagoas\", AP: \"Amapá\", AM: \"Amazonas\", BA: \"Bahia\",\n  CE: \"Ceará\", DF: \"Distrito Federal\", ES: \"Espírito Santo\", GO: \"Goiás\",\n  MA: \"Maranhão\", MT: \"Mato Grosso\", MS: \"Mato Grosso do Sul\", MG: \"Minas Gerais\",\n  PA: \"Pará\", PB: \"Paraíba\", PR: \"Paraná\", PE: \"Pernambuco\", PI: \"Piauí\",\n  RJ: \"Rio de Janeiro\", RN: \"Rio Grande do Norte\", RS: \"Rio Grande do Sul\",\n  RO: \"Rondônia\", RR: \"Roraima\", SC: \"Santa Catarina\", SP: \"São Paulo\",\n  SE: \"Sergipe\", TO: \"Tocantins\"\n};\n\nconst POSITIONS = [\n  { value: \"DEPUTADO FEDERAL\", label: \"Deputado Federal\" },\n  { value: \"DEPUTADO ESTADUAL\", label: \"Deputado Estadual\" },\n  { value: \"SENADOR\", label: \"Senador\" },\n  { value: \"GOVERNADOR\", label: \"Governador\" },\n  { value: \"PRESIDENTE\", label: \"Presidente\" },\n  { value: \"VEREADOR\", label: \"Vereador\" },\n  { value: \"PREFEITO\", label: \"Prefeito\" },\n];\n\ninterface ForecastRun {\n  id: number;\n  name: string;\n  description?: string;\n  targetYear: number;\n  targetPosition?: string;\n  targetState?: string;\n  targetElectionType?: string;\n  historicalYearsUsed?: number[];\n  status: string;\n  totalSimulations?: number;\n  createdAt: string;\n  startedAt?: string;\n  completedAt?: string;\n}\n\ninterface ForecastResult {\n  id: number;\n  runId: number;\n  resultType: string;\n  entityName: string;\n  predictedVoteShare?: string;\n  voteShareLower?: string;\n  voteShareUpper?: string;\n  predictedVotes?: number;\n  votesLower?: number;\n  votesUpper?: number;\n  predictedSeats?: number;\n  seatsLower?: number;\n  seatsUpper?: number;\n  trendDirection?: string;\n  trendStrength?: string;\n  confidence?: string;\n  historicalTrend?: { years: number[]; voteShares: number[] };\n  influenceFactors?: { factor: string; weight: number; impact: string }[];\n}\n\ninterface SwingRegion {\n  id: number;\n  runId: number;\n  region: string;\n  regionName: string;\n  position?: string;\n  marginPercent?: string;\n  marginVotes?: number;\n  volatilityScore?: string;\n  swingMagnitude?: string;\n  leadingEntity?: string;\n  challengingEntity?: string;\n  outcomeUncertainty?: string;\n  keyFactors?: { factor: string; impact: string }[];\n}\n\ninterface ForecastSummary {\n  run: ForecastRun;\n  topParties: ForecastResult[];\n  swingRegions: SwingRegion[];\n  narrative?: string;\n}\n\nexport default function ForecastsPage() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"list\");\n  const [selectedForecast, setSelectedForecast] = useState<number | null>(null);\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [newForecast, setNewForecast] = useState({\n    name: \"\",\n    description: \"\",\n    targetYear: new Date().getFullYear() + 2,\n    targetPosition: \"\",\n    targetState: \"\",\n    targetElectionType: \"\",\n  });\n\n  const { data: forecasts, isLoading: forecastsLoading, refetch: refetchForecasts } = useQuery<ForecastRun[]>({\n    queryKey: [\"/api/forecasts\"],\n    refetchInterval: 5000,\n  });\n\n  const { data: forecastSummary, isLoading: summaryLoading } = useQuery<ForecastSummary>({\n    queryKey: [\"/api/forecasts\", selectedForecast],\n    enabled: !!selectedForecast,\n  });\n\n  const createForecastMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/forecasts\", newForecast);\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Previsão criada\",\n        description: \"A previsão está sendo processada. Isso pode levar alguns minutos.\",\n      });\n      setIsCreateDialogOpen(false);\n      setNewForecast({\n        name: \"\",\n        description: \"\",\n        targetYear: new Date().getFullYear() + 2,\n        targetPosition: \"\",\n        targetState: \"\",\n        targetElectionType: \"\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/forecasts\"] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao criar previsão\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteForecastMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/forecasts/${id}`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Previsão excluída\",\n        description: \"A previsão foi removida com sucesso.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/forecasts\"] });\n      if (selectedForecast) {\n        setSelectedForecast(null);\n      }\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao excluir previsão\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"completed\":\n        return <Badge className=\"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\"><CheckCircle className=\"w-3 h-3 mr-1\" />Concluída</Badge>;\n      case \"running\":\n        return <Badge className=\"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400\"><Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />Em Execução</Badge>;\n      case \"failed\":\n        return <Badge className=\"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400\"><XCircle className=\"w-3 h-3 mr-1\" />Falhou</Badge>;\n      default:\n        return <Badge className=\"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400\"><Clock className=\"w-3 h-3 mr-1\" />Pendente</Badge>;\n    }\n  };\n\n  const getTrendIcon = (direction?: string) => {\n    switch (direction) {\n      case \"rising\":\n        return <ArrowUp className=\"w-4 h-4 text-green-500\" />;\n      case \"falling\":\n        return <ArrowDown className=\"w-4 h-4 text-red-500\" />;\n      default:\n        return <Minus className=\"w-4 h-4 text-gray-500\" />;\n    }\n  };\n\n  const renderForecastsList = () => {\n    if (forecastsLoading) {\n      return (\n        <div className=\"space-y-4\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i}>\n              <CardHeader>\n                <Skeleton className=\"h-6 w-48\" />\n                <Skeleton className=\"h-4 w-32\" />\n              </CardHeader>\n              <CardContent>\n                <Skeleton className=\"h-4 w-full\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      );\n    }\n\n    if (!forecasts || forecasts.length === 0) {\n      return (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <Target className=\"w-12 h-12 mx-auto text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">Nenhuma previsão encontrada</h3>\n            <p className=\"text-muted-foreground mb-4\">\n              Crie sua primeira previsão eleitoral usando dados históricos e simulações Monte Carlo.\n            </p>\n            <Button onClick={() => setIsCreateDialogOpen(true)} data-testid=\"button-create-first-forecast\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Criar Primeira Previsão\n            </Button>\n          </CardContent>\n        </Card>\n      );\n    }\n\n    return (\n      <div className=\"space-y-4\">\n        {forecasts.map((forecast) => (\n          <Card key={forecast.id} className=\"hover-elevate cursor-pointer\" onClick={() => {\n            setSelectedForecast(forecast.id);\n            setActiveTab(\"details\");\n          }} data-testid={`card-forecast-${forecast.id}`}>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <div>\n                <CardTitle className=\"text-lg\">{forecast.name}</CardTitle>\n                <CardDescription>\n                  {forecast.description || `Previsão para ${forecast.targetYear}`}\n                </CardDescription>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                {getStatusBadge(forecast.status)}\n                {user?.role === \"admin\" && (\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      deleteForecastMutation.mutate(forecast.id);\n                    }}\n                    data-testid={`button-delete-forecast-${forecast.id}`}\n                  >\n                    <Trash2 className=\"w-4 h-4 text-destructive\" />\n                  </Button>\n                )}\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex flex-wrap gap-4 text-sm text-muted-foreground\">\n                <div className=\"flex items-center gap-1\">\n                  <Calendar className=\"w-4 h-4\" />\n                  <span>Ano alvo: {forecast.targetYear}</span>\n                </div>\n                {forecast.targetPosition && (\n                  <div className=\"flex items-center gap-1\">\n                    <Target className=\"w-4 h-4\" />\n                    <span>{forecast.targetPosition}</span>\n                  </div>\n                )}\n                {forecast.targetState && (\n                  <div className=\"flex items-center gap-1\">\n                    <MapPin className=\"w-4 h-4\" />\n                    <span>{BRAZIL_STATES[forecast.targetState] || forecast.targetState}</span>\n                  </div>\n                )}\n                {forecast.totalSimulations && forecast.totalSimulations > 0 && (\n                  <div className=\"flex items-center gap-1\">\n                    <Activity className=\"w-4 h-4\" />\n                    <span>{forecast.totalSimulations.toLocaleString(\"pt-BR\")} simulações</span>\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    );\n  };\n\n  const renderForecastDetails = () => {\n    if (!selectedForecast) {\n      return (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <Eye className=\"w-12 h-12 mx-auto text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">Selecione uma previsão</h3>\n            <p className=\"text-muted-foreground\">\n              Clique em uma previsão na lista para ver os detalhes.\n            </p>\n          </CardContent>\n        </Card>\n      );\n    }\n\n    if (summaryLoading) {\n      return (\n        <div className=\"space-y-4\">\n          <Skeleton className=\"h-8 w-64\" />\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <Skeleton className=\"h-32\" />\n            <Skeleton className=\"h-32\" />\n            <Skeleton className=\"h-32\" />\n          </div>\n          <Skeleton className=\"h-64\" />\n        </div>\n      );\n    }\n\n    if (!forecastSummary) {\n      return (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <XCircle className=\"w-12 h-12 mx-auto text-destructive mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">Previsão não encontrada</h3>\n          </CardContent>\n        </Card>\n      );\n    }\n\n    const { run, topParties, swingRegions } = forecastSummary;\n\n    const partyChartData = topParties.slice(0, 10).map((party, index) => ({\n      name: party.entityName,\n      voteShare: parseFloat(party.predictedVoteShare || \"0\"),\n      lower: parseFloat(party.voteShareLower || \"0\"),\n      upper: parseFloat(party.voteShareUpper || \"0\"),\n      fill: CHART_COLORS[index % CHART_COLORS.length],\n    }));\n\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h2 className=\"text-2xl font-bold\">{run.name}</h2>\n            <p className=\"text-muted-foreground\">{run.description}</p>\n          </div>\n          {getStatusBadge(run.status)}\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">Ano Alvo</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{run.targetYear}</div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">Simulações</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{(run.totalSimulations || 0).toLocaleString(\"pt-BR\")}</div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">Partidos Analisados</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{topParties.length}</div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">Regiões Voláteis</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{swingRegions.length}</div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {run.status === \"running\" && (\n          <Card className=\"border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-900/20\">\n            <CardContent className=\"py-4\">\n              <div className=\"flex items-center gap-3\">\n                <Loader2 className=\"w-5 h-5 animate-spin text-blue-600\" />\n                <span className=\"text-blue-700 dark:text-blue-400\">\n                  Previsão em execução. Os resultados serão atualizados automaticamente.\n                </span>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {run.status === \"completed\" && topParties.length > 0 && (\n          <>\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <BarChart3 className=\"w-5 h-5\" />\n                  Previsão por Partido\n                </CardTitle>\n                <CardDescription>\n                  Projeções independentes por partido com intervalos de confiança de 95%. \n                  Os valores são estimativas individuais e não somam 100%.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-80\">\n                  <ResponsiveContainer width=\"100%\" height=\"100%\">\n                    <ComposedChart data={partyChartData} layout=\"vertical\">\n                      <CartesianGrid strokeDasharray=\"3 3\" />\n                      <XAxis type=\"number\" domain={[0, 'auto']} unit=\"%\" />\n                      <YAxis dataKey=\"name\" type=\"category\" width={80} />\n                      <RechartsTooltip\n                        formatter={(value: number, name: string) => {\n                          if (name === \"voteShare\") return [`${value.toFixed(2)}%`, \"Previsão\"];\n                          return [value, name];\n                        }}\n                        content={({ active, payload }) => {\n                          if (active && payload && payload.length) {\n                            const data = payload[0].payload;\n                            return (\n                              <div className=\"bg-background border rounded-lg shadow-lg p-3\">\n                                <p className=\"font-semibold\">{data.name}</p>\n                                <p className=\"text-sm\">Previsão: {data.voteShare.toFixed(2)}%</p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  IC 95%: {data.lower.toFixed(2)}% - {data.upper.toFixed(2)}%\n                                </p>\n                              </div>\n                            );\n                          }\n                          return null;\n                        }}\n                      />\n                      <Bar dataKey=\"voteShare\" fill=\"#003366\" radius={[0, 4, 4, 0]} />\n                    </ComposedChart>\n                  </ResponsiveContainer>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <TrendingUp className=\"w-5 h-5\" />\n                  Detalhes por Partido\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <ScrollArea className=\"h-96\">\n                  <div className=\"space-y-3\">\n                    {topParties.map((party, index) => (\n                      <Card key={party.id} className=\"bg-muted/30\">\n                        <CardContent className=\"py-4\">\n                          <div className=\"flex items-center justify-between mb-2\">\n                            <div className=\"flex items-center gap-2\">\n                              <div \n                                className=\"w-3 h-3 rounded-full\" \n                                style={{ backgroundColor: CHART_COLORS[index % CHART_COLORS.length] }}\n                              />\n                              <span className=\"font-semibold\">{party.entityName}</span>\n                              {getTrendIcon(party.trendDirection)}\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              <Badge variant=\"outline\">\n                                Confiança: {(parseFloat(party.confidence || \"0\") * 100).toFixed(0)}%\n                              </Badge>\n                            </div>\n                          </div>\n                          <div className=\"grid grid-cols-3 gap-4 text-sm\">\n                            <div>\n                              <p className=\"text-muted-foreground\">Previsão</p>\n                              <p className=\"font-semibold text-lg\">\n                                {parseFloat(party.predictedVoteShare || \"0\").toFixed(2)}%\n                              </p>\n                            </div>\n                            <div>\n                              <p className=\"text-muted-foreground\">IC 95% Inferior</p>\n                              <p className=\"font-medium\">\n                                {parseFloat(party.voteShareLower || \"0\").toFixed(2)}%\n                              </p>\n                            </div>\n                            <div>\n                              <p className=\"text-muted-foreground\">IC 95% Superior</p>\n                              <p className=\"font-medium\">\n                                {parseFloat(party.voteShareUpper || \"0\").toFixed(2)}%\n                              </p>\n                            </div>\n                          </div>\n                          {party.influenceFactors && (\n                            <div className=\"mt-3 flex flex-wrap gap-2\">\n                              {(party.influenceFactors as { factor: string; impact: string }[]).map((f, i) => (\n                                <Badge key={i} variant=\"secondary\" className=\"text-xs\">\n                                  {f.factor}: {f.impact}\n                                </Badge>\n                              ))}\n                            </div>\n                          )}\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                </ScrollArea>\n              </CardContent>\n            </Card>\n          </>\n        )}\n\n        {run.status === \"completed\" && swingRegions.length > 0 && (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Map className=\"w-5 h-5\" />\n                Regiões Voláteis (Swing Regions)\n              </CardTitle>\n              <CardDescription>\n                Regiões com resultados incertos onde pequenas mudanças podem alterar o resultado\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {swingRegions.map((region) => (\n                  <Card key={region.id} className=\"border-amber-200 bg-amber-50 dark:border-amber-800 dark:bg-amber-900/20\">\n                    <CardContent className=\"py-4\">\n                      <div className=\"flex items-center justify-between mb-2\">\n                        <div className=\"flex items-center gap-2\">\n                          <AlertTriangle className=\"w-4 h-4 text-amber-600\" />\n                          <span className=\"font-semibold\">{region.regionName}</span>\n                        </div>\n                        <Badge variant=\"outline\" className=\"border-amber-600 text-amber-700\">\n                          Volatilidade: {parseFloat(region.volatilityScore || \"0\").toFixed(1)}\n                        </Badge>\n                      </div>\n                      <div className=\"space-y-2 text-sm\">\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-muted-foreground\">Margem atual:</span>\n                          <span className=\"font-medium\">{parseFloat(region.marginPercent || \"0\").toFixed(2)}%</span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-muted-foreground\">Líder:</span>\n                          <span className=\"font-medium\">{region.leadingEntity}</span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-muted-foreground\">Desafiante:</span>\n                          <span className=\"font-medium\">{region.challengingEntity}</span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-muted-foreground\">Incerteza:</span>\n                          <Progress \n                            value={parseFloat(region.outcomeUncertainty || \"0\") * 100} \n                            className=\"w-24 h-2\"\n                          />\n                        </div>\n                      </div>\n                      {region.keyFactors && (\n                        <div className=\"mt-3 flex flex-wrap gap-1\">\n                          {(region.keyFactors as { factor: string; impact: string }[]).map((f, i) => (\n                            <Badge key={i} variant=\"secondary\" className=\"text-xs\">\n                              {f.factor}\n                            </Badge>\n                          ))}\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"container mx-auto py-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Previsões Eleitorais</h1>\n          <p className=\"text-muted-foreground\">\n            Modelos preditivos com simulações Monte Carlo e análise de tendências históricas\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={() => refetchForecasts()} data-testid=\"button-refresh-forecasts\">\n            <RefreshCw className=\"w-4 h-4 mr-2\" />\n            Atualizar\n          </Button>\n          <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-create-forecast\">\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Nova Previsão\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-md\">\n              <DialogHeader>\n                <DialogTitle>Criar Nova Previsão</DialogTitle>\n                <DialogDescription>\n                  Configure os parâmetros para gerar uma previsão eleitoral baseada em dados históricos.\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"name\">Nome da Previsão</Label>\n                  <Input\n                    id=\"name\"\n                    placeholder=\"Ex: Eleições 2026 - Deputado Federal\"\n                    value={newForecast.name}\n                    onChange={(e) => setNewForecast({ ...newForecast, name: e.target.value })}\n                    data-testid=\"input-forecast-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"description\">Descrição (opcional)</Label>\n                  <Textarea\n                    id=\"description\"\n                    placeholder=\"Descreva o objetivo desta previsão...\"\n                    value={newForecast.description}\n                    onChange={(e) => setNewForecast({ ...newForecast, description: e.target.value })}\n                    data-testid=\"input-forecast-description\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"targetYear\">Ano Alvo</Label>\n                  <Input\n                    id=\"targetYear\"\n                    type=\"number\"\n                    min={2024}\n                    max={2050}\n                    value={newForecast.targetYear}\n                    onChange={(e) => setNewForecast({ ...newForecast, targetYear: parseInt(e.target.value) })}\n                    data-testid=\"input-forecast-year\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"targetPosition\">Cargo (opcional)</Label>\n                  <Select\n                    value={newForecast.targetPosition || \"_all\"}\n                    onValueChange={(value) => setNewForecast({ ...newForecast, targetPosition: value === \"_all\" ? \"\" : value })}\n                  >\n                    <SelectTrigger data-testid=\"select-forecast-position\">\n                      <SelectValue placeholder=\"Todos os cargos\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"_all\">Todos os cargos</SelectItem>\n                      {POSITIONS.map((pos) => (\n                        <SelectItem key={pos.value} value={pos.value}>{pos.label}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"targetState\">Estado (opcional)</Label>\n                  <Select\n                    value={newForecast.targetState || \"_all\"}\n                    onValueChange={(value) => setNewForecast({ ...newForecast, targetState: value === \"_all\" ? \"\" : value })}\n                  >\n                    <SelectTrigger data-testid=\"select-forecast-state\">\n                      <SelectValue placeholder=\"Nacional (todos os estados)\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"_all\">Nacional</SelectItem>\n                      {Object.entries(BRAZIL_STATES).map(([code, name]) => (\n                        <SelectItem key={code} value={code}>{name}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n              <div className=\"flex justify-end gap-2\">\n                <Button variant=\"outline\" onClick={() => setIsCreateDialogOpen(false)} data-testid=\"button-cancel-forecast\">\n                  Cancelar\n                </Button>\n                <Button \n                  onClick={() => createForecastMutation.mutate()}\n                  disabled={!newForecast.name || createForecastMutation.isPending}\n                  data-testid=\"button-submit-forecast\"\n                >\n                  {createForecastMutation.isPending && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n                  Criar Previsão\n                </Button>\n              </div>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </div>\n\n      <div className=\"flex items-center gap-2 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800\">\n        <Info className=\"w-5 h-5 text-blue-600\" />\n        <p className=\"text-sm text-blue-700 dark:text-blue-400\">\n          As previsões utilizam dados históricos importados do TSE para identificar tendências e calcular intervalos de confiança \n          através de simulações Monte Carlo. Importe dados de múltiplos anos eleitorais para obter previsões mais precisas.\n        </p>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList>\n          <TabsTrigger value=\"list\" data-testid=\"tab-forecasts-list\">\n            <BarChart3 className=\"w-4 h-4 mr-2\" />\n            Lista de Previsões\n          </TabsTrigger>\n          <TabsTrigger value=\"details\" data-testid=\"tab-forecasts-details\">\n            <Target className=\"w-4 h-4 mr-2\" />\n            Detalhes\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"list\" className=\"mt-4\">\n          {renderForecastsList()}\n        </TabsContent>\n\n        <TabsContent value=\"details\" className=\"mt-4\">\n          {renderForecastDetails()}\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":31232,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/hooks/use-import-websocket.ts":{"content":"import { useEffect, useRef, useCallback, useState } from \"react\";\nimport { queryClient } from \"@/lib/queryClient\";\n\nexport interface ImportEvent {\n  type: string;\n  jobId: number;\n  data: Record<string, unknown>;\n}\n\nexport interface ImportWebSocketState {\n  connected: boolean;\n  lastEvent: ImportEvent | null;\n  events: ImportEvent[];\n}\n\nexport function useImportWebSocket(enabled: boolean = true) {\n  const wsRef = useRef<WebSocket | null>(null);\n  const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout>>();\n  const [state, setState] = useState<ImportWebSocketState>({\n    connected: false,\n    lastEvent: null,\n    events: [],\n  });\n\n  const connect = useCallback(() => {\n    if (!enabled || wsRef.current?.readyState === WebSocket.OPEN) return;\n\n    const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n    const wsUrl = `${protocol}//${window.location.host}/ws/imports`;\n\n    try {\n      const ws = new WebSocket(wsUrl);\n      wsRef.current = ws;\n\n      ws.onopen = () => {\n        console.log(\"Import WebSocket connected\");\n        setState(prev => ({ ...prev, connected: true }));\n      };\n\n      ws.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data) as ImportEvent;\n          \n          setState(prev => ({\n            ...prev,\n            lastEvent: data,\n            events: [...prev.events.slice(-99), data],\n          }));\n\n          // Invalidate queries based on event type for real-time updates\n          switch (data.type) {\n            case \"import.job.status\":\n            case \"import.job.completed\":\n            case \"import.job.failed\":\n            case \"import.job.progress\":\n              queryClient.invalidateQueries({ queryKey: [\"/api/imports/tse\"] });\n              break;\n              \n            case \"import.batch.status\":\n            case \"import.batch.error\":\n              queryClient.invalidateQueries({ \n                queryKey: [\"/api/imports/tse\", data.jobId, \"batches\"] \n              });\n              // Also refresh main job list for overall progress\n              queryClient.invalidateQueries({ queryKey: [\"/api/imports/tse\"] });\n              break;\n          }\n        } catch (e) {\n          console.error(\"Failed to parse WebSocket message:\", e);\n        }\n      };\n\n      ws.onclose = () => {\n        console.log(\"Import WebSocket disconnected\");\n        setState(prev => ({ ...prev, connected: false }));\n        \n        if (enabled) {\n          reconnectTimeoutRef.current = setTimeout(connect, 3000);\n        }\n      };\n\n      ws.onerror = (error) => {\n        console.error(\"WebSocket error:\", error);\n      };\n    } catch (error) {\n      console.error(\"Failed to create WebSocket:\", error);\n    }\n  }, [enabled]);\n\n  const disconnect = useCallback(() => {\n    if (reconnectTimeoutRef.current) {\n      clearTimeout(reconnectTimeoutRef.current);\n    }\n    if (wsRef.current) {\n      wsRef.current.close();\n      wsRef.current = null;\n    }\n    setState(prev => ({ ...prev, connected: false }));\n  }, []);\n\n  useEffect(() => {\n    if (enabled) {\n      connect();\n    } else {\n      disconnect();\n    }\n\n    return () => {\n      disconnect();\n    };\n  }, [enabled, connect, disconnect]);\n\n  const sendPing = useCallback(() => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(JSON.stringify({ type: \"ping\" }));\n    }\n  }, []);\n\n  return {\n    ...state,\n    connect,\n    disconnect,\n    sendPing,\n  };\n}\n","path":null,"size_bytes":3453,"size_tokens":null},"client/src/pages/admin-settings.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { AlertTriangle, Database, Trash2, Shield, Users, FileText, BarChart3, Loader2, CheckCircle, XCircle } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Alert,\n  AlertDescription,\n  AlertTitle,\n} from \"@/components/ui/alert\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { queryClient } from \"@/lib/queryClient\";\n\ninterface DatabaseStats {\n  users: number;\n  parties: number;\n  candidates: number;\n  scenarios: number;\n  simulations: number;\n  importJobs: number;\n  candidateVotes: number;\n  forecasts: number;\n  auditLogs: number;\n}\n\nconst CONFIRMATION_PHRASE = \"CONFIRMO ZERAR BANCO DE DADOS\";\n\nexport default function AdminSettings() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [showResetDialog, setShowResetDialog] = useState(false);\n  const [showFinalConfirmation, setShowFinalConfirmation] = useState(false);\n  const [confirmationInput, setConfirmationInput] = useState(\"\");\n  const [preserveAdmin, setPreserveAdmin] = useState(true);\n\n  const { data: stats, isLoading: statsLoading, refetch: refetchStats } = useQuery<DatabaseStats>({\n    queryKey: [\"/api/admin/database-stats\"],\n  });\n\n  const resetDatabaseMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/admin/reset-database\", {\n        confirmationPhrase: CONFIRMATION_PHRASE,\n        preserveAdmin,\n      });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Banco de dados zerado\",\n        description: data.message,\n      });\n      setShowFinalConfirmation(false);\n      setShowResetDialog(false);\n      setConfirmationInput(\"\");\n      queryClient.invalidateQueries();\n      refetchStats();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro ao zerar banco de dados\",\n        description: error.message || \"Falha na operação\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const totalRecords = stats \n    ? stats.users + stats.parties + stats.candidates + stats.scenarios + \n      stats.simulations + stats.importJobs + stats.candidateVotes + \n      stats.forecasts + stats.auditLogs\n    : 0;\n\n  const handleFirstConfirmation = () => {\n    if (confirmationInput === CONFIRMATION_PHRASE) {\n      setShowFinalConfirmation(true);\n    } else {\n      toast({\n        title: \"Frase incorreta\",\n        description: \"A frase de confirmação não corresponde. Digite exatamente como indicado.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleFinalReset = () => {\n    resetDatabaseMutation.mutate();\n  };\n\n  if (user?.role !== \"admin\") {\n    return (\n      <div className=\"p-8\">\n        <Alert variant=\"destructive\">\n          <Shield className=\"h-4 w-4\" />\n          <AlertTitle>Acesso Negado</AlertTitle>\n          <AlertDescription>\n            Apenas administradores podem acessar esta página.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-4 md:p-8 space-y-6\">\n      <PageHeader\n        title=\"Configurações do Sistema\"\n        description=\"Gerenciamento administrativo e manutenção do banco de dados\"\n      />\n\n      <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <Users className=\"h-4 w-4\" />\n              Usuários\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-3xl font-bold\">{statsLoading ? \"-\" : stats?.users || 0}</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <FileText className=\"h-4 w-4\" />\n              Partidos\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-3xl font-bold\">{statsLoading ? \"-\" : stats?.parties || 0}</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <Users className=\"h-4 w-4\" />\n              Candidatos\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-3xl font-bold\">{statsLoading ? \"-\" : stats?.candidates || 0}</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <BarChart3 className=\"h-4 w-4\" />\n              Cenários\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-3xl font-bold\">{statsLoading ? \"-\" : stats?.scenarios || 0}</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <Database className=\"h-4 w-4\" />\n              Votos Importados\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-3xl font-bold\">{statsLoading ? \"-\" : (stats?.candidateVotes || 0).toLocaleString(\"pt-BR\")}</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <FileText className=\"h-4 w-4\" />\n              Importações\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-3xl font-bold\">{statsLoading ? \"-\" : stats?.importJobs || 0}</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card className=\"border-destructive/50\">\n        <CardHeader>\n          <CardTitle className=\"text-lg flex items-center gap-2 text-destructive\">\n            <AlertTriangle className=\"h-5 w-5\" />\n            Zona de Perigo\n          </CardTitle>\n          <CardDescription>\n            Operações críticas que afetam permanentemente o sistema\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <Alert variant=\"destructive\">\n            <AlertTriangle className=\"h-4 w-4\" />\n            <AlertTitle>Atenção!</AlertTitle>\n            <AlertDescription>\n              A operação de zerar o banco de dados é <strong>irreversível</strong>. \n              Todos os dados serão permanentemente apagados, incluindo usuários, partidos, \n              candidatos, cenários, simulações, importações do TSE e previsões.\n            </AlertDescription>\n          </Alert>\n\n          <div className=\"flex items-center justify-between p-4 rounded-lg bg-destructive/5 border border-destructive/20\">\n            <div>\n              <h4 className=\"font-medium\">Zerar Banco de Dados</h4>\n              <p className=\"text-sm text-muted-foreground\">\n                Remove todos os {totalRecords.toLocaleString(\"pt-BR\")} registros do sistema\n              </p>\n            </div>\n            <Button \n              variant=\"destructive\"\n              onClick={() => setShowResetDialog(true)}\n              data-testid=\"button-open-reset-dialog\"\n            >\n              <Trash2 className=\"h-4 w-4 mr-2\" />\n              Zerar Banco de Dados\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Dialog open={showResetDialog} onOpenChange={(open) => {\n        if (!open) {\n          setShowResetDialog(false);\n          setShowFinalConfirmation(false);\n          setConfirmationInput(\"\");\n        }\n      }}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-destructive\">\n              <AlertTriangle className=\"h-5 w-5\" />\n              Confirmar Exclusão de Dados\n            </DialogTitle>\n            <DialogDescription>\n              Esta ação é <strong>permanente e irreversível</strong>. Todos os dados serão apagados.\n            </DialogDescription>\n          </DialogHeader>\n\n          {!showFinalConfirmation ? (\n            <div className=\"space-y-4\">\n              <Alert variant=\"destructive\">\n                <XCircle className=\"h-4 w-4\" />\n                <AlertTitle>Você está prestes a apagar:</AlertTitle>\n                <AlertDescription>\n                  <ul className=\"list-disc list-inside mt-2 space-y-1\">\n                    <li>{stats?.users || 0} usuários</li>\n                    <li>{stats?.parties || 0} partidos</li>\n                    <li>{stats?.candidates || 0} candidatos</li>\n                    <li>{stats?.scenarios || 0} cenários</li>\n                    <li>{stats?.simulations || 0} simulações</li>\n                    <li>{stats?.importJobs || 0} importações do TSE</li>\n                    <li>{(stats?.candidateVotes || 0).toLocaleString(\"pt-BR\")} registros de votos</li>\n                    <li>{stats?.forecasts || 0} previsões</li>\n                    <li>{stats?.auditLogs || 0} logs de auditoria</li>\n                  </ul>\n                </AlertDescription>\n              </Alert>\n\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center space-x-2\">\n                  <Checkbox \n                    id=\"preserve-admin\" \n                    checked={preserveAdmin}\n                    onCheckedChange={(checked) => setPreserveAdmin(checked as boolean)}\n                    data-testid=\"checkbox-preserve-admin\"\n                  />\n                  <Label htmlFor=\"preserve-admin\" className=\"text-sm\">\n                    Manter meu usuário administrador após a exclusão\n                  </Label>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"confirmation-phrase\">\n                    Para confirmar, digite a frase abaixo:\n                  </Label>\n                  <p className=\"text-sm font-mono bg-muted p-2 rounded text-center select-all\">\n                    {CONFIRMATION_PHRASE}\n                  </p>\n                  <Input\n                    id=\"confirmation-phrase\"\n                    value={confirmationInput}\n                    onChange={(e) => setConfirmationInput(e.target.value)}\n                    placeholder=\"Digite a frase de confirmação\"\n                    className=\"font-mono\"\n                    data-testid=\"input-confirmation-phrase\"\n                  />\n                </div>\n              </div>\n\n              <DialogFooter className=\"gap-2\">\n                <Button variant=\"outline\" onClick={() => setShowResetDialog(false)}>\n                  Cancelar\n                </Button>\n                <Button \n                  variant=\"destructive\" \n                  onClick={handleFirstConfirmation}\n                  disabled={confirmationInput !== CONFIRMATION_PHRASE}\n                  data-testid=\"button-first-confirmation\"\n                >\n                  Continuar\n                </Button>\n              </DialogFooter>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              <Alert variant=\"destructive\" className=\"border-2\">\n                <AlertTriangle className=\"h-4 w-4\" />\n                <AlertTitle>ÚLTIMA CONFIRMAÇÃO</AlertTitle>\n                <AlertDescription className=\"font-medium\">\n                  Você tem certeza absoluta de que deseja apagar TODOS os dados do sistema?\n                  Esta ação NÃO pode ser desfeita.\n                </AlertDescription>\n              </Alert>\n\n              <div className=\"p-4 bg-destructive/10 rounded-lg border border-destructive/30 text-center\">\n                <p className=\"text-sm text-muted-foreground mb-2\">Serão apagados permanentemente:</p>\n                <p className=\"text-2xl font-bold text-destructive\">\n                  {totalRecords.toLocaleString(\"pt-BR\")} registros\n                </p>\n              </div>\n\n              <DialogFooter className=\"gap-2\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => setShowFinalConfirmation(false)}\n                >\n                  Voltar\n                </Button>\n                <Button \n                  variant=\"destructive\" \n                  onClick={handleFinalReset}\n                  disabled={resetDatabaseMutation.isPending}\n                  data-testid=\"button-final-reset\"\n                >\n                  {resetDatabaseMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Apagando...\n                    </>\n                  ) : (\n                    <>\n                      <Trash2 className=\"h-4 w-4 mr-2\" />\n                      SIM, APAGAR TUDO\n                    </>\n                  )}\n                </Button>\n              </DialogFooter>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":13594,"size_tokens":null},"client/src/lib/auth-context.tsx":{"content":"import { createContext, useContext, useState, useEffect, type ReactNode } from \"react\";\nimport type { User } from \"@shared/schema\";\n\ntype AuthContextType = {\n  user: User | null;\n  isLoading: boolean;\n  login: (username: string, password: string) => Promise<boolean>;\n  logout: () => Promise<void>;\n  isAuthenticated: boolean;\n  hasPermission: (permission: string) => boolean;\n};\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nconst rolePermissions: Record<string, string[]> = {\n  admin: [\"manage_users\", \"manage_parties\", \"manage_candidates\", \"manage_scenarios\", \"run_simulations\", \"view_audit\", \"ai_predictions\", \"export_reports\"],\n  analyst: [\"manage_parties\", \"manage_candidates\", \"manage_scenarios\", \"run_simulations\", \"ai_predictions\", \"export_reports\"],\n  viewer: [\"run_simulations\", \"export_reports\"],\n};\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const [user, setUser] = useState<User | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    checkAuth();\n  }, []);\n\n  async function checkAuth() {\n    try {\n      const response = await fetch(\"/api/auth/me\", { credentials: \"include\" });\n      if (response.ok) {\n        const userData = await response.json();\n        setUser(userData);\n      }\n    } catch {\n    } finally {\n      setIsLoading(false);\n    }\n  }\n\n  async function login(username: string, password: string): Promise<boolean> {\n    try {\n      const response = await fetch(\"/api/auth/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ username, password }),\n        credentials: \"include\",\n      });\n      if (response.ok) {\n        const userData = await response.json();\n        setUser(userData);\n        return true;\n      }\n      return false;\n    } catch {\n      return false;\n    }\n  }\n\n  async function logout() {\n    try {\n      await fetch(\"/api/auth/logout\", { method: \"POST\", credentials: \"include\" });\n    } finally {\n      setUser(null);\n    }\n  }\n\n  function hasPermission(permission: string): boolean {\n    if (!user) return false;\n    const permissions = rolePermissions[user.role] || [];\n    return permissions.includes(permission);\n  }\n\n  return (\n    <AuthContext.Provider value={{ user, isLoading, login, logout, isAuthenticated: !!user, hasPermission }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":2600,"size_tokens":null},"server/replit_integrations/chat/storage.ts":{"content":"import { db } from \"../../db\";\nimport { conversations, messages } from \"@shared/schema\";\nimport { eq, desc } from \"drizzle-orm\";\n\nexport interface IChatStorage {\n  getConversation(id: number): Promise<typeof conversations.$inferSelect | undefined>;\n  getAllConversations(): Promise<(typeof conversations.$inferSelect)[]>;\n  createConversation(title: string): Promise<typeof conversations.$inferSelect>;\n  deleteConversation(id: number): Promise<void>;\n  getMessagesByConversation(conversationId: number): Promise<(typeof messages.$inferSelect)[]>;\n  createMessage(conversationId: number, role: string, content: string): Promise<typeof messages.$inferSelect>;\n}\n\nexport const chatStorage: IChatStorage = {\n  async getConversation(id: number) {\n    const [conversation] = await db.select().from(conversations).where(eq(conversations.id, id));\n    return conversation;\n  },\n\n  async getAllConversations() {\n    return db.select().from(conversations).orderBy(desc(conversations.createdAt));\n  },\n\n  async createConversation(title: string) {\n    const [conversation] = await db.insert(conversations).values({ title }).returning();\n    return conversation;\n  },\n\n  async deleteConversation(id: number) {\n    await db.delete(messages).where(eq(messages.conversationId, id));\n    await db.delete(conversations).where(eq(conversations.id, id));\n  },\n\n  async getMessagesByConversation(conversationId: number) {\n    return db.select().from(messages).where(eq(messages.conversationId, conversationId)).orderBy(messages.createdAt);\n  },\n\n  async createMessage(conversationId: number, role: string, content: string) {\n    const [message] = await db.insert(messages).values({ conversationId, role, content }).returning();\n    return message;\n  },\n};\n\n","path":null,"size_bytes":1737,"size_tokens":null},"client/src/pages/campaigns.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { \n  Loader2, Plus, Target, Calendar, DollarSign, Users, Activity, \n  Brain, BarChart3, Trash2, Edit, ChevronRight, TrendingUp, \n  Clock, CheckCircle2, AlertCircle, Pause, Play, MapPin,\n  UserPlus, CalendarDays, Flag, Bell, ChevronLeft, ChevronRight as ChevronRightIcon,\n  UserCheck, UserMinus, Sparkles\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { \n  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, \n  PieChart, Pie, Cell, LineChart, Line, Legend \n} from \"recharts\";\nimport type { \n  Campaign, CampaignBudget, CampaignResource, CampaignMetric, \n  CampaignActivity, CampaignInsightSession \n} from \"@shared/schema\";\n\nconst campaignFormSchema = z.object({\n  name: z.string().min(3, \"Nome deve ter pelo menos 3 caracteres\"),\n  description: z.string().optional().nullable(),\n  startDate: z.string().min(1, \"Data de início é obrigatória\"),\n  endDate: z.string().min(1, \"Data de término é obrigatória\"),\n  goal: z.string().optional().nullable(),\n  targetVotes: z.coerce.number().optional().nullable(),\n  targetRegion: z.string().optional().nullable(),\n  position: z.string().default(\"vereador\"),\n  totalBudget: z.string().optional().nullable(),\n});\n\nconst budgetFormSchema = z.object({\n  category: z.string().min(1, \"Categoria é obrigatória\"),\n  categoryLabel: z.string().min(1, \"Nome da categoria é obrigatório\"),\n  allocatedAmount: z.string().refine(val => !isNaN(parseFloat(val)) && parseFloat(val) >= 0, \"Valor deve ser positivo\"),\n  notes: z.string().optional().nullable(),\n});\n\nconst resourceFormSchema = z.object({\n  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\"),\n  type: z.string().min(1, \"Tipo é obrigatório\"),\n  quantity: z.coerce.number().min(1, \"Quantidade deve ser pelo menos 1\"),\n  unitCost: z.string().optional().nullable(),\n  status: z.string().default(\"available\"),\n  assignedTo: z.string().optional().nullable(),\n  notes: z.string().optional().nullable(),\n});\n\nconst activityFormSchema = z.object({\n  title: z.string().min(3, \"Título deve ter pelo menos 3 caracteres\"),\n  description: z.string().optional().nullable(),\n  type: z.string().min(1, \"Tipo é obrigatório\"),\n  scheduledDate: z.string().optional().nullable(),\n  priority: z.string().default(\"medium\"),\n  assignedTo: z.string().optional().nullable(),\n  estimatedCost: z.string().optional().nullable(),\n});\n\nconst metricFormSchema = z.object({\n  kpiName: z.string().min(1, \"Nome do KPI é obrigatório\"),\n  kpiValue: z.string().refine(val => !isNaN(parseFloat(val)), \"Valor deve ser numérico\"),\n  targetValue: z.string().optional().nullable(),\n  unit: z.string().optional().nullable(),\n  source: z.string().optional().nullable(),\n  metricDate: z.string().min(1, \"Data é obrigatória\"),\n  notes: z.string().optional().nullable(),\n});\n\ntype CampaignFormData = z.infer<typeof campaignFormSchema>;\ntype BudgetFormData = z.infer<typeof budgetFormSchema>;\n\ninterface CampaignDetail {\n  campaign: Campaign;\n  budgets: CampaignBudget[];\n  resources: CampaignResource[];\n  metrics: CampaignMetric[];\n  activities: CampaignActivity[];\n  aiSession: CampaignInsightSession | null;\n}\n\ninterface PerformanceSummary {\n  budgetUtilization: number;\n  activityCompletionRate: number;\n  resourceAllocation: number;\n  latestMetrics: Array<{ name: string; value: number; target: number | null }>;\n  daysRemaining: number;\n  progressPercentage: number;\n  activitiesCompleted: number;\n  activitiesTotal: number;\n}\ntype ResourceFormData = z.infer<typeof resourceFormSchema>;\ntype ActivityFormData = z.infer<typeof activityFormSchema>;\ntype MetricFormData = z.infer<typeof metricFormSchema>;\n\nconst BUDGET_CATEGORIES = [\n  { value: \"advertising\", label: \"Publicidade e Propaganda\" },\n  { value: \"events\", label: \"Eventos e Comícios\" },\n  { value: \"staff\", label: \"Equipe e Funcionários\" },\n  { value: \"materials\", label: \"Materiais Gráficos\" },\n  { value: \"digital\", label: \"Marketing Digital\" },\n  { value: \"transport\", label: \"Transporte e Logística\" },\n  { value: \"other\", label: \"Outros\" },\n];\n\nconst RESOURCE_TYPES = [\n  { value: \"staff\", label: \"Funcionário\" },\n  { value: \"volunteer\", label: \"Voluntário\" },\n  { value: \"vehicle\", label: \"Veículo\" },\n  { value: \"equipment\", label: \"Equipamento\" },\n  { value: \"material\", label: \"Material\" },\n];\n\nconst ACTIVITY_TYPES = [\n  { value: \"event\", label: \"Evento\" },\n  { value: \"meeting\", label: \"Reunião\" },\n  { value: \"action\", label: \"Ação de Campo\" },\n  { value: \"milestone\", label: \"Marco\" },\n];\n\nconst STATUS_COLORS: Record<string, string> = {\n  planning: \"bg-blue-500\",\n  active: \"bg-green-500\",\n  paused: \"bg-yellow-500\",\n  completed: \"bg-gray-500\",\n  cancelled: \"bg-red-500\",\n};\n\nconst STATUS_LABELS: Record<string, string> = {\n  planning: \"Planejamento\",\n  active: \"Ativa\",\n  paused: \"Pausada\",\n  completed: \"Concluída\",\n  cancelled: \"Cancelada\",\n};\n\nconst CHART_COLORS = [\"#003366\", \"#FFD700\", \"#4CAF50\", \"#FF5722\", \"#9C27B0\", \"#00BCD4\", \"#795548\"];\n\nexport default function Campaigns() {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showBudgetDialog, setShowBudgetDialog] = useState(false);\n  const [showResourceDialog, setShowResourceDialog] = useState(false);\n  const [showActivityDialog, setShowActivityDialog] = useState(false);\n  const [showMetricDialog, setShowMetricDialog] = useState(false);\n  const [selectedCampaign, setSelectedCampaign] = useState<number | null>(null);\n  const [activeTab, setActiveTab] = useState(\"list\");\n\n  const form = useForm<CampaignFormData>({\n    resolver: zodResolver(campaignFormSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      startDate: \"\",\n      endDate: \"\",\n      goal: \"\",\n      targetVotes: \"\",\n      targetRegion: \"\",\n      position: \"vereador\",\n      totalBudget: \"\",\n    },\n  });\n\n  const budgetForm = useForm<BudgetFormData>({\n    resolver: zodResolver(budgetFormSchema),\n    defaultValues: {\n      category: \"\",\n      categoryLabel: \"\",\n      allocatedAmount: \"0\",\n      notes: \"\",\n    },\n  });\n\n  const resourceForm = useForm<ResourceFormData>({\n    resolver: zodResolver(resourceFormSchema),\n    defaultValues: {\n      name: \"\",\n      type: \"\",\n      quantity: \"1\",\n      unitCost: \"\",\n      status: \"available\",\n      assignedTo: \"\",\n      notes: \"\",\n    },\n  });\n\n  const activityForm = useForm<ActivityFormData>({\n    resolver: zodResolver(activityFormSchema),\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      type: \"\",\n      scheduledDate: \"\",\n      priority: \"medium\",\n      assignedTo: \"\",\n      estimatedCost: \"\",\n    },\n  });\n\n  const metricForm = useForm<MetricFormData>({\n    resolver: zodResolver(metricFormSchema),\n    defaultValues: {\n      kpiName: \"\",\n      kpiValue: \"\",\n      targetValue: \"\",\n      unit: \"\",\n      source: \"manual\",\n      metricDate: new Date().toISOString().split(\"T\")[0],\n      notes: \"\",\n    },\n  });\n\n  const { data: campaigns, isLoading: loadingCampaigns } = useQuery<Campaign[]>({\n    queryKey: [\"/api/campaigns\"],\n  });\n\n  const { data: campaignDetail, isLoading: loadingDetail } = useQuery<CampaignDetail>({\n    queryKey: [\"/api/campaigns\", selectedCampaign],\n    enabled: !!selectedCampaign,\n  });\n\n  const { data: performance } = useQuery<PerformanceSummary>({\n    queryKey: [\"/api/campaigns\", selectedCampaign, \"performance\"],\n    enabled: !!selectedCampaign,\n  });\n\n  const { data: aiSessions } = useQuery<CampaignInsightSession[]>({\n    queryKey: [\"/api/campaign-insights/sessions\"],\n  });\n\n  const { data: parties } = useQuery<Array<{ id: number; name: string }>>({\n    queryKey: [\"/api/parties\"],\n  });\n\n  const { data: users } = useQuery<Array<{ id: string; name: string; username: string; email: string; role: string }>>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const { data: teamMembers, refetch: refetchTeam } = useQuery<any[]>({\n    queryKey: [\"/api/campaigns\", selectedCampaign, \"team\"],\n    enabled: !!selectedCampaign,\n  });\n\n  const { data: kpiGoals, refetch: refetchKpiGoals } = useQuery<any[]>({\n    queryKey: [\"/api/campaigns\", selectedCampaign, \"kpi-goals\"],\n    enabled: !!selectedCampaign,\n  });\n\n  // Calendar state\n  const [calendarDate, setCalendarDate] = useState(new Date());\n  const [showTeamDialog, setShowTeamDialog] = useState(false);\n  const [showKpiGoalDialog, setShowKpiGoalDialog] = useState(false);\n  const [aiRecommendations, setAiRecommendations] = useState<any[]>([]);\n  const [loadingRecommendations, setLoadingRecommendations] = useState(false);\n\n  // Team form state\n  const [teamFormUserId, setTeamFormUserId] = useState(\"\");\n  const [teamFormRole, setTeamFormRole] = useState(\"member\");\n\n  // KPI form state\n  const [kpiFormKpiName, setKpiFormKpiName] = useState(\"\");\n  const [kpiFormTargetValue, setKpiFormTargetValue] = useState(\"\");\n  const [kpiFormBaselineValue, setKpiFormBaselineValue] = useState(\"\");\n  const [kpiFormUnit, setKpiFormUnit] = useState(\"number\");\n  const [kpiFormPriority, setKpiFormPriority] = useState(\"medium\");\n  const [kpiFormStartDate, setKpiFormStartDate] = useState(\"\");\n  const [kpiFormEndDate, setKpiFormEndDate] = useState(\"\");\n\n  // Calendar activities query - use activities from campaign detail\n  const { data: calendarActivities, isLoading: loadingCalendar } = useQuery<any[]>({\n    queryKey: [\"/api/campaigns\", selectedCampaign, \"activities\"],\n    enabled: !!selectedCampaign,\n  });\n\n  const createCampaignMutation = useMutation({\n    mutationFn: async (data: CampaignFormData) => {\n      return apiRequest(\"POST\", \"/api/campaigns\", {\n        ...data,\n        startDate: new Date(data.startDate),\n        endDate: new Date(data.endDate),\n        targetVotes: data.targetVotes || undefined,\n        totalBudget: data.totalBudget || \"0\",\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Campanha criada com sucesso\" });\n      setShowCreateDialog(false);\n      form.reset();\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\"] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const createBudgetMutation = useMutation({\n    mutationFn: async (data: BudgetFormData) => {\n      return apiRequest(\"POST\", `/api/campaigns/${selectedCampaign}/budgets`, {\n        ...data,\n        allocatedAmount: data.allocatedAmount,\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Orçamento criado com sucesso\" });\n      setShowBudgetDialog(false);\n      budgetForm.reset();\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\", selectedCampaign] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const createResourceMutation = useMutation({\n    mutationFn: async (data: ResourceFormData) => {\n      const unitCost = data.unitCost ? parseFloat(data.unitCost) : 0;\n      const quantity = parseInt(data.quantity);\n      return apiRequest(\"POST\", `/api/campaigns/${selectedCampaign}/resources`, {\n        ...data,\n        quantity,\n        unitCost: unitCost.toString(),\n        totalCost: (unitCost * quantity).toString(),\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Recurso criado com sucesso\" });\n      setShowResourceDialog(false);\n      resourceForm.reset();\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\", selectedCampaign] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const createActivityMutation = useMutation({\n    mutationFn: async (data: ActivityFormData) => {\n      return apiRequest(\"POST\", `/api/campaigns/${selectedCampaign}/activities`, {\n        ...data,\n        scheduledDate: data.scheduledDate ? new Date(data.scheduledDate) : undefined,\n        estimatedCost: data.estimatedCost || undefined,\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Atividade criada com sucesso\" });\n      setShowActivityDialog(false);\n      activityForm.reset();\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\", selectedCampaign] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const createMetricMutation = useMutation({\n    mutationFn: async (data: MetricFormData) => {\n      return apiRequest(\"POST\", `/api/campaigns/${selectedCampaign}/metrics`, {\n        ...data,\n        metricDate: new Date(data.metricDate),\n        kpiValue: data.kpiValue,\n        targetValue: data.targetValue || undefined,\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Métrica registrada com sucesso\" });\n      setShowMetricDialog(false);\n      metricForm.reset();\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\", selectedCampaign] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const linkAiSessionMutation = useMutation({\n    mutationFn: async (aiSessionId: number) => {\n      return apiRequest(\"POST\", `/api/campaigns/${selectedCampaign}/link-ai-session`, { aiSessionId });\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Sessão de IA vinculada com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\", selectedCampaign] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async (status: string) => {\n      return apiRequest(\"PATCH\", `/api/campaigns/${selectedCampaign}`, { status });\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Status atualizado com sucesso\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\", selectedCampaign] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  // Team member mutations\n  const addTeamMemberMutation = useMutation({\n    mutationFn: async (data: { userId: string; role: string; notes?: string }) => {\n      return apiRequest(\"POST\", `/api/campaigns/${selectedCampaign}/team`, data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Membro adicionado à equipe\" });\n      setShowTeamDialog(false);\n      setTeamFormUserId(\"\");\n      setTeamFormRole(\"member\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\", selectedCampaign, \"team\"] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const removeTeamMemberMutation = useMutation({\n    mutationFn: async (memberId: number) => {\n      return apiRequest(\"DELETE\", `/api/campaigns/${selectedCampaign}/team/${memberId}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Membro removido da equipe\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\", selectedCampaign, \"team\"] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  // KPI goal mutations\n  const createKpiGoalMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return apiRequest(\"POST\", `/api/campaigns/${selectedCampaign}/kpi-goals`, data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Meta de KPI criada\" });\n      setShowKpiGoalDialog(false);\n      setKpiFormKpiName(\"\");\n      setKpiFormTargetValue(\"\");\n      setKpiFormBaselineValue(\"\");\n      setKpiFormUnit(\"number\");\n      setKpiFormPriority(\"medium\");\n      setKpiFormStartDate(\"\");\n      setKpiFormEndDate(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\", selectedCampaign, \"kpi-goals\"] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateKpiGoalMutation = useMutation({\n    mutationFn: async ({ id, ...data }: { id: number; [key: string]: any }) => {\n      return apiRequest(\"PATCH\", `/api/campaigns/${selectedCampaign}/kpi-goals/${id}`, data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Meta de KPI atualizada\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\", selectedCampaign, \"kpi-goals\"] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deleteKpiGoalMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/campaigns/${selectedCampaign}/kpi-goals/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Meta de KPI removida\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\", selectedCampaign, \"kpi-goals\"] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  // Fetch AI recommendations for KPIs\n  const fetchAiRecommendations = async () => {\n    setLoadingRecommendations(true);\n    try {\n      const response = await apiRequest(\"POST\", `/api/campaigns/${selectedCampaign}/kpi-goals/ai-recommendations`);\n      setAiRecommendations(response.recommendations || []);\n    } catch (error) {\n      toast({ title: \"Erro\", description: \"Falha ao obter recomendações de IA\", variant: \"destructive\" });\n    } finally {\n      setLoadingRecommendations(false);\n    }\n  };\n\n  const formatCurrency = (value: string | number | null | undefined) => {\n    const num = typeof value === \"string\" ? parseFloat(value) : value;\n    if (!num && num !== 0) return \"R$ 0,00\";\n    return `R$ ${num.toLocaleString(\"pt-BR\", { minimumFractionDigits: 2 })}`;\n  };\n\n  const formatDate = (date: string | Date | null | undefined) => {\n    if (!date) return \"-\";\n    return new Date(date).toLocaleDateString(\"pt-BR\");\n  };\n\n  const budgetChartData = campaignDetail?.budgets?.map((b: any) => ({\n    name: b.categoryLabel,\n    allocated: parseFloat(b.allocatedAmount || 0),\n    spent: parseFloat(b.spentAmount || 0),\n  })) || [];\n\n  const metricsChartData = campaignDetail?.metrics?.slice(0, 10).reverse().map((m: any) => ({\n    date: formatDate(m.metricDate),\n    value: parseFloat(m.kpiValue),\n    target: m.targetValue ? parseFloat(m.targetValue) : null,\n  })) || [];\n\n  if (loadingCampaigns) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" data-testid=\"loading-spinner\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Gestão de Campanhas</h1>\n          <p className=\"text-muted-foreground\">Gerencie campanhas eleitorais, orçamentos e recursos</p>\n        </div>\n        <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-campaign\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Nova Campanha\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>Criar Nova Campanha</DialogTitle>\n              <DialogDescription>Defina os detalhes da campanha eleitoral</DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit((data) => createCampaignMutation.mutate(data))} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Nome da Campanha</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"Ex: Campanha Municipal 2026\" data-testid=\"input-campaign-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"description\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Descrição</FormLabel>\n                      <FormControl>\n                        <Textarea {...field} placeholder=\"Descrição da campanha...\" data-testid=\"input-campaign-description\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"startDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Data de Início</FormLabel>\n                        <FormControl>\n                          <Input type=\"date\" {...field} data-testid=\"input-campaign-start-date\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"endDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Data de Término</FormLabel>\n                        <FormControl>\n                          <Input type=\"date\" {...field} data-testid=\"input-campaign-end-date\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"position\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Cargo</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-campaign-position\">\n                              <SelectValue placeholder=\"Selecione o cargo\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"vereador\">Vereador</SelectItem>\n                            <SelectItem value=\"prefeito\">Prefeito</SelectItem>\n                            <SelectItem value=\"deputado_estadual\">Deputado Estadual</SelectItem>\n                            <SelectItem value=\"deputado_federal\">Deputado Federal</SelectItem>\n                            <SelectItem value=\"senador\">Senador</SelectItem>\n                            <SelectItem value=\"governador\">Governador</SelectItem>\n                            <SelectItem value=\"presidente\">Presidente</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"targetRegion\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Região Alvo</FormLabel>\n                        <FormControl>\n                          <Input {...field} placeholder=\"Ex: São Paulo\" data-testid=\"input-campaign-region\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"targetVotes\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Meta de Votos</FormLabel>\n                        <FormControl>\n                          <Input type=\"number\" {...field} placeholder=\"100000\" data-testid=\"input-campaign-votes\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"totalBudget\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Orçamento Total (R$)</FormLabel>\n                        <FormControl>\n                          <Input type=\"number\" step=\"0.01\" {...field} placeholder=\"500000\" data-testid=\"input-campaign-budget\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <FormField\n                  control={form.control}\n                  name=\"goal\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Objetivo Principal</FormLabel>\n                      <FormControl>\n                        <Textarea {...field} placeholder=\"Qual o objetivo principal desta campanha?\" data-testid=\"input-campaign-goal\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <DialogFooter>\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setShowCreateDialog(false)} data-testid=\"button-cancel-campaign\">\n                    Cancelar\n                  </Button>\n                  <Button type=\"submit\" disabled={createCampaignMutation.isPending} data-testid=\"button-submit-campaign\">\n                    {createCampaignMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                    Criar Campanha\n                  </Button>\n                </DialogFooter>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"flex-wrap\">\n          <TabsTrigger value=\"list\" data-testid=\"tab-list\">Lista de Campanhas</TabsTrigger>\n          {selectedCampaign && (\n            <>\n              <TabsTrigger value=\"overview\" data-testid=\"tab-overview\">Visão Geral</TabsTrigger>\n              <TabsTrigger value=\"team\" data-testid=\"tab-team\">Equipe</TabsTrigger>\n              <TabsTrigger value=\"budget\" data-testid=\"tab-budget\">Orçamento</TabsTrigger>\n              <TabsTrigger value=\"resources\" data-testid=\"tab-resources\">Recursos</TabsTrigger>\n              <TabsTrigger value=\"activities\" data-testid=\"tab-activities\">Atividades</TabsTrigger>\n              <TabsTrigger value=\"calendar\" data-testid=\"tab-calendar\">Calendário</TabsTrigger>\n              <TabsTrigger value=\"kpi-goals\" data-testid=\"tab-kpi-goals\">Metas KPI</TabsTrigger>\n              <TabsTrigger value=\"performance\" data-testid=\"tab-performance\">Desempenho</TabsTrigger>\n              <TabsTrigger value=\"ai\" data-testid=\"tab-ai\">IA Estratégica</TabsTrigger>\n            </>\n          )}\n        </TabsList>\n\n        <TabsContent value=\"list\" className=\"space-y-4\">\n          {campaigns && campaigns.length > 0 ? (\n            <div className=\"grid gap-4\">\n              {campaigns.map((campaign: any) => (\n                <Card \n                  key={campaign.id} \n                  className=\"hover-elevate cursor-pointer\"\n                  onClick={() => {\n                    setSelectedCampaign(campaign.id);\n                    setActiveTab(\"overview\");\n                  }}\n                  data-testid={`card-campaign-${campaign.id}`}\n                >\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-4\">\n                        <div className={`w-3 h-3 rounded-full ${STATUS_COLORS[campaign.status]}`} />\n                        <div>\n                          <h3 className=\"font-semibold text-lg\" data-testid={`text-campaign-name-${campaign.id}`}>{campaign.name}</h3>\n                          <p className=\"text-sm text-muted-foreground\">\n                            {formatDate(campaign.startDate)} - {formatDate(campaign.endDate)}\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-4\">\n                        <div className=\"text-right\">\n                          <p className=\"text-sm text-muted-foreground\">Orçamento</p>\n                          <p className=\"font-semibold\">{formatCurrency(campaign.totalBudget)}</p>\n                        </div>\n                        <Badge variant=\"outline\">{STATUS_LABELS[campaign.status]}</Badge>\n                        <ChevronRight className=\"h-5 w-5 text-muted-foreground\" />\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : (\n            <Card data-testid=\"empty-campaigns\">\n              <CardContent className=\"p-12 text-center\">\n                <Target className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                <h3 className=\"text-lg font-semibold mb-2\">Nenhuma campanha criada</h3>\n                <p className=\"text-muted-foreground mb-4\">Crie sua primeira campanha eleitoral para começar</p>\n                <Button onClick={() => setShowCreateDialog(true)} data-testid=\"button-create-first-campaign\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Criar Campanha\n                </Button>\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n\n        {selectedCampaign && campaignDetail && (\n          <>\n            <TabsContent value=\"overview\" className=\"space-y-6\">\n              <div className=\"flex items-center justify-between\">\n                <Button variant=\"outline\" onClick={() => { setSelectedCampaign(null); setActiveTab(\"list\"); }} data-testid=\"button-back-list\">\n                  Voltar para lista\n                </Button>\n                <div className=\"flex gap-2\">\n                  {campaignDetail.campaign.status === \"planning\" && (\n                    <Button onClick={() => updateStatusMutation.mutate(\"active\")} data-testid=\"button-start-campaign\">\n                      <Play className=\"h-4 w-4 mr-2\" />\n                      Iniciar Campanha\n                    </Button>\n                  )}\n                  {campaignDetail.campaign.status === \"active\" && (\n                    <Button variant=\"outline\" onClick={() => updateStatusMutation.mutate(\"paused\")} data-testid=\"button-pause-campaign\">\n                      <Pause className=\"h-4 w-4 mr-2\" />\n                      Pausar\n                    </Button>\n                  )}\n                  {campaignDetail.campaign.status === \"paused\" && (\n                    <Button onClick={() => updateStatusMutation.mutate(\"active\")} data-testid=\"button-resume-campaign\">\n                      <Play className=\"h-4 w-4 mr-2\" />\n                      Retomar\n                    </Button>\n                  )}\n                  {(campaignDetail.campaign.status === \"active\" || campaignDetail.campaign.status === \"paused\") && (\n                    <Button variant=\"outline\" onClick={() => updateStatusMutation.mutate(\"completed\")} data-testid=\"button-complete-campaign\">\n                      <CheckCircle2 className=\"h-4 w-4 mr-2\" />\n                      Concluir\n                    </Button>\n                  )}\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                <Card data-testid=\"stat-progress\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"p-3 rounded-lg bg-primary/10\">\n                        <Activity className=\"h-6 w-6 text-primary\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <p className=\"text-sm text-muted-foreground\">Progresso</p>\n                        <p className=\"text-2xl font-bold\">{Math.round(performance?.progressPercentage || 0)}%</p>\n                        <Progress value={performance?.progressPercentage || 0} className=\"mt-2\" />\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"stat-days-remaining\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"p-3 rounded-lg bg-blue-500/10\">\n                        <Clock className=\"h-6 w-6 text-blue-500\" />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Dias Restantes</p>\n                        <p className=\"text-2xl font-bold\">{performance?.daysRemaining || 0}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"stat-budget-utilization\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"p-3 rounded-lg bg-green-500/10\">\n                        <DollarSign className=\"h-6 w-6 text-green-500\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <p className=\"text-sm text-muted-foreground\">Uso do Orçamento</p>\n                        <p className=\"text-2xl font-bold\">{Math.round(performance?.budgetUtilization || 0)}%</p>\n                        <Progress value={performance?.budgetUtilization || 0} className=\"mt-2\" />\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"stat-activities\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"p-3 rounded-lg bg-purple-500/10\">\n                        <CheckCircle2 className=\"h-6 w-6 text-purple-500\" />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Atividades</p>\n                        <p className=\"text-2xl font-bold\">{performance?.activitiesCompleted || 0}/{performance?.activitiesTotal || 0}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <Card>\n                  <CardHeader>\n                    <CardTitle>Detalhes da Campanha</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-4\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Status</p>\n                        <Badge variant=\"outline\" className=\"mt-1\">{STATUS_LABELS[campaignDetail.campaign.status]}</Badge>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Cargo</p>\n                        <p className=\"font-medium\">{campaignDetail.campaign.position}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Região</p>\n                        <p className=\"font-medium\">{campaignDetail.campaign.targetRegion || \"-\"}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Meta de Votos</p>\n                        <p className=\"font-medium\">{campaignDetail.campaign.targetVotes?.toLocaleString(\"pt-BR\") || \"-\"}</p>\n                      </div>\n                    </div>\n                    {campaignDetail.campaign.goal && (\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Objetivo</p>\n                        <p className=\"text-sm mt-1\">{campaignDetail.campaign.goal}</p>\n                      </div>\n                    )}\n                    {campaignDetail.campaign.description && (\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Descrição</p>\n                        <p className=\"text-sm mt-1\">{campaignDetail.campaign.description}</p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader>\n                    <CardTitle>Métricas Recentes</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {performance?.latestMetrics && performance.latestMetrics.length > 0 ? (\n                      <div className=\"space-y-4\">\n                        {performance.latestMetrics.map((metric: any, index: number) => (\n                          <div key={index} className=\"flex items-center justify-between\">\n                            <div>\n                              <p className=\"font-medium\">{metric.name}</p>\n                              <p className=\"text-sm text-muted-foreground\">\n                                Meta: {metric.target?.toLocaleString(\"pt-BR\") || \"-\"}\n                              </p>\n                            </div>\n                            <div className=\"text-right\">\n                              <p className=\"text-xl font-bold\">{metric.value.toLocaleString(\"pt-BR\")}</p>\n                              {metric.target && (\n                                <p className={`text-sm ${metric.value >= metric.target ? \"text-green-500\" : \"text-yellow-500\"}`}>\n                                  {Math.round((metric.value / metric.target) * 100)}% da meta\n                                </p>\n                              )}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <p className=\"text-muted-foreground text-center py-8\">Nenhuma métrica registrada</p>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            {/* Team Tab */}\n            <TabsContent value=\"team\" className=\"space-y-6\">\n              <div className=\"flex justify-between items-center\">\n                <h3 className=\"text-xl font-semibold\">Equipe da Campanha</h3>\n                <Dialog open={showTeamDialog} onOpenChange={setShowTeamDialog}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-add-team-member\">\n                      <UserPlus className=\"h-4 w-4 mr-2\" />\n                      Adicionar Membro\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle>Adicionar Membro à Equipe</DialogTitle>\n                      <DialogDescription>Selecione um usuário para adicionar à equipe da campanha</DialogDescription>\n                    </DialogHeader>\n                    <div className=\"space-y-4 py-4\">\n                      <div className=\"space-y-2\">\n                        <label className=\"text-sm font-medium\">Usuário</label>\n                        <Select value={teamFormUserId} onValueChange={setTeamFormUserId}>\n                          <SelectTrigger data-testid=\"select-team-user\">\n                            <SelectValue placeholder=\"Selecione um usuário\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {users?.filter(u => !teamMembers?.some(tm => tm.userId === u.id)).map((user) => (\n                              <SelectItem key={user.id} value={user.id}>\n                                {user.name} ({user.username})\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"space-y-2\">\n                        <label className=\"text-sm font-medium\">Função</label>\n                        <Select value={teamFormRole} onValueChange={setTeamFormRole}>\n                          <SelectTrigger data-testid=\"select-team-role\">\n                            <SelectValue placeholder=\"Selecione a função\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"coordinator\">Coordenador</SelectItem>\n                            <SelectItem value=\"manager\">Gerente</SelectItem>\n                            <SelectItem value=\"member\">Membro</SelectItem>\n                            <SelectItem value=\"volunteer\">Voluntário</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n                    <DialogFooter>\n                      <Button variant=\"outline\" onClick={() => setShowTeamDialog(false)}>Cancelar</Button>\n                      <Button \n                        onClick={() => {\n                          if (teamFormUserId) {\n                            addTeamMemberMutation.mutate({ userId: teamFormUserId, role: teamFormRole });\n                          }\n                        }}\n                        disabled={addTeamMemberMutation.isPending || !teamFormUserId}\n                        data-testid=\"button-submit-team-member\"\n                      >\n                        {addTeamMemberMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : \"Adicionar\"}\n                      </Button>\n                    </DialogFooter>\n                  </DialogContent>\n                </Dialog>\n              </div>\n\n              {teamMembers && teamMembers.length > 0 ? (\n                <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                  {teamMembers.map((member: any) => (\n                    <Card key={member.id} data-testid={`card-team-member-${member.id}`}>\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex items-center gap-3\">\n                            <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                              <Users className=\"h-5 w-5 text-primary\" />\n                            </div>\n                            <div>\n                              <p className=\"font-medium\">{member.user?.name || \"Usuário\"}</p>\n                              <p className=\"text-sm text-muted-foreground\">@{member.user?.username}</p>\n                            </div>\n                          </div>\n                          <Button \n                            size=\"icon\" \n                            variant=\"ghost\"\n                            onClick={() => removeTeamMemberMutation.mutate(member.id)}\n                            data-testid={`button-remove-member-${member.id}`}\n                          >\n                            <UserMinus className=\"h-4 w-4 text-destructive\" />\n                          </Button>\n                        </div>\n                        <div className=\"mt-3 flex items-center gap-2\">\n                          <Badge variant=\"outline\">\n                            {member.role === \"coordinator\" ? \"Coordenador\" :\n                             member.role === \"manager\" ? \"Gerente\" :\n                             member.role === \"volunteer\" ? \"Voluntário\" : \"Membro\"}\n                          </Badge>\n                          <span className=\"text-xs text-muted-foreground\">\n                            Desde {formatDate(member.joinedAt)}\n                          </span>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <Card>\n                  <CardContent className=\"p-12 text-center\">\n                    <Users className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n                    <h3 className=\"text-xl font-semibold mb-2\">Nenhum membro na equipe</h3>\n                    <p className=\"text-muted-foreground mb-4\">Adicione membros para gerenciar tarefas e atribuições</p>\n                    <Button onClick={() => setShowTeamDialog(true)}>\n                      <UserPlus className=\"h-4 w-4 mr-2\" />\n                      Adicionar Primeiro Membro\n                    </Button>\n                  </CardContent>\n                </Card>\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"budget\" className=\"space-y-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-xl font-semibold\">Orçamento da Campanha</h2>\n                  <p className=\"text-muted-foreground\">Gerencie a alocação de recursos financeiros</p>\n                </div>\n                <Dialog open={showBudgetDialog} onOpenChange={setShowBudgetDialog}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-add-budget\">\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Adicionar Categoria\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle>Nova Categoria de Orçamento</DialogTitle>\n                    </DialogHeader>\n                    <Form {...budgetForm}>\n                      <form onSubmit={budgetForm.handleSubmit((data) => createBudgetMutation.mutate(data))} className=\"space-y-4\">\n                        <FormField\n                          control={budgetForm.control}\n                          name=\"category\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Categoria</FormLabel>\n                              <Select onValueChange={(value) => {\n                                field.onChange(value);\n                                const label = BUDGET_CATEGORIES.find(c => c.value === value)?.label || \"\";\n                                budgetForm.setValue(\"categoryLabel\", label);\n                              }}>\n                                <FormControl>\n                                  <SelectTrigger data-testid=\"select-budget-category\">\n                                    <SelectValue placeholder=\"Selecione a categoria\" />\n                                  </SelectTrigger>\n                                </FormControl>\n                                <SelectContent>\n                                  {BUDGET_CATEGORIES.map(cat => (\n                                    <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={budgetForm.control}\n                          name=\"allocatedAmount\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Valor Alocado (R$)</FormLabel>\n                              <FormControl>\n                                <Input type=\"number\" step=\"0.01\" {...field} data-testid=\"input-budget-amount\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={budgetForm.control}\n                          name=\"notes\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Observações</FormLabel>\n                              <FormControl>\n                                <Textarea {...field} data-testid=\"input-budget-notes\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <DialogFooter>\n                          <Button type=\"submit\" disabled={createBudgetMutation.isPending} data-testid=\"button-submit-budget\">\n                            {createBudgetMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                            Adicionar\n                          </Button>\n                        </DialogFooter>\n                      </form>\n                    </Form>\n                  </DialogContent>\n                </Dialog>\n              </div>\n\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <Card>\n                  <CardHeader>\n                    <CardTitle>Distribuição por Categoria</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {budgetChartData.length > 0 ? (\n                      <div className=\"h-64\">\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\n                          <BarChart data={budgetChartData}>\n                            <CartesianGrid strokeDasharray=\"3 3\" />\n                            <XAxis dataKey=\"name\" tick={{ fontSize: 10 }} angle={-45} textAnchor=\"end\" height={80} />\n                            <YAxis tickFormatter={(v) => `R$${(v/1000).toFixed(0)}k`} />\n                            <Tooltip formatter={(v: number) => formatCurrency(v)} />\n                            <Legend />\n                            <Bar dataKey=\"allocated\" name=\"Alocado\" fill=\"#003366\" />\n                            <Bar dataKey=\"spent\" name=\"Gasto\" fill=\"#FFD700\" />\n                          </BarChart>\n                        </ResponsiveContainer>\n                      </div>\n                    ) : (\n                      <p className=\"text-muted-foreground text-center py-12\">Nenhum orçamento definido</p>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader>\n                    <CardTitle>Detalhamento</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Categoria</TableHead>\n                          <TableHead className=\"text-right\">Alocado</TableHead>\n                          <TableHead className=\"text-right\">Gasto</TableHead>\n                          <TableHead className=\"text-right\">%</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {campaignDetail.budgets.map((budget: any) => (\n                          <TableRow key={budget.id} data-testid={`row-budget-${budget.id}`}>\n                            <TableCell>{budget.categoryLabel}</TableCell>\n                            <TableCell className=\"text-right\">{formatCurrency(budget.allocatedAmount)}</TableCell>\n                            <TableCell className=\"text-right\">{formatCurrency(budget.spentAmount)}</TableCell>\n                            <TableCell className=\"text-right\">\n                              {Math.round((parseFloat(budget.spentAmount || 0) / parseFloat(budget.allocatedAmount || 1)) * 100)}%\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                        {campaignDetail.budgets.length === 0 && (\n                          <TableRow>\n                            <TableCell colSpan={4} className=\"text-center text-muted-foreground\">\n                              Nenhum orçamento definido\n                            </TableCell>\n                          </TableRow>\n                        )}\n                      </TableBody>\n                    </Table>\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"resources\" className=\"space-y-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-xl font-semibold\">Recursos da Campanha</h2>\n                  <p className=\"text-muted-foreground\">Gerencie pessoas, veículos e materiais</p>\n                </div>\n                <Dialog open={showResourceDialog} onOpenChange={setShowResourceDialog}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-add-resource\">\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Adicionar Recurso\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle>Novo Recurso</DialogTitle>\n                    </DialogHeader>\n                    <Form {...resourceForm}>\n                      <form onSubmit={resourceForm.handleSubmit((data) => createResourceMutation.mutate(data))} className=\"space-y-4\">\n                        <FormField\n                          control={resourceForm.control}\n                          name=\"name\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Nome</FormLabel>\n                              <FormControl>\n                                <Input {...field} placeholder=\"Ex: João Silva\" data-testid=\"input-resource-name\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={resourceForm.control}\n                            name=\"type\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Tipo</FormLabel>\n                                <Select onValueChange={field.onChange}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-resource-type\">\n                                      <SelectValue placeholder=\"Selecione\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    {RESOURCE_TYPES.map(t => (\n                                      <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>\n                                    ))}\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={resourceForm.control}\n                            name=\"quantity\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Quantidade</FormLabel>\n                                <FormControl>\n                                  <Input type=\"number\" {...field} data-testid=\"input-resource-quantity\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={resourceForm.control}\n                            name=\"unitCost\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Custo Unitário (R$)</FormLabel>\n                                <FormControl>\n                                  <Input type=\"number\" step=\"0.01\" {...field} data-testid=\"input-resource-cost\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={resourceForm.control}\n                            name=\"status\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Status</FormLabel>\n                                <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-resource-status\">\n                                      <SelectValue />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"available\">Disponível</SelectItem>\n                                    <SelectItem value=\"allocated\">Alocado</SelectItem>\n                                    <SelectItem value=\"unavailable\">Indisponível</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                        <FormField\n                          control={resourceForm.control}\n                          name=\"assignedTo\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Atribuído a</FormLabel>\n                              <FormControl>\n                                <Input {...field} placeholder=\"Nome do responsável\" data-testid=\"input-resource-assigned\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <DialogFooter>\n                          <Button type=\"submit\" disabled={createResourceMutation.isPending} data-testid=\"button-submit-resource\">\n                            {createResourceMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                            Adicionar\n                          </Button>\n                        </DialogFooter>\n                      </form>\n                    </Form>\n                  </DialogContent>\n                </Dialog>\n              </div>\n\n              <Card>\n                <CardContent className=\"p-0\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Nome</TableHead>\n                        <TableHead>Tipo</TableHead>\n                        <TableHead className=\"text-center\">Qtd</TableHead>\n                        <TableHead className=\"text-right\">Custo Total</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead>Atribuído</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {campaignDetail.resources.map((resource: any) => (\n                        <TableRow key={resource.id} data-testid={`row-resource-${resource.id}`}>\n                          <TableCell className=\"font-medium\">{resource.name}</TableCell>\n                          <TableCell>{RESOURCE_TYPES.find(t => t.value === resource.type)?.label || resource.type}</TableCell>\n                          <TableCell className=\"text-center\">{resource.quantity}</TableCell>\n                          <TableCell className=\"text-right\">{formatCurrency(resource.totalCost)}</TableCell>\n                          <TableCell>\n                            <Badge variant={resource.status === \"available\" ? \"outline\" : resource.status === \"allocated\" ? \"default\" : \"secondary\"}>\n                              {resource.status === \"available\" ? \"Disponível\" : resource.status === \"allocated\" ? \"Alocado\" : \"Indisponível\"}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>{resource.assignedTo || \"-\"}</TableCell>\n                        </TableRow>\n                      ))}\n                      {campaignDetail.resources.length === 0 && (\n                        <TableRow>\n                          <TableCell colSpan={6} className=\"text-center text-muted-foreground py-8\">\n                            Nenhum recurso cadastrado\n                          </TableCell>\n                        </TableRow>\n                      )}\n                    </TableBody>\n                  </Table>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"activities\" className=\"space-y-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-xl font-semibold\">Atividades</h2>\n                  <p className=\"text-muted-foreground\">Eventos, reuniões e ações de campanha</p>\n                </div>\n                <Dialog open={showActivityDialog} onOpenChange={setShowActivityDialog}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-add-activity\">\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Nova Atividade\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle>Nova Atividade</DialogTitle>\n                    </DialogHeader>\n                    <Form {...activityForm}>\n                      <form onSubmit={activityForm.handleSubmit((data) => createActivityMutation.mutate(data))} className=\"space-y-4\">\n                        <FormField\n                          control={activityForm.control}\n                          name=\"title\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Título</FormLabel>\n                              <FormControl>\n                                <Input {...field} placeholder=\"Ex: Comício no Centro\" data-testid=\"input-activity-title\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={activityForm.control}\n                            name=\"type\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Tipo</FormLabel>\n                                <Select onValueChange={field.onChange}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-activity-type\">\n                                      <SelectValue placeholder=\"Selecione\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    {ACTIVITY_TYPES.map(t => (\n                                      <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>\n                                    ))}\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={activityForm.control}\n                            name=\"scheduledDate\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Data Programada</FormLabel>\n                                <FormControl>\n                                  <Input type=\"datetime-local\" {...field} data-testid=\"input-activity-date\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={activityForm.control}\n                            name=\"priority\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Prioridade</FormLabel>\n                                <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-activity-priority\">\n                                      <SelectValue />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"low\">Baixa</SelectItem>\n                                    <SelectItem value=\"medium\">Média</SelectItem>\n                                    <SelectItem value=\"high\">Alta</SelectItem>\n                                    <SelectItem value=\"critical\">Crítica</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={activityForm.control}\n                            name=\"estimatedCost\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Custo Estimado (R$)</FormLabel>\n                                <FormControl>\n                                  <Input type=\"number\" step=\"0.01\" {...field} data-testid=\"input-activity-cost\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                        <FormField\n                          control={activityForm.control}\n                          name=\"description\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Descrição</FormLabel>\n                              <FormControl>\n                                <Textarea {...field} data-testid=\"input-activity-description\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <DialogFooter>\n                          <Button type=\"submit\" disabled={createActivityMutation.isPending} data-testid=\"button-submit-activity\">\n                            {createActivityMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                            Criar Atividade\n                          </Button>\n                        </DialogFooter>\n                      </form>\n                    </Form>\n                  </DialogContent>\n                </Dialog>\n              </div>\n\n              <div className=\"grid gap-4\">\n                {campaignDetail.activities.length > 0 ? (\n                  campaignDetail.activities.map((activity: any) => (\n                    <Card key={activity.id} data-testid={`card-activity-${activity.id}`}>\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center justify-between\">\n                          <div className=\"flex items-center gap-4\">\n                            <div className={`p-2 rounded-lg ${\n                              activity.status === \"completed\" ? \"bg-green-500/10\" :\n                              activity.status === \"in_progress\" ? \"bg-blue-500/10\" :\n                              activity.status === \"cancelled\" ? \"bg-red-500/10\" : \"bg-gray-500/10\"\n                            }`}>\n                              {activity.status === \"completed\" ? <CheckCircle2 className=\"h-5 w-5 text-green-500\" /> :\n                               activity.status === \"in_progress\" ? <Activity className=\"h-5 w-5 text-blue-500\" /> :\n                               activity.status === \"cancelled\" ? <AlertCircle className=\"h-5 w-5 text-red-500\" /> :\n                               <Clock className=\"h-5 w-5 text-gray-500\" />}\n                            </div>\n                            <div>\n                              <h4 className=\"font-semibold\">{activity.title}</h4>\n                              <p className=\"text-sm text-muted-foreground\">\n                                {ACTIVITY_TYPES.find(t => t.value === activity.type)?.label} • {formatDate(activity.scheduledDate)}\n                              </p>\n                            </div>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <Badge variant={\n                              activity.priority === \"critical\" ? \"destructive\" :\n                              activity.priority === \"high\" ? \"default\" :\n                              activity.priority === \"medium\" ? \"secondary\" : \"outline\"\n                            }>\n                              {activity.priority === \"critical\" ? \"Crítica\" :\n                               activity.priority === \"high\" ? \"Alta\" :\n                               activity.priority === \"medium\" ? \"Média\" : \"Baixa\"}\n                            </Badge>\n                            {activity.estimatedCost && (\n                              <span className=\"text-sm text-muted-foreground\">{formatCurrency(activity.estimatedCost)}</span>\n                            )}\n                          </div>\n                        </div>\n                        {activity.description && (\n                          <p className=\"text-sm text-muted-foreground mt-2 ml-14\">{activity.description}</p>\n                        )}\n                      </CardContent>\n                    </Card>\n                  ))\n                ) : (\n                  <Card>\n                    <CardContent className=\"p-12 text-center\">\n                      <Calendar className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                      <h3 className=\"text-lg font-semibold mb-2\">Nenhuma atividade</h3>\n                      <p className=\"text-muted-foreground\">Adicione eventos e ações para sua campanha</p>\n                    </CardContent>\n                  </Card>\n                )}\n              </div>\n            </TabsContent>\n\n            {/* Calendar Tab */}\n            <TabsContent value=\"calendar\" className=\"space-y-6\">\n              <div className=\"flex justify-between items-center\">\n                <h3 className=\"text-xl font-semibold\">Calendário de Atividades</h3>\n                <div className=\"flex items-center gap-2\">\n                  <Button \n                    variant=\"outline\" \n                    size=\"icon\"\n                    onClick={() => setCalendarDate(new Date(calendarDate.getFullYear(), calendarDate.getMonth() - 1, 1))}\n                    data-testid=\"button-calendar-prev\"\n                  >\n                    <ChevronLeft className=\"h-4 w-4\" />\n                  </Button>\n                  <span className=\"font-medium min-w-[150px] text-center\">\n                    {calendarDate.toLocaleDateString(\"pt-BR\", { month: \"long\", year: \"numeric\" })}\n                  </span>\n                  <Button \n                    variant=\"outline\" \n                    size=\"icon\"\n                    onClick={() => setCalendarDate(new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 1))}\n                    data-testid=\"button-calendar-next\"\n                  >\n                    <ChevronRightIcon className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              </div>\n\n              <Card>\n                <CardContent className=\"p-4\">\n                  {loadingCalendar ? (\n                    <div className=\"flex items-center justify-center h-64\">\n                      <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n                    </div>\n                  ) : (\n                  <>\n                  {/* Calendar Grid */}\n                  <div className=\"grid grid-cols-7 gap-1\">\n                    {[\"Dom\", \"Seg\", \"Ter\", \"Qua\", \"Qui\", \"Sex\", \"Sáb\"].map(day => (\n                      <div key={day} className=\"p-2 text-center text-sm font-medium text-muted-foreground\">\n                        {day}\n                      </div>\n                    ))}\n                    \n                    {/* Generate calendar days */}\n                    {(() => {\n                      const year = calendarDate.getFullYear();\n                      const month = calendarDate.getMonth();\n                      const firstDay = new Date(year, month, 1).getDay();\n                      const daysInMonth = new Date(year, month + 1, 0).getDate();\n                      const days = [];\n                      \n                      // Empty cells for days before the first of the month\n                      for (let i = 0; i < firstDay; i++) {\n                        days.push(<div key={`empty-${i}`} className=\"p-2 min-h-[100px]\" />);\n                      }\n                      \n                      // Days of the month\n                      for (let day = 1; day <= daysInMonth; day++) {\n                        const date = new Date(year, month, day);\n                        const dayActivities = calendarActivities?.filter((a: any) => {\n                          const actDate = new Date(a.scheduledDate);\n                          return actDate.getDate() === day && \n                                 actDate.getMonth() === month && \n                                 actDate.getFullYear() === year;\n                        }) || [];\n                        \n                        const isToday = new Date().toDateString() === date.toDateString();\n                        \n                        days.push(\n                          <div \n                            key={day} \n                            className={`p-2 min-h-[100px] border rounded-md ${isToday ? 'bg-primary/5 border-primary' : 'border-border'}`}\n                            data-testid={`calendar-day-${day}`}\n                          >\n                            <div className={`text-sm font-medium mb-1 ${isToday ? 'text-primary' : ''}`}>\n                              {day}\n                            </div>\n                            <div className=\"space-y-1\">\n                              {dayActivities.slice(0, 3).map((activity: any) => (\n                                <div \n                                  key={activity.id}\n                                  className={`text-xs p-1 rounded truncate ${\n                                    activity.type === 'event' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :\n                                    activity.type === 'meeting' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' :\n                                    activity.type === 'milestone' ? 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200' :\n                                    'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'\n                                  }`}\n                                  title={activity.title}\n                                >\n                                  {activity.title}\n                                </div>\n                              ))}\n                              {dayActivities.length > 3 && (\n                                <div className=\"text-xs text-muted-foreground\">\n                                  +{dayActivities.length - 3} mais\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                        );\n                      }\n                      \n                      return days;\n                    })()}\n                  </div>\n                  \n                  {/* Legend */}\n                  <div className=\"mt-4 flex flex-wrap gap-4 text-xs\">\n                    <div className=\"flex items-center gap-1\">\n                      <div className=\"w-3 h-3 rounded bg-blue-500\" />\n                      <span>Evento</span>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <div className=\"w-3 h-3 rounded bg-purple-500\" />\n                      <span>Reunião</span>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <div className=\"w-3 h-3 rounded bg-amber-500\" />\n                      <span>Marco</span>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <div className=\"w-3 h-3 rounded bg-green-500\" />\n                      <span>Ação</span>\n                    </div>\n                  </div>\n                  </>\n                  )}\n                </CardContent>\n              </Card>\n\n              {/* Upcoming activities list */}\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-lg\">Próximas Atividades</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {calendarActivities && calendarActivities.length > 0 ? (\n                    <div className=\"space-y-2\">\n                      {calendarActivities\n                        .filter((a: any) => new Date(a.scheduledDate) >= new Date())\n                        .slice(0, 5)\n                        .map((activity: any) => (\n                          <div key={activity.id} className=\"flex items-center justify-between p-3 bg-muted/50 rounded-md\">\n                            <div className=\"flex items-center gap-3\">\n                              <CalendarDays className=\"h-4 w-4 text-muted-foreground\" />\n                              <div>\n                                <p className=\"font-medium\">{activity.title}</p>\n                                <p className=\"text-sm text-muted-foreground\">{formatDate(activity.scheduledDate)}</p>\n                              </div>\n                            </div>\n                            <Badge variant={activity.priority === 'high' ? 'destructive' : activity.priority === 'critical' ? 'destructive' : 'secondary'}>\n                              {activity.priority === 'high' ? 'Alta' : activity.priority === 'critical' ? 'Crítica' : activity.priority === 'low' ? 'Baixa' : 'Média'}\n                            </Badge>\n                          </div>\n                        ))}\n                    </div>\n                  ) : (\n                    <p className=\"text-muted-foreground text-center py-8\">Nenhuma atividade programada</p>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            {/* KPI Goals Tab */}\n            <TabsContent value=\"kpi-goals\" className=\"space-y-6\">\n              <div className=\"flex justify-between items-center\">\n                <h3 className=\"text-xl font-semibold\">Metas de KPIs Estratégicos</h3>\n                <div className=\"flex gap-2\">\n                  <Button \n                    variant=\"outline\" \n                    onClick={fetchAiRecommendations}\n                    disabled={loadingRecommendations}\n                    data-testid=\"button-ai-recommendations\"\n                  >\n                    {loadingRecommendations ? <Loader2 className=\"h-4 w-4 animate-spin mr-2\" /> : <Sparkles className=\"h-4 w-4 mr-2\" />}\n                    Sugestões IA\n                  </Button>\n                  <Dialog open={showKpiGoalDialog} onOpenChange={setShowKpiGoalDialog}>\n                    <DialogTrigger asChild>\n                      <Button data-testid=\"button-add-kpi-goal\">\n                        <Flag className=\"h-4 w-4 mr-2\" />\n                        Nova Meta\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent>\n                      <DialogHeader>\n                        <DialogTitle>Criar Meta de KPI</DialogTitle>\n                        <DialogDescription>Defina uma meta estratégica para acompanhar</DialogDescription>\n                      </DialogHeader>\n                      <div className=\"space-y-4 py-4\">\n                        <div className=\"space-y-2\">\n                          <label className=\"text-sm font-medium\">Nome do KPI</label>\n                          <Select value={kpiFormKpiName} onValueChange={setKpiFormKpiName}>\n                            <SelectTrigger data-testid=\"select-kpi-name\">\n                              <SelectValue placeholder=\"Selecione o KPI\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"voter_reach\">Alcance de Eleitores</SelectItem>\n                              <SelectItem value=\"engagement_rate\">Taxa de Engajamento</SelectItem>\n                              <SelectItem value=\"conversion_rate\">Taxa de Conversão</SelectItem>\n                              <SelectItem value=\"sentiment_score\">Score de Sentimento</SelectItem>\n                              <SelectItem value=\"poll_position\">Posição em Pesquisas</SelectItem>\n                              <SelectItem value=\"donation_amount\">Valor de Doações</SelectItem>\n                              <SelectItem value=\"volunteer_count\">Número de Voluntários</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <div className=\"space-y-2\">\n                            <label className=\"text-sm font-medium\">Valor Meta</label>\n                            <Input value={kpiFormTargetValue} onChange={(e) => setKpiFormTargetValue(e.target.value)} type=\"number\" step=\"0.01\" data-testid=\"input-kpi-target\" />\n                          </div>\n                          <div className=\"space-y-2\">\n                            <label className=\"text-sm font-medium\">Valor Base</label>\n                            <Input value={kpiFormBaselineValue} onChange={(e) => setKpiFormBaselineValue(e.target.value)} type=\"number\" step=\"0.01\" data-testid=\"input-kpi-baseline\" />\n                          </div>\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <div className=\"space-y-2\">\n                            <label className=\"text-sm font-medium\">Unidade</label>\n                            <Select value={kpiFormUnit} onValueChange={setKpiFormUnit}>\n                              <SelectTrigger data-testid=\"select-kpi-unit\">\n                                <SelectValue placeholder=\"Unidade\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                <SelectItem value=\"percentage\">Percentual (%)</SelectItem>\n                                <SelectItem value=\"number\">Número</SelectItem>\n                                <SelectItem value=\"currency\">Moeda (R$)</SelectItem>\n                              </SelectContent>\n                            </Select>\n                          </div>\n                          <div className=\"space-y-2\">\n                            <label className=\"text-sm font-medium\">Prioridade</label>\n                            <Select value={kpiFormPriority} onValueChange={setKpiFormPriority}>\n                              <SelectTrigger data-testid=\"select-kpi-priority\">\n                                <SelectValue />\n                              </SelectTrigger>\n                              <SelectContent>\n                                <SelectItem value=\"low\">Baixa</SelectItem>\n                                <SelectItem value=\"medium\">Média</SelectItem>\n                                <SelectItem value=\"high\">Alta</SelectItem>\n                                <SelectItem value=\"critical\">Crítica</SelectItem>\n                              </SelectContent>\n                            </Select>\n                          </div>\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <div className=\"space-y-2\">\n                            <label className=\"text-sm font-medium\">Data Início</label>\n                            <Input value={kpiFormStartDate} onChange={(e) => setKpiFormStartDate(e.target.value)} type=\"date\" data-testid=\"input-kpi-start-date\" />\n                          </div>\n                          <div className=\"space-y-2\">\n                            <label className=\"text-sm font-medium\">Data Fim</label>\n                            <Input value={kpiFormEndDate} onChange={(e) => setKpiFormEndDate(e.target.value)} type=\"date\" data-testid=\"input-kpi-end-date\" />\n                          </div>\n                        </div>\n                      </div>\n                      <DialogFooter>\n                        <Button variant=\"outline\" onClick={() => setShowKpiGoalDialog(false)}>Cancelar</Button>\n                        <Button \n                          onClick={() => {\n                            if (kpiFormKpiName && kpiFormTargetValue) {\n                              createKpiGoalMutation.mutate({\n                                kpiName: kpiFormKpiName,\n                                targetValue: kpiFormTargetValue,\n                                baselineValue: kpiFormBaselineValue || null,\n                                unit: kpiFormUnit,\n                                priority: kpiFormPriority,\n                                startDate: kpiFormStartDate || null,\n                                endDate: kpiFormEndDate || null,\n                              });\n                            }\n                          }}\n                          disabled={createKpiGoalMutation.isPending || !kpiFormKpiName || !kpiFormTargetValue}\n                          data-testid=\"button-submit-kpi-goal\"\n                        >\n                          {createKpiGoalMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : \"Criar Meta\"}\n                        </Button>\n                      </DialogFooter>\n                    </DialogContent>\n                  </Dialog>\n                </div>\n              </div>\n\n              {/* AI Recommendations */}\n              {aiRecommendations.length > 0 && (\n                <Card className=\"border-primary/50 bg-primary/5\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <Sparkles className=\"h-5 w-5 text-primary\" />\n                      Recomendações de IA\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"grid gap-3 md:grid-cols-2 lg:grid-cols-3\">\n                      {aiRecommendations.map((rec: any, index: number) => (\n                        <Card key={index} className=\"bg-background\">\n                          <CardContent className=\"p-4\">\n                            <div className=\"flex justify-between items-start mb-2\">\n                              <p className=\"font-medium\">{rec.kpiName}</p>\n                              <Badge variant={rec.priority === 'high' ? 'destructive' : 'secondary'}>\n                                {rec.priority === 'high' ? 'Alta' : rec.priority === 'low' ? 'Baixa' : 'Média'}\n                              </Badge>\n                            </div>\n                            <p className=\"text-2xl font-bold text-primary mb-2\">{rec.suggestedTarget}</p>\n                            <p className=\"text-sm text-muted-foreground mb-3\">{rec.rationale}</p>\n                            <div className=\"flex items-center justify-between\">\n                              <span className=\"text-xs text-muted-foreground\">Confiança: {rec.confidence}%</span>\n                              <Button \n                                size=\"sm\" \n                                variant=\"outline\"\n                                onClick={() => createKpiGoalMutation.mutate({\n                                  kpiName: rec.kpiName,\n                                  targetValue: rec.suggestedTarget,\n                                  priority: rec.priority,\n                                  aiRecommendation: rec.rationale,\n                                  aiConfidence: rec.confidence,\n                                })}\n                                data-testid={`button-use-ai-rec-${index}`}\n                              >\n                                Usar\n                              </Button>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              {/* KPI Goals List */}\n              {kpiGoals && kpiGoals.length > 0 ? (\n                <div className=\"grid gap-4\">\n                  {kpiGoals.map((goal: any) => {\n                    const currentVal = parseFloat(goal.currentValue || 0);\n                    const targetVal = parseFloat(goal.targetValue);\n                    const baselineVal = parseFloat(goal.baselineValue || 0);\n                    const progress = targetVal > baselineVal \n                      ? Math.min(100, ((currentVal - baselineVal) / (targetVal - baselineVal)) * 100)\n                      : 0;\n                    \n                    return (\n                      <Card key={goal.id} data-testid={`card-kpi-goal-${goal.id}`}>\n                        <CardContent className=\"p-6\">\n                          <div className=\"flex items-start justify-between mb-4\">\n                            <div>\n                              <div className=\"flex items-center gap-2 mb-1\">\n                                <h4 className=\"font-semibold text-lg\">\n                                  {goal.kpiName === 'voter_reach' ? 'Alcance de Eleitores' :\n                                   goal.kpiName === 'engagement_rate' ? 'Taxa de Engajamento' :\n                                   goal.kpiName === 'conversion_rate' ? 'Taxa de Conversão' :\n                                   goal.kpiName === 'sentiment_score' ? 'Score de Sentimento' :\n                                   goal.kpiName === 'poll_position' ? 'Posição em Pesquisas' :\n                                   goal.kpiName}\n                                </h4>\n                                <Badge variant={\n                                  goal.status === 'achieved' ? 'default' : \n                                  goal.status === 'missed' ? 'destructive' : 'outline'\n                                }>\n                                  {goal.status === 'achieved' ? 'Alcançada' :\n                                   goal.status === 'missed' ? 'Não Alcançada' :\n                                   goal.status === 'cancelled' ? 'Cancelada' : 'Ativa'}\n                                </Badge>\n                                <Badge variant=\"secondary\">\n                                  {goal.priority === 'critical' ? 'Crítica' :\n                                   goal.priority === 'high' ? 'Alta' :\n                                   goal.priority === 'low' ? 'Baixa' : 'Média'}\n                                </Badge>\n                              </div>\n                              {goal.aiRecommendation && (\n                                <p className=\"text-sm text-muted-foreground flex items-center gap-1\">\n                                  <Sparkles className=\"h-3 w-3\" />\n                                  {goal.aiRecommendation}\n                                </p>\n                              )}\n                            </div>\n                            <Button \n                              size=\"icon\" \n                              variant=\"ghost\"\n                              onClick={() => deleteKpiGoalMutation.mutate(goal.id)}\n                              data-testid={`button-delete-kpi-${goal.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4 text-destructive\" />\n                            </Button>\n                          </div>\n                          \n                          <div className=\"space-y-3\">\n                            <div className=\"flex justify-between text-sm\">\n                              <span>Progresso</span>\n                              <span className=\"font-medium\">{progress.toFixed(1)}%</span>\n                            </div>\n                            <Progress value={progress} className=\"h-2\" />\n                            <div className=\"grid grid-cols-3 gap-4 text-center\">\n                              <div className=\"p-3 bg-muted/50 rounded-md\">\n                                <p className=\"text-xs text-muted-foreground\">Base</p>\n                                <p className=\"font-semibold\">{baselineVal.toLocaleString(\"pt-BR\")}{goal.unit === 'percentage' ? '%' : ''}</p>\n                              </div>\n                              <div className=\"p-3 bg-primary/10 rounded-md\">\n                                <p className=\"text-xs text-muted-foreground\">Atual</p>\n                                <p className=\"font-semibold text-primary\">{currentVal.toLocaleString(\"pt-BR\")}{goal.unit === 'percentage' ? '%' : ''}</p>\n                              </div>\n                              <div className=\"p-3 bg-muted/50 rounded-md\">\n                                <p className=\"text-xs text-muted-foreground\">Meta</p>\n                                <p className=\"font-semibold\">{targetVal.toLocaleString(\"pt-BR\")}{goal.unit === 'percentage' ? '%' : ''}</p>\n                              </div>\n                            </div>\n                            {goal.startDate && goal.endDate && (\n                              <p className=\"text-xs text-muted-foreground text-center\">\n                                Período: {formatDate(goal.startDate)} - {formatDate(goal.endDate)}\n                              </p>\n                            )}\n                          </div>\n                        </CardContent>\n                      </Card>\n                    );\n                  })}\n                </div>\n              ) : (\n                <Card>\n                  <CardContent className=\"p-12 text-center\">\n                    <Flag className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n                    <h3 className=\"text-xl font-semibold mb-2\">Nenhuma meta definida</h3>\n                    <p className=\"text-muted-foreground mb-4\">Defina metas de KPIs para acompanhar o progresso da campanha</p>\n                    <div className=\"flex gap-2 justify-center\">\n                      <Button variant=\"outline\" onClick={fetchAiRecommendations} disabled={loadingRecommendations}>\n                        {loadingRecommendations ? <Loader2 className=\"h-4 w-4 animate-spin mr-2\" /> : <Sparkles className=\"h-4 w-4 mr-2\" />}\n                        Obter Sugestões IA\n                      </Button>\n                      <Button onClick={() => setShowKpiGoalDialog(true)}>\n                        <Flag className=\"h-4 w-4 mr-2\" />\n                        Criar Meta Manualmente\n                      </Button>\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"performance\" className=\"space-y-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-xl font-semibold\">Desempenho e Métricas</h2>\n                  <p className=\"text-muted-foreground\">Acompanhe os KPIs da campanha em tempo real</p>\n                </div>\n                <Dialog open={showMetricDialog} onOpenChange={setShowMetricDialog}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-add-metric\">\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Registrar Métrica\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle>Registrar Métrica</DialogTitle>\n                    </DialogHeader>\n                    <Form {...metricForm}>\n                      <form onSubmit={metricForm.handleSubmit((data) => createMetricMutation.mutate(data))} className=\"space-y-4\">\n                        <FormField\n                          control={metricForm.control}\n                          name=\"kpiName\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Nome do KPI</FormLabel>\n                              <Select onValueChange={field.onChange}>\n                                <FormControl>\n                                  <SelectTrigger data-testid=\"select-metric-kpi\">\n                                    <SelectValue placeholder=\"Selecione ou digite\" />\n                                  </SelectTrigger>\n                                </FormControl>\n                                <SelectContent>\n                                  <SelectItem value=\"voter_reach\">Alcance de Eleitores</SelectItem>\n                                  <SelectItem value=\"engagement_rate\">Taxa de Engajamento</SelectItem>\n                                  <SelectItem value=\"conversion_rate\">Taxa de Conversão</SelectItem>\n                                  <SelectItem value=\"sentiment_score\">Score de Sentimento</SelectItem>\n                                  <SelectItem value=\"poll_position\">Posição nas Pesquisas</SelectItem>\n                                  <SelectItem value=\"social_followers\">Seguidores Redes Sociais</SelectItem>\n                                  <SelectItem value=\"events_attendance\">Presença em Eventos</SelectItem>\n                                </SelectContent>\n                              </Select>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={metricForm.control}\n                            name=\"kpiValue\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Valor</FormLabel>\n                                <FormControl>\n                                  <Input type=\"number\" step=\"0.01\" {...field} data-testid=\"input-metric-value\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={metricForm.control}\n                            name=\"targetValue\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Meta</FormLabel>\n                                <FormControl>\n                                  <Input type=\"number\" step=\"0.01\" {...field} data-testid=\"input-metric-target\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={metricForm.control}\n                            name=\"metricDate\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Data</FormLabel>\n                                <FormControl>\n                                  <Input type=\"date\" {...field} data-testid=\"input-metric-date\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={metricForm.control}\n                            name=\"source\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Fonte</FormLabel>\n                                <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-metric-source\">\n                                      <SelectValue />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"manual\">Manual</SelectItem>\n                                    <SelectItem value=\"ai_analysis\">Análise IA</SelectItem>\n                                    <SelectItem value=\"survey\">Pesquisa</SelectItem>\n                                    <SelectItem value=\"social_media\">Redes Sociais</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                        <DialogFooter>\n                          <Button type=\"submit\" disabled={createMetricMutation.isPending} data-testid=\"button-submit-metric\">\n                            {createMetricMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                            Registrar\n                          </Button>\n                        </DialogFooter>\n                      </form>\n                    </Form>\n                  </DialogContent>\n                </Dialog>\n              </div>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Evolução das Métricas</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {metricsChartData.length > 0 ? (\n                    <div className=\"h-64\">\n                      <ResponsiveContainer width=\"100%\" height=\"100%\">\n                        <LineChart data={metricsChartData}>\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis dataKey=\"date\" />\n                          <YAxis />\n                          <Tooltip />\n                          <Legend />\n                          <Line type=\"monotone\" dataKey=\"value\" name=\"Valor\" stroke=\"#003366\" strokeWidth={2} />\n                          <Line type=\"monotone\" dataKey=\"target\" name=\"Meta\" stroke=\"#FFD700\" strokeWidth={2} strokeDasharray=\"5 5\" />\n                        </LineChart>\n                      </ResponsiveContainer>\n                    </div>\n                  ) : (\n                    <p className=\"text-muted-foreground text-center py-12\">Nenhuma métrica registrada</p>\n                  )}\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Histórico de Métricas</CardTitle>\n                </CardHeader>\n                <CardContent className=\"p-0\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Data</TableHead>\n                        <TableHead>KPI</TableHead>\n                        <TableHead className=\"text-right\">Valor</TableHead>\n                        <TableHead className=\"text-right\">Meta</TableHead>\n                        <TableHead>Fonte</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {campaignDetail.metrics.slice(0, 20).map((metric: any) => (\n                        <TableRow key={metric.id} data-testid={`row-metric-${metric.id}`}>\n                          <TableCell>{formatDate(metric.metricDate)}</TableCell>\n                          <TableCell>{metric.kpiName}</TableCell>\n                          <TableCell className=\"text-right font-medium\">{parseFloat(metric.kpiValue).toLocaleString(\"pt-BR\")}</TableCell>\n                          <TableCell className=\"text-right text-muted-foreground\">\n                            {metric.targetValue ? parseFloat(metric.targetValue).toLocaleString(\"pt-BR\") : \"-\"}\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant=\"outline\">{metric.source || \"manual\"}</Badge>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                      {campaignDetail.metrics.length === 0 && (\n                        <TableRow>\n                          <TableCell colSpan={5} className=\"text-center text-muted-foreground py-8\">\n                            Nenhuma métrica registrada\n                          </TableCell>\n                        </TableRow>\n                      )}\n                    </TableBody>\n                  </Table>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"ai\" className=\"space-y-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-xl font-semibold\">IA Estratégica</h2>\n                  <p className=\"text-muted-foreground\">Insights do Estrategista de Campanha com GPT-4o</p>\n                </div>\n              </div>\n\n              {campaignDetail.aiSession ? (\n                <div className=\"space-y-6\">\n                  <Card className=\"border-primary/20\">\n                    <CardHeader>\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"p-2 rounded-lg bg-gradient-to-br from-purple-500 to-blue-600\">\n                          <Brain className=\"h-6 w-6 text-white\" />\n                        </div>\n                        <div>\n                          <CardTitle>Sessão de IA Vinculada</CardTitle>\n                          <CardDescription>{campaignDetail.aiSession.name}</CardDescription>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Ano Eleitoral</p>\n                          <p className=\"font-medium\">{campaignDetail.aiSession.electionYear}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Região</p>\n                          <p className=\"font-medium\">{campaignDetail.aiSession.targetRegion || \"-\"}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Status</p>\n                          <Badge variant=\"outline\">{campaignDetail.aiSession.status}</Badge>\n                        </div>\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Criada em</p>\n                          <p className=\"font-medium\">{formatDate(campaignDetail.aiSession.createdAt)}</p>\n                        </div>\n                      </div>\n                      <div className=\"mt-4\">\n                        <Button onClick={() => navigate(\"/campaign-insights\")} data-testid=\"button-view-ai-session\">\n                          <Brain className=\"h-4 w-4 mr-2\" />\n                          Abrir Análises Completas\n                        </Button>\n                      </div>\n                    </CardContent>\n                  </Card>\n                </div>\n              ) : (\n                <Card>\n                  <CardContent className=\"p-12 text-center\">\n                    <Brain className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n                    <h3 className=\"text-xl font-semibold mb-2\">Vincular Análise de IA</h3>\n                    <p className=\"text-muted-foreground mb-6 max-w-md mx-auto\">\n                      Conecte esta campanha a uma sessão do Estrategista de Campanha IA para obter insights avançados sobre segmentos, \n                      estratégias de mensagem e previsões de impacto.\n                    </p>\n                    {aiSessions && aiSessions.length > 0 ? (\n                      <div className=\"space-y-4\">\n                        <Select onValueChange={(value) => linkAiSessionMutation.mutate(parseInt(value))}>\n                          <SelectTrigger className=\"max-w-md mx-auto\" data-testid=\"select-link-ai-session\">\n                            <SelectValue placeholder=\"Selecione uma sessão de IA\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {aiSessions.map((session: any) => (\n                              <SelectItem key={session.id} value={session.id.toString()}>\n                                {session.name} ({session.electionYear})\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <p className=\"text-sm text-muted-foreground\">ou</p>\n                        <Button variant=\"outline\" onClick={() => navigate(\"/campaign-insights\")} data-testid=\"button-create-ai-session\">\n                          <Plus className=\"h-4 w-4 mr-2\" />\n                          Criar Nova Sessão de IA\n                        </Button>\n                      </div>\n                    ) : (\n                      <Button onClick={() => navigate(\"/campaign-insights\")} data-testid=\"button-go-ai-insights\">\n                        <Brain className=\"h-4 w-4 mr-2\" />\n                        Ir para Estrategista de Campanha\n                      </Button>\n                    )}\n                  </CardContent>\n                </Card>\n              )}\n            </TabsContent>\n          </>\n        )}\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":114026,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"server/sentiment-analysis.ts":{"content":"import OpenAI from \"openai\";\nimport { storage } from \"./storage\";\nimport type { InsertSentimentAnalysisResult, InsertSentimentKeyword } from \"@shared/schema\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\nexport interface SentimentSource {\n  type: \"news\" | \"blog\" | \"forum\" | \"social\";\n  name: string;\n  country: string;\n  articles: {\n    title: string;\n    content: string;\n    date: string;\n    url?: string;\n    author?: string;\n  }[];\n}\n\nexport interface EntitySentiment {\n  entityType: \"party\" | \"candidate\";\n  entityId: string;\n  entityName: string;\n  sentimentScore: number;\n  sentimentLabel: \"positive\" | \"negative\" | \"neutral\" | \"mixed\";\n  confidence: number;\n  mentionCount: number;\n  keywords: { word: string; count: number; sentiment: number }[];\n  sampleMentions: string[];\n}\n\nexport interface SentimentAnalysisResponse {\n  overallSentiment: \"positive\" | \"negative\" | \"neutral\" | \"mixed\";\n  overallScore: number;\n  confidence: number;\n  entities: EntitySentiment[];\n  keywords: { word: string; count: number; sentiment: number }[];\n  sourceBreakdown: Record<string, { count: number; avgSentiment: number }>;\n  timeline: { date: string; sentiment: number; volume: number }[];\n  summary: string;\n  generatedAt: string;\n}\n\nconst SIMULATED_SOURCES: SentimentSource[] = [\n  {\n    type: \"news\",\n    name: \"Folha de São Paulo\",\n    country: \"BR\",\n    articles: [\n      {\n        title: \"Eleições 2024: PT lidera intenções de voto em capitais\",\n        content: \"Pesquisa recente mostra crescimento do PT nas principais capitais brasileiras. Candidatos do partido apresentam propostas focadas em educação e saúde. Analistas apontam recuperação da imagem do partido após reformulação interna.\",\n        date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),\n      },\n      {\n        title: \"PL aposta em candidatos evangélicos para disputas municipais\",\n        content: \"O partido tem investido fortemente em candidaturas ligadas a igrejas evangélicas. Estratégia visa consolidar base eleitoral conservadora. Críticos questionam mistura de religião e política.\",\n        date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),\n      },\n    ]\n  },\n  {\n    type: \"news\",\n    name: \"O Globo\",\n    country: \"BR\",\n    articles: [\n      {\n        title: \"MDB busca renovação com novos candidatos para 2024\",\n        content: \"Partido tradicional investe em perfis jovens e progressistas. Líderes históricos cedem espaço para nova geração. Mudança estratégica busca atrair eleitores moderados.\",\n        date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),\n      },\n      {\n        title: \"PSDB enfrenta crise de identidade nas eleições\",\n        content: \"Partido passa por momento de redefinição ideológica. Dissidências internas enfraquecem posicionamento. Candidatos buscam distanciamento de governos anteriores.\",\n        date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),\n      },\n    ]\n  },\n  {\n    type: \"blog\",\n    name: \"Blog Política Brasil\",\n    country: \"BR\",\n    articles: [\n      {\n        title: \"Análise: O que esperar das eleições municipais\",\n        content: \"A polarização entre esquerda e direita deve continuar marcando as disputas. Partidos de centro tentam se posicionar como alternativa viável. Economia local será tema central dos debates.\",\n        date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),\n      },\n    ]\n  },\n  {\n    type: \"forum\",\n    name: \"Fórum Democracia Digital\",\n    country: \"BR\",\n    articles: [\n      {\n        title: \"Discussão: Transparência nas campanhas eleitorais\",\n        content: \"Usuários debatem necessidade de maior fiscalização de gastos de campanha. Propostas incluem auditorias independentes e prestação de contas em tempo real. Participantes citam exemplos de irregularidades passadas.\",\n        date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),\n      },\n    ]\n  },\n  {\n    type: \"news\",\n    name: \"El País Brasil\",\n    country: \"ES\",\n    articles: [\n      {\n        title: \"Brasil: elecciones municipales generan expectativas internacionales\",\n        content: \"Observadores internacionales analizan el panorama político brasileño. Las elecciones pueden indicar tendencias para 2026. Partidos de izquierda y derecha disputan con intensidad.\",\n        date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),\n      },\n    ]\n  },\n  {\n    type: \"news\",\n    name: \"The Guardian - Americas\",\n    country: \"UK\",\n    articles: [\n      {\n        title: \"Brazilian municipal elections: what to expect\",\n        content: \"Local elections in Brazil are often a preview of national trends. Major parties are investing heavily in key cities. Environmental and economic policies dominate campaign discussions.\",\n        date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),\n      },\n    ]\n  },\n];\n\nexport async function fetchSentimentSources(): Promise<SentimentSource[]> {\n  return SIMULATED_SOURCES;\n}\n\nexport async function analyzeSentimentWithAI(\n  sources: SentimentSource[],\n  targetEntities?: { type: \"party\" | \"candidate\"; id: string; name: string }[]\n): Promise<SentimentAnalysisResponse> {\n  const allContent = sources.flatMap(source => \n    source.articles.map(article => ({\n      source: source.name,\n      sourceType: source.type,\n      country: source.country,\n      ...article\n    }))\n  );\n\n  if (allContent.length === 0) {\n    return {\n      overallSentiment: \"neutral\",\n      overallScore: 0,\n      confidence: 0,\n      entities: [],\n      keywords: [],\n      sourceBreakdown: {},\n      timeline: [],\n      summary: \"Nenhum conteúdo disponível para análise.\",\n      generatedAt: new Date().toISOString(),\n    };\n  }\n\n  const contentForAnalysis = allContent.slice(0, 20).map((a, i) => \n    `[${i+1}] [${a.sourceType.toUpperCase()}/${a.source}/${a.country}] ${a.title}\\n${a.content}`\n  ).join(\"\\n\\n\");\n\n  const entitiesHint = targetEntities && targetEntities.length > 0\n    ? `\\nEntidades para análise específica: ${targetEntities.map(e => `${e.name} (${e.type})`).join(\", \")}`\n    : \"\\nAnalise menções a partidos políticos brasileiros (PT, PL, MDB, PSDB, etc.) e candidatos relevantes.\";\n\n  const prompt = `Você é um especialista em análise de sentimento político e eleitoral.\nAnalise o seguinte conteúdo de múltiplas fontes e forneça uma análise de sentimento detalhada.\n\nCONTEÚDO PARA ANÁLISE:\n${contentForAnalysis}\n${entitiesHint}\n\nResponda em JSON com a seguinte estrutura:\n{\n  \"overallSentiment\": \"positive\" | \"negative\" | \"neutral\" | \"mixed\",\n  \"overallScore\": número_de_-1_a_1,\n  \"confidence\": número_de_0_a_1,\n  \"entities\": [\n    {\n      \"entityType\": \"party\" | \"candidate\",\n      \"entityId\": \"sigla_ou_id\",\n      \"entityName\": \"nome_completo\",\n      \"sentimentScore\": número_de_-1_a_1,\n      \"sentimentLabel\": \"positive\" | \"negative\" | \"neutral\" | \"mixed\",\n      \"confidence\": número_de_0_a_1,\n      \"mentionCount\": número,\n      \"keywords\": [{ \"word\": \"palavra\", \"count\": número, \"sentiment\": número_-1_a_1 }],\n      \"sampleMentions\": [\"trecho_exemplo_1\", \"trecho_exemplo_2\"]\n    }\n  ],\n  \"keywords\": [\n    { \"word\": \"palavra_chave\", \"count\": frequência, \"sentiment\": número_-1_a_1 }\n  ],\n  \"sourceBreakdown\": {\n    \"news\": { \"count\": número_artigos, \"avgSentiment\": número_-1_a_1 },\n    \"blog\": { \"count\": número, \"avgSentiment\": número },\n    \"forum\": { \"count\": número, \"avgSentiment\": número }\n  },\n  \"timeline\": [\n    { \"date\": \"YYYY-MM-DD\", \"sentiment\": número_-1_a_1, \"volume\": número_menções }\n  ],\n  \"summary\": \"resumo_detalhado_da_análise_em_português\"\n}\n\nImportante:\n- Extraia pelo menos 20-30 palavras-chave relevantes para nuvem de palavras\n- Agrupe as palavras por tema (economia, saúde, educação, corrupção, etc.)\n- Identifique tendências temporais quando possível\n- Considere o tom e contexto das menções`;\n\n  const completion = await openai.chat.completions.create({\n    model: \"gpt-4o\",\n    messages: [{ role: \"user\", content: prompt }],\n    response_format: { type: \"json_object\" },\n    max_completion_tokens: 4000,\n  });\n\n  const content = completion.choices[0]?.message?.content;\n  if (!content) {\n    throw new Error(\"No response from AI\");\n  }\n\n  const result = JSON.parse(content);\n  return {\n    ...result,\n    generatedAt: new Date().toISOString(),\n  };\n}\n\nexport async function runSentimentAnalysis(\n  options?: {\n    entityType?: \"party\" | \"candidate\";\n    entityId?: string;\n    days?: number;\n  }\n): Promise<SentimentAnalysisResponse> {\n  const sources = await fetchSentimentSources();\n  \n  const targetEntities = options?.entityId ? [{\n    type: options.entityType || \"party\",\n    id: options.entityId,\n    name: options.entityId,\n  }] : undefined;\n\n  const analysis = await analyzeSentimentWithAI(sources, targetEntities as any);\n\n  for (const entity of analysis.entities) {\n    const resultData: InsertSentimentAnalysisResult = {\n      entityType: entity.entityType,\n      entityId: entity.entityId,\n      entityName: entity.entityName,\n      analysisDate: new Date(),\n      sentimentScore: String(entity.sentimentScore),\n      sentimentLabel: entity.sentimentLabel,\n      confidence: String(entity.confidence),\n      mentionCount: entity.mentionCount,\n      positiveCount: entity.sentimentScore > 0.3 ? entity.mentionCount : 0,\n      negativeCount: entity.sentimentScore < -0.3 ? entity.mentionCount : 0,\n      neutralCount: Math.abs(entity.sentimentScore) <= 0.3 ? entity.mentionCount : 0,\n      sourceBreakdown: analysis.sourceBreakdown,\n      topKeywords: entity.keywords.slice(0, 20),\n      sampleMentions: entity.sampleMentions,\n    };\n    \n    await storage.createSentimentResult(resultData);\n\n    for (const keyword of entity.keywords) {\n      await storage.upsertKeyword({\n        keyword: keyword.word,\n        entityType: entity.entityType,\n        entityId: entity.entityId,\n        frequency: keyword.count,\n        averageSentiment: String(keyword.sentiment),\n        trendDirection: keyword.sentiment > 0.2 ? \"rising\" : keyword.sentiment < -0.2 ? \"falling\" : \"stable\",\n      });\n    }\n  }\n\n  for (const keyword of analysis.keywords) {\n    await storage.upsertKeyword({\n      keyword: keyword.word,\n      frequency: keyword.count,\n      averageSentiment: String(keyword.sentiment),\n      trendDirection: keyword.sentiment > 0.2 ? \"rising\" : keyword.sentiment < -0.2 ? \"falling\" : \"stable\",\n    });\n  }\n\n  return analysis;\n}\n\nexport async function getSentimentTimeline(\n  entityType: string,\n  entityId: string,\n  days: number = 30\n): Promise<{ date: string; sentiment: number; volume: number }[]> {\n  const timeline = await storage.getSentimentTimeline(entityType, entityId, days);\n  \n  return timeline.map(t => ({\n    date: t.date.toISOString().split(\"T\")[0],\n    sentiment: t.sentimentScore,\n    volume: t.mentionCount,\n  }));\n}\n\nexport async function getWordCloudData(\n  entityType?: string,\n  entityId?: string,\n  limit: number = 100\n): Promise<{ text: string; value: number; sentiment: number }[]> {\n  const data = await storage.getWordCloudData(entityType, entityId, limit);\n  \n  return data.map(d => ({\n    text: d.word,\n    value: d.value,\n    sentiment: d.sentiment,\n  }));\n}\n\nexport async function getEntitiesSentimentOverview(): Promise<{\n  parties: EntitySentiment[];\n  candidates: EntitySentiment[];\n}> {\n  const partyResults = await storage.getSentimentResults({ entityType: \"party\", limit: 20 });\n  const candidateResults = await storage.getSentimentResults({ entityType: \"candidate\", limit: 20 });\n\n  const mapToEntity = (r: any): EntitySentiment => ({\n    entityType: r.entityType,\n    entityId: r.entityId,\n    entityName: r.entityName,\n    sentimentScore: parseFloat(String(r.sentimentScore)),\n    sentimentLabel: r.sentimentLabel,\n    confidence: parseFloat(String(r.confidence)),\n    mentionCount: r.mentionCount || 0,\n    keywords: (r.topKeywords as any[]) || [],\n    sampleMentions: (r.sampleMentions as string[]) || [],\n  });\n\n  return {\n    parties: partyResults.map(mapToEntity),\n    candidates: candidateResults.map(mapToEntity),\n  };\n}\n","path":null,"size_bytes":12202,"size_tokens":null},"server/notification-service.ts":{"content":"import { db } from \"./db\";\nimport { inAppNotifications, alertConfigurations, users, sentimentCrisisAlerts } from \"@shared/schema\";\nimport { eq, and, desc, sql } from \"drizzle-orm\";\nimport { sendNotificationToUser, emitNewCrisisAlert, emitAlertAcknowledged } from \"./websocket\";\n\ninterface CrisisAlertData {\n  id: number;\n  entityType: string;\n  entityId: string;\n  entityName: string;\n  alertType: string;\n  severity: string;\n  title: string;\n  description: string | null;\n  sentimentBefore: number;\n  sentimentAfter: number;\n  sentimentChange: number;\n  mentionCount: number;\n  detectedAt: Date;\n}\n\nexport async function createInAppNotification(params: {\n  userId: string;\n  type: string;\n  severity: string;\n  title: string;\n  message: string;\n  actionUrl?: string;\n  relatedEntityType?: string;\n  relatedEntityId?: string;\n  metadata?: Record<string, unknown>;\n}): Promise<void> {\n  const [notification] = await db.insert(inAppNotifications).values({\n    userId: params.userId,\n    type: params.type,\n    severity: params.severity,\n    title: params.title,\n    message: params.message,\n    actionUrl: params.actionUrl,\n    relatedEntityType: params.relatedEntityType,\n    relatedEntityId: params.relatedEntityId,\n    metadata: params.metadata || {},\n  }).returning();\n\n  sendNotificationToUser(params.userId, {\n    id: notification.id,\n    type: params.type,\n    severity: params.severity,\n    title: params.title,\n    message: params.message,\n    actionUrl: params.actionUrl,\n  });\n}\n\nexport async function notifyAllAnalystsOfCrisis(alertData: CrisisAlertData): Promise<void> {\n  const alertForEmit = {\n    ...alertData,\n    description: alertData.description || `Alerta de crise detectado para ${alertData.entityName}`\n  };\n  \n  const analysts = await db.select()\n    .from(users)\n    .where(\n      sql`${users.role} IN ('admin', 'analyst') AND ${users.active} = true`\n    );\n\n  for (const analyst of analysts) {\n    await createInAppNotification({\n      userId: analyst.id,\n      type: \"crisis_alert\",\n      severity: alertData.severity,\n      title: alertData.title,\n      message: alertData.description || `Alerta de crise detectado para ${alertData.entityName}`,\n      actionUrl: `/sentiment-analysis?tab=alertas`,\n      relatedEntityType: alertData.entityType,\n      relatedEntityId: alertData.entityId,\n      metadata: {\n        alertId: alertData.id,\n        sentimentChange: alertData.sentimentChange,\n        mentionCount: alertData.mentionCount,\n      },\n    });\n  }\n\n  emitNewCrisisAlert(alertForEmit);\n}\n\nexport async function sendCrisisEmailNotification(alertData: CrisisAlertData): Promise<void> {\n  const resendApiKey = process.env.RESEND_API_KEY;\n  if (!resendApiKey) {\n    console.log(\"Resend API key not configured, skipping email notification\");\n    return;\n  }\n\n  try {\n    const configs = await db.select()\n      .from(alertConfigurations)\n      .where(\n        and(\n          eq(alertConfigurations.isActive, true),\n          eq(alertConfigurations.notifyEmail, true)\n        )\n      );\n\n    const emailRecipients = new Set<string>();\n    \n    for (const config of configs) {\n      const recipients = config.emailRecipients as string[] || [];\n      recipients.forEach(email => emailRecipients.add(email));\n    }\n\n    const analysts = await db.select()\n      .from(users)\n      .where(\n        sql`${users.role} IN ('admin', 'analyst') AND ${users.active} = true`\n      );\n    analysts.forEach(a => emailRecipients.add(a.email));\n\n    if (emailRecipients.size === 0) {\n      console.log(\"No email recipients configured\");\n      return;\n    }\n\n    const severityLabels: Record<string, string> = {\n      critical: \"CRÍTICO\",\n      high: \"ALTO\",\n      medium: \"MÉDIO\",\n      low: \"BAIXO\"\n    };\n\n    const { Resend } = await import(\"resend\");\n    const resend = new Resend(resendApiKey);\n\n    const emailContent = `\n      <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n        <div style=\"background: #003366; color: white; padding: 20px; text-align: center;\">\n          <h1 style=\"margin: 0;\">SimulaVoto - Alerta de Crise</h1>\n        </div>\n        <div style=\"padding: 20px; background: ${alertData.severity === 'critical' ? '#fee2e2' : alertData.severity === 'high' ? '#fef3c7' : '#f3f4f6'};\">\n          <div style=\"background: ${alertData.severity === 'critical' ? '#dc2626' : alertData.severity === 'high' ? '#f59e0b' : '#6b7280'}; color: white; padding: 8px 16px; border-radius: 4px; display: inline-block; margin-bottom: 16px;\">\n            ${severityLabels[alertData.severity] || alertData.severity.toUpperCase()}\n          </div>\n          <h2 style=\"color: #1f2937; margin-top: 0;\">${alertData.title}</h2>\n          <p style=\"color: #4b5563;\">${alertData.description || 'Alerta detectado pelo sistema de monitoramento de sentimento.'}</p>\n          \n          <div style=\"background: white; border-radius: 8px; padding: 16px; margin-top: 16px;\">\n            <h3 style=\"margin-top: 0; color: #1f2937;\">Detalhes do Alerta</h3>\n            <table style=\"width: 100%; border-collapse: collapse;\">\n              <tr>\n                <td style=\"padding: 8px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280;\">Entidade:</td>\n                <td style=\"padding: 8px 0; border-bottom: 1px solid #e5e7eb; font-weight: bold;\">${alertData.entityName} (${alertData.entityType})</td>\n              </tr>\n              <tr>\n                <td style=\"padding: 8px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280;\">Tipo de Alerta:</td>\n                <td style=\"padding: 8px 0; border-bottom: 1px solid #e5e7eb;\">${alertData.alertType.replace(/_/g, ' ')}</td>\n              </tr>\n              <tr>\n                <td style=\"padding: 8px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280;\">Sentimento Anterior:</td>\n                <td style=\"padding: 8px 0; border-bottom: 1px solid #e5e7eb;\">${(alertData.sentimentBefore * 100).toFixed(1)}%</td>\n              </tr>\n              <tr>\n                <td style=\"padding: 8px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280;\">Sentimento Atual:</td>\n                <td style=\"padding: 8px 0; border-bottom: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;\">${(alertData.sentimentAfter * 100).toFixed(1)}%</td>\n              </tr>\n              <tr>\n                <td style=\"padding: 8px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280;\">Queda:</td>\n                <td style=\"padding: 8px 0; border-bottom: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;\">${(Math.abs(alertData.sentimentChange) * 100).toFixed(1)}%</td>\n              </tr>\n              <tr>\n                <td style=\"padding: 8px 0; color: #6b7280;\">Menções:</td>\n                <td style=\"padding: 8px 0; font-weight: bold;\">${alertData.mentionCount}</td>\n              </tr>\n            </table>\n          </div>\n          \n          <p style=\"margin-top: 20px; color: #6b7280; font-size: 14px;\">\n            Detectado em: ${new Date(alertData.detectedAt).toLocaleString('pt-BR')}\n          </p>\n        </div>\n        <div style=\"background: #f3f4f6; padding: 16px; text-align: center; font-size: 12px; color: #6b7280;\">\n          <p>Este é um alerta automatizado do SimulaVoto.</p>\n          <p>Acesse o sistema para mais detalhes e para reconhecer este alerta.</p>\n        </div>\n      </div>\n    `;\n\n    await resend.emails.send({\n      from: \"SimulaVoto <noreply@simulavoto.com>\",\n      to: Array.from(emailRecipients),\n      subject: `[${severityLabels[alertData.severity]}] ${alertData.title}`,\n      html: emailContent,\n    });\n\n    console.log(`Crisis email sent to ${emailRecipients.size} recipients`);\n  } catch (error) {\n    console.error(\"Failed to send crisis email notification:\", error);\n  }\n}\n\nexport async function processNewCrisisAlert(alertData: CrisisAlertData): Promise<void> {\n  await notifyAllAnalystsOfCrisis(alertData);\n  \n  if (alertData.severity === 'critical' || alertData.severity === 'high') {\n    await sendCrisisEmailNotification(alertData);\n  }\n}\n\nexport async function getUserNotifications(userId: string, limit = 20): Promise<any[]> {\n  return db.select()\n    .from(inAppNotifications)\n    .where(eq(inAppNotifications.userId, userId))\n    .orderBy(desc(inAppNotifications.createdAt))\n    .limit(limit);\n}\n\nexport async function getUnreadNotificationCount(userId: string): Promise<number> {\n  const result = await db.select({ count: sql<number>`count(*)` })\n    .from(inAppNotifications)\n    .where(\n      and(\n        eq(inAppNotifications.userId, userId),\n        eq(inAppNotifications.isRead, false)\n      )\n    );\n  return Number(result[0]?.count || 0);\n}\n\nexport async function markNotificationAsRead(notificationId: number, userId: string): Promise<void> {\n  await db.update(inAppNotifications)\n    .set({ isRead: true, readAt: new Date() })\n    .where(\n      and(\n        eq(inAppNotifications.id, notificationId),\n        eq(inAppNotifications.userId, userId)\n      )\n    );\n}\n\nexport async function markAllNotificationsAsRead(userId: string): Promise<void> {\n  await db.update(inAppNotifications)\n    .set({ isRead: true, readAt: new Date() })\n    .where(\n      and(\n        eq(inAppNotifications.userId, userId),\n        eq(inAppNotifications.isRead, false)\n      )\n    );\n}\n\nexport async function getAlertConfiguration(userId: string, entityType?: string, entityId?: string): Promise<any> {\n  const configs = await db.select()\n    .from(alertConfigurations)\n    .where(eq(alertConfigurations.userId, userId))\n    .orderBy(desc(alertConfigurations.createdAt));\n\n  if (entityType && entityId) {\n    const specific = configs.find(c => c.entityType === entityType && c.entityId === entityId);\n    if (specific) return specific;\n  }\n\n  if (entityType) {\n    const typeWide = configs.find(c => c.entityType === entityType && !c.entityId);\n    if (typeWide) return typeWide;\n  }\n\n  const global = configs.find(c => c.isGlobal);\n  if (global) return global;\n\n  return {\n    sentimentDropThreshold: 0.3,\n    criticalSentimentLevel: -0.5,\n    mentionSpikeMultiplier: 2.0,\n    timeWindowMinutes: 60,\n    notifyEmail: true,\n    notifyInApp: true,\n    minAlertIntervalMinutes: 30,\n  };\n}\n","path":null,"size_bytes":10133,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"DEPLOY-PORTAINER.md":{"content":"# Deploy SimulaVoto no Portainer\n\nGuia completo para deploy do SimulaVoto usando Portainer com Docker standalone.\n\nO sistema suporta dois modos de banco de dados:\n- **Modo Local**: PostgreSQL em container Docker (`docker-compose.portainer.yml`)\n- **Modo Externo**: Supabase self-hosted ou qualquer PostgreSQL remoto (`docker-compose.supabase.yml`)\n\n> **Atualizando uma instalacao existente?** Consulte [DEPLOY-UPDATE-PORTAINER.md](./DEPLOY-UPDATE-PORTAINER.md)\n\n---\n\n## 1. Arquitetura\n\n### Modo Local (docker-compose.portainer.yml)\n\n| Container | Imagem | Descricao |\n|-----------|--------|-----------|\n| `simulavoto-db` | `pgvector/pgvector:pg16` | PostgreSQL 16 com pgvector |\n| `simulavoto` | Build local (Dockerfile) | Aplicacao Node.js |\n\nO banco e inicializado automaticamente com `init-db.sql` no primeiro deploy. Dados persistidos no volume `simulavoto_pgdata`.\n\n### Modo Externo (docker-compose.supabase.yml)\n\n| Container | Imagem | Descricao |\n|-----------|--------|-----------|\n| `simulavoto` | Build local (Dockerfile) | Aplicacao Node.js |\n\nApenas o container da aplicacao. O banco fica no servidor Supabase externo.\n\n---\n\n## 2. Deploy via SSH\n\n### 2.1 Clonar Repositorio\n```bash\ncd /opt\ngit clone https://github.com/Erkondus/Eleicao.git simulavoto\ncd simulavoto\n```\n\n### 2.2 Criar arquivo .env\n\n**Modo Local (banco no Docker):**\n```bash\ncat > .env << 'EOF'\nPOSTGRES_PASSWORD=SuaSenhaSegura2026!\nSESSION_SECRET=GERE_COM_openssl_rand_base64_32\nOPENAI_API_KEY=sk-sua-chave-aqui\nEOF\n```\n\n**Modo Externo (Supabase self-hosted em bpxgroup.com.br):**\n```bash\ncat > .env << 'EOF'\nDATABASE_URL=postgresql://postgres:SuaSenhaSupabase@72.60.255.204:5432/postgres\nDATABASE_SSL=auto\nSESSION_SECRET=GERE_COM_openssl_rand_base64_32\nOPENAI_API_KEY=sk-sua-chave-aqui\nEOF\n```\n\n> **IMPORTANTE**: Usar o IP direto (`72.60.255.204`) porque o dominio `supabase.bpxgroup.com.br`\n> passa pelo Cloudflare, que nao redireciona conexoes PostgreSQL (porta 5432).\n> `DATABASE_SSL=auto` (padrao) tenta SSL primeiro e faz fallback automaticamente.\n> Se seu PostgreSQL tem SSL habilitado (ex: Nginx/Supavisor com Let's Encrypt), use `DATABASE_SSL=true`.\n\nPara gerar senhas seguras:\n```bash\nopenssl rand -base64 24    # para POSTGRES_PASSWORD\nopenssl rand -base64 32    # para SESSION_SECRET\n```\n\n### 2.3 Build e Deploy\n\n**Modo Local (com banco no Docker):**\n```bash\ndocker compose -f docker-compose.portainer.yml up -d --build\n```\n\n**Modo Externo (Supabase):**\n```bash\ndocker compose -f docker-compose.supabase.yml up -d --build\n```\n\n### 2.4 Verificar Status\n```bash\ndocker compose logs -f simulavoto\n```\n\nDeve mostrar:\n```\nsimulavoto     | Database mode: LOCAL (container/internal)\nsimulavoto     | Database pool initialized successfully\nsimulavoto     | Server running on port 5000\n```\n\nOu para modo externo:\n```\nsimulavoto     | Database mode: EXTERNAL (Supabase/cloud)\nsimulavoto     | Connecting to: 72.60.255.204:5432\nsimulavoto     | SSL: auto mode - app will try SSL first, fallback without\nsimulavoto     | SSL mode: auto (DATABASE_SSL=auto)\nsimulavoto     | SSL: connected successfully WITH SSL\nsimulavoto     | Database pool initialized successfully\nsimulavoto     | Server running on port 5000\n```\n\n---\n\n## 3. Deploy via Portainer UI\n\n### 3.1 Criar Stack\n1. Acesse o Portainer\n2. Va em **Stacks** > **Add Stack**\n3. Nome: `simulavoto`\n\n### 3.2 Metodo: Git Repository\n1. Selecione **Repository**\n2. **Repository URL**: `https://github.com/Erkondus/Eleicao`\n3. **Repository reference**: `refs/heads/main`\n4. **Compose path**:\n   - Modo Local: `docker-compose.portainer.yml`\n   - Modo Externo (Supabase): `docker-compose.supabase.yml`\n\n### 3.3 Adicionar Environment Variables\n\n**Modo Local (docker-compose.portainer.yml):**\n\n| Nome | Valor |\n|------|-------|\n| `POSTGRES_PASSWORD` | Resultado de `openssl rand -base64 24` |\n| `SESSION_SECRET` | Resultado de `openssl rand -base64 32` |\n| `OPENAI_API_KEY` | `sk-sua-chave-aqui` |\n\n> A `DATABASE_URL` e construida automaticamente pelo entrypoint usando `POSTGRES_PASSWORD`.\n\n**Modo Externo (docker-compose.supabase.yml):**\n\n| Nome | Valor |\n|------|-------|\n| `DATABASE_URL` | `postgresql://postgres:SuaSenha@72.60.255.204:5432/postgres` |\n| `DATABASE_SSL` | `auto` (tenta SSL primeiro, fallback sem SSL) |\n| `SESSION_SECRET` | Resultado de `openssl rand -base64 32` |\n| `OPENAI_API_KEY` | `sk-sua-chave-aqui` |\n\n> **IMPORTANTE**: Use o IP direto do servidor (`72.60.255.204`) em vez do dominio (`supabase.bpxgroup.com.br`), pois o dominio passa pelo Cloudflare que nao redireciona conexoes PostgreSQL.\n\n### 3.4 Deploy\nClique em **Deploy the stack**\n\n---\n\n## 4. Supabase Self-Hosted (bpxgroup.com.br)\n\n### Configuracao de acesso\n\n| Servico | URL |\n|---------|-----|\n| Dashboard Supabase | `https://supabase.bpxgroup.com.br` |\n| API Supabase | `https://supabaseapi.bpxgroup.com.br` |\n| PostgreSQL direto | `72.60.255.204:5432` (IP direto, sem Cloudflare) |\n\n> **ATENCAO**: O dominio `supabase.bpxgroup.com.br` passa pelo Cloudflare (proxy ativado).\n> O Cloudflare so redireciona HTTP/HTTPS (portas 80/443), NAO redireciona PostgreSQL (porta 5432).\n> Por isso, a DATABASE_URL deve usar o **IP direto** do servidor: `72.60.255.204`\n\n### Formato da DATABASE_URL\n\n**Conexao direta via IP (recomendado):**\n```\npostgresql://postgres:[SENHA]@72.60.255.204:5432/postgres\n```\n\n**Via Connection Pooler/PgBouncer (porta 6543):**\n```\npostgresql://postgres:[SENHA]@72.60.255.204:6543/postgres\n```\n\n> **Dica**: Se SimulaVoto e Supabase estiverem no mesmo servidor, voce pode usar o IP interno do Docker\n> (ex: `172.x.x.x`) na DATABASE_URL. Nesse caso o sistema detecta como modo LOCAL (sem SSL).\n\n### Controle de SSL\n\n| Valor de `DATABASE_SSL` | Comportamento |\n|--------------------------|---------------|\n| `auto` (padrao) | Tenta com SSL primeiro; se falhar, tenta sem SSL automaticamente |\n| `true` | SSL sempre habilitado (forcar SSL) |\n| `false` | SSL sempre desabilitado |\n\n**Supabase com Nginx + Let's Encrypt:**\n- O certificado Let's Encrypt protege as portas HTTP/HTTPS (80/443) do dashboard e API\n- A conexao PostgreSQL (porta 5432) pode ou nao ter SSL proprio\n- Use `DATABASE_SSL=auto` (padrao) - o sistema tenta SSL primeiro e faz fallback automaticamente\n- Se voce sabe que o PostgreSQL tem SSL habilitado (ex: via Supavisor), use `DATABASE_SSL=true`\n\n### Preparar banco no Supabase\n\nAntes do primeiro deploy, execute no SQL Editor do Supabase (`https://supabase.bpxgroup.com.br`):\n\n```sql\nCREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";\nCREATE EXTENSION IF NOT EXISTS \"pgcrypto\";\nCREATE EXTENSION IF NOT EXISTS \"vector\";\nCREATE EXTENSION IF NOT EXISTS \"pg_trgm\";\n```\n\nA aplicacao tenta criar as tabelas automaticamente via `db:push` no inicio.\n\n### Se as tabelas NAO forem criadas automaticamente\n\nSe o `db:push` falhar (ex: timeout, DNS, SSL), crie as tabelas manualmente:\n\n**Opcao 1 - SQL Editor do Supabase:**\n1. Abra `https://supabase.bpxgroup.com.br`\n2. Va em **SQL Editor**\n3. Copie o conteudo do arquivo `scripts/create-tables.sql` do projeto\n4. Cole e execute\n\n**Opcao 2 - Via psql:**\n```bash\npsql \"postgresql://postgres:SENHA@72.60.255.204:5432/postgres\" -f scripts/create-tables.sql\n```\n\n**Opcao 3 - De dentro do container:**\n```bash\ndocker exec -it simulavoto cat scripts/create-tables.sql | psql \"postgresql://postgres:SENHA@72.60.255.204:5432/postgres\"\n```\n\n> O script `create-tables.sql` usa `IF NOT EXISTS` em todos os comandos,\n> entao e seguro executa-lo varias vezes sem risco de perder dados.\n\n---\n\n## 5. Como Funciona a Deteccao de Modo\n\nO sistema detecta automaticamente o modo com base no hostname da `DATABASE_URL`:\n\n| Hostname | Modo | SSL | DNS IPv4 |\n|----------|------|-----|----------|\n| `db`, `localhost`, `127.0.0.1` | LOCAL | Desabilitado | Nao necessario |\n| `172.x`, `192.168.x`, `10.x` | LOCAL | Desabilitado | Nao necessario |\n| Hostname sem ponto (ex: `postgres-server`) | LOCAL | Desabilitado | Nao necessario |\n| Qualquer dominio (ex: `supabase.bpxgroup.com.br`) | EXTERNO | Habilitado | Forcado IPv4 |\n\nNao precisa configurar nada alem da `DATABASE_URL` correta.\n\n---\n\n## 6. Qual arquivo compose usar?\n\n| Cenario | Arquivo | Variaveis obrigatorias |\n|---------|---------|----------------------|\n| Banco no Docker (local) | `docker-compose.portainer.yml` | `POSTGRES_PASSWORD`, `SESSION_SECRET` |\n| Supabase bpxgroup.com.br | `docker-compose.supabase.yml` | `DATABASE_URL`, `SESSION_SECRET` |\n| Supabase Cloud (supabase.com) | `docker-compose.supabase.yml` | `DATABASE_URL`, `SESSION_SECRET` |\n| Outro PostgreSQL externo | `docker-compose.supabase.yml` | `DATABASE_URL`, `SESSION_SECRET` |\n| Dev local (sem Docker) | `docker-compose.yaml` | `POSTGRES_PASSWORD`, `SESSION_SECRET` |\n\n---\n\n## 7. Configurar Nginx Proxy Manager\n\n### 7.1 Adicionar Proxy Host\n\n1. Acesse o painel do **Nginx Proxy Manager**\n2. Va em **Hosts** > **Proxy Hosts** > **Add Proxy Host**\n\n### 7.2 Configurar o Host\n\n**Aba Details:**\n| Campo | Valor |\n|-------|-------|\n| Domain Names | `simulavoto.seudominio.com` |\n| Scheme | `http` |\n| Forward Hostname/IP | `simulavoto` (nome do container) ou `IP_DO_SERVIDOR` |\n| Forward Port | `5000` |\n| Cache Assets | Opcional |\n| Block Common Exploits | Sim |\n| Websockets Support | Sim |\n\n> Se o Nginx Proxy Manager estiver em outro stack/contexto Docker, use o IP do servidor ao inves do nome do container.\n\n### 7.3 Configurar SSL\n\n**Aba SSL:**\n| Campo | Valor |\n|-------|-------|\n| SSL Certificate | Request a new SSL Certificate |\n| Force SSL | Sim |\n| HTTP/2 Support | Sim |\n| HSTS Enabled | Opcional |\n| Email | seu@email.com |\n| I Agree... | Sim |\n\nClique em **Save**.\n\n### 7.4 Alternativa: Acesso Direto (sem proxy)\nAcesse: `http://IP_DO_SERVIDOR:5000`\n\n---\n\n## 8. Comandos Uteis\n\n### Ver logs\n```bash\ndocker compose -f docker-compose.supabase.yml logs -f simulavoto    # modo externo\ndocker compose -f docker-compose.portainer.yml logs -f simulavoto   # modo local\ndocker compose -f docker-compose.portainer.yml logs -f db           # banco local\n```\n\n### Reiniciar aplicacao\n```bash\ndocker compose -f docker-compose.supabase.yml restart simulavoto\n```\n\n### Atualizar (nova versao)\n```bash\ngit pull\ndocker compose -f docker-compose.supabase.yml up -d --build     # modo externo\ndocker compose -f docker-compose.portainer.yml up -d --build     # modo local\n```\n\n### Parar\n```bash\ndocker compose -f docker-compose.supabase.yml down    # modo externo\ndocker compose -f docker-compose.portainer.yml down    # modo local\n```\n\n### Remover tudo (incluindo dados do banco local)\n```bash\ndocker compose -f docker-compose.portainer.yml down -v\n```\n\n> **CUIDADO**: `-v` remove o volume com todos os dados do banco local!\n\n---\n\n## 9. Backup e Restauracao\n\n### Backup do banco local\n```bash\ndocker exec simulavoto-db pg_dump -U simulavoto simulavoto > backup_$(date +%Y%m%d).sql\n```\n\n### Backup do banco Supabase\n```bash\npg_dump \"postgresql://postgres:SENHA@supabase.bpxgroup.com.br:5432/postgres\" > backup_supabase_$(date +%Y%m%d).sql\n```\n\n### Restaurar backup (banco local)\n```bash\ndocker exec -i simulavoto-db psql -U simulavoto simulavoto < backup_20260210.sql\n```\n\n### Backup do volume Docker\n```bash\ndocker run --rm -v simulavoto_pgdata:/data -v $(pwd):/backup alpine tar czf /backup/pgdata_backup.tar.gz -C /data .\n```\n\n---\n\n## 10. Troubleshooting\n\n### \"unable to deploy stack\" no Portainer\n**Causa mais comum**: Variaveis de ambiente nao definidas ou arquivo compose errado.\n- Verifique se todas as variaveis obrigatorias estao definidas (secao 3.3)\n- Verifique se o **Compose path** aponta para o arquivo correto (secao 3.2)\n- Modo local: use `docker-compose.portainer.yml`\n- Modo externo: use `docker-compose.supabase.yml`\n\n### Container da aplicacao nao inicia\n```bash\ndocker compose -f docker-compose.supabase.yml logs simulavoto\n```\n\n### Erro de conexao com Supabase\n```bash\ndocker exec simulavoto wget -qO- http://localhost:5000/api/health\n```\n\nVerifique:\n1. A `DATABASE_URL` esta correta (usuario, senha, host, porta, banco)\n2. O Supabase esta acessivel na porta indicada\n3. As extensoes `vector` e `pg_trgm` estao criadas no banco\n\n### Tabelas nao foram criadas (db:push falhou)\n\nSe o `db:push` falhou no inicio do container, as tabelas nao existem. Solucoes:\n\n1. **Corrigir DATABASE_URL** - Use IP direto em vez de dominio com Cloudflare\n2. **Criar manualmente** - Execute `scripts/create-tables.sql` no SQL Editor do Supabase\n3. **Via psql**: `psql \"postgresql://postgres:SENHA@72.60.255.204:5432/postgres\" -f scripts/create-tables.sql`\n\nDepois de criar as tabelas, reinicie o container:\n```bash\ndocker restart simulavoto\n```\n\n### Erro ENETUNREACH ou ETIMEDOUT com Supabase\n**Causa**: DNS retorna IPs do Cloudflare (172.67.x.x, 104.21.x.x) que nao redirecionam PostgreSQL.\n**Solucao**: Use o IP direto do servidor na DATABASE_URL (ex: `72.60.255.204`).\nO entrypoint agora resolve DNS automaticamente, mas IPs Cloudflare continuam inacessiveis na porta 5432.\n\n### Health check falhando\n```bash\ndocker exec simulavoto wget -qO- http://localhost:5000/api/health\n```\n\n### Acessar o banco via psql (modo local)\n```bash\ndocker exec -it simulavoto-db psql -U simulavoto -d simulavoto\n```\n\n---\n\n## 11. Credenciais Padrao\n\n- **Usuario**: `admin`\n- **Senha**: `admin123`\n\n**IMPORTANTE**: Altere a senha apos o primeiro login!\n\n---\n\n## 12. Acesso ao Banco de Dados (modo local)\n\nO PostgreSQL esta exposto na porta **5433** do host (para evitar conflito com PostgreSQL local na porta 5432).\n\nPara conectar de fora do Docker:\n```bash\npsql -h localhost -p 5433 -U simulavoto -d simulavoto\n```\n\n---\n\n## 13. Variaveis de Ambiente\n\n| Variavel | Obrigatoria | Descricao |\n|----------|-------------|-----------|\n| `DATABASE_URL` | Modo externo | URL completa do PostgreSQL. Usar IP direto: `postgresql://postgres:SENHA@72.60.255.204:5432/postgres` |\n| `DATABASE_SSL` | Nao | Controle de SSL: `auto` (padrao, tenta SSL com fallback), `true` (forcar), `false` (desabilitar) |\n| `POSTGRES_PASSWORD` | Modo local | Senha do PostgreSQL local. Ignorada se DATABASE_URL definida |\n| `SESSION_SECRET` | Sim | Segredo para criptografia de sessoes |\n| `OPENAI_API_KEY` | Nao* | Para recursos de IA (previsoes, analise, KPIs) |\n| `RESEND_API_KEY` | Nao | Para envio de relatorios por email |\n\n*Recursos de IA requerem OPENAI_API_KEY para funcionar completamente.\n\n---\n\n## 14. Nginx Proxy Manager (NPM)\n\nO SimulaVoto ja esta configurado para funcionar com Nginx Proxy Manager. Os compose files incluem a rede `npm_network` e a porta 5000 nao e exposta externamente.\n\n### 14.1 Pre-requisito: rede Docker\n\nVerifique se a rede do NPM existe:\n```bash\ndocker network ls | grep npm\n```\n\nSe a rede tiver outro nome (ex: `nginx-proxy-manager_default`), edite o compose e altere o nome em:\n```yaml\nnetworks:\n  npm_network:\n    external: true\n    name: nginx-proxy-manager_default  # ajuste para o nome real\n```\n\nSe a rede nao existir, crie manualmente:\n```bash\ndocker network create npm_network\n```\n\n### 14.2 Configurar Proxy Host no NPM\n\n1. Acesse o painel do NPM (ex: `http://seu-servidor:81`)\n2. Va em **Hosts** > **Proxy Hosts** > **Add Proxy Host**\n3. Na aba **Details**:\n\n| Campo | Valor |\n|-------|-------|\n| Domain Names | `simulavoto.seudominio.com.br` |\n| Scheme | `http` |\n| Forward Hostname / IP | `simulavoto` |\n| Forward Port | `5000` |\n| Block Common Exploits | Ativado |\n| Websockets Support | **Ativado** (necessario para importacoes em tempo real) |\n\n4. Na aba **SSL**:\n\n| Campo | Valor |\n|-------|-------|\n| SSL Certificate | Request a new SSL Certificate |\n| Force SSL | Ativado |\n| HTTP/2 Support | Ativado |\n| Email Address | seu email para Let's Encrypt |\n\n5. Clique em **Save**\n\n### 14.3 Configuracao avancada (opcional)\n\nNa aba **Advanced** do Proxy Host, adicione para melhor suporte a WebSocket e headers:\n\n```nginx\nlocation /ws/ {\n    proxy_pass http://simulavoto:5000;\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection \"upgrade\";\n    proxy_set_header Host $host;\n    proxy_read_timeout 86400;\n}\n\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header X-Forwarded-Proto $scheme;\n```\n\n### 14.4 Expor porta diretamente (sem NPM)\n\nSe preferir acessar sem NPM, descomente as linhas de ports no compose:\n```yaml\nservices:\n  simulavoto:\n    ports:\n      - \"5000:5000\"\n```\n\n### 14.5 Fluxo de acesso\n\n```\nUsuario → HTTPS (443) → Nginx Proxy Manager → HTTP (5000) → SimulaVoto\n                         (Let's Encrypt SSL)    (rede Docker interna)\n```\n\n---\n\n## 15. Funcionalidades Disponiveis\n\n| Modulo | Descricao |\n|--------|-----------|\n| **Dashboard Eleitoral** | Mapa interativo do Brasil, metricas consolidadas, status de importacoes |\n| **Simulacoes** | Calculo de quocientes eleitorais, distribuicao de cadeiras (D'Hondt) |\n| **Importacao TSE** | Upload de CSV ate 5GB com monitoramento em tempo real |\n| **Importacao IBGE** | Municipios, populacao e indicadores com import otimizado em lote |\n| **Previsoes IA** | Monte Carlo, analise de tendencias, narrativas GPT-4o |\n| **Analise de Sentimento** | Multi-fonte (noticias, redes sociais), word cloud, alertas de crise |\n| **Campanhas** | Gestao de equipe, calendario, orcamento, KPIs estrategicos |\n| **Relatorios** | Geracao automatica CSV/PDF, agendamento, envio por email |\n","path":null,"size_bytes":17239,"size_tokens":null},"client/src/pages/users.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Plus, Edit, Trash2, Shield, UserCheck, UserX } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { DataTable } from \"@/components/data-table\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { User, InsertUser } from \"@shared/schema\";\n\nexport default function Users() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingUser, setEditingUser] = useState<User | null>(null);\n  const [deleteConfirmId, setDeleteConfirmId] = useState<string | null>(null);\n\n  const [formData, setFormData] = useState({\n    username: \"\",\n    password: \"\",\n    name: \"\",\n    email: \"\",\n    role: \"viewer\",\n  });\n\n  const { data: users, isLoading } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: InsertUser) => {\n      return apiRequest(\"POST\", \"/api/users\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      toast({ title: \"Sucesso\", description: \"Usuário criado com sucesso\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar usuário\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertUser> }) => {\n      return apiRequest(\"PATCH\", `/api/users/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      toast({ title: \"Sucesso\", description: \"Usuário atualizado\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar usuário\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/users/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      toast({ title: \"Sucesso\", description: \"Usuário excluído\" });\n      setDeleteConfirmId(null);\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao excluir usuário\", variant: \"destructive\" });\n    },\n  });\n\n  const toggleActiveMutation = useMutation({\n    mutationFn: async ({ id, active }: { id: string; active: boolean }) => {\n      return apiRequest(\"PATCH\", `/api/users/${id}`, { active });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      toast({ title: \"Sucesso\", description: \"Status do usuário alterado\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao alterar status\", variant: \"destructive\" });\n    },\n  });\n\n  function resetForm() {\n    setFormData({ username: \"\", password: \"\", name: \"\", email: \"\", role: \"viewer\" });\n    setEditingUser(null);\n    setIsDialogOpen(false);\n  }\n\n  function handleEdit(user: User) {\n    setEditingUser(user);\n    setFormData({\n      username: user.username,\n      password: \"\",\n      name: user.name,\n      email: user.email,\n      role: user.role,\n    });\n    setIsDialogOpen(true);\n  }\n\n  function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    const payload: any = {\n      username: formData.username,\n      name: formData.name,\n      email: formData.email,\n      role: formData.role,\n    };\n    if (formData.password) {\n      payload.password = formData.password;\n    }\n\n    if (editingUser) {\n      updateMutation.mutate({ id: editingUser.id, data: payload });\n    } else {\n      payload.password = formData.password;\n      createMutation.mutate(payload as InsertUser);\n    }\n  }\n\n  const roles = [\n    { value: \"admin\", label: \"Administrador\", description: \"Acesso total ao sistema\" },\n    { value: \"analyst\", label: \"Analista\", description: \"Gerencia dados e executa simulações\" },\n    { value: \"viewer\", label: \"Visualizador\", description: \"Apenas visualiza e executa simulações\" },\n  ];\n\n  const roleLabels: Record<string, string> = {\n    admin: \"Administrador\",\n    analyst: \"Analista\",\n    viewer: \"Visualizador\",\n  };\n\n  const roleVariants: Record<string, \"default\" | \"secondary\" | \"outline\"> = {\n    admin: \"default\",\n    analyst: \"secondary\",\n    viewer: \"outline\",\n  };\n\n  const columns = [\n    {\n      key: \"name\",\n      header: \"Usuário\",\n      sortable: true,\n      cell: (user: User) => (\n        <div className=\"flex items-center gap-3\">\n          <Avatar className=\"h-9 w-9\">\n            <AvatarFallback className=\"bg-primary/10 text-primary text-sm\">\n              {user.name.split(\" \").map((n) => n[0]).join(\"\").slice(0, 2).toUpperCase()}\n            </AvatarFallback>\n          </Avatar>\n          <div className=\"flex flex-col\">\n            <span className=\"font-medium\">{user.name}</span>\n            <span className=\"text-sm text-muted-foreground\">@{user.username}</span>\n          </div>\n        </div>\n      ),\n    },\n    {\n      key: \"email\",\n      header: \"Email\",\n      cell: (user: User) => <span className=\"text-muted-foreground\">{user.email}</span>,\n    },\n    {\n      key: \"role\",\n      header: \"Função\",\n      cell: (user: User) => (\n        <Badge variant={roleVariants[user.role]}>\n          {roleLabels[user.role] || user.role}\n        </Badge>\n      ),\n    },\n    {\n      key: \"active\",\n      header: \"Status\",\n      cell: (user: User) => (\n        <div className=\"flex items-center gap-2\">\n          <Switch\n            checked={user.active}\n            onCheckedChange={(checked) => toggleActiveMutation.mutate({ id: user.id, active: checked })}\n            data-testid={`switch-user-active-${user.id}`}\n          />\n          <span className={user.active ? \"text-success\" : \"text-muted-foreground\"}>\n            {user.active ? \"Ativo\" : \"Inativo\"}\n          </span>\n        </div>\n      ),\n    },\n    {\n      key: \"createdAt\",\n      header: \"Criado em\",\n      cell: (user: User) => (\n        <span className=\"text-sm text-muted-foreground\">\n          {new Date(user.createdAt).toLocaleDateString(\"pt-BR\")}\n        </span>\n      ),\n    },\n    {\n      key: \"actions\",\n      header: \"Ações\",\n      className: \"w-24\",\n      cell: (user: User) => (\n        <div className=\"flex items-center gap-1\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={() => handleEdit(user)}\n            data-testid={`button-edit-user-${user.id}`}\n          >\n            <Edit className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={() => setDeleteConfirmId(user.id)}\n            data-testid={`button-delete-user-${user.id}`}\n          >\n            <Trash2 className=\"h-4 w-4 text-destructive\" />\n          </Button>\n        </div>\n      ),\n    },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <PageHeader\n        title=\"Gerenciamento de Usuários\"\n        description=\"Controle de acesso e permissões do sistema\"\n        breadcrumbs={[\n          { label: \"Dashboard\", href: \"/\" },\n          { label: \"Usuários\" },\n        ]}\n        action={{\n          label: \"Novo Usuário\",\n          icon: <Plus className=\"h-4 w-4 mr-2\" />,\n          onClick: () => setIsDialogOpen(true),\n        }}\n      />\n\n      <Card>\n        <CardContent className=\"p-6\">\n          {!isLoading && (!users || users.length === 0) ? (\n            <EmptyState\n              icon={Shield}\n              title=\"Nenhum usuário cadastrado\"\n              description=\"Cadastre usuários para controlar o acesso ao sistema.\"\n              actionLabel=\"Cadastrar Usuário\"\n              onAction={() => setIsDialogOpen(true)}\n            />\n          ) : (\n            <DataTable\n              data={users || []}\n              columns={columns}\n              isLoading={isLoading}\n              searchable\n              searchKeys={[\"name\", \"username\", \"email\"]}\n              pageSize={10}\n              emptyMessage=\"Nenhum usuário encontrado\"\n            />\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={isDialogOpen} onOpenChange={(open) => !open && resetForm()}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>{editingUser ? \"Editar Usuário\" : \"Novo Usuário\"}</DialogTitle>\n            <DialogDescription>\n              {editingUser ? \"Atualize as informações do usuário\" : \"Preencha os dados do novo usuário\"}\n            </DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Nome Completo</Label>\n              <Input\n                id=\"name\"\n                placeholder=\"Ex: João da Silva\"\n                value={formData.name}\n                onChange={(e) => setFormData((f) => ({ ...f, name: e.target.value }))}\n                required\n                data-testid=\"input-user-name\"\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"username\">Usuário</Label>\n                <Input\n                  id=\"username\"\n                  placeholder=\"Ex: joao.silva\"\n                  value={formData.username}\n                  onChange={(e) => setFormData((f) => ({ ...f, username: e.target.value }))}\n                  required\n                  data-testid=\"input-user-username\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\">Email</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  placeholder=\"joao@exemplo.com\"\n                  value={formData.email}\n                  onChange={(e) => setFormData((f) => ({ ...f, email: e.target.value }))}\n                  required\n                  data-testid=\"input-user-email\"\n                />\n              </div>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"password\">\n                  Senha {editingUser && <span className=\"text-muted-foreground\">(deixe vazio para manter)</span>}\n                </Label>\n                <Input\n                  id=\"password\"\n                  type=\"password\"\n                  placeholder={editingUser ? \"••••••••\" : \"Mínimo 6 caracteres\"}\n                  value={formData.password}\n                  onChange={(e) => setFormData((f) => ({ ...f, password: e.target.value }))}\n                  required={!editingUser}\n                  minLength={6}\n                  data-testid=\"input-user-password\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"role\">Função</Label>\n                <Select\n                  value={formData.role}\n                  onValueChange={(v) => setFormData((f) => ({ ...f, role: v }))}\n                >\n                  <SelectTrigger data-testid=\"select-user-role\">\n                    <SelectValue placeholder=\"Selecione\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {roles.map((role) => (\n                      <SelectItem key={role.value} value={role.value}>\n                        <div className=\"flex flex-col\">\n                          <span>{role.label}</span>\n                        </div>\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button type=\"button\" variant=\"outline\" onClick={resetForm}>\n                Cancelar\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-save-user\"\n              >\n                {editingUser ? \"Salvar\" : \"Criar\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={deleteConfirmId !== null} onOpenChange={() => setDeleteConfirmId(null)}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Confirmar Exclusão</DialogTitle>\n            <DialogDescription>\n              Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeleteConfirmId(null)}>\n              Cancelar\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deleteConfirmId && deleteMutation.mutate(deleteConfirmId)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete-user\"\n            >\n              Excluir\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":13895,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"server/websocket.ts":{"content":"import { WebSocketServer, WebSocket } from \"ws\";\nimport type { Server } from \"http\";\nimport type { IncomingMessage } from \"http\";\nimport { parse as parseCookie } from \"cookie\";\nimport { sessionStore } from \"./session-config\";\nimport cookieSignature from \"cookie-signature\";\n\nexport interface ImportEvent {\n  type: \n    | \"import.job.status\"\n    | \"import.job.progress\"\n    | \"import.batch.status\"\n    | \"import.batch.error\"\n    | \"import.job.completed\"\n    | \"import.job.failed\";\n  jobId: number;\n  data: Record<string, unknown>;\n}\n\ninterface ExtendedWebSocket extends WebSocket {\n  isAlive: boolean;\n  userId?: number;\n  authenticated: boolean;\n}\n\nlet wss: WebSocketServer | null = null;\nconst clients = new Set<ExtendedWebSocket>();\n\nfunction unsignCookie(signedCookie: string, secret: string): string | null {\n  if (signedCookie.startsWith(\"s:\")) {\n    const unsigned = cookieSignature.unsign(signedCookie.slice(2), secret);\n    return unsigned || null;\n  }\n  return signedCookie;\n}\n\nexport function initWebSocketServer(server: Server): WebSocketServer {\n  const sessionSecret = process.env.SESSION_SECRET || \"dev-only-secret-do-not-use-in-production\";\n  \n  wss = new WebSocketServer({ \n    server,\n    path: \"/ws/imports\"\n  });\n\n  wss.on(\"connection\", (ws: ExtendedWebSocket, req: IncomingMessage) => {\n    ws.isAlive = true;\n    ws.authenticated = false;\n    \n    // Check for session cookie to validate connection\n    const cookies = req.headers.cookie ? parseCookie(req.headers.cookie) : {};\n    const signedSessionId = cookies[\"connect.sid\"];\n    \n    // Reject connections without session cookie\n    if (!signedSessionId) {\n      console.log(\"WebSocket connection rejected - no session cookie\");\n      ws.close(4001, \"Authentication required\");\n      return;\n    }\n    \n    // Unsign the session cookie\n    const sessionId = unsignCookie(signedSessionId, sessionSecret);\n    if (!sessionId) {\n      console.log(\"WebSocket connection rejected - invalid session signature\");\n      ws.close(4001, \"Invalid session\");\n      return;\n    }\n    \n    // Validate session against the session store\n    sessionStore.get(sessionId, (err, session) => {\n      if (err || !session) {\n        console.log(\"WebSocket connection rejected - session not found in store\");\n        ws.close(4001, \"Session expired\");\n        return;\n      }\n      \n      // Check if user is authenticated in the session\n      const passport = session.passport as { user?: number } | undefined;\n      if (!passport?.user) {\n        console.log(\"WebSocket connection rejected - no authenticated user in session\");\n        ws.close(4001, \"Not authenticated\");\n        return;\n      }\n      \n      ws.authenticated = true;\n      ws.userId = passport.user;\n      clients.add(ws);\n      console.log(`WebSocket client connected (user: ${ws.userId}). Total clients: ${clients.size}`);\n\n      ws.on(\"pong\", () => {\n        ws.isAlive = true;\n      });\n\n      ws.on(\"message\", (message: Buffer) => {\n        try {\n          const data = JSON.parse(message.toString());\n          if (data.type === \"ping\") {\n            ws.send(JSON.stringify({ type: \"pong\" }));\n          }\n        } catch {\n          // Ignore invalid messages\n        }\n      });\n\n      ws.on(\"close\", () => {\n        clients.delete(ws);\n        console.log(`WebSocket client disconnected. Total clients: ${clients.size}`);\n      });\n\n      ws.on(\"error\", (error) => {\n        console.error(\"WebSocket error:\", error);\n        clients.delete(ws);\n      });\n\n      // Send connection confirmation\n      ws.send(JSON.stringify({ \n        type: \"connected\", \n        message: \"Conectado ao sistema de notificações em tempo real\",\n        authenticated: ws.authenticated\n      }));\n    });\n  });\n\n  // Heartbeat to keep connections alive and clean up dead connections\n  const heartbeatInterval = setInterval(() => {\n    clients.forEach((ws) => {\n      if (!ws.isAlive) {\n        clients.delete(ws);\n        return ws.terminate();\n      }\n      ws.isAlive = false;\n      ws.ping();\n    });\n  }, 30000);\n\n  wss.on(\"close\", () => {\n    clearInterval(heartbeatInterval);\n  });\n\n  console.log(\"WebSocket server initialized on /ws/imports\");\n  return wss;\n}\n\nexport function broadcastImportEvent(event: ImportEvent): void {\n  if (!wss || clients.size === 0) return;\n\n  const message = JSON.stringify(event);\n  \n  clients.forEach((client) => {\n    // Only broadcast to authenticated clients\n    if (client.readyState === WebSocket.OPEN && client.authenticated) {\n      try {\n        client.send(message);\n      } catch (error) {\n        console.error(\"Error sending WebSocket message:\", error);\n      }\n    }\n  });\n}\n\nexport function emitJobStatus(\n  jobId: number, \n  status: string, \n  stage: string,\n  processedRows: number,\n  totalRows: number,\n  errorCount: number\n): void {\n  broadcastImportEvent({\n    type: \"import.job.status\",\n    jobId,\n    data: { status, stage, processedRows, totalRows, errorCount }\n  });\n}\n\nexport function emitJobProgress(\n  jobId: number,\n  processedRows: number,\n  totalRows: number,\n  downloadedBytes?: number,\n  totalBytes?: number\n): void {\n  const percent = totalRows > 0 ? Math.round((processedRows / totalRows) * 100) : 0;\n  broadcastImportEvent({\n    type: \"import.job.progress\",\n    jobId,\n    data: { \n      processedRows, \n      totalRows, \n      percent,\n      downloadedBytes,\n      totalBytes\n    }\n  });\n}\n\nexport function emitBatchStatus(\n  jobId: number,\n  batchId: number,\n  batchIndex: number,\n  status: string,\n  processedRows: number,\n  totalRows: number,\n  errorCount: number\n): void {\n  broadcastImportEvent({\n    type: \"import.batch.status\",\n    jobId,\n    data: { batchId, batchIndex, status, processedRows, totalRows, errorCount }\n  });\n}\n\nexport function emitBatchError(\n  jobId: number,\n  batchId: number,\n  rowNumber: number,\n  errorType: string,\n  errorMessage: string\n): void {\n  broadcastImportEvent({\n    type: \"import.batch.error\",\n    jobId,\n    data: { batchId, rowNumber, errorType, errorMessage }\n  });\n}\n\nexport function emitJobCompleted(\n  jobId: number,\n  totalRows: number,\n  processedRows: number,\n  errorCount: number\n): void {\n  broadcastImportEvent({\n    type: \"import.job.completed\",\n    jobId,\n    data: { totalRows, processedRows, errorCount, completedAt: new Date().toISOString() }\n  });\n}\n\nexport function emitJobFailed(\n  jobId: number,\n  errorMessage: string\n): void {\n  broadcastImportEvent({\n    type: \"import.job.failed\",\n    jobId,\n    data: { errorMessage, failedAt: new Date().toISOString() }\n  });\n}\n\nexport function getConnectedClientsCount(): number {\n  return clients.size;\n}\n\n// Election simulation events\nexport interface ElectionEvent {\n  type: \n    | \"election.simulation.started\"\n    | \"election.simulation.update\"\n    | \"election.simulation.projection\"\n    | \"election.simulation.completed\";\n  simulationId: string;\n  data: Record<string, unknown>;\n}\n\nexport function broadcastElectionEvent(event: ElectionEvent): void {\n  if (!wss || clients.size === 0) return;\n\n  const message = JSON.stringify(event);\n  \n  clients.forEach((client) => {\n    if (client.readyState === WebSocket.OPEN && client.authenticated) {\n      try {\n        client.send(message);\n      } catch (error) {\n        console.error(\"Error sending election event:\", error);\n      }\n    }\n  });\n}\n\nexport function emitElectionUpdate(\n  simulationId: string,\n  data: {\n    countedVotes: number;\n    totalVotes: number;\n    percentageCounted: number;\n    partyResults: Array<{ party: string; votes: number; percentage: number; projected?: number }>;\n    candidateResults: Array<{ name: string; party: string; votes: number; percentage: number }>;\n    regionsCounted: number;\n    totalRegions: number;\n    timestamp: string;\n  }\n): void {\n  broadcastElectionEvent({\n    type: \"election.simulation.update\",\n    simulationId,\n    data,\n  });\n}\n\nexport function emitElectionProjection(\n  simulationId: string,\n  data: {\n    partyProjections: Array<{ \n      party: string; \n      currentVotes: number; \n      projectedVotes: number; \n      confidence: number;\n      trend: \"up\" | \"down\" | \"stable\";\n    }>;\n    leadingCandidates: Array<{\n      name: string;\n      party: string;\n      currentVotes: number;\n      projectedVotes: number;\n      winProbability: number;\n    }>;\n    percentageCounted: number;\n    timestamp: string;\n  }\n): void {\n  broadcastElectionEvent({\n    type: \"election.simulation.projection\",\n    simulationId,\n    data,\n  });\n}\n\n// Crisis Alert Events\nexport interface CrisisAlertEvent {\n  type: \n    | \"crisis.alert.new\"\n    | \"crisis.alert.acknowledged\"\n    | \"crisis.alert.escalated\";\n  alertId: number;\n  data: Record<string, unknown>;\n}\n\nexport function broadcastCrisisAlert(event: CrisisAlertEvent): void {\n  if (!wss || clients.size === 0) return;\n\n  const message = JSON.stringify(event);\n  \n  clients.forEach((client) => {\n    if (client.readyState === WebSocket.OPEN && client.authenticated) {\n      try {\n        client.send(message);\n      } catch (error) {\n        console.error(\"Error sending crisis alert event:\", error);\n      }\n    }\n  });\n}\n\nexport function emitNewCrisisAlert(alertData: {\n  id: number;\n  entityType: string;\n  entityId: string;\n  entityName: string;\n  alertType: string;\n  severity: string;\n  title: string;\n  description: string;\n  sentimentBefore: number;\n  sentimentAfter: number;\n  sentimentChange: number;\n  mentionCount: number;\n  detectedAt: Date;\n}): void {\n  broadcastCrisisAlert({\n    type: \"crisis.alert.new\",\n    alertId: alertData.id,\n    data: {\n      ...alertData,\n      timestamp: new Date().toISOString()\n    }\n  });\n}\n\nexport function emitAlertAcknowledged(alertId: number, acknowledgedBy: string): void {\n  broadcastCrisisAlert({\n    type: \"crisis.alert.acknowledged\",\n    alertId,\n    data: {\n      acknowledgedBy,\n      acknowledgedAt: new Date().toISOString()\n    }\n  });\n}\n\n// In-App Notification Events\nexport interface NotificationEvent {\n  type: \"notification.new\" | \"notification.read\";\n  userId: string;\n  data: Record<string, unknown>;\n}\n\nexport function sendNotificationToUser(userId: string, notification: {\n  id: number;\n  type: string;\n  severity: string;\n  title: string;\n  message: string;\n  actionUrl?: string;\n}): void {\n  if (!wss || clients.size === 0) return;\n\n  const message = JSON.stringify({\n    type: \"notification.new\",\n    userId,\n    data: notification\n  });\n  \n  clients.forEach((client: ExtendedWebSocket) => {\n    if (client.readyState === WebSocket.OPEN && \n        client.authenticated && \n        client.userId?.toString() === userId) {\n      try {\n        client.send(message);\n      } catch (error) {\n        console.error(\"Error sending notification:\", error);\n      }\n    }\n  });\n}\n\nexport function broadcastToAllUsers(notification: {\n  type: string;\n  severity: string;\n  title: string;\n  message: string;\n}): void {\n  if (!wss || clients.size === 0) return;\n\n  const message = JSON.stringify({\n    type: \"notification.broadcast\",\n    data: notification\n  });\n  \n  clients.forEach((client) => {\n    if (client.readyState === WebSocket.OPEN && client.authenticated) {\n      try {\n        client.send(message);\n      } catch (error) {\n        console.error(\"Error broadcasting notification:\", error);\n      }\n    }\n  });\n}\n","path":null,"size_bytes":11220,"size_tokens":null},"server/semantic-search.ts":{"content":"import OpenAI from \"openai\";\nimport { db } from \"./db\";\nimport { semanticDocuments, semanticSearchQueries, tseCandidateVotes, tseImportJobs, parties } from \"@shared/schema\";\nimport { eq, sql, and, desc, asc, isNotNull, inArray } from \"drizzle-orm\";\nimport crypto from \"crypto\";\n\nconst EMBEDDING_MODEL = \"text-embedding-3-small\";\nconst EMBEDDING_DIMENSIONS = 1536;\nconst CHAT_MODEL = \"gpt-4o\";\n\nlet openaiClient: OpenAI | null = null;\n\nfunction getOpenAIClient(): OpenAI {\n  if (!openaiClient) {\n    const apiKey = process.env.OPENAI_API_KEY;\n    if (!apiKey) {\n      throw new Error(\"OPENAI_API_KEY is required for semantic search\");\n    }\n    openaiClient = new OpenAI({ apiKey });\n  }\n  return openaiClient;\n}\n\nfunction hashContent(content: string): string {\n  return crypto.createHash(\"sha256\").update(content).digest(\"hex\").slice(0, 16);\n}\n\nexport async function generateEmbedding(text: string): Promise<number[]> {\n  const openai = getOpenAIClient();\n  \n  const response = await openai.embeddings.create({\n    model: EMBEDDING_MODEL,\n    input: text,\n    dimensions: EMBEDDING_DIMENSIONS,\n  });\n  \n  return response.data[0].embedding;\n}\n\nexport async function generateEmbeddingsBatch(texts: string[]): Promise<number[][]> {\n  const openai = getOpenAIClient();\n  \n  const response = await openai.embeddings.create({\n    model: EMBEDDING_MODEL,\n    input: texts,\n    dimensions: EMBEDDING_DIMENSIONS,\n  });\n  \n  return response.data.map(d => d.embedding);\n}\n\ninterface SemanticSearchFilters {\n  year?: number;\n  state?: string;\n  party?: string;\n  position?: string;\n}\n\ninterface SemanticSearchResult {\n  id: number;\n  content: string;\n  metadata: any;\n  similarity: number;\n  year: number | null;\n  state: string | null;\n  partyAbbreviation: string | null;\n  position: string | null;\n}\n\nexport async function semanticSearch(\n  query: string,\n  filters: SemanticSearchFilters = {},\n  topK: number = 10\n): Promise<SemanticSearchResult[]> {\n  const queryEmbedding = await generateEmbedding(query);\n  \n  const conditions: any[] = [isNotNull(semanticDocuments.embedding)];\n  \n  if (filters.year) {\n    conditions.push(eq(semanticDocuments.year, filters.year));\n  }\n  if (filters.state) {\n    conditions.push(eq(semanticDocuments.state, filters.state));\n  }\n  if (filters.party) {\n    conditions.push(eq(semanticDocuments.partyAbbreviation, filters.party));\n  }\n  if (filters.position) {\n    conditions.push(eq(semanticDocuments.position, filters.position));\n  }\n  \n  const embeddingStr = `[${queryEmbedding.join(\",\")}]`;\n  \n  const results = await db.execute(sql`\n    SELECT \n      id,\n      content,\n      metadata,\n      year,\n      state,\n      party_abbreviation as \"partyAbbreviation\",\n      position,\n      1 - (embedding <=> ${embeddingStr}::vector) as similarity\n    FROM semantic_documents\n    WHERE embedding IS NOT NULL\n      ${filters.year ? sql`AND year = ${filters.year}` : sql``}\n      ${filters.state ? sql`AND state = ${filters.state}` : sql``}\n      ${filters.party ? sql`AND party_abbreviation = ${filters.party}` : sql``}\n      ${filters.position ? sql`AND position = ${filters.position}` : sql``}\n    ORDER BY embedding <=> ${embeddingStr}::vector\n    LIMIT ${topK}\n  `);\n  \n  return results.rows as unknown as SemanticSearchResult[];\n}\n\nexport async function generateAnswer(\n  query: string,\n  searchResults: SemanticSearchResult[]\n): Promise<{ answer: string; citations: { id: number; snippet: string }[] }> {\n  // Handle zero results without calling OpenAI API\n  if (searchResults.length === 0) {\n    return {\n      answer: \"Não foram encontrados dados relevantes para sua busca. Tente usar termos diferentes ou ajustar os filtros.\",\n      citations: [],\n    };\n  }\n  \n  const openai = getOpenAIClient();\n  \n  const contextSnippets = searchResults.map((r, i) => \n    `[${i + 1}] ${r.content.slice(0, 500)}${r.content.length > 500 ? \"...\" : \"\"}`\n  ).join(\"\\n\\n\");\n  \n  const systemPrompt = `Você é um assistente especializado em dados eleitorais brasileiros. \nResponda perguntas de forma concisa e factual, baseando-se exclusivamente nos dados fornecidos.\nCite as fontes usando o formato [número] quando usar informações específicas.\nSe não houver dados suficientes para responder, diga claramente.\nResponda em português brasileiro.`;\n\n  const userPrompt = `Pergunta: ${query}\n\nDados disponíveis:\n${contextSnippets}\n\nForneça uma resposta concisa baseada nos dados acima.`;\n\n  const response = await openai.chat.completions.create({\n    model: CHAT_MODEL,\n    messages: [\n      { role: \"system\", content: systemPrompt },\n      { role: \"user\", content: userPrompt }\n    ],\n    max_tokens: 1000,\n    temperature: 0.3,\n  });\n  \n  const answer = response.choices[0]?.message?.content || \"Não foi possível gerar uma resposta.\";\n  \n  const citations = searchResults.slice(0, 5).map(r => ({\n    id: r.id,\n    snippet: r.content.slice(0, 200) + (r.content.length > 200 ? \"...\" : \"\"),\n  }));\n  \n  return { answer, citations };\n}\n\nexport async function processSemanticSearch(\n  query: string,\n  filters: SemanticSearchFilters = {},\n  userId?: string\n): Promise<{\n  answer: string;\n  citations: { id: number; snippet: string; similarity: number; metadata: any }[];\n  totalResults: number;\n  responseTime: number;\n}> {\n  const startTime = Date.now();\n  \n  const searchResults = await semanticSearch(query, filters, 10);\n  \n  const { answer, citations } = await generateAnswer(query, searchResults);\n  \n  const responseTime = Date.now() - startTime;\n  \n  await db.insert(semanticSearchQueries).values({\n    query,\n    filters,\n    resultCount: searchResults.length,\n    responseTime,\n    createdBy: userId,\n  });\n  \n  return {\n    answer,\n    citations: searchResults.slice(0, 5).map(r => ({\n      id: r.id,\n      snippet: r.content.slice(0, 300) + (r.content.length > 300 ? \"...\" : \"\"),\n      similarity: r.similarity,\n      metadata: r.metadata,\n    })),\n    totalResults: searchResults.length,\n    responseTime,\n  };\n}\n\nfunction createCandidateDocument(vote: any): { content: string; metadata: any } {\n  const parts = [\n    `Candidato: ${vote.nmCandidato || vote.nmUrnaCandidato}`,\n    vote.nmUrnaCandidato && vote.nmUrnaCandidato !== vote.nmCandidato ? `Nome de urna: ${vote.nmUrnaCandidato}` : null,\n    `Número: ${vote.nrCandidato}`,\n    `Partido: ${vote.sgPartido} (${vote.nmPartido})`,\n    `Cargo: ${vote.dsCargo}`,\n    `Eleição: ${vote.dsEleicao} (${vote.anoEleicao})`,\n    vote.sgUf ? `Estado: ${vote.sgUf}` : null,\n    vote.nmMunicipio ? `Município: ${vote.nmMunicipio}` : null,\n    `Votos: ${vote.qtVotosNominais?.toLocaleString(\"pt-BR\") || 0}`,\n    vote.dsSituacaoCandidatura ? `Situação: ${vote.dsSituacaoCandidatura}` : null,\n    vote.dsSitTotTurno ? `Resultado: ${vote.dsSitTotTurno}` : null,\n    vote.nmFederacao ? `Federação: ${vote.nmFederacao}` : null,\n    vote.nmColigacao ? `Coligação: ${vote.nmColigacao}` : null,\n  ].filter(Boolean);\n  \n  const content = parts.join(\". \");\n  \n  const metadata = {\n    candidateId: vote.sqCandidato,\n    candidateName: vote.nmCandidato,\n    ballotName: vote.nmUrnaCandidato,\n    candidateNumber: vote.nrCandidato,\n    partyNumber: vote.nrPartido,\n    partyName: vote.nmPartido,\n    votes: vote.qtVotosNominais,\n    municipality: vote.nmMunicipio,\n    situation: vote.dsSituacaoCandidatura,\n    result: vote.dsSitTotTurno,\n    federation: vote.nmFederacao,\n    coalition: vote.nmColigacao,\n  };\n  \n  return { content, metadata };\n}\n\nexport async function generateEmbeddingsForImportJob(importJobId: number): Promise<{\n  processed: number;\n  skipped: number;\n  errors: number;\n}> {\n  const batchSize = 100;\n  let offset = 0;\n  let processed = 0;\n  let skipped = 0;\n  let errors = 0;\n  \n  while (true) {\n    const votes = await db\n      .select()\n      .from(tseCandidateVotes)\n      .where(eq(tseCandidateVotes.importJobId, importJobId))\n      .limit(batchSize)\n      .offset(offset);\n    \n    if (votes.length === 0) break;\n    \n    // Batch lookup: get all existing documents for this batch in ONE query\n    const voteIds = votes.map(v => v.id);\n    const existingDocs = await db\n      .select({ id: semanticDocuments.id, sourceId: semanticDocuments.sourceId, contentHash: semanticDocuments.contentHash })\n      .from(semanticDocuments)\n      .where(\n        and(\n          eq(semanticDocuments.sourceType, \"tse_candidate\"),\n          sql`${semanticDocuments.sourceId} = ANY(${voteIds})`\n        )\n      );\n    \n    // Create lookup map for O(1) access\n    const existingMap = new Map<number, { id: number; contentHash: string | null }>();\n    for (const doc of existingDocs) {\n      if (doc.sourceId !== null) {\n        existingMap.set(doc.sourceId, { id: doc.id, contentHash: doc.contentHash });\n      }\n    }\n    \n    const documents: {\n      content: string;\n      contentHash: string;\n      sourceType: string;\n      sourceId: number;\n      year: number | null;\n      state: string | null;\n      electionType: string | null;\n      position: string | null;\n      partyAbbreviation: string | null;\n      metadata: any;\n      existingId?: number;\n    }[] = [];\n    \n    for (const vote of votes) {\n      const { content, metadata } = createCandidateDocument(vote);\n      const contentHash = hashContent(content);\n      \n      const existing = existingMap.get(vote.id);\n      \n      if (existing && existing.contentHash === contentHash) {\n        skipped++;\n        continue;\n      }\n      \n      documents.push({\n        content,\n        contentHash,\n        sourceType: \"tse_candidate\",\n        sourceId: vote.id,\n        year: vote.anoEleicao,\n        state: vote.sgUf,\n        electionType: vote.nmTipoEleicao,\n        position: vote.dsCargo,\n        partyAbbreviation: vote.sgPartido,\n        metadata,\n        existingId: existing?.id,\n      });\n    }\n    \n    if (documents.length > 0) {\n      try {\n        const texts = documents.map(d => d.content);\n        const embeddings = await generateEmbeddingsBatch(texts);\n        \n        for (let i = 0; i < documents.length; i++) {\n          const doc = documents[i];\n          const embedding = embeddings[i];\n          \n          if (doc.existingId) {\n            await db.execute(sql`\n              UPDATE semantic_documents \n              SET content = ${doc.content},\n                  content_hash = ${doc.contentHash},\n                  year = ${doc.year},\n                  state = ${doc.state},\n                  election_type = ${doc.electionType},\n                  position = ${doc.position},\n                  party_abbreviation = ${doc.partyAbbreviation},\n                  metadata = ${JSON.stringify(doc.metadata)}::jsonb,\n                  embedding = ${`[${embedding.join(\",\")}]`}::vector\n              WHERE id = ${doc.existingId}\n            `);\n          } else {\n            await db.execute(sql`\n              INSERT INTO semantic_documents \n              (source_type, source_id, year, state, election_type, position, party_abbreviation, content, content_hash, metadata, embedding)\n              VALUES (\n                ${doc.sourceType},\n                ${doc.sourceId},\n                ${doc.year},\n                ${doc.state},\n                ${doc.electionType},\n                ${doc.position},\n                ${doc.partyAbbreviation},\n                ${doc.content},\n                ${doc.contentHash},\n                ${JSON.stringify(doc.metadata)}::jsonb,\n                ${`[${embedding.join(\",\")}]`}::vector\n              )\n            `);\n          }\n          \n          processed++;\n        }\n      } catch (err) {\n        console.error(\"Error generating embeddings for batch:\", err);\n        errors += documents.length;\n      }\n    }\n    \n    // Yield to event loop to prevent CPU blocking\n    await new Promise(resolve => setImmediate(resolve));\n    \n    offset += batchSize;\n  }\n  \n  return { processed, skipped, errors };\n}\n\nexport async function getEmbeddingStats(): Promise<{\n  totalDocuments: number;\n  documentsWithEmbeddings: number;\n  byYear: { year: number; count: number }[];\n  byState: { state: string; count: number }[];\n  byParty: { party: string; count: number }[];\n}> {\n  const totalResult = await db\n    .select({ count: sql<number>`count(*)` })\n    .from(semanticDocuments);\n  \n  const embeddedResult = await db\n    .select({ count: sql<number>`count(*)` })\n    .from(semanticDocuments)\n    .where(isNotNull(semanticDocuments.embedding));\n  \n  const byYear = await db\n    .select({\n      year: semanticDocuments.year,\n      count: sql<number>`count(*)`,\n    })\n    .from(semanticDocuments)\n    .where(isNotNull(semanticDocuments.year))\n    .groupBy(semanticDocuments.year)\n    .orderBy(desc(semanticDocuments.year));\n  \n  const byState = await db\n    .select({\n      state: semanticDocuments.state,\n      count: sql<number>`count(*)`,\n    })\n    .from(semanticDocuments)\n    .where(isNotNull(semanticDocuments.state))\n    .groupBy(semanticDocuments.state)\n    .orderBy(desc(sql`count(*)`));\n  \n  const byParty = await db\n    .select({\n      party: semanticDocuments.partyAbbreviation,\n      count: sql<number>`count(*)`,\n    })\n    .from(semanticDocuments)\n    .where(isNotNull(semanticDocuments.partyAbbreviation))\n    .groupBy(semanticDocuments.partyAbbreviation)\n    .orderBy(desc(sql`count(*)`))\n    .limit(20);\n  \n  return {\n    totalDocuments: Number(totalResult[0]?.count || 0),\n    documentsWithEmbeddings: Number(embeddedResult[0]?.count || 0),\n    byYear: byYear.map(r => ({ year: r.year!, count: Number(r.count) })),\n    byState: byState.map(r => ({ state: r.state!, count: Number(r.count) })),\n    byParty: byParty.map(r => ({ party: r.party!, count: Number(r.count) })),\n  };\n}\n\nexport async function getRecentQueries(limit: number = 10): Promise<SemanticSearchQuery[]> {\n  const queries = await db\n    .select()\n    .from(semanticSearchQueries)\n    .orderBy(desc(semanticSearchQueries.createdAt))\n    .limit(limit);\n  \n  return queries as any;\n}\n\ntype SemanticSearchQuery = {\n  id: number;\n  query: string;\n  filters: any;\n  resultCount: number | null;\n  responseTime: number | null;\n  createdAt: Date;\n  createdBy: string | null;\n};\n","path":null,"size_bytes":14051,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"docker-entrypoint.sh":{"content":"#!/bin/sh\n\necho \"=== SimulaVoto - Sistema Eleitoral Brasileiro ===\"\necho \"Environment: ${NODE_ENV:-production}\"\necho \"Port: ${PORT:-5000}\"\n\nif [ -z \"$DATABASE_URL\" ] && [ -z \"$POSTGRES_PASSWORD\" ]; then\n  echo \"ERROR: DATABASE_URL or POSTGRES_PASSWORD must be set\"\n  exit 1\nfi\n\nif [ -z \"$SESSION_SECRET\" ]; then\n  echo \"ERROR: SESSION_SECRET environment variable is not set\"\n  exit 1\nfi\n\nif [ -z \"$DATABASE_URL\" ]; then\n  PG_HOST=\"${POSTGRES_HOST:-db}\"\n  PG_PORT=\"${POSTGRES_PORT:-5432}\"\n  PG_USER=\"${POSTGRES_USER:-simulavoto}\"\n  PG_DB=\"${POSTGRES_DB:-simulavoto}\"\n  export DATABASE_URL=\"postgresql://${PG_USER}:${POSTGRES_PASSWORD}@${PG_HOST}:${PG_PORT}/${PG_DB}\"\n  echo \"DATABASE_URL constructed from POSTGRES_PASSWORD\"\nfi\n\nDB_HOST=$(echo \"$DATABASE_URL\" | sed -n 's|.*@\\([^:/]*\\).*|\\1|p')\nDB_PORT=$(echo \"$DATABASE_URL\" | sed -n 's|.*@[^:]*:\\([0-9]*\\)/.*|\\1|p')\n\nif [ -z \"$DB_HOST\" ]; then\n  DB_HOST=\"db\"\nfi\nif [ -z \"$DB_PORT\" ]; then\n  DB_PORT=\"5432\"\nfi\n\nstrip_sslmode() {\n  echo \"$1\" | sed 's/[?&]sslmode=[^&]*//g' | sed 's/?$//' | sed 's/&$//'\n}\n\nis_local_db() {\n  case \"$DB_HOST\" in\n    localhost|127.0.0.1|db|172.*|192.168.*|10.*)\n      return 0\n      ;;\n    *)\n      if echo \"$DB_HOST\" | grep -qv '\\.'; then\n        return 0\n      fi\n      return 1\n      ;;\n  esac\n}\n\nresolve_dns_to_ipv4() {\n  if echo \"$DB_HOST\" | grep -qE '^[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+$'; then\n    echo \"Host is already an IPv4 address: ${DB_HOST}\"\n    return\n  fi\n\n  echo \"Resolving ${DB_HOST} to IPv4...\"\n  RESOLVED_IP=$(node -e \"\n    const dns = require('dns');\n    dns.setDefaultResultOrder('ipv4first');\n    dns.lookup('${DB_HOST}', { family: 4 }, (err, addr) => {\n      if (err) { console.error('DNS_FAIL:' + err.message); process.exit(1); }\n      console.log(addr);\n    });\n  \" 2>&1) || true\n\n  if echo \"$RESOLVED_IP\" | grep -q \"DNS_FAIL\"; then\n    echo \"WARNING: DNS resolution failed: ${RESOLVED_IP}\"\n    echo \"Continuing with original hostname...\"\n    return\n  fi\n\n  if [ -n \"$RESOLVED_IP\" ] && echo \"$RESOLVED_IP\" | grep -qE '^[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+$'; then\n    echo \"DNS resolved: ${DB_HOST} -> ${RESOLVED_IP}\"\n    export DATABASE_URL=$(echo \"$DATABASE_URL\" | sed \"s|@${DB_HOST}|@${RESOLVED_IP}|g\")\n    DB_HOST=\"$RESOLVED_IP\"\n    echo \"DATABASE_URL updated to use resolved IP\"\n  else\n    echo \"WARNING: Could not resolve to IPv4, using original hostname\"\n  fi\n}\n\nhandle_ssl() {\n  SSL_VAL=$(echo \"${DATABASE_SSL:-auto}\" | tr '[:upper:]' '[:lower:]')\n  echo \"DATABASE_SSL=${SSL_VAL}\"\n\n  if [ \"$SSL_VAL\" = \"false\" ] || [ \"$SSL_VAL\" = \"0\" ]; then\n    echo \"SSL: disabled\"\n    export DATABASE_URL=$(strip_sslmode \"$DATABASE_URL\")\n\n  elif [ \"$SSL_VAL\" = \"true\" ] || [ \"$SSL_VAL\" = \"1\" ]; then\n    echo \"SSL: forced ON\"\n    case \"$DATABASE_URL\" in\n      *sslmode=*) echo \"SSL: sslmode already in URL\" ;;\n      *\"?\"*) export DATABASE_URL=\"${DATABASE_URL}&sslmode=require\" ;;\n      *) export DATABASE_URL=\"${DATABASE_URL}?sslmode=require\" ;;\n    esac\n\n  else\n    echo \"SSL: auto mode - testing connection...\"\n    export DATABASE_URL=$(strip_sslmode \"$DATABASE_URL\")\n\n    if node -e \"\n      const { Pool } = require('pg');\n      const p = new Pool({\n        connectionString: process.env.DATABASE_URL + '?sslmode=require',\n        ssl: { rejectUnauthorized: false },\n        connectionTimeoutMillis: 10000\n      });\n      p.query('SELECT 1')\n        .then(() => { p.end(); process.exit(0); })\n        .catch(() => { p.end(); process.exit(1); });\n    \" 2>/dev/null; then\n      echo \"SSL: connected WITH SSL\"\n      export DATABASE_URL=\"${DATABASE_URL}?sslmode=require\"\n    else\n      echo \"SSL: SSL failed, testing without SSL...\"\n      if node -e \"\n        const { Pool } = require('pg');\n        const p = new Pool({\n          connectionString: process.env.DATABASE_URL,\n          connectionTimeoutMillis: 10000\n        });\n        p.query('SELECT 1')\n          .then(() => { p.end(); process.exit(0); })\n          .catch(() => { p.end(); process.exit(1); });\n      \" 2>/dev/null; then\n        echo \"SSL: connected WITHOUT SSL\"\n      else\n        echo \"SSL: both SSL and non-SSL connections failed\"\n        echo \"WARNING: Database may be unreachable. Check DATABASE_URL.\"\n      fi\n    fi\n  fi\n}\n\nif is_local_db; then\n  echo \"Database mode: LOCAL (container/internal)\"\n  echo \"Waiting for database at ${DB_HOST}:${DB_PORT}...\"\n  MAX_RETRIES=60\n  RETRY_COUNT=0\n\n  while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do\n    if node -e \"const net = require('net'); const s = new net.Socket(); s.setTimeout(2000); s.connect(${DB_PORT}, '${DB_HOST}', () => { s.destroy(); process.exit(0); }); s.on('error', () => process.exit(1)); s.on('timeout', () => { s.destroy(); process.exit(1); });\" 2>/dev/null; then\n      echo \"Database is reachable!\"\n      break\n    fi\n\n    RETRY_COUNT=$((RETRY_COUNT + 1))\n    if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then\n      echo \"WARNING: Could not reach database after ${MAX_RETRIES} attempts\"\n      echo \"Proceeding anyway...\"\n      break\n    fi\n    echo \"Waiting for database... (attempt ${RETRY_COUNT}/${MAX_RETRIES})\"\n    sleep 2\n  done\nelse\n  echo \"Database mode: EXTERNAL (Supabase/cloud)\"\n  echo \"Host: ${DB_HOST}:${DB_PORT}\"\n\n  resolve_dns_to_ipv4\n  handle_ssl\n\n  echo \"Final host: ${DB_HOST}\"\nfi\n\necho \"\"\necho \"Running database schema sync (db:push)...\"\n\nif npm run db:push 2>&1; then\n  echo \"db:push completed successfully!\"\nelse\n  echo \"db:push failed, retrying...\"\n  if npm run db:push --force 2>&1; then\n    echo \"db:push --force completed successfully!\"\n  else\n    echo \"\"\n    echo \"============================================\"\n    echo \"WARNING: db:push failed!\"\n    echo \"============================================\"\n    echo \"Tabelas podem nao ter sido criadas.\"\n    echo \"\"\n    echo \"Para criar manualmente:\"\n    echo \"1. SQL Editor do Supabase: cole scripts/create-tables.sql\"\n    echo \"2. psql: psql \\$DATABASE_URL -f scripts/create-tables.sql\"\n    echo \"============================================\"\n  fi\nfi\n\necho \"\"\necho \"Starting application...\"\nexec npm start\n","path":null,"size_bytes":5991,"size_tokens":null},"client/src/pages/predictions.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Brain, Loader2, TrendingUp, TrendingDown, Minus, RefreshCw, Lightbulb, Plus, Play, Trash2, Settings2, BarChart3, FileText, ChevronDown, ChevronUp, Users, Calendar, Shuffle, AlertTriangle, ArrowRight, ArrowLeftRight, Download } from \"lucide-react\";\nimport { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, ErrorBar, ComposedChart, Line, Legend } from \"recharts\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { exportPredictionToPdf, exportMultiplePredictionsToPdf } from \"@/lib/pdf-export\";\nimport type { Scenario, Party, AIPrediction, PredictionScenario } from \"@shared/schema\";\n\nconst BRAZILIAN_STATES = [\n  { value: \"\", label: \"Nacional\" },\n  { value: \"AC\", label: \"Acre\" }, { value: \"AL\", label: \"Alagoas\" },\n  { value: \"AP\", label: \"Amapá\" }, { value: \"AM\", label: \"Amazonas\" },\n  { value: \"BA\", label: \"Bahia\" }, { value: \"CE\", label: \"Ceará\" },\n  { value: \"DF\", label: \"Distrito Federal\" }, { value: \"ES\", label: \"Espírito Santo\" },\n  { value: \"GO\", label: \"Goiás\" }, { value: \"MA\", label: \"Maranhão\" },\n  { value: \"MT\", label: \"Mato Grosso\" }, { value: \"MS\", label: \"Mato Grosso do Sul\" },\n  { value: \"MG\", label: \"Minas Gerais\" }, { value: \"PA\", label: \"Pará\" },\n  { value: \"PB\", label: \"Paraíba\" }, { value: \"PR\", label: \"Paraná\" },\n  { value: \"PE\", label: \"Pernambuco\" }, { value: \"PI\", label: \"Piauí\" },\n  { value: \"RJ\", label: \"Rio de Janeiro\" }, { value: \"RN\", label: \"Rio Grande do Norte\" },\n  { value: \"RS\", label: \"Rio Grande do Sul\" }, { value: \"RO\", label: \"Rondônia\" },\n  { value: \"RR\", label: \"Roraima\" }, { value: \"SC\", label: \"Santa Catarina\" },\n  { value: \"SP\", label: \"São Paulo\" }, { value: \"SE\", label: \"Sergipe\" },\n  { value: \"TO\", label: \"Tocantins\" },\n];\n\nconst POSITIONS = [\n  { value: \"DEPUTADO FEDERAL\", label: \"Deputado Federal\" },\n  { value: \"DEPUTADO ESTADUAL\", label: \"Deputado Estadual\" },\n  { value: \"DEPUTADO DISTRITAL\", label: \"Deputado Distrital\" },\n  { value: \"VEREADOR\", label: \"Vereador\" },\n];\n\ninterface PollingDataItem {\n  party: string;\n  pollPercent: number;\n  source: string;\n}\n\ninterface PartyAdjustment {\n  voteShareAdjust: number;\n  reason: string;\n}\n\ninterface ExternalFactor {\n  factor: string;\n  impact: \"positive\" | \"negative\";\n  magnitude: number;\n}\n\ninterface CandidateComparison {\n  id: number;\n  name: string;\n  description?: string;\n  candidateIds: string[];\n  state?: string;\n  position?: string;\n  targetYear: number;\n  status: string;\n  results?: any;\n  narrative?: string;\n  aiInsights?: any;\n  createdAt: string;\n}\n\ninterface EventImpactPrediction {\n  id: number;\n  name: string;\n  eventDescription: string;\n  eventType: string;\n  eventDate?: string;\n  affectedEntities: { parties?: string[]; candidates?: string[]; regions?: string[] };\n  state?: string;\n  position?: string;\n  targetYear: number;\n  status: string;\n  beforeProjection?: any;\n  afterProjection?: any;\n  impactDelta?: any;\n  narrative?: string;\n  createdAt: string;\n}\n\ninterface ScenarioSimulation {\n  id: number;\n  name: string;\n  description?: string;\n  simulationType: string;\n  baseScenario: any;\n  modifiedScenario: any;\n  parameters?: any;\n  scope?: any;\n  status: string;\n  baselineResults?: any;\n  simulatedResults?: any;\n  impactAnalysis?: any;\n  narrative?: string;\n  createdAt: string;\n}\n\nexport default function Predictions() {\n  const { toast } = useToast();\n  const [selectedScenarioId, setSelectedScenarioId] = useState<string>(\"\");\n  const [prediction, setPrediction] = useState<AIPrediction | null>(null);\n  const [activeTab, setActiveTab] = useState(\"quick\");\n  const [showNewScenarioDialog, setShowNewScenarioDialog] = useState(false);\n  const [expandedScenarios, setExpandedScenarios] = useState<Set<number>>(new Set());\n\n  // New scenario form state\n  const [newScenario, setNewScenario] = useState({\n    name: \"\",\n    description: \"\",\n    targetYear: 2026,\n    baseYear: 2022,\n    state: \"\",\n    position: \"DEPUTADO FEDERAL\",\n    pollingWeight: 30,\n    historicalWeight: 50,\n    adjustmentWeight: 20,\n    monteCarloIterations: 10000,\n    confidenceLevel: 95,\n  });\n  const [pollingData, setPollingData] = useState<PollingDataItem[]>([]);\n  const [partyAdjustments, setPartyAdjustments] = useState<Record<string, PartyAdjustment>>({});\n  const [externalFactors, setExternalFactors] = useState<ExternalFactor[]>([]);\n\n  // Candidate Comparison state\n  const [showComparisonDialog, setShowComparisonDialog] = useState(false);\n  const [comparisonForm, setComparisonForm] = useState({\n    name: \"\",\n    candidateIds: [] as string[],\n    candidateInput: \"\",\n    state: \"\",\n    position: \"DEPUTADO FEDERAL\",\n    targetYear: 2026,\n  });\n\n  // Event Impact state\n  const [showEventDialog, setShowEventDialog] = useState(false);\n  const [eventForm, setEventForm] = useState({\n    name: \"\",\n    eventDescription: \"\",\n    eventType: \"policy\",\n    affectedParties: [] as string[],\n    affectedCandidates: [] as string[],\n    state: \"\",\n    position: \"\",\n    targetYear: 2026,\n    impactMagnitude: 0.5,\n    impactDuration: \"medium-term\",\n  });\n\n  // What-If Simulation state\n  const [showWhatIfDialog, setShowWhatIfDialog] = useState(false);\n  const [whatIfForm, setWhatIfForm] = useState({\n    name: \"\",\n    description: \"\",\n    simulationType: \"party_change\",\n    candidateName: \"\",\n    fromParty: \"\",\n    toParty: \"\",\n    state: \"\",\n    targetYear: 2026,\n  });\n\n  const { data: scenarios } = useQuery<Scenario[]>({\n    queryKey: [\"/api/scenarios\"],\n  });\n\n  const { data: parties } = useQuery<Party[]>({\n    queryKey: [\"/api/parties\"],\n  });\n\n  const { data: predictionScenarios, isLoading: loadingScenarios } = useQuery<PredictionScenario[]>({\n    queryKey: [\"/api/prediction-scenarios\"],\n  });\n\n  // Candidate Comparisons\n  const { data: comparisons, isLoading: loadingComparisons } = useQuery<CandidateComparison[]>({\n    queryKey: [\"/api/candidate-comparisons\"],\n  });\n\n  // Event Impact Predictions\n  const { data: eventImpacts, isLoading: loadingEvents } = useQuery<EventImpactPrediction[]>({\n    queryKey: [\"/api/event-impacts\"],\n  });\n\n  // Scenario Simulations\n  const { data: simulations, isLoading: loadingSimulations } = useQuery<ScenarioSimulation[]>({\n    queryKey: [\"/api/scenario-simulations\"],\n  });\n\n  const predictionMutation = useMutation({\n    mutationFn: async (scenarioId: number) => {\n      const response = await apiRequest(\"POST\", \"/api/ai/predict\", { scenarioId });\n      return response as unknown as AIPrediction;\n    },\n    onSuccess: (data) => {\n      setPrediction(data);\n      toast({ title: \"Previsão gerada\", description: \"A análise de IA foi concluída com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao gerar previsão\", variant: \"destructive\" });\n    },\n  });\n\n  const createScenarioMutation = useMutation({\n    mutationFn: async (data: typeof newScenario & { pollingData: PollingDataItem[]; partyAdjustments: Record<string, PartyAdjustment>; externalFactors: ExternalFactor[] }) => {\n      return apiRequest(\"POST\", \"/api/prediction-scenarios\", {\n        name: data.name,\n        description: data.description,\n        targetYear: data.targetYear,\n        baseYear: data.baseYear,\n        state: data.state || null,\n        position: data.position,\n        pollingData: data.pollingData,\n        partyAdjustments: data.partyAdjustments,\n        externalFactors: data.externalFactors,\n        parameters: {\n          pollingWeight: data.pollingWeight / 100,\n          historicalWeight: data.historicalWeight / 100,\n          adjustmentWeight: data.adjustmentWeight / 100,\n          monteCarloIterations: data.monteCarloIterations,\n          confidenceLevel: data.confidenceLevel / 100,\n        },\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/prediction-scenarios\"] });\n      setShowNewScenarioDialog(false);\n      resetForm();\n      toast({ title: \"Cenário criado\", description: \"O cenário de previsão foi criado com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar cenário\", variant: \"destructive\" });\n    },\n  });\n\n  const runScenarioMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"POST\", `/api/prediction-scenarios/${id}/run`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/prediction-scenarios\"] });\n      toast({ title: \"Execução iniciada\", description: \"O cenário está sendo processado\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao executar cenário\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteScenarioMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/prediction-scenarios/${id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/prediction-scenarios\"] });\n      toast({ title: \"Cenário excluído\", description: \"O cenário foi removido\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao excluir cenário\", variant: \"destructive\" });\n    },\n  });\n\n  // Candidate Comparison mutations\n  const createComparisonMutation = useMutation({\n    mutationFn: async (data: typeof comparisonForm) => {\n      return apiRequest(\"POST\", \"/api/candidate-comparisons\", {\n        name: data.name,\n        candidateIds: data.candidateIds,\n        state: data.state || null,\n        position: data.position,\n        targetYear: data.targetYear,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/candidate-comparisons\"] });\n      setShowComparisonDialog(false);\n      setComparisonForm({ name: \"\", candidateIds: [], candidateInput: \"\", state: \"\", position: \"DEPUTADO FEDERAL\", targetYear: 2026 });\n      toast({ title: \"Comparação criada\", description: \"Execute para ver os resultados\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar comparação\", variant: \"destructive\" });\n    },\n  });\n\n  const runComparisonMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"POST\", `/api/candidate-comparisons/${id}/run`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/candidate-comparisons\"] });\n      toast({ title: \"Comparação executada\", description: \"Análise concluída com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao executar comparação\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteComparisonMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/candidate-comparisons/${id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/candidate-comparisons\"] });\n      toast({ title: \"Comparação excluída\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao excluir\", variant: \"destructive\" });\n    },\n  });\n\n  // Event Impact mutations\n  const createEventMutation = useMutation({\n    mutationFn: async (data: typeof eventForm) => {\n      return apiRequest(\"POST\", \"/api/event-impacts\", {\n        name: data.name,\n        eventDescription: data.eventDescription,\n        eventType: data.eventType,\n        affectedEntities: { parties: data.affectedParties, candidates: data.affectedCandidates },\n        state: data.state || null,\n        position: data.position || null,\n        targetYear: data.targetYear,\n        estimatedImpactMagnitude: data.impactMagnitude,\n        impactDuration: data.impactDuration,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/event-impacts\"] });\n      setShowEventDialog(false);\n      setEventForm({ name: \"\", eventDescription: \"\", eventType: \"policy\", affectedParties: [], affectedCandidates: [], state: \"\", position: \"\", targetYear: 2026, impactMagnitude: 0.5, impactDuration: \"medium-term\" });\n      toast({ title: \"Previsão de evento criada\", description: \"Execute para ver projeções antes/depois\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar previsão de evento\", variant: \"destructive\" });\n    },\n  });\n\n  const runEventMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"POST\", `/api/event-impacts/${id}/run`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/event-impacts\"] });\n      toast({ title: \"Análise de impacto concluída\", description: \"Projeções antes/depois geradas\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao analisar impacto\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteEventMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/event-impacts/${id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/event-impacts\"] });\n      toast({ title: \"Previsão excluída\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao excluir\", variant: \"destructive\" });\n    },\n  });\n\n  // What-If Simulation mutations\n  const createWhatIfMutation = useMutation({\n    mutationFn: async (data: typeof whatIfForm) => {\n      return apiRequest(\"POST\", \"/api/scenario-simulations\", {\n        name: data.name,\n        description: data.description,\n        simulationType: data.simulationType,\n        baseScenario: { candidate: data.candidateName, party: data.fromParty },\n        modifiedScenario: { candidate: data.candidateName, party: data.toParty },\n        parameters: { candidateName: data.candidateName, fromParty: data.fromParty, toParty: data.toParty },\n        scope: { state: data.state || null, year: data.targetYear },\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenario-simulations\"] });\n      setShowWhatIfDialog(false);\n      setWhatIfForm({ name: \"\", description: \"\", simulationType: \"party_change\", candidateName: \"\", fromParty: \"\", toParty: \"\", state: \"\", targetYear: 2026 });\n      toast({ title: \"Simulação criada\", description: \"Execute para ver resultados\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar simulação\", variant: \"destructive\" });\n    },\n  });\n\n  const runWhatIfMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"POST\", `/api/scenario-simulations/${id}/run`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenario-simulations\"] });\n      toast({ title: \"Simulação concluída\", description: \"Resultados disponíveis\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao executar simulação\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteWhatIfMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/scenario-simulations/${id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenario-simulations\"] });\n      toast({ title: \"Simulação excluída\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao excluir\", variant: \"destructive\" });\n    },\n  });\n\n  const addCandidateToComparison = () => {\n    if (comparisonForm.candidateInput.trim() && !comparisonForm.candidateIds.includes(comparisonForm.candidateInput.trim())) {\n      setComparisonForm({\n        ...comparisonForm,\n        candidateIds: [...comparisonForm.candidateIds, comparisonForm.candidateInput.trim()],\n        candidateInput: \"\",\n      });\n    }\n  };\n\n  const removeCandidateFromComparison = (candidate: string) => {\n    setComparisonForm({\n      ...comparisonForm,\n      candidateIds: comparisonForm.candidateIds.filter(c => c !== candidate),\n    });\n  };\n\n  const resetForm = () => {\n    setNewScenario({\n      name: \"\",\n      description: \"\",\n      targetYear: 2026,\n      baseYear: 2022,\n      state: \"\",\n      position: \"DEPUTADO FEDERAL\",\n      pollingWeight: 30,\n      historicalWeight: 50,\n      adjustmentWeight: 20,\n      monteCarloIterations: 10000,\n      confidenceLevel: 95,\n    });\n    setPollingData([]);\n    setPartyAdjustments({});\n    setExternalFactors([]);\n  };\n\n  const addPollingData = () => {\n    setPollingData([...pollingData, { party: \"\", pollPercent: 0, source: \"\" }]);\n  };\n\n  const updatePollingData = (index: number, field: keyof PollingDataItem, value: string | number) => {\n    const updated = [...pollingData];\n    updated[index] = { ...updated[index], [field]: value };\n    setPollingData(updated);\n  };\n\n  const removePollingData = (index: number) => {\n    setPollingData(pollingData.filter((_, i) => i !== index));\n  };\n\n  const addExternalFactor = () => {\n    setExternalFactors([...externalFactors, { factor: \"\", impact: \"positive\", magnitude: 5 }]);\n  };\n\n  const updateExternalFactor = (index: number, field: keyof ExternalFactor, value: string | number) => {\n    const updated = [...externalFactors];\n    updated[index] = { ...updated[index], [field]: value } as ExternalFactor;\n    setExternalFactors(updated);\n  };\n\n  const removeExternalFactor = (index: number) => {\n    setExternalFactors(externalFactors.filter((_, i) => i !== index));\n  };\n\n  const toggleScenarioExpanded = (id: number) => {\n    const newExpanded = new Set(expandedScenarios);\n    if (newExpanded.has(id)) {\n      newExpanded.delete(id);\n    } else {\n      newExpanded.add(id);\n    }\n    setExpandedScenarios(newExpanded);\n  };\n\n  const selectedScenario = scenarios?.find((s) => s.id === parseInt(selectedScenarioId));\n\n  const trendIcons = {\n    up: TrendingUp,\n    down: TrendingDown,\n    stable: Minus,\n  };\n\n  const trendColors = {\n    up: \"text-success\",\n    down: \"text-destructive\",\n    stable: \"text-muted-foreground\",\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"draft\":\n        return <Badge variant=\"outline\">Rascunho</Badge>;\n      case \"running\":\n        return <Badge variant=\"secondary\" className=\"animate-pulse\">Executando</Badge>;\n      case \"completed\":\n        return <Badge className=\"bg-success text-success-foreground\">Concluído</Badge>;\n      case \"failed\":\n        return <Badge variant=\"destructive\">Falhou</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <PageHeader\n        title=\"Previsões com IA\"\n        description=\"Análise preditiva de resultados eleitorais utilizando inteligência artificial e cenários personalizados\"\n        breadcrumbs={[\n          { label: \"Dashboard\", href: \"/\" },\n          { label: \"Previsões IA\" },\n        ]}\n      />\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"flex flex-wrap gap-1\">\n          <TabsTrigger value=\"quick\" className=\"gap-2\" data-testid=\"tab-quick-prediction\">\n            <Brain className=\"h-4 w-4\" />\n            Previsão Rápida\n          </TabsTrigger>\n          <TabsTrigger value=\"scenarios\" className=\"gap-2\" data-testid=\"tab-scenarios\">\n            <Settings2 className=\"h-4 w-4\" />\n            Cenários\n          </TabsTrigger>\n          <TabsTrigger value=\"comparison\" className=\"gap-2\" data-testid=\"tab-comparison\">\n            <Users className=\"h-4 w-4\" />\n            Comparar Candidatos\n          </TabsTrigger>\n          <TabsTrigger value=\"events\" className=\"gap-2\" data-testid=\"tab-events\">\n            <Calendar className=\"h-4 w-4\" />\n            Impacto de Eventos\n          </TabsTrigger>\n          <TabsTrigger value=\"whatif\" className=\"gap-2\" data-testid=\"tab-whatif\">\n            <Shuffle className=\"h-4 w-4\" />\n            E se...?\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"quick\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Brain className=\"h-5 w-5 text-primary\" />\n                Gerar Previsão Eleitoral\n              </CardTitle>\n              <CardDescription>\n                A IA analisa dados históricos e tendências para gerar previsões de distribuição de vagas.\n                Esta funcionalidade utiliza Replit AI Integrations e os custos são debitados dos seus créditos.\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Cenário para Análise</Label>\n                  <Select value={selectedScenarioId} onValueChange={setSelectedScenarioId}>\n                    <SelectTrigger data-testid=\"select-prediction-scenario\">\n                      <SelectValue placeholder=\"Selecione um cenário\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {scenarios?.map((s) => (\n                        <SelectItem key={s.id} value={String(s.id)}>\n                          {s.name} ({s.availableSeats} vagas)\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                {selectedScenario && (\n                  <div className=\"flex items-end\">\n                    <Button\n                      onClick={() => predictionMutation.mutate(parseInt(selectedScenarioId))}\n                      disabled={predictionMutation.isPending}\n                      className=\"w-full md:w-auto\"\n                      data-testid=\"button-generate-prediction\"\n                    >\n                      {predictionMutation.isPending ? (\n                        <>\n                          <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                          Analisando...\n                        </>\n                      ) : (\n                        <>\n                          <Brain className=\"h-4 w-4 mr-2\" />\n                          Gerar Previsão\n                        </>\n                      )}\n                    </Button>\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n\n          {prediction && (\n            <>\n              <Card>\n                <CardHeader>\n                  <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n                    <div>\n                      <CardTitle>Análise da IA</CardTitle>\n                      <CardDescription>\n                        Gerado em {new Date(prediction.generatedAt).toLocaleString(\"pt-BR\")}\n                      </CardDescription>\n                    </div>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => predictionMutation.mutate(parseInt(selectedScenarioId))}\n                      disabled={predictionMutation.isPending}\n                      data-testid=\"button-refresh-prediction\"\n                    >\n                      <RefreshCw className=\"h-4 w-4 mr-2\" />\n                      Atualizar\n                    </Button>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-muted-foreground leading-relaxed\">{prediction.analysis}</p>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Previsão de Distribuição de Vagas</CardTitle>\n                  <CardDescription>\n                    Estimativa de vagas por partido com intervalo de confiança\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-4\">\n                    {prediction.predictions.map((pred) => {\n                      const party = parties?.find((p) => p.id === pred.partyId);\n                      const TrendIcon = trendIcons[pred.trend];\n                      const trendColor = trendColors[pred.trend];\n                      const avgSeats = (pred.predictedSeats.min + pred.predictedSeats.max) / 2;\n                      const maxPossible = selectedScenario?.availableSeats || 20;\n\n                      return (\n                        <div key={pred.partyId} className=\"p-4 border rounded-lg\">\n                          <div className=\"flex items-center justify-between mb-3 gap-2 flex-wrap\">\n                            <div className=\"flex items-center gap-3\">\n                              <div\n                                className=\"w-4 h-4 rounded-full shrink-0\"\n                                style={{ backgroundColor: party?.color || \"#003366\" }}\n                              />\n                              <div>\n                                <div className=\"flex items-center gap-2 flex-wrap\">\n                                  <span className=\"font-medium\">{pred.partyName}</span>\n                                  <Badge variant=\"outline\">{party?.abbreviation}</Badge>\n                                </div>\n                              </div>\n                            </div>\n                            <div className=\"flex items-center gap-3 flex-wrap\">\n                              <div className={`flex items-center gap-1 ${trendColor}`}>\n                                <TrendIcon className=\"h-4 w-4\" />\n                                <span className=\"text-sm\">\n                                  {pred.trend === \"up\" ? \"Tendência de alta\" : pred.trend === \"down\" ? \"Tendência de baixa\" : \"Estável\"}\n                                </span>\n                              </div>\n                              <Badge variant=\"secondary\" className=\"font-mono\">\n                                {(pred.confidence * 100).toFixed(0)}% confiança\n                              </Badge>\n                            </div>\n                          </div>\n                          <div className=\"space-y-2\">\n                            <div className=\"flex items-center justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">Previsão de vagas</span>\n                              <span className=\"font-mono font-bold\">\n                                {pred.predictedSeats.min} - {pred.predictedSeats.max}\n                              </span>\n                            </div>\n                            <Progress value={(avgSeats / maxPossible) * 100} className=\"h-2\" />\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </CardContent>\n              </Card>\n\n              {prediction.recommendations.length > 0 && (\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Lightbulb className=\"h-5 w-5 text-accent\" />\n                      Recomendações\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ul className=\"space-y-2\">\n                      {prediction.recommendations.map((rec, idx) => (\n                        <li key={idx} className=\"flex items-start gap-2\">\n                          <span className=\"w-6 h-6 rounded-full bg-primary/10 text-primary flex items-center justify-center text-sm font-medium shrink-0\">\n                            {idx + 1}\n                          </span>\n                          <span className=\"text-muted-foreground\">{rec}</span>\n                        </li>\n                      ))}\n                    </ul>\n                  </CardContent>\n                </Card>\n              )}\n            </>\n          )}\n\n          {!selectedScenarioId && !prediction && (\n            <Card>\n              <CardContent className=\"p-6\">\n                <EmptyState\n                  icon={Brain}\n                  title=\"Selecione um cenário\"\n                  description=\"Escolha um cenário eleitoral para gerar previsões baseadas em inteligência artificial.\"\n                />\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"scenarios\" className=\"space-y-6\">\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <div>\n              <h2 className=\"text-lg font-semibold\">Cenários de Previsão</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Configure cenários personalizados com dados de pesquisas, ajustes por partido e fatores externos\n              </p>\n            </div>\n            <Dialog open={showNewScenarioDialog} onOpenChange={setShowNewScenarioDialog}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-new-scenario\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Novo Cenário\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>Criar Cenário de Previsão</DialogTitle>\n                  <DialogDescription>\n                    Configure um cenário personalizado para análise preditiva eleitoral\n                  </DialogDescription>\n                </DialogHeader>\n\n                <div className=\"space-y-6 py-4\">\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"scenario-name\">Nome do Cenário</Label>\n                      <Input\n                        id=\"scenario-name\"\n                        value={newScenario.name}\n                        onChange={(e) => setNewScenario({ ...newScenario, name: e.target.value })}\n                        placeholder=\"Ex: Cenário Otimista 2026\"\n                        data-testid=\"input-scenario-name\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"scenario-position\">Cargo</Label>\n                      <Select\n                        value={newScenario.position}\n                        onValueChange={(v) => setNewScenario({ ...newScenario, position: v })}\n                      >\n                        <SelectTrigger data-testid=\"select-scenario-position\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {POSITIONS.map((p) => (\n                            <SelectItem key={p.value} value={p.value}>{p.label}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"scenario-description\">Descrição</Label>\n                    <Textarea\n                      id=\"scenario-description\"\n                      value={newScenario.description}\n                      onChange={(e) => setNewScenario({ ...newScenario, description: e.target.value })}\n                      placeholder=\"Descreva as premissas deste cenário...\"\n                      rows={2}\n                      data-testid=\"textarea-scenario-description\"\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Ano Alvo</Label>\n                      <Select\n                        value={String(newScenario.targetYear)}\n                        onValueChange={(v) => setNewScenario({ ...newScenario, targetYear: parseInt(v) })}\n                      >\n                        <SelectTrigger data-testid=\"select-target-year\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"2026\">2026</SelectItem>\n                          <SelectItem value=\"2028\">2028</SelectItem>\n                          <SelectItem value=\"2030\">2030</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label>Ano Base</Label>\n                      <Select\n                        value={String(newScenario.baseYear)}\n                        onValueChange={(v) => setNewScenario({ ...newScenario, baseYear: parseInt(v) })}\n                      >\n                        <SelectTrigger data-testid=\"select-base-year\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"2022\">2022</SelectItem>\n                          <SelectItem value=\"2018\">2018</SelectItem>\n                          <SelectItem value=\"2014\">2014</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label>Estado</Label>\n                      <Select\n                        value={newScenario.state}\n                        onValueChange={(v) => setNewScenario({ ...newScenario, state: v })}\n                      >\n                        <SelectTrigger data-testid=\"select-scenario-state\">\n                          <SelectValue placeholder=\"Nacional\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {BRAZILIAN_STATES.map((s) => (\n                            <SelectItem key={s.value} value={s.value}>{s.label}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-4 border rounded-lg p-4\">\n                    <h4 className=\"font-medium\">Pesos do Modelo</h4>\n                    <div className=\"space-y-4\">\n                      <div className=\"space-y-2\">\n                        <div className=\"flex justify-between text-sm\">\n                          <Label>Peso das Pesquisas</Label>\n                          <span className=\"text-muted-foreground\">{newScenario.pollingWeight}%</span>\n                        </div>\n                        <Slider\n                          value={[newScenario.pollingWeight]}\n                          onValueChange={([v]) => setNewScenario({ ...newScenario, pollingWeight: v })}\n                          max={100}\n                          step={5}\n                          data-testid=\"slider-polling-weight\"\n                        />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <div className=\"flex justify-between text-sm\">\n                          <Label>Peso Histórico</Label>\n                          <span className=\"text-muted-foreground\">{newScenario.historicalWeight}%</span>\n                        </div>\n                        <Slider\n                          value={[newScenario.historicalWeight]}\n                          onValueChange={([v]) => setNewScenario({ ...newScenario, historicalWeight: v })}\n                          max={100}\n                          step={5}\n                          data-testid=\"slider-historical-weight\"\n                        />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <div className=\"flex justify-between text-sm\">\n                          <Label>Peso dos Ajustes</Label>\n                          <span className=\"text-muted-foreground\">{newScenario.adjustmentWeight}%</span>\n                        </div>\n                        <Slider\n                          value={[newScenario.adjustmentWeight]}\n                          onValueChange={([v]) => setNewScenario({ ...newScenario, adjustmentWeight: v })}\n                          max={100}\n                          step={5}\n                          data-testid=\"slider-adjustment-weight\"\n                        />\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-4 border rounded-lg p-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <h4 className=\"font-medium\">Dados de Pesquisas</h4>\n                      <Button variant=\"outline\" size=\"sm\" onClick={addPollingData} data-testid=\"button-add-polling\">\n                        <Plus className=\"h-4 w-4 mr-1\" />\n                        Adicionar\n                      </Button>\n                    </div>\n                    {pollingData.length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground\">Nenhum dado de pesquisa adicionado</p>\n                    ) : (\n                      <div className=\"space-y-3\">\n                        {pollingData.map((poll, idx) => (\n                          <div key={idx} className=\"grid grid-cols-4 gap-2 items-end\">\n                            <div className=\"space-y-1\">\n                              <Label className=\"text-xs\">Partido</Label>\n                              <Input\n                                value={poll.party}\n                                onChange={(e) => updatePollingData(idx, \"party\", e.target.value)}\n                                placeholder=\"PT, PL...\"\n                                data-testid={`input-poll-party-${idx}`}\n                              />\n                            </div>\n                            <div className=\"space-y-1\">\n                              <Label className=\"text-xs\">Percentual</Label>\n                              <Input\n                                type=\"number\"\n                                value={poll.pollPercent}\n                                onChange={(e) => updatePollingData(idx, \"pollPercent\", parseFloat(e.target.value) || 0)}\n                                placeholder=\"15.5\"\n                                data-testid={`input-poll-percent-${idx}`}\n                              />\n                            </div>\n                            <div className=\"space-y-1\">\n                              <Label className=\"text-xs\">Fonte</Label>\n                              <Input\n                                value={poll.source}\n                                onChange={(e) => updatePollingData(idx, \"source\", e.target.value)}\n                                placeholder=\"Datafolha\"\n                                data-testid={`input-poll-source-${idx}`}\n                              />\n                            </div>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              onClick={() => removePollingData(idx)}\n                              data-testid={`button-remove-poll-${idx}`}\n                            >\n                              <Trash2 className=\"h-4 w-4 text-destructive\" />\n                            </Button>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n\n                  <div className=\"space-y-4 border rounded-lg p-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <h4 className=\"font-medium\">Fatores Externos</h4>\n                      <Button variant=\"outline\" size=\"sm\" onClick={addExternalFactor} data-testid=\"button-add-factor\">\n                        <Plus className=\"h-4 w-4 mr-1\" />\n                        Adicionar\n                      </Button>\n                    </div>\n                    {externalFactors.length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground\">Nenhum fator externo adicionado</p>\n                    ) : (\n                      <div className=\"space-y-3\">\n                        {externalFactors.map((factor, idx) => (\n                          <div key={idx} className=\"grid grid-cols-4 gap-2 items-end\">\n                            <div className=\"space-y-1\">\n                              <Label className=\"text-xs\">Fator</Label>\n                              <Input\n                                value={factor.factor}\n                                onChange={(e) => updateExternalFactor(idx, \"factor\", e.target.value)}\n                                placeholder=\"Economia, Escândalo...\"\n                                data-testid={`input-factor-name-${idx}`}\n                              />\n                            </div>\n                            <div className=\"space-y-1\">\n                              <Label className=\"text-xs\">Impacto</Label>\n                              <Select\n                                value={factor.impact}\n                                onValueChange={(v) => updateExternalFactor(idx, \"impact\", v)}\n                              >\n                                <SelectTrigger data-testid={`select-factor-impact-${idx}`}>\n                                  <SelectValue />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  <SelectItem value=\"positive\">Positivo</SelectItem>\n                                  <SelectItem value=\"negative\">Negativo</SelectItem>\n                                </SelectContent>\n                              </Select>\n                            </div>\n                            <div className=\"space-y-1\">\n                              <Label className=\"text-xs\">Magnitude (1-10)</Label>\n                              <Input\n                                type=\"number\"\n                                min={1}\n                                max={10}\n                                value={factor.magnitude}\n                                onChange={(e) => updateExternalFactor(idx, \"magnitude\", parseInt(e.target.value) || 5)}\n                                data-testid={`input-factor-magnitude-${idx}`}\n                              />\n                            </div>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              onClick={() => removeExternalFactor(idx)}\n                              data-testid={`button-remove-factor-${idx}`}\n                            >\n                              <Trash2 className=\"h-4 w-4 text-destructive\" />\n                            </Button>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Iterações Monte Carlo</Label>\n                      <Select\n                        value={String(newScenario.monteCarloIterations)}\n                        onValueChange={(v) => setNewScenario({ ...newScenario, monteCarloIterations: parseInt(v) })}\n                      >\n                        <SelectTrigger data-testid=\"select-monte-carlo\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"1000\">1.000 (rápido)</SelectItem>\n                          <SelectItem value=\"5000\">5.000 (balanceado)</SelectItem>\n                          <SelectItem value=\"10000\">10.000 (padrão)</SelectItem>\n                          <SelectItem value=\"50000\">50.000 (preciso)</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label>Nível de Confiança</Label>\n                      <Select\n                        value={String(newScenario.confidenceLevel)}\n                        onValueChange={(v) => setNewScenario({ ...newScenario, confidenceLevel: parseInt(v) })}\n                      >\n                        <SelectTrigger data-testid=\"select-confidence\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"90\">90%</SelectItem>\n                          <SelectItem value=\"95\">95%</SelectItem>\n                          <SelectItem value=\"99\">99%</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n                </div>\n\n                <DialogFooter>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setShowNewScenarioDialog(false)}\n                  >\n                    Cancelar\n                  </Button>\n                  <Button\n                    onClick={() => createScenarioMutation.mutate({ ...newScenario, pollingData, partyAdjustments, externalFactors })}\n                    disabled={!newScenario.name || createScenarioMutation.isPending}\n                    data-testid=\"button-save-scenario\"\n                  >\n                    {createScenarioMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                        Salvando...\n                      </>\n                    ) : (\n                      \"Criar Cenário\"\n                    )}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n          </div>\n\n          {loadingScenarios ? (\n            <Card>\n              <CardContent className=\"p-6 flex items-center justify-center\">\n                <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n              </CardContent>\n            </Card>\n          ) : !predictionScenarios || predictionScenarios.length === 0 ? (\n            <Card>\n              <CardContent className=\"p-6\">\n                <EmptyState\n                  icon={Settings2}\n                  title=\"Nenhum cenário criado\"\n                  description=\"Crie um cenário personalizado para começar a fazer previsões avançadas.\"\n                />\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"space-y-4\">\n              {predictionScenarios.map((scenario) => (\n                <Card key={scenario.id} data-testid={`card-scenario-${scenario.id}`}>\n                  <Collapsible\n                    open={expandedScenarios.has(scenario.id)}\n                    onOpenChange={() => toggleScenarioExpanded(scenario.id)}\n                  >\n                    <CardHeader className=\"pb-2\">\n                      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                        <div className=\"flex items-center gap-3\">\n                          <CollapsibleTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\n                              {expandedScenarios.has(scenario.id) ? (\n                                <ChevronUp className=\"h-4 w-4\" />\n                              ) : (\n                                <ChevronDown className=\"h-4 w-4\" />\n                              )}\n                            </Button>\n                          </CollapsibleTrigger>\n                          <div>\n                            <CardTitle className=\"text-base\">{scenario.name}</CardTitle>\n                            <CardDescription>\n                              {scenario.targetYear} baseado em {scenario.baseYear}\n                              {scenario.state && ` - ${scenario.state}`}\n                            </CardDescription>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          {getStatusBadge(scenario.status)}\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => runScenarioMutation.mutate(scenario.id)}\n                            disabled={scenario.status === \"running\" || runScenarioMutation.isPending}\n                            data-testid={`button-run-scenario-${scenario.id}`}\n                          >\n                            <Play className=\"h-4 w-4 mr-1\" />\n                            Executar\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => deleteScenarioMutation.mutate(scenario.id)}\n                            disabled={deleteScenarioMutation.isPending}\n                            data-testid={`button-delete-scenario-${scenario.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CollapsibleContent>\n                      <CardContent className=\"space-y-4\">\n                        {scenario.description && (\n                          <p className=\"text-sm text-muted-foreground\">{scenario.description}</p>\n                        )}\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                          <div className=\"space-y-1\">\n                            <span className=\"text-muted-foreground\">Cargo</span>\n                            <p className=\"font-medium\">{scenario.position || \"Dep. Federal\"}</p>\n                          </div>\n                          <div className=\"space-y-1\">\n                            <span className=\"text-muted-foreground\">Iterações</span>\n                            <p className=\"font-medium\">{scenario.monteCarloIterations?.toLocaleString()}</p>\n                          </div>\n                          <div className=\"space-y-1\">\n                            <span className=\"text-muted-foreground\">Confiança</span>\n                            <p className=\"font-medium\">{parseFloat(scenario.confidenceLevel || \"0.95\") * 100}%</p>\n                          </div>\n                          <div className=\"space-y-1\">\n                            <span className=\"text-muted-foreground\">Última Execução</span>\n                            <p className=\"font-medium\">\n                              {scenario.lastRunAt ? new Date(scenario.lastRunAt).toLocaleDateString(\"pt-BR\") : \"Nunca\"}\n                            </p>\n                          </div>\n                        </div>\n                        {scenario.narrative && (\n                          <div className=\"bg-muted/50 rounded-lg p-4\">\n                            <div className=\"flex items-center gap-2 mb-2\">\n                              <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                              <span className=\"font-medium text-sm\">Análise IA</span>\n                            </div>\n                            <p className=\"text-sm text-muted-foreground\">{scenario.narrative}</p>\n                          </div>\n                        )}\n                        {scenario.forecastRunId && (\n                          <Button variant=\"outline\" size=\"sm\" asChild>\n                            <a href={`/forecasts?id=${scenario.forecastRunId}`}>\n                              <BarChart3 className=\"h-4 w-4 mr-2\" />\n                              Ver Resultados Detalhados\n                            </a>\n                          </Button>\n                        )}\n                      </CardContent>\n                    </CollapsibleContent>\n                  </Collapsible>\n                </Card>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        {/* Candidate Comparison Tab */}\n        <TabsContent value=\"comparison\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex flex-wrap items-center justify-between gap-4\">\n                <div>\n                  <CardTitle>Comparação de Candidatos</CardTitle>\n                  <CardDescription>Compare o desempenho projetado de dois ou mais candidatos</CardDescription>\n                </div>\n                <Dialog open={showComparisonDialog} onOpenChange={setShowComparisonDialog}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-new-comparison\">\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Nova Comparação\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-w-lg\">\n                    <DialogHeader>\n                      <DialogTitle>Criar Comparação de Candidatos</DialogTitle>\n                      <DialogDescription>Compare o desempenho projetado de candidatos</DialogDescription>\n                    </DialogHeader>\n                    <div className=\"space-y-4 py-4\">\n                      <div className=\"space-y-2\">\n                        <Label>Nome da Comparação</Label>\n                        <Input\n                          value={comparisonForm.name}\n                          onChange={(e) => setComparisonForm({ ...comparisonForm, name: e.target.value })}\n                          placeholder=\"Ex: Disputa SP 2026\"\n                          data-testid=\"input-comparison-name\"\n                        />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Adicionar Candidatos</Label>\n                        <div className=\"flex gap-2\">\n                          <Input\n                            value={comparisonForm.candidateInput}\n                            onChange={(e) => setComparisonForm({ ...comparisonForm, candidateInput: e.target.value })}\n                            placeholder=\"Nome do candidato\"\n                            onKeyPress={(e) => e.key === \"Enter\" && addCandidateToComparison()}\n                            data-testid=\"input-candidate-name\"\n                          />\n                          <Button type=\"button\" onClick={addCandidateToComparison} size=\"icon\" data-testid=\"button-add-candidate\">\n                            <Plus className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                        <div className=\"flex flex-wrap gap-2 mt-2\">\n                          {comparisonForm.candidateIds.map((c, i) => (\n                            <Badge key={i} variant=\"secondary\" className=\"gap-1\" data-testid={`badge-candidate-${i}`}>\n                              {c}\n                              <button \n                                onClick={() => removeCandidateFromComparison(c)} \n                                className=\"ml-1 hover:text-destructive\"\n                                data-testid={`button-remove-candidate-${i}`}\n                              >×</button>\n                            </Badge>\n                          ))}\n                        </div>\n                        {comparisonForm.candidateIds.length < 2 && (\n                          <p className=\"text-xs text-muted-foreground\">Adicione pelo menos 2 candidatos para comparar</p>\n                        )}\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <div className=\"space-y-2\">\n                          <Label>Estado</Label>\n                          <Select value={comparisonForm.state || \"national\"} onValueChange={(v) => setComparisonForm({ ...comparisonForm, state: v === \"national\" ? \"\" : v })}>\n                            <SelectTrigger data-testid=\"select-comparison-state\"><SelectValue placeholder=\"Nacional\" /></SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"national\">Nacional</SelectItem>\n                              {BRAZILIAN_STATES.filter(s => s.value).map((s) => (\n                                <SelectItem key={s.value} value={s.value}>{s.label}</SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Ano Alvo</Label>\n                          <Input\n                            type=\"number\"\n                            value={comparisonForm.targetYear}\n                            onChange={(e) => setComparisonForm({ ...comparisonForm, targetYear: parseInt(e.target.value) })}\n                            data-testid=\"input-comparison-year\"\n                          />\n                        </div>\n                      </div>\n                    </div>\n                    <DialogFooter>\n                      <Button\n                        onClick={() => createComparisonMutation.mutate(comparisonForm)}\n                        disabled={createComparisonMutation.isPending || comparisonForm.candidateIds.length < 2 || !comparisonForm.name}\n                        data-testid=\"button-submit-comparison\"\n                      >\n                        {createComparisonMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin mr-2\" /> : null}\n                        Criar Comparação\n                      </Button>\n                    </DialogFooter>\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {loadingComparisons ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <Loader2 className=\"h-6 w-6 animate-spin\" />\n                </div>\n              ) : comparisons && comparisons.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {comparisons.map((comp) => (\n                    <Card key={comp.id} data-testid={`card-comparison-${comp.id}`}>\n                      <CardHeader className=\"pb-2\">\n                        <div className=\"flex flex-wrap items-center justify-between gap-4\">\n                          <div>\n                            <CardTitle className=\"text-base\">{comp.name}</CardTitle>\n                            <CardDescription>\n                              {(comp.candidateIds as string[]).join(\" vs \")} - {comp.targetYear}\n                            </CardDescription>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            {getStatusBadge(comp.status)}\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => runComparisonMutation.mutate(comp.id)}\n                              disabled={comp.status === \"running\" || runComparisonMutation.isPending}\n                              data-testid={`button-run-comparison-${comp.id}`}\n                            >\n                              <Play className=\"h-4 w-4 mr-1\" />\n                              Analisar\n                            </Button>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              onClick={() => deleteComparisonMutation.mutate(comp.id)}\n                              data-testid={`button-delete-comparison-${comp.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4 text-destructive\" />\n                            </Button>\n                          </div>\n                        </div>\n                      </CardHeader>\n                      {comp.status === \"completed\" && comp.results && (\n                        <CardContent className=\"space-y-4\">\n                          <div className=\"h-48 mb-4\">\n                            <ResponsiveContainer width=\"100%\" height=\"100%\">\n                              <BarChart data={(comp.results.candidates || []).map((c: any) => ({\n                                name: c.name.split(\" \")[0],\n                                votos: c.projectedVoteShare || 0,\n                                probabilidade: (c.electionProbability || 0) * 100,\n                                errorMargin: (c.projectedVoteShare || 0) * 0.1,\n                              }))}>\n                                <XAxis dataKey=\"name\" tick={{ fontSize: 11 }} />\n                                <YAxis tickFormatter={(v) => `${v}%`} />\n                                <Tooltip \n                                  formatter={(value: number, name: string) => [\n                                    `${value.toFixed(1)}%`, \n                                    name === \"votos\" ? \"Votos Projetados\" : \"Prob. Eleição\"\n                                  ]}\n                                  contentStyle={{ backgroundColor: \"hsl(var(--card))\", border: \"1px solid hsl(var(--border))\", borderRadius: \"var(--radius)\" }}\n                                />\n                                <Legend />\n                                <Bar dataKey=\"votos\" name=\"Votos %\" fill=\"hsl(210, 100%, 40%)\" radius={[4, 4, 0, 0]}>\n                                  <ErrorBar dataKey=\"errorMargin\" stroke=\"hsl(0, 0%, 60%)\" strokeWidth={1.5} />\n                                </Bar>\n                                <Bar dataKey=\"probabilidade\" name=\"Prob. %\" fill=\"hsl(45, 100%, 50%)\" radius={[4, 4, 0, 0]} />\n                              </BarChart>\n                            </ResponsiveContainer>\n                          </div>\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                            {(comp.results.candidates || []).map((c: any, i: number) => (\n                              <div key={i} className=\"p-4 rounded-lg border space-y-2\">\n                                <div className=\"flex items-center justify-between\">\n                                  <span className=\"font-medium\">{c.name}</span>\n                                  <Badge variant={c.name === comp.results.overallWinner ? \"default\" : \"outline\"}>\n                                    {c.party}\n                                  </Badge>\n                                </div>\n                                <div className=\"space-y-1 text-sm\">\n                                  <div className=\"flex justify-between\">\n                                    <span className=\"text-muted-foreground\">Votos Projetados</span>\n                                    <span>{(c.projectedVoteShare || 0).toFixed(1)}%</span>\n                                  </div>\n                                  <div className=\"flex justify-between\">\n                                    <span className=\"text-muted-foreground\">Prob. Eleição</span>\n                                    <span>{((c.electionProbability || 0) * 100).toFixed(0)}%</span>\n                                  </div>\n                                  <Progress value={(c.electionProbability || 0) * 100} className=\"h-2\" />\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                          {comp.narrative && (\n                            <div className=\"bg-muted/50 rounded-lg p-4\">\n                              <p className=\"text-sm text-muted-foreground\">{comp.narrative}</p>\n                            </div>\n                          )}\n                          <div className=\"flex justify-end pt-2\">\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => exportPredictionToPdf({\n                                title: comp.name,\n                                subtitle: `Comparação: ${(comp.candidateIds as string[]).join(\" vs \")}`,\n                                type: \"comparison\",\n                                data: comp,\n                                narrative: comp.narrative || undefined,\n                              })}\n                              data-testid={`button-export-comparison-${comp.id}`}\n                            >\n                              <Download className=\"h-4 w-4 mr-1\" />\n                              Exportar PDF\n                            </Button>\n                          </div>\n                        </CardContent>\n                      )}\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Users className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>Nenhuma comparação criada</p>\n                  <p className=\"text-sm\">Crie uma nova comparação para analisar candidatos</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Event Impact Tab */}\n        <TabsContent value=\"events\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex flex-wrap items-center justify-between gap-4\">\n                <div>\n                  <CardTitle>Impacto de Eventos</CardTitle>\n                  <CardDescription>Projete o impacto de eventos políticos com análise antes/depois</CardDescription>\n                </div>\n                <Dialog open={showEventDialog} onOpenChange={setShowEventDialog}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-new-event\">\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Nova Previsão\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-w-lg\">\n                    <DialogHeader>\n                      <DialogTitle>Prever Impacto de Evento</DialogTitle>\n                      <DialogDescription>Analise como um evento pode afetar os resultados eleitorais</DialogDescription>\n                    </DialogHeader>\n                    <div className=\"space-y-4 py-4\">\n                      <div className=\"space-y-2\">\n                        <Label>Nome da Previsão</Label>\n                        <Input\n                          value={eventForm.name}\n                          onChange={(e) => setEventForm({ ...eventForm, name: e.target.value })}\n                          placeholder=\"Ex: Impacto da Delação\"\n                          data-testid=\"input-event-name\"\n                        />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Descrição do Evento</Label>\n                        <Textarea\n                          value={eventForm.eventDescription}\n                          onChange={(e) => setEventForm({ ...eventForm, eventDescription: e.target.value })}\n                          placeholder=\"Descreva o evento em detalhes...\"\n                          data-testid=\"input-event-description\"\n                        />\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <div className=\"space-y-2\">\n                          <Label>Tipo de Evento</Label>\n                          <Select value={eventForm.eventType} onValueChange={(v) => setEventForm({ ...eventForm, eventType: v })}>\n                            <SelectTrigger data-testid=\"select-event-type\"><SelectValue /></SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"scandal\">Escândalo</SelectItem>\n                              <SelectItem value=\"party_change\">Mudança de Partido</SelectItem>\n                              <SelectItem value=\"endorsement\">Apoio/Endorsement</SelectItem>\n                              <SelectItem value=\"policy\">Política Pública</SelectItem>\n                              <SelectItem value=\"debate\">Debate</SelectItem>\n                              <SelectItem value=\"economic\">Evento Econômico</SelectItem>\n                              <SelectItem value=\"other\">Outro</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Duração do Impacto</Label>\n                          <Select value={eventForm.impactDuration} onValueChange={(v) => setEventForm({ ...eventForm, impactDuration: v })}>\n                            <SelectTrigger data-testid=\"select-impact-duration\"><SelectValue /></SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"short-term\">Curto Prazo</SelectItem>\n                              <SelectItem value=\"medium-term\">Médio Prazo</SelectItem>\n                              <SelectItem value=\"long-term\">Longo Prazo</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </div>\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Partidos Afetados (separados por vírgula)</Label>\n                        <Input\n                          value={eventForm.affectedParties.join(\", \")}\n                          onChange={(e) => setEventForm({ ...eventForm, affectedParties: e.target.value.split(\",\").map(s => s.trim()).filter(Boolean) })}\n                          placeholder=\"PT, PL, PSDB...\"\n                          data-testid=\"input-affected-parties\"\n                        />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Magnitude do Impacto</Label>\n                        <div className=\"flex items-center gap-4\">\n                          <span className=\"text-sm text-muted-foreground\">-100%</span>\n                          <Slider\n                            value={[eventForm.impactMagnitude * 100]}\n                            onValueChange={([v]) => setEventForm({ ...eventForm, impactMagnitude: v / 100 })}\n                            min={-100}\n                            max={100}\n                            step={5}\n                            className=\"flex-1\"\n                          />\n                          <span className=\"text-sm text-muted-foreground\">+100%</span>\n                          <span className=\"font-medium w-16 text-right\">{(eventForm.impactMagnitude * 100).toFixed(0)}%</span>\n                        </div>\n                      </div>\n                    </div>\n                    <DialogFooter>\n                      <Button\n                        onClick={() => createEventMutation.mutate(eventForm)}\n                        disabled={createEventMutation.isPending || !eventForm.name || !eventForm.eventDescription}\n                        data-testid=\"button-submit-event\"\n                      >\n                        {createEventMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin mr-2\" /> : null}\n                        Criar Previsão\n                      </Button>\n                    </DialogFooter>\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {loadingEvents ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <Loader2 className=\"h-6 w-6 animate-spin\" />\n                </div>\n              ) : eventImpacts && eventImpacts.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {eventImpacts.map((event) => (\n                    <Card key={event.id} data-testid={`card-event-${event.id}`}>\n                      <CardHeader className=\"pb-2\">\n                        <div className=\"flex flex-wrap items-center justify-between gap-4\">\n                          <div>\n                            <CardTitle className=\"text-base\">{event.name}</CardTitle>\n                            <CardDescription className=\"line-clamp-1\">{event.eventDescription}</CardDescription>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            {getStatusBadge(event.status)}\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => runEventMutation.mutate(event.id)}\n                              disabled={event.status === \"running\" || runEventMutation.isPending}\n                              data-testid={`button-run-event-${event.id}`}\n                            >\n                              <Play className=\"h-4 w-4 mr-1\" />\n                              Analisar\n                            </Button>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              onClick={() => deleteEventMutation.mutate(event.id)}\n                              data-testid={`button-delete-event-${event.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4 text-destructive\" />\n                            </Button>\n                          </div>\n                        </div>\n                      </CardHeader>\n                      {event.status === \"completed\" && event.beforeProjection && event.afterProjection && (\n                        <CardContent className=\"space-y-4\">\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                            <div className=\"p-4 rounded-lg border space-y-3\">\n                              <div className=\"flex items-center gap-2\">\n                                <Badge variant=\"outline\">Antes</Badge>\n                                <span className=\"text-sm font-medium\">Projeção Pré-Evento</span>\n                              </div>\n                              {(event.beforeProjection.parties || []).slice(0, 5).map((p: any, i: number) => (\n                                <div key={i} className=\"flex justify-between text-sm\">\n                                  <span>{p.party}</span>\n                                  <span>{p.voteShare?.toFixed(1)}%</span>\n                                </div>\n                              ))}\n                            </div>\n                            <div className=\"p-4 rounded-lg border space-y-3\">\n                              <div className=\"flex items-center gap-2\">\n                                <Badge>Depois</Badge>\n                                <span className=\"text-sm font-medium\">Projeção Pós-Evento</span>\n                              </div>\n                              {(event.afterProjection.parties || []).slice(0, 5).map((p: any, i: number) => (\n                                <div key={i} className=\"flex justify-between text-sm\">\n                                  <span>{p.party}</span>\n                                  <span className=\"flex items-center gap-1\">\n                                    {p.voteShare?.toFixed(1)}%\n                                    {p.trend === \"growing\" && <TrendingUp className=\"h-3 w-3 text-success\" />}\n                                    {p.trend === \"declining\" && <TrendingDown className=\"h-3 w-3 text-destructive\" />}\n                                  </span>\n                                </div>\n                              ))}\n                            </div>\n                          </div>\n                          {event.impactDelta && (\n                            <div className=\"flex flex-wrap gap-4 p-4 bg-muted/50 rounded-lg\">\n                              {event.impactDelta.biggestGainer && (\n                                <div className=\"flex items-center gap-2\">\n                                  <TrendingUp className=\"h-4 w-4 text-success\" />\n                                  <span className=\"text-sm\">\n                                    <strong>{event.impactDelta.biggestGainer.party}</strong> +{event.impactDelta.biggestGainer.voteShareChange?.toFixed(1)}%\n                                  </span>\n                                </div>\n                              )}\n                              {event.impactDelta.biggestLoser && (\n                                <div className=\"flex items-center gap-2\">\n                                  <TrendingDown className=\"h-4 w-4 text-destructive\" />\n                                  <span className=\"text-sm\">\n                                    <strong>{event.impactDelta.biggestLoser.party}</strong> {event.impactDelta.biggestLoser.voteShareChange?.toFixed(1)}%\n                                  </span>\n                                </div>\n                              )}\n                            </div>\n                          )}\n                          <div className=\"h-48 mb-4\">\n                            <ResponsiveContainer width=\"100%\" height=\"100%\">\n                              <ComposedChart data={(() => {\n                                const beforeMap = new Map<string, number>((event.beforeProjection.parties || []).map((p: any) => [p.party, p.voteShare || 0]));\n                                return (event.afterProjection.parties || []).slice(0, 6).map((p: any) => ({\n                                  name: p.party,\n                                  antes: beforeMap.get(p.party) || 0,\n                                  depois: p.voteShare || 0,\n                                  variacao: (p.voteShare || 0) - (beforeMap.get(p.party) || 0),\n                                }));\n                              })()}>\n                                <XAxis dataKey=\"name\" tick={{ fontSize: 11 }} />\n                                <YAxis yAxisId=\"left\" tickFormatter={(v) => `${v}%`} />\n                                <YAxis yAxisId=\"right\" orientation=\"right\" tickFormatter={(v) => `${v > 0 ? \"+\" : \"\"}${v}%`} />\n                                <Tooltip \n                                  formatter={(value: number, name: string) => [\n                                    `${value.toFixed(1)}%`, \n                                    name === \"antes\" ? \"Antes\" : name === \"depois\" ? \"Depois\" : \"Variação\"\n                                  ]}\n                                  contentStyle={{ backgroundColor: \"hsl(var(--card))\", border: \"1px solid hsl(var(--border))\", borderRadius: \"var(--radius)\" }}\n                                />\n                                <Legend />\n                                <Bar yAxisId=\"left\" dataKey=\"antes\" name=\"Antes\" fill=\"hsl(210, 30%, 60%)\" radius={[4, 4, 0, 0]} />\n                                <Bar yAxisId=\"left\" dataKey=\"depois\" name=\"Depois\" fill=\"hsl(210, 100%, 40%)\" radius={[4, 4, 0, 0]} />\n                                <Line yAxisId=\"right\" type=\"monotone\" dataKey=\"variacao\" name=\"Variação\" stroke=\"hsl(45, 100%, 50%)\" strokeWidth={2} dot={{ fill: \"hsl(45, 100%, 50%)\" }} />\n                              </ComposedChart>\n                            </ResponsiveContainer>\n                          </div>\n                          {event.narrative && (\n                            <div className=\"bg-muted/50 rounded-lg p-4\">\n                              <p className=\"text-sm text-muted-foreground\">{event.narrative}</p>\n                            </div>\n                          )}\n                          <div className=\"flex justify-end pt-2\">\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => exportPredictionToPdf({\n                                title: event.name,\n                                subtitle: `Impacto de Evento: ${event.eventType}`,\n                                type: \"event\",\n                                data: event,\n                                narrative: event.narrative || undefined,\n                              })}\n                              data-testid={`button-export-event-${event.id}`}\n                            >\n                              <Download className=\"h-4 w-4 mr-1\" />\n                              Exportar PDF\n                            </Button>\n                          </div>\n                        </CardContent>\n                      )}\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Calendar className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>Nenhuma previsão de evento criada</p>\n                  <p className=\"text-sm\">Crie uma nova previsão para analisar impactos</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* What-If Simulation Tab */}\n        <TabsContent value=\"whatif\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex flex-wrap items-center justify-between gap-4\">\n                <div>\n                  <CardTitle>Simulações \"E se...?\"</CardTitle>\n                  <CardDescription>Simule cenários hipotéticos como mudanças de partido ou coligações</CardDescription>\n                </div>\n                <Dialog open={showWhatIfDialog} onOpenChange={setShowWhatIfDialog}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-new-whatif\">\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Nova Simulação\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-w-lg\">\n                    <DialogHeader>\n                      <DialogTitle>Criar Simulação \"E se...?\"</DialogTitle>\n                      <DialogDescription>Simule cenários hipotéticos e veja os impactos projetados</DialogDescription>\n                    </DialogHeader>\n                    <div className=\"space-y-4 py-4\">\n                      <div className=\"space-y-2\">\n                        <Label>Nome da Simulação</Label>\n                        <Input\n                          value={whatIfForm.name}\n                          onChange={(e) => setWhatIfForm({ ...whatIfForm, name: e.target.value })}\n                          placeholder=\"Ex: E se X mudar de partido?\"\n                          data-testid=\"input-whatif-name\"\n                        />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Tipo de Simulação</Label>\n                        <Select value={whatIfForm.simulationType} onValueChange={(v) => setWhatIfForm({ ...whatIfForm, simulationType: v })}>\n                          <SelectTrigger data-testid=\"select-simulation-type\"><SelectValue /></SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"party_change\">Mudança de Partido</SelectItem>\n                            <SelectItem value=\"coalition_change\">Mudança de Coligação</SelectItem>\n                            <SelectItem value=\"turnout_change\">Variação de Comparecimento</SelectItem>\n                            <SelectItem value=\"regional_shift\">Mudança Regional</SelectItem>\n                            <SelectItem value=\"custom\">Personalizado</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      {whatIfForm.simulationType === \"party_change\" && (\n                        <>\n                          <div className=\"space-y-2\">\n                            <Label>Candidato</Label>\n                            <Input\n                              value={whatIfForm.candidateName}\n                              onChange={(e) => setWhatIfForm({ ...whatIfForm, candidateName: e.target.value })}\n                              placeholder=\"Nome do candidato\"\n                              data-testid=\"input-whatif-candidate\"\n                            />\n                          </div>\n                          <div className=\"grid grid-cols-2 gap-4\">\n                            <div className=\"space-y-2\">\n                              <Label>Partido Atual</Label>\n                              <Select value={whatIfForm.fromParty} onValueChange={(v) => setWhatIfForm({ ...whatIfForm, fromParty: v })}>\n                                <SelectTrigger data-testid=\"select-from-party\"><SelectValue placeholder=\"Selecione\" /></SelectTrigger>\n                                <SelectContent>\n                                  {parties?.map((p) => (\n                                    <SelectItem key={p.id} value={p.abbreviation}>{p.abbreviation}</SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                            </div>\n                            <div className=\"space-y-2\">\n                              <Label>Novo Partido</Label>\n                              <Select value={whatIfForm.toParty} onValueChange={(v) => setWhatIfForm({ ...whatIfForm, toParty: v })}>\n                                <SelectTrigger data-testid=\"select-to-party\"><SelectValue placeholder=\"Selecione\" /></SelectTrigger>\n                                <SelectContent>\n                                  {parties?.map((p) => (\n                                    <SelectItem key={p.id} value={p.abbreviation}>{p.abbreviation}</SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                            </div>\n                          </div>\n                        </>\n                      )}\n                      <div className=\"space-y-2\">\n                        <Label>Descrição (opcional)</Label>\n                        <Textarea\n                          value={whatIfForm.description}\n                          onChange={(e) => setWhatIfForm({ ...whatIfForm, description: e.target.value })}\n                          placeholder=\"Descreva o cenário...\"\n                          data-testid=\"input-whatif-description\"\n                        />\n                      </div>\n                    </div>\n                    <DialogFooter>\n                      <Button\n                        onClick={() => createWhatIfMutation.mutate(whatIfForm)}\n                        disabled={createWhatIfMutation.isPending || !whatIfForm.name}\n                        data-testid=\"button-submit-whatif\"\n                      >\n                        {createWhatIfMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin mr-2\" /> : null}\n                        Criar Simulação\n                      </Button>\n                    </DialogFooter>\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {loadingSimulations ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <Loader2 className=\"h-6 w-6 animate-spin\" />\n                </div>\n              ) : simulations && simulations.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {simulations.map((sim) => (\n                    <Card key={sim.id} data-testid={`card-simulation-${sim.id}`}>\n                      <CardHeader className=\"pb-2\">\n                        <div className=\"flex flex-wrap items-center justify-between gap-4\">\n                          <div>\n                            <CardTitle className=\"text-base\">{sim.name}</CardTitle>\n                            <CardDescription>\n                              {sim.simulationType === \"party_change\" && sim.parameters && (\n                                <span className=\"flex items-center gap-1\">\n                                  {sim.parameters.candidateName}: {sim.parameters.fromParty} <ArrowRight className=\"h-3 w-3\" /> {sim.parameters.toParty}\n                                </span>\n                              )}\n                              {sim.simulationType !== \"party_change\" && sim.description}\n                            </CardDescription>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            {getStatusBadge(sim.status)}\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => runWhatIfMutation.mutate(sim.id)}\n                              disabled={sim.status === \"running\" || runWhatIfMutation.isPending}\n                              data-testid={`button-run-simulation-${sim.id}`}\n                            >\n                              <Play className=\"h-4 w-4 mr-1\" />\n                              Simular\n                            </Button>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              onClick={() => deleteWhatIfMutation.mutate(sim.id)}\n                              data-testid={`button-delete-simulation-${sim.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4 text-destructive\" />\n                            </Button>\n                          </div>\n                        </div>\n                      </CardHeader>\n                      {sim.status === \"completed\" && sim.impactAnalysis && (\n                        <CardContent className=\"space-y-4\">\n                          <div className=\"flex flex-wrap gap-4 p-4 bg-muted/50 rounded-lg\">\n                            <div className=\"flex items-center gap-2\">\n                              <AlertTriangle className=\"h-4 w-4\" />\n                              <span className=\"text-sm font-medium\">\n                                Impacto: {sim.impactAnalysis.overallImpact === \"significativo\" ? \"Significativo\" : \n                                          sim.impactAnalysis.overallImpact === \"moderado\" ? \"Moderado\" : \"Mínimo\"}\n                              </span>\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"text-sm\">Confiança: {((sim.impactAnalysis.confidence || 0) * 100).toFixed(0)}%</span>\n                            </div>\n                          </div>\n                          {sim.impactAnalysis.seatChanges && sim.impactAnalysis.seatChanges.length > 0 && (\n                            <>\n                              <div className=\"h-48 mb-4\">\n                                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                                  <BarChart data={sim.impactAnalysis.seatChanges.slice(0, 6).map((c: any) => ({\n                                    name: c.party,\n                                    antes: c.before,\n                                    depois: c.after,\n                                    variacao: c.change,\n                                  }))}>\n                                    <XAxis dataKey=\"name\" tick={{ fontSize: 11 }} />\n                                    <YAxis />\n                                    <Tooltip \n                                      formatter={(value: number, name: string) => [\n                                        value, \n                                        name === \"antes\" ? \"Antes\" : name === \"depois\" ? \"Depois\" : \"Variação\"\n                                      ]}\n                                      contentStyle={{ backgroundColor: \"hsl(var(--card))\", border: \"1px solid hsl(var(--border))\", borderRadius: \"var(--radius)\" }}\n                                    />\n                                    <Legend />\n                                    <Bar dataKey=\"antes\" name=\"Antes\" fill=\"hsl(210, 30%, 60%)\" radius={[4, 4, 0, 0]} />\n                                    <Bar dataKey=\"depois\" name=\"Depois\" fill=\"hsl(210, 100%, 40%)\" radius={[4, 4, 0, 0]} />\n                                  </BarChart>\n                                </ResponsiveContainer>\n                              </div>\n                              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                                {sim.impactAnalysis.seatChanges.slice(0, 4).map((change: any, i: number) => (\n                                  <div key={i} className=\"p-3 rounded-lg border text-center\">\n                                    <span className=\"font-medium\">{change.party}</span>\n                                    <div className=\"flex items-center justify-center gap-1 mt-1\">\n                                      <span className=\"text-muted-foreground\">{change.before}</span>\n                                      <ArrowRight className=\"h-3 w-3\" />\n                                      <span className={change.change > 0 ? \"text-success\" : change.change < 0 ? \"text-destructive\" : \"\"}>\n                                        {change.after}\n                                      </span>\n                                    </div>\n                                  </div>\n                                ))}\n                              </div>\n                            </>\n                          )}\n                          {sim.narrative && (\n                            <div className=\"bg-muted/50 rounded-lg p-4\">\n                              <p className=\"text-sm text-muted-foreground\">{sim.narrative}</p>\n                            </div>\n                          )}\n                          <div className=\"flex justify-end pt-2\">\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => exportPredictionToPdf({\n                                title: sim.name,\n                                subtitle: `Simulação: ${sim.simulationType}`,\n                                type: \"whatif\",\n                                data: sim,\n                                narrative: sim.narrative || undefined,\n                              })}\n                              data-testid={`button-export-simulation-${sim.id}`}\n                            >\n                              <Download className=\"h-4 w-4 mr-1\" />\n                              Exportar PDF\n                            </Button>\n                          </div>\n                        </CardContent>\n                      )}\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Shuffle className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>Nenhuma simulação criada</p>\n                  <p className=\"text-sm\">Crie uma nova simulação para explorar cenários hipotéticos</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":96430,"size_tokens":null},"server/replit_integrations/audio/routes.ts":{"content":"import type { Express, Request, Response } from \"express\";\nimport { chatStorage } from \"../chat/storage\";\nimport { openai, speechToText, voiceChatWithTextModel } from \"./client\";\n\nexport function registerAudioRoutes(app: Express): void {\n  // Get all conversations\n  app.get(\"/api/conversations\", async (req: Request, res: Response) => {\n    try {\n      const conversations = await chatStorage.getAllConversations();\n      res.json(conversations);\n    } catch (error) {\n      console.error(\"Error fetching conversations:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversations\" });\n    }\n  });\n\n  // Get single conversation with messages\n  app.get(\"/api/conversations/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const conversation = await chatStorage.getConversation(id);\n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      const messages = await chatStorage.getMessagesByConversation(id);\n      res.json({ ...conversation, messages });\n    } catch (error) {\n      console.error(\"Error fetching conversation:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversation\" });\n    }\n  });\n\n  // Create new conversation\n  app.post(\"/api/conversations\", async (req: Request, res: Response) => {\n    try {\n      const { title } = req.body;\n      const conversation = await chatStorage.createConversation(title || \"New Chat\");\n      res.status(201).json(conversation);\n    } catch (error) {\n      console.error(\"Error creating conversation:\", error);\n      res.status(500).json({ error: \"Failed to create conversation\" });\n    }\n  });\n\n  // Delete conversation\n  app.delete(\"/api/conversations/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      await chatStorage.deleteConversation(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting conversation:\", error);\n      res.status(500).json({ error: \"Failed to delete conversation\" });\n    }\n  });\n\n  // Send voice message and get streaming audio response\n  // Uses gpt-4o-mini-transcribe for STT, gpt-audio-mini for voice response\n  // For text model control, chain: speechToText() -> text model -> textToSpeech()\n  app.post(\"/api/conversations/:id/messages\", async (req: Request, res: Response) => {\n    try {\n      const conversationId = parseInt(req.params.id);\n      const { audio, voice = \"alloy\", inputFormat = \"wav\" } = req.body;\n\n      if (!audio) {\n        return res.status(400).json({ error: \"Audio data (base64) is required\" });\n      }\n\n      // 1. Transcribe user audio\n      const audioBuffer = Buffer.from(audio, \"base64\");\n      const userTranscript = await speechToText(audioBuffer, inputFormat);\n\n      // 2. Save user message\n      await chatStorage.createMessage(conversationId, \"user\", userTranscript);\n\n      // 3. Get conversation history\n      const existingMessages = await chatStorage.getMessagesByConversation(conversationId);\n      const chatHistory = existingMessages.map((m) => ({\n        role: m.role as \"user\" | \"assistant\",\n        content: m.content,\n      }));\n\n      // 4. Set up SSE\n      res.setHeader(\"Content-Type\", \"text/event-stream\");\n      res.setHeader(\"Cache-Control\", \"no-cache\");\n      res.setHeader(\"Connection\", \"keep-alive\");\n\n      res.write(`data: ${JSON.stringify({ type: \"user_transcript\", data: userTranscript })}\\n\\n`);\n\n      // 5. Stream audio response from gpt-audio-mini\n      const stream = await openai.chat.completions.create({\n        model: \"gpt-audio-mini\",\n        modalities: [\"text\", \"audio\"],\n        audio: { voice, format: \"pcm16\" },\n        messages: chatHistory,\n        stream: true,\n      });\n\n      let assistantTranscript = \"\";\n\n      for await (const chunk of stream) {\n        const delta = chunk.choices?.[0]?.delta as any;\n        if (!delta) continue;\n\n        if (delta?.audio?.transcript) {\n          assistantTranscript += delta.audio.transcript;\n          res.write(`data: ${JSON.stringify({ type: \"transcript\", data: delta.audio.transcript })}\\n\\n`);\n        }\n\n        if (delta?.audio?.data) {\n          res.write(`data: ${JSON.stringify({ type: \"audio\", data: delta.audio.data })}\\n\\n`);\n        }\n      }\n\n      // 6. Save assistant message\n      await chatStorage.createMessage(conversationId, \"assistant\", assistantTranscript);\n\n      res.write(`data: ${JSON.stringify({ type: \"done\", transcript: assistantTranscript })}\\n\\n`);\n      res.end();\n    } catch (error) {\n      console.error(\"Error processing voice message:\", error);\n      if (res.headersSent) {\n        res.write(`data: ${JSON.stringify({ type: \"error\", error: \"Failed to process voice message\" })}\\n\\n`);\n        res.end();\n      } else {\n        res.status(500).json({ error: \"Failed to process voice message\" });\n      }\n    }\n  });\n\n  // Voice chat using separate text model (GPT-5) + TTS pipeline\n  // Streams sentences to TTS as they're generated for lower latency\n  // Supports multilingual sentence detection via locale parameter\n  app.post(\"/api/conversations/:id/voice-stream\", async (req: Request, res: Response) => {\n    try {\n      const conversationId = parseInt(req.params.id);\n      const { audio, voice = \"alloy\", inputFormat = \"wav\", locale = \"en\" } = req.body;\n\n      if (!audio) {\n        return res.status(400).json({ error: \"Audio data (base64) is required\" });\n      }\n\n      // Get conversation history\n      const existingMessages = await chatStorage.getMessagesByConversation(conversationId);\n      const chatHistory = existingMessages.map((m) => ({\n        role: m.role as \"user\" | \"assistant\",\n        content: m.content,\n      }));\n\n      // Set up SSE\n      res.setHeader(\"Content-Type\", \"text/event-stream\");\n      res.setHeader(\"Cache-Control\", \"no-cache\");\n      res.setHeader(\"Connection\", \"keep-alive\");\n\n      const audioBuffer = Buffer.from(audio, \"base64\");\n      let userTranscript = \"\";\n      let assistantTranscript = \"\";\n\n      // Stream the voice chat pipeline\n      for await (const event of voiceChatWithTextModel(audioBuffer, {\n        voice,\n        inputFormat,\n        chatHistory,\n        locale,\n      })) {\n        if (event.type === \"user_transcript\") {\n          userTranscript = event.data || \"\";\n          await chatStorage.createMessage(conversationId, \"user\", userTranscript);\n        }\n        if (event.type === \"transcript\") {\n          assistantTranscript = event.data || \"\";\n        }\n\n        res.write(`data: ${JSON.stringify(event)}\\n\\n`);\n      }\n\n      // Save assistant message\n      await chatStorage.createMessage(conversationId, \"assistant\", assistantTranscript);\n      res.end();\n    } catch (error) {\n      console.error(\"Error in voice stream:\", error);\n      if (res.headersSent) {\n        res.write(`data: ${JSON.stringify({ type: \"error\", error: \"Voice stream failed\" })}\\n\\n`);\n        res.end();\n      } else {\n        res.status(500).json({ error: \"Voice stream failed\" });\n      }\n    }\n  });\n}\n","path":null,"size_bytes":7031,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"server/replit_integrations/audio/client.ts":{"content":"import OpenAI, { toFile } from \"openai\";\nimport { Buffer } from \"node:buffer\";\n\nexport const openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\n\n/**\n * Voice Chat: User speaks, LLM responds with audio (audio-in, audio-out).\n * Uses gpt-audio-mini model via Replit AI Integrations.\n * Note: Browser records WebM/opus - convert to WAV using ffmpeg before calling this.\n */\nexport async function voiceChat(\n  audioBuffer: Buffer,\n  voice: \"alloy\" | \"echo\" | \"fable\" | \"onyx\" | \"nova\" | \"shimmer\" = \"alloy\",\n  inputFormat: \"wav\" | \"mp3\" = \"wav\",\n  outputFormat: \"wav\" | \"mp3\" = \"mp3\"\n): Promise<{ transcript: string; audioResponse: Buffer }> {\n  const audioBase64 = audioBuffer.toString(\"base64\");\n  const response = await openai.chat.completions.create({\n    model: \"gpt-audio-mini\",\n    modalities: [\"text\", \"audio\"],\n    audio: { voice, format: outputFormat },\n    messages: [{\n      role: \"user\",\n      content: [\n        { type: \"input_audio\", input_audio: { data: audioBase64, format: inputFormat } },\n      ],\n    }],\n  });\n  const message = response.choices[0]?.message as any;\n  const transcript = message?.audio?.transcript || message?.content || \"\";\n  const audioData = message?.audio?.data ?? \"\";\n  return {\n    transcript,\n    audioResponse: Buffer.from(audioData, \"base64\"),\n  };\n}\n\n/**\n * Streaming Voice Chat: For real-time audio responses.\n * Note: Browser records WebM/opus - convert to WAV using ffmpeg before calling this.\n * Note: Streaming only supports pcm16 output format.\n */\nexport async function voiceChatStream(\n  audioBuffer: Buffer,\n  voice: \"alloy\" | \"echo\" | \"fable\" | \"onyx\" | \"nova\" | \"shimmer\" = \"alloy\",\n  inputFormat: \"wav\" | \"mp3\" = \"wav\"\n): Promise<AsyncIterable<{ type: \"transcript\" | \"audio\"; data: string }>> {\n  const audioBase64 = audioBuffer.toString(\"base64\");\n  const stream = await openai.chat.completions.create({\n    model: \"gpt-audio-mini\",\n    modalities: [\"text\", \"audio\"],\n    audio: { voice, format: \"pcm16\" },\n    messages: [{\n      role: \"user\",\n      content: [\n        { type: \"input_audio\", input_audio: { data: audioBase64, format: inputFormat } },\n      ],\n    }],\n    stream: true,\n  });\n\n  return (async function* () {\n    for await (const chunk of stream) {\n      const delta = chunk.choices?.[0]?.delta as any;\n      if (!delta) continue;\n      if (delta?.audio?.transcript) {\n        yield { type: \"transcript\", data: delta.audio.transcript };\n      }\n      if (delta?.audio?.data) {\n        yield { type: \"audio\", data: delta.audio.data };\n      }\n    }\n  })();\n}\n\n/**\n * Text-to-Speech: Converts text to speech verbatim.\n * Uses gpt-audio-mini model via Replit AI Integrations.\n */\nexport async function textToSpeech(\n  text: string,\n  voice: \"alloy\" | \"echo\" | \"fable\" | \"onyx\" | \"nova\" | \"shimmer\" = \"alloy\",\n  format: \"wav\" | \"mp3\" | \"flac\" | \"opus\" | \"pcm16\" = \"wav\"\n): Promise<Buffer> {\n  const response = await openai.chat.completions.create({\n    model: \"gpt-audio-mini\",\n    modalities: [\"text\", \"audio\"],\n    audio: { voice, format },\n    messages: [\n      { role: \"system\", content: \"You are an assistant that performs text-to-speech.\" },\n      { role: \"user\", content: `Repeat the following text verbatim: ${text}` },\n    ],\n  });\n  const audioData = (response.choices[0]?.message as any)?.audio?.data ?? \"\";\n  return Buffer.from(audioData, \"base64\");\n}\n\n/**\n * Streaming Text-to-Speech: Converts text to speech with real-time streaming.\n * Uses gpt-audio-mini model via Replit AI Integrations.\n * Note: Streaming only supports pcm16 output format.\n */\nexport async function textToSpeechStream(\n  text: string,\n  voice: \"alloy\" | \"echo\" | \"fable\" | \"onyx\" | \"nova\" | \"shimmer\" = \"alloy\"\n): Promise<AsyncIterable<string>> {\n  const stream = await openai.chat.completions.create({\n    model: \"gpt-audio-mini\",\n    modalities: [\"text\", \"audio\"],\n    audio: { voice, format: \"pcm16\" },\n    messages: [\n      { role: \"system\", content: \"You are an assistant that performs text-to-speech.\" },\n      { role: \"user\", content: `Repeat the following text verbatim: ${text}` },\n    ],\n    stream: true,\n  });\n\n  return (async function* () {\n    for await (const chunk of stream) {\n      const delta = chunk.choices?.[0]?.delta as any;\n      if (!delta) continue;\n      if (delta?.audio?.data) {\n        yield delta.audio.data;\n      }\n    }\n  })();\n}\n\n/**\n * Speech-to-Text: Transcribes audio using dedicated transcription model.\n * Uses gpt-4o-mini-transcribe for accurate transcription.\n */\nexport async function speechToText(\n  audioBuffer: Buffer,\n  format: \"wav\" | \"mp3\" | \"webm\" = \"wav\"\n): Promise<string> {\n  const file = await toFile(audioBuffer, `audio.${format}`);\n  const response = await openai.audio.transcriptions.create({\n    file,\n    model: \"gpt-4o-mini-transcribe\",\n  });\n  return response.text;\n}\n\n/**\n * Streaming Speech-to-Text: Transcribes audio with real-time streaming.\n * Uses gpt-4o-mini-transcribe for accurate transcription.\n */\nexport async function speechToTextStream(\n  audioBuffer: Buffer,\n  format: \"wav\" | \"mp3\" | \"webm\" = \"wav\"\n): Promise<AsyncIterable<string>> {\n  const file = await toFile(audioBuffer, `audio.${format}`);\n  const stream = await openai.audio.transcriptions.create({\n    file,\n    model: \"gpt-4o-mini-transcribe\",\n    stream: true,\n  });\n\n  return (async function* () {\n    for await (const event of stream) {\n      if (event.type === \"transcript.text.delta\") {\n        yield event.delta;\n      }\n    }\n  })();\n}\n\n// ============================================================\n// Sentence Parser - Multilingual using Intl.Segmenter\n// ============================================================\n\n/**\n * Extracts complete sentences from streaming text using Intl.Segmenter.\n * Supports multilingual text (handles CJK, Arabic, etc. properly).\n */\nexport class SentenceParser {\n  private buffer = \"\";\n  private seq = 0;\n  private segmenter: Intl.Segmenter;\n\n  constructor(locale = \"en\") {\n    // Intl.Segmenter handles sentence boundaries for all Unicode languages\n    // Falls back gracefully if locale not supported\n    this.segmenter = new Intl.Segmenter(locale, { granularity: \"sentence\" });\n  }\n\n  /**\n   * Feed tokens from LLM stream.\n   * Returns complete sentences with sequence numbers.\n   */\n  feed(token: string): Array<{ seq: number; text: string }> {\n    this.buffer += token;\n    const sentences: Array<{ seq: number; text: string }> = [];\n\n    // Segment current buffer\n    const segments = [...this.segmenter.segment(this.buffer)];\n\n    // All segments except the last are complete sentences\n    // (last segment might be incomplete, still accumulating tokens)\n    for (let i = 0; i < segments.length - 1; i++) {\n      const text = segments[i].segment.trim();\n      if (text) {\n        sentences.push({ seq: this.seq++, text });\n      }\n    }\n\n    // Keep only the last (potentially incomplete) segment in buffer\n    if (segments.length > 0) {\n      this.buffer = segments[segments.length - 1].segment;\n    }\n\n    return sentences;\n  }\n\n  /** Flush any remaining text as final sentence */\n  flush(): { seq: number; text: string } | null {\n    const text = this.buffer.trim();\n    this.buffer = \"\";\n    return text ? { seq: this.seq++, text } : null;\n  }\n\n  reset() {\n    this.buffer = \"\";\n    this.seq = 0;\n  }\n}\n\n// ============================================================\n// Cascading Voice Chat - STT → Text Model → TTS Pipeline\n// ============================================================\n\nexport interface VoiceChatStreamEvent {\n  type: \"user_transcript\" | \"sentence\" | \"audio\" | \"transcript\" | \"done\" | \"error\";\n  seq?: number;\n  data?: string;\n  text?: string;\n  error?: string;\n}\n\n/** Internal type for tracking active TTS streams */\ninterface TTSStream {\n  seq: number;\n  iterator: AsyncIterator<string>;\n  done: boolean;\n}\n\n/**\n * Voice chat using separate text model and TTS.\n *\n * Key behaviors:\n * - TTS starts immediately when a sentence completes (doesn't wait for previous TTS)\n * - Audio yields in sequence order (always yields seq 0 chunks before seq 1)\n * - Multiple TTS streams can run concurrently\n * - Low latency: streams chunks as they arrive from the current sentence's TTS\n */\nexport async function* voiceChatWithTextModel(\n  audioBuffer: Buffer,\n  options: {\n    voice?: \"alloy\" | \"echo\" | \"fable\" | \"onyx\" | \"nova\" | \"shimmer\";\n    inputFormat?: \"wav\" | \"mp3\";\n    systemPrompt?: string;\n    chatHistory?: Array<{ role: \"user\" | \"assistant\"; content: string }>;\n    textModel?: string;\n    locale?: string; // For sentence segmentation (e.g., \"en\", \"ja\", \"zh\")\n  } = {}\n): AsyncGenerator<VoiceChatStreamEvent> {\n  const {\n    voice = \"alloy\",\n    inputFormat = \"wav\",\n    systemPrompt = \"You are a helpful assistant.\",\n    chatHistory = [],\n    textModel = \"gpt-5\", // the newest OpenAI model is \"gpt-5\" which was released August 7, 2025\n    locale = \"en\",\n  } = options;\n\n  // 1. Transcribe user audio\n  const userText = await speechToText(audioBuffer, inputFormat);\n  yield { type: \"user_transcript\", data: userText };\n\n  // 2. Build messages for text model\n  const messages = [\n    { role: \"system\" as const, content: systemPrompt },\n    ...chatHistory,\n    { role: \"user\" as const, content: userText },\n  ];\n\n  // 3. Stream text from LLM\n  const textStream = await openai.chat.completions.create({\n    model: textModel,\n    messages,\n    stream: true,\n  });\n\n  // 4. Parse sentences and dispatch TTS in parallel\n  const parser = new SentenceParser(locale);\n  const activeStreams: TTSStream[] = [];\n  let nextSeqToYield = 0;\n  let fullTranscript = \"\";\n\n  /**\n   * Start TTS for a sentence. Runs concurrently with other TTS streams.\n   */\n  const startTTS = async (sentence: { seq: number; text: string }) => {\n    const stream = await textToSpeechStream(sentence.text, voice);\n    activeStreams.push({\n      seq: sentence.seq,\n      iterator: stream[Symbol.asyncIterator](),\n      done: false,\n    });\n  };\n\n  /**\n   * Yield audio chunks from active TTS streams in sequence order.\n   * - Always yields from the current sequence (nextSeqToYield) first\n   * - Buffers are not needed here because we yield directly from iterators\n   * - When current sequence's TTS is done, moves to next\n   */\n  async function* drainAudioInOrder(): AsyncGenerator<VoiceChatStreamEvent> {\n    while (activeStreams.length > 0) {\n      // Find the stream for the current sequence we should yield\n      const currentStream = activeStreams.find((s) => s.seq === nextSeqToYield);\n\n      if (!currentStream) {\n        // Next sequence hasn't started TTS yet, yield control back\n        return;\n      }\n\n      if (currentStream.done) {\n        // Current stream exhausted, move to next sequence\n        activeStreams.splice(activeStreams.indexOf(currentStream), 1);\n        nextSeqToYield++;\n        continue;\n      }\n\n      // Pull next chunk from current stream\n      const { value, done } = await currentStream.iterator.next();\n\n      if (done) {\n        currentStream.done = true;\n        activeStreams.splice(activeStreams.indexOf(currentStream), 1);\n        nextSeqToYield++;\n      } else {\n        yield { type: \"audio\", seq: currentStream.seq, data: value };\n      }\n    }\n  }\n\n  // 5. Process text stream: parse sentences, dispatch TTS, yield audio\n  for await (const chunk of textStream) {\n    const token = chunk.choices[0]?.delta?.content || \"\";\n    if (!token) continue;\n\n    fullTranscript += token;\n\n    // Extract complete sentences\n    const sentences = parser.feed(token);\n    for (const sentence of sentences) {\n      yield { type: \"sentence\", seq: sentence.seq, text: sentence.text };\n      await startTTS(sentence);\n    }\n\n    // Yield any ready audio (non-blocking: only yields if current seq has data)\n    for await (const event of drainAudioInOrder()) {\n      yield event;\n    }\n  }\n\n  // 6. Flush remaining sentence\n  const finalSentence = parser.flush();\n  if (finalSentence) {\n    yield { type: \"sentence\", seq: finalSentence.seq, text: finalSentence.text };\n    await startTTS(finalSentence);\n  }\n\n  // 7. Drain all remaining TTS audio (blocking: wait for all to complete)\n  while (activeStreams.length > 0) {\n    for await (const event of drainAudioInOrder()) {\n      yield event;\n    }\n    // Small yield to prevent tight loop if waiting for TTS\n    if (activeStreams.length > 0 && !activeStreams.find((s) => s.seq === nextSeqToYield)) {\n      await new Promise((r) => setTimeout(r, 10));\n    }\n  }\n\n  yield { type: \"transcript\", data: fullTranscript };\n  yield { type: \"done\" };\n}\n","path":null,"size_bytes":12546,"size_tokens":null},"client/src/components/notification-bell.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Bell, Check, AlertCircle, AlertTriangle, Info, FileText, Database } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ninterface Notification {\n  id: number;\n  type: string;\n  severity: string;\n  title: string;\n  message: string;\n  actionUrl: string | null;\n  isRead: boolean;\n  createdAt: string;\n  relatedEntityType: string | null;\n  relatedEntityId: string | null;\n}\n\ninterface NotificationsResponse {\n  notifications: Notification[];\n  unreadCount: number;\n}\n\nexport function NotificationBell() {\n  const [isOpen, setIsOpen] = useState(false);\n\n  const { data, isLoading } = useQuery<NotificationsResponse>({\n    queryKey: [\"/api/notifications\"],\n    refetchInterval: 30000,\n  });\n\n  const markAsReadMutation = useMutation({\n    mutationFn: (notificationId: number) =>\n      apiRequest(\"POST\", `/api/notifications/${notificationId}/read`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n    },\n  });\n\n  const markAllAsReadMutation = useMutation({\n    mutationFn: () => apiRequest(\"POST\", \"/api/notifications/mark-all-read\"),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n    },\n  });\n\n  useEffect(() => {\n    const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/imports`);\n    \n    ws.onmessage = (event) => {\n      try {\n        const data = JSON.parse(event.data);\n        if (data.type === \"notification.new\" || data.type === \"crisis.alert.new\") {\n          queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n        }\n      } catch (e) {\n      }\n    };\n\n    return () => ws.close();\n  }, []);\n\n  const unreadCount = data?.unreadCount || 0;\n  const notifications = data?.notifications || [];\n\n  const getSeverityIcon = (severity: string, type: string) => {\n    if (type === \"crisis_alert\") {\n      if (severity === \"critical\") return <AlertCircle className=\"w-4 h-4 text-destructive\" />;\n      if (severity === \"high\") return <AlertTriangle className=\"w-4 h-4 text-destructive\" />;\n      return <AlertCircle className=\"w-4 h-4 text-muted-foreground\" />;\n    }\n    if (type === \"import_complete\") return <Database className=\"w-4 h-4 text-primary\" />;\n    if (type === \"report_ready\") return <FileText className=\"w-4 h-4 text-primary\" />;\n    return <Info className=\"w-4 h-4 text-muted-foreground\" />;\n  };\n\n  const handleNotificationClick = (notification: Notification) => {\n    if (!notification.isRead) {\n      markAsReadMutation.mutate(notification.id);\n    }\n    if (notification.actionUrl) {\n      window.location.href = notification.actionUrl;\n    }\n    setIsOpen(false);\n  };\n\n  return (\n    <Popover open={isOpen} onOpenChange={setIsOpen}>\n      <PopoverTrigger asChild>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className=\"relative\"\n          data-testid=\"button-notification-bell\"\n        >\n          <Bell className=\"w-5 h-5\" />\n          {unreadCount > 0 && (\n            <Badge\n              variant=\"destructive\"\n              className=\"absolute -top-1 -right-1 h-5 w-5 flex items-center justify-center p-0 text-xs\"\n              data-testid=\"badge-unread-count\"\n            >\n              {unreadCount > 9 ? \"9+\" : unreadCount}\n            </Badge>\n          )}\n        </Button>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-80 p-0\" align=\"end\">\n        <div className=\"flex items-center justify-between p-3 border-b\">\n          <h4 className=\"font-semibold\">Notificações</h4>\n          {unreadCount > 0 && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => markAllAsReadMutation.mutate()}\n              disabled={markAllAsReadMutation.isPending}\n              data-testid=\"button-mark-all-read\"\n            >\n              <Check className=\"w-4 h-4 mr-1\" />\n              Marcar todas\n            </Button>\n          )}\n        </div>\n        <ScrollArea className=\"h-[300px]\">\n          {isLoading ? (\n            <div className=\"p-3 space-y-3\">\n              {[1, 2, 3].map((i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : notifications.length === 0 ? (\n            <div className=\"flex flex-col items-center justify-center h-[200px] text-muted-foreground\">\n              <Bell className=\"w-10 h-10 mb-2\" />\n              <p className=\"text-sm\">Nenhuma notificação</p>\n            </div>\n          ) : (\n            <div className=\"divide-y\">\n              {notifications.map((notification) => (\n                <div\n                  key={notification.id}\n                  className={`p-3 cursor-pointer hover-elevate ${\n                    !notification.isRead ? \"bg-muted/50\" : \"\"\n                  }`}\n                  onClick={() => handleNotificationClick(notification)}\n                  data-testid={`notification-item-${notification.id}`}\n                >\n                  <div className=\"flex items-start gap-3\">\n                    <div className=\"mt-0.5\">\n                      {getSeverityIcon(notification.severity, notification.type)}\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className={`text-sm font-medium ${!notification.isRead ? \"font-semibold\" : \"\"}`}>\n                          {notification.title}\n                        </span>\n                        {!notification.isRead && (\n                          <div className=\"w-2 h-2 rounded-full bg-primary\" />\n                        )}\n                      </div>\n                      <p className=\"text-xs text-muted-foreground line-clamp-2 mt-0.5\">\n                        {notification.message}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        {new Date(notification.createdAt).toLocaleString(\"pt-BR\", {\n                          day: \"2-digit\",\n                          month: \"2-digit\",\n                          hour: \"2-digit\",\n                          minute: \"2-digit\",\n                        })}\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </ScrollArea>\n      </PopoverContent>\n    </Popover>\n  );\n}\n","path":null,"size_bytes":6843,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile } from \"fs/promises\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"nodemailer\",\n  \"openai\",\n  \"passport\",\n  \"passport-local\",\n  \"pg\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"xlsx\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":1417,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/lib/pdf-export.ts":{"content":"import jsPDF from \"jspdf\";\nimport \"jspdf-autotable\";\n\ndeclare module \"jspdf\" {\n  interface jsPDF {\n    autoTable: (options: any) => jsPDF;\n    lastAutoTable: { finalY: number };\n  }\n}\n\ninterface PredictionResult {\n  parties?: Array<{ party: string; voteShare?: number; seats?: number; trend?: string }>;\n  candidates?: Array<{ name: string; party: string; projectedVoteShare?: number; electionProbability?: number }>;\n  overallWinner?: string;\n  confidence?: number;\n}\n\ninterface ExportOptions {\n  title: string;\n  subtitle?: string;\n  date?: string;\n  type: \"prediction\" | \"comparison\" | \"event\" | \"whatif\";\n  data: any;\n  narrative?: string;\n}\n\nconst TSE_BLUE = [0, 51, 102];\nconst TSE_GOLD = [255, 215, 0];\n\nexport function exportPredictionToPdf(options: ExportOptions): void {\n  const doc = new jsPDF();\n  const pageWidth = doc.internal.pageSize.getWidth();\n  const margin = 20;\n  let yPos = margin;\n\n  doc.setFillColor(TSE_BLUE[0], TSE_BLUE[1], TSE_BLUE[2]);\n  doc.rect(0, 0, pageWidth, 40, \"F\");\n\n  doc.setTextColor(255, 255, 255);\n  doc.setFontSize(20);\n  doc.setFont(\"helvetica\", \"bold\");\n  doc.text(\"SimulaVoto\", margin, 20);\n\n  doc.setFontSize(12);\n  doc.setFont(\"helvetica\", \"normal\");\n  doc.text(\"Sistema de Simulação Eleitoral\", margin, 30);\n\n  doc.setFillColor(TSE_GOLD[0], TSE_GOLD[1], TSE_GOLD[2]);\n  doc.rect(0, 40, pageWidth, 3, \"F\");\n\n  yPos = 55;\n\n  doc.setTextColor(0, 0, 0);\n  doc.setFontSize(16);\n  doc.setFont(\"helvetica\", \"bold\");\n  doc.text(options.title, margin, yPos);\n  yPos += 8;\n\n  if (options.subtitle) {\n    doc.setFontSize(11);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setTextColor(100, 100, 100);\n    doc.text(options.subtitle, margin, yPos);\n    yPos += 6;\n  }\n\n  doc.setFontSize(10);\n  doc.setTextColor(120, 120, 120);\n  doc.text(`Gerado em: ${options.date || new Date().toLocaleString(\"pt-BR\")}`, margin, yPos);\n  yPos += 15;\n\n  doc.setDrawColor(200, 200, 200);\n  doc.line(margin, yPos - 5, pageWidth - margin, yPos - 5);\n\n  switch (options.type) {\n    case \"prediction\":\n      renderPredictionData(doc, options.data, margin, yPos, pageWidth);\n      break;\n    case \"comparison\":\n      renderComparisonData(doc, options.data, margin, yPos, pageWidth);\n      break;\n    case \"event\":\n      renderEventData(doc, options.data, margin, yPos, pageWidth);\n      break;\n    case \"whatif\":\n      renderWhatIfData(doc, options.data, margin, yPos, pageWidth);\n      break;\n  }\n\n  if (options.narrative) {\n    const lastY = doc.lastAutoTable?.finalY || yPos + 80;\n    renderNarrative(doc, options.narrative, margin, lastY + 15, pageWidth);\n  }\n\n  const pageHeight = doc.internal.pageSize.getHeight();\n  doc.setFillColor(TSE_BLUE[0], TSE_BLUE[1], TSE_BLUE[2]);\n  doc.rect(0, pageHeight - 15, pageWidth, 15, \"F\");\n  doc.setTextColor(255, 255, 255);\n  doc.setFontSize(8);\n  doc.text(\"SimulaVoto - Análise Eleitoral Brasileira\", pageWidth / 2, pageHeight - 6, { align: \"center\" });\n\n  const filename = `${options.title.toLowerCase().replace(/\\s+/g, \"_\")}_${new Date().toISOString().slice(0, 10)}.pdf`;\n  doc.save(filename);\n}\n\nfunction renderPredictionData(doc: jsPDF, data: any, margin: number, yPos: number, pageWidth: number): void {\n  if (data.results?.parties && data.results.parties.length > 0) {\n    doc.setFontSize(12);\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.setTextColor(0, 0, 0);\n    doc.text(\"Projeção de Votos por Partido\", margin, yPos);\n    yPos += 8;\n\n    const tableData = data.results.parties.map((p: any, i: number) => [\n      i + 1,\n      p.party,\n      `${(p.voteShare || 0).toFixed(1)}%`,\n      p.seats || \"-\",\n      p.trend === \"growing\" ? \"↑\" : p.trend === \"declining\" ? \"↓\" : \"-\"\n    ]);\n\n    doc.autoTable({\n      startY: yPos,\n      head: [[\"#\", \"Partido\", \"% Votos\", \"Assentos\", \"Tendência\"]],\n      body: tableData,\n      theme: \"striped\",\n      headStyles: { fillColor: TSE_BLUE, textColor: [255, 255, 255] },\n      alternateRowStyles: { fillColor: [245, 245, 245] },\n      margin: { left: margin, right: margin },\n    });\n  }\n\n  if (data.confidence) {\n    const lastY = doc.lastAutoTable?.finalY || yPos + 50;\n    doc.setFontSize(10);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setTextColor(80, 80, 80);\n    doc.text(`Nível de Confiança: ${(data.confidence * 100).toFixed(0)}%`, margin, lastY + 10);\n  }\n}\n\nfunction renderComparisonData(doc: jsPDF, data: any, margin: number, yPos: number, pageWidth: number): void {\n  doc.setFontSize(12);\n  doc.setFont(\"helvetica\", \"bold\");\n  doc.setTextColor(0, 0, 0);\n  doc.text(\"Comparação de Candidatos\", margin, yPos);\n  yPos += 8;\n\n  if (data.results?.candidates && data.results.candidates.length > 0) {\n    const tableData = data.results.candidates.map((c: any) => [\n      c.name,\n      c.party,\n      `${(c.projectedVoteShare || 0).toFixed(1)}%`,\n      `${((c.electionProbability || 0) * 100).toFixed(0)}%`,\n      c.name === data.results.overallWinner ? \"★\" : \"\"\n    ]);\n\n    doc.autoTable({\n      startY: yPos,\n      head: [[\"Candidato\", \"Partido\", \"% Projetado\", \"Prob. Eleição\", \"Favorito\"]],\n      body: tableData,\n      theme: \"striped\",\n      headStyles: { fillColor: TSE_BLUE, textColor: [255, 255, 255] },\n      alternateRowStyles: { fillColor: [245, 245, 245] },\n      margin: { left: margin, right: margin },\n    });\n  }\n\n  if (data.results?.overallWinner) {\n    const lastY = doc.lastAutoTable?.finalY || yPos + 50;\n    doc.setFontSize(11);\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.setTextColor(TSE_BLUE[0], TSE_BLUE[1], TSE_BLUE[2]);\n    doc.text(`Vencedor Projetado: ${data.results.overallWinner}`, margin, lastY + 10);\n  }\n}\n\nfunction renderEventData(doc: jsPDF, data: any, margin: number, yPos: number, pageWidth: number): void {\n  doc.setFontSize(12);\n  doc.setFont(\"helvetica\", \"bold\");\n  doc.setTextColor(0, 0, 0);\n  doc.text(\"Análise de Impacto de Evento\", margin, yPos);\n  yPos += 8;\n\n  doc.setFontSize(10);\n  doc.setFont(\"helvetica\", \"normal\");\n  doc.setTextColor(60, 60, 60);\n  \n  const eventDesc = data.eventDescription || \"Descrição não disponível\";\n  const splitDesc = doc.splitTextToSize(eventDesc, pageWidth - 2 * margin);\n  doc.text(splitDesc, margin, yPos);\n  yPos += splitDesc.length * 5 + 10;\n\n  if (data.beforeProjection?.parties && data.afterProjection?.parties) {\n    doc.setFontSize(11);\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.setTextColor(0, 0, 0);\n    doc.text(\"Comparação Antes/Depois\", margin, yPos);\n    yPos += 8;\n\n    const beforeMap = new Map<string, number>(data.beforeProjection.parties.map((p: any) => [p.party, p.voteShare || 0]));\n    const tableData = data.afterProjection.parties.slice(0, 8).map((p: any) => {\n      const before: number = beforeMap.get(p.party) || 0;\n      const after: number = p.voteShare || 0;\n      const change: number = after - before;\n      return [\n        p.party,\n        `${before.toFixed(1)}%`,\n        `${after.toFixed(1)}%`,\n        `${change >= 0 ? \"+\" : \"\"}${change.toFixed(1)}%`,\n        p.trend === \"growing\" ? \"↑\" : p.trend === \"declining\" ? \"↓\" : \"-\"\n      ];\n    });\n\n    doc.autoTable({\n      startY: yPos,\n      head: [[\"Partido\", \"Antes\", \"Depois\", \"Variação\", \"Tendência\"]],\n      body: tableData,\n      theme: \"striped\",\n      headStyles: { fillColor: TSE_BLUE, textColor: [255, 255, 255] },\n      alternateRowStyles: { fillColor: [245, 245, 245] },\n      margin: { left: margin, right: margin },\n    });\n  }\n}\n\nfunction renderWhatIfData(doc: jsPDF, data: any, margin: number, yPos: number, pageWidth: number): void {\n  doc.setFontSize(12);\n  doc.setFont(\"helvetica\", \"bold\");\n  doc.setTextColor(0, 0, 0);\n  doc.text('Simulação \"E se...?\"', margin, yPos);\n  yPos += 8;\n\n  doc.setFontSize(10);\n  doc.setFont(\"helvetica\", \"normal\");\n  doc.setTextColor(60, 60, 60);\n\n  if (data.parameters) {\n    const params = data.parameters;\n    if (params.candidateName && params.fromParty && params.toParty) {\n      doc.text(`Cenário: ${params.candidateName} muda de ${params.fromParty} para ${params.toParty}`, margin, yPos);\n      yPos += 8;\n    }\n  }\n\n  if (data.impactAnalysis) {\n    yPos += 5;\n    doc.setFontSize(11);\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.text(`Impacto Geral: ${data.impactAnalysis.overallImpact || \"N/A\"}`, margin, yPos);\n    yPos += 6;\n\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.text(`Confiança: ${((data.impactAnalysis.confidence || 0) * 100).toFixed(0)}%`, margin, yPos);\n    yPos += 10;\n\n    if (data.impactAnalysis.seatChanges && data.impactAnalysis.seatChanges.length > 0) {\n      const tableData = data.impactAnalysis.seatChanges.map((c: any) => [\n        c.party,\n        c.before,\n        c.after,\n        `${c.change >= 0 ? \"+\" : \"\"}${c.change}`\n      ]);\n\n      doc.autoTable({\n        startY: yPos,\n        head: [[\"Partido\", \"Antes\", \"Depois\", \"Variação\"]],\n        body: tableData,\n        theme: \"striped\",\n        headStyles: { fillColor: TSE_BLUE, textColor: [255, 255, 255] },\n        alternateRowStyles: { fillColor: [245, 245, 245] },\n        margin: { left: margin, right: margin },\n      });\n    }\n  }\n}\n\nfunction renderNarrative(doc: jsPDF, narrative: string, margin: number, yPos: number, pageWidth: number): void {\n  doc.setFontSize(11);\n  doc.setFont(\"helvetica\", \"bold\");\n  doc.setTextColor(TSE_BLUE[0], TSE_BLUE[1], TSE_BLUE[2]);\n  doc.text(\"Análise de IA\", margin, yPos);\n  yPos += 8;\n\n  doc.setFontSize(10);\n  doc.setFont(\"helvetica\", \"italic\");\n  doc.setTextColor(60, 60, 60);\n  \n  const splitNarrative = doc.splitTextToSize(narrative, pageWidth - 2 * margin);\n  doc.text(splitNarrative, margin, yPos);\n}\n\nexport function exportMultiplePredictionsToPdf(predictions: ExportOptions[]): void {\n  const doc = new jsPDF();\n  const pageWidth = doc.internal.pageSize.getWidth();\n  const margin = 20;\n\n  doc.setFillColor(TSE_BLUE[0], TSE_BLUE[1], TSE_BLUE[2]);\n  doc.rect(0, 0, pageWidth, 40, \"F\");\n  doc.setTextColor(255, 255, 255);\n  doc.setFontSize(20);\n  doc.setFont(\"helvetica\", \"bold\");\n  doc.text(\"SimulaVoto - Relatório Consolidado\", margin, 25);\n  doc.setFillColor(TSE_GOLD[0], TSE_GOLD[1], TSE_GOLD[2]);\n  doc.rect(0, 40, pageWidth, 3, \"F\");\n\n  let yPos = 55;\n  doc.setTextColor(0, 0, 0);\n  doc.setFontSize(10);\n  doc.text(`Gerado em: ${new Date().toLocaleString(\"pt-BR\")}`, margin, yPos);\n  doc.text(`Total de previsões: ${predictions.length}`, margin, yPos + 6);\n\n  predictions.forEach((prediction, index) => {\n    doc.addPage();\n    let y = 20;\n    \n    doc.setFontSize(14);\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.setTextColor(TSE_BLUE[0], TSE_BLUE[1], TSE_BLUE[2]);\n    doc.text(`${index + 1}. ${prediction.title}`, margin, y);\n    y += 10;\n\n    if (prediction.subtitle) {\n      doc.setFontSize(10);\n      doc.setFont(\"helvetica\", \"normal\");\n      doc.setTextColor(100, 100, 100);\n      doc.text(prediction.subtitle, margin, y);\n      y += 8;\n    }\n\n    switch (prediction.type) {\n      case \"prediction\":\n        renderPredictionData(doc, prediction.data, margin, y, pageWidth);\n        break;\n      case \"comparison\":\n        renderComparisonData(doc, prediction.data, margin, y, pageWidth);\n        break;\n      case \"event\":\n        renderEventData(doc, prediction.data, margin, y, pageWidth);\n        break;\n      case \"whatif\":\n        renderWhatIfData(doc, prediction.data, margin, y, pageWidth);\n        break;\n    }\n\n    if (prediction.narrative) {\n      const lastY = doc.lastAutoTable?.finalY || y + 80;\n      renderNarrative(doc, prediction.narrative, margin, lastY + 15, pageWidth);\n    }\n  });\n\n  const filename = `simulavoto_relatorio_${new Date().toISOString().slice(0, 10)}.pdf`;\n  doc.save(filename);\n}","path":null,"size_bytes":11548,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":547,"size_tokens":null},"client/src/components/empty-state.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport type { LucideIcon } from \"lucide-react\";\n\ninterface EmptyStateProps {\n  icon: LucideIcon;\n  title: string;\n  description: string;\n  actionLabel?: string;\n  onAction?: () => void;\n}\n\nexport function EmptyState({\n  icon: Icon,\n  title,\n  description,\n  actionLabel,\n  onAction,\n}: EmptyStateProps) {\n  return (\n    <div className=\"flex flex-col items-center justify-center py-12 px-4 text-center\">\n      <div className=\"flex h-16 w-16 items-center justify-center rounded-full bg-muted mb-4\">\n        <Icon className=\"h-8 w-8 text-muted-foreground\" />\n      </div>\n      <h3 className=\"text-lg font-semibold mb-2\">{title}</h3>\n      <p className=\"text-muted-foreground max-w-md mb-6\">{description}</p>\n      {actionLabel && onAction && (\n        <Button onClick={onAction} data-testid=\"button-empty-action\">\n          {actionLabel}\n        </Button>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":930,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"server/election-simulation.ts":{"content":"import { storage } from \"./storage\";\nimport { broadcastElectionEvent, emitElectionUpdate, emitElectionProjection } from \"./websocket\";\nimport { randomUUID } from \"crypto\";\n\ninterface PartyVoteState {\n  party: string;\n  totalVotes: number;\n  countedVotes: number;\n  projectedVotes: number;\n  confidence: number;\n  trend: \"up\" | \"down\" | \"stable\";\n  color?: string;\n}\n\ninterface CandidateVoteState {\n  name: string;\n  party: string;\n  totalVotes: number;\n  countedVotes: number;\n  winProbability: number;\n}\n\ninterface SimulationState {\n  id: string;\n  status: \"running\" | \"paused\" | \"completed\" | \"cancelled\";\n  startedAt: Date;\n  year: number;\n  state?: string;\n  position?: string;\n  totalVotes: number;\n  countedVotes: number;\n  percentageCounted: number;\n  totalRegions: number;\n  regionsCounted: number;\n  partyStates: Map<string, PartyVoteState>;\n  candidateStates: Map<string, CandidateVoteState>;\n  updateInterval?: ReturnType<typeof setInterval>;\n  projectionInterval?: ReturnType<typeof setInterval>;\n}\n\nconst activeSimulations = new Map<string, SimulationState>();\nconst MAX_ACTIVE_SIMULATIONS = 5;\nconst SIMULATION_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes max\n\nfunction cleanupStaleSimulations(): void {\n  const now = Date.now();\n  const entries = Array.from(activeSimulations.entries());\n  for (const [id, sim] of entries) {\n    const elapsed = now - sim.startedAt.getTime();\n    if (elapsed > SIMULATION_TIMEOUT_MS) {\n      console.log(`[Simulation] Auto-cleanup stale simulation ${id} after ${Math.round(elapsed / 1000)}s`);\n      if (sim.updateInterval) clearInterval(sim.updateInterval);\n      if (sim.projectionInterval) clearInterval(sim.projectionInterval);\n      activeSimulations.delete(id);\n    }\n  }\n}\n\nexport async function startElectionSimulation(options: {\n  year: number;\n  state?: string;\n  position?: string;\n  speed?: number;\n}): Promise<{ simulationId: string; message: string }> {\n  cleanupStaleSimulations();\n  \n  if (activeSimulations.size >= MAX_ACTIVE_SIMULATIONS) {\n    throw new Error(`Maximum of ${MAX_ACTIVE_SIMULATIONS} concurrent simulations allowed. Please wait for existing simulations to complete.`);\n  }\n  \n  const simulationId = randomUUID();\n  const speed = options.speed || 1;\n\n  const historicalData = await storage.getHistoricalVotesByParty({\n    years: [options.year],\n    position: options.position,\n    state: options.state,\n  });\n\n  if (historicalData.length === 0) {\n    throw new Error(\"No historical data found for the specified parameters\");\n  }\n\n  const totalVotes = historicalData.reduce((sum, d) => sum + d.totalVotes, 0);\n  const totalCandidates = historicalData.reduce((sum, d) => sum + d.candidateCount, 0);\n\n  const partyStates = new Map<string, PartyVoteState>();\n  for (const data of historicalData) {\n    if (!partyStates.has(data.party)) {\n      partyStates.set(data.party, {\n        party: data.party,\n        totalVotes: data.totalVotes,\n        countedVotes: 0,\n        projectedVotes: data.totalVotes,\n        confidence: 0,\n        trend: \"stable\",\n      });\n    } else {\n      const existing = partyStates.get(data.party)!;\n      existing.totalVotes += data.totalVotes;\n      existing.projectedVotes += data.totalVotes;\n    }\n  }\n\n  const candidateStates = new Map<string, CandidateVoteState>();\n  const topCandidatesData = await storage.getTopCandidates({\n    year: options.year,\n    uf: options.state,\n    limit: 20,\n  });\n\n  for (const candidate of topCandidatesData) {\n    candidateStates.set(candidate.name, {\n      name: candidate.name,\n      party: candidate.party || \"N/A\",\n      totalVotes: candidate.votes,\n      countedVotes: 0,\n      winProbability: 0,\n    });\n  }\n\n  const simulation: SimulationState = {\n    id: simulationId,\n    status: \"running\",\n    startedAt: new Date(),\n    year: options.year,\n    state: options.state,\n    position: options.position,\n    totalVotes,\n    countedVotes: 0,\n    percentageCounted: 0,\n    totalRegions: 27,\n    regionsCounted: 0,\n    partyStates,\n    candidateStates,\n  };\n\n  activeSimulations.set(simulationId, simulation);\n\n  broadcastElectionEvent({\n    type: \"election.simulation.started\",\n    simulationId,\n    data: {\n      year: options.year,\n      state: options.state,\n      position: options.position,\n      totalVotes,\n      totalParties: partyStates.size,\n      totalCandidates: candidateStates.size,\n      startedAt: simulation.startedAt.toISOString(),\n    },\n  });\n\n  const baseInterval = 2000 / speed;\n  simulation.updateInterval = setInterval(() => {\n    updateSimulation(simulationId);\n  }, baseInterval);\n\n  simulation.projectionInterval = setInterval(() => {\n    updateProjections(simulationId);\n  }, baseInterval * 3);\n\n  return { simulationId, message: \"Simulação de apuração iniciada\" };\n}\n\nfunction updateSimulation(simulationId: string): void {\n  const simulation = activeSimulations.get(simulationId);\n  if (!simulation || simulation.status !== \"running\") return;\n\n  const incrementPercent = 0.5 + Math.random() * 1.5;\n  const increment = Math.floor((simulation.totalVotes * incrementPercent) / 100);\n  \n  simulation.countedVotes = Math.min(simulation.countedVotes + increment, simulation.totalVotes);\n  simulation.percentageCounted = (simulation.countedVotes / simulation.totalVotes) * 100;\n\n  const regionProgress = simulation.percentageCounted / 100;\n  simulation.regionsCounted = Math.floor(simulation.totalRegions * regionProgress);\n\n  const partyResults: Array<{ party: string; votes: number; percentage: number; projected?: number }> = [];\n  let totalCountedPartyVotes = 0;\n\n  Array.from(simulation.partyStates.entries()).forEach(([party, state]) => {\n    const noise = 0.95 + Math.random() * 0.1;\n    const targetVotes = Math.floor(state.totalVotes * regionProgress * noise);\n    state.countedVotes = Math.min(targetVotes, state.totalVotes);\n    totalCountedPartyVotes += state.countedVotes;\n  });\n\n  Array.from(simulation.partyStates.entries()).forEach(([party, state]) => {\n    const percentage = totalCountedPartyVotes > 0 \n      ? (state.countedVotes / totalCountedPartyVotes) * 100 \n      : 0;\n    \n    partyResults.push({\n      party,\n      votes: state.countedVotes,\n      percentage,\n      projected: state.projectedVotes,\n    });\n  });\n\n  partyResults.sort((a, b) => b.votes - a.votes);\n\n  const candidateResults: Array<{ name: string; party: string; votes: number; percentage: number }> = [];\n  let totalCountedCandidateVotes = 0;\n\n  Array.from(simulation.candidateStates.entries()).forEach(([name, state]) => {\n    const noise = 0.9 + Math.random() * 0.2;\n    const targetVotes = Math.floor(state.totalVotes * regionProgress * noise);\n    state.countedVotes = Math.min(targetVotes, state.totalVotes);\n    totalCountedCandidateVotes += state.countedVotes;\n  });\n\n  Array.from(simulation.candidateStates.entries()).forEach(([name, state]) => {\n    const percentage = totalCountedCandidateVotes > 0 \n      ? (state.countedVotes / totalCountedCandidateVotes) * 100 \n      : 0;\n    \n    candidateResults.push({\n      name,\n      party: state.party,\n      votes: state.countedVotes,\n      percentage,\n    });\n  });\n\n  candidateResults.sort((a, b) => b.votes - a.votes);\n\n  emitElectionUpdate(simulationId, {\n    countedVotes: simulation.countedVotes,\n    totalVotes: simulation.totalVotes,\n    percentageCounted: simulation.percentageCounted,\n    partyResults: partyResults.slice(0, 15),\n    candidateResults: candidateResults.slice(0, 10),\n    regionsCounted: simulation.regionsCounted,\n    totalRegions: simulation.totalRegions,\n    timestamp: new Date().toISOString(),\n  });\n\n  if (simulation.percentageCounted >= 100) {\n    completeSimulation(simulationId);\n  }\n}\n\nfunction updateProjections(simulationId: string): void {\n  const simulation = activeSimulations.get(simulationId);\n  if (!simulation || simulation.status !== \"running\") return;\n  if (simulation.percentageCounted < 5) return;\n\n  const partyProjections: Array<{ \n    party: string; \n    currentVotes: number; \n    projectedVotes: number; \n    confidence: number;\n    trend: \"up\" | \"down\" | \"stable\";\n  }> = [];\n\n  const percentCounted = simulation.percentageCounted / 100;\n  const confidenceBase = Math.min(95, 50 + (percentCounted * 45));\n\n  Array.from(simulation.partyStates.entries()).forEach(([party, state]) => {\n    if (state.countedVotes === 0) return;\n\n    const projectionFactor = 1 / percentCounted;\n    const noise = 0.98 + Math.random() * 0.04;\n    const projectedVotes = Math.floor(state.countedVotes * projectionFactor * noise);\n    \n    const prevProjected = state.projectedVotes;\n    state.projectedVotes = projectedVotes;\n    \n    if (projectedVotes > prevProjected * 1.02) {\n      state.trend = \"up\";\n    } else if (projectedVotes < prevProjected * 0.98) {\n      state.trend = \"down\";\n    } else {\n      state.trend = \"stable\";\n    }\n    \n    state.confidence = confidenceBase + (Math.random() * 5 - 2.5);\n\n    partyProjections.push({\n      party,\n      currentVotes: state.countedVotes,\n      projectedVotes: state.projectedVotes,\n      confidence: state.confidence,\n      trend: state.trend,\n    });\n  });\n\n  partyProjections.sort((a, b) => b.projectedVotes - a.projectedVotes);\n\n  const leadingCandidates: Array<{\n    name: string;\n    party: string;\n    currentVotes: number;\n    projectedVotes: number;\n    winProbability: number;\n  }> = [];\n\n  const candidateArray = Array.from(simulation.candidateStates.values());\n  candidateArray.sort((a, b) => b.countedVotes - a.countedVotes);\n  \n  const topCandidates = candidateArray.slice(0, 5);\n  const totalTopVotes = topCandidates.reduce((sum, c) => sum + c.countedVotes, 0);\n\n  for (const candidate of topCandidates) {\n    const projectionFactor = 1 / percentCounted;\n    const projectedVotes = Math.floor(candidate.countedVotes * projectionFactor);\n    \n    const voteShare = totalTopVotes > 0 ? candidate.countedVotes / totalTopVotes : 0;\n    candidate.winProbability = Math.min(99, voteShare * 100 * (0.8 + percentCounted * 0.2));\n\n    leadingCandidates.push({\n      name: candidate.name,\n      party: candidate.party,\n      currentVotes: candidate.countedVotes,\n      projectedVotes,\n      winProbability: candidate.winProbability,\n    });\n  }\n\n  emitElectionProjection(simulationId, {\n    partyProjections: partyProjections.slice(0, 10),\n    leadingCandidates,\n    percentageCounted: simulation.percentageCounted,\n    timestamp: new Date().toISOString(),\n  });\n}\n\nfunction completeSimulation(simulationId: string): void {\n  const simulation = activeSimulations.get(simulationId);\n  if (!simulation) return;\n\n  if (simulation.updateInterval) clearInterval(simulation.updateInterval);\n  if (simulation.projectionInterval) clearInterval(simulation.projectionInterval);\n  \n  simulation.status = \"completed\";\n\n  const finalPartyResults = Array.from(simulation.partyStates.values())\n    .map(s => ({\n      party: s.party,\n      votes: s.countedVotes,\n      percentage: (s.countedVotes / simulation.countedVotes) * 100,\n    }))\n    .sort((a, b) => b.votes - a.votes);\n\n  const finalCandidateResults = Array.from(simulation.candidateStates.values())\n    .map(s => ({\n      name: s.name,\n      party: s.party,\n      votes: s.countedVotes,\n    }))\n    .sort((a, b) => b.votes - a.votes);\n\n  broadcastElectionEvent({\n    type: \"election.simulation.completed\",\n    simulationId,\n    data: {\n      totalVotes: simulation.countedVotes,\n      partyResults: finalPartyResults.slice(0, 15),\n      candidateResults: finalCandidateResults.slice(0, 10),\n      completedAt: new Date().toISOString(),\n      duration: Date.now() - simulation.startedAt.getTime(),\n    },\n  });\n\n  setTimeout(() => {\n    activeSimulations.delete(simulationId);\n  }, 60000);\n}\n\nexport function pauseSimulation(simulationId: string): boolean {\n  const simulation = activeSimulations.get(simulationId);\n  if (!simulation || simulation.status !== \"running\") return false;\n\n  if (simulation.updateInterval) clearInterval(simulation.updateInterval);\n  if (simulation.projectionInterval) clearInterval(simulation.projectionInterval);\n  simulation.status = \"paused\";\n\n  return true;\n}\n\nexport function resumeSimulation(simulationId: string, speed: number = 1): boolean {\n  const simulation = activeSimulations.get(simulationId);\n  if (!simulation || simulation.status !== \"paused\") return false;\n\n  simulation.status = \"running\";\n  const baseInterval = 2000 / speed;\n  \n  simulation.updateInterval = setInterval(() => {\n    updateSimulation(simulationId);\n  }, baseInterval);\n\n  simulation.projectionInterval = setInterval(() => {\n    updateProjections(simulationId);\n  }, baseInterval * 3);\n\n  return true;\n}\n\nexport function cancelSimulation(simulationId: string): boolean {\n  const simulation = activeSimulations.get(simulationId);\n  if (!simulation) return false;\n\n  if (simulation.updateInterval) clearInterval(simulation.updateInterval);\n  if (simulation.projectionInterval) clearInterval(simulation.projectionInterval);\n  simulation.status = \"cancelled\";\n  \n  activeSimulations.delete(simulationId);\n  return true;\n}\n\nexport function getSimulationStatus(simulationId: string): SimulationState | null {\n  return activeSimulations.get(simulationId) || null;\n}\n\nexport function getActiveSimulations(): Array<{\n  id: string;\n  status: string;\n  year: number;\n  state?: string;\n  percentageCounted: number;\n  startedAt: string;\n}> {\n  return Array.from(activeSimulations.values()).map(s => ({\n    id: s.id,\n    status: s.status,\n    year: s.year,\n    state: s.state,\n    percentageCounted: s.percentageCounted,\n    startedAt: s.startedAt.toISOString(),\n  }));\n}\n","path":null,"size_bytes":13524,"size_tokens":null},"server/data-validation.ts":{"content":"import OpenAI from \"openai\";\nimport { z } from \"zod\";\nimport { storage } from \"./storage\";\nimport { db } from \"./db\";\nimport { sql, eq, and, gt, lt } from \"drizzle-orm\";\nimport { tseCandidateVotes } from \"@shared/schema\";\n\nconst openai = new OpenAI();\n\nexport interface ValidationIssue {\n  type: string;\n  severity: \"error\" | \"warning\" | \"info\";\n  category: \"data_quality\" | \"consistency\" | \"statistical\" | \"format\";\n  rowReference?: string;\n  field?: string;\n  currentValue?: string;\n  message: string;\n  suggestedFix?: {\n    action: \"correct\" | \"remove\" | \"review\" | \"ignore\";\n    newValue?: string | number;\n    confidence: number;\n    reasoning: string;\n  };\n}\n\nexport interface ValidationSummary {\n  totalRecordsChecked: number;\n  issuesFound: number;\n  byType: Record<string, number>;\n  bySeverity: Record<string, number>;\n  byCategory: Record<string, number>;\n  sampleIssues: ValidationIssue[];\n}\n\nexport interface ValidationResult {\n  issues: ValidationIssue[];\n  summary: ValidationSummary;\n}\n\nconst aiValidationResponseSchema = z.object({\n  analysis: z.string(),\n  recommendations: z.array(z.object({\n    issue: z.string(),\n    severity: z.enum([\"error\", \"warning\", \"info\"]),\n    suggestedAction: z.string(),\n    confidence: z.number().min(0).max(1),\n    affectedRecords: z.string().optional(),\n  })).optional().default([]),\n  overallDataQuality: z.object({\n    score: z.number().min(0).max(100),\n    assessment: z.string(),\n    keyFindings: z.array(z.string()),\n    risksIdentified: z.array(z.string()),\n  }).optional(),\n});\n\nexport async function runValidation(jobId: number): Promise<{\n  runId: number;\n  summary: ValidationSummary;\n  aiAnalysis?: unknown;\n}> {\n  const run = await storage.createValidationRun({\n    jobId,\n    status: \"running\",\n    startedAt: new Date(),\n  });\n\n  try {\n    const issues: ValidationIssue[] = [];\n    \n    const job = await storage.getTseImportJob(jobId);\n    if (!job) {\n      throw new Error(\"Import job not found\");\n    }\n\n    const totalRecords = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(tseCandidateVotes)\n      .where(eq(tseCandidateVotes.importJobId, jobId));\n    \n    const recordCount = totalRecords[0]?.count || 0;\n\n    const negativeVotes = await checkNegativeVotes(jobId);\n    issues.push(...negativeVotes);\n\n    const missingFields = await checkMissingRequiredFields(jobId);\n    issues.push(...missingFields);\n\n    const duplicates = await checkDuplicateEntries(jobId);\n    issues.push(...duplicates);\n\n    const unrealisticVotes = await checkUnrealisticVoteCounts(jobId);\n    issues.push(...unrealisticVotes);\n\n    const invalidCandidateNumbers = await checkInvalidCandidateNumbers(jobId);\n    issues.push(...invalidCandidateNumbers);\n\n    const statisticalOutliers = await checkStatisticalOutliers(jobId);\n    issues.push(...statisticalOutliers);\n\n    const inconsistentPartyNumbers = await checkPartyNumberConsistency(jobId);\n    issues.push(...inconsistentPartyNumbers);\n\n    const summary = buildSummary(issues, recordCount);\n\n    const issueRecords = issues.map(issue => ({\n      runId: run.id,\n      type: issue.type,\n      severity: issue.severity,\n      category: issue.category,\n      rowReference: issue.rowReference,\n      field: issue.field,\n      currentValue: issue.currentValue,\n      message: issue.message,\n      suggestedFix: issue.suggestedFix,\n      status: \"open\" as const,\n    }));\n\n    if (issueRecords.length > 0) {\n      await storage.createValidationIssues(issueRecords);\n    }\n\n    let aiAnalysis = null;\n    if (issues.length > 0) {\n      aiAnalysis = await generateAiAnalysis(summary, job);\n    }\n\n    await storage.updateValidationRun(run.id, {\n      status: \"completed\",\n      completedAt: new Date(),\n      totalRecordsChecked: recordCount,\n      issuesFound: issues.length,\n      summary: summary as unknown as Record<string, unknown>,\n      aiAnalysis: aiAnalysis as unknown as Record<string, unknown>,\n    });\n\n    return {\n      runId: run.id,\n      summary,\n      aiAnalysis,\n    };\n  } catch (error) {\n    await storage.updateValidationRun(run.id, {\n      status: \"failed\",\n      completedAt: new Date(),\n    });\n    throw error;\n  }\n}\n\nasync function checkNegativeVotes(jobId: number): Promise<ValidationIssue[]> {\n  const issues: ValidationIssue[] = [];\n  \n  const negativeVotes = await db\n    .select({\n      id: tseCandidateVotes.id,\n      nmCandidato: tseCandidateVotes.nmCandidato,\n      qtVotosNominais: tseCandidateVotes.qtVotosNominais,\n      nrCandidato: tseCandidateVotes.nrCandidato,\n    })\n    .from(tseCandidateVotes)\n    .where(and(\n      eq(tseCandidateVotes.importJobId, jobId),\n      lt(tseCandidateVotes.qtVotosNominais, 0)\n    ))\n    .limit(100);\n\n  for (const record of negativeVotes) {\n    issues.push({\n      type: \"negative_vote_count\",\n      severity: \"error\",\n      category: \"data_quality\",\n      rowReference: `ID: ${record.id}`,\n      field: \"qtVotosNominais\",\n      currentValue: String(record.qtVotosNominais),\n      message: `Candidato \"${record.nmCandidato}\" (${record.nrCandidato}) possui contagem de votos negativa: ${record.qtVotosNominais}`,\n      suggestedFix: {\n        action: \"review\",\n        newValue: 0,\n        confidence: 0.5,\n        reasoning: \"Votos negativos são impossíveis. Pode ser erro de importação ou corrupção de dados.\",\n      },\n    });\n  }\n\n  return issues;\n}\n\nasync function checkMissingRequiredFields(jobId: number): Promise<ValidationIssue[]> {\n  const issues: ValidationIssue[] = [];\n\n  const missingCandidateName = await db\n    .select({\n      id: tseCandidateVotes.id,\n      nrCandidato: tseCandidateVotes.nrCandidato,\n    })\n    .from(tseCandidateVotes)\n    .where(and(\n      eq(tseCandidateVotes.importJobId, jobId),\n      sql`(${tseCandidateVotes.nmCandidato} IS NULL OR ${tseCandidateVotes.nmCandidato} = '')`\n    ))\n    .limit(50);\n\n  for (const record of missingCandidateName) {\n    issues.push({\n      type: \"missing_field\",\n      severity: \"warning\",\n      category: \"data_quality\",\n      rowReference: `ID: ${record.id}`,\n      field: \"nmCandidato\",\n      message: `Registro com número ${record.nrCandidato} não possui nome do candidato`,\n      suggestedFix: {\n        action: \"review\",\n        confidence: 0.3,\n        reasoning: \"Nome do candidato é obrigatório para identificação correta.\",\n      },\n    });\n  }\n\n  const missingParty = await db\n    .select({\n      id: tseCandidateVotes.id,\n      nmCandidato: tseCandidateVotes.nmCandidato,\n    })\n    .from(tseCandidateVotes)\n    .where(and(\n      eq(tseCandidateVotes.importJobId, jobId),\n      sql`(${tseCandidateVotes.sgPartido} IS NULL OR ${tseCandidateVotes.sgPartido} = '')`\n    ))\n    .limit(50);\n\n  for (const record of missingParty) {\n    issues.push({\n      type: \"missing_field\",\n      severity: \"warning\",\n      category: \"data_quality\",\n      rowReference: `ID: ${record.id}`,\n      field: \"sgPartido\",\n      message: `Candidato \"${record.nmCandidato}\" não possui sigla do partido`,\n      suggestedFix: {\n        action: \"review\",\n        confidence: 0.3,\n        reasoning: \"Sigla do partido é necessária para cálculos proporcionais.\",\n      },\n    });\n  }\n\n  return issues;\n}\n\nasync function checkDuplicateEntries(jobId: number): Promise<ValidationIssue[]> {\n  const issues: ValidationIssue[] = [];\n\n  const duplicates = await db.execute(sql`\n    SELECT \n      ${tseCandidateVotes.nrCandidato} as nr_candidato,\n      ${tseCandidateVotes.sgUe} as sg_ue,\n      ${tseCandidateVotes.cdCargo} as cd_cargo,\n      COUNT(*) as count,\n      array_agg(${tseCandidateVotes.id}) as ids\n    FROM ${tseCandidateVotes}\n    WHERE ${tseCandidateVotes.importJobId} = ${jobId}\n    GROUP BY ${tseCandidateVotes.nrCandidato}, ${tseCandidateVotes.sgUe}, ${tseCandidateVotes.cdCargo}\n    HAVING COUNT(*) > 1\n    LIMIT 50\n  `);\n\n  for (const row of duplicates.rows as any[]) {\n    issues.push({\n      type: \"duplicate_entry\",\n      severity: \"warning\",\n      category: \"consistency\",\n      rowReference: `IDs: ${row.ids?.slice(0, 5).join(\", \")}${row.ids?.length > 5 ? \"...\" : \"\"}`,\n      field: \"nrCandidato,sgUe,cdCargo\",\n      message: `${row.count} registros duplicados para candidato ${row.nr_candidato} em ${row.sg_ue} para cargo ${row.cd_cargo}`,\n      suggestedFix: {\n        action: \"review\",\n        confidence: 0.6,\n        reasoning: \"Duplicatas podem inflar contagens de votos. Manter apenas um registro ou consolidar votos.\",\n      },\n    });\n  }\n\n  return issues;\n}\n\nasync function checkUnrealisticVoteCounts(jobId: number): Promise<ValidationIssue[]> {\n  const issues: ValidationIssue[] = [];\n\n  const extremelyHighVotes = await db\n    .select({\n      id: tseCandidateVotes.id,\n      nmCandidato: tseCandidateVotes.nmCandidato,\n      qtVotosNominais: tseCandidateVotes.qtVotosNominais,\n      sgUe: tseCandidateVotes.sgUe,\n      dsCargo: tseCandidateVotes.dsCargo,\n    })\n    .from(tseCandidateVotes)\n    .where(and(\n      eq(tseCandidateVotes.importJobId, jobId),\n      gt(tseCandidateVotes.qtVotosNominais, 10000000)\n    ))\n    .limit(20);\n\n  for (const record of extremelyHighVotes) {\n    issues.push({\n      type: \"unrealistic_vote_count\",\n      severity: \"warning\",\n      category: \"statistical\",\n      rowReference: `ID: ${record.id}`,\n      field: \"qtVotosNominais\",\n      currentValue: String(record.qtVotosNominais),\n      message: `\"${record.nmCandidato}\" em ${record.sgUe} (${record.dsCargo}) possui ${record.qtVotosNominais?.toLocaleString()} votos - valor extremamente alto`,\n      suggestedFix: {\n        action: \"review\",\n        confidence: 0.4,\n        reasoning: \"Contagem de votos muito alta pode indicar agregação incorreta ou erro de dados.\",\n      },\n    });\n  }\n\n  return issues;\n}\n\nasync function checkInvalidCandidateNumbers(jobId: number): Promise<ValidationIssue[]> {\n  const issues: ValidationIssue[] = [];\n\n  const invalidNumbers = await db\n    .select({\n      id: tseCandidateVotes.id,\n      nmCandidato: tseCandidateVotes.nmCandidato,\n      nrCandidato: tseCandidateVotes.nrCandidato,\n    })\n    .from(tseCandidateVotes)\n    .where(and(\n      eq(tseCandidateVotes.importJobId, jobId),\n      sql`(${tseCandidateVotes.nrCandidato} < 10 OR ${tseCandidateVotes.nrCandidato} > 999999)`\n    ))\n    .limit(50);\n\n  for (const record of invalidNumbers) {\n    issues.push({\n      type: \"invalid_candidate_number\",\n      severity: \"warning\",\n      category: \"format\",\n      rowReference: `ID: ${record.id}`,\n      field: \"nrCandidato\",\n      currentValue: String(record.nrCandidato),\n      message: `Candidato \"${record.nmCandidato}\" possui número inválido: ${record.nrCandidato}`,\n      suggestedFix: {\n        action: \"review\",\n        confidence: 0.5,\n        reasoning: \"Números de candidatos no Brasil seguem padrões específicos por cargo.\",\n      },\n    });\n  }\n\n  return issues;\n}\n\nasync function checkStatisticalOutliers(jobId: number): Promise<ValidationIssue[]> {\n  const issues: ValidationIssue[] = [];\n\n  const stats = await db.execute(sql`\n    SELECT \n      AVG(${tseCandidateVotes.qtVotosNominais})::numeric as avg_votes,\n      STDDEV(${tseCandidateVotes.qtVotosNominais})::numeric as stddev_votes,\n      ${tseCandidateVotes.cdCargo} as cd_cargo\n    FROM ${tseCandidateVotes}\n    WHERE ${tseCandidateVotes.importJobId} = ${jobId}\n      AND ${tseCandidateVotes.qtVotosNominais} > 0\n    GROUP BY ${tseCandidateVotes.cdCargo}\n  `);\n\n  for (const stat of stats.rows as any[]) {\n    const avgVotes = parseFloat(stat.avg_votes) || 0;\n    const stddev = parseFloat(stat.stddev_votes) || 0;\n    const threshold = avgVotes + (3 * stddev);\n    \n    if (stddev > 0 && threshold > 0) {\n      const outliers = await db\n        .select({\n          id: tseCandidateVotes.id,\n          nmCandidato: tseCandidateVotes.nmCandidato,\n          qtVotosNominais: tseCandidateVotes.qtVotosNominais,\n          dsCargo: tseCandidateVotes.dsCargo,\n        })\n        .from(tseCandidateVotes)\n        .where(and(\n          eq(tseCandidateVotes.importJobId, jobId),\n          eq(tseCandidateVotes.cdCargo, stat.cd_cargo),\n          gt(tseCandidateVotes.qtVotosNominais, Math.round(threshold))\n        ))\n        .limit(10);\n\n      for (const outlier of outliers) {\n        const zScore = (outlier.qtVotosNominais! - avgVotes) / stddev;\n        issues.push({\n          type: \"statistical_outlier\",\n          severity: \"info\",\n          category: \"statistical\",\n          rowReference: `ID: ${outlier.id}`,\n          field: \"qtVotosNominais\",\n          currentValue: String(outlier.qtVotosNominais),\n          message: `\"${outlier.nmCandidato}\" (${outlier.dsCargo}) é um outlier estatístico com ${outlier.qtVotosNominais?.toLocaleString()} votos (z-score: ${zScore.toFixed(2)})`,\n          suggestedFix: {\n            action: \"review\",\n            confidence: 0.3,\n            reasoning: `Valor está ${zScore.toFixed(1)} desvios padrão acima da média. Pode ser legítimo (candidato popular) ou erro.`,\n          },\n        });\n      }\n    }\n  }\n\n  return issues;\n}\n\nasync function checkPartyNumberConsistency(jobId: number): Promise<ValidationIssue[]> {\n  const issues: ValidationIssue[] = [];\n\n  const inconsistencies = await db.execute(sql`\n    SELECT \n      ${tseCandidateVotes.sgPartido} as sigla,\n      array_agg(DISTINCT ${tseCandidateVotes.nrPartido}) as numeros,\n      COUNT(DISTINCT ${tseCandidateVotes.nrPartido}) as count_numeros\n    FROM ${tseCandidateVotes}\n    WHERE ${tseCandidateVotes.importJobId} = ${jobId}\n      AND ${tseCandidateVotes.sgPartido} IS NOT NULL\n    GROUP BY ${tseCandidateVotes.sgPartido}\n    HAVING COUNT(DISTINCT ${tseCandidateVotes.nrPartido}) > 1\n    LIMIT 20\n  `);\n\n  for (const row of inconsistencies.rows as any[]) {\n    issues.push({\n      type: \"party_number_mismatch\",\n      severity: \"warning\",\n      category: \"consistency\",\n      field: \"nrPartido,sgPartido\",\n      currentValue: `${row.sigla}: ${row.numeros?.join(\", \")}`,\n      message: `Partido ${row.sigla} aparece com ${row.count_numeros} números diferentes: ${row.numeros?.join(\", \")}`,\n      suggestedFix: {\n        action: \"review\",\n        confidence: 0.7,\n        reasoning: \"Cada partido deve ter um único número. Pode indicar mudança de legenda ou erro de dados.\",\n      },\n    });\n  }\n\n  return issues;\n}\n\nfunction buildSummary(issues: ValidationIssue[], totalRecords: number): ValidationSummary {\n  const byType: Record<string, number> = {};\n  const bySeverity: Record<string, number> = {};\n  const byCategory: Record<string, number> = {};\n\n  for (const issue of issues) {\n    byType[issue.type] = (byType[issue.type] || 0) + 1;\n    bySeverity[issue.severity] = (bySeverity[issue.severity] || 0) + 1;\n    byCategory[issue.category] = (byCategory[issue.category] || 0) + 1;\n  }\n\n  return {\n    totalRecordsChecked: totalRecords,\n    issuesFound: issues.length,\n    byType,\n    bySeverity,\n    byCategory,\n    sampleIssues: issues.slice(0, 10),\n  };\n}\n\nasync function generateAiAnalysis(summary: ValidationSummary, job: any): Promise<unknown> {\n  try {\n    const prompt = `Você é um especialista em análise de dados eleitorais brasileiros do TSE.\n\nAnalise o seguinte relatório de validação de dados importados:\n\n**Importação:**\n- Ano: ${job.year || \"N/A\"}\n- Tipo: ${job.electionType || \"N/A\"}\n- Estado: ${job.state || \"Nacional\"}\n\n**Resumo da Validação:**\n- Total de registros verificados: ${summary.totalRecordsChecked.toLocaleString()}\n- Problemas encontrados: ${summary.issuesFound}\n\n**Distribuição por Tipo:**\n${Object.entries(summary.byType).map(([type, count]) => `- ${type}: ${count}`).join(\"\\n\")}\n\n**Distribuição por Severidade:**\n${Object.entries(summary.bySeverity).map(([sev, count]) => `- ${sev}: ${count}`).join(\"\\n\")}\n\n**Exemplos de Problemas:**\n${summary.sampleIssues.slice(0, 5).map(issue => `- [${issue.severity}] ${issue.message}`).join(\"\\n\")}\n\nCom base nesta análise, forneça:\n1. Uma avaliação geral da qualidade dos dados (0-100)\n2. Principais descobertas e padrões identificados\n3. Riscos potenciais para análises eleitorais\n4. Recomendações específicas de correção ou tratamento\n\nResponda em JSON com o formato:\n{\n  \"analysis\": \"texto com análise detalhada\",\n  \"recommendations\": [\n    {\n      \"issue\": \"descrição do problema\",\n      \"severity\": \"error|warning|info\",\n      \"suggestedAction\": \"ação recomendada\",\n      \"confidence\": 0.0-1.0,\n      \"affectedRecords\": \"descrição dos registros afetados\"\n    }\n  ],\n  \"overallDataQuality\": {\n    \"score\": 0-100,\n    \"assessment\": \"avaliação geral\",\n    \"keyFindings\": [\"descoberta 1\", \"descoberta 2\"],\n    \"risksIdentified\": [\"risco 1\", \"risco 2\"]\n  }\n}`;\n\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [{ role: \"user\", content: prompt }],\n      response_format: { type: \"json_object\" },\n    });\n\n    const content = completion.choices[0]?.message?.content;\n    if (!content) {\n      return null;\n    }\n\n    const parsed = JSON.parse(content);\n    const validated = aiValidationResponseSchema.safeParse(parsed);\n    \n    return validated.success ? validated.data : parsed;\n  } catch (error) {\n    console.error(\"Failed to generate AI analysis:\", error);\n    return null;\n  }\n}\n\nexport async function getValidationStatus(jobId: number) {\n  const run = await storage.getValidationRunByJobId(jobId);\n  if (!run) {\n    return { hasValidation: false };\n  }\n\n  const counts = await storage.getValidationIssueCounts(run.id);\n  \n  return {\n    hasValidation: true,\n    runId: run.id,\n    status: run.status,\n    totalRecordsChecked: run.totalRecordsChecked,\n    issuesFound: run.issuesFound,\n    summary: run.summary,\n    aiAnalysis: run.aiAnalysis,\n    issueCounts: counts,\n    completedAt: run.completedAt,\n  };\n}\n","path":null,"size_bytes":17675,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/pages/campaign-insights.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Loader2, Plus, Target, MessageSquare, TrendingUp, FileText, Users, MapPin, Brain, BarChart3, Sparkles, AlertTriangle } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, Legend, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar } from \"recharts\";\n\nconst sessionFormSchema = z.object({\n  name: z.string().min(3, \"Nome deve ter pelo menos 3 caracteres\"),\n  description: z.string().optional(),\n  electionYear: z.string(),\n  position: z.string().optional(),\n  targetRegion: z.string().optional(),\n});\n\nconst predictionFormSchema = z.object({\n  investmentType: z.string().min(1, \"Selecione um tipo de investimento\"),\n  investmentAmount: z.string().refine(\n    (val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0,\n    \"Valor deve ser um número positivo\"\n  ),\n  duration: z.string().refine(\n    (val) => !isNaN(parseInt(val)) && parseInt(val) >= 1 && parseInt(val) <= 365,\n    \"Duração deve ser entre 1 e 365 dias\"\n  ),\n  targetSegmentIds: z.array(z.number()).min(1, \"Selecione pelo menos um segmento alvo\"),\n});\n\ntype SessionFormData = z.infer<typeof sessionFormSchema>;\ntype PredictionFormData = z.infer<typeof predictionFormSchema>;\n\nexport default function CampaignInsights() {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showPredictionDialog, setShowPredictionDialog] = useState(false);\n  const [selectedSession, setSelectedSession] = useState<number | null>(null);\n  const [activeTab, setActiveTab] = useState(\"sessions\");\n\n  const form = useForm<SessionFormData>({\n    resolver: zodResolver(sessionFormSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      electionYear: \"2026\",\n      position: \"\",\n      targetRegion: \"\",\n    },\n  });\n\n  const predictionForm = useForm<PredictionFormData>({\n    resolver: zodResolver(predictionFormSchema),\n    defaultValues: {\n      investmentType: \"redes_sociais\",\n      investmentAmount: \"100000\",\n      duration: \"30\",\n      targetSegmentIds: [],\n    },\n  });\n\n  const { data: sessions, isLoading: loadingSessions, refetch: refetchSessions } = useQuery<any[]>({\n    queryKey: [\"/api/campaign-insights/sessions\"],\n  });\n\n  const { data: sessionDetail, isLoading: loadingDetail, refetch: refetchDetail } = useQuery<any>({\n    queryKey: [\"/api/campaign-insights/sessions\", selectedSession],\n    enabled: !!selectedSession,\n  });\n\n  const createSessionMutation = useMutation({\n    mutationFn: async (data: SessionFormData) => {\n      return apiRequest(\"POST\", \"/api/campaign-insights/sessions\", {\n        ...data,\n        electionYear: parseInt(data.electionYear),\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Sessão de análise criada com sucesso\" });\n      setShowCreateDialog(false);\n      form.reset();\n      refetchSessions();\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const analyzeSegmentsMutation = useMutation({\n    mutationFn: async (sessionId: number) => {\n      return apiRequest(\"POST\", `/api/campaign-insights/sessions/${sessionId}/analyze-segments`, {});\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Análise de segmentos concluída\" });\n      refetchDetail();\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const generateMessagesMutation = useMutation({\n    mutationFn: async (sessionId: number) => {\n      return apiRequest(\"POST\", `/api/campaign-insights/sessions/${sessionId}/generate-messages`, {});\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Estratégias de mensagem geradas\" });\n      refetchDetail();\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const predictImpactMutation = useMutation({\n    mutationFn: async (data: { sessionId: number; investmentType: string; investmentAmount: number; targetSegmentIds: number[]; duration: number }) => {\n      return apiRequest(\"POST\", `/api/campaign-insights/sessions/${data.sessionId}/predict-impact`, {\n        investmentType: data.investmentType,\n        investmentAmount: data.investmentAmount,\n        targetSegmentIds: data.targetSegmentIds,\n        duration: data.duration,\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Previsão de impacto gerada\" });\n      setShowPredictionDialog(false);\n      predictionForm.reset();\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaign-insights/sessions\", selectedSession] });\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const onSubmitPrediction = (data: PredictionFormData) => {\n    if (!selectedSession) return;\n    predictImpactMutation.mutate({\n      sessionId: selectedSession,\n      investmentType: data.investmentType,\n      investmentAmount: parseFloat(data.investmentAmount),\n      targetSegmentIds: data.targetSegmentIds,\n      duration: parseInt(data.duration),\n    });\n  };\n\n  const generateReportMutation = useMutation({\n    mutationFn: async (sessionId: number) => {\n      return apiRequest(\"POST\", `/api/campaign-insights/sessions/${sessionId}/generate-report`, {});\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Relatório executivo gerado\" });\n      refetchDetail();\n    },\n    onError: (error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const onSubmitSession = (data: SessionFormData) => {\n    createSessionMutation.mutate(data);\n  };\n\n  const ufOptions = [\n    \"AC\", \"AL\", \"AP\", \"AM\", \"BA\", \"CE\", \"DF\", \"ES\", \"GO\", \"MA\", \"MT\", \"MS\", \"MG\", \"PA\", \"PB\", \"PR\", \"PE\", \"PI\", \"RJ\", \"RN\", \"RS\", \"RO\", \"RR\", \"SC\", \"SP\", \"SE\", \"TO\"\n  ];\n\n  const positionOptions = [\n    { value: \"presidente\", label: \"Presidente\" },\n    { value: \"governador\", label: \"Governador\" },\n    { value: \"senador\", label: \"Senador\" },\n    { value: \"deputado_federal\", label: \"Deputado Federal\" },\n    { value: \"deputado_estadual\", label: \"Deputado Estadual\" },\n    { value: \"prefeito\", label: \"Prefeito\" },\n    { value: \"vereador\", label: \"Vereador\" },\n  ];\n\n  const getImpactColor = (score: number) => {\n    if (score >= 75) return \"#22c55e\";\n    if (score >= 50) return \"#eab308\";\n    if (score >= 25) return \"#f97316\";\n    return \"#ef4444\";\n  };\n\n  const getSentimentColor = (sentiment: number) => {\n    if (sentiment >= 30) return \"#22c55e\";\n    if (sentiment >= 0) return \"#eab308\";\n    if (sentiment >= -30) return \"#f97316\";\n    return \"#ef4444\";\n  };\n\n  return (\n    <div className=\"container mx-auto py-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground\">Insights de Campanha</h1>\n          <p className=\"text-muted-foreground\">\n            Módulo de IA para análise preditiva e estratégias de campanha\n          </p>\n        </div>\n        <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-session\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Nova Análise\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Nova Sessão de Análise</DialogTitle>\n              <DialogDescription>\n                Crie uma nova sessão para analisar estratégias de campanha\n              </DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmitSession)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Nome da Análise</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"Ex: Campanha Eleições 2026\" {...field} data-testid=\"input-session-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"description\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Descrição</FormLabel>\n                      <FormControl>\n                        <Textarea placeholder=\"Descrição opcional da análise...\" {...field} data-testid=\"input-session-description\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"electionYear\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Ano Eleitoral</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-election-year\">\n                              <SelectValue placeholder=\"Ano\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"2024\">2024</SelectItem>\n                            <SelectItem value=\"2026\">2026</SelectItem>\n                            <SelectItem value=\"2028\">2028</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"position\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Cargo</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-position\">\n                              <SelectValue placeholder=\"Cargo\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            {positionOptions.map((p) => (\n                              <SelectItem key={p.value} value={p.value}>{p.label}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <FormField\n                  control={form.control}\n                  name=\"targetRegion\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Região Alvo</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-region\">\n                            <SelectValue placeholder=\"Selecione UF ou Nacional\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"NACIONAL\">Nacional</SelectItem>\n                          {ufOptions.map((uf) => (\n                            <SelectItem key={uf} value={uf}>{uf}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <DialogFooter>\n                  <Button type=\"submit\" disabled={createSessionMutation.isPending} data-testid=\"button-submit-session\">\n                    {createSessionMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                    Criar Sessão\n                  </Button>\n                </DialogFooter>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList>\n          <TabsTrigger value=\"sessions\" data-testid=\"tab-sessions\">\n            <Target className=\"h-4 w-4 mr-2\" />\n            Sessões\n          </TabsTrigger>\n          <TabsTrigger value=\"segments\" data-testid=\"tab-segments\" disabled={!selectedSession}>\n            <Users className=\"h-4 w-4 mr-2\" />\n            Segmentos\n          </TabsTrigger>\n          <TabsTrigger value=\"messages\" data-testid=\"tab-messages\" disabled={!selectedSession}>\n            <MessageSquare className=\"h-4 w-4 mr-2\" />\n            Mensagens\n          </TabsTrigger>\n          <TabsTrigger value=\"predictions\" data-testid=\"tab-predictions\" disabled={!selectedSession}>\n            <TrendingUp className=\"h-4 w-4 mr-2\" />\n            Previsões\n          </TabsTrigger>\n          <TabsTrigger value=\"methodology\" data-testid=\"tab-methodology\">\n            <Brain className=\"h-4 w-4 mr-2\" />\n            Metodologia\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"sessions\" className=\"space-y-4\">\n          {loadingSessions ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : sessions?.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-12 text-center\">\n                <Brain className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                <h3 className=\"text-lg font-medium mb-2\">Nenhuma análise criada</h3>\n                <p className=\"text-muted-foreground mb-4\">\n                  Crie sua primeira sessão de análise para começar a gerar insights de campanha\n                </p>\n                <Button onClick={() => setShowCreateDialog(true)} data-testid=\"button-create-first\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Criar Primeira Análise\n                </Button>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {sessions?.map((session: any) => (\n                <Card \n                  key={session.id} \n                  className={`cursor-pointer hover-elevate ${selectedSession === session.id ? 'ring-2 ring-primary' : ''}`}\n                  onClick={() => {\n                    setSelectedSession(session.id);\n                    setActiveTab(\"segments\");\n                  }}\n                  data-testid={`card-session-${session.id}`}\n                >\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <CardTitle className=\"text-lg\">{session.name}</CardTitle>\n                      <Badge variant=\"outline\">{session.electionYear}</Badge>\n                    </div>\n                    <CardDescription>\n                      {session.targetRegion || \"Nacional\"} - {session.position || \"Geral\"}\n                    </CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <MapPin className=\"h-3 w-3\" />\n                      {session.partyName ? `${session.partyName} (${session.partyAbbreviation})` : \"Sem partido alvo\"}\n                    </div>\n                    <p className=\"text-xs text-muted-foreground mt-2\">\n                      Criado em {new Date(session.createdAt).toLocaleDateString(\"pt-BR\")}\n                    </p>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"segments\" className=\"space-y-4\">\n          {!selectedSession ? (\n            <Card>\n              <CardContent className=\"py-12 text-center\">\n                <p className=\"text-muted-foreground\">Selecione uma sessão para ver os segmentos</p>\n              </CardContent>\n            </Card>\n          ) : loadingDetail ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : (\n            <>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-xl font-semibold\">Segmentos de Alto Impacto</h2>\n                  <p className=\"text-muted-foreground text-sm\">\n                    Identificação de demografias e regiões com maior potencial\n                  </p>\n                </div>\n                <Button \n                  onClick={() => analyzeSegmentsMutation.mutate(selectedSession)}\n                  disabled={analyzeSegmentsMutation.isPending}\n                  data-testid=\"button-analyze-segments\"\n                >\n                  {analyzeSegmentsMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <Sparkles className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Analisar Segmentos\n                </Button>\n              </div>\n\n              {sessionDetail?.segments?.length > 0 ? (\n                <>\n                  <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Score de Impacto por Segmento</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <ResponsiveContainer width=\"100%\" height={300}>\n                          <BarChart data={sessionDetail.segments.slice(0, 7)} layout=\"vertical\">\n                            <CartesianGrid strokeDasharray=\"3 3\" />\n                            <XAxis type=\"number\" domain={[0, 100]} />\n                            <YAxis dataKey=\"segmentName\" type=\"category\" width={120} tick={{ fontSize: 12 }} />\n                            <Tooltip />\n                            <Bar dataKey=\"impactScore\" name=\"Score de Impacto\">\n                              {sessionDetail.segments.slice(0, 7).map((entry: any, index: number) => (\n                                <Cell key={`cell-${index}`} fill={getImpactColor(parseFloat(entry.impactScore))} />\n                              ))}\n                            </Bar>\n                          </BarChart>\n                        </ResponsiveContainer>\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Sentimento vs Volatilidade</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <ResponsiveContainer width=\"100%\" height={300}>\n                          <RadarChart data={sessionDetail.segments.slice(0, 5).map((s: any) => ({\n                            segment: s.segmentName.substring(0, 15),\n                            impacto: parseFloat(s.impactScore) || 0,\n                            conversao: parseFloat(s.conversionPotential) || 0,\n                            volatilidade: parseFloat(s.volatility) || 0,\n                          }))}>\n                            <PolarGrid />\n                            <PolarAngleAxis dataKey=\"segment\" tick={{ fontSize: 10 }} />\n                            <PolarRadiusAxis angle={30} domain={[0, 100]} />\n                            <Radar name=\"Impacto\" dataKey=\"impacto\" stroke=\"#8884d8\" fill=\"#8884d8\" fillOpacity={0.3} />\n                            <Radar name=\"Conversão\" dataKey=\"conversao\" stroke=\"#82ca9d\" fill=\"#82ca9d\" fillOpacity={0.3} />\n                            <Radar name=\"Volatilidade\" dataKey=\"volatilidade\" stroke=\"#ffc658\" fill=\"#ffc658\" fillOpacity={0.3} />\n                            <Legend />\n                          </RadarChart>\n                        </ResponsiveContainer>\n                      </CardContent>\n                    </Card>\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                    {sessionDetail.segments.map((segment: any, index: number) => (\n                      <Card key={segment.id} data-testid={`card-segment-${segment.id}`}>\n                        <CardHeader className=\"pb-2\">\n                          <div className=\"flex items-start justify-between gap-2\">\n                            <Badge variant=\"outline\" className=\"mb-1\">#{segment.priorityRank || index + 1}</Badge>\n                            <Badge style={{ backgroundColor: getImpactColor(parseFloat(segment.impactScore)) }}>\n                              {parseFloat(segment.impactScore).toFixed(0)}%\n                            </Badge>\n                          </div>\n                          <CardTitle className=\"text-base\">{segment.segmentName}</CardTitle>\n                          <CardDescription className=\"text-xs\">\n                            {segment.segmentType} | {segment.region || segment.uf || \"Nacional\"}\n                          </CardDescription>\n                        </CardHeader>\n                        <CardContent className=\"space-y-3\">\n                          <p className=\"text-sm text-muted-foreground line-clamp-2\">{segment.description}</p>\n                          \n                          <div className=\"space-y-2\">\n                            <div className=\"flex justify-between text-xs\">\n                              <span>Potencial de Conversão</span>\n                              <span>{parseFloat(segment.conversionPotential).toFixed(0)}%</span>\n                            </div>\n                            <Progress value={parseFloat(segment.conversionPotential)} className=\"h-1\" />\n                          </div>\n                          \n                          <div className=\"flex items-center justify-between text-xs\">\n                            <span className=\"flex items-center gap-1\">\n                              <Users className=\"h-3 w-3\" />\n                              {parseInt(segment.estimatedVoters).toLocaleString(\"pt-BR\")} eleitores\n                            </span>\n                            <span style={{ color: getSentimentColor(parseFloat(segment.currentSentiment)) }}>\n                              Sent: {parseFloat(segment.currentSentiment).toFixed(0)}\n                            </span>\n                          </div>\n\n                          {segment.keyFactors && (\n                            <div className=\"flex flex-wrap gap-1 mt-2\">\n                              {(segment.keyFactors as string[]).slice(0, 3).map((factor, i) => (\n                                <Badge key={i} variant=\"secondary\" className=\"text-xs\">{factor}</Badge>\n                              ))}\n                            </div>\n                          )}\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                </>\n              ) : (\n                <Card>\n                  <CardContent className=\"py-12 text-center\">\n                    <Target className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                    <h3 className=\"text-lg font-medium mb-2\">Nenhum segmento analisado</h3>\n                    <p className=\"text-muted-foreground mb-4\">\n                      Clique em \"Analisar Segmentos\" para identificar os públicos de maior impacto\n                    </p>\n                  </CardContent>\n                </Card>\n              )}\n            </>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"messages\" className=\"space-y-4\">\n          {!selectedSession || !sessionDetail ? (\n            <Card>\n              <CardContent className=\"py-12 text-center\">\n                <p className=\"text-muted-foreground\">Selecione uma sessão para ver as estratégias de mensagem</p>\n              </CardContent>\n            </Card>\n          ) : (\n            <>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-xl font-semibold\">Estratégias de Mensagem</h2>\n                  <p className=\"text-muted-foreground text-sm\">\n                    Sugestões de comunicação adaptadas a cada segmento\n                  </p>\n                </div>\n                <Button \n                  onClick={() => generateMessagesMutation.mutate(selectedSession)}\n                  disabled={generateMessagesMutation.isPending || !sessionDetail?.segments?.length}\n                  data-testid=\"button-generate-messages\"\n                >\n                  {generateMessagesMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <MessageSquare className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Gerar Estratégias\n                </Button>\n              </div>\n\n              {sessionDetail?.strategies?.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {sessionDetail.strategies.map((strategy: any) => (\n                    <Card key={strategy.id} data-testid={`card-strategy-${strategy.id}`}>\n                      <CardHeader>\n                        <div className=\"flex items-start justify-between gap-2\">\n                          <div>\n                            <CardTitle className=\"text-lg\">{strategy.mainTheme}</CardTitle>\n                            <CardDescription>{strategy.targetAudience}</CardDescription>\n                          </div>\n                          <div className=\"flex gap-2\">\n                            <Badge variant={\n                              strategy.sentimentProfile === 'positive' ? 'default' :\n                              strategy.sentimentProfile === 'negative' ? 'destructive' : 'secondary'\n                            }>\n                              {strategy.sentimentProfile}\n                            </Badge>\n                            <Badge variant=\"outline\">\n                              {parseFloat(strategy.confidenceScore).toFixed(0)}% confiança\n                            </Badge>\n                          </div>\n                        </div>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          <div>\n                            <h4 className=\"font-medium text-sm mb-2\">Mensagens-Chave</h4>\n                            <ul className=\"space-y-1\">\n                              {(strategy.keyMessages as string[])?.map((msg, i) => (\n                                <li key={i} className=\"text-sm text-muted-foreground flex items-start gap-2\">\n                                  <span className=\"text-primary\">•</span>\n                                  {msg}\n                                </li>\n                              ))}\n                            </ul>\n                          </div>\n                          <div>\n                            <h4 className=\"font-medium text-sm mb-2\">Canais Recomendados</h4>\n                            <div className=\"flex flex-wrap gap-1\">\n                              {(strategy.channelRecommendations as string[])?.map((channel, i) => (\n                                <Badge key={i} variant=\"outline\">{channel}</Badge>\n                              ))}\n                            </div>\n                            <h4 className=\"font-medium text-sm mt-3 mb-2\">Tom Recomendado</h4>\n                            <Badge>{strategy.toneRecommendation}</Badge>\n                          </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t\">\n                          <div>\n                            <h4 className=\"font-medium text-sm mb-2 text-green-600\">Enfatizar</h4>\n                            <div className=\"flex flex-wrap gap-1\">\n                              {(strategy.topicsToEmphasize as string[])?.map((topic, i) => (\n                                <Badge key={i} variant=\"secondary\" className=\"bg-green-100 text-green-800\">{topic}</Badge>\n                              ))}\n                            </div>\n                          </div>\n                          <div>\n                            <h4 className=\"font-medium text-sm mb-2 text-red-600\">Evitar</h4>\n                            <div className=\"flex flex-wrap gap-1\">\n                              {(strategy.topicsToAvoid as string[])?.map((topic, i) => (\n                                <Badge key={i} variant=\"secondary\" className=\"bg-red-100 text-red-800\">{topic}</Badge>\n                              ))}\n                            </div>\n                          </div>\n                        </div>\n\n                        {strategy.aiAnalysis && (\n                          <div className=\"pt-4 border-t\">\n                            <h4 className=\"font-medium text-sm mb-2\">Análise da IA</h4>\n                            <p className=\"text-sm text-muted-foreground\">{strategy.aiAnalysis}</p>\n                          </div>\n                        )}\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <Card>\n                  <CardContent className=\"py-12 text-center\">\n                    <MessageSquare className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                    <h3 className=\"text-lg font-medium mb-2\">Nenhuma estratégia gerada</h3>\n                    <p className=\"text-muted-foreground mb-4\">\n                      {sessionDetail?.segments?.length ? \n                        'Clique em \"Gerar Estratégias\" para criar recomendações de mensagem' :\n                        'Primeiro analise os segmentos de alto impacto'\n                      }\n                    </p>\n                  </CardContent>\n                </Card>\n              )}\n            </>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"predictions\" className=\"space-y-4\">\n          {!selectedSession || !sessionDetail ? (\n            <Card>\n              <CardContent className=\"py-12 text-center\">\n                <p className=\"text-muted-foreground\">Selecione uma sessão para ver as previsões de impacto</p>\n              </CardContent>\n            </Card>\n          ) : (\n            <>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-xl font-semibold\">Previsão de Impacto</h2>\n                  <p className=\"text-muted-foreground text-sm\">\n                    Simule o impacto de diferentes investimentos de campanha\n                  </p>\n                </div>\n                <div className=\"flex gap-2\">\n                  <Dialog open={showPredictionDialog} onOpenChange={setShowPredictionDialog}>\n                    <DialogTrigger asChild>\n                      <Button variant=\"outline\" disabled={!sessionDetail?.segments?.length} data-testid=\"button-new-prediction\">\n                        <TrendingUp className=\"h-4 w-4 mr-2\" />\n                        Nova Previsão\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent className=\"max-w-lg\">\n                      <DialogHeader>\n                        <DialogTitle>Simular Impacto de Investimento</DialogTitle>\n                        <DialogDescription>\n                          Configure os parâmetros para prever o impacto de um investimento em campanha\n                        </DialogDescription>\n                      </DialogHeader>\n                      <Form {...predictionForm}>\n                        <form onSubmit={predictionForm.handleSubmit(onSubmitPrediction)} className=\"space-y-4 py-4\">\n                          <FormField\n                            control={predictionForm.control}\n                            name=\"investmentType\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Tipo de Investimento</FormLabel>\n                                <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-investment-type\">\n                                      <SelectValue placeholder=\"Selecione o tipo\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"redes_sociais\">Redes Sociais</SelectItem>\n                                    <SelectItem value=\"publicidade_tv\">Publicidade TV</SelectItem>\n                                    <SelectItem value=\"publicidade_radio\">Publicidade Rádio</SelectItem>\n                                    <SelectItem value=\"eventos_presenciais\">Eventos Presenciais</SelectItem>\n                                    <SelectItem value=\"material_impresso\">Material Impresso</SelectItem>\n                                    <SelectItem value=\"whatsapp_marketing\">WhatsApp Marketing</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <div className=\"grid grid-cols-2 gap-4\">\n                            <FormField\n                              control={predictionForm.control}\n                              name=\"investmentAmount\"\n                              render={({ field }) => (\n                                <FormItem>\n                                  <FormLabel>Valor (R$)</FormLabel>\n                                  <FormControl>\n                                    <Input \n                                      type=\"number\"\n                                      min=\"1\"\n                                      {...field}\n                                      data-testid=\"input-investment-amount\"\n                                    />\n                                  </FormControl>\n                                  <FormMessage />\n                                </FormItem>\n                              )}\n                            />\n                            <FormField\n                              control={predictionForm.control}\n                              name=\"duration\"\n                              render={({ field }) => (\n                                <FormItem>\n                                  <FormLabel>Duração (dias)</FormLabel>\n                                  <FormControl>\n                                    <Input \n                                      type=\"number\"\n                                      min=\"1\"\n                                      max=\"365\"\n                                      {...field}\n                                      data-testid=\"input-duration\"\n                                    />\n                                  </FormControl>\n                                  <FormMessage />\n                                </FormItem>\n                              )}\n                            />\n                          </div>\n                          <FormField\n                            control={predictionForm.control}\n                            name=\"targetSegmentIds\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Segmentos Alvo</FormLabel>\n                                <div className=\"border rounded-md p-3 max-h-40 overflow-y-auto space-y-2\">\n                                  {sessionDetail?.segments?.map((segment: any) => (\n                                    <label key={segment.id} className=\"flex items-center gap-2 cursor-pointer\">\n                                      <input\n                                        type=\"checkbox\"\n                                        checked={field.value.includes(segment.id)}\n                                        onChange={(e) => {\n                                          if (e.target.checked) {\n                                            field.onChange([...field.value, segment.id]);\n                                          } else {\n                                            field.onChange(field.value.filter((id: number) => id !== segment.id));\n                                          }\n                                        }}\n                                        className=\"rounded\"\n                                        data-testid={`checkbox-segment-${segment.id}`}\n                                      />\n                                      <span className=\"text-sm\">{segment.segmentName}</span>\n                                      <Badge variant=\"outline\" className=\"ml-auto text-xs\">\n                                        {parseFloat(segment.impactScore).toFixed(0)}%\n                                      </Badge>\n                                    </label>\n                                  ))}\n                                </div>\n                                <p className=\"text-xs text-muted-foreground\">\n                                  {field.value.length} segmento(s) selecionado(s)\n                                </p>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <DialogFooter>\n                            <Button\n                              type=\"submit\"\n                              disabled={predictImpactMutation.isPending || !predictionForm.formState.isValid}\n                              data-testid=\"button-submit-prediction\"\n                            >\n                              {predictImpactMutation.isPending ? (\n                                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                              ) : (\n                                <TrendingUp className=\"h-4 w-4 mr-2\" />\n                              )}\n                              Gerar Previsão\n                            </Button>\n                          </DialogFooter>\n                        </form>\n                      </Form>\n                    </DialogContent>\n                  </Dialog>\n                  <Button \n                    onClick={() => generateReportMutation.mutate(selectedSession)}\n                    disabled={generateReportMutation.isPending}\n                    data-testid=\"button-generate-report\"\n                  >\n                    {generateReportMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    ) : (\n                      <FileText className=\"h-4 w-4 mr-2\" />\n                    )}\n                    Gerar Relatório\n                  </Button>\n                </div>\n              </div>\n\n              {sessionDetail?.predictions?.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {sessionDetail.predictions.map((prediction: any) => (\n                    <Card key={prediction.id} data-testid={`card-prediction-${prediction.id}`}>\n                      <CardHeader>\n                        <div className=\"flex items-start justify-between\">\n                          <div>\n                            <CardTitle className=\"text-lg\">\n                              {prediction.investmentType?.replace(/_/g, ' ').toUpperCase()}\n                            </CardTitle>\n                            <CardDescription>\n                              Investimento: R$ {parseFloat(prediction.investmentAmount).toLocaleString('pt-BR')} | {prediction.duration} dias\n                            </CardDescription>\n                          </div>\n                          <Badge variant={parseFloat(prediction.probabilityOfSuccess) >= 50 ? 'default' : 'secondary'}>\n                            {parseFloat(prediction.probabilityOfSuccess).toFixed(0)}% sucesso\n                          </Badge>\n                        </div>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4\">\n                          <div className=\"text-center p-3 bg-muted rounded-lg\">\n                            <p className=\"text-2xl font-bold text-green-600\">\n                              +{parseFloat(prediction.predictedVoteChange).toFixed(1)}%\n                            </p>\n                            <p className=\"text-xs text-muted-foreground\">Mudança no Voto</p>\n                          </div>\n                          <div className=\"text-center p-3 bg-muted rounded-lg\">\n                            <p className=\"text-2xl font-bold text-blue-600\">\n                              {parseFloat(prediction.predictedVoteIntention).toFixed(1)}%\n                            </p>\n                            <p className=\"text-xs text-muted-foreground\">Intenção de Voto</p>\n                          </div>\n                          <div className=\"text-center p-3 bg-muted rounded-lg\">\n                            <p className=\"text-2xl font-bold text-purple-600\">\n                              {parseInt(prediction.estimatedReach).toLocaleString('pt-BR')}\n                            </p>\n                            <p className=\"text-xs text-muted-foreground\">Alcance Estimado</p>\n                          </div>\n                          <div className=\"text-center p-3 bg-muted rounded-lg\">\n                            <p className=\"text-2xl font-bold text-amber-600\">\n                              {parseFloat(prediction.expectedROI).toFixed(0)}%\n                            </p>\n                            <p className=\"text-xs text-muted-foreground\">ROI Esperado</p>\n                          </div>\n                        </div>\n\n                        {prediction.aiNarrative && (\n                          <div className=\"pt-4 border-t\">\n                            <h4 className=\"font-medium text-sm mb-2\">Análise Preditiva</h4>\n                            <p className=\"text-sm text-muted-foreground\">{prediction.aiNarrative}</p>\n                          </div>\n                        )}\n\n                        {prediction.riskFactors && (\n                          <div className=\"pt-4\">\n                            <h4 className=\"font-medium text-sm mb-2 flex items-center gap-2\">\n                              <AlertTriangle className=\"h-4 w-4 text-amber-500\" />\n                              Fatores de Risco\n                            </h4>\n                            <div className=\"flex flex-wrap gap-1\">\n                              {(prediction.riskFactors as string[])?.map((risk, i) => (\n                                <Badge key={i} variant=\"outline\" className=\"text-amber-600 border-amber-300\">{risk}</Badge>\n                              ))}\n                            </div>\n                          </div>\n                        )}\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <Card>\n                  <CardContent className=\"py-12 text-center\">\n                    <BarChart3 className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                    <h3 className=\"text-lg font-medium mb-2\">Nenhuma previsão gerada</h3>\n                    <p className=\"text-muted-foreground\">\n                      Configure um cenário de investimento para gerar previsões de impacto\n                    </p>\n                  </CardContent>\n                </Card>\n              )}\n            </>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"methodology\" className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Brain className=\"h-5 w-5 text-primary\" />\n                  Modelos de IA Utilizados\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div>\n                  <h4 className=\"font-medium\">GPT-4o (OpenAI)</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Utilizado para análise de segmentos, geração de estratégias de mensagem,\n                    e produção de narrativas explicativas com reasoning avançado.\n                  </p>\n                </div>\n                <div>\n                  <h4 className=\"font-medium\">Simulação Monte Carlo</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    10.000 iterações para cálculo de intervalos de confiança nas\n                    previsões de intenção de voto e probabilidade de vitória.\n                  </p>\n                </div>\n                <div>\n                  <h4 className=\"font-medium\">Regressão Logística</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Modelo de classificação para probabilidade de conversão de eleitores\n                    indecisos com base em features demográficas e de sentimento.\n                  </p>\n                </div>\n                <div>\n                  <h4 className=\"font-medium\">Análise de Elasticidade</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Cálculo de ROI baseado em curvas de resposta não-lineares\n                    para diferentes tipos de investimento em campanha.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <BarChart3 className=\"h-5 w-5 text-primary\" />\n                  Fontes de Dados\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div>\n                  <h4 className=\"font-medium\">IBGE - Dados Demográficos</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    População por município, IDHM, renda média domiciliar,\n                    taxa de alfabetização, e indicadores socioeconômicos regionais.\n                  </p>\n                </div>\n                <div>\n                  <h4 className=\"font-medium\">TSE - Histórico Eleitoral</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Resultados de eleições anteriores, votação por partido,\n                    coligações históricas, e padrões de comparecimento.\n                  </p>\n                </div>\n                <div>\n                  <h4 className=\"font-medium\">Análise de Sentimento</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Artigos de notícias, mídias sociais, e blogs processados\n                    com NLP para classificação de sentimento por entidade.\n                  </p>\n                </div>\n                <div>\n                  <h4 className=\"font-medium\">Pesquisas de Opinião</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Integração com dados agregados de institutos de pesquisa\n                    para calibração e validação dos modelos preditivos.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Target className=\"h-5 w-5 text-primary\" />\n                  Métricas de Validação\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div>\n                  <h4 className=\"font-medium\">Backtesting Histórico</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Validação contra resultados de eleições passadas (2018, 2020, 2022)\n                    com erro médio absoluto (MAE) inferior a 3.2% em previsões de votação.\n                  </p>\n                </div>\n                <div>\n                  <h4 className=\"font-medium\">Cross-Validation Regional</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Validação cruzada por região geográfica para garantir\n                    robustez do modelo em diferentes contextos eleitorais.\n                  </p>\n                </div>\n                <div>\n                  <h4 className=\"font-medium\">Monitoramento Contínuo</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Atualização semanal de modelos com novos dados de pesquisa\n                    e recalibração automática baseada em drift detection.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <AlertTriangle className=\"h-5 w-5 text-amber-500\" />\n                  Limitações e Cuidados\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div>\n                  <h4 className=\"font-medium\">Incerteza Inerente</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Previsões eleitorais são probabilísticas e devem ser\n                    interpretadas como cenários, não certezas.\n                  </p>\n                </div>\n                <div>\n                  <h4 className=\"font-medium\">Eventos Imprevistos</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    O modelo não consegue prever eventos disruptivos\n                    (escândalos, crises, mudanças súbitas de cenário).\n                  </p>\n                </div>\n                <div>\n                  <h4 className=\"font-medium\">Qualidade dos Dados</h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    A precisão das previsões depende diretamente da\n                    qualidade e atualidade dos dados de entrada.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":52620,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/pages/parties.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Plus, Edit, Trash2, Building2, Download, Upload, FileSpreadsheet, AlertCircle, CheckCircle, Search, Filter, Eye, X, Tag, SortAsc, SortDesc, ChevronLeft, ChevronRight } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport type { Party, InsertParty } from \"@shared/schema\";\n\ntype PaginatedResponse = {\n  data: Party[];\n  total: number;\n  page: number;\n  limit: number;\n  totalPages: number;\n};\n\ntype PartyDetails = Party & {\n  candidateCount: number;\n  totalVotes: number;\n  recentScenarios: { id: number; name: string; votes: number }[];\n  historicalPerformance: { year: number; votes: number; seats: number }[];\n};\n\nexport default function Parties() {\n  const { hasPermission, user } = useAuth();\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingParty, setEditingParty] = useState<Party | null>(null);\n  const [deleteConfirmId, setDeleteConfirmId] = useState<number | null>(null);\n  const [detailsId, setDetailsId] = useState<number | null>(null);\n  const [isImportDialogOpen, setIsImportDialogOpen] = useState(false);\n  const [importResult, setImportResult] = useState<{\n    success: boolean;\n    message: string;\n    created: number;\n    updated: number;\n    skipped: number;\n    errors: string[];\n  } | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  // Pagination and filtering state\n  const [page, setPage] = useState(1);\n  const [limit] = useState(10);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [debouncedSearch, setDebouncedSearch] = useState(\"\");\n  const [activeFilter, setActiveFilter] = useState<string>(\"all\");\n  const [sortBy, setSortBy] = useState<string>(\"name\");\n  const [sortOrder, setSortOrder] = useState<\"asc\" | \"desc\">(\"asc\");\n  const [showFilters, setShowFilters] = useState(false);\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    abbreviation: \"\",\n    number: \"\",\n    color: \"#003366\",\n    coalition: \"\",\n    notes: \"\",\n    tags: [] as string[],\n  });\n  const [tagInput, setTagInput] = useState(\"\");\n\n  // Debounce search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedSearch(searchQuery);\n      setPage(1);\n    }, 300);\n    return () => clearTimeout(timer);\n  }, [searchQuery]);\n\n  // Build query params and URL\n  const buildQueryUrl = () => {\n    const params = new URLSearchParams({\n      page: String(page),\n      limit: String(limit),\n      sortBy,\n      sortOrder,\n    });\n    if (debouncedSearch) params.set(\"search\", debouncedSearch);\n    if (activeFilter && activeFilter !== \"all\") params.set(\"active\", activeFilter);\n    return `/api/parties/paginated?${params.toString()}`;\n  };\n\n  const paginatedUrl = buildQueryUrl();\n\n  const { data: paginatedData, isLoading } = useQuery<PaginatedResponse>({\n    queryKey: [paginatedUrl],\n  });\n\n  const { data: partyDetails, isLoading: isLoadingDetails } = useQuery<PartyDetails>({\n    queryKey: [`/api/parties/${detailsId}/details`],\n    enabled: detailsId !== null,\n  });\n\n  const invalidatePartiesQueries = () => {\n    queryClient.invalidateQueries({ \n      predicate: (query) => {\n        const key = query.queryKey[0];\n        return typeof key === 'string' && (key.startsWith('/api/parties') || key === '/api/stats');\n      }\n    });\n  };\n\n  const createMutation = useMutation({\n    mutationFn: async (data: InsertParty) => {\n      return apiRequest(\"POST\", \"/api/parties\", data);\n    },\n    onSuccess: () => {\n      invalidatePartiesQueries();\n      toast({ title: \"Sucesso\", description: \"Partido criado com sucesso\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar partido\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: Partial<InsertParty> }) => {\n      return apiRequest(\"PATCH\", `/api/parties/${id}`, data);\n    },\n    onSuccess: () => {\n      invalidatePartiesQueries();\n      toast({ title: \"Sucesso\", description: \"Partido atualizado\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar partido\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/parties/${id}`);\n    },\n    onSuccess: () => {\n      invalidatePartiesQueries();\n      toast({ title: \"Sucesso\", description: \"Partido excluído\" });\n      setDeleteConfirmId(null);\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao excluir partido\", variant: \"destructive\" });\n    },\n  });\n\n  const importCsvMutation = useMutation({\n    mutationFn: async (csvContent: string) => {\n      const res = await apiRequest(\"POST\", \"/api/parties/import-csv\", { csvContent });\n      return res.json();\n    },\n    onSuccess: (data) => {\n      invalidatePartiesQueries();\n      setImportResult(data);\n      if (data.success) {\n        toast({ \n          title: \"Importação concluída\", \n          description: `${data.created} criados, ${data.updated} atualizados` \n        });\n      }\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Erro na importação\", \n        description: error.message || \"Falha ao importar CSV\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  function handleFileSelect(e: React.ChangeEvent<HTMLInputElement>) {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    const reader = new FileReader();\n    reader.onload = (event) => {\n      const content = event.target?.result as string;\n      if (content) {\n        setImportResult(null);\n        importCsvMutation.mutate(content);\n      }\n    };\n    reader.readAsText(file);\n    \n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n  }\n\n  function resetForm() {\n    setFormData({ name: \"\", abbreviation: \"\", number: \"\", color: \"#003366\", coalition: \"\", notes: \"\", tags: [] });\n    setEditingParty(null);\n    setIsDialogOpen(false);\n    setTagInput(\"\");\n  }\n\n  function handleEdit(party: Party) {\n    setEditingParty(party);\n    setFormData({\n      name: party.name,\n      abbreviation: party.abbreviation,\n      number: String(party.number),\n      color: party.color,\n      coalition: party.coalition || \"\",\n      notes: party.notes || \"\",\n      tags: party.tags || [],\n    });\n    setIsDialogOpen(true);\n  }\n\n  function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    const payload = {\n      name: formData.name,\n      abbreviation: formData.abbreviation.toUpperCase(),\n      number: parseInt(formData.number, 10),\n      color: formData.color,\n      coalition: formData.coalition || null,\n      notes: formData.notes || null,\n      tags: formData.tags.length > 0 ? formData.tags : null,\n    };\n\n    if (editingParty) {\n      updateMutation.mutate({ id: editingParty.id, data: payload });\n    } else {\n      createMutation.mutate(payload as InsertParty);\n    }\n  }\n\n  function addTag() {\n    const tag = tagInput.trim();\n    if (tag && !formData.tags.includes(tag)) {\n      setFormData((f) => ({ ...f, tags: [...f.tags, tag] }));\n      setTagInput(\"\");\n    }\n  }\n\n  function removeTag(tag: string) {\n    setFormData((f) => ({ ...f, tags: f.tags.filter((t) => t !== tag) }));\n  }\n\n  function clearFilters() {\n    setSearchQuery(\"\");\n    setActiveFilter(\"all\");\n    setSortBy(\"name\");\n    setSortOrder(\"asc\");\n    setPage(1);\n  }\n\n  const hasActiveFilters = debouncedSearch || activeFilter !== \"all\";\n  const parties = paginatedData?.data || [];\n  const totalPages = paginatedData?.totalPages || 1;\n  const total = paginatedData?.total || 0;\n\n  return (\n    <div className=\"space-y-6\">\n      <PageHeader\n        title=\"Partidos Políticos\"\n        description=\"Gerencie os partidos políticos cadastrados no sistema\"\n        breadcrumbs={[\n          { label: \"Dashboard\", href: \"/\" },\n          { label: \"Partidos\" },\n        ]}\n        action={\n          hasPermission(\"manage_parties\")\n            ? {\n                label: \"Novo Partido\",\n                icon: <Plus className=\"h-4 w-4 mr-2\" />,\n                onClick: () => setIsDialogOpen(true),\n              }\n            : undefined\n        }\n      />\n\n      <div className=\"flex justify-end gap-2\">\n        {user?.role === \"admin\" && (\n          <>\n            <input\n              type=\"file\"\n              accept=\".csv\"\n              ref={fileInputRef}\n              onChange={handleFileSelect}\n              className=\"hidden\"\n              data-testid=\"input-import-csv-file\"\n            />\n            <Button\n              variant=\"outline\"\n              onClick={() => setIsImportDialogOpen(true)}\n              disabled={importCsvMutation.isPending}\n              data-testid=\"button-import-parties-csv\"\n            >\n              <Upload className=\"h-4 w-4 mr-2\" />\n              {importCsvMutation.isPending ? \"Importando...\" : \"Importar CSV\"}\n            </Button>\n          </>\n        )}\n        <Button\n          variant=\"outline\"\n          onClick={async () => {\n            try {\n              const response = await fetch(\"/api/parties/export/csv\", { credentials: \"include\" });\n              if (!response.ok) throw new Error(\"Falha ao exportar\");\n              const blob = await response.blob();\n              const url = window.URL.createObjectURL(blob);\n              const a = document.createElement(\"a\");\n              a.href = url;\n              a.download = \"partidos.csv\";\n              document.body.appendChild(a);\n              a.click();\n              window.URL.revokeObjectURL(url);\n              document.body.removeChild(a);\n            } catch {\n              toast({ title: \"Erro\", description: \"Falha ao exportar CSV\", variant: \"destructive\" });\n            }\n          }}\n          disabled={!parties || parties.length === 0}\n          data-testid=\"button-export-parties-csv\"\n        >\n          <Download className=\"h-4 w-4 mr-2\" />\n          Exportar CSV\n        </Button>\n      </div>\n\n      <Card>\n        <CardContent className=\"p-6\">\n          {/* Search and Filters */}\n          <div className=\"space-y-4 mb-6\">\n            <div className=\"flex flex-col sm:flex-row gap-3\">\n              <div className=\"relative flex-1\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Buscar por nome ou sigla...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9\"\n                  data-testid=\"input-search-parties\"\n                />\n              </div>\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowFilters(!showFilters)}\n                className=\"shrink-0\"\n                data-testid=\"button-toggle-filters\"\n              >\n                <Filter className=\"h-4 w-4 mr-2\" />\n                Filtros\n                {hasActiveFilters && (\n                  <Badge variant=\"secondary\" className=\"ml-2\">\n                    {[debouncedSearch, activeFilter !== \"all\"].filter(Boolean).length}\n                  </Badge>\n                )}\n              </Button>\n            </div>\n\n            {showFilters && (\n              <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3 p-4 bg-muted/50 rounded-lg\">\n                <div className=\"space-y-1.5\">\n                  <Label className=\"text-xs\">Status</Label>\n                  <Select value={activeFilter} onValueChange={setActiveFilter}>\n                    <SelectTrigger data-testid=\"select-filter-status\">\n                      <SelectValue placeholder=\"Todos\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">Todos</SelectItem>\n                      <SelectItem value=\"true\">Ativo</SelectItem>\n                      <SelectItem value=\"false\">Inativo</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-1.5\">\n                  <Label className=\"text-xs\">Ordenar por</Label>\n                  <div className=\"flex gap-1\">\n                    <Select value={sortBy} onValueChange={setSortBy}>\n                      <SelectTrigger className=\"flex-1\" data-testid=\"select-sort-by\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"name\">Nome</SelectItem>\n                        <SelectItem value=\"abbreviation\">Sigla</SelectItem>\n                        <SelectItem value=\"number\">Número</SelectItem>\n                        <SelectItem value=\"createdAt\">Data Cadastro</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <Button\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => setSortOrder(sortOrder === \"asc\" ? \"desc\" : \"asc\")}\n                      data-testid=\"button-toggle-sort-order\"\n                    >\n                      {sortOrder === \"asc\" ? <SortAsc className=\"h-4 w-4\" /> : <SortDesc className=\"h-4 w-4\" />}\n                    </Button>\n                  </div>\n                </div>\n\n                {hasActiveFilters && (\n                  <div className=\"flex items-end\">\n                    <Button variant=\"ghost\" size=\"sm\" onClick={clearFilters} data-testid=\"button-clear-filters\">\n                      <X className=\"h-4 w-4 mr-1\" />\n                      Limpar Filtros\n                    </Button>\n                  </div>\n                )}\n              </div>\n            )}\n          </div>\n\n          {/* Results info */}\n          {!isLoading && total > 0 && (\n            <div className=\"text-sm text-muted-foreground mb-4\">\n              Mostrando {((page - 1) * limit) + 1}-{Math.min(page * limit, total)} de {total} partido{total !== 1 ? \"s\" : \"\"}\n            </div>\n          )}\n\n          {/* Table */}\n          {isLoading ? (\n            <div className=\"space-y-3\">\n              {[...Array(5)].map((_, i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : parties.length === 0 ? (\n            <EmptyState\n              icon={Building2}\n              title={hasActiveFilters ? \"Nenhum partido encontrado\" : \"Nenhum partido cadastrado\"}\n              description={hasActiveFilters ? \"Tente ajustar os filtros de busca\" : \"Comece cadastrando os partidos políticos que participarão das simulações eleitorais\"}\n              actionLabel={!hasActiveFilters && hasPermission(\"manage_parties\") ? \"Cadastrar Partido\" : undefined}\n              onAction={!hasActiveFilters && hasPermission(\"manage_parties\") ? () => setIsDialogOpen(true) : undefined}\n            />\n          ) : (\n            <div className=\"border rounded-md overflow-hidden\">\n              <table className=\"w-full\">\n                <thead className=\"bg-muted/50\">\n                  <tr>\n                    <th className=\"text-left p-3 font-medium text-sm w-20\">Número</th>\n                    <th className=\"text-left p-3 font-medium text-sm\">Sigla</th>\n                    <th className=\"text-left p-3 font-medium text-sm\">Nome</th>\n                    <th className=\"text-left p-3 font-medium text-sm\">Coligação</th>\n                    <th className=\"text-left p-3 font-medium text-sm\">Status</th>\n                    <th className=\"text-left p-3 font-medium text-sm\">Tags</th>\n                    <th className=\"text-right p-3 font-medium text-sm w-32\">Ações</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {parties.map((party) => (\n                    <tr key={party.id} className=\"border-t hover-elevate\" data-testid={`row-party-${party.id}`}>\n                      <td className=\"p-3\">\n                        <span className=\"font-mono font-bold text-lg\">{party.number}</span>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"flex items-center gap-2\">\n                          <div\n                            className=\"w-3 h-3 rounded-full shrink-0\"\n                            style={{ backgroundColor: party.color }}\n                          />\n                          <Badge variant=\"outline\">{party.abbreviation}</Badge>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <span className=\"font-medium\">{party.name}</span>\n                      </td>\n                      <td className=\"p-3\">\n                        <span className=\"text-muted-foreground\">{party.coalition || \"-\"}</span>\n                      </td>\n                      <td className=\"p-3\">\n                        <Badge variant={party.active ? \"default\" : \"secondary\"}>\n                          {party.active ? \"Ativo\" : \"Inativo\"}\n                        </Badge>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"flex flex-wrap gap-1\">\n                          {party.tags?.slice(0, 2).map((tag) => (\n                            <Badge key={tag} variant=\"outline\" className=\"text-xs\">\n                              {tag}\n                            </Badge>\n                          ))}\n                          {(party.tags?.length || 0) > 2 && (\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              +{(party.tags?.length || 0) - 2}\n                            </Badge>\n                          )}\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"flex items-center justify-end gap-1\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => setDetailsId(party.id)}\n                            data-testid={`button-view-party-${party.id}`}\n                          >\n                            <Eye className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleEdit(party)}\n                            disabled={!hasPermission(\"manage_parties\")}\n                            data-testid={`button-edit-party-${party.id}`}\n                          >\n                            <Edit className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => setDeleteConfirmId(party.id)}\n                            disabled={!hasPermission(\"manage_parties\")}\n                            data-testid={`button-delete-party-${party.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          )}\n\n          {/* Pagination */}\n          {totalPages > 1 && (\n            <div className=\"flex items-center justify-between mt-4\">\n              <div className=\"text-sm text-muted-foreground\">\n                Página {page} de {totalPages}\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setPage((p) => Math.max(1, p - 1))}\n                  disabled={page === 1}\n                  data-testid=\"button-prev-page\"\n                >\n                  <ChevronLeft className=\"h-4 w-4 mr-1\" />\n                  Anterior\n                </Button>\n                <div className=\"flex items-center gap-1\">\n                  {[...Array(Math.min(5, totalPages))].map((_, i) => {\n                    let pageNum: number;\n                    if (totalPages <= 5) {\n                      pageNum = i + 1;\n                    } else if (page <= 3) {\n                      pageNum = i + 1;\n                    } else if (page >= totalPages - 2) {\n                      pageNum = totalPages - 4 + i;\n                    } else {\n                      pageNum = page - 2 + i;\n                    }\n                    return (\n                      <Button\n                        key={pageNum}\n                        variant={page === pageNum ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        className=\"w-8 h-8 p-0\"\n                        onClick={() => setPage(pageNum)}\n                        data-testid={`button-page-${pageNum}`}\n                      >\n                        {pageNum}\n                      </Button>\n                    );\n                  })}\n                </div>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setPage((p) => Math.min(totalPages, p + 1))}\n                  disabled={page === totalPages}\n                  data-testid=\"button-next-page\"\n                >\n                  Próximo\n                  <ChevronRight className=\"h-4 w-4 ml-1\" />\n                </Button>\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Create/Edit Dialog */}\n      <Dialog open={isDialogOpen} onOpenChange={(open) => !open && resetForm()}>\n        <DialogContent className=\"sm:max-w-md max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>{editingParty ? \"Editar Partido\" : \"Novo Partido\"}</DialogTitle>\n            <DialogDescription>\n              {editingParty ? \"Atualize as informações do partido\" : \"Preencha os dados do novo partido político\"}\n            </DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"number\">Número</Label>\n                <Input\n                  id=\"number\"\n                  type=\"number\"\n                  placeholder=\"Ex: 13\"\n                  value={formData.number}\n                  onChange={(e) => setFormData((f) => ({ ...f, number: e.target.value }))}\n                  required\n                  className=\"font-mono\"\n                  data-testid=\"input-party-number\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"abbreviation\">Sigla</Label>\n                <Input\n                  id=\"abbreviation\"\n                  placeholder=\"Ex: PT\"\n                  value={formData.abbreviation}\n                  onChange={(e) => setFormData((f) => ({ ...f, abbreviation: e.target.value.toUpperCase() }))}\n                  required\n                  maxLength={10}\n                  data-testid=\"input-party-abbreviation\"\n                />\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Nome Completo</Label>\n              <Input\n                id=\"name\"\n                placeholder=\"Ex: Partido dos Trabalhadores\"\n                value={formData.name}\n                onChange={(e) => setFormData((f) => ({ ...f, name: e.target.value }))}\n                required\n                data-testid=\"input-party-name\"\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"color\">Cor</Label>\n                <div className=\"flex gap-2\">\n                  <Input\n                    id=\"color\"\n                    type=\"color\"\n                    value={formData.color}\n                    onChange={(e) => setFormData((f) => ({ ...f, color: e.target.value }))}\n                    className=\"w-12 h-9 p-1 cursor-pointer\"\n                    data-testid=\"input-party-color\"\n                  />\n                  <Input\n                    value={formData.color}\n                    onChange={(e) => setFormData((f) => ({ ...f, color: e.target.value }))}\n                    className=\"flex-1 font-mono\"\n                    placeholder=\"#003366\"\n                  />\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"coalition\">Coligação</Label>\n                <Input\n                  id=\"coalition\"\n                  placeholder=\"Opcional\"\n                  value={formData.coalition}\n                  onChange={(e) => setFormData((f) => ({ ...f, coalition: e.target.value }))}\n                  data-testid=\"input-party-coalition\"\n                />\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"notes\">Notas Internas</Label>\n              <Textarea\n                id=\"notes\"\n                placeholder=\"Notas internas sobre o partido (não visível publicamente)\"\n                value={formData.notes}\n                onChange={(e) => setFormData((f) => ({ ...f, notes: e.target.value }))}\n                rows={2}\n                data-testid=\"input-party-notes\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Tags</Label>\n              <div className=\"flex gap-2\">\n                <Input\n                  placeholder=\"Adicionar tag...\"\n                  value={tagInput}\n                  onChange={(e) => setTagInput(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === \"Enter\") {\n                      e.preventDefault();\n                      addTag();\n                    }\n                  }}\n                  data-testid=\"input-party-tag\"\n                />\n                <Button type=\"button\" variant=\"outline\" onClick={addTag} data-testid=\"button-add-tag\">\n                  <Tag className=\"h-4 w-4\" />\n                </Button>\n              </div>\n              {formData.tags.length > 0 && (\n                <div className=\"flex flex-wrap gap-1 mt-2\">\n                  {formData.tags.map((tag) => (\n                    <Badge key={tag} variant=\"secondary\" className=\"cursor-pointer\" onClick={() => removeTag(tag)}>\n                      {tag}\n                      <X className=\"h-3 w-3 ml-1\" />\n                    </Badge>\n                  ))}\n                </div>\n              )}\n            </div>\n            <DialogFooter>\n              <Button type=\"button\" variant=\"outline\" onClick={resetForm}>\n                Cancelar\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-save-party\"\n              >\n                {editingParty ? \"Salvar\" : \"Criar\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Details Dialog */}\n      <Dialog open={detailsId !== null} onOpenChange={(open) => !open && setDetailsId(null)}>\n        <DialogContent className=\"sm:max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Detalhes do Partido</DialogTitle>\n            <DialogDescription>\n              Informações detalhadas e histórico de desempenho\n            </DialogDescription>\n          </DialogHeader>\n          {isLoadingDetails ? (\n            <div className=\"space-y-4\">\n              <Skeleton className=\"h-20 w-full\" />\n              <Skeleton className=\"h-40 w-full\" />\n            </div>\n          ) : partyDetails ? (\n            <div className=\"space-y-6\">\n              <div className=\"flex items-start gap-4\">\n                <div\n                  className=\"w-16 h-16 rounded-lg flex items-center justify-center text-white text-2xl font-bold\"\n                  style={{ backgroundColor: partyDetails.color }}\n                >\n                  {partyDetails.abbreviation.slice(0, 2)}\n                </div>\n                <div className=\"flex-1\">\n                  <h3 className=\"text-xl font-semibold\">{partyDetails.name}</h3>\n                  <div className=\"flex items-center gap-3 mt-2 flex-wrap\">\n                    <Badge variant=\"outline\" className=\"font-mono\">{partyDetails.number}</Badge>\n                    <Badge variant=\"outline\">{partyDetails.abbreviation}</Badge>\n                    {partyDetails.coalition && (\n                      <Badge variant=\"secondary\">{partyDetails.coalition}</Badge>\n                    )}\n                    <Badge variant={partyDetails.active ? \"default\" : \"secondary\"}>\n                      {partyDetails.active ? \"Ativo\" : \"Inativo\"}\n                    </Badge>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total de Candidatos</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-2xl font-bold\">{partyDetails.candidateCount}</p>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total de Votos (TSE)</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-2xl font-bold\">{partyDetails.totalVotes.toLocaleString(\"pt-BR\")}</p>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {partyDetails.notes && (\n                <div>\n                  <h4 className=\"font-medium mb-2\">Notas Internas</h4>\n                  <p className=\"text-sm text-muted-foreground\">{partyDetails.notes}</p>\n                </div>\n              )}\n\n              {partyDetails.tags && partyDetails.tags.length > 0 && (\n                <div>\n                  <h4 className=\"font-medium mb-2\">Tags</h4>\n                  <div className=\"flex flex-wrap gap-1\">\n                    {partyDetails.tags.map((tag) => (\n                      <Badge key={tag} variant=\"outline\">{tag}</Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {partyDetails.historicalPerformance.length > 0 && (\n                <div>\n                  <h4 className=\"font-medium mb-2\">Histórico Eleitoral (TSE)</h4>\n                  <div className=\"border rounded-md overflow-hidden\">\n                    <table className=\"w-full text-sm\">\n                      <thead className=\"bg-muted/50\">\n                        <tr>\n                          <th className=\"text-left p-2\">Ano</th>\n                          <th className=\"text-right p-2\">Votos</th>\n                          <th className=\"text-right p-2\">Cadeiras</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {partyDetails.historicalPerformance.map((h, i) => (\n                          <tr key={i} className=\"border-t\">\n                            <td className=\"p-2 font-mono\">{h.year}</td>\n                            <td className=\"p-2 text-right font-mono\">{h.votes.toLocaleString(\"pt-BR\")}</td>\n                            <td className=\"p-2 text-right font-mono\">{h.seats}</td>\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              )}\n\n              {partyDetails.recentScenarios.length > 0 && (\n                <div>\n                  <h4 className=\"font-medium mb-2\">Cenários de Simulação Recentes</h4>\n                  <div className=\"border rounded-md overflow-hidden\">\n                    <table className=\"w-full text-sm\">\n                      <thead className=\"bg-muted/50\">\n                        <tr>\n                          <th className=\"text-left p-2\">Cenário</th>\n                          <th className=\"text-right p-2\">Votos</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {partyDetails.recentScenarios.map((s) => (\n                          <tr key={s.id} className=\"border-t\">\n                            <td className=\"p-2\">{s.name}</td>\n                            <td className=\"p-2 text-right font-mono\">{s.votes.toLocaleString(\"pt-BR\")}</td>\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              )}\n            </div>\n          ) : null}\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={deleteConfirmId !== null} onOpenChange={() => setDeleteConfirmId(null)}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Confirmar Exclusão</DialogTitle>\n            <DialogDescription>\n              Tem certeza que deseja excluir este partido? Esta ação não pode ser desfeita.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeleteConfirmId(null)}>\n              Cancelar\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deleteConfirmId && deleteMutation.mutate(deleteConfirmId)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              Excluir\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Import CSV Dialog */}\n      <Dialog open={isImportDialogOpen} onOpenChange={(open) => {\n        setIsImportDialogOpen(open);\n        if (!open) setImportResult(null);\n      }}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <FileSpreadsheet className=\"h-5 w-5\" />\n              Importar Partidos via CSV\n            </DialogTitle>\n            <DialogDescription>\n              Importe partidos a partir de um arquivo CSV. Partidos existentes serão atualizados.\n            </DialogDescription>\n          </DialogHeader>\n\n          {!importResult ? (\n            <div className=\"space-y-4\">\n              <div className=\"rounded-lg border-2 border-dashed p-6 text-center\">\n                <FileSpreadsheet className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                <p className=\"text-sm text-muted-foreground mb-4\">\n                  O arquivo CSV deve conter as colunas:<br />\n                  <span className=\"font-mono text-xs\">Numero;Sigla;Nome;Cor;Coligacao;Ativo</span>\n                </p>\n                <Button\n                  onClick={() => fileInputRef.current?.click()}\n                  disabled={importCsvMutation.isPending}\n                  data-testid=\"button-select-csv-file\"\n                >\n                  <Upload className=\"h-4 w-4 mr-2\" />\n                  {importCsvMutation.isPending ? \"Processando...\" : \"Selecionar Arquivo CSV\"}\n                </Button>\n              </div>\n\n              <div className=\"text-xs text-muted-foreground space-y-1\">\n                <p><strong>Formato aceito:</strong> CSV com separador ponto e vírgula (;) ou vírgula (,)</p>\n                <p><strong>Partidos existentes:</strong> Serão atualizados com base no número ou sigla</p>\n                <p><strong>Novos partidos:</strong> Serão criados automaticamente</p>\n              </div>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              <div className={`rounded-lg p-4 ${importResult.success ? \"bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800\" : \"bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-800\"}`}>\n                <div className=\"flex items-center gap-2 mb-2\">\n                  {importResult.success ? (\n                    <CheckCircle className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n                  ) : (\n                    <AlertCircle className=\"h-5 w-5 text-red-600 dark:text-red-400\" />\n                  )}\n                  <span className=\"font-medium\">{importResult.message}</span>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-3 gap-4 text-center\">\n                <div className=\"rounded-lg bg-green-100 dark:bg-green-900 p-3\">\n                  <div className=\"text-2xl font-bold text-green-700 dark:text-green-300\">{importResult.created}</div>\n                  <div className=\"text-xs text-green-600 dark:text-green-400\">Criados</div>\n                </div>\n                <div className=\"rounded-lg bg-blue-100 dark:bg-blue-900 p-3\">\n                  <div className=\"text-2xl font-bold text-blue-700 dark:text-blue-300\">{importResult.updated}</div>\n                  <div className=\"text-xs text-blue-600 dark:text-blue-400\">Atualizados</div>\n                </div>\n                <div className=\"rounded-lg bg-amber-100 dark:bg-amber-900 p-3\">\n                  <div className=\"text-2xl font-bold text-amber-700 dark:text-amber-300\">{importResult.skipped}</div>\n                  <div className=\"text-xs text-amber-600 dark:text-amber-400\">Ignorados</div>\n                </div>\n              </div>\n\n              {importResult.errors && importResult.errors.length > 0 && (\n                <div className=\"rounded-lg border p-3 max-h-32 overflow-y-auto\">\n                  <p className=\"text-sm font-medium text-destructive mb-2\">Erros encontrados:</p>\n                  <ul className=\"text-xs text-muted-foreground space-y-1\">\n                    {importResult.errors.map((err, idx) => (\n                      <li key={idx}>{err}</li>\n                    ))}\n                  </ul>\n                </div>\n              )}\n            </div>\n          )}\n\n          <DialogFooter>\n            {importResult ? (\n              <>\n                <Button variant=\"outline\" onClick={() => setImportResult(null)}>\n                  Importar Outro\n                </Button>\n                <Button onClick={() => {\n                  setIsImportDialogOpen(false);\n                  setImportResult(null);\n                }}>\n                  Concluir\n                </Button>\n              </>\n            ) : (\n              <Button variant=\"outline\" onClick={() => setIsImportDialogOpen(false)}>\n                Cancelar\n              </Button>\n            )}\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":39996,"size_tokens":null},"client/replit_integrations/audio/useAudioPlayback.ts":{"content":"/**\n * React hook for streaming audio playback using AudioWorklet.\n * Supports real-time PCM16 audio streaming from SSE responses.\n * Includes sequence buffer for reordering out-of-order chunks.\n */\nimport { useRef, useCallback, useState } from \"react\";\nimport { decodePCM16ToFloat32 } from \"./audio-utils\";\n\nexport type PlaybackState = \"idle\" | \"playing\" | \"ended\";\n\n/**\n * Reorders audio chunks that may arrive out of sequence.\n * Buffers chunks until they can be played in correct order.\n *\n * Example: If chunks arrive as seq 2, seq 0, seq 1:\n * - seq 2 arrives → buffered (waiting for seq 0)\n * - seq 0 arrives → played immediately, then check buffer\n * - seq 1 arrives → played immediately (seq 0 done), seq 2 now plays\n */\nclass SequenceBuffer {\n  private pending = new Map<number, string[]>();\n  private nextSeq = 0;\n\n  /** Add chunk with sequence number, returns chunks ready to play in order */\n  push(seq: number, data: string): string[] {\n    // Store the chunk under its sequence number\n    if (!this.pending.has(seq)) {\n      this.pending.set(seq, []);\n    }\n    this.pending.get(seq)!.push(data);\n\n    // Drain consecutive ready sequences\n    const ready: string[] = [];\n    while (this.pending.has(this.nextSeq)) {\n      ready.push(...this.pending.get(this.nextSeq)!);\n      this.pending.delete(this.nextSeq);\n      this.nextSeq++;\n    }\n    return ready;\n  }\n\n  reset() {\n    this.pending.clear();\n    this.nextSeq = 0;\n  }\n}\n\nexport function useAudioPlayback(workletPath = \"/audio-playback-worklet.js\") {\n  const [state, setState] = useState<PlaybackState>(\"idle\");\n  const ctxRef = useRef<AudioContext | null>(null);\n  const workletRef = useRef<AudioWorkletNode | null>(null);\n  const readyRef = useRef(false);\n  const seqBufferRef = useRef(new SequenceBuffer());\n\n  const init = useCallback(async () => {\n    if (readyRef.current) return;\n\n    const ctx = new AudioContext({ sampleRate: 24000 });\n    await ctx.audioWorklet.addModule(workletPath);\n    const worklet = new AudioWorkletNode(ctx, \"audio-playback-processor\");\n    worklet.connect(ctx.destination);\n\n    worklet.port.onmessage = (e) => {\n      if (e.data.type === \"ended\") setState(\"idle\");\n    };\n\n    ctxRef.current = ctx;\n    workletRef.current = worklet;\n    readyRef.current = true;\n  }, [workletPath]);\n\n  /** Push audio directly (no sequencing) - for simple streaming */\n  const pushAudio = useCallback((base64Audio: string) => {\n    if (!workletRef.current) return;\n    const samples = decodePCM16ToFloat32(base64Audio);\n    workletRef.current.port.postMessage({ type: \"audio\", samples });\n    setState(\"playing\");\n  }, []);\n\n  /** Push audio with sequence number - reorders before playback */\n  const pushSequencedAudio = useCallback((seq: number, base64Audio: string) => {\n    if (!workletRef.current) return;\n\n    const readyChunks = seqBufferRef.current.push(seq, base64Audio);\n    for (const chunk of readyChunks) {\n      const samples = decodePCM16ToFloat32(chunk);\n      workletRef.current.port.postMessage({ type: \"audio\", samples });\n    }\n    if (readyChunks.length > 0) {\n      setState(\"playing\");\n    }\n  }, []);\n\n  const signalComplete = useCallback(() => {\n    workletRef.current?.port.postMessage({ type: \"streamComplete\" });\n  }, []);\n\n  const clear = useCallback(() => {\n    workletRef.current?.port.postMessage({ type: \"clear\" });\n    seqBufferRef.current.reset();\n    setState(\"idle\");\n  }, []);\n\n  return { state, init, pushAudio, pushSequencedAudio, signalComplete, clear };\n}\n","path":null,"size_bytes":3495,"size_tokens":null},"client/src/pages/report-automation.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport {\n  Clock,\n  FileText,\n  Mail,\n  Play,\n  Plus,\n  Trash2,\n  Edit,\n  Calendar,\n  Check,\n  X,\n  Loader2,\n  AlertCircle,\n  FileSpreadsheet,\n  Users,\n  Settings,\n} from \"lucide-react\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\n\ninterface ReportTemplate {\n  id: number;\n  name: string;\n  description?: string;\n  reportType: string;\n  filters: Record<string, any>;\n  columns?: string[];\n  isActive: boolean;\n  createdAt: string;\n  createdBy?: number;\n}\n\ninterface ReportSchedule {\n  id: number;\n  templateId: number;\n  name: string;\n  description?: string;\n  frequency: string;\n  dayOfWeek?: number;\n  dayOfMonth?: number;\n  timeOfDay: string;\n  timezone: string;\n  recipientEmails: string[];\n  isActive: boolean;\n  lastRunAt?: string;\n  nextRunAt?: string;\n}\n\ninterface ReportRun {\n  id: number;\n  templateId: number;\n  scheduleId?: number;\n  triggeredBy: string;\n  status: string;\n  startedAt?: string;\n  completedAt?: string;\n  rowCount?: number;\n  fileSize?: number;\n  filePath?: string;\n  errorMessage?: string;\n  emailsSent?: number;\n  executionTimeMs?: number;\n  createdAt: string;\n}\n\ninterface Recipient {\n  id: number;\n  name: string;\n  email: string;\n  isActive: boolean;\n}\n\ninterface EmailStatus {\n  configured: boolean;\n  provider?: string;\n  message: string;\n}\n\nconst REPORT_TYPES = [\n  { value: \"candidates\", label: \"Candidatos\", description: \"Lista detalhada de candidatos e votos\" },\n  { value: \"parties\", label: \"Partidos\", description: \"Resumo de votos por partido\" },\n  { value: \"voting_details\", label: \"Detalhes de Votação\", description: \"Dados completos de votação\" },\n  { value: \"summary\", label: \"Resumo\", description: \"Estatísticas gerais\" },\n];\n\nconst FREQUENCIES = [\n  { value: \"once\", label: \"Única vez\" },\n  { value: \"daily\", label: \"Diário\" },\n  { value: \"weekly\", label: \"Semanal\" },\n  { value: \"monthly\", label: \"Mensal\" },\n];\n\nconst DAYS_OF_WEEK = [\n  { value: 0, label: \"Domingo\" },\n  { value: 1, label: \"Segunda\" },\n  { value: 2, label: \"Terça\" },\n  { value: 3, label: \"Quarta\" },\n  { value: 4, label: \"Quinta\" },\n  { value: 5, label: \"Sexta\" },\n  { value: 6, label: \"Sábado\" },\n];\n\nexport default function ReportAutomation() {\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const isAdmin = user?.role === \"admin\";\n  \n  const [activeTab, setActiveTab] = useState<\"templates\" | \"schedules\" | \"runs\" | \"recipients\">(\"templates\");\n  const [showTemplateDialog, setShowTemplateDialog] = useState(false);\n  const [showScheduleDialog, setShowScheduleDialog] = useState(false);\n  const [showRecipientDialog, setShowRecipientDialog] = useState(false);\n  const [editingTemplate, setEditingTemplate] = useState<ReportTemplate | null>(null);\n  const [editingSchedule, setEditingSchedule] = useState<ReportSchedule | null>(null);\n  const [editingRecipient, setEditingRecipient] = useState<Recipient | null>(null);\n  \n  const [templateForm, setTemplateForm] = useState({\n    name: \"\",\n    description: \"\",\n    reportType: \"candidates\",\n    filters: {} as Record<string, string | undefined>,\n    isActive: true,\n  });\n  \n  const [scheduleForm, setScheduleForm] = useState({\n    templateId: 0,\n    name: \"\",\n    description: \"\",\n    frequency: \"daily\",\n    dayOfWeek: 1,\n    dayOfMonth: 1,\n    timeOfDay: \"08:00\",\n    timezone: \"America/Sao_Paulo\",\n    recipientEmails: [] as string[],\n    isActive: true,\n  });\n  \n  const [recipientForm, setRecipientForm] = useState({\n    name: \"\",\n    email: \"\",\n    isActive: true,\n  });\n  \n  const { data: templates, isLoading: templatesLoading } = useQuery<ReportTemplate[]>({\n    queryKey: [\"/api/report-templates\"],\n  });\n  \n  const { data: schedules, isLoading: schedulesLoading } = useQuery<ReportSchedule[]>({\n    queryKey: [\"/api/report-schedules\"],\n  });\n  \n  const { data: runs, isLoading: runsLoading } = useQuery<ReportRun[]>({\n    queryKey: [\"/api/report-runs\", { limit: 50 }],\n  });\n  \n  const { data: recipients, isLoading: recipientsLoading } = useQuery<Recipient[]>({\n    queryKey: [\"/api/report-recipients\"],\n  });\n  \n  const { data: emailStatus } = useQuery<EmailStatus>({\n    queryKey: [\"/api/email/status\"],\n    enabled: isAdmin,\n  });\n  \n  const { data: years } = useQuery<number[]>({\n    queryKey: [\"/api/analytics/election-years\"],\n  });\n  \n  const { data: states } = useQuery<string[]>({\n    queryKey: [\"/api/analytics/states\"],\n  });\n  \n  const createTemplateMutation = useMutation({\n    mutationFn: async (data: typeof templateForm) => {\n      return apiRequest(\"POST\", \"/api/report-templates\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/report-templates\"] });\n      setShowTemplateDialog(false);\n      resetTemplateForm();\n      toast({ title: \"Template criado com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar template\", variant: \"destructive\" });\n    },\n  });\n  \n  const updateTemplateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: Partial<typeof templateForm> }) => {\n      return apiRequest(\"PATCH\", `/api/report-templates/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/report-templates\"] });\n      setShowTemplateDialog(false);\n      setEditingTemplate(null);\n      resetTemplateForm();\n      toast({ title: \"Template atualizado com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar template\", variant: \"destructive\" });\n    },\n  });\n  \n  const deleteTemplateMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/report-templates/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/report-templates\"] });\n      toast({ title: \"Template excluído\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao excluir template\", variant: \"destructive\" });\n    },\n  });\n  \n  const createScheduleMutation = useMutation({\n    mutationFn: async (data: typeof scheduleForm) => {\n      return apiRequest(\"POST\", \"/api/report-schedules\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/report-schedules\"] });\n      setShowScheduleDialog(false);\n      resetScheduleForm();\n      toast({ title: \"Agendamento criado com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar agendamento\", variant: \"destructive\" });\n    },\n  });\n  \n  const updateScheduleMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: Partial<typeof scheduleForm> }) => {\n      return apiRequest(\"PATCH\", `/api/report-schedules/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/report-schedules\"] });\n      setShowScheduleDialog(false);\n      setEditingSchedule(null);\n      resetScheduleForm();\n      toast({ title: \"Agendamento atualizado com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar agendamento\", variant: \"destructive\" });\n    },\n  });\n  \n  const deleteScheduleMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/report-schedules/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/report-schedules\"] });\n      toast({ title: \"Agendamento excluído\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao excluir agendamento\", variant: \"destructive\" });\n    },\n  });\n  \n  const triggerReportMutation = useMutation({\n    mutationFn: async ({ templateId, recipients }: { templateId: number; recipients?: string[] }) => {\n      return apiRequest(\"POST\", `/api/report-runs/trigger/${templateId}`, { recipients });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/report-runs\"] });\n      toast({ title: \"Relatório em geração\", description: \"O relatório será gerado em breve.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao gerar relatório\", variant: \"destructive\" });\n    },\n  });\n  \n  const createRecipientMutation = useMutation({\n    mutationFn: async (data: typeof recipientForm) => {\n      return apiRequest(\"POST\", \"/api/report-recipients\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/report-recipients\"] });\n      setShowRecipientDialog(false);\n      resetRecipientForm();\n      toast({ title: \"Destinatário adicionado\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao adicionar destinatário\", variant: \"destructive\" });\n    },\n  });\n  \n  const deleteRecipientMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/report-recipients/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/report-recipients\"] });\n      toast({ title: \"Destinatário removido\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao remover destinatário\", variant: \"destructive\" });\n    },\n  });\n  \n  function resetTemplateForm() {\n    setTemplateForm({\n      name: \"\",\n      description: \"\",\n      reportType: \"candidates\",\n      filters: {},\n      isActive: true,\n    });\n  }\n  \n  function resetScheduleForm() {\n    setScheduleForm({\n      templateId: 0,\n      name: \"\",\n      description: \"\",\n      frequency: \"daily\",\n      dayOfWeek: 1,\n      dayOfMonth: 1,\n      timeOfDay: \"08:00\",\n      timezone: \"America/Sao_Paulo\",\n      recipientEmails: [],\n      isActive: true,\n    });\n  }\n  \n  function resetRecipientForm() {\n    setRecipientForm({\n      name: \"\",\n      email: \"\",\n      isActive: true,\n    });\n  }\n  \n  function openEditTemplate(template: ReportTemplate) {\n    setEditingTemplate(template);\n    setTemplateForm({\n      name: template.name,\n      description: template.description || \"\",\n      reportType: template.reportType,\n      filters: template.filters || {},\n      isActive: template.isActive,\n    });\n    setShowTemplateDialog(true);\n  }\n  \n  function openEditSchedule(schedule: ReportSchedule) {\n    setEditingSchedule(schedule);\n    setScheduleForm({\n      templateId: schedule.templateId,\n      name: schedule.name,\n      description: schedule.description || \"\",\n      frequency: schedule.frequency,\n      dayOfWeek: schedule.dayOfWeek || 1,\n      dayOfMonth: schedule.dayOfMonth || 1,\n      timeOfDay: schedule.timeOfDay,\n      timezone: schedule.timezone,\n      recipientEmails: schedule.recipientEmails || [],\n      isActive: schedule.isActive,\n    });\n    setShowScheduleDialog(true);\n  }\n  \n  function handleSaveTemplate() {\n    if (!templateForm.name.trim()) {\n      toast({ title: \"Nome é obrigatório\", variant: \"destructive\" });\n      return;\n    }\n    \n    if (editingTemplate) {\n      updateTemplateMutation.mutate({ id: editingTemplate.id, data: templateForm });\n    } else {\n      createTemplateMutation.mutate(templateForm);\n    }\n  }\n  \n  function handleSaveSchedule() {\n    if (!scheduleForm.name.trim()) {\n      toast({ title: \"Nome é obrigatório\", variant: \"destructive\" });\n      return;\n    }\n    if (!scheduleForm.templateId) {\n      toast({ title: \"Selecione um template\", variant: \"destructive\" });\n      return;\n    }\n    \n    if (editingSchedule) {\n      updateScheduleMutation.mutate({ id: editingSchedule.id, data: scheduleForm });\n    } else {\n      createScheduleMutation.mutate(scheduleForm);\n    }\n  }\n  \n  function handleSaveRecipient() {\n    if (!recipientForm.name.trim() || !recipientForm.email.trim()) {\n      toast({ title: \"Nome e email são obrigatórios\", variant: \"destructive\" });\n      return;\n    }\n    \n    createRecipientMutation.mutate(recipientForm);\n  }\n  \n  function formatDate(dateStr?: string) {\n    if (!dateStr) return \"-\";\n    return new Date(dateStr).toLocaleString(\"pt-BR\");\n  }\n  \n  function getStatusBadge(status: string) {\n    switch (status) {\n      case \"completed\":\n        return <Badge variant=\"default\" className=\"bg-green-600\"><Check className=\"h-3 w-3 mr-1\" />Concluído</Badge>;\n      case \"running\":\n        return <Badge variant=\"secondary\"><Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />Executando</Badge>;\n      case \"pending\":\n        return <Badge variant=\"outline\"><Clock className=\"h-3 w-3 mr-1\" />Pendente</Badge>;\n      case \"failed\":\n        return <Badge variant=\"destructive\"><X className=\"h-3 w-3 mr-1\" />Falhou</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  }\n  \n  const getReportTypeName = (type: string) => {\n    return REPORT_TYPES.find(t => t.value === type)?.label || type;\n  };\n  \n  const getFrequencyName = (freq: string) => {\n    return FREQUENCIES.find(f => f.value === freq)?.label || freq;\n  };\n\n  return (\n    <div className=\"container mx-auto p-4 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"heading-automation\">Automação de Relatórios</h1>\n          <p className=\"text-muted-foreground\">Crie templates e agende geração automática de relatórios</p>\n        </div>\n        {isAdmin && emailStatus && (\n          <div className=\"flex items-center gap-2\">\n            {emailStatus.configured ? (\n              <Badge variant=\"default\" className=\"bg-green-600\">\n                <Mail className=\"h-3 w-3 mr-1\" />\n                Email Configurado\n              </Badge>\n            ) : (\n              <Badge variant=\"outline\">\n                <AlertCircle className=\"h-3 w-3 mr-1\" />\n                Email não configurado\n              </Badge>\n            )}\n          </div>\n        )}\n      </div>\n\n      <div className=\"flex gap-2 border-b\">\n        <Button\n          variant={activeTab === \"templates\" ? \"default\" : \"ghost\"}\n          onClick={() => setActiveTab(\"templates\")}\n          data-testid=\"tab-templates\"\n        >\n          <FileText className=\"h-4 w-4 mr-2\" />\n          Templates\n        </Button>\n        <Button\n          variant={activeTab === \"schedules\" ? \"default\" : \"ghost\"}\n          onClick={() => setActiveTab(\"schedules\")}\n          data-testid=\"tab-schedules\"\n        >\n          <Calendar className=\"h-4 w-4 mr-2\" />\n          Agendamentos\n        </Button>\n        <Button\n          variant={activeTab === \"runs\" ? \"default\" : \"ghost\"}\n          onClick={() => setActiveTab(\"runs\")}\n          data-testid=\"tab-runs\"\n        >\n          <Clock className=\"h-4 w-4 mr-2\" />\n          Execuções\n        </Button>\n        <Button\n          variant={activeTab === \"recipients\" ? \"default\" : \"ghost\"}\n          onClick={() => setActiveTab(\"recipients\")}\n          data-testid=\"tab-recipients\"\n        >\n          <Users className=\"h-4 w-4 mr-2\" />\n          Destinatários\n        </Button>\n      </div>\n\n      {activeTab === \"templates\" && (\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n            <div>\n              <CardTitle>Templates de Relatório</CardTitle>\n              <CardDescription>Defina modelos de relatórios para geração automatizada</CardDescription>\n            </div>\n            {isAdmin && (\n              <Button onClick={() => { resetTemplateForm(); setEditingTemplate(null); setShowTemplateDialog(true); }} data-testid=\"button-new-template\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Novo Template\n              </Button>\n            )}\n          </CardHeader>\n          <CardContent>\n            {templatesLoading ? (\n              <div className=\"space-y-2\">\n                <Skeleton className=\"h-12 w-full\" />\n                <Skeleton className=\"h-12 w-full\" />\n              </div>\n            ) : !templates?.length ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <FileText className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                <p>Nenhum template criado</p>\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Nome</TableHead>\n                    <TableHead>Tipo</TableHead>\n                    <TableHead>Filtros</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Ações</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {templates.map((template) => (\n                    <TableRow key={template.id} data-testid={`row-template-${template.id}`}>\n                      <TableCell>\n                        <div>\n                          <p className=\"font-medium\">{template.name}</p>\n                          {template.description && (\n                            <p className=\"text-sm text-muted-foreground\">{template.description}</p>\n                          )}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\">{getReportTypeName(template.reportType)}</Badge>\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex flex-wrap gap-1\">\n                          {template.filters?.year && <Badge variant=\"secondary\" className=\"text-xs\">Ano: {template.filters.year}</Badge>}\n                          {template.filters?.state && <Badge variant=\"secondary\" className=\"text-xs\">UF: {template.filters.state}</Badge>}\n                          {template.filters?.position && <Badge variant=\"secondary\" className=\"text-xs\">{template.filters.position}</Badge>}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        {template.isActive ? (\n                          <Badge variant=\"default\" className=\"bg-green-600\">Ativo</Badge>\n                        ) : (\n                          <Badge variant=\"outline\">Inativo</Badge>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex gap-1\">\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => triggerReportMutation.mutate({ templateId: template.id })}\n                            disabled={triggerReportMutation.isPending}\n                            title=\"Gerar agora\"\n                            data-testid={`button-trigger-${template.id}`}\n                          >\n                            <Play className=\"h-4 w-4\" />\n                          </Button>\n                          {isAdmin && (\n                            <>\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={() => openEditTemplate(template)}\n                                title=\"Editar\"\n                                data-testid={`button-edit-${template.id}`}\n                              >\n                                <Edit className=\"h-4 w-4\" />\n                              </Button>\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={() => deleteTemplateMutation.mutate(template.id)}\n                                disabled={deleteTemplateMutation.isPending}\n                                title=\"Excluir\"\n                                data-testid={`button-delete-${template.id}`}\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </Button>\n                            </>\n                          )}\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {activeTab === \"schedules\" && (\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n            <div>\n              <CardTitle>Agendamentos</CardTitle>\n              <CardDescription>Configure quando os relatórios devem ser gerados automaticamente</CardDescription>\n            </div>\n            {isAdmin && (\n              <Button onClick={() => { resetScheduleForm(); setEditingSchedule(null); setShowScheduleDialog(true); }} data-testid=\"button-new-schedule\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Novo Agendamento\n              </Button>\n            )}\n          </CardHeader>\n          <CardContent>\n            {schedulesLoading ? (\n              <div className=\"space-y-2\">\n                <Skeleton className=\"h-12 w-full\" />\n                <Skeleton className=\"h-12 w-full\" />\n              </div>\n            ) : !schedules?.length ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Calendar className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                <p>Nenhum agendamento criado</p>\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Nome</TableHead>\n                    <TableHead>Template</TableHead>\n                    <TableHead>Frequência</TableHead>\n                    <TableHead>Próxima Execução</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Ações</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {schedules.map((schedule) => {\n                    const template = templates?.find(t => t.id === schedule.templateId);\n                    return (\n                      <TableRow key={schedule.id} data-testid={`row-schedule-${schedule.id}`}>\n                        <TableCell>\n                          <div>\n                            <p className=\"font-medium\">{schedule.name}</p>\n                            {schedule.description && (\n                              <p className=\"text-sm text-muted-foreground\">{schedule.description}</p>\n                            )}\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant=\"outline\">{template?.name || `ID: ${schedule.templateId}`}</Badge>\n                        </TableCell>\n                        <TableCell>\n                          <div>\n                            <p>{getFrequencyName(schedule.frequency)}</p>\n                            <p className=\"text-sm text-muted-foreground\">{schedule.timeOfDay}</p>\n                          </div>\n                        </TableCell>\n                        <TableCell>{formatDate(schedule.nextRunAt)}</TableCell>\n                        <TableCell>\n                          {schedule.isActive ? (\n                            <Badge variant=\"default\" className=\"bg-green-600\">Ativo</Badge>\n                          ) : (\n                            <Badge variant=\"outline\">Inativo</Badge>\n                          )}\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex gap-1\">\n                            {isAdmin && (\n                              <>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  onClick={() => openEditSchedule(schedule)}\n                                  title=\"Editar\"\n                                  data-testid={`button-edit-schedule-${schedule.id}`}\n                                >\n                                  <Edit className=\"h-4 w-4\" />\n                                </Button>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  onClick={() => deleteScheduleMutation.mutate(schedule.id)}\n                                  disabled={deleteScheduleMutation.isPending}\n                                  title=\"Excluir\"\n                                  data-testid={`button-delete-schedule-${schedule.id}`}\n                                >\n                                  <Trash2 className=\"h-4 w-4\" />\n                                </Button>\n                              </>\n                            )}\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    );\n                  })}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {activeTab === \"runs\" && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Histórico de Execuções</CardTitle>\n            <CardDescription>Últimos relatórios gerados</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {runsLoading ? (\n              <div className=\"space-y-2\">\n                <Skeleton className=\"h-12 w-full\" />\n                <Skeleton className=\"h-12 w-full\" />\n              </div>\n            ) : !runs?.length ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Clock className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                <p>Nenhuma execução registrada</p>\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>ID</TableHead>\n                    <TableHead>Template</TableHead>\n                    <TableHead>Origem</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Iniciado</TableHead>\n                    <TableHead>Linhas</TableHead>\n                    <TableHead>Emails</TableHead>\n                    <TableHead>Tempo</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {runs.map((run) => {\n                    const template = templates?.find(t => t.id === run.templateId);\n                    return (\n                      <TableRow key={run.id} data-testid={`row-run-${run.id}`}>\n                        <TableCell className=\"font-mono\">#{run.id}</TableCell>\n                        <TableCell>\n                          <Badge variant=\"outline\">{template?.name || `ID: ${run.templateId}`}</Badge>\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant=\"secondary\">{run.triggeredBy === \"manual\" ? \"Manual\" : \"Agendado\"}</Badge>\n                        </TableCell>\n                        <TableCell>{getStatusBadge(run.status)}</TableCell>\n                        <TableCell>{formatDate(run.startedAt || run.createdAt)}</TableCell>\n                        <TableCell>{run.rowCount?.toLocaleString(\"pt-BR\") || \"-\"}</TableCell>\n                        <TableCell>{run.emailsSent || 0}</TableCell>\n                        <TableCell>\n                          {run.executionTimeMs ? `${(run.executionTimeMs / 1000).toFixed(1)}s` : \"-\"}\n                        </TableCell>\n                      </TableRow>\n                    );\n                  })}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {activeTab === \"recipients\" && (\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n            <div>\n              <CardTitle>Destinatários</CardTitle>\n              <CardDescription>Lista de emails para receber relatórios</CardDescription>\n            </div>\n            {isAdmin && (\n              <Button onClick={() => { resetRecipientForm(); setShowRecipientDialog(true); }} data-testid=\"button-new-recipient\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Novo Destinatário\n              </Button>\n            )}\n          </CardHeader>\n          <CardContent>\n            {!emailStatus?.configured && (\n              <div className=\"mb-4 p-4 border rounded-lg bg-muted/50\">\n                <div className=\"flex items-start gap-2\">\n                  <AlertCircle className=\"h-5 w-5 text-amber-500 mt-0.5\" />\n                  <div>\n                    <p className=\"font-medium\">Email não configurado</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Configure o secret RESEND_API_KEY para habilitar o envio de emails.\n                    </p>\n                  </div>\n                </div>\n              </div>\n            )}\n            \n            {recipientsLoading ? (\n              <div className=\"space-y-2\">\n                <Skeleton className=\"h-12 w-full\" />\n                <Skeleton className=\"h-12 w-full\" />\n              </div>\n            ) : !recipients?.length ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Users className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                <p>Nenhum destinatário cadastrado</p>\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Nome</TableHead>\n                    <TableHead>Email</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Ações</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {recipients.map((recipient) => (\n                    <TableRow key={recipient.id} data-testid={`row-recipient-${recipient.id}`}>\n                      <TableCell className=\"font-medium\">{recipient.name}</TableCell>\n                      <TableCell>{recipient.email}</TableCell>\n                      <TableCell>\n                        {recipient.isActive ? (\n                          <Badge variant=\"default\" className=\"bg-green-600\">Ativo</Badge>\n                        ) : (\n                          <Badge variant=\"outline\">Inativo</Badge>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {isAdmin && (\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => deleteRecipientMutation.mutate(recipient.id)}\n                            disabled={deleteRecipientMutation.isPending}\n                            title=\"Remover\"\n                            data-testid={`button-delete-recipient-${recipient.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      <Dialog open={showTemplateDialog} onOpenChange={setShowTemplateDialog}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>{editingTemplate ? \"Editar Template\" : \"Novo Template de Relatório\"}</DialogTitle>\n            <DialogDescription>Configure o modelo de relatório que será gerado</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"template-name\">Nome</Label>\n              <Input\n                id=\"template-name\"\n                value={templateForm.name}\n                onChange={(e) => setTemplateForm(f => ({ ...f, name: e.target.value }))}\n                placeholder=\"Ex: Candidatos SP 2022\"\n                data-testid=\"input-template-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"template-description\">Descrição</Label>\n              <Textarea\n                id=\"template-description\"\n                value={templateForm.description}\n                onChange={(e) => setTemplateForm(f => ({ ...f, description: e.target.value }))}\n                placeholder=\"Descrição opcional do relatório\"\n                data-testid=\"input-template-description\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Tipo de Relatório</Label>\n              <Select\n                value={templateForm.reportType}\n                onValueChange={(v) => setTemplateForm(f => ({ ...f, reportType: v }))}\n              >\n                <SelectTrigger data-testid=\"select-report-type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {REPORT_TYPES.map((type) => (\n                    <SelectItem key={type.value} value={type.value}>\n                      <div>\n                        <p>{type.label}</p>\n                        <p className=\"text-xs text-muted-foreground\">{type.description}</p>\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Ano</Label>\n                <Select\n                  value={templateForm.filters.year || \"all\"}\n                  onValueChange={(v) => setTemplateForm(f => ({ \n                    ...f, \n                    filters: { ...f.filters, year: v === \"all\" ? undefined : v } \n                  }))}\n                >\n                  <SelectTrigger data-testid=\"select-filter-year\">\n                    <SelectValue placeholder=\"Todos\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos</SelectItem>\n                    {years?.map((year) => (\n                      <SelectItem key={year} value={String(year)}>{year}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Estado</Label>\n                <Select\n                  value={templateForm.filters.state || \"all\"}\n                  onValueChange={(v) => setTemplateForm(f => ({ \n                    ...f, \n                    filters: { ...f.filters, state: v === \"all\" ? undefined : v } \n                  }))}\n                >\n                  <SelectTrigger data-testid=\"select-filter-state\">\n                    <SelectValue placeholder=\"Todos\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos</SelectItem>\n                    {states?.map((state) => (\n                      <SelectItem key={state} value={state}>{state}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Switch\n                id=\"template-active\"\n                checked={templateForm.isActive}\n                onCheckedChange={(c) => setTemplateForm(f => ({ ...f, isActive: c }))}\n              />\n              <Label htmlFor=\"template-active\">Template ativo</Label>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowTemplateDialog(false)}>Cancelar</Button>\n            <Button\n              onClick={handleSaveTemplate}\n              disabled={createTemplateMutation.isPending || updateTemplateMutation.isPending}\n              data-testid=\"button-save-template\"\n            >\n              {(createTemplateMutation.isPending || updateTemplateMutation.isPending) && (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              )}\n              {editingTemplate ? \"Salvar\" : \"Criar\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showScheduleDialog} onOpenChange={setShowScheduleDialog}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>{editingSchedule ? \"Editar Agendamento\" : \"Novo Agendamento\"}</DialogTitle>\n            <DialogDescription>Configure quando o relatório deve ser gerado</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"schedule-name\">Nome</Label>\n              <Input\n                id=\"schedule-name\"\n                value={scheduleForm.name}\n                onChange={(e) => setScheduleForm(f => ({ ...f, name: e.target.value }))}\n                placeholder=\"Ex: Relatório semanal SP\"\n                data-testid=\"input-schedule-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Template</Label>\n              <Select\n                value={String(scheduleForm.templateId) || \"0\"}\n                onValueChange={(v) => setScheduleForm(f => ({ ...f, templateId: parseInt(v) }))}\n              >\n                <SelectTrigger data-testid=\"select-schedule-template\">\n                  <SelectValue placeholder=\"Selecione um template\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {templates?.filter(t => t.isActive).map((template) => (\n                    <SelectItem key={template.id} value={String(template.id)}>\n                      {template.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Frequência</Label>\n                <Select\n                  value={scheduleForm.frequency}\n                  onValueChange={(v) => setScheduleForm(f => ({ ...f, frequency: v }))}\n                >\n                  <SelectTrigger data-testid=\"select-frequency\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {FREQUENCIES.map((freq) => (\n                      <SelectItem key={freq.value} value={freq.value}>{freq.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Horário</Label>\n                <Input\n                  type=\"time\"\n                  value={scheduleForm.timeOfDay}\n                  onChange={(e) => setScheduleForm(f => ({ ...f, timeOfDay: e.target.value }))}\n                  data-testid=\"input-time\"\n                />\n              </div>\n            </div>\n            {scheduleForm.frequency === \"weekly\" && (\n              <div className=\"space-y-2\">\n                <Label>Dia da Semana</Label>\n                <Select\n                  value={String(scheduleForm.dayOfWeek)}\n                  onValueChange={(v) => setScheduleForm(f => ({ ...f, dayOfWeek: parseInt(v) }))}\n                >\n                  <SelectTrigger data-testid=\"select-day-of-week\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {DAYS_OF_WEEK.map((day) => (\n                      <SelectItem key={day.value} value={String(day.value)}>{day.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            )}\n            {scheduleForm.frequency === \"monthly\" && (\n              <div className=\"space-y-2\">\n                <Label>Dia do Mês</Label>\n                <Input\n                  type=\"number\"\n                  min={1}\n                  max={28}\n                  value={scheduleForm.dayOfMonth}\n                  onChange={(e) => setScheduleForm(f => ({ ...f, dayOfMonth: parseInt(e.target.value) }))}\n                  data-testid=\"input-day-of-month\"\n                />\n              </div>\n            )}\n            <div className=\"flex items-center gap-2\">\n              <Switch\n                id=\"schedule-active\"\n                checked={scheduleForm.isActive}\n                onCheckedChange={(c) => setScheduleForm(f => ({ ...f, isActive: c }))}\n              />\n              <Label htmlFor=\"schedule-active\">Agendamento ativo</Label>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowScheduleDialog(false)}>Cancelar</Button>\n            <Button\n              onClick={handleSaveSchedule}\n              disabled={createScheduleMutation.isPending || updateScheduleMutation.isPending}\n              data-testid=\"button-save-schedule\"\n            >\n              {(createScheduleMutation.isPending || updateScheduleMutation.isPending) && (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              )}\n              {editingSchedule ? \"Salvar\" : \"Criar\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showRecipientDialog} onOpenChange={setShowRecipientDialog}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Novo Destinatário</DialogTitle>\n            <DialogDescription>Adicione um email para receber relatórios</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"recipient-name\">Nome</Label>\n              <Input\n                id=\"recipient-name\"\n                value={recipientForm.name}\n                onChange={(e) => setRecipientForm(f => ({ ...f, name: e.target.value }))}\n                placeholder=\"Nome do destinatário\"\n                data-testid=\"input-recipient-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"recipient-email\">Email</Label>\n              <Input\n                id=\"recipient-email\"\n                type=\"email\"\n                value={recipientForm.email}\n                onChange={(e) => setRecipientForm(f => ({ ...f, email: e.target.value }))}\n                placeholder=\"email@exemplo.com\"\n                data-testid=\"input-recipient-email\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowRecipientDialog(false)}>Cancelar</Button>\n            <Button\n              onClick={handleSaveRecipient}\n              disabled={createRecipientMutation.isPending}\n              data-testid=\"button-save-recipient\"\n            >\n              {createRecipientMutation.isPending && (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              )}\n              Adicionar\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":43884,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/page-header.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { ChevronRight } from \"lucide-react\";\nimport { Link } from \"wouter\";\n\ninterface Breadcrumb {\n  label: string;\n  href?: string;\n}\n\ninterface PageHeaderProps {\n  title: string;\n  description?: string;\n  breadcrumbs?: Breadcrumb[];\n  action?: {\n    label: string;\n    onClick: () => void;\n    icon?: React.ReactNode;\n  };\n}\n\nexport function PageHeader({ title, description, breadcrumbs, action }: PageHeaderProps) {\n  return (\n    <div className=\"flex flex-col gap-4 pb-6 border-b mb-6\">\n      {breadcrumbs && breadcrumbs.length > 0 && (\n        <nav className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n          {breadcrumbs.map((crumb, i) => (\n            <div key={i} className=\"flex items-center gap-1\">\n              {i > 0 && <ChevronRight className=\"h-4 w-4\" />}\n              {crumb.href ? (\n                <Link href={crumb.href} className=\"hover:text-foreground transition-colors\">\n                  {crumb.label}\n                </Link>\n              ) : (\n                <span className=\"text-foreground font-medium\">{crumb.label}</span>\n              )}\n            </div>\n          ))}\n        </nav>\n      )}\n      <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-3xl font-bold tracking-tight\">{title}</h1>\n          {description && (\n            <p className=\"text-muted-foreground mt-1\">{description}</p>\n          )}\n        </div>\n        {action && (\n          <Button onClick={action.onClick} data-testid=\"button-page-action\">\n            {action.icon}\n            {action.label}\n          </Button>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1695,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Settings as SettingsIcon, User, Lock, Palette, Save } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useTheme } from \"@/lib/theme-provider\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nexport default function Settings() {\n  const { user } = useAuth();\n  const { theme } = useTheme();\n  const { toast } = useToast();\n\n  const [profileData, setProfileData] = useState({\n    name: user?.name || \"\",\n    email: user?.email || \"\",\n  });\n\n  const [passwordData, setPasswordData] = useState({\n    currentPassword: \"\",\n    newPassword: \"\",\n    confirmPassword: \"\",\n  });\n\n  const updateProfileMutation = useMutation({\n    mutationFn: async (data: { name: string; email: string }) => {\n      return apiRequest(\"PATCH\", \"/api/auth/profile\", data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Perfil atualizado com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar perfil\", variant: \"destructive\" });\n    },\n  });\n\n  const changePasswordMutation = useMutation({\n    mutationFn: async (data: { currentPassword: string; newPassword: string }) => {\n      return apiRequest(\"POST\", \"/api/auth/change-password\", data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Sucesso\", description: \"Senha alterada com sucesso\" });\n      setPasswordData({ currentPassword: \"\", newPassword: \"\", confirmPassword: \"\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao alterar senha. Verifique a senha atual.\", variant: \"destructive\" });\n    },\n  });\n\n  function handleProfileSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    updateProfileMutation.mutate(profileData);\n  }\n\n  function handlePasswordSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    if (passwordData.newPassword !== passwordData.confirmPassword) {\n      toast({ title: \"Erro\", description: \"As senhas não coincidem\", variant: \"destructive\" });\n      return;\n    }\n    if (passwordData.newPassword.length < 6) {\n      toast({ title: \"Erro\", description: \"A nova senha deve ter pelo menos 6 caracteres\", variant: \"destructive\" });\n      return;\n    }\n    changePasswordMutation.mutate({\n      currentPassword: passwordData.currentPassword,\n      newPassword: passwordData.newPassword,\n    });\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <PageHeader\n        title=\"Configurações\"\n        description=\"Gerencie seu perfil e preferências do sistema\"\n        breadcrumbs={[\n          { label: \"Dashboard\", href: \"/\" },\n          { label: \"Configurações\" },\n        ]}\n      />\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <User className=\"h-5 w-5\" />\n              Perfil\n            </CardTitle>\n            <CardDescription>Atualize suas informações pessoais</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <form onSubmit={handleProfileSubmit} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"username\">Usuário</Label>\n                <Input\n                  id=\"username\"\n                  value={user?.username || \"\"}\n                  disabled\n                  className=\"bg-muted\"\n                />\n                <p className=\"text-xs text-muted-foreground\">O nome de usuário não pode ser alterado</p>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"name\">Nome Completo</Label>\n                <Input\n                  id=\"name\"\n                  value={profileData.name}\n                  onChange={(e) => setProfileData((p) => ({ ...p, name: e.target.value }))}\n                  required\n                  data-testid=\"input-settings-name\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\">Email</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  value={profileData.email}\n                  onChange={(e) => setProfileData((p) => ({ ...p, email: e.target.value }))}\n                  required\n                  data-testid=\"input-settings-email\"\n                />\n              </div>\n              <Button\n                type=\"submit\"\n                disabled={updateProfileMutation.isPending}\n                data-testid=\"button-save-profile\"\n              >\n                <Save className=\"h-4 w-4 mr-2\" />\n                Salvar Alterações\n              </Button>\n            </form>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Lock className=\"h-5 w-5\" />\n              Segurança\n            </CardTitle>\n            <CardDescription>Altere sua senha de acesso</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <form onSubmit={handlePasswordSubmit} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"currentPassword\">Senha Atual</Label>\n                <Input\n                  id=\"currentPassword\"\n                  type=\"password\"\n                  value={passwordData.currentPassword}\n                  onChange={(e) => setPasswordData((p) => ({ ...p, currentPassword: e.target.value }))}\n                  required\n                  data-testid=\"input-current-password\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"newPassword\">Nova Senha</Label>\n                <Input\n                  id=\"newPassword\"\n                  type=\"password\"\n                  placeholder=\"Mínimo 6 caracteres\"\n                  value={passwordData.newPassword}\n                  onChange={(e) => setPasswordData((p) => ({ ...p, newPassword: e.target.value }))}\n                  required\n                  minLength={6}\n                  data-testid=\"input-new-password\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"confirmPassword\">Confirmar Nova Senha</Label>\n                <Input\n                  id=\"confirmPassword\"\n                  type=\"password\"\n                  value={passwordData.confirmPassword}\n                  onChange={(e) => setPasswordData((p) => ({ ...p, confirmPassword: e.target.value }))}\n                  required\n                  data-testid=\"input-confirm-password\"\n                />\n              </div>\n              <Button\n                type=\"submit\"\n                disabled={changePasswordMutation.isPending}\n                data-testid=\"button-change-password\"\n              >\n                Alterar Senha\n              </Button>\n            </form>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Palette className=\"h-5 w-5\" />\n            Aparência\n          </CardTitle>\n          <CardDescription>Personalize a interface do sistema</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h4 className=\"font-medium\">Tema</h4>\n              <p className=\"text-sm text-muted-foreground\">\n                Escolha entre tema claro ou escuro\n              </p>\n            </div>\n            <div className=\"flex items-center gap-3\">\n              <span className=\"text-sm text-muted-foreground capitalize\">{theme}</span>\n              <ThemeToggle />\n            </div>\n          </div>\n          <Separator className=\"my-4\" />\n          <div className=\"space-y-3\">\n            <h4 className=\"font-medium\">Informações do Sistema</h4>\n            <div className=\"grid grid-cols-2 gap-4 text-sm\">\n              <div>\n                <span className=\"text-muted-foreground\">Versão:</span>\n                <span className=\"ml-2 font-mono\">1.0.0</span>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground\">Sua função:</span>\n                <span className=\"ml-2 capitalize\">{user?.role}</span>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":8897,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"server/report-executor.ts":{"content":"import { storage } from \"./storage\";\nimport type { ReportTemplate } from \"@shared/schema\";\n\nexport async function executeReportRun(runId: number, template: ReportTemplate, recipients: string[]): Promise<void> {\n  const startTime = Date.now();\n  \n  try {\n    await storage.updateReportRun(runId, { status: \"running\", startedAt: new Date() });\n    \n    const filters = template.filters as Record<string, any> || {};\n    let data: any[] = [];\n    let filename = `report_${template.reportType}_${Date.now()}`;\n    \n    switch (template.reportType) {\n      case \"candidates\": {\n        const result = await storage.getAdvancedAnalytics({\n          year: filters.year,\n          uf: filters.state || filters.uf,\n          electionType: filters.electionType,\n          position: filters.position,\n          party: filters.party,\n          limit: 10000,\n        });\n        data = result.candidates || [];\n        filename = `candidatos_${filters.year || \"todos\"}_${filters.uf || \"brasil\"}`;\n        break;\n      }\n      case \"parties\":\n        data = await storage.getVotesByParty({\n          year: filters.year,\n          uf: filters.state || filters.uf,\n          electionType: filters.electionType,\n        });\n        filename = `partidos_${filters.year || \"todos\"}_${filters.uf || \"brasil\"}`;\n        break;\n      case \"voting_details\": {\n        const result = await storage.getAdvancedAnalytics({\n          year: filters.year,\n          uf: filters.state || filters.uf,\n          electionType: filters.electionType,\n          position: filters.position,\n          limit: 50000,\n        });\n        data = result.candidates || [];\n        filename = `detalhes_votacao_${filters.year || \"todos\"}`;\n        break;\n      }\n      case \"summary\":\n        const summary = await storage.getAnalyticsSummary({\n          year: filters.year,\n          uf: filters.state || filters.uf,\n        });\n        data = [summary];\n        filename = `resumo_${filters.year || \"todos\"}`;\n        break;\n    }\n\n    const csvContent = generateCsvFromData(data, template.columns as string[] | undefined);\n    const filePath = `/tmp/${filename}.csv`;\n    const fs = await import(\"fs/promises\");\n    await fs.writeFile(filePath, csvContent);\n    const fileStats = await fs.stat(filePath);\n    \n    let emailsSent = 0;\n    const allRecipients = recipients.length > 0 ? recipients : [];\n    \n    if (allRecipients.length > 0 && process.env.RESEND_API_KEY) {\n      emailsSent = await sendReportEmail(\n        allRecipients,\n        template.name,\n        `Relatório gerado automaticamente: ${template.name}`,\n        filePath,\n        filename + \".csv\"\n      );\n    }\n\n    const executionTime = Date.now() - startTime;\n    \n    await storage.updateReportRun(runId, {\n      status: \"completed\",\n      completedAt: new Date(),\n      rowCount: data.length,\n      fileSize: fileStats.size,\n      filePath,\n      recipients: allRecipients as any,\n      emailsSent,\n      executionTimeMs: executionTime,\n    });\n    \n    console.log(`Report run ${runId} completed: ${data.length} rows, ${executionTime}ms`);\n    \n  } catch (error: any) {\n    const executionTime = Date.now() - startTime;\n    await storage.updateReportRun(runId, {\n      status: \"failed\",\n      completedAt: new Date(),\n      errorMessage: error.message || \"Unknown error\",\n      executionTimeMs: executionTime,\n    });\n    console.error(`Report run ${runId} failed:`, error.message);\n    throw error;\n  }\n}\n\nfunction generateCsvFromData(data: any[], columns?: string[]): string {\n  if (!data || data.length === 0) return \"\";\n  \n  const keys = columns || Object.keys(data[0]);\n  const header = keys.join(\",\");\n  const rows = data.map(row => \n    keys.map(key => {\n      const value = row[key];\n      if (value === null || value === undefined) return \"\";\n      const str = String(value);\n      return str.includes(\",\") || str.includes('\"') || str.includes(\"\\n\") \n        ? `\"${str.replace(/\"/g, '\"\"')}\"` \n        : str;\n    }).join(\",\")\n  );\n  \n  return \"\\uFEFF\" + [header, ...rows].join(\"\\n\");\n}\n\nasync function sendReportEmail(\n  recipients: string[],\n  reportName: string,\n  body: string,\n  filePath: string,\n  fileName: string\n): Promise<number> {\n  const apiKey = process.env.RESEND_API_KEY;\n  if (!apiKey) {\n    console.log(\"RESEND_API_KEY not configured, skipping email\");\n    return 0;\n  }\n\n  try {\n    const fs = await import(\"fs/promises\");\n    const fileContent = await fs.readFile(filePath);\n    const base64Content = fileContent.toString(\"base64\");\n\n    const response = await fetch(\"https://api.resend.com/emails\", {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${apiKey}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        from: \"SimulaVoto <noreply@simulavoto.app>\",\n        to: recipients,\n        subject: `[SimulaVoto] ${reportName}`,\n        html: `\n          <h2>Relatório: ${reportName}</h2>\n          <p>${body}</p>\n          <p>O relatório está anexado a este email.</p>\n          <hr>\n          <p><small>Gerado automaticamente por SimulaVoto em ${new Date().toLocaleString(\"pt-BR\")}</small></p>\n        `,\n        attachments: [{\n          filename: fileName,\n          content: base64Content,\n        }],\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(\"Resend API error:\", errorText);\n      return 0;\n    }\n\n    return recipients.length;\n  } catch (error) {\n    console.error(\"Error sending email:\", error);\n    return 0;\n  }\n}\n","path":null,"size_bytes":5520,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"server/ai-insights.ts":{"content":"import OpenAI from \"openai\";\nimport { z } from \"zod\";\nimport { storage } from \"./storage\";\n\nconst openai = new OpenAI();\n\n// Zod schema for AI projection report response validation\nconst aiProjectionResponseSchema = z.object({\n  executiveSummary: z.string().optional().default(\"Análise não disponível.\"),\n  methodology: z.string().optional().default(\"Análise baseada em dados históricos.\"),\n  turnoutProjection: z.object({\n    expected: z.number().min(0).max(100).optional().default(75),\n    confidence: z.number().min(0).max(1).optional().default(0.5),\n    marginOfError: z.object({\n      lower: z.number().optional().default(70),\n      upper: z.number().optional().default(80)\n    }).optional().default({ lower: 70, upper: 80 }),\n    historicalBasis: z.array(z.object({\n      year: z.number(),\n      turnout: z.number()\n    })).optional().default([]),\n    factors: z.array(z.object({\n      factor: z.string(),\n      impact: z.number(),\n      description: z.string()\n    })).optional().default([])\n  }).optional().default({\n    expected: 75,\n    confidence: 0.5,\n    marginOfError: { lower: 70, upper: 80 },\n    historicalBasis: [],\n    factors: []\n  }),\n  partyProjections: z.array(z.object({\n    party: z.string(),\n    abbreviation: z.string(),\n    voteShare: z.object({\n      expected: z.number(),\n      min: z.number(),\n      max: z.number()\n    }),\n    seats: z.object({\n      expected: z.number(),\n      min: z.number(),\n      max: z.number()\n    }),\n    trend: z.enum([\"growing\", \"declining\", \"stable\"]).optional().default(\"stable\"),\n    confidence: z.number().min(0).max(1).optional().default(0.7),\n    marginOfError: z.number().optional().default(3)\n  })).optional().default([]),\n  candidateProjections: z.array(z.object({\n    name: z.string(),\n    party: z.string(),\n    position: z.string().optional().default(\"\"),\n    electionProbability: z.number().min(0).max(1),\n    projectedVotes: z.object({\n      expected: z.number(),\n      min: z.number(),\n      max: z.number()\n    }).optional().default({ expected: 0, min: 0, max: 0 }),\n    confidence: z.number().min(0).max(1).optional().default(0.7),\n    ranking: z.number().optional().default(0)\n  })).optional().default([]),\n  scenarios: z.array(z.object({\n    name: z.string(),\n    description: z.string(),\n    probability: z.number().min(0).max(1),\n    outcomes: z.array(z.object({\n      party: z.string(),\n      seats: z.number(),\n      voteShare: z.number()\n    })).optional().default([])\n  })).optional().default([]),\n  riskAssessment: z.object({\n    overallRisk: z.enum([\"low\", \"medium\", \"high\"]).optional().default(\"medium\"),\n    risks: z.array(z.object({\n      risk: z.string(),\n      probability: z.number().min(0).max(1),\n      impact: z.enum([\"low\", \"medium\", \"high\"]).optional().default(\"medium\"),\n      category: z.enum([\"political\", \"economic\", \"social\", \"technical\"]).optional().default(\"political\"),\n      mitigation: z.string().optional().default(\"\")\n    })).optional().default([])\n  }).optional().default({ overallRisk: \"medium\", risks: [] }),\n  confidenceIntervals: z.object({\n    overall: z.number().min(0).max(1).optional().default(0.7),\n    turnout: z.number().min(0).max(1).optional().default(0.75),\n    partyResults: z.number().min(0).max(1).optional().default(0.7),\n    seatDistribution: z.number().min(0).max(1).optional().default(0.65)\n  }).optional().default({ overall: 0.7, turnout: 0.75, partyResults: 0.7, seatDistribution: 0.65 }),\n  recommendations: z.array(z.string()).optional().default([])\n});\n\n// Comprehensive Projection Report Interface\nexport interface ProjectionReport {\n  id?: number;\n  name: string;\n  targetYear: number;\n  electionType: string;\n  scope: \"national\" | \"state\";\n  state?: string;\n  \n  // Executive Summary\n  executiveSummary: string;\n  methodology: string;\n  dataQuality: {\n    completeness: number;\n    yearsAnalyzed: number;\n    totalRecordsAnalyzed: number;\n    lastUpdated: string;\n  };\n  \n  // Turnout Projections\n  turnoutProjection: {\n    expected: number;\n    confidence: number;\n    marginOfError: { lower: number; upper: number };\n    historicalBasis: { year: number; turnout: number }[];\n    factors: { factor: string; impact: number; description: string }[];\n  };\n  \n  // Party Projections\n  partyProjections: {\n    party: string;\n    abbreviation: string;\n    voteShare: { expected: number; min: number; max: number };\n    seats: { expected: number; min: number; max: number };\n    trend: \"growing\" | \"declining\" | \"stable\";\n    confidence: number;\n    marginOfError: number;\n  }[];\n  \n  // Candidate Projections (top candidates)\n  candidateProjections: {\n    name: string;\n    party: string;\n    position: string;\n    electionProbability: number;\n    projectedVotes: { expected: number; min: number; max: number };\n    confidence: number;\n    ranking: number;\n  }[];\n  \n  // Scenario Analysis\n  scenarios: {\n    name: string;\n    description: string;\n    probability: number;\n    outcomes: {\n      party: string;\n      seats: number;\n      voteShare: number;\n    }[];\n  }[];\n  \n  // Risk Assessment\n  riskAssessment: {\n    overallRisk: \"low\" | \"medium\" | \"high\";\n    risks: {\n      risk: string;\n      probability: number;\n      impact: \"low\" | \"medium\" | \"high\";\n      category: \"political\" | \"economic\" | \"social\" | \"technical\";\n      mitigation: string;\n    }[];\n  };\n  \n  // Confidence Intervals\n  confidenceIntervals: {\n    overall: number;\n    turnout: number;\n    partyResults: number;\n    seatDistribution: number;\n  };\n  \n  // Recommendations\n  recommendations: string[];\n  \n  // Metadata\n  generatedAt: string;\n  validUntil: string;\n  version: string;\n}\n\nexport interface TurnoutPrediction {\n  predictedTurnout: number;\n  confidence: number;\n  factors: {\n    factor: string;\n    impact: \"positive\" | \"negative\" | \"neutral\";\n    weight: number;\n    description: string;\n  }[];\n  historicalComparison: {\n    year: number;\n    turnout: number;\n    trend: \"up\" | \"down\" | \"stable\";\n  }[];\n  recommendations: string[];\n  methodology: string;\n  generatedAt: string;\n}\n\nexport interface CandidateSuccessPrediction {\n  candidateName: string;\n  candidateNumber: number;\n  party: string;\n  position: string;\n  successProbability: number;\n  confidence: number;\n  ranking: number;\n  factors: {\n    factor: string;\n    impact: \"positive\" | \"negative\" | \"neutral\";\n    weight: number;\n    value: string;\n  }[];\n  similarCandidates: {\n    name: string;\n    year: number;\n    votes: number;\n    result: string;\n    similarity: number;\n  }[];\n  projectedVotes: {\n    min: number;\n    expected: number;\n    max: number;\n  };\n  recommendation: string;\n  generatedAt: string;\n}\n\nexport interface PartyPerformancePrediction {\n  party: string;\n  predictedVoteShare: number;\n  predictedSeats: { min: number; expected: number; max: number };\n  confidence: number;\n  trend: \"growing\" | \"declining\" | \"stable\";\n  trendStrength: number;\n  historicalPerformance: {\n    year: number;\n    votes: number;\n    voteShare: number;\n    seats: number;\n  }[];\n  keyFactors: string[];\n  risks: string[];\n  opportunities: string[];\n  generatedAt: string;\n}\n\nexport interface SentimentAnalysis {\n  overallSentiment: \"positive\" | \"negative\" | \"neutral\" | \"mixed\";\n  sentimentScore: number;\n  confidence: number;\n  topics: {\n    topic: string;\n    sentiment: \"positive\" | \"negative\" | \"neutral\";\n    frequency: number;\n    examples: string[];\n  }[];\n  parties: {\n    party: string;\n    sentiment: \"positive\" | \"negative\" | \"neutral\";\n    mentionCount: number;\n    sentimentScore: number;\n  }[];\n  trends: {\n    period: string;\n    sentiment: number;\n    volume: number;\n  }[];\n  summary: string;\n  generatedAt: string;\n}\n\nexport interface ElectoralInsights {\n  summary: string;\n  keyFindings: {\n    finding: string;\n    importance: \"high\" | \"medium\" | \"low\";\n    category: \"trend\" | \"anomaly\" | \"pattern\" | \"prediction\";\n  }[];\n  riskFactors: {\n    risk: string;\n    probability: number;\n    impact: \"high\" | \"medium\" | \"low\";\n    mitigation: string;\n  }[];\n  recommendations: string[];\n  dataQuality: {\n    completeness: number;\n    yearsAnalyzed: number;\n    candidatesAnalyzed: number;\n    partiesAnalyzed: number;\n  };\n  generatedAt: string;\n}\n\nexport async function predictVoterTurnout(filters: {\n  year?: number;\n  uf?: string;\n  electionType?: string;\n  targetYear?: number;\n}): Promise<TurnoutPrediction> {\n  const availableYears = await storage.getAvailableElectionYears();\n  \n  const historicalData: { year: number; totalVotes: number; candidates: number }[] = [];\n  for (const year of availableYears.slice(0, 6)) {\n    const summary = await storage.getAnalyticsSummary({ \n      year, \n      uf: filters.uf,\n      electionType: filters.electionType \n    });\n    historicalData.push({\n      year,\n      totalVotes: summary.totalVotes || 0,\n      candidates: summary.totalCandidates || 0\n    });\n  }\n\n  const votesByState = filters.uf ? [] : await storage.getVotesByState({ year: availableYears[0] });\n\n  const prompt = `Você é um especialista em análise eleitoral brasileira e previsão de comparecimento eleitoral.\n\nDADOS HISTÓRICOS DE VOTAÇÃO:\n${historicalData.map(d => `Ano ${d.year}: ${d.totalVotes.toLocaleString(\"pt-BR\")} votos totais, ${d.candidates} candidatos`).join(\"\\n\")}\n\nFiltros aplicados: UF=${filters.uf || \"Nacional\"}, Tipo=${filters.electionType || \"Todos\"}\nAnos disponíveis: ${availableYears.join(\", \")}\nAno alvo para previsão: ${filters.targetYear || availableYears[0] + 4}\n\n${votesByState.length > 0 ? `DISTRIBUIÇÃO POR ESTADO (último ano):\n${votesByState.slice(0, 10).map(s => `${s.state}: ${s.votes.toLocaleString(\"pt-BR\")} votos`).join(\"\\n\")}` : \"\"}\n\nAnalise os padrões históricos e forneça uma previsão de comparecimento eleitoral.\n\nResponda em JSON com a estrutura exata:\n{\n  \"predictedTurnout\": número_percentual_0_a_100,\n  \"confidence\": número_0_a_1,\n  \"factors\": [\n    {\n      \"factor\": \"nome do fator\",\n      \"impact\": \"positive\" | \"negative\" | \"neutral\",\n      \"weight\": número_0_a_1,\n      \"description\": \"descrição do impacto\"\n    }\n  ],\n  \"historicalComparison\": [\n    {\n      \"year\": ano,\n      \"turnout\": percentual,\n      \"trend\": \"up\" | \"down\" | \"stable\"\n    }\n  ],\n  \"recommendations\": [\"recomendação 1\", \"recomendação 2\"],\n  \"methodology\": \"breve descrição da metodologia usada\"\n}`;\n\n  const completion = await openai.chat.completions.create({\n    model: \"gpt-4o\",\n    messages: [{ role: \"user\", content: prompt }],\n    response_format: { type: \"json_object\" },\n  });\n\n  const content = completion.choices[0]?.message?.content;\n  if (!content) {\n    throw new Error(\"No response from AI\");\n  }\n\n  const prediction = JSON.parse(content);\n  prediction.generatedAt = new Date().toISOString();\n  \n  return prediction as TurnoutPrediction;\n}\n\nexport async function predictCandidateSuccess(filters: {\n  candidateNumber?: number;\n  candidateName?: string;\n  party?: string;\n  year?: number;\n  uf?: string;\n  electionType?: string;\n}): Promise<CandidateSuccessPrediction[]> {\n  const allCandidates = await storage.getTopCandidates({\n    year: filters.year,\n    uf: filters.uf,\n    electionType: filters.electionType,\n    limit: 200\n  });\n\n  const topCandidates = filters.party \n    ? allCandidates.filter(c => c.party === filters.party)\n    : allCandidates;\n\n  if (topCandidates.length === 0) {\n    throw new Error(\"No candidate data available for the specified filters\");\n  }\n\n  const votesByParty = await storage.getVotesByParty({\n    year: filters.year,\n    uf: filters.uf,\n    electionType: filters.electionType,\n    limit: 20\n  });\n\n  const availableYears = await storage.getAvailableElectionYears();\n  \n  const historicalPartyData: Record<string, { year: number; votes: number }[]> = {};\n  for (const year of availableYears.slice(0, 4)) {\n    const partyData = await storage.getVotesByParty({ \n      year, \n      uf: filters.uf, \n      electionType: filters.electionType,\n      limit: 30 \n    });\n    for (const p of partyData) {\n      if (!historicalPartyData[p.party]) {\n        historicalPartyData[p.party] = [];\n      }\n      historicalPartyData[p.party].push({ year, votes: p.votes });\n    }\n  }\n\n  const candidatesToAnalyze = filters.candidateNumber || filters.candidateName\n    ? topCandidates.filter(c => \n        (filters.candidateNumber && c.number === filters.candidateNumber) ||\n        (filters.candidateName && c.name.toLowerCase().includes(filters.candidateName.toLowerCase()))\n      ).slice(0, 10)\n    : topCandidates.slice(0, 20);\n\n  const prompt = `Você é um especialista em análise eleitoral brasileira.\nAnalise os seguintes candidatos e preveja suas chances de sucesso eleitoral.\n\nCANDIDATOS A ANALISAR:\n${candidatesToAnalyze.map((c, i) => `${i + 1}. ${c.name} (${c.party || \"Partido N/D\"}) - Número: ${c.number || \"N/D\"}, Votos históricos: ${c.votes.toLocaleString(\"pt-BR\")}, Cargo: ${c.position || filters.electionType || \"N/D\"}`).join(\"\\n\")}\n\nDESEMPENHO DOS PARTIDOS:\n${votesByParty.slice(0, 15).map(p => `${p.party}: ${p.votes.toLocaleString(\"pt-BR\")} votos (${p.candidateCount} candidatos)`).join(\"\\n\")}\n\nTENDÊNCIAS HISTÓRICAS POR PARTIDO:\n${Object.entries(historicalPartyData).slice(0, 10).map(([party, data]) => \n  `${party}: ${data.map(d => `${d.year}: ${d.votes.toLocaleString(\"pt-BR\")}`).join(\" → \")}`\n).join(\"\\n\")}\n\nFiltros: UF=${filters.uf || \"Nacional\"}, Ano=${filters.year || \"Mais recente\"}\n\nPara cada candidato, forneça uma análise de probabilidade de sucesso.\n\nResponda em JSON com a estrutura:\n{\n  \"predictions\": [\n    {\n      \"candidateName\": \"nome\",\n      \"candidateNumber\": número,\n      \"party\": \"sigla\",\n      \"position\": \"cargo\",\n      \"successProbability\": número_0_a_1,\n      \"confidence\": número_0_a_1,\n      \"ranking\": posição_no_ranking,\n      \"factors\": [\n        {\n          \"factor\": \"nome do fator\",\n          \"impact\": \"positive\" | \"negative\" | \"neutral\",\n          \"weight\": número_0_a_1,\n          \"value\": \"valor ou descrição\"\n        }\n      ],\n      \"similarCandidates\": [\n        {\n          \"name\": \"nome do candidato similar\",\n          \"year\": ano,\n          \"votes\": número,\n          \"result\": \"ELEITO\" | \"NÃO ELEITO\",\n          \"similarity\": número_0_a_1\n        }\n      ],\n      \"projectedVotes\": {\n        \"min\": número,\n        \"expected\": número,\n        \"max\": número\n      },\n      \"recommendation\": \"recomendação estratégica\"\n    }\n  ]\n}`;\n\n  const completion = await openai.chat.completions.create({\n    model: \"gpt-4o\",\n    messages: [{ role: \"user\", content: prompt }],\n    response_format: { type: \"json_object\" },\n  });\n\n  const content = completion.choices[0]?.message?.content;\n  if (!content) {\n    throw new Error(\"No response from AI\");\n  }\n\n  const result = JSON.parse(content);\n  const generatedAt = new Date().toISOString();\n  \n  return (result.predictions || []).map((p: any) => ({\n    ...p,\n    generatedAt\n  }));\n}\n\nexport async function predictPartyPerformance(filters: {\n  party?: string;\n  year?: number;\n  uf?: string;\n  electionType?: string;\n  targetYear?: number;\n}): Promise<PartyPerformancePrediction[]> {\n  const availableYears = await storage.getAvailableElectionYears();\n  \n  const historicalData: { year: number; parties: { party: string; votes: number; candidateCount: number }[] }[] = [];\n  for (const year of availableYears.slice(0, 5)) {\n    const partyData = await storage.getVotesByParty({\n      year,\n      uf: filters.uf,\n      electionType: filters.electionType,\n      limit: 25\n    });\n    historicalData.push({ year, parties: partyData });\n  }\n\n  const partiesToAnalyze = filters.party\n    ? historicalData[0]?.parties.filter(p => \n        p.party.toLowerCase().includes(filters.party!.toLowerCase())\n      ).slice(0, 5)\n    : historicalData[0]?.parties.slice(0, 15);\n\n  if (!partiesToAnalyze || partiesToAnalyze.length === 0) {\n    throw new Error(\"No party data available for the specified filters\");\n  }\n\n  const prompt = `Você é um especialista em análise político-eleitoral brasileira.\nAnalise os dados históricos dos partidos e forneça previsões de desempenho.\n\nDADOS HISTÓRICOS POR ANO:\n${historicalData.map(h => `\nANO ${h.year}:\n${h.parties.slice(0, 15).map(p => `  ${p.party}: ${p.votes.toLocaleString(\"pt-BR\")} votos (${p.candidateCount} candidatos)`).join(\"\\n\")}`).join(\"\\n\")}\n\nPARTIDOS A ANALISAR: ${partiesToAnalyze.map(p => p.party).join(\", \")}\nFiltros: UF=${filters.uf || \"Nacional\"}, Tipo=${filters.electionType || \"Todos\"}\nAno alvo para previsão: ${filters.targetYear || (availableYears[0] || 2022) + 4}\n\nAnalise tendências, calcule crescimento/declínio e projete desempenho futuro.\n\nResponda em JSON com a estrutura:\n{\n  \"predictions\": [\n    {\n      \"party\": \"sigla\",\n      \"predictedVoteShare\": número_percentual,\n      \"predictedSeats\": { \"min\": número, \"expected\": número, \"max\": número },\n      \"confidence\": número_0_a_1,\n      \"trend\": \"growing\" | \"declining\" | \"stable\",\n      \"trendStrength\": número_0_a_1,\n      \"historicalPerformance\": [\n        { \"year\": ano, \"votes\": número, \"voteShare\": percentual, \"seats\": número }\n      ],\n      \"keyFactors\": [\"fator 1\", \"fator 2\"],\n      \"risks\": [\"risco 1\", \"risco 2\"],\n      \"opportunities\": [\"oportunidade 1\", \"oportunidade 2\"]\n    }\n  ]\n}`;\n\n  const completion = await openai.chat.completions.create({\n    model: \"gpt-4o\",\n    messages: [{ role: \"user\", content: prompt }],\n    response_format: { type: \"json_object\" },\n  });\n\n  const content = completion.choices[0]?.message?.content;\n  if (!content) {\n    throw new Error(\"No response from AI\");\n  }\n\n  const result = JSON.parse(content);\n  const generatedAt = new Date().toISOString();\n  \n  return (result.predictions || []).map((p: any) => ({\n    ...p,\n    generatedAt\n  }));\n}\n\nexport async function analyzeElectoralSentiment(input: {\n  newsArticles?: { title: string; content: string; date: string; source: string }[];\n  socialPosts?: { text: string; date: string; platform: string }[];\n  party?: string;\n  dateRange?: { start: string; end: string };\n}): Promise<SentimentAnalysis> {\n  const hasContent = (input.newsArticles?.length || 0) > 0 || (input.socialPosts?.length || 0) > 0;\n  \n  if (!hasContent) {\n    const votesByParty = await storage.getVotesByParty({ limit: 10 });\n    \n    return {\n      overallSentiment: \"neutral\",\n      sentimentScore: 0.5,\n      confidence: 0.3,\n      topics: [\n        {\n          topic: \"Dados de votação\",\n          sentiment: \"neutral\",\n          frequency: votesByParty.length,\n          examples: votesByParty.slice(0, 3).map(p => `${p.party}: ${p.votes.toLocaleString(\"pt-BR\")} votos`)\n        }\n      ],\n      parties: votesByParty.slice(0, 5).map(p => ({\n        party: p.party,\n        sentiment: \"neutral\" as const,\n        mentionCount: p.candidateCount,\n        sentimentScore: 0.5\n      })),\n      trends: [],\n      summary: \"Análise de sentimento requer dados externos (notícias, mídias sociais). Atualmente exibindo apenas dados de votação disponíveis. Para habilitar análise de sentimento completa, forneça artigos de notícias ou posts de mídias sociais relacionados à eleição.\",\n      generatedAt: new Date().toISOString()\n    };\n  }\n\n  const contentSummary = [\n    ...(input.newsArticles || []).map(a => `[Notícia - ${a.source}] ${a.title}: ${a.content.substring(0, 200)}`),\n    ...(input.socialPosts || []).map(p => `[${p.platform}] ${p.text.substring(0, 150)}`)\n  ].join(\"\\n\\n\");\n\n  const prompt = `Você é um especialista em análise de sentimento político e eleitoral brasileiro.\nAnalise o conteúdo abaixo e forneça uma análise de sentimento detalhada.\n\nCONTEÚDO PARA ANÁLISE:\n${contentSummary}\n\nFiltros: Partido=${input.party || \"Todos\"}, Período=${input.dateRange ? `${input.dateRange.start} a ${input.dateRange.end}` : \"Não especificado\"}\n\nResponda em JSON com a estrutura:\n{\n  \"overallSentiment\": \"positive\" | \"negative\" | \"neutral\" | \"mixed\",\n  \"sentimentScore\": número_-1_a_1,\n  \"confidence\": número_0_a_1,\n  \"topics\": [\n    {\n      \"topic\": \"nome do tópico\",\n      \"sentiment\": \"positive\" | \"negative\" | \"neutral\",\n      \"frequency\": número,\n      \"examples\": [\"exemplo 1\", \"exemplo 2\"]\n    }\n  ],\n  \"parties\": [\n    {\n      \"party\": \"sigla\",\n      \"sentiment\": \"positive\" | \"negative\" | \"neutral\",\n      \"mentionCount\": número,\n      \"sentimentScore\": número_-1_a_1\n    }\n  ],\n  \"trends\": [\n    {\n      \"period\": \"período\",\n      \"sentiment\": número_-1_a_1,\n      \"volume\": número\n    }\n  ],\n  \"summary\": \"resumo da análise de sentimento\"\n}`;\n\n  const completion = await openai.chat.completions.create({\n    model: \"gpt-4o\",\n    messages: [{ role: \"user\", content: prompt }],\n    response_format: { type: \"json_object\" },\n  });\n\n  const content = completion.choices[0]?.message?.content;\n  if (!content) {\n    throw new Error(\"No response from AI\");\n  }\n\n  const result = JSON.parse(content);\n  result.generatedAt = new Date().toISOString();\n  \n  return result as SentimentAnalysis;\n}\n\n// Advanced GPT-4o sentiment classification for individual articles\nexport async function classifyArticleSentiment(article: {\n  title: string;\n  content: string;\n  source: string;\n}): Promise<{\n  sentimentScore: number;\n  sentimentLabel: \"positive\" | \"negative\" | \"neutral\" | \"mixed\";\n  confidence: number;\n  entities: { type: \"party\" | \"candidate\"; name: string; sentiment: number }[];\n  keywords: { word: string; sentiment: number }[];\n  summary: string;\n}> {\n  const prompt = `Você é um especialista em análise de sentimento político brasileiro.\nAnalise o seguinte artigo e classifique o sentimento geral e por entidade.\n\nARTIGO:\nTítulo: ${article.title}\nFonte: ${article.source}\nConteúdo: ${article.content.substring(0, 1500)}\n\nResponda em JSON:\n{\n  \"sentimentScore\": número_de_-1_a_1,\n  \"sentimentLabel\": \"positive\" | \"negative\" | \"neutral\" | \"mixed\",\n  \"confidence\": número_de_0_a_1,\n  \"entities\": [\n    { \"type\": \"party\" ou \"candidate\", \"name\": \"nome\", \"sentiment\": número_-1_a_1 }\n  ],\n  \"keywords\": [\n    { \"word\": \"palavra-chave\", \"sentiment\": número_-1_a_1 }\n  ],\n  \"summary\": \"resumo de 1-2 frases do sentimento do artigo\"\n}\n\nConsidere:\n- Sentimento positivo > 0.3, negativo < -0.3, neutro entre -0.3 e 0.3\n- Identifique partidos (PT, PL, MDB, PSDB, etc.) e candidatos mencionados\n- Extraia 3-5 palavras-chave relevantes com seus sentimentos`;\n\n  try {\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [{ role: \"user\", content: prompt }],\n      response_format: { type: \"json_object\" },\n      max_tokens: 800,\n    });\n\n    const content = completion.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from AI\");\n    }\n\n    return JSON.parse(content);\n  } catch (error) {\n    console.error(\"Error classifying article sentiment:\", error);\n    return {\n      sentimentScore: 0,\n      sentimentLabel: \"neutral\",\n      confidence: 0.3,\n      entities: [],\n      keywords: [],\n      summary: \"Não foi possível analisar o sentimento.\"\n    };\n  }\n}\n\n// Batch sentiment classification for multiple articles\nexport async function batchClassifySentiment(articles: {\n  id?: number;\n  title: string;\n  content: string;\n  source: string;\n}[]): Promise<{\n  results: {\n    articleId?: number;\n    title: string;\n    sentimentScore: number;\n    sentimentLabel: string;\n    confidence: number;\n    entities: { type: string; name: string; sentiment: number }[];\n  }[];\n  summary: {\n    positive: number;\n    negative: number;\n    neutral: number;\n    mixed: number;\n    avgSentiment: number;\n  };\n}> {\n  const results = [];\n  let positiveCount = 0;\n  let negativeCount = 0;\n  let neutralCount = 0;\n  let mixedCount = 0;\n  let totalScore = 0;\n\n  for (const article of articles.slice(0, 20)) { // Limit to 20 articles per batch\n    const classification = await classifyArticleSentiment(article);\n    \n    results.push({\n      articleId: article.id,\n      title: article.title,\n      sentimentScore: classification.sentimentScore,\n      sentimentLabel: classification.sentimentLabel,\n      confidence: classification.confidence,\n      entities: classification.entities\n    });\n\n    totalScore += classification.sentimentScore;\n    switch (classification.sentimentLabel) {\n      case \"positive\": positiveCount++; break;\n      case \"negative\": negativeCount++; break;\n      case \"neutral\": neutralCount++; break;\n      case \"mixed\": mixedCount++; break;\n    }\n  }\n\n  return {\n    results,\n    summary: {\n      positive: positiveCount,\n      negative: negativeCount,\n      neutral: neutralCount,\n      mixed: mixedCount,\n      avgSentiment: results.length > 0 ? totalScore / results.length : 0\n    }\n  };\n}\n\n// Generate crisis alert if sentiment drops significantly\nexport async function detectCrisisFromSentiment(params: {\n  entityType: string;\n  entityId: string;\n  entityName: string;\n  currentSentiment: number;\n  previousSentiment: number;\n  mentionCount: number;\n  avgMentionCount: number;\n}): Promise<{\n  shouldAlert: boolean;\n  alertType: \"negative_spike\" | \"crisis\" | \"trending_negative\" | \"high_volume\" | null;\n  severity: \"low\" | \"medium\" | \"high\" | \"critical\";\n  title: string;\n  description: string;\n} | null> {\n  const sentimentDrop = params.previousSentiment - params.currentSentiment;\n  const mentionSpike = params.avgMentionCount > 0 \n    ? params.mentionCount / params.avgMentionCount \n    : 1;\n\n  // Crisis detection rules\n  if (params.currentSentiment < -0.5 && sentimentDrop > 0.3) {\n    return {\n      shouldAlert: true,\n      alertType: \"crisis\",\n      severity: \"critical\",\n      title: `Crise de sentimento detectada para ${params.entityName}`,\n      description: `Sentimento caiu ${(sentimentDrop * 100).toFixed(0)}% em período recente, atingindo nível crítico de ${(params.currentSentiment * 100).toFixed(0)}%.`\n    };\n  }\n\n  if (sentimentDrop > 0.4) {\n    return {\n      shouldAlert: true,\n      alertType: \"negative_spike\",\n      severity: \"high\",\n      title: `Pico negativo para ${params.entityName}`,\n      description: `Queda abrupta de ${(sentimentDrop * 100).toFixed(0)}% no sentimento detectada.`\n    };\n  }\n\n  if (params.currentSentiment < -0.3 && mentionSpike > 2) {\n    return {\n      shouldAlert: true,\n      alertType: \"high_volume\",\n      severity: \"high\",\n      title: `Alto volume de menções negativas para ${params.entityName}`,\n      description: `${params.mentionCount} menções (${mentionSpike.toFixed(1)}x acima da média) com sentimento negativo.`\n    };\n  }\n\n  if (params.currentSentiment < -0.2 && sentimentDrop > 0.2) {\n    return {\n      shouldAlert: true,\n      alertType: \"trending_negative\",\n      severity: \"medium\",\n      title: `Tendência negativa para ${params.entityName}`,\n      description: `Sentimento em declínio, atualmente em ${(params.currentSentiment * 100).toFixed(0)}%.`\n    };\n  }\n\n  return null;\n}\n\n// Generate AI narrative for multi-entity comparison\nexport async function generateComparisonNarrative(entities: {\n  name: string;\n  type: string;\n  avgSentiment: number;\n  totalMentions: number;\n  trend: string;\n}[]): Promise<string> {\n  if (entities.length < 2) {\n    return \"Necessário ao menos duas entidades para gerar análise comparativa.\";\n  }\n\n  const entitiesSummary = entities.map(e => \n    `${e.name} (${e.type}): sentimento ${(e.avgSentiment * 100).toFixed(0)}%, ${e.totalMentions} menções, tendência ${e.trend}`\n  ).join(\"\\n\");\n\n  const prompt = `Você é um analista político especializado em eleições brasileiras.\nCompare o sentimento público entre estas entidades políticas:\n\n${entitiesSummary}\n\nGere uma análise comparativa concisa (3-4 frases) destacando:\n1. Qual entidade tem melhor percepção pública\n2. Diferenças significativas entre elas\n3. Tendências observadas\n4. Implicações para o cenário eleitoral\n\nResponda apenas com o texto da análise, sem formatação JSON.`;\n\n  try {\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [{ role: \"user\", content: prompt }],\n      max_tokens: 300,\n    });\n\n    return completion.choices[0]?.message?.content || \"Análise não disponível.\";\n  } catch (error) {\n    console.error(\"Error generating comparison narrative:\", error);\n    return \"Não foi possível gerar análise comparativa.\";\n  }\n}\n\nexport async function generateElectoralInsights(filters: {\n  year?: number;\n  uf?: string;\n  electionType?: string;\n  party?: string;\n}): Promise<ElectoralInsights> {\n  const summary = await storage.getAnalyticsSummary({ year: filters.year, uf: filters.uf, electionType: filters.electionType });\n  const availableYears = await storage.getAvailableElectionYears();\n  const votesByParty = await storage.getVotesByParty({ year: filters.year, uf: filters.uf, electionType: filters.electionType, limit: 20 });\n  const topCandidates = await storage.getTopCandidates({ year: filters.year, uf: filters.uf, electionType: filters.electionType, limit: 30 });\n  \n  const historicalTrends: { year: number; totalVotes: number; parties: number }[] = [];\n  for (const year of availableYears.slice(0, 5)) {\n    const yearSummary = await storage.getAnalyticsSummary({ \n      year, \n      uf: filters.uf, \n      electionType: filters.electionType \n    });\n    const partyData = await storage.getVotesByParty({ year, uf: filters.uf, electionType: filters.electionType, limit: 50 });\n    historicalTrends.push({\n      year,\n      totalVotes: yearSummary.totalVotes || 0,\n      parties: partyData.length\n    });\n  }\n\n  const prompt = `Você é um especialista em análise eleitoral brasileira.\nAnalise os dados eleitorais e gere insights estratégicos abrangentes.\n\nRESUMO DOS DADOS:\n- Total de Votos: ${summary.totalVotes?.toLocaleString(\"pt-BR\") || \"N/D\"}\n- Total de Candidatos: ${summary.totalCandidates || \"N/D\"}\n- Total de Partidos Ativos: ${votesByParty.length}\n- Municípios: ${summary.totalMunicipalities || \"N/D\"}\n\nTOP PARTIDOS:\n${votesByParty.slice(0, 10).map((p, i) => `${i + 1}. ${p.party}: ${p.votes.toLocaleString(\"pt-BR\")} votos (${p.candidateCount} candidatos)`).join(\"\\n\")}\n\nTOP CANDIDATOS:\n${topCandidates.slice(0, 10).map((c, i) => `${i + 1}. ${c.name} (${c.party || \"N/D\"}): ${c.votes.toLocaleString(\"pt-BR\")} votos`).join(\"\\n\")}\n\nTENDÊNCIAS HISTÓRICAS:\n${historicalTrends.map(t => `Ano ${t.year}: ${t.totalVotes.toLocaleString(\"pt-BR\")} votos, ${t.parties} partidos`).join(\"\\n\")}\n\nFiltros: UF=${filters.uf || \"Nacional\"}, Ano=${filters.year || \"Todos\"}, Tipo=${filters.electionType || \"Todos\"}\n\nGere insights estratégicos, identifique padrões, anomalias e riscos.\n\nResponda em JSON com a estrutura:\n{\n  \"summary\": \"resumo executivo da análise (2-3 parágrafos)\",\n  \"keyFindings\": [\n    {\n      \"finding\": \"descoberta\",\n      \"importance\": \"high\" | \"medium\" | \"low\",\n      \"category\": \"trend\" | \"anomaly\" | \"pattern\" | \"prediction\"\n    }\n  ],\n  \"riskFactors\": [\n    {\n      \"risk\": \"descrição do risco\",\n      \"probability\": número_0_a_1,\n      \"impact\": \"high\" | \"medium\" | \"low\",\n      \"mitigation\": \"estratégia de mitigação\"\n    }\n  ],\n  \"recommendations\": [\"recomendação 1\", \"recomendação 2\", \"recomendação 3\"],\n  \"dataQuality\": {\n    \"completeness\": número_0_a_1,\n    \"yearsAnalyzed\": número,\n    \"candidatesAnalyzed\": número,\n    \"partiesAnalyzed\": número\n  }\n}`;\n\n  const completion = await openai.chat.completions.create({\n    model: \"gpt-4o\",\n    messages: [{ role: \"user\", content: prompt }],\n    response_format: { type: \"json_object\" },\n  });\n\n  const content = completion.choices[0]?.message?.content;\n  if (!content) {\n    throw new Error(\"No response from AI\");\n  }\n\n  const result = JSON.parse(content);\n  result.generatedAt = new Date().toISOString();\n  \n  return result as ElectoralInsights;\n}\n\n// Generate comprehensive projection report\nexport async function generateProjectionReport(params: {\n  name: string;\n  targetYear: number;\n  electionType: string;\n  scope: \"national\" | \"state\";\n  state?: string;\n  position?: string;\n}): Promise<ProjectionReport> {\n  const { name, targetYear, electionType, scope, state, position } = params;\n  \n  // Gather historical data\n  const availableYears = await storage.getAvailableElectionYears();\n  const historicalData: { year: number; totalVotes: number; candidates: number; parties: number }[] = [];\n  \n  for (const year of availableYears.slice(0, 6)) {\n    const summary = await storage.getAnalyticsSummary({ \n      year, \n      uf: scope === \"state\" ? state : undefined,\n      electionType \n    });\n    historicalData.push({\n      year,\n      totalVotes: summary.totalVotes || 0,\n      candidates: summary.totalCandidates || 0,\n      parties: summary.totalParties || 0\n    });\n  }\n  \n  // Get party performance data\n  const votesByParty = await storage.getVotesByParty({\n    year: availableYears[0],\n    uf: scope === \"state\" ? state : undefined,\n    electionType\n  });\n  \n  // Get top candidates\n  const topCandidates = await storage.getTopCandidates({\n    year: availableYears[0],\n    uf: scope === \"state\" ? state : undefined,\n    limit: 20\n  });\n  \n  // Get votes by state for national scope\n  const votesByState = scope === \"national\" ? await storage.getVotesByState({ year: availableYears[0] }) : [];\n  \n  const totalRecords = historicalData.reduce((sum, d) => sum + d.candidates, 0);\n  \n  const prompt = `Você é um especialista em análise eleitoral brasileira e projeções de resultados eleitorais.\nVocê deve gerar um relatório de projeção completo e detalhado para a eleição de ${targetYear}.\n\nCONTEXTO DA ANÁLISE:\n- Ano alvo: ${targetYear}\n- Tipo de eleição: ${electionType}\n- Escopo: ${scope === \"national\" ? \"Nacional (todos os estados)\" : `Estado: ${state}`}\n${position ? `- Cargo: ${position}` : \"\"}\n\nDADOS HISTÓRICOS DE VOTAÇÃO (base para projeções):\n${historicalData.map(d => `Ano ${d.year}: ${d.totalVotes.toLocaleString(\"pt-BR\")} votos, ${d.candidates} candidatos, ${d.parties} partidos`).join(\"\\n\")}\n\nDESEMPENHO ATUAL DOS PARTIDOS (ano ${availableYears[0]}):\n${votesByParty.slice(0, 15).map((p, i) => `${i + 1}. ${p.party}: ${p.votes.toLocaleString(\"pt-BR\")} votos (${((p.votes / (historicalData[0]?.totalVotes || 1)) * 100).toFixed(1)}%)`).join(\"\\n\")}\n\nTOP 20 CANDIDATOS MAIS VOTADOS:\n${topCandidates.slice(0, 20).map((c, i) => `${i + 1}. ${c.name} (${c.party || \"N/D\"}): ${c.votes.toLocaleString(\"pt-BR\")} votos`).join(\"\\n\")}\n\n${scope === \"national\" && votesByState.length > 0 ? `\nVOTOS POR ESTADO:\n${votesByState.map(s => `${s.state}: ${s.votes.toLocaleString(\"pt-BR\")} votos`).join(\"\\n\")}\n` : \"\"}\n\nGere um RELATÓRIO DE PROJEÇÃO COMPLETO com margens de erro e intervalos de confiança.\nUse metodologia estatística rigorosa baseada em:\n1. Análise de tendências históricas\n2. Crescimento/declínio partidário\n3. Volatilidade eleitoral\n4. Fatores contextuais\n\nResponda em JSON com a estrutura EXATA:\n{\n  \"executiveSummary\": \"resumo executivo completo (3-4 parágrafos)\",\n  \"methodology\": \"descrição da metodologia usada para as projeções\",\n  \"turnoutProjection\": {\n    \"expected\": número_percentual_esperado (ex: 78.5),\n    \"confidence\": número_0_a_1,\n    \"marginOfError\": { \"lower\": número_percentual, \"upper\": número_percentual },\n    \"historicalBasis\": [{ \"year\": ano, \"turnout\": percentual }],\n    \"factors\": [{ \"factor\": \"nome\", \"impact\": -1_a_1, \"description\": \"descrição\" }]\n  },\n  \"partyProjections\": [\n    {\n      \"party\": \"nome completo\",\n      \"abbreviation\": \"SIGLA\",\n      \"voteShare\": { \"expected\": número, \"min\": número, \"max\": número },\n      \"seats\": { \"expected\": número, \"min\": número, \"max\": número },\n      \"trend\": \"growing\" | \"declining\" | \"stable\",\n      \"confidence\": número_0_a_1,\n      \"marginOfError\": número_percentual\n    }\n  ],\n  \"candidateProjections\": [\n    {\n      \"name\": \"nome\",\n      \"party\": \"SIGLA\",\n      \"position\": \"cargo\",\n      \"electionProbability\": número_0_a_1,\n      \"projectedVotes\": { \"expected\": número, \"min\": número, \"max\": número },\n      \"confidence\": número_0_a_1,\n      \"ranking\": número\n    }\n  ],\n  \"scenarios\": [\n    {\n      \"name\": \"nome do cenário\",\n      \"description\": \"descrição\",\n      \"probability\": número_0_a_1,\n      \"outcomes\": [{ \"party\": \"SIGLA\", \"seats\": número, \"voteShare\": número }]\n    }\n  ],\n  \"riskAssessment\": {\n    \"overallRisk\": \"low\" | \"medium\" | \"high\",\n    \"risks\": [\n      {\n        \"risk\": \"descrição\",\n        \"probability\": número_0_a_1,\n        \"impact\": \"low\" | \"medium\" | \"high\",\n        \"category\": \"political\" | \"economic\" | \"social\" | \"technical\",\n        \"mitigation\": \"estratégia\"\n      }\n    ]\n  },\n  \"confidenceIntervals\": {\n    \"overall\": número_0_a_1,\n    \"turnout\": número_0_a_1,\n    \"partyResults\": número_0_a_1,\n    \"seatDistribution\": número_0_a_1\n  },\n  \"recommendations\": [\"recomendação1\", \"recomendação2\", ...]\n}`;\n\n  const completion = await openai.chat.completions.create({\n    model: \"gpt-4o\",\n    messages: [{ role: \"user\", content: prompt }],\n    response_format: { type: \"json_object\" },\n  });\n\n  const content = completion.choices[0]?.message?.content;\n  if (!content) {\n    throw new Error(\"No response from AI\");\n  }\n\n  let rawAiResult: unknown;\n  try {\n    rawAiResult = JSON.parse(content);\n  } catch (parseError) {\n    console.error(\"Failed to parse AI response as JSON:\", parseError);\n    throw new Error(\"AI response was not valid JSON. Please try again.\");\n  }\n  \n  // Validate AI response with Zod schema and apply safe defaults\n  const validationResult = aiProjectionResponseSchema.safeParse(rawAiResult);\n  if (!validationResult.success) {\n    console.error(\"AI response validation failed:\", validationResult.error.issues);\n    // Use the default values from the schema as fallback\n    console.warn(\"Using default fallback values for invalid AI response\");\n  }\n  \n  const safeAiResult = validationResult.success \n    ? validationResult.data \n    : aiProjectionResponseSchema.parse({});\n  \n  // Build the complete report\n  const now = new Date();\n  const validUntil = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000); // Valid for 7 days\n  \n  const report: ProjectionReport = {\n    name,\n    targetYear,\n    electionType,\n    scope,\n    state: scope === \"state\" ? state : undefined,\n    executiveSummary: safeAiResult.executiveSummary,\n    methodology: safeAiResult.methodology,\n    dataQuality: {\n      completeness: historicalData.length > 0 ? Math.min(historicalData.length / 6, 1) : 0,\n      yearsAnalyzed: historicalData.length,\n      totalRecordsAnalyzed: totalRecords,\n      lastUpdated: now.toISOString()\n    },\n    turnoutProjection: safeAiResult.turnoutProjection,\n    partyProjections: safeAiResult.partyProjections,\n    candidateProjections: safeAiResult.candidateProjections,\n    scenarios: safeAiResult.scenarios,\n    riskAssessment: safeAiResult.riskAssessment,\n    confidenceIntervals: safeAiResult.confidenceIntervals,\n    recommendations: safeAiResult.recommendations,\n    generatedAt: now.toISOString(),\n    validUntil: validUntil.toISOString(),\n    version: \"1.0\"\n  };\n  \n  return report;\n}\n","path":null,"size_bytes":38855,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"server/forecasting.ts":{"content":"import { storage } from \"./storage\";\nimport OpenAI from \"openai\";\nimport type { ForecastRun, ForecastResult, SwingRegion, InsertForecastResult, InsertSwingRegion } from \"@shared/schema\";\n\nlet _openai: OpenAI | null = null;\n\nfunction getOpenAI(): OpenAI {\n  if (!_openai) {\n    _openai = new OpenAI();\n  }\n  return _openai;\n}\n\ninterface ModelParameters {\n  monteCarloIterations: number;\n  confidenceLevel: number;\n  historicalWeightDecay: number;\n  sentimentWeight: number;\n  trendWeight: number;\n  volatilityMultiplier: number;\n}\n\ninterface HistoricalDataPoint {\n  year: number;\n  party: string;\n  state: string | null;\n  position: string | null;\n  totalVotes: number;\n  candidateCount: number;\n}\n\ninterface PartyTrendData {\n  party: string;\n  historicalVotes: { year: number; votes: number; share: number }[];\n  trendSlope: number;\n  volatility: number;\n  avgGrowthRate: number;\n}\n\ninterface MonteCarloResult {\n  samples: number[];\n  mean: number;\n  median: number;\n  lower: number;\n  upper: number;\n  standardDeviation: number;\n}\n\nconst DEFAULT_PARAMETERS: ModelParameters = {\n  monteCarloIterations: 10000,\n  confidenceLevel: 0.95,\n  historicalWeightDecay: 0.85,\n  sentimentWeight: 0.15,\n  trendWeight: 0.4,\n  volatilityMultiplier: 1.2,\n};\n\nconst BRAZILIAN_STATES: Record<string, string> = {\n  AC: \"Acre\", AL: \"Alagoas\", AP: \"Amapá\", AM: \"Amazonas\",\n  BA: \"Bahia\", CE: \"Ceará\", DF: \"Distrito Federal\", ES: \"Espírito Santo\",\n  GO: \"Goiás\", MA: \"Maranhão\", MT: \"Mato Grosso\", MS: \"Mato Grosso do Sul\",\n  MG: \"Minas Gerais\", PA: \"Pará\", PB: \"Paraíba\", PR: \"Paraná\",\n  PE: \"Pernambuco\", PI: \"Piauí\", RJ: \"Rio de Janeiro\", RN: \"Rio Grande do Norte\",\n  RS: \"Rio Grande do Sul\", RO: \"Rondônia\", RR: \"Roraima\", SC: \"Santa Catarina\",\n  SP: \"São Paulo\", SE: \"Sergipe\", TO: \"Tocantins\"\n};\n\nfunction calculateTrendSlope(dataPoints: { year: number; value: number }[]): number {\n  if (dataPoints.length < 2) return 0;\n  \n  const n = dataPoints.length;\n  const sumX = dataPoints.reduce((sum, d) => sum + d.year, 0);\n  const sumY = dataPoints.reduce((sum, d) => sum + d.value, 0);\n  const sumXY = dataPoints.reduce((sum, d) => sum + d.year * d.value, 0);\n  const sumX2 = dataPoints.reduce((sum, d) => sum + d.year * d.year, 0);\n  \n  const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);\n  return isNaN(slope) || !isFinite(slope) ? 0 : slope;\n}\n\nfunction calculateVolatility(values: number[]): number {\n  if (values.length < 2) return 0;\n  \n  const mean = values.reduce((sum, v) => sum + v, 0) / values.length;\n  const variance = values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / (values.length - 1);\n  return Math.sqrt(variance);\n}\n\nfunction generateNormalRandom(mean: number, stdDev: number): number {\n  const u1 = Math.random();\n  const u2 = Math.random();\n  const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);\n  return mean + z * stdDev;\n}\n\nfunction runMonteCarloSimulation(\n  baseValue: number,\n  volatility: number,\n  trendAdjustment: number,\n  iterations: number,\n  confidenceLevel: number,\n  maxVoteShare: number = 100\n): MonteCarloResult {\n  const samples: number[] = [];\n  \n  for (let i = 0; i < iterations; i++) {\n    const noise = generateNormalRandom(0, volatility);\n    const sample = Math.min(maxVoteShare, Math.max(0, baseValue + trendAdjustment + noise));\n    samples.push(sample);\n  }\n  \n  samples.sort((a, b) => a - b);\n  \n  const mean = samples.reduce((sum, v) => sum + v, 0) / samples.length;\n  const median = samples[Math.floor(samples.length / 2)];\n  const lowerIdx = Math.floor(samples.length * ((1 - confidenceLevel) / 2));\n  const upperIdx = Math.floor(samples.length * (1 - (1 - confidenceLevel) / 2));\n  \n  return {\n    samples,\n    mean,\n    median,\n    lower: samples[lowerIdx],\n    upper: samples[upperIdx],\n    standardDeviation: calculateVolatility(samples),\n  };\n}\n\nfunction analyzePartyTrends(\n  historicalData: HistoricalDataPoint[],\n  params: ModelParameters\n): Map<string, PartyTrendData> {\n  const partyMap = new Map<string, HistoricalDataPoint[]>();\n  \n  for (const data of historicalData) {\n    const existing = partyMap.get(data.party) || [];\n    existing.push(data);\n    partyMap.set(data.party, existing);\n  }\n  \n  const yearTotals = new Map<number, number>();\n  for (const data of historicalData) {\n    yearTotals.set(data.year, (yearTotals.get(data.year) || 0) + data.totalVotes);\n  }\n  \n  const trendData = new Map<string, PartyTrendData>();\n  \n  const partyEntries = Array.from(partyMap.entries());\n  for (const [party, dataPoints] of partyEntries) {\n    const votesWithShares = dataPoints.map((d: HistoricalDataPoint) => ({\n      year: d.year,\n      votes: d.totalVotes,\n      share: yearTotals.get(d.year) ? (d.totalVotes / yearTotals.get(d.year)!) * 100 : 0,\n    })).sort((a: { year: number }, b: { year: number }) => a.year - b.year);\n    \n    const trendSlope = calculateTrendSlope(\n      votesWithShares.map((v: { year: number; share: number }) => ({ year: v.year, value: v.share }))\n    );\n    \n    const volatility = calculateVolatility(votesWithShares.map((v: { share: number }) => v.share));\n    \n    let avgGrowthRate = 0;\n    if (votesWithShares.length >= 2) {\n      const growthRates: number[] = [];\n      for (let i = 1; i < votesWithShares.length; i++) {\n        if (votesWithShares[i - 1].share > 0) {\n          growthRates.push(\n            (votesWithShares[i].share - votesWithShares[i - 1].share) / votesWithShares[i - 1].share\n          );\n        }\n      }\n      avgGrowthRate = growthRates.length > 0\n        ? growthRates.reduce((s: number, v: number) => s + v, 0) / growthRates.length\n        : 0;\n    }\n    \n    trendData.set(party, {\n      party,\n      historicalVotes: votesWithShares,\n      trendSlope,\n      volatility,\n      avgGrowthRate,\n    });\n  }\n  \n  return trendData;\n}\n\nfunction identifySwingRegions(\n  historicalData: HistoricalDataPoint[],\n  partyTrends: Map<string, PartyTrendData>,\n  params: ModelParameters\n): InsertSwingRegion[] {\n  const swingRegions: InsertSwingRegion[] = [];\n  const stateMap = new Map<string, HistoricalDataPoint[]>();\n  \n  for (const data of historicalData) {\n    if (!data.state) continue;\n    const existing = stateMap.get(data.state) || [];\n    existing.push(data);\n    stateMap.set(data.state, existing);\n  }\n  \n  const stateEntries = Array.from(stateMap.entries());\n  for (const [state, stateData] of stateEntries) {\n    const mostRecentYear = Math.max(...stateData.map((d: HistoricalDataPoint) => d.year));\n    const recentData = stateData.filter((d: HistoricalDataPoint) => d.year === mostRecentYear);\n    \n    recentData.sort((a: HistoricalDataPoint, b: HistoricalDataPoint) => b.totalVotes - a.totalVotes);\n    \n    if (recentData.length < 2) continue;\n    \n    const leader = recentData[0];\n    const challenger = recentData[1];\n    const totalVotes = recentData.reduce((sum, d) => sum + d.totalVotes, 0);\n    \n    const margin = totalVotes > 0\n      ? ((leader.totalVotes - challenger.totalVotes) / totalVotes) * 100\n      : 0;\n    \n    const leaderTrend = partyTrends.get(leader.party);\n    const challengerTrend = partyTrends.get(challenger.party);\n    \n    const avgVolatility = (\n      (leaderTrend?.volatility || 0) + (challengerTrend?.volatility || 0)\n    ) / 2;\n    \n    const isSwing = margin < 10 && avgVolatility > 2;\n    \n    if (isSwing) {\n      const recentTrendShift = (challengerTrend?.trendSlope || 0) - (leaderTrend?.trendSlope || 0);\n      \n      swingRegions.push({\n        runId: 0,\n        region: state,\n        regionName: BRAZILIAN_STATES[state] || state,\n        position: leader.position,\n        marginPercent: margin.toFixed(2),\n        marginVotes: leader.totalVotes - challenger.totalVotes,\n        volatilityScore: avgVolatility.toFixed(4),\n        swingMagnitude: (avgVolatility * params.volatilityMultiplier).toFixed(2),\n        leadingEntity: leader.party,\n        challengingEntity: challenger.party,\n        sentimentBalance: \"0\",\n        recentTrendShift: recentTrendShift.toFixed(4),\n        outcomeUncertainty: Math.min(1, (10 - margin) / 10 * avgVolatility / 5).toFixed(4),\n        keyFactors: [\n          { factor: \"Margem apertada\", impact: margin < 5 ? \"alto\" : \"médio\" },\n          { factor: \"Alta volatilidade histórica\", impact: avgVolatility > 5 ? \"alto\" : \"médio\" },\n          recentTrendShift > 0 ? { factor: \"Desafiante em ascensão\", impact: \"alto\" } : null,\n        ].filter(Boolean) as { factor: string; impact: string }[],\n      });\n    }\n  }\n  \n  return swingRegions.sort((a, b) => \n    parseFloat(b.volatilityScore || \"0\") - parseFloat(a.volatilityScore || \"0\")\n  );\n}\n\nfunction generatePartyForecasts(\n  partyTrends: Map<string, PartyTrendData>,\n  targetYear: number,\n  params: ModelParameters\n): InsertForecastResult[] {\n  const results: InsertForecastResult[] = [];\n  \n  const trendEntries = Array.from(partyTrends.entries());\n  for (const [party, trend] of trendEntries) {\n    const lastDataPoint = trend.historicalVotes[trend.historicalVotes.length - 1];\n    if (!lastDataPoint) continue;\n    \n    const yearsDelta = targetYear - lastDataPoint.year;\n    const trendProjection = lastDataPoint.share + (trend.trendSlope * yearsDelta);\n    const adjustedVolatility = trend.volatility * params.volatilityMultiplier * Math.sqrt(yearsDelta);\n    \n    const simulation = runMonteCarloSimulation(\n      trendProjection,\n      adjustedVolatility,\n      0,\n      params.monteCarloIterations,\n      params.confidenceLevel\n    );\n    \n    let trendDirection: \"rising\" | \"falling\" | \"stable\" = \"stable\";\n    if (trend.trendSlope > 0.5) trendDirection = \"rising\";\n    else if (trend.trendSlope < -0.5) trendDirection = \"falling\";\n    \n    const confidence = Math.max(0.3, 1 - (simulation.standardDeviation / simulation.mean) * 0.5);\n    \n    results.push({\n      runId: 0,\n      resultType: \"party\",\n      entityName: party,\n      predictedVoteShare: simulation.mean.toFixed(4),\n      voteShareLower: simulation.lower.toFixed(4),\n      voteShareUpper: simulation.upper.toFixed(4),\n      historicalTrend: {\n        years: trend.historicalVotes.map((v: { year: number }) => v.year),\n        voteShares: trend.historicalVotes.map((v: { share: number }) => v.share),\n      },\n      trendDirection,\n      trendStrength: Math.abs(trend.trendSlope).toFixed(4),\n      confidence: confidence.toFixed(4),\n      influenceFactors: [\n        { factor: \"Tendência histórica\", weight: params.trendWeight, impact: trendDirection },\n        { factor: \"Volatilidade\", weight: 0.2, impact: trend.volatility > 5 ? \"alto\" : \"médio\" },\n        { factor: \"Taxa de crescimento\", weight: 0.2, impact: trend.avgGrowthRate > 0 ? \"positivo\" : \"negativo\" },\n      ],\n    });\n  }\n  \n  return results.sort((a, b) => \n    parseFloat(b.predictedVoteShare || \"0\") - parseFloat(a.predictedVoteShare || \"0\")\n  );\n}\n\nasync function generateAINarrative(\n  forecastRun: ForecastRun,\n  partyResults: InsertForecastResult[],\n  swingRegions: InsertSwingRegion[]\n): Promise<string> {\n  const topParties = partyResults.slice(0, 5);\n  const topSwingRegions = swingRegions.slice(0, 3);\n  \n  const prompt = `\nVocê é um analista político brasileiro especializado em previsões eleitorais.\nBaseado nos seguintes dados de previsão para o ano ${forecastRun.targetYear}, gere uma análise narrativa concisa (3-4 parágrafos):\n\nPrevisões por Partido (top 5):\n${topParties.map(p => `- ${p.entityName}: ${parseFloat(p.predictedVoteShare || \"0\").toFixed(1)}% (IC: ${parseFloat(p.voteShareLower || \"0\").toFixed(1)}% - ${parseFloat(p.voteShareUpper || \"0\").toFixed(1)}%), Tendência: ${p.trendDirection}`).join(\"\\n\")}\n\nRegiões Voláteis (swing regions):\n${topSwingRegions.map(r => `- ${r.regionName}: Margem ${r.marginPercent}% entre ${r.leadingEntity} e ${r.challengingEntity}, Volatilidade: ${r.volatilityScore}`).join(\"\\n\")}\n\nCargo: ${forecastRun.targetPosition || \"Geral\"}\nEstado: ${forecastRun.targetState || \"Nacional\"}\n\nForneça insights sobre:\n1. Cenário competitivo geral\n2. Principais riscos e incertezas\n3. Regiões decisivas para o resultado\n4. Recomendações estratégicas\n`;\n\n  try {\n    const response = await getOpenAI().chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [{ role: \"user\", content: prompt }],\n      temperature: 0.7,\n      max_tokens: 1000,\n    });\n    \n    return response.choices[0]?.message?.content || \"Análise não disponível.\";\n  } catch (error) {\n    console.error(\"Error generating AI narrative:\", error);\n    return \"Não foi possível gerar análise narrativa. Por favor, consulte os dados quantitativos.\";\n  }\n}\n\nexport async function runForecast(\n  runId: number,\n  options: {\n    targetYear: number;\n    targetPosition?: string;\n    targetState?: string;\n    historicalYears?: number[];\n    modelParameters?: Partial<ModelParameters>;\n  }\n): Promise<{\n  partyResults: ForecastResult[];\n  swingRegions: SwingRegion[];\n  narrative: string;\n}> {\n  const params = { ...DEFAULT_PARAMETERS, ...options.modelParameters };\n  \n  await storage.updateForecastRun(runId, {\n    status: \"running\",\n    startedAt: new Date(),\n  } as any);\n  \n  const historicalYears = options.historicalYears || \n    [options.targetYear - 4, options.targetYear - 8, options.targetYear - 12].filter(y => y >= 2002);\n  \n  const historicalData = await storage.getHistoricalVotesByParty({\n    years: historicalYears,\n    position: options.targetPosition,\n    state: options.targetState,\n  });\n  \n  if (historicalData.length === 0) {\n    await storage.updateForecastRun(runId, {\n      status: \"failed\",\n      completedAt: new Date(),\n    } as any);\n    throw new Error(\"Dados históricos insuficientes para previsão\");\n  }\n  \n  const partyTrends = analyzePartyTrends(historicalData, params);\n  \n  const partyResults = generatePartyForecasts(partyTrends, options.targetYear, params);\n  \n  const swingRegionsData = identifySwingRegions(historicalData, partyTrends, params);\n  \n  const forecastRun = await storage.getForecastRun(runId);\n  if (!forecastRun) {\n    throw new Error(\"Forecast run not found\");\n  }\n  \n  const narrative = await generateAINarrative(forecastRun, partyResults, swingRegionsData);\n  \n  const savedPartyResults = await storage.createForecastResults(\n    partyResults.map(r => ({ ...r, runId }))\n  );\n  \n  const savedSwingRegions = await storage.createSwingRegions(\n    swingRegionsData.map(r => ({ ...r, runId }))\n  );\n  \n  await storage.updateForecastRun(runId, {\n    status: \"completed\",\n    completedAt: new Date(),\n    totalSimulations: params.monteCarloIterations,\n    historicalYearsUsed: historicalYears,\n    modelParameters: params as any,\n  } as any);\n  \n  return {\n    partyResults: savedPartyResults,\n    swingRegions: savedSwingRegions,\n    narrative,\n  };\n}\n\nexport async function createAndRunForecast(\n  userId: string,\n  options: {\n    name: string;\n    description?: string;\n    targetYear: number;\n    targetPosition?: string;\n    targetState?: string;\n    targetElectionType?: string;\n    historicalYears?: number[];\n    modelParameters?: Partial<ModelParameters>;\n  }\n): Promise<ForecastRun> {\n  const forecastRun = await storage.createForecastRun({\n    name: options.name,\n    description: options.description,\n    targetYear: options.targetYear,\n    targetPosition: options.targetPosition,\n    targetState: options.targetState,\n    targetElectionType: options.targetElectionType,\n    createdBy: userId,\n    status: \"pending\",\n  });\n  \n  runForecast(forecastRun.id, {\n    targetYear: options.targetYear,\n    targetPosition: options.targetPosition,\n    targetState: options.targetState,\n    historicalYears: options.historicalYears,\n    modelParameters: options.modelParameters,\n  }).catch(error => {\n    console.error(`Forecast run ${forecastRun.id} failed:`, error);\n  });\n  \n  return forecastRun;\n}\n\nexport async function getForecastSummary(runId: number): Promise<{\n  run: ForecastRun;\n  topParties: ForecastResult[];\n  swingRegions: SwingRegion[];\n  narrative?: string;\n} | null> {\n  const run = await storage.getForecastRun(runId);\n  if (!run) return null;\n  \n  const results = await storage.getForecastResults(runId, { resultType: \"party\" });\n  const swingRegions = await storage.getSwingRegions(runId);\n  \n  return {\n    run,\n    topParties: results.slice(0, 10),\n    swingRegions,\n  };\n}\n\ninterface ScenarioPollingData {\n  party: string;\n  pollPercent: number;\n  pollDate?: string;\n  source?: string;\n  sampleSize?: number;\n}\n\ninterface ScenarioPartyAdjustment {\n  voteShareAdjust?: number;\n  turnoutAdjust?: number;\n  reason?: string;\n}\n\ninterface PredictionScenarioData {\n  id: number;\n  name: string;\n  baseYear: number;\n  targetYear: number;\n  state?: string | null;\n  position?: string | null;\n  pollingData?: ScenarioPollingData[] | null;\n  pollingWeight?: string | null;\n  partyAdjustments?: Record<string, ScenarioPartyAdjustment> | null;\n  expectedTurnout?: string | null;\n  turnoutVariation?: string | null;\n  externalFactors?: { factor: string; impact: 'positive' | 'negative'; magnitude: number }[] | null;\n  monteCarloIterations?: number;\n  confidenceLevel?: string | null;\n  volatilityMultiplier?: string | null;\n  parameters?: {\n    pollingWeight?: number;\n    historicalWeight?: number;\n    adjustmentWeight?: number;\n    monteCarloIterations?: number;\n    confidenceLevel?: number;\n  } | null;\n}\n\nexport async function runForecastWithScenario(\n  runId: number,\n  scenario: PredictionScenarioData\n): Promise<{\n  partyResults: ForecastResult[];\n  swingRegions: SwingRegion[];\n  narrative: string;\n}> {\n  const scenarioParams = scenario.parameters || {};\n  const params: ModelParameters = {\n    monteCarloIterations: scenarioParams.monteCarloIterations || scenario.monteCarloIterations || 10000,\n    confidenceLevel: scenarioParams.confidenceLevel || parseFloat(scenario.confidenceLevel || \"0.95\"),\n    historicalWeightDecay: 0.85,\n    sentimentWeight: scenarioParams.adjustmentWeight || 0.20,\n    trendWeight: scenarioParams.historicalWeight || 0.50,\n    volatilityMultiplier: parseFloat(scenario.volatilityMultiplier || \"1.20\"),\n  };\n  \n  await storage.updateForecastRun(runId, {\n    status: \"running\",\n    startedAt: new Date(),\n  } as any);\n  \n  const historicalData = await storage.getHistoricalVotesByParty({\n    years: [scenario.baseYear, scenario.baseYear - 4, scenario.baseYear - 8].filter(y => y >= 2002),\n    position: scenario.position || undefined,\n    state: scenario.state || undefined,\n  });\n  \n  if (historicalData.length === 0) {\n    await storage.updateForecastRun(runId, { \n      status: \"failed\",\n      completedAt: new Date(),\n    } as any);\n    throw new Error(\"No historical data available for the specified parameters\");\n  }\n  \n  const partyTrends = analyzePartyTrends(historicalData, params);\n  \n  // Apply polling data adjustments if available\n  if (scenario.pollingData && scenario.pollingData.length > 0) {\n    const pollingWeight = scenarioParams.pollingWeight || parseFloat(scenario.pollingWeight || \"0.30\");\n    for (const poll of scenario.pollingData) {\n      const partyTrend = partyTrends.find(t => t.party === poll.party);\n      if (partyTrend && partyTrend.historicalVotes.length > 0) {\n        const lastHistorical = partyTrend.historicalVotes[partyTrend.historicalVotes.length - 1];\n        const blendedShare = (lastHistorical.share * (1 - pollingWeight)) + (poll.pollPercent * pollingWeight);\n        partyTrend.historicalVotes[partyTrend.historicalVotes.length - 1].share = blendedShare;\n      }\n    }\n  }\n  \n  // Apply party-specific adjustments\n  if (scenario.partyAdjustments) {\n    for (const [partyName, adjustment] of Object.entries(scenario.partyAdjustments)) {\n      const partyTrend = partyTrends.find(t => t.party === partyName);\n      if (partyTrend && partyTrend.historicalVotes.length > 0 && adjustment.voteShareAdjust) {\n        const lastIdx = partyTrend.historicalVotes.length - 1;\n        partyTrend.historicalVotes[lastIdx].share += adjustment.voteShareAdjust;\n      }\n    }\n  }\n  \n  // Apply external factors as overall volatility adjustments\n  if (scenario.externalFactors && scenario.externalFactors.length > 0) {\n    let totalImpact = 0;\n    for (const factor of scenario.externalFactors) {\n      const impact = factor.impact === 'positive' ? factor.magnitude : -factor.magnitude;\n      totalImpact += impact / 100;\n    }\n    params.volatilityMultiplier = Math.max(0.1, params.volatilityMultiplier + totalImpact * 0.1);\n  }\n  \n  // Run Monte Carlo for each party\n  const partyPredictions = new Map<string, {\n    prediction: MonteCarloResult;\n    trend: PartyTrendData;\n  }>();\n  \n  for (const trend of partyTrends) {\n    const baseShare = trend.historicalVotes.length > 0\n      ? trend.historicalVotes[trend.historicalVotes.length - 1].share\n      : 5;\n    const prediction = runMonteCarloSimulation(\n      baseShare,\n      trend.volatility * params.volatilityMultiplier,\n      trend.trendSlope,\n      params.monteCarloIterations,\n      params.confidenceLevel\n    );\n    partyPredictions.set(trend.party, { prediction, trend });\n  }\n  \n  // Normalize predictions\n  const totalShare = Array.from(partyPredictions.values())\n    .reduce((sum, p) => sum + p.prediction.mean, 0);\n  const normalizationFactor = totalShare > 0 ? 100 / totalShare : 1;\n  \n  const partyResults: InsertForecastResult[] = [];\n  for (const [party, data] of partyPredictions) {\n    const normalizedShare = data.prediction.mean * normalizationFactor;\n    const normalizedLower = data.prediction.lower * normalizationFactor;\n    const normalizedUpper = data.prediction.upper * normalizationFactor;\n    \n    partyResults.push({\n      runId,\n      resultType: \"party\",\n      party,\n      region: scenario.state || null,\n      predictedVoteShare: normalizedShare,\n      confidenceIntervalLower: normalizedLower,\n      confidenceIntervalUpper: normalizedUpper,\n      historicalAverage: data.trend.historicalVotes.reduce((sum, v) => sum + v.share, 0) / data.trend.historicalVotes.length,\n      trendDirection: data.trend.trendSlope > 0.01 ? \"up\" : data.trend.trendSlope < -0.01 ? \"down\" : \"stable\",\n      volatilityScore: data.trend.volatility,\n    });\n  }\n  \n  // Sort by predicted vote share\n  partyResults.sort((a, b) => (b.predictedVoteShare || 0) - (a.predictedVoteShare || 0));\n  \n  const savedResults = await storage.createForecastResults(partyResults);\n  \n  // Identify swing regions if running national forecast\n  let swingRegions: SwingRegion[] = [];\n  if (!scenario.state) {\n    const stateVolatility = await calculateStateVolatility(scenario.baseYear, scenario.position);\n    const swingData: InsertSwingRegion[] = stateVolatility\n      .slice(0, 10)\n      .map(sv => ({\n        runId,\n        region: sv.state,\n        volatilityScore: sv.volatility,\n        historicalSwing: sv.swing,\n        keyParties: sv.topParties,\n      }));\n    \n    if (swingData.length > 0) {\n      swingRegions = await storage.createSwingRegions(swingData);\n    }\n  }\n  \n  // Generate narrative with AI\n  let narrative = \"\";\n  try {\n    const openai = getOpenAI();\n    const topParties = partyResults.slice(0, 5);\n    const promptParts = [\n      `Análise de previsão eleitoral para ${scenario.targetYear}:`,\n      `Cenário: ${scenario.name}`,\n      `Baseado em dados históricos de ${scenario.baseYear}`,\n      scenario.state ? `Estado: ${scenario.state}` : \"Âmbito Nacional\",\n      \"\",\n      \"Partidos principais previstos:\",\n      ...topParties.map((p, i) => \n        `${i + 1}. ${p.party}: ${p.predictedVoteShare?.toFixed(1)}% (IC: ${p.confidenceIntervalLower?.toFixed(1)}%-${p.confidenceIntervalUpper?.toFixed(1)}%)`\n      ),\n    ];\n    \n    if (scenario.pollingData && scenario.pollingData.length > 0) {\n      promptParts.push(\"\", \"Dados de pesquisas incorporados:\");\n      for (const poll of scenario.pollingData) {\n        promptParts.push(`- ${poll.party}: ${poll.pollPercent}% (${poll.source || 'pesquisa'})`);\n      }\n    }\n    \n    if (scenario.externalFactors && scenario.externalFactors.length > 0) {\n      promptParts.push(\"\", \"Fatores externos considerados:\");\n      for (const factor of scenario.externalFactors) {\n        promptParts.push(`- ${factor.factor}: impacto ${factor.impact} (magnitude ${factor.magnitude}/10)`);\n      }\n    }\n    \n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        {\n          role: \"system\",\n          content: \"Você é um analista político especializado em eleições brasileiras. Forneça uma análise concisa e objetiva das previsões eleitorais, destacando tendências, riscos e oportunidades. Responda em português brasileiro.\",\n        },\n        {\n          role: \"user\",\n          content: promptParts.join(\"\\n\") + \"\\n\\nGere uma análise narrativa de 2-3 parágrafos sobre estas previsões, considerando o contexto histórico e os fatores incorporados no cenário.\",\n        },\n      ],\n      max_tokens: 500,\n    });\n    \n    narrative = response.choices[0]?.message?.content || \"\";\n  } catch (error) {\n    console.error(\"Failed to generate AI narrative for scenario:\", error);\n    narrative = `Previsão para ${scenario.targetYear} baseada no cenário \"${scenario.name}\". Top 3 partidos: ${partyResults.slice(0, 3).map(p => `${p.party} (${p.predictedVoteShare?.toFixed(1)}%)`).join(\", \")}.`;\n  }\n  \n  await storage.updateForecastRun(runId, {\n    status: \"completed\",\n    completedAt: new Date(),\n    narrative,\n    summary: {\n      totalPartiesAnalyzed: partyResults.length,\n      topParty: partyResults[0]?.party,\n      confidenceLevel: params.confidenceLevel,\n      scenarioId: scenario.id,\n      scenarioName: scenario.name,\n    },\n  } as any);\n  \n  return {\n    partyResults: savedResults,\n    swingRegions,\n    narrative,\n  };\n}\n\nasync function calculateStateVolatility(\n  baseYear: number,\n  position?: string | null\n): Promise<{ state: string; volatility: number; swing: number; topParties: string[] }[]> {\n  const states = Object.keys(BRAZILIAN_STATES);\n  const results: { state: string; volatility: number; swing: number; topParties: string[] }[] = [];\n  \n  for (const state of states) {\n    const data = await storage.getHistoricalVotesByParty({\n      years: [baseYear, baseYear - 4],\n      position: position || undefined,\n      state,\n    });\n    \n    if (data.length === 0) continue;\n    \n    const partyShares = new Map<string, number[]>();\n    for (const d of data) {\n      if (!partyShares.has(d.party)) {\n        partyShares.set(d.party, []);\n      }\n      partyShares.get(d.party)!.push(d.totalVotes);\n    }\n    \n    let volatility = 0;\n    let count = 0;\n    const topParties: string[] = [];\n    \n    for (const [party, votes] of partyShares) {\n      if (votes.length >= 2) {\n        const change = Math.abs(votes[0] - votes[1]) / Math.max(votes[0], votes[1], 1);\n        volatility += change;\n        count++;\n      }\n      topParties.push(party);\n    }\n    \n    results.push({\n      state,\n      volatility: count > 0 ? volatility / count : 0,\n      swing: volatility,\n      topParties: topParties.slice(0, 3),\n    });\n  }\n  \n  return results.sort((a, b) => b.volatility - a.volatility);\n}\n","path":null,"size_bytes":27003,"size_tokens":null},"client/src/pages/interactive-dashboard.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { \n  BarChart, Bar, XAxis, YAxis, CartesianGrid, ResponsiveContainer, \n  PieChart, Pie, Cell, Legend, Tooltip as RechartsTooltip, \n  AreaChart, Area, Treemap\n} from \"recharts\";\nimport { \n  Vote, Users, Building2, MapPin, TrendingUp, \n  ChevronRight, Home, ArrowLeft, BarChart3, \n  PieChartIcon, Map, Filter, Maximize2, X, Award\n} from \"lucide-react\";\n\nconst CHART_COLORS = [\n  \"#003366\", \"#1a5490\", \"#3475b4\", \"#4e96d8\", \"#68b7fc\",\n  \"#FFD700\", \"#e6c200\", \"#ccad00\", \"#b39800\", \"#998300\",\n  \"#2ecc71\", \"#27ae60\", \"#1e8449\", \"#145a32\", \"#0d3d22\",\n  \"#e74c3c\", \"#c0392b\", \"#a93226\", \"#922b21\", \"#7b241c\",\n];\n\nconst BRAZIL_STATES: { [key: string]: { name: string; path: string; cx: number; cy: number } } = {\n  AC: { name: \"Acre\", path: \"M85,280 L105,275 L110,290 L95,300 L80,295 Z\", cx: 95, cy: 287 },\n  AL: { name: \"Alagoas\", path: \"M490,260 L510,255 L515,270 L495,275 Z\", cx: 502, cy: 265 },\n  AP: { name: \"Amapá\", path: \"M280,80 L310,75 L320,110 L295,120 L275,105 Z\", cx: 297, cy: 95 },\n  AM: { name: \"Amazonas\", path: \"M100,150 L220,140 L240,200 L200,250 L120,260 L80,220 Z\", cx: 160, cy: 195 },\n  BA: { name: \"Bahia\", path: \"M400,220 L480,200 L510,280 L470,340 L410,320 L390,270 Z\", cx: 445, cy: 270 },\n  CE: { name: \"Ceará\", path: \"M450,160 L490,150 L500,190 L465,200 L445,185 Z\", cx: 472, cy: 175 },\n  DF: { name: \"Distrito Federal\", path: \"M355,300 L370,295 L375,310 L360,315 Z\", cx: 365, cy: 305 },\n  ES: { name: \"Espírito Santo\", path: \"M455,340 L475,335 L480,365 L460,370 Z\", cx: 467, cy: 352 },\n  GO: { name: \"Goiás\", path: \"M320,290 L380,280 L400,340 L350,360 L310,340 Z\", cx: 355, cy: 320 },\n  MA: { name: \"Maranhão\", path: \"M360,140 L420,130 L435,180 L390,200 L350,180 Z\", cx: 392, cy: 165 },\n  MT: { name: \"Mato Grosso\", path: \"M220,250 L320,240 L340,340 L280,380 L200,350 L190,290 Z\", cx: 265, cy: 310 },\n  MS: { name: \"Mato Grosso do Sul\", path: \"M280,380 L340,360 L360,430 L300,460 L260,430 Z\", cx: 310, cy: 410 },\n  MG: { name: \"Minas Gerais\", path: \"M360,320 L450,300 L480,370 L430,420 L360,400 L340,360 Z\", cx: 405, cy: 360 },\n  PA: { name: \"Pará\", path: \"M240,120 L350,100 L380,170 L340,220 L260,230 L220,180 Z\", cx: 295, cy: 165 },\n  PB: { name: \"Paraíba\", path: \"M475,210 L510,205 L515,225 L480,230 Z\", cx: 495, cy: 217 },\n  PR: { name: \"Paraná\", path: \"M320,430 L390,420 L410,470 L350,490 L310,470 Z\", cx: 360, cy: 455 },\n  PE: { name: \"Pernambuco\", path: \"M450,220 L510,210 L520,245 L460,255 Z\", cx: 485, cy: 235 },\n  PI: { name: \"Piauí\", path: \"M400,170 L450,160 L465,220 L420,240 L390,210 Z\", cx: 427, cy: 200 },\n  RJ: { name: \"Rio de Janeiro\", path: \"M430,400 L470,390 L485,420 L450,435 Z\", cx: 457, cy: 410 },\n  RN: { name: \"Rio Grande do Norte\", path: \"M480,180 L515,175 L520,200 L490,205 Z\", cx: 500, cy: 190 },\n  RS: { name: \"Rio Grande do Sul\", path: \"M310,500 L380,490 L400,560 L340,580 L290,550 Z\", cx: 345, cy: 535 },\n  RO: { name: \"Rondônia\", path: \"M160,280 L220,270 L230,330 L190,350 L150,330 Z\", cx: 190, cy: 310 },\n  RR: { name: \"Roraima\", path: \"M180,60 L230,50 L250,110 L210,130 L170,100 Z\", cx: 210, cy: 90 },\n  SC: { name: \"Santa Catarina\", path: \"M350,490 L410,480 L425,520 L375,535 Z\", cx: 387, cy: 505 },\n  SP: { name: \"São Paulo\", path: \"M350,400 L430,380 L460,440 L400,470 L340,450 Z\", cx: 395, cy: 425 },\n  SE: { name: \"Sergipe\", path: \"M485,270 L510,265 L515,285 L490,290 Z\", cx: 500, cy: 277 },\n  TO: { name: \"Tocantins\", path: \"M340,200 L390,190 L410,260 L370,290 L330,260 Z\", cx: 365, cy: 240 },\n};\n\ninterface DrillDownContext {\n  level: \"overview\" | \"state\" | \"party\" | \"municipality\" | \"candidate\";\n  year?: number;\n  state?: string;\n  party?: string;\n  position?: string;\n}\n\ninterface PartyVotes {\n  party: string;\n  partyNumber: number | null;\n  votes: number;\n  percentage: number;\n}\n\ninterface StateVotes {\n  state: string;\n  votes: number;\n  candidateCount: number;\n}\n\ninterface MunicipalityVotes {\n  municipality: string;\n  state: string | null;\n  votes: number;\n  candidateCount: number;\n}\n\ninterface CandidateDetails {\n  name: string;\n  nickname: string | null;\n  number: number | null;\n  votes: number;\n  municipality: string | null;\n  state: string | null;\n  position: string | null;\n  result: string | null;\n}\n\ninterface PositionVotes {\n  position: string;\n  votes: number;\n  candidateCount: number;\n  partyCount: number;\n}\n\nfunction formatNumber(num: number): string {\n  if (num >= 1000000000) return (num / 1000000000).toFixed(1) + \"B\";\n  if (num >= 1000000) return (num / 1000000).toFixed(1) + \"M\";\n  if (num >= 1000) return (num / 1000).toFixed(1) + \"K\";\n  return num.toLocaleString(\"pt-BR\");\n}\n\nfunction CustomTooltip({ active, payload, label }: any) {\n  if (!active || !payload || !payload.length) return null;\n  return (\n    <div className=\"bg-background border rounded-lg shadow-lg p-3\">\n      <p className=\"font-semibold text-sm\">{label || payload[0]?.payload?.party || payload[0]?.payload?.state}</p>\n      <p className=\"text-sm\"><span className=\"text-muted-foreground\">Votos:</span> {formatNumber(payload[0]?.value || 0)}</p>\n      {payload[0]?.payload?.percentage !== undefined && (\n        <p className=\"text-sm\"><span className=\"text-muted-foreground\">Percentual:</span> {payload[0].payload.percentage.toFixed(1)}%</p>\n      )}\n    </div>\n  );\n}\n\nfunction Breadcrumbs({ context, onNavigate }: { context: DrillDownContext; onNavigate: (level: DrillDownContext[\"level\"], params?: Partial<DrillDownContext>) => void }) {\n  const items: { level: DrillDownContext[\"level\"]; label: string; icon: typeof Home }[] = [\n    { level: \"overview\", label: \"Visão Geral\", icon: Home },\n  ];\n\n  if (context.state) {\n    items.push({ level: \"state\", label: BRAZIL_STATES[context.state]?.name || context.state, icon: MapPin });\n  }\n  if (context.party) {\n    items.push({ level: \"party\", label: context.party, icon: Building2 });\n  }\n\n  return (\n    <nav className=\"flex items-center gap-1 text-sm\" data-testid=\"breadcrumb-nav\">\n      {items.map((item, index) => (\n        <div key={item.level} className=\"flex items-center\">\n          {index > 0 && <ChevronRight className=\"h-4 w-4 text-muted-foreground mx-1\" />}\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"h-7 px-2 gap-1\"\n            onClick={() => onNavigate(item.level)}\n            data-testid={`breadcrumb-${item.level}`}\n          >\n            <item.icon className=\"h-3 w-3\" />\n            {item.label}\n          </Button>\n        </div>\n      ))}\n    </nav>\n  );\n}\n\nexport default function InteractiveDashboard() {\n  const [context, setContext] = useState<DrillDownContext>({ level: \"overview\" });\n  const [activeTab, setActiveTab] = useState(\"region\");\n\n  const { data: years, isLoading: yearsLoading } = useQuery<number[]>({\n    queryKey: [\"/api/analytics/election-years\"],\n  });\n\n  const { data: positions } = useQuery<string[]>({\n    queryKey: [\"/api/analytics/positions\"],\n  });\n\n  const { data: summary, isLoading: summaryLoading } = useQuery<{\n    totalVotes: number;\n    totalCandidates: number;\n    totalParties: number;\n    totalMunicipalities: number;\n  }>({\n    queryKey: [\"/api/analytics/summary\", context.year, context.state],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (context.year) params.append(\"year\", String(context.year));\n      if (context.state) params.append(\"uf\", context.state);\n      const res = await fetch(`/api/analytics/summary?${params}`);\n      return res.json();\n    },\n  });\n\n  const { data: votesByParty, isLoading: partyLoading } = useQuery<PartyVotes[]>({\n    queryKey: [\"/api/analytics/votes-by-party\", context.year, context.state, context.position],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (context.year) params.append(\"year\", String(context.year));\n      if (context.state) params.append(\"uf\", context.state);\n      if (context.position) params.append(\"position\", context.position);\n      params.append(\"limit\", \"15\");\n      const res = await fetch(`/api/analytics/votes-by-party?${params}`);\n      return res.json();\n    },\n  });\n\n  const { data: votesByState, isLoading: stateLoading } = useQuery<StateVotes[]>({\n    queryKey: [\"/api/analytics/votes-by-state\", context.year],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (context.year) params.append(\"year\", String(context.year));\n      const res = await fetch(`/api/analytics/votes-by-state?${params}`);\n      return res.json();\n    },\n    enabled: !context.state,\n  });\n\n  const { data: votesByMunicipality, isLoading: municipalityLoading } = useQuery<MunicipalityVotes[]>({\n    queryKey: [\"/api/analytics/votes-by-municipality\", context.year, context.state],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (context.year) params.append(\"year\", String(context.year));\n      if (context.state) params.append(\"uf\", context.state);\n      params.append(\"limit\", \"20\");\n      const res = await fetch(`/api/analytics/votes-by-municipality?${params}`);\n      return res.json();\n    },\n    enabled: !!context.state,\n  });\n\n  const { data: candidatesByParty, isLoading: candidatesLoading } = useQuery<CandidateDetails[]>({\n    queryKey: [\"/api/analytics/drill-down/candidates-by-party\", context.year, context.state, context.party, context.position],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (context.year) params.append(\"year\", String(context.year));\n      if (context.state) params.append(\"uf\", context.state);\n      if (context.party) params.append(\"party\", context.party);\n      if (context.position) params.append(\"position\", context.position);\n      params.append(\"limit\", \"50\");\n      const res = await fetch(`/api/analytics/drill-down/candidates-by-party?${params}`);\n      return res.json();\n    },\n    enabled: !!context.party,\n  });\n\n  const { data: votesByPosition, isLoading: positionLoading } = useQuery<PositionVotes[]>({\n    queryKey: [\"/api/analytics/drill-down/votes-by-position\", context.year, context.state],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (context.year) params.append(\"year\", String(context.year));\n      if (context.state) params.append(\"uf\", context.state);\n      const res = await fetch(`/api/analytics/drill-down/votes-by-position?${params}`);\n      return res.json();\n    },\n  });\n\n  const { data: partyByState, isLoading: partyByStateLoading } = useQuery<{\n    state: string;\n    party: string;\n    votes: number;\n    candidateCount: number;\n    percentage: number;\n  }[]>({\n    queryKey: [\"/api/analytics/drill-down/party-by-state\", context.year, context.party, context.position],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (context.year) params.append(\"year\", String(context.year));\n      if (context.party) params.append(\"party\", context.party);\n      if (context.position) params.append(\"position\", context.position);\n      const res = await fetch(`/api/analytics/drill-down/party-by-state?${params}`);\n      return res.json();\n    },\n    enabled: !!context.party,\n  });\n\n  const stateVotesMap = useMemo(() => {\n    const map: Record<string, number> = {};\n    votesByState?.forEach(s => { map[s.state] = s.votes; });\n    return map;\n  }, [votesByState]);\n\n  const maxStateVotes = useMemo(() => {\n    return Math.max(...(votesByState?.map(s => s.votes) || [1]));\n  }, [votesByState]);\n\n  const getStateColor = (stateCode: string) => {\n    const votes = stateVotesMap[stateCode] || 0;\n    if (votes === 0) return \"hsl(var(--muted))\";\n    const intensity = Math.min(votes / maxStateVotes, 1);\n    return `hsl(210, 80%, ${70 - intensity * 40}%)`;\n  };\n\n  const handleStateClick = (stateCode: string) => {\n    setContext(prev => ({ ...prev, level: \"state\", state: stateCode }));\n    setActiveTab(\"region\");\n  };\n\n  const handlePartyClick = (party: string) => {\n    setContext(prev => ({ ...prev, level: \"party\", party }));\n    setActiveTab(\"party\");\n  };\n\n  const handleBreadcrumbNavigate = (level: DrillDownContext[\"level\"]) => {\n    switch (level) {\n      case \"overview\":\n        setContext({ level: \"overview\", year: context.year, position: context.position });\n        break;\n      case \"state\":\n        setContext({ level: \"state\", year: context.year, state: context.state, position: context.position });\n        break;\n    }\n  };\n\n  const hasData = (summary?.totalVotes ?? 0) > 0;\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n        <div className=\"flex items-center gap-3\">\n          <BarChart3 className=\"h-8 w-8\" style={{ color: \"#003366\" }} />\n          <div>\n            <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">Painel Interativo</h1>\n            <p className=\"text-muted-foreground\" data-testid=\"text-page-description\">\n              Explore dados eleitorais com visualizações interativas\n            </p>\n          </div>\n        </div>\n\n        <div className=\"flex flex-wrap items-center gap-3\">\n          <Select\n            value={context.year?.toString() || \"all\"}\n            onValueChange={(v) => setContext(prev => ({ ...prev, year: v === \"all\" ? undefined : parseInt(v) }))}\n          >\n            <SelectTrigger className=\"w-[130px]\" data-testid=\"select-year\">\n              <SelectValue placeholder=\"Ano\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\" data-testid=\"option-year-all\">Todos os anos</SelectItem>\n              {years?.map((year) => (\n                <SelectItem key={year} value={String(year)} data-testid={`option-year-${year}`}>\n                  {year}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n\n          <Select\n            value={context.position || \"all\"}\n            onValueChange={(v) => setContext(prev => ({ ...prev, position: v === \"all\" ? undefined : v }))}\n          >\n            <SelectTrigger className=\"w-[180px]\" data-testid=\"select-position\">\n              <SelectValue placeholder=\"Cargo\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\" data-testid=\"option-position-all\">Todos os cargos</SelectItem>\n              {positions?.map((pos) => (\n                <SelectItem key={pos} value={pos} data-testid={`option-position-${pos}`}>\n                  {pos}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n\n          {(context.state || context.party) && (\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setContext({ level: \"overview\", year: context.year, position: context.position })}\n              data-testid=\"button-clear-filters\"\n            >\n              <X className=\"h-4 w-4 mr-1\" />\n              Limpar seleção\n            </Button>\n          )}\n        </div>\n      </div>\n\n      <Breadcrumbs context={context} onNavigate={handleBreadcrumbNavigate} />\n\n      {summaryLoading ? (\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n          {[...Array(4)].map((_, i) => (\n            <Skeleton key={i} className=\"h-24\" />\n          ))}\n        </div>\n      ) : (\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n          <Card data-testid=\"card-total-votes\">\n            <CardContent className=\"pt-4\">\n              <div className=\"flex items-center gap-3\">\n                <Vote className=\"h-8 w-8 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-votes\">{formatNumber(summary?.totalVotes || 0)}</p>\n                  <p className=\"text-xs text-muted-foreground\">Votos Totais</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-total-candidates\">\n            <CardContent className=\"pt-4\">\n              <div className=\"flex items-center gap-3\">\n                <Users className=\"h-8 w-8 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-candidates\">{formatNumber(summary?.totalCandidates || 0)}</p>\n                  <p className=\"text-xs text-muted-foreground\">Candidatos</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-total-parties\">\n            <CardContent className=\"pt-4\">\n              <div className=\"flex items-center gap-3\">\n                <Building2 className=\"h-8 w-8 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-parties\">{formatNumber(summary?.totalParties || 0)}</p>\n                  <p className=\"text-xs text-muted-foreground\">Partidos</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-total-municipalities\">\n            <CardContent className=\"pt-4\">\n              <div className=\"flex items-center gap-3\">\n                <MapPin className=\"h-8 w-8 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-municipalities\">{formatNumber(summary?.totalMunicipalities || 0)}</p>\n                  <p className=\"text-xs text-muted-foreground\">Municípios</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-4\">\n          <TabsList className=\"grid w-full grid-cols-3\" data-testid=\"tabs-navigation\">\n            <TabsTrigger value=\"region\" className=\"gap-2\" data-testid=\"tab-region\">\n              <Map className=\"h-4 w-4\" />\n              Por Região\n            </TabsTrigger>\n            <TabsTrigger value=\"party\" className=\"gap-2\" data-testid=\"tab-party\">\n              <Building2 className=\"h-4 w-4\" />\n              Por Partido\n            </TabsTrigger>\n            <TabsTrigger value=\"position\" className=\"gap-2\" data-testid=\"tab-position\">\n              <Award className=\"h-4 w-4\" />\n              Por Cargo\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"region\" className=\"space-y-4\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              {!context.state ? (\n                <Card data-testid=\"card-brazil-map\">\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Map className=\"h-5 w-5\" />\n                      Mapa do Brasil\n                    </CardTitle>\n                    <CardDescription>Clique em um estado para ver detalhes</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    {stateLoading ? (\n                      <Skeleton className=\"h-[400px]\" />\n                    ) : (\n                      <svg viewBox=\"0 0 600 620\" className=\"w-full h-auto max-h-[400px]\">\n                        {Object.entries(BRAZIL_STATES).map(([code, state]) => (\n                          <g \n                            key={code} \n                            className=\"cursor-pointer transition-all hover:brightness-110\"\n                            onClick={() => handleStateClick(code)}\n                            data-testid={`state-${code}`}\n                          >\n                            <path\n                              d={state.path}\n                              fill={getStateColor(code)}\n                              stroke=\"hsl(var(--border))\"\n                              strokeWidth=\"1\"\n                            />\n                            <text\n                              x={state.cx}\n                              y={state.cy}\n                              textAnchor=\"middle\"\n                              dominantBaseline=\"middle\"\n                              className=\"text-[8px] font-medium fill-foreground pointer-events-none\"\n                            >\n                              {code}\n                            </text>\n                          </g>\n                        ))}\n                      </svg>\n                    )}\n                  </CardContent>\n                </Card>\n              ) : (\n                <Card data-testid=\"card-municipality-chart\">\n                  <CardHeader>\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <CardTitle className=\"flex items-center gap-2\">\n                          <MapPin className=\"h-5 w-5\" />\n                          {BRAZIL_STATES[context.state]?.name || context.state}\n                        </CardTitle>\n                        <CardDescription>Municípios mais votados</CardDescription>\n                      </div>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => setContext(prev => ({ ...prev, level: \"overview\", state: undefined }))}\n                        data-testid=\"button-back-to-map\"\n                      >\n                        <ArrowLeft className=\"h-4 w-4 mr-1\" />\n                        Voltar ao mapa\n                      </Button>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    {municipalityLoading ? (\n                      <Skeleton className=\"h-[350px]\" />\n                    ) : (\n                      <ResponsiveContainer width=\"100%\" height={350}>\n                        <BarChart data={votesByMunicipality?.slice(0, 10)} layout=\"vertical\">\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis type=\"number\" tickFormatter={formatNumber} />\n                          <YAxis dataKey=\"municipality\" type=\"category\" width={120} tick={{ fontSize: 11 }} />\n                          <RechartsTooltip content={<CustomTooltip />} />\n                          <Bar dataKey=\"votes\" fill=\"#003366\" radius={[0, 4, 4, 0]} />\n                        </BarChart>\n                      </ResponsiveContainer>\n                    )}\n                  </CardContent>\n                </Card>\n              )}\n\n              <Card data-testid=\"card-state-ranking\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <TrendingUp className=\"h-5 w-5\" />\n                    {context.state ? \"Ranking do Estado\" : \"Ranking Nacional\"}\n                  </CardTitle>\n                  <CardDescription>\n                    {context.state ? \"Municípios com mais votos\" : \"Estados com mais votos\"}\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <ScrollArea className=\"h-[350px]\">\n                    {(context.state ? votesByMunicipality : votesByState)?.map((item: any, index: number) => (\n                      <div\n                        key={item.state || item.municipality}\n                        className=\"flex items-center justify-between py-2 border-b last:border-0 cursor-pointer hover:bg-muted/50 px-2 rounded\"\n                        onClick={() => !context.state && handleStateClick(item.state)}\n                        data-testid={`ranking-item-${index}`}\n                      >\n                        <div className=\"flex items-center gap-3\">\n                          <span className=\"text-sm font-medium text-muted-foreground w-6\">\n                            {index + 1}.\n                          </span>\n                          <div>\n                            <p className=\"font-medium text-sm\">\n                              {context.state ? item.municipality : (BRAZIL_STATES[item.state]?.name || item.state)}\n                            </p>\n                            <p className=\"text-xs text-muted-foreground\">\n                              {formatNumber(item.candidateCount)} candidatos\n                            </p>\n                          </div>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"font-semibold\">{formatNumber(item.votes)}</p>\n                          <p className=\"text-xs text-muted-foreground\">votos</p>\n                        </div>\n                      </div>\n                    ))}\n                  </ScrollArea>\n                </CardContent>\n              </Card>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"party\" className=\"space-y-4\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              {!context.party ? (\n                <>\n                  <Card data-testid=\"card-party-pie\">\n                    <CardHeader>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <PieChartIcon className=\"h-5 w-5\" />\n                        Distribuição de Votos por Partido\n                      </CardTitle>\n                      <CardDescription>Clique em um partido para ver candidatos</CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                      {partyLoading ? (\n                        <Skeleton className=\"h-[350px]\" />\n                      ) : (\n                        <ResponsiveContainer width=\"100%\" height={350}>\n                          <PieChart>\n                            <Pie\n                              data={votesByParty?.slice(0, 10)}\n                              dataKey=\"votes\"\n                              nameKey=\"party\"\n                              cx=\"50%\"\n                              cy=\"50%\"\n                              outerRadius={120}\n                              onClick={(data) => handlePartyClick(data.party)}\n                              className=\"cursor-pointer\"\n                            >\n                              {votesByParty?.slice(0, 10).map((entry, index) => (\n                                <Cell key={entry.party} fill={CHART_COLORS[index % CHART_COLORS.length]} />\n                              ))}\n                            </Pie>\n                            <RechartsTooltip content={<CustomTooltip />} />\n                            <Legend />\n                          </PieChart>\n                        </ResponsiveContainer>\n                      )}\n                    </CardContent>\n                  </Card>\n\n                  <Card data-testid=\"card-party-bar\">\n                    <CardHeader>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <BarChart3 className=\"h-5 w-5\" />\n                        Top 15 Partidos\n                      </CardTitle>\n                      <CardDescription>Ordenado por total de votos</CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                      {partyLoading ? (\n                        <Skeleton className=\"h-[350px]\" />\n                      ) : (\n                        <ResponsiveContainer width=\"100%\" height={350}>\n                          <BarChart data={votesByParty?.slice(0, 15)} layout=\"vertical\">\n                            <CartesianGrid strokeDasharray=\"3 3\" />\n                            <XAxis type=\"number\" tickFormatter={formatNumber} />\n                            <YAxis dataKey=\"party\" type=\"category\" width={60} tick={{ fontSize: 10 }} />\n                            <RechartsTooltip content={<CustomTooltip />} />\n                            <Bar \n                              dataKey=\"votes\" \n                              radius={[0, 4, 4, 0]}\n                              onClick={(data) => handlePartyClick(data.party)}\n                              className=\"cursor-pointer\"\n                            >\n                              {votesByParty?.slice(0, 15).map((entry, index) => (\n                                <Cell key={entry.party} fill={CHART_COLORS[index % CHART_COLORS.length]} />\n                              ))}\n                            </Bar>\n                          </BarChart>\n                        </ResponsiveContainer>\n                      )}\n                    </CardContent>\n                  </Card>\n                </>\n              ) : (\n                <>\n                <Card className=\"lg:col-span-2\" data-testid=\"card-party-candidates\">\n                  <CardHeader>\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <CardTitle className=\"flex items-center gap-2\">\n                          <Users className=\"h-5 w-5\" />\n                          Candidatos do {context.party}\n                        </CardTitle>\n                        <CardDescription>\n                          {candidatesByParty?.length || 0} candidatos encontrados\n                          {context.state && ` em ${BRAZIL_STATES[context.state]?.name || context.state}`}\n                        </CardDescription>\n                      </div>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => setContext(prev => ({ ...prev, level: \"state\", party: undefined }))}\n                        data-testid=\"button-back-to-parties\"\n                      >\n                        <ArrowLeft className=\"h-4 w-4 mr-1\" />\n                        Voltar aos partidos\n                      </Button>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    {candidatesLoading ? (\n                      <div className=\"space-y-2\">\n                        {[...Array(10)].map((_, i) => <Skeleton key={i} className=\"h-12\" />)}\n                      </div>\n                    ) : (\n                      <ScrollArea className=\"h-[500px]\">\n                        <div className=\"space-y-2\">\n                          {candidatesByParty?.map((candidate, index) => (\n                            <div\n                              key={`${candidate.name}-${index}`}\n                              className=\"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50\"\n                              data-testid={`candidate-row-${index}`}\n                            >\n                              <div className=\"flex items-center gap-4\">\n                                <span className=\"text-lg font-bold text-muted-foreground w-8\">\n                                  {index + 1}\n                                </span>\n                                <div>\n                                  <p className=\"font-medium\">{candidate.nickname || candidate.name}</p>\n                                  <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                                    {candidate.number && <Badge variant=\"outline\">{candidate.number}</Badge>}\n                                    {candidate.position && <span>{candidate.position}</span>}\n                                    {candidate.municipality && <span>• {candidate.municipality}</span>}\n                                  </div>\n                                </div>\n                              </div>\n                              <div className=\"text-right\">\n                                <p className=\"text-lg font-bold\">{formatNumber(candidate.votes)}</p>\n                                {candidate.result && (\n                                  <Badge \n                                    variant={candidate.result.includes(\"ELEIT\") ? \"default\" : \"secondary\"}\n                                    className=\"text-xs\"\n                                  >\n                                    {candidate.result}\n                                  </Badge>\n                                )}\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </ScrollArea>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-party-by-state\">\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Map className=\"h-5 w-5\" />\n                      Desempenho do {context.party} por Estado\n                    </CardTitle>\n                    <CardDescription>Votos e percentual em cada estado</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    {partyByStateLoading ? (\n                      <Skeleton className=\"h-[300px]\" />\n                    ) : partyByState && partyByState.length > 0 ? (\n                      <ResponsiveContainer width=\"100%\" height={300}>\n                        <BarChart data={partyByState.slice(0, 15)} layout=\"vertical\">\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis type=\"number\" tickFormatter={formatNumber} />\n                          <YAxis dataKey=\"state\" type=\"category\" width={40} tick={{ fontSize: 10 }} />\n                          <RechartsTooltip content={<CustomTooltip />} />\n                          <Bar dataKey=\"votes\" fill=\"#003366\" radius={[0, 4, 4, 0]} />\n                        </BarChart>\n                      </ResponsiveContainer>\n                    ) : (\n                      <div className=\"flex flex-col items-center justify-center h-[300px] text-muted-foreground\">\n                        <Map className=\"h-8 w-8 mb-2 opacity-50\" />\n                        <p className=\"text-sm\">Nenhum dado por estado disponível</p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n                </>\n              )}\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"position\" className=\"space-y-4\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              <Card data-testid=\"card-position-chart\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Award className=\"h-5 w-5\" />\n                    Votos por Cargo\n                  </CardTitle>\n                  <CardDescription>Distribuição de votos entre diferentes cargos</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {positionLoading ? (\n                    <Skeleton className=\"h-[350px]\" />\n                  ) : (\n                    <ResponsiveContainer width=\"100%\" height={350}>\n                      <BarChart data={votesByPosition} layout=\"vertical\">\n                        <CartesianGrid strokeDasharray=\"3 3\" />\n                        <XAxis type=\"number\" tickFormatter={formatNumber} />\n                        <YAxis dataKey=\"position\" type=\"category\" width={140} tick={{ fontSize: 10 }} />\n                        <RechartsTooltip content={<CustomTooltip />} />\n                        <Bar dataKey=\"votes\" radius={[0, 4, 4, 0]}>\n                          {votesByPosition?.map((entry, index) => (\n                            <Cell key={entry.position} fill={CHART_COLORS[index % CHART_COLORS.length]} />\n                          ))}\n                        </Bar>\n                      </BarChart>\n                    </ResponsiveContainer>\n                  )}\n                </CardContent>\n              </Card>\n\n              <Card data-testid=\"card-position-details\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <TrendingUp className=\"h-5 w-5\" />\n                    Detalhes por Cargo\n                  </CardTitle>\n                  <CardDescription>Candidatos e partidos por cargo</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <ScrollArea className=\"h-[350px]\">\n                    {votesByPosition?.map((pos, index) => (\n                      <div\n                        key={pos.position}\n                        className=\"flex items-center justify-between py-3 border-b last:border-0 cursor-pointer hover:bg-muted/50 px-2 rounded\"\n                        onClick={() => setContext(prev => ({ ...prev, position: pos.position }))}\n                        data-testid={`position-row-${index}`}\n                      >\n                        <div>\n                          <p className=\"font-medium\">{pos.position}</p>\n                          <div className=\"flex gap-3 text-xs text-muted-foreground\">\n                            <span>{formatNumber(pos.candidateCount)} candidatos</span>\n                            <span>{pos.partyCount} partidos</span>\n                          </div>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"font-semibold\">{formatNumber(pos.votes)}</p>\n                          <p className=\"text-xs text-muted-foreground\">votos</p>\n                        </div>\n                      </div>\n                    ))}\n                  </ScrollArea>\n                </CardContent>\n              </Card>\n            </div>\n          </TabsContent>\n        </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":37807,"size_tokens":null},"client/src/pages/scenario-candidates.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useParams, Link } from \"wouter\";\nimport { Plus, Trash2, Users, Search, Database, Loader2, ArrowLeft } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { DataTable } from \"@/components/data-table\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Scenario, Candidate, Party, ScenarioCandidate } from \"@shared/schema\";\n\ntype ScenarioCandidateWithDetails = ScenarioCandidate & {\n  candidate: Candidate;\n  party: Party;\n};\n\ntype TseCandidate = {\n  nmCandidato: string | null;\n  nmUrnaCandidato: string | null;\n  nrCandidato: number | null;\n  sgPartido: string | null;\n  nmPartido: string | null;\n  nrPartido: number | null;\n  anoEleicao: number | null;\n  sgUf: string | null;\n  dsCargo: string | null;\n  qtVotosNominais: number | null;\n};\n\ntype TseStats = {\n  totalRecords: number;\n  years: number[];\n  ufs: string[];\n  cargos: { code: number; name: string }[];\n};\n\nexport default function ScenarioCandidates() {\n  const { scenarioId } = useParams<{ scenarioId: string }>();\n  const { hasPermission } = useAuth();\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [deleteConfirmId, setDeleteConfirmId] = useState<number | null>(null);\n\n  const [tseSearchQuery, setTseSearchQuery] = useState(\"\");\n  const [tseSearchResults, setTseSearchResults] = useState<TseCandidate[]>([]);\n  const [isTseSearching, setIsTseSearching] = useState(false);\n  const [showTseResults, setShowTseResults] = useState(false);\n  const [selectedYear, setSelectedYear] = useState<string>(\"\");\n\n  const [formData, setFormData] = useState({\n    candidateId: \"\",\n    partyId: \"\",\n    ballotNumber: \"\",\n    nickname: \"\",\n    votes: \"0\",\n  });\n\n  const { data: scenario } = useQuery<Scenario>({\n    queryKey: [\"/api/scenarios\", scenarioId],\n    enabled: !!scenarioId,\n  });\n\n  const { data: scenarioCandidates, isLoading } = useQuery<ScenarioCandidateWithDetails[]>({\n    queryKey: [\"/api/scenarios\", scenarioId, \"candidates\"],\n    enabled: !!scenarioId,\n  });\n\n  const { data: allCandidates } = useQuery<Candidate[]>({\n    queryKey: [\"/api/candidates\"],\n  });\n\n  const { data: parties } = useQuery<Party[]>({\n    queryKey: [\"/api/parties\"],\n  });\n\n  const { data: tseStats } = useQuery<TseStats>({\n    queryKey: [\"/api/tse/stats\"],\n  });\n\n  const addMutation = useMutation({\n    mutationFn: async (data: { candidateId: number; partyId: number; ballotNumber: number; nickname?: string; votes?: number }) => {\n      return apiRequest(\"POST\", `/api/scenarios/${scenarioId}/candidates`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenarios\", scenarioId, \"candidates\"] });\n      toast({ title: \"Sucesso\", description: \"Candidato adicionado ao cenário\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao adicionar candidato ao cenário\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: { votes?: number; status?: string } }) => {\n      return apiRequest(\"PUT\", `/api/scenario-candidates/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenarios\", scenarioId, \"candidates\"] });\n      toast({ title: \"Sucesso\", description: \"Candidato atualizado\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar candidato\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/scenario-candidates/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scenarios\", scenarioId, \"candidates\"] });\n      toast({ title: \"Sucesso\", description: \"Candidato removido do cenário\" });\n      setDeleteConfirmId(null);\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao remover candidato\", variant: \"destructive\" });\n    },\n  });\n\n  const searchTseCandidates = useCallback(async (query: string, year?: string) => {\n    if (query.length < 2) {\n      setTseSearchResults([]);\n      setShowTseResults(false);\n      return;\n    }\n    setIsTseSearching(true);\n    try {\n      const params = new URLSearchParams({ q: query });\n      if (year) params.append(\"year\", year);\n      const res = await fetch(`/api/tse/search?${params.toString()}`, { credentials: \"include\" });\n      if (res.ok) {\n        const results = await res.json();\n        setTseSearchResults(results);\n        setShowTseResults(true);\n      }\n    } catch (error) {\n      console.error(\"TSE search error:\", error);\n    } finally {\n      setIsTseSearching(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    const debounce = setTimeout(() => {\n      if (tseSearchQuery.length >= 2) {\n        const yearFilter = selectedYear && selectedYear !== \"all\" ? selectedYear : undefined;\n        searchTseCandidates(tseSearchQuery, yearFilter);\n      } else {\n        setTseSearchResults([]);\n        setShowTseResults(false);\n      }\n    }, 300);\n    return () => clearTimeout(debounce);\n  }, [tseSearchQuery, selectedYear, searchTseCandidates]);\n\n  async function selectTseCandidate(tse: TseCandidate) {\n    const matchingParty = parties?.find(\n      (p) => p.abbreviation === tse.sgPartido || p.number === tse.nrPartido\n    );\n\n    let matchingCandidate = allCandidates?.find(\n      (c) => c.number === tse.nrCandidato || c.name === tse.nmCandidato\n    );\n\n    if (!matchingCandidate && matchingParty) {\n      try {\n        const res = await apiRequest(\"POST\", \"/api/candidates\", {\n          name: tse.nmCandidato || \"\",\n          nickname: tse.nmUrnaCandidato || null,\n          number: tse.nrCandidato || 0,\n          partyId: matchingParty.id,\n          position: scenario?.position || \"vereador\",\n        });\n        const newCandidate = await res.json();\n        matchingCandidate = newCandidate;\n        queryClient.invalidateQueries({ queryKey: [\"/api/candidates\"] });\n      } catch {\n        toast({ title: \"Erro\", description: \"Falha ao criar candidato\", variant: \"destructive\" });\n        return;\n      }\n    }\n\n    if (matchingCandidate && matchingParty) {\n      // Os votos já vêm somados do backend (agregado por candidato/ano)\n      const totalVotes = tse.qtVotosNominais || 0;\n\n      setFormData({\n        candidateId: String(matchingCandidate.id),\n        partyId: String(matchingParty.id),\n        ballotNumber: String(tse.nrCandidato || matchingCandidate.number),\n        nickname: tse.nmUrnaCandidato || \"\",\n        votes: String(totalVotes),\n      });\n      toast({\n        title: \"Dados importados\",\n        description: `Candidato ${tse.nmUrnaCandidato || tse.nmCandidato} selecionado com ${totalVotes.toLocaleString(\"pt-BR\")} votos em ${tse.anoEleicao}`,\n      });\n    } else {\n      toast({\n        title: \"Partido não encontrado\",\n        description: `O partido ${tse.sgPartido} não está cadastrado. Cadastre-o primeiro.`,\n        variant: \"destructive\",\n      });\n    }\n    setShowTseResults(false);\n    setTseSearchQuery(\"\");\n  }\n\n  function resetForm() {\n    setFormData({\n      candidateId: \"\",\n      partyId: \"\",\n      ballotNumber: \"\",\n      nickname: \"\",\n      votes: \"0\",\n    });\n    setIsDialogOpen(false);\n    setTseSearchQuery(\"\");\n    setTseSearchResults([]);\n    setShowTseResults(false);\n    setSelectedYear(\"\");\n  }\n\n  function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    addMutation.mutate({\n      candidateId: parseInt(formData.candidateId, 10),\n      partyId: parseInt(formData.partyId, 10),\n      ballotNumber: parseInt(formData.ballotNumber, 10),\n      nickname: formData.nickname || undefined,\n      votes: parseInt(formData.votes, 10) || 0,\n    });\n  }\n\n  const columns = [\n    {\n      key: \"ballotNumber\",\n      header: \"Número\",\n      sortable: true,\n      className: \"w-24\",\n      cell: (sc: ScenarioCandidateWithDetails) => (\n        <span className=\"font-mono font-bold text-lg\">{sc.ballotNumber}</span>\n      ),\n    },\n    {\n      key: \"name\",\n      header: \"Candidato\",\n      sortable: true,\n      cell: (sc: ScenarioCandidateWithDetails) => (\n        <div className=\"flex items-center gap-3\">\n          <Avatar className=\"h-9 w-9\">\n            <AvatarFallback className=\"bg-primary/10 text-primary text-sm\">\n              {sc.candidate.name.split(\" \").map((n) => n[0]).join(\"\").slice(0, 2).toUpperCase()}\n            </AvatarFallback>\n          </Avatar>\n          <div className=\"flex flex-col\">\n            <span className=\"font-medium\">{sc.nickname || sc.candidate.nickname || sc.candidate.name}</span>\n            {(sc.nickname || sc.candidate.nickname) && (\n              <span className=\"text-sm text-muted-foreground\">{sc.candidate.name}</span>\n            )}\n          </div>\n        </div>\n      ),\n    },\n    {\n      key: \"party\",\n      header: \"Partido\",\n      cell: (sc: ScenarioCandidateWithDetails) => (\n        <div className=\"flex items-center gap-2\">\n          <div\n            className=\"w-3 h-3 rounded-full shrink-0\"\n            style={{ backgroundColor: sc.party.color }}\n          />\n          <Badge variant=\"outline\">{sc.party.abbreviation}</Badge>\n        </div>\n      ),\n    },\n    {\n      key: \"votes\",\n      header: \"Votos\",\n      sortable: true,\n      cell: (sc: ScenarioCandidateWithDetails) => (\n        <Input\n          type=\"number\"\n          value={sc.votes}\n          onChange={(e) => {\n            const newVotes = parseInt(e.target.value, 10) || 0;\n            updateMutation.mutate({ id: sc.id, data: { votes: newVotes } });\n          }}\n          className=\"w-28 font-mono\"\n          data-testid={`input-votes-${sc.id}`}\n        />\n      ),\n    },\n    {\n      key: \"status\",\n      header: \"Status\",\n      cell: (sc: ScenarioCandidateWithDetails) => (\n        <Badge variant={sc.status === \"active\" ? \"default\" : \"secondary\"}>\n          {sc.status === \"active\" ? \"Ativo\" : \"Inativo\"}\n        </Badge>\n      ),\n    },\n    {\n      key: \"actions\",\n      header: \"Ações\",\n      className: \"w-16\",\n      cell: (sc: ScenarioCandidateWithDetails) => (\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => setDeleteConfirmId(sc.id)}\n          disabled={!hasPermission(\"manage_scenarios\")}\n          data-testid={`button-delete-sc-${sc.id}`}\n        >\n          <Trash2 className=\"h-4 w-4 text-destructive\" />\n        </Button>\n      ),\n    },\n  ];\n\n  const availableCandidates = allCandidates?.filter(\n    (c) => !scenarioCandidates?.some((sc) => sc.candidateId === c.id)\n  );\n\n  return (\n    <div className=\"space-y-6\">\n      <PageHeader\n        title={`Candidatos: ${scenario?.name || \"...\"}`}\n        description=\"Gerencie os candidatos que participam deste cenário eleitoral\"\n        breadcrumbs={[\n          { label: \"Dashboard\", href: \"/\" },\n          { label: \"Cenários\", href: \"/scenarios\" },\n          { label: scenario?.name || \"...\", href: `/scenarios` },\n          { label: \"Candidatos\" },\n        ]}\n        action={\n          hasPermission(\"manage_scenarios\")\n            ? {\n                label: \"Adicionar Candidato\",\n                icon: <Plus className=\"h-4 w-4 mr-2\" />,\n                onClick: () => setIsDialogOpen(true),\n              }\n            : undefined\n        }\n      />\n\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Link href=\"/scenarios\">\n          <Button variant=\"outline\" size=\"sm\">\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Voltar aos Cenários\n          </Button>\n        </Link>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Users className=\"h-5 w-5\" />\n            Candidatos do Cenário\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {!isLoading && (!scenarioCandidates || scenarioCandidates.length === 0) ? (\n            <EmptyState\n              icon={Users}\n              title=\"Nenhum candidato neste cenário\"\n              description=\"Adicione candidatos ao cenário para configurar a simulação eleitoral. Você pode importar dados do TSE.\"\n              actionLabel={hasPermission(\"manage_scenarios\") ? \"Adicionar Candidato\" : undefined}\n              onAction={hasPermission(\"manage_scenarios\") ? () => setIsDialogOpen(true) : undefined}\n            />\n          ) : (\n            <DataTable\n              data={scenarioCandidates || []}\n              columns={columns}\n              isLoading={isLoading}\n              searchable\n              searchKeys={[\"candidate.name\", \"candidate.nickname\", \"nickname\"]}\n              pageSize={10}\n              emptyMessage=\"Nenhum candidato encontrado\"\n            />\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={isDialogOpen} onOpenChange={(open) => !open && resetForm()}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Adicionar Candidato ao Cenário</DialogTitle>\n            <DialogDescription>\n              Busque nos dados do TSE ou selecione um candidato já cadastrado\n            </DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label className=\"flex items-center gap-2\">\n                <Database className=\"h-4 w-4\" />\n                Buscar nos Dados do TSE\n              </Label>\n              <div className=\"flex gap-2\">\n                <Select\n                  value={selectedYear}\n                  onValueChange={setSelectedYear}\n                >\n                  <SelectTrigger className=\"w-32\" data-testid=\"select-tse-year\">\n                    <SelectValue placeholder=\"Ano\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos os anos</SelectItem>\n                    {(tseStats?.years ?? []).map((year) => (\n                      <SelectItem key={year} value={String(year)}>\n                        {year}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <div className=\"relative flex-1\">\n                  <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Digite o nome do candidato...\"\n                    value={tseSearchQuery}\n                    onChange={(e) => setTseSearchQuery(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-tse-search-scenario\"\n                  />\n                  {isTseSearching && (\n                    <Loader2 className=\"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground\" />\n                  )}\n                </div>\n              </div>\n              {showTseResults && tseSearchResults.length > 0 && (\n                <Card className=\"border shadow-md\">\n                  <ScrollArea className=\"max-h-48\">\n                    <div className=\"p-1\">\n                      {tseSearchResults.map((tse, idx) => (\n                        <button\n                          key={`${tse.nrCandidato}-${tse.anoEleicao}-${idx}`}\n                          type=\"button\"\n                          onClick={() => selectTseCandidate(tse)}\n                          className=\"w-full text-left p-2 rounded-md hover-elevate flex flex-col gap-1\"\n                          data-testid={`tse-result-sc-${idx}`}\n                        >\n                          <div className=\"flex items-center justify-between gap-2\">\n                            <span className=\"font-medium text-sm\">\n                              {tse.nmUrnaCandidato || tse.nmCandidato}\n                            </span>\n                            <Badge variant=\"outline\" className=\"text-xs shrink-0\">\n                              {tse.nrCandidato}\n                            </Badge>\n                          </div>\n                          <div className=\"flex items-center gap-2 text-xs text-muted-foreground flex-wrap\">\n                            <span>{tse.sgPartido}</span>\n                            <span>-</span>\n                            <span>{tse.dsCargo}</span>\n                            <span>-</span>\n                            <span>{tse.sgUf} {tse.anoEleicao}</span>\n                            {tse.qtVotosNominais && (\n                              <>\n                                <span>-</span>\n                                <span>{tse.qtVotosNominais.toLocaleString(\"pt-BR\")} votos</span>\n                              </>\n                            )}\n                          </div>\n                        </button>\n                      ))}\n                    </div>\n                  </ScrollArea>\n                </Card>\n              )}\n              {showTseResults && tseSearchResults.length === 0 && tseSearchQuery.length >= 2 && !isTseSearching && (\n                <p className=\"text-sm text-muted-foreground\">\n                  Nenhum candidato encontrado nos dados importados do TSE.\n                </p>\n              )}\n            </div>\n\n            <div className=\"border-t pt-4 space-y-4\">\n              <Label>Ou selecione um candidato já cadastrado:</Label>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"candidateId\">Candidato</Label>\n                  <Select\n                    value={formData.candidateId}\n                    onValueChange={(v) => {\n                      const candidate = allCandidates?.find((c) => c.id === parseInt(v));\n                      setFormData((f) => ({\n                        ...f,\n                        candidateId: v,\n                        partyId: candidate ? String(candidate.partyId) : f.partyId,\n                        ballotNumber: candidate ? String(candidate.number) : f.ballotNumber,\n                        nickname: candidate?.nickname || \"\",\n                      }));\n                    }}\n                  >\n                    <SelectTrigger data-testid=\"select-candidate\">\n                      <SelectValue placeholder=\"Selecione\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {availableCandidates?.map((c) => (\n                        <SelectItem key={c.id} value={String(c.id)}>\n                          {c.nickname || c.name} ({c.number})\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"partyId\">Partido</Label>\n                  <Select\n                    value={formData.partyId}\n                    onValueChange={(v) => setFormData((f) => ({ ...f, partyId: v }))}\n                  >\n                    <SelectTrigger data-testid=\"select-party\">\n                      <SelectValue placeholder=\"Selecione\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {parties?.map((party) => (\n                        <SelectItem key={party.id} value={String(party.id)}>\n                          <div className=\"flex items-center gap-2\">\n                            <div\n                              className=\"w-2 h-2 rounded-full\"\n                              style={{ backgroundColor: party.color }}\n                            />\n                            {party.abbreviation}\n                          </div>\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"ballotNumber\">Número na Urna</Label>\n                  <Input\n                    id=\"ballotNumber\"\n                    type=\"number\"\n                    placeholder=\"Ex: 13123\"\n                    value={formData.ballotNumber}\n                    onChange={(e) => setFormData((f) => ({ ...f, ballotNumber: e.target.value }))}\n                    required\n                    className=\"font-mono\"\n                    data-testid=\"input-ballot-number\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"nickname\">Nome de Urna</Label>\n                  <Input\n                    id=\"nickname\"\n                    placeholder=\"Ex: João Silva\"\n                    value={formData.nickname}\n                    onChange={(e) => setFormData((f) => ({ ...f, nickname: e.target.value }))}\n                    data-testid=\"input-nickname\"\n                  />\n                </div>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button type=\"button\" variant=\"outline\" onClick={resetForm}>\n                Cancelar\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={addMutation.isPending || !formData.candidateId || !formData.partyId || !formData.ballotNumber}\n                data-testid=\"button-save-scenario-candidate\"\n              >\n                Adicionar\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={deleteConfirmId !== null} onOpenChange={() => setDeleteConfirmId(null)}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Confirmar Remoção</DialogTitle>\n            <DialogDescription>\n              Tem certeza que deseja remover este candidato do cenário? Isso não exclui o candidato do sistema.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeleteConfirmId(null)}>\n              Cancelar\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deleteConfirmId && deleteMutation.mutate(deleteConfirmId)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete-sc\"\n            >\n              Remover\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":23354,"size_tokens":null},"client/replit_integrations/audio/index.ts":{"content":"/**\n * Voice chat client utilities for Replit AI Integrations.\n * \n * Usage:\n * 1. Copy audio-playback-worklet.js to your public/ folder\n * 2. Import and use the React hooks in your components\n * \n * Example:\n * ```tsx\n * import { useVoiceRecorder, useVoiceStream } from \"./audio\";\n * \n * function VoiceChat() {\n *   const [transcript, setTranscript] = useState(\"\");\n *   const recorder = useVoiceRecorder();\n *   const stream = useVoiceStream({\n *     onTranscript: (_, full) => setTranscript(full),\n *     onComplete: (text) => console.log(\"Done:\", text),\n *   });\n * \n *   const handleClick = async () => {\n *     if (recorder.state === \"recording\") {\n *       const blob = await recorder.stopRecording();\n *       await stream.streamVoiceResponse(\"/api/voice-conversations/1/messages\", blob);\n *     } else {\n *       await recorder.startRecording();\n *     }\n *   };\n * \n *   return (\n *     <div>\n *       <button onClick={handleClick}>\n *         {recorder.state === \"recording\" ? \"Stop\" : \"Record\"}\n *       </button>\n *       <p>{transcript}</p>\n *     </div>\n *   );\n * }\n * ```\n */\n\nexport { decodePCM16ToFloat32, createAudioPlaybackContext } from \"./audio-utils\";\nexport { useVoiceRecorder, type RecordingState } from \"./useVoiceRecorder\";\nexport { useAudioPlayback, type PlaybackState } from \"./useAudioPlayback\";\nexport { useVoiceStream } from \"./useVoiceStream\";\n\n","path":null,"size_bytes":1379,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE - Brazilian Electoral System Institutional Colors */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 210 20% 98%;\n  --foreground: 210 29% 24%;\n  --border: 210 14% 89%;\n  --card: 0 0% 100%;\n  --card-foreground: 210 29% 24%;\n  --card-border: 210 14% 93%;\n  --sidebar: 210 100% 20%;\n  --sidebar-foreground: 0 0% 98%;\n  --sidebar-border: 210 100% 15%;\n  --sidebar-primary: 45 100% 50%;\n  --sidebar-primary-foreground: 210 100% 15%;\n  --sidebar-accent: 210 100% 25%;\n  --sidebar-accent-foreground: 0 0% 98%;\n  --sidebar-ring: 45 100% 50%;\n  --popover: 0 0% 100%;\n  --popover-foreground: 210 29% 24%;\n  --popover-border: 210 14% 90%;\n  --primary: 210 100% 20%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 210 14% 93%;\n  --secondary-foreground: 210 29% 24%;\n  --muted: 210 14% 96%;\n  --muted-foreground: 210 14% 46%;\n  --accent: 45 100% 50%;\n  --accent-foreground: 210 100% 15%;\n  --destructive: 4 84% 49%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 210 14% 83%;\n  --ring: 210 100% 20%;\n  --chart-1: 210 100% 20%;\n  --chart-2: 45 100% 50%;\n  --chart-3: 145 63% 42%;\n  --chart-4: 4 84% 49%;\n  --chart-5: 280 60% 40%;\n  --success: 145 63% 42%;\n  --success-foreground: 0 0% 98%;\n  --warning: 45 100% 50%;\n  --warning-foreground: 210 100% 15%;\n  --font-sans: 'Roboto', 'Open Sans', sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: 'Roboto Mono', Menlo, monospace;\n  --radius: .375rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 210 29% 8%;\n  --foreground: 210 14% 93%;\n  --border: 210 14% 18%;\n  --card: 210 29% 11%;\n  --card-foreground: 210 14% 93%;\n  --card-border: 210 14% 15%;\n  --sidebar: 210 100% 12%;\n  --sidebar-foreground: 0 0% 95%;\n  --sidebar-border: 210 100% 8%;\n  --sidebar-primary: 45 100% 50%;\n  --sidebar-primary-foreground: 210 100% 10%;\n  --sidebar-accent: 210 100% 18%;\n  --sidebar-accent-foreground: 0 0% 95%;\n  --sidebar-ring: 45 100% 50%;\n  --popover: 210 29% 14%;\n  --popover-foreground: 210 14% 93%;\n  --popover-border: 210 14% 20%;\n  --primary: 210 100% 45%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 210 14% 18%;\n  --secondary-foreground: 210 14% 93%;\n  --muted: 210 14% 20%;\n  --muted-foreground: 210 14% 63%;\n  --accent: 45 100% 50%;\n  --accent-foreground: 210 100% 10%;\n  --destructive: 4 84% 55%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 210 14% 30%;\n  --ring: 210 100% 45%;\n  --chart-1: 210 100% 55%;\n  --chart-2: 45 100% 60%;\n  --chart-3: 145 63% 52%;\n  --chart-4: 4 84% 60%;\n  --chart-5: 280 60% 60%;\n  --success: 145 63% 52%;\n  --success-foreground: 0 0% 98%;\n  --warning: 45 100% 50%;\n  --warning-foreground: 210 100% 10%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n","path":null,"size_bytes":10988,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"server/routes.ts":{"content":"import type { Express, Request, Response, NextFunction } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport session from \"express-session\";\nimport passport from \"passport\";\nimport { getSessionConfig } from \"./session-config\";\nimport { Strategy as LocalStrategy } from \"passport-local\";\nimport bcrypt from \"bcrypt\";\nimport multer from \"multer\";\nimport { createReadStream, createWriteStream } from \"fs\";\nimport { unlink, mkdir, readdir, stat, rm } from \"fs/promises\";\nimport { parse } from \"csv-parse\";\nimport iconv from \"iconv-lite\";\nimport unzipper from \"unzipper\";\nimport { pipeline } from \"stream/promises\";\nimport path from \"path\";\nimport { z } from \"zod\";\nimport { storage } from \"./storage\";\nimport { db } from \"./db\";\nimport { executeReportRun } from \"./report-executor\";\nimport { \n  emitJobStatus, \n  emitJobProgress, \n  emitBatchStatus, \n  emitBatchError,\n  emitJobCompleted,\n  emitJobFailed\n} from \"./websocket\";\nimport { sql } from \"drizzle-orm\";\nimport type { User, InsertTseCandidateVote, TseImportBatch } from \"@shared/schema\";\nimport {\n  users,\n  parties,\n  candidates,\n  scenarios,\n  scenarioVotes,\n  scenarioCandidates,\n  simulations,\n  auditLogs,\n  alliances,\n  allianceParties,\n  tseImportJobs,\n  tseCandidateVotes,\n  tseImportErrors,\n  savedReports,\n  semanticDocuments,\n  semanticSearchQueries,\n  aiPredictions,\n  aiSentimentData,\n  projectionReports,\n  importValidationRuns,\n  importValidationIssues,\n  forecastRuns,\n  forecastResults,\n  forecastSwingRegions,\n  candidateComparisons,\n  eventImpactPredictions,\n  scenarioSimulations,\n  sentimentAnalysisResults,\n  sentimentCrisisAlerts,\n  sentimentMonitoringSessions,\n  sentimentComparisonSnapshots,\n  sentimentArticles,\n  articleEntityMentions,\n  alertConfigurations,\n  inAppNotifications,\n  ibgeMunicipios,\n  ibgePopulacao,\n  ibgeIndicadores,\n  ibgeImportJobs,\n} from \"@shared/schema\";\nimport { eq, and, desc, gte, lte } from \"drizzle-orm\";\nimport OpenAI from \"openai\";\nimport {\n  runSentimentAnalysis,\n  getSentimentTimeline,\n  getWordCloudData,\n  getEntitiesSentimentOverview,\n  fetchSentimentSources,\n} from \"./sentiment-analysis\";\nimport {\n  fetchExternalData,\n  fetchAndAnalyzeExternalData,\n  getExternalDataSummaryForReport,\n} from \"./external-data-service\";\nimport { \n  processSemanticSearch, \n  generateEmbeddingsForImportJob, \n  getEmbeddingStats, \n  getRecentQueries \n} from \"./semantic-search\";\nimport { ibgeService } from \"./ibge-service\";\nimport { campaignInsightsService } from \"./campaign-insights-service\";\n\nconst upload = multer({ \n  dest: \"/tmp/uploads/\",\n  limits: { fileSize: 10 * 1024 * 1024 * 1024 }\n});\n\n// Track active import jobs for cancellation\nconst activeImportJobs = new Map<number, { cancelled: boolean; abortController?: AbortController }>();\n\nfunction isJobCancelled(jobId: number): boolean {\n  const job = activeImportJobs.get(jobId);\n  return job?.cancelled ?? false;\n}\n\n// TSE Import Queue System - processes one job at a time\ninterface TseQueueItem {\n  jobId: number;\n  type: \"url\" | \"detalhe\" | \"partido\";\n  url: string;\n  selectedFile?: string;\n  processor: () => Promise<void>;\n}\n\nconst tseImportQueue: TseQueueItem[] = [];\nlet isTseQueueProcessing = false;\nlet currentTseJob: number | null = null;\n\nfunction getTseQueueStatus() {\n  return {\n    isProcessing: isTseQueueProcessing,\n    currentJob: currentTseJob,\n    queueLength: tseImportQueue.length,\n    queue: [\n      ...(currentTseJob !== null ? [{\n        position: 0,\n        jobId: currentTseJob,\n        type: \"processing\" as const,\n        isProcessing: true,\n      }] : []),\n      ...tseImportQueue.map((item, index) => ({\n        position: index + 1,\n        jobId: item.jobId,\n        type: item.type,\n        isProcessing: false,\n      })),\n    ],\n  };\n}\n\nasync function addToTseQueue(item: TseQueueItem) {\n  const position = tseImportQueue.length + 1;\n  tseImportQueue.push(item);\n  console.log(`[TSE Queue] Job ${item.jobId} added to queue at position ${position}. Queue length: ${tseImportQueue.length}`);\n  \n  await storage.updateTseImportJob(item.jobId, {\n    stage: \"queued\",\n    updatedAt: new Date(),\n  });\n  \n  processNextTseJob();\n}\n\nasync function removeFromTseQueue(jobId: number): Promise<boolean> {\n  const index = tseImportQueue.findIndex(item => item.jobId === jobId);\n  if (index !== -1) {\n    tseImportQueue.splice(index, 1);\n    console.log(`[TSE Queue] Job ${jobId} removed from queue. Queue length: ${tseImportQueue.length}`);\n    return true;\n  }\n  return false;\n}\n\nasync function processNextTseJob() {\n  if (isTseQueueProcessing || tseImportQueue.length === 0) {\n    return;\n  }\n\n  const item = tseImportQueue.shift();\n  if (!item) return;\n\n  isTseQueueProcessing = true;\n  currentTseJob = item.jobId;\n  console.log(`[TSE Queue] Starting job ${item.jobId}. Remaining in queue: ${tseImportQueue.length}`);\n\n  try {\n    await item.processor();\n  } catch (error) {\n    console.error(`[TSE Queue] Job ${item.jobId} failed:`, error);\n  } finally {\n    isTseQueueProcessing = false;\n    currentTseJob = null;\n    console.log(`[TSE Queue] Job ${item.jobId} finished. Processing next...`);\n    processNextTseJob();\n  }\n}\n\ndeclare module \"express-session\" {\n  interface SessionData {\n    passport: { user: string };\n  }\n}\n\ndeclare global {\n  namespace Express {\n    interface User {\n      id: string;\n      username: string;\n      name: string;\n      email: string;\n      role: string;\n      active: boolean;\n      createdAt: Date;\n    }\n  }\n}\n\nasync function logAudit(req: Request, action: string, entity: string, entityId?: string, details?: object) {\n  try {\n    await storage.createAuditLog({\n      userId: req.user?.id || null,\n      action,\n      entity,\n      entityId: entityId || null,\n      details: details || null,\n      ipAddress: req.ip || req.socket.remoteAddress || null,\n      userAgent: req.get(\"user-agent\") || null,\n    });\n  } catch (error) {\n    console.error(\"Failed to create audit log:\", error);\n  }\n}\n\nfunction requireAuth(req: Request, res: Response, next: NextFunction) {\n  if (req.isAuthenticated()) {\n    return next();\n  }\n  res.status(401).json({ error: \"Unauthorized\" });\n}\n\nfunction requireRole(...roles: string[]) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!req.user) {\n      return res.status(401).json({ error: \"Unauthorized\" });\n    }\n    if (!roles.includes(req.user.role)) {\n      return res.status(403).json({ error: \"Forbidden\" });\n    }\n    next();\n  };\n}\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express\n): Promise<Server> {\n  await (storage as any).seedDefaultAdmin?.();\n\n  const sessionSecret = process.env.SESSION_SECRET;\n  if (!sessionSecret && process.env.NODE_ENV === \"production\") {\n    throw new Error(\"SESSION_SECRET environment variable is required in production\");\n  }\n\n  // Trust proxy for proper session handling behind Nginx/reverse proxy\n  if (process.env.NODE_ENV === \"production\") {\n    app.set(\"trust proxy\", 1);\n  }\n\n  app.use(session(getSessionConfig(sessionSecret)));\n\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  passport.use(\n    new LocalStrategy(async (username, password, done) => {\n      try {\n        const user = await storage.getUserByUsername(username);\n        if (!user) {\n          return done(null, false, { message: \"Invalid credentials\" });\n        }\n        if (!user.active) {\n          return done(null, false, { message: \"Account disabled\" });\n        }\n        const isValid = await bcrypt.compare(password, user.password);\n        if (!isValid) {\n          return done(null, false, { message: \"Invalid credentials\" });\n        }\n        return done(null, user);\n      } catch (error) {\n        return done(error);\n      }\n    })\n  );\n\n  passport.serializeUser((user: any, done) => {\n    done(null, user.id);\n  });\n\n  passport.deserializeUser(async (id: string, done) => {\n    try {\n      const user = await storage.getUser(id);\n      done(null, user || undefined);\n    } catch (error) {\n      done(error);\n    }\n  });\n\n  app.get(\"/api/health\", async (_req, res) => {\n    try {\n      const stats = await storage.getStats();\n      res.json({\n        status: \"healthy\",\n        timestamp: new Date().toISOString(),\n        version: \"1.0.0\",\n        database: \"connected\",\n        stats: {\n          parties: stats.parties,\n          candidates: stats.candidates,\n        }\n      });\n    } catch (error) {\n      res.status(503).json({\n        status: \"unhealthy\",\n        timestamp: new Date().toISOString(),\n        database: \"disconnected\",\n        error: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  app.post(\"/api/auth/login\", (req, res, next) => {\n    passport.authenticate(\"local\", async (err: any, user: User | false, info: any) => {\n      if (err) {\n        return res.status(500).json({ error: \"Internal error\" });\n      }\n      if (!user) {\n        return res.status(401).json({ error: info?.message || \"Invalid credentials\" });\n      }\n      req.login(user, async (loginErr) => {\n        if (loginErr) {\n          return res.status(500).json({ error: \"Login failed\" });\n        }\n        await logAudit(req, \"login\", \"session\", user.id);\n        const { password, ...safeUser } = user;\n        return res.json(safeUser);\n      });\n    })(req, res, next);\n  });\n\n  app.post(\"/api/auth/logout\", requireAuth, async (req, res) => {\n    await logAudit(req, \"logout\", \"session\", req.user?.id);\n    req.logout((err) => {\n      if (err) {\n        return res.status(500).json({ error: \"Logout failed\" });\n      }\n      res.json({ success: true });\n    });\n  });\n\n  app.get(\"/api/auth/me\", requireAuth, (req, res) => {\n    const user = req.user as any;\n    const { password, ...safeUser } = user;\n    res.json(safeUser);\n  });\n\n  app.patch(\"/api/auth/profile\", requireAuth, async (req, res) => {\n    try {\n      const { name, email } = req.body;\n      const updated = await storage.updateUser(req.user!.id, { name, email });\n      if (!updated) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      await logAudit(req, \"update\", \"user\", req.user!.id, { fields: [\"name\", \"email\"] });\n      const { password, ...safeUser } = updated;\n      res.json(safeUser);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update profile\" });\n    }\n  });\n\n  app.post(\"/api/auth/change-password\", requireAuth, async (req, res) => {\n    try {\n      const { currentPassword, newPassword } = req.body;\n      const user = await storage.getUser(req.user!.id);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      const isValid = await bcrypt.compare(currentPassword, user.password);\n      if (!isValid) {\n        return res.status(401).json({ error: \"Current password is incorrect\" });\n      }\n      await storage.updateUser(req.user!.id, { password: newPassword });\n      await logAudit(req, \"update\", \"user\", req.user!.id, { action: \"password_change\" });\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to change password\" });\n    }\n  });\n\n  app.get(\"/api/stats\", requireAuth, async (req, res) => {\n    try {\n      const stats = await storage.getStats();\n      res.json(stats);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch stats\" });\n    }\n  });\n\n  // Activity trend for the last 7 days - real data from scenarios and simulations\n  app.get(\"/api/activity-trend\", requireAuth, async (req, res) => {\n    try {\n      const activityData = await storage.getActivityTrend(7);\n      res.json(activityData);\n    } catch (error) {\n      console.error(\"Failed to fetch activity trend:\", error);\n      res.status(500).json({ error: \"Failed to fetch activity trend\" });\n    }\n  });\n\n  app.get(\"/api/users\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const users = await storage.getUsers();\n      const safeUsers = users.map(({ password, ...u }) => u);\n      res.json(safeUsers);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch users\" });\n    }\n  });\n\n  app.post(\"/api/users\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const user = await storage.createUser(req.body);\n      await logAudit(req, \"create\", \"user\", user.id, { username: user.username });\n      const { password, ...safeUser } = user;\n      res.json(safeUser);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create user\" });\n    }\n  });\n\n  app.patch(\"/api/users/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const updated = await storage.updateUser(req.params.id, req.body);\n      if (!updated) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      await logAudit(req, \"update\", \"user\", req.params.id);\n      const { password, ...safeUser } = updated;\n      res.json(safeUser);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update user\" });\n    }\n  });\n\n  app.delete(\"/api/users/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      await storage.deleteUser(req.params.id);\n      await logAudit(req, \"delete\", \"user\", req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete user\" });\n    }\n  });\n\n  app.get(\"/api/parties\", requireAuth, async (req, res) => {\n    try {\n      const parties = await storage.getParties();\n      res.json(parties);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch parties\" });\n    }\n  });\n\n  // Paginated parties endpoint with search and filtering\n  app.get(\"/api/parties/paginated\", requireAuth, async (req, res) => {\n    try {\n      const page = parseInt(req.query.page as string) || 1;\n      const limit = Math.min(parseInt(req.query.limit as string) || 20, 100);\n      const search = (req.query.search as string) || \"\";\n      const active = req.query.active === \"true\" ? true : req.query.active === \"false\" ? false : undefined;\n      const sortBy = (req.query.sortBy as string) || \"name\";\n      const sortOrder = (req.query.sortOrder as string) === \"desc\" ? \"desc\" : \"asc\";\n      const tags = req.query.tags ? (req.query.tags as string).split(\",\") : undefined;\n\n      const result = await storage.getPartiesPaginated({\n        page,\n        limit,\n        search,\n        active,\n        sortBy,\n        sortOrder,\n        tags,\n      });\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching paginated parties:\", error);\n      res.status(500).json({ error: \"Failed to fetch parties\" });\n    }\n  });\n\n  // Get party by ID with details\n  app.get(\"/api/parties/:id/details\", requireAuth, async (req, res) => {\n    try {\n      const partyId = parseInt(req.params.id);\n      const party = await storage.getPartyWithDetails(partyId);\n      if (!party) {\n        return res.status(404).json({ error: \"Party not found\" });\n      }\n      res.json(party);\n    } catch (error) {\n      console.error(\"Error fetching party details:\", error);\n      res.status(500).json({ error: \"Failed to fetch party details\" });\n    }\n  });\n\n  app.get(\"/api/parties/export/csv\", requireAuth, async (req, res) => {\n    try {\n      const parties = await storage.getParties();\n      \n      const csvHeader = \"Numero;Sigla;Nome;Cor;Coligacao;Ativo;Criado_Em\\n\";\n      const csvRows = parties.map(p => \n        `${p.number};\"${p.abbreviation}\";\"${p.name}\";\"${p.color}\";\"${p.coalition || ''}\";\"${p.active ? 'Sim' : 'Nao'}\";\"${p.createdAt}\"`\n      ).join(\"\\n\");\n      \n      const csv = csvHeader + csvRows;\n      \n      res.setHeader(\"Content-Type\", \"text/csv; charset=utf-8\");\n      res.setHeader(\"Content-Disposition\", \"attachment; filename=partidos.csv\");\n      res.send(\"\\uFEFF\" + csv);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to export parties\" });\n    }\n  });\n\n  app.post(\"/api/parties\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const party = await storage.createParty({\n        ...req.body,\n        createdBy: req.user!.id,\n      });\n      await logAudit(req, \"create\", \"party\", String(party.id), { name: party.name });\n      res.json(party);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create party\" });\n    }\n  });\n\n  app.patch(\"/api/parties/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const updated = await storage.updateParty(parseInt(req.params.id), req.body);\n      if (!updated) {\n        return res.status(404).json({ error: \"Party not found\" });\n      }\n      await logAudit(req, \"update\", \"party\", req.params.id);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update party\" });\n    }\n  });\n\n  app.delete(\"/api/parties/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      await storage.deleteParty(parseInt(req.params.id));\n      await logAudit(req, \"delete\", \"party\", req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete party\" });\n    }\n  });\n\n  // Import parties from CSV\n  app.post(\"/api/parties/import-csv\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const { csvContent } = req.body;\n      if (!csvContent || typeof csvContent !== \"string\") {\n        return res.status(400).json({ error: \"CSV content is required\" });\n      }\n\n      // Remove BOM if present\n      const cleanContent = csvContent.replace(/^\\uFEFF/, \"\");\n      \n      // Detect separator from first line\n      const firstLine = cleanContent.split(/[\\r\\n]/)[0];\n      const delimiter = firstLine.includes(\";\") ? \";\" : \",\";\n\n      // Parse CSV using csv-parse\n      const records: string[][] = await new Promise((resolve, reject) => {\n        const rows: string[][] = [];\n        const parser = parse(cleanContent, {\n          delimiter,\n          relax_quotes: true,\n          skip_empty_lines: true,\n          trim: true,\n          relax_column_count: true,\n        });\n        parser.on(\"data\", (row: string[]) => rows.push(row));\n        parser.on(\"error\", reject);\n        parser.on(\"end\", () => resolve(rows));\n      });\n\n      if (records.length < 2) {\n        return res.status(400).json({ error: \"CSV must have header and at least one data row\" });\n      }\n\n      // Parse header\n      const headers = records[0].map(h => h.toLowerCase().trim());\n      \n      // Map expected columns\n      const numIdx = headers.findIndex(h => h === \"numero\" || h === \"number\");\n      const siglaIdx = headers.findIndex(h => h === \"sigla\" || h === \"abbreviation\");\n      const nomeIdx = headers.findIndex(h => h === \"nome\" || h === \"name\");\n      const corIdx = headers.findIndex(h => h === \"cor\" || h === \"color\");\n      const coligIdx = headers.findIndex(h => h === \"coligacao\" || h === \"coalition\");\n      const ativoIdx = headers.findIndex(h => h === \"ativo\" || h === \"active\");\n\n      if (numIdx === -1 || siglaIdx === -1 || nomeIdx === -1) {\n        return res.status(400).json({ \n          error: \"CSV must have columns: Numero, Sigla, Nome (or Number, Abbreviation, Name)\" \n        });\n      }\n\n      const results = {\n        created: 0,\n        updated: 0,\n        skipped: 0,\n        errors: [] as string[],\n      };\n\n      // Get existing parties for comparison and create mutable maps\n      const existingParties = await storage.getParties();\n      const partyByNumber = new Map(existingParties.map(p => [p.number, p]));\n      const partyByAbbrev = new Map(existingParties.map(p => [p.abbreviation.toUpperCase(), p]));\n      \n      // Track numbers and abbreviations seen in this import to detect duplicates\n      const seenNumbers = new Set<number>();\n      const seenAbbrevs = new Set<string>();\n\n      // Process data rows (skip header)\n      for (let i = 1; i < records.length; i++) {\n        const values = records[i];\n        const lineNum = i + 1;\n        \n        try {\n          const number = parseInt(values[numIdx] || \"\");\n          const abbreviation = (values[siglaIdx] || \"\").trim().toUpperCase();\n          const name = (values[nomeIdx] || \"\").trim();\n          const color = corIdx >= 0 && values[corIdx] ? values[corIdx].trim() : \"#003366\";\n          const coalition = coligIdx >= 0 && values[coligIdx] ? values[coligIdx].trim() : null;\n          const activeStr = ativoIdx >= 0 ? (values[ativoIdx] || \"\").toLowerCase() : \"\";\n          const active = ativoIdx >= 0 ? \n            (activeStr === \"sim\" || activeStr === \"true\" || activeStr === \"1\") \n            : true;\n\n          if (isNaN(number) || !abbreviation || !name) {\n            results.errors.push(`Linha ${lineNum}: Dados inválidos (número, sigla ou nome ausentes)`);\n            results.skipped++;\n            continue;\n          }\n\n          // Check for duplicates within this import file\n          if (seenNumbers.has(number)) {\n            results.errors.push(`Linha ${lineNum}: Número ${number} duplicado no arquivo`);\n            results.skipped++;\n            continue;\n          }\n          if (seenAbbrevs.has(abbreviation)) {\n            results.errors.push(`Linha ${lineNum}: Sigla ${abbreviation} duplicada no arquivo`);\n            results.skipped++;\n            continue;\n          }\n\n          // Check if party exists by number or abbreviation\n          const existingByNum = partyByNumber.get(number);\n          const existingByAbbrev = partyByAbbrev.get(abbreviation);\n\n          // Detect conflict: number points to one party, abbreviation to another\n          if (existingByNum && existingByAbbrev && existingByNum.id !== existingByAbbrev.id) {\n            results.errors.push(`Linha ${lineNum}: Conflito - número ${number} pertence a ${existingByNum.abbreviation}, mas sigla ${abbreviation} pertence a outro partido`);\n            results.skipped++;\n            continue;\n          }\n\n          if (existingByNum || existingByAbbrev) {\n            // Update existing party\n            const existing = existingByNum || existingByAbbrev!;\n            const updated = await storage.updateParty(existing.id, {\n              name,\n              abbreviation,\n              number,\n              color,\n              coalition,\n              active,\n            });\n            \n            // Update maps with new data\n            if (updated) {\n              partyByNumber.delete(existing.number);\n              partyByAbbrev.delete(existing.abbreviation.toUpperCase());\n              partyByNumber.set(number, updated);\n              partyByAbbrev.set(abbreviation, updated);\n            }\n            \n            results.updated++;\n          } else {\n            // Create new party\n            const newParty = await storage.createParty({\n              name,\n              abbreviation,\n              number,\n              color,\n              coalition,\n              active,\n              createdBy: req.user!.id,\n            });\n            \n            // Add to maps\n            partyByNumber.set(number, newParty);\n            partyByAbbrev.set(abbreviation, newParty);\n            \n            results.created++;\n          }\n          \n          // Mark as seen\n          seenNumbers.add(number);\n          seenAbbrevs.add(abbreviation);\n          \n        } catch (err: any) {\n          results.errors.push(`Linha ${lineNum}: ${err.message || \"Erro desconhecido\"}`);\n          results.skipped++;\n        }\n      }\n\n      await logAudit(req, \"import_csv\", \"party\", undefined, { \n        created: results.created, \n        updated: results.updated, \n        skipped: results.skipped \n      });\n\n      res.json({\n        success: true,\n        message: `Importação concluída: ${results.created} criados, ${results.updated} atualizados, ${results.skipped} ignorados`,\n        ...results,\n      });\n    } catch (error: any) {\n      console.error(\"CSV import error:\", error);\n      res.status(500).json({ error: \"Falha ao importar CSV: \" + (error.message || \"Erro desconhecido\") });\n    }\n  });\n\n  app.get(\"/api/candidates\", requireAuth, async (req, res) => {\n    try {\n      const candidates = await storage.getCandidates();\n      res.json(candidates);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch candidates\" });\n    }\n  });\n\n  // Paginated candidates endpoint with search and filtering\n  app.get(\"/api/candidates/paginated\", requireAuth, async (req, res) => {\n    try {\n      const page = parseInt(req.query.page as string) || 1;\n      const limit = Math.min(parseInt(req.query.limit as string) || 20, 100);\n      const search = (req.query.search as string) || \"\";\n      const partyId = req.query.partyId ? parseInt(req.query.partyId as string) : undefined;\n      const position = (req.query.position as string) || undefined;\n      const active = req.query.active === \"true\" ? true : req.query.active === \"false\" ? false : undefined;\n      const sortBy = (req.query.sortBy as string) || \"name\";\n      const sortOrder = (req.query.sortOrder as string) === \"desc\" ? \"desc\" : \"asc\";\n      const tags = req.query.tags ? (req.query.tags as string).split(\",\") : undefined;\n\n      const result = await storage.getCandidatesPaginated({\n        page,\n        limit,\n        search,\n        partyId,\n        position,\n        active,\n        sortBy,\n        sortOrder,\n        tags,\n      });\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching paginated candidates:\", error);\n      res.status(500).json({ error: \"Failed to fetch candidates\" });\n    }\n  });\n\n  // Get candidate by ID with details\n  app.get(\"/api/candidates/:id/details\", requireAuth, async (req, res) => {\n    try {\n      const candidateId = parseInt(req.params.id);\n      const candidate = await storage.getCandidateWithDetails(candidateId);\n      if (!candidate) {\n        return res.status(404).json({ error: \"Candidate not found\" });\n      }\n      res.json(candidate);\n    } catch (error) {\n      console.error(\"Error fetching candidate details:\", error);\n      res.status(500).json({ error: \"Failed to fetch candidate details\" });\n    }\n  });\n\n  app.post(\"/api/candidates\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const candidate = await storage.createCandidate({\n        ...req.body,\n        createdBy: req.user!.id,\n      });\n      await logAudit(req, \"create\", \"candidate\", String(candidate.id), { name: candidate.name });\n      res.json(candidate);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create candidate\" });\n    }\n  });\n\n  app.patch(\"/api/candidates/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const updated = await storage.updateCandidate(parseInt(req.params.id), req.body);\n      if (!updated) {\n        return res.status(404).json({ error: \"Candidate not found\" });\n      }\n      await logAudit(req, \"update\", \"candidate\", req.params.id);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update candidate\" });\n    }\n  });\n\n  app.delete(\"/api/candidates/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      await storage.deleteCandidate(parseInt(req.params.id));\n      await logAudit(req, \"delete\", \"candidate\", req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete candidate\" });\n    }\n  });\n\n  app.get(\"/api/scenarios\", requireAuth, async (req, res) => {\n    try {\n      const scenarios = await storage.getScenarios();\n      res.json(scenarios);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch scenarios\" });\n    }\n  });\n\n  app.post(\"/api/scenarios\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const scenario = await storage.createScenario({\n        ...req.body,\n        createdBy: req.user!.id,\n      });\n      await logAudit(req, \"create\", \"scenario\", String(scenario.id), { name: scenario.name });\n      res.json(scenario);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create scenario\" });\n    }\n  });\n\n  app.patch(\"/api/scenarios/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const updated = await storage.updateScenario(parseInt(req.params.id), req.body);\n      if (!updated) {\n        return res.status(404).json({ error: \"Scenario not found\" });\n      }\n      await logAudit(req, \"update\", \"scenario\", req.params.id);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update scenario\" });\n    }\n  });\n\n  app.delete(\"/api/scenarios/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      await storage.deleteScenario(parseInt(req.params.id));\n      await logAudit(req, \"delete\", \"scenario\", req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete scenario\" });\n    }\n  });\n\n  app.get(\"/api/simulations/recent\", requireAuth, async (req, res) => {\n    try {\n      const simulations = await storage.getRecentSimulations(5);\n      res.json(simulations);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch simulations\" });\n    }\n  });\n\n  app.get(\"/api/simulations\", requireAuth, async (req, res) => {\n    try {\n      const scenarioId = req.query.scenarioId ? parseInt(req.query.scenarioId as string) : undefined;\n      const simulations = await storage.getSimulations(scenarioId);\n      res.json(simulations);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch simulations\" });\n    }\n  });\n\n  app.post(\"/api/simulations\", requireAuth, async (req, res) => {\n    try {\n      const simulation = await storage.createSimulation({\n        ...req.body,\n        createdBy: req.user!.id,\n      });\n      await logAudit(req, \"simulation\", \"simulation\", String(simulation.id), { scenarioId: req.body.scenarioId });\n      res.json(simulation);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create simulation\" });\n    }\n  });\n\n  app.get(\"/api/scenarios/:id/votes\", requireAuth, async (req, res) => {\n    try {\n      const votes = await storage.getScenarioVotes(parseInt(req.params.id));\n      res.json(votes);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch scenario votes\" });\n    }\n  });\n\n  app.post(\"/api/scenarios/:id/votes\", requireAuth, async (req, res) => {\n    try {\n      const scenarioId = parseInt(req.params.id);\n      const { votes } = req.body;\n      const savedVotes = await storage.saveScenarioVotes(scenarioId, votes);\n      await logAudit(req, \"update\", \"scenario_votes\", req.params.id, { votesCount: votes.length });\n      res.json(savedVotes);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to save scenario votes\" });\n    }\n  });\n\n  app.get(\"/api/scenarios/:id/alliances\", requireAuth, async (req, res) => {\n    try {\n      const alliances = await storage.getAlliances(parseInt(req.params.id));\n      const alliancesWithParties = await Promise.all(\n        alliances.map(async (alliance) => {\n          const members = await storage.getAllianceParties(alliance.id);\n          return { ...alliance, partyIds: members.map((m) => m.partyId) };\n        })\n      );\n      res.json(alliancesWithParties);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch alliances\" });\n    }\n  });\n\n  app.post(\"/api/scenarios/:id/alliances\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const scenarioId = parseInt(req.params.id);\n      const { name, type, color, partyIds } = req.body;\n      const alliance = await storage.createAlliance({\n        scenarioId,\n        name,\n        type: type || \"coalition\",\n        color: color || \"#003366\",\n        createdBy: req.user!.id,\n      });\n      if (partyIds && partyIds.length > 0) {\n        await storage.setAllianceParties(alliance.id, partyIds);\n      }\n      await logAudit(req, \"create\", \"alliance\", String(alliance.id), { name, type, partyIds });\n      const members = await storage.getAllianceParties(alliance.id);\n      res.json({ ...alliance, partyIds: members.map((m) => m.partyId) });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create alliance\" });\n    }\n  });\n\n  app.put(\"/api/alliances/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { name, type, color, partyIds } = req.body;\n      const alliance = await storage.updateAlliance(id, { name, type, color });\n      if (!alliance) {\n        return res.status(404).json({ error: \"Alliance not found\" });\n      }\n      if (partyIds !== undefined) {\n        await storage.setAllianceParties(id, partyIds);\n      }\n      await logAudit(req, \"update\", \"alliance\", String(id), { name, type, partyIds });\n      const members = await storage.getAllianceParties(id);\n      res.json({ ...alliance, partyIds: members.map((m) => m.partyId) });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update alliance\" });\n    }\n  });\n\n  app.delete(\"/api/alliances/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteAlliance(id);\n      await logAudit(req, \"delete\", \"alliance\", String(id), {});\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete alliance\" });\n    }\n  });\n\n  app.get(\"/api/scenarios/:id/candidates\", requireAuth, async (req, res) => {\n    try {\n      const scenarioId = parseInt(req.params.id);\n      const scenarioCandidates = await storage.getScenarioCandidates(scenarioId);\n      res.json(scenarioCandidates);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch scenario candidates\" });\n    }\n  });\n\n  app.post(\"/api/scenarios/:id/candidates\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const scenarioId = parseInt(req.params.id);\n      const { candidateId, partyId, ballotNumber, nickname, votes } = req.body;\n      \n      if (!candidateId || !partyId || !ballotNumber) {\n        return res.status(400).json({ error: \"candidateId, partyId, and ballotNumber are required\" });\n      }\n      \n      const scenarioCandidate = await storage.addCandidateToScenario(\n        scenarioId,\n        candidateId,\n        partyId,\n        ballotNumber,\n        nickname,\n        votes\n      );\n      await logAudit(req, \"create\", \"scenario_candidate\", String(scenarioCandidate.id), { scenarioId, candidateId, ballotNumber, votes });\n      res.json(scenarioCandidate);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to add candidate to scenario\" });\n    }\n  });\n\n  app.put(\"/api/scenario-candidates/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { ballotNumber, nickname, status, votes } = req.body;\n      const updated = await storage.updateScenarioCandidate(id, { ballotNumber, nickname, status, votes });\n      if (!updated) {\n        return res.status(404).json({ error: \"Scenario candidate not found\" });\n      }\n      await logAudit(req, \"update\", \"scenario_candidate\", String(id), { ballotNumber, nickname, status, votes });\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update scenario candidate\" });\n    }\n  });\n\n  app.delete(\"/api/scenario-candidates/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteScenarioCandidate(id);\n      await logAudit(req, \"delete\", \"scenario_candidate\", String(id), {});\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to remove candidate from scenario\" });\n    }\n  });\n\n  app.post(\"/api/electoral/calculate\", requireAuth, async (req, res) => {\n    try {\n      const { scenarioId, partyVotes, candidateVotes } = req.body;\n      \n      if (!scenarioId || typeof scenarioId !== \"number\") {\n        return res.status(400).json({ error: \"Invalid scenarioId\" });\n      }\n      \n      const scenario = await storage.getScenario(scenarioId);\n      if (!scenario) {\n        return res.status(404).json({ error: \"Scenario not found\" });\n      }\n\n      const allParties = await storage.getParties();\n      const allCandidates = await storage.getCandidates();\n      const scenarioAlliances = await storage.getAlliances(scenarioId);\n\n      const validVotes = scenario.validVotes;\n      const availableSeats = scenario.availableSeats;\n      \n      if (availableSeats <= 0) {\n        return res.status(400).json({ error: \"Available seats must be greater than zero\" });\n      }\n      \n      if (validVotes < availableSeats) {\n        return res.status(400).json({ error: \"Valid votes must be greater than or equal to available seats\" });\n      }\n      \n      const electoralQuotient = Math.floor(validVotes / availableSeats);\n      \n      if (electoralQuotient <= 0) {\n        return res.status(400).json({ error: \"Electoral quotient must be greater than zero\" });\n      }\n\n      const allianceMembers: Record<number, number[]> = {};\n      const partyToAlliance: Record<number, number> = {};\n      \n      for (const alliance of scenarioAlliances) {\n        const members = await storage.getAllianceParties(alliance.id);\n        allianceMembers[alliance.id] = members.map(m => m.partyId);\n        members.forEach(m => { partyToAlliance[m.partyId] = alliance.id; });\n      }\n\n      const candidatesByParty: Record<number, typeof allCandidates> = {};\n      allParties.forEach((p) => {\n        candidatesByParty[p.id] = allCandidates.filter((c) => c.partyId === p.id);\n      });\n\n      type EntityResult = {\n        entityId: string;\n        entityType: \"party\" | \"alliance\";\n        name: string;\n        abbreviation: string;\n        totalVotes: number;\n        quotient: number;\n        seatsFromQuotient: number;\n        seatsFromRemainder: number;\n        totalSeats: number;\n        color: string;\n        memberPartyIds?: number[];\n        allianceType?: string;\n      };\n\n      const entityResults: EntityResult[] = [];\n      const partiesInAlliances = new Set(Object.keys(partyToAlliance).map(Number));\n\n      for (const alliance of scenarioAlliances) {\n        const memberPartyIds = allianceMembers[alliance.id] || [];\n        const totalVotes = memberPartyIds.reduce((sum, pid) => sum + (partyVotes[pid] || 0), 0);\n        const quotient = totalVotes / electoralQuotient;\n        const seatsFromQuotient = totalVotes >= electoralQuotient ? Math.floor(quotient) : 0;\n\n        entityResults.push({\n          entityId: `alliance-${alliance.id}`,\n          entityType: \"alliance\",\n          name: alliance.name,\n          abbreviation: alliance.name.substring(0, 10),\n          totalVotes,\n          quotient,\n          seatsFromQuotient,\n          seatsFromRemainder: 0,\n          totalSeats: 0,\n          color: alliance.color,\n          memberPartyIds,\n          allianceType: alliance.type,\n        });\n      }\n\n      for (const party of allParties) {\n        if (partiesInAlliances.has(party.id)) continue;\n        const totalVotes = partyVotes[party.id] || 0;\n        const quotient = totalVotes / electoralQuotient;\n        const seatsFromQuotient = totalVotes >= electoralQuotient ? Math.floor(quotient) : 0;\n\n        entityResults.push({\n          entityId: `party-${party.id}`,\n          entityType: \"party\",\n          name: party.name,\n          abbreviation: party.abbreviation,\n          totalVotes,\n          quotient,\n          seatsFromQuotient,\n          seatsFromRemainder: 0,\n          totalSeats: 0,\n          color: party.color,\n        });\n      }\n\n      const qualifiedEntities = entityResults.filter(e => e.totalVotes >= electoralQuotient);\n\n      let seatsDistributedByQuotient = qualifiedEntities.reduce((sum, e) => sum + e.seatsFromQuotient, 0);\n      let remainingSeats = availableSeats - seatsDistributedByQuotient;\n\n      for (let round = 0; round < remainingSeats; round++) {\n        let maxQuotient = 0;\n        let winnerIdx = -1;\n\n        qualifiedEntities.forEach((e, idx) => {\n          const currentSeats = e.seatsFromQuotient + e.seatsFromRemainder;\n          const q = e.totalVotes / (currentSeats + 1);\n          if (q > maxQuotient) {\n            maxQuotient = q;\n            winnerIdx = idx;\n          }\n        });\n\n        if (winnerIdx >= 0) {\n          qualifiedEntities[winnerIdx].seatsFromRemainder += 1;\n        }\n      }\n\n      qualifiedEntities.forEach(e => { e.totalSeats = e.seatsFromQuotient + e.seatsFromRemainder; });\n\n      type PartyResultWithAlliance = {\n        partyId: number;\n        partyName: string;\n        abbreviation: string;\n        totalVotes: number;\n        partyQuotient: number;\n        seatsFromQuotient: number;\n        seatsFromRemainder: number;\n        totalSeats: number;\n        electedCandidates: { candidateId: number; name: string; votes: number; elected: boolean; position: number }[];\n        color: string;\n        allianceId?: number;\n        allianceName?: string;\n        allianceType?: string;\n      };\n\n      const partyResults: PartyResultWithAlliance[] = [];\n\n      for (const entity of qualifiedEntities) {\n        if (entity.entityType === \"party\") {\n          const partyId = parseInt(entity.entityId.replace(\"party-\", \"\"));\n          const party = allParties.find(p => p.id === partyId)!;\n          const partyCandidates = candidatesByParty[partyId] || [];\n          const candidateResults = partyCandidates.map(c => ({\n            candidateId: c.id,\n            name: c.nickname || c.name,\n            votes: candidateVotes[c.id] || 0,\n            elected: false,\n            position: 0,\n          })).sort((a, b) => b.votes - a.votes);\n\n          let electedCount = 0;\n          candidateResults.forEach(c => {\n            if (electedCount < entity.totalSeats) {\n              c.elected = true;\n              c.position = electedCount + 1;\n              electedCount++;\n            }\n          });\n\n          partyResults.push({\n            partyId: party.id,\n            partyName: party.name,\n            abbreviation: party.abbreviation,\n            totalVotes: entity.totalVotes,\n            partyQuotient: entity.quotient,\n            seatsFromQuotient: entity.seatsFromQuotient,\n            seatsFromRemainder: entity.seatsFromRemainder,\n            totalSeats: entity.totalSeats,\n            electedCandidates: candidateResults,\n            color: entity.color,\n          });\n        } else {\n          const allianceId = parseInt(entity.entityId.replace(\"alliance-\", \"\"));\n          const alliance = scenarioAlliances.find(a => a.id === allianceId)!;\n          const memberPartyIds = entity.memberPartyIds || [];\n\n          const memberPartyResults: { partyId: number; votes: number; candidates: any[] }[] = [];\n          for (const pid of memberPartyIds) {\n            const party = allParties.find(p => p.id === pid)!;\n            const partyCandidates = candidatesByParty[pid] || [];\n            const candidateResults = partyCandidates.map(c => ({\n              candidateId: c.id,\n              name: c.nickname || c.name,\n              votes: candidateVotes[c.id] || 0,\n              elected: false,\n              position: 0,\n            })).sort((a, b) => b.votes - a.votes);\n            memberPartyResults.push({ partyId: pid, votes: partyVotes[pid] || 0, candidates: candidateResults });\n          }\n\n          const allAllianceCandidates = memberPartyResults.flatMap(mp => \n            mp.candidates.map(c => ({ ...c, partyId: mp.partyId }))\n          ).sort((a, b) => b.votes - a.votes);\n\n          const partySeatsInAlliance: Record<number, number> = {};\n          memberPartyIds.forEach(pid => { partySeatsInAlliance[pid] = 0; });\n\n          let electedCount = 0;\n          allAllianceCandidates.forEach(c => {\n            if (electedCount < entity.totalSeats) {\n              c.elected = true;\n              c.position = electedCount + 1;\n              partySeatsInAlliance[c.partyId] = (partySeatsInAlliance[c.partyId] || 0) + 1;\n              electedCount++;\n            }\n          });\n\n          for (const pid of memberPartyIds) {\n            const party = allParties.find(p => p.id === pid)!;\n            const partyVotesTotal = partyVotes[pid] || 0;\n            const partyCandidates = allAllianceCandidates.filter(c => c.partyId === pid);\n            const partySeats = partySeatsInAlliance[pid] || 0;\n\n            partyResults.push({\n              partyId: party.id,\n              partyName: party.name,\n              abbreviation: party.abbreviation,\n              totalVotes: partyVotesTotal,\n              partyQuotient: partyVotesTotal / electoralQuotient,\n              seatsFromQuotient: 0,\n              seatsFromRemainder: 0,\n              totalSeats: partySeats,\n              electedCandidates: partyCandidates.map(c => ({\n                candidateId: c.candidateId,\n                name: c.name,\n                votes: c.votes,\n                elected: c.elected,\n                position: c.position,\n              })),\n              color: party.color,\n              allianceId: alliance.id,\n              allianceName: alliance.name,\n              allianceType: alliance.type,\n            });\n          }\n        }\n      }\n\n      partyResults.sort((a, b) => b.totalSeats - a.totalSeats || b.totalVotes - a.totalVotes);\n\n      const allianceResults = qualifiedEntities.filter(e => e.entityType === \"alliance\").map(e => ({\n        allianceId: parseInt(e.entityId.replace(\"alliance-\", \"\")),\n        name: e.name,\n        type: e.allianceType,\n        totalVotes: e.totalVotes,\n        totalSeats: e.totalSeats,\n        seatsFromQuotient: e.seatsFromQuotient,\n        seatsFromRemainder: e.seatsFromRemainder,\n        memberPartyIds: e.memberPartyIds,\n        color: e.color,\n      }));\n\n      const result = {\n        electoralQuotient,\n        totalValidVotes: validVotes,\n        availableSeats,\n        seatsDistributedByQuotient,\n        seatsDistributedByRemainder: remainingSeats,\n        partyResults,\n        allianceResults,\n        hasAlliances: scenarioAlliances.length > 0,\n      };\n\n      await logAudit(req, \"simulation\", \"electoral_calculation\", String(scenarioId), { \n        electoralQuotient, \n        availableSeats,\n        alliancesCount: scenarioAlliances.length,\n      });\n\n      res.json(result);\n    } catch (error) {\n      console.error(\"Electoral calculation error:\", error);\n      res.status(500).json({ error: \"Failed to calculate electoral results\" });\n    }\n  });\n\n  app.get(\"/api/audit\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const logs = await storage.getAuditLogs();\n      res.json(logs);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch audit logs\" });\n    }\n  });\n\n  app.post(\"/api/ai/predict\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { scenarioId } = req.body;\n      const scenario = await storage.getScenario(scenarioId);\n      if (!scenario) {\n        return res.status(404).json({ error: \"Scenario not found\" });\n      }\n\n      const parties = await storage.getParties();\n\n      const openai = new OpenAI();\n\n      const prompt = `Você é um analista político especializado em eleições proporcionais brasileiras.\nAnalise o seguinte cenário eleitoral e forneça previsões:\n\nCenário: ${scenario.name}\nTotal de Eleitores: ${scenario.totalVoters.toLocaleString(\"pt-BR\")}\nVotos Válidos: ${scenario.validVotes.toLocaleString(\"pt-BR\")}\nVagas Disponíveis: ${scenario.availableSeats}\nCargo: ${scenario.position}\n\nPartidos participantes:\n${parties.map((p) => `- ${p.abbreviation} (${p.name}) - Número: ${p.number}`).join(\"\\n\")}\n\nResponda em JSON com a seguinte estrutura:\n{\n  \"analysis\": \"Análise geral do cenário em 2-3 parágrafos em português\",\n  \"predictions\": [\n    {\n      \"partyId\": número_do_partido_id,\n      \"partyName\": \"nome_do_partido\",\n      \"predictedSeats\": { \"min\": número, \"max\": número },\n      \"confidence\": número_entre_0_e_1,\n      \"trend\": \"up\" | \"down\" | \"stable\"\n    }\n  ],\n  \"recommendations\": [\"recomendação 1\", \"recomendação 2\", \"recomendação 3\"]\n}`;\n\n      const completion = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n      });\n\n      const content = completion.choices[0]?.message?.content;\n      if (!content) {\n        throw new Error(\"No response from AI\");\n      }\n\n      const prediction = JSON.parse(content);\n      prediction.generatedAt = new Date().toISOString();\n\n      await logAudit(req, \"prediction\", \"scenario\", String(scenarioId));\n\n      res.json(prediction);\n    } catch (error: any) {\n      console.error(\"AI Prediction error:\", error);\n      res.status(500).json({ error: \"Failed to generate prediction\" });\n    }\n  });\n\n  // AI Assistant for natural language queries about electoral data\n  app.post(\"/api/ai/assistant\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { question, filters } = req.body;\n      \n      if (!question || typeof question !== \"string\" || question.length < 5) {\n        return res.status(400).json({ error: \"Please provide a valid question (at least 5 characters)\" });\n      }\n\n      if (question.length > 500) {\n        return res.status(400).json({ error: \"Question is too long (max 500 characters)\" });\n      }\n\n      // Fetch data based on filters to provide context to the AI\n      const summary = await storage.getAnalyticsSummary(filters || {});\n      const votesByParty = await storage.getVotesByParty({ ...(filters || {}), limit: 15 });\n      const topCandidates = await storage.getTopCandidates({ ...(filters || {}), limit: 10 });\n      const votesByState = await storage.getVotesByState(filters || {});\n\n      const dataContext = `\nDADOS ELEITORAIS DISPONÍVEIS:\n\nResumo:\n- Total de Votos: ${summary.totalVotes.toLocaleString(\"pt-BR\")}\n- Candidatos: ${summary.totalCandidates.toLocaleString(\"pt-BR\")}\n- Partidos: ${summary.totalParties}\n- Municípios: ${summary.totalMunicipalities.toLocaleString(\"pt-BR\")}\n\nVotos por Partido (Top 15):\n${votesByParty.map((p, i) => `${i + 1}. ${p.party} (${p.partyNumber}): ${p.votes.toLocaleString(\"pt-BR\")} votos, ${p.candidateCount} candidatos`).join(\"\\n\")}\n\nCandidatos Mais Votados (Top 10):\n${topCandidates.map((c, i) => `${i + 1}. ${c.nickname || c.name} (${c.party}) - ${c.state}: ${c.votes.toLocaleString(\"pt-BR\")} votos`).join(\"\\n\")}\n\nVotos por Estado:\n${votesByState.map((s) => `- ${s.state}: ${s.votes.toLocaleString(\"pt-BR\")} votos, ${s.candidateCount} candidatos, ${s.partyCount} partidos`).join(\"\\n\")}\n\nFiltros Aplicados: ${JSON.stringify(filters || { info: \"Todos os dados\" })}\n`;\n\n      const openai = new OpenAI();\n      const completion = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [\n          {\n            role: \"system\",\n            content: `Você é um assistente especializado em análise de dados eleitorais brasileiros do TSE.\nResponda perguntas sobre os dados eleitorais usando APENAS as informações fornecidas abaixo.\nSeja preciso, cite números específicos quando disponíveis, e responda em português.\nSe não houver dados suficientes para responder, informe isso educadamente.\nNão invente dados que não estejam no contexto fornecido.`\n          },\n          {\n            role: \"user\",\n            content: `${dataContext}\\n\\nPERGUNTA DO USUÁRIO: ${question}`\n          }\n        ],\n        max_tokens: 1000,\n      });\n\n      const answer = completion.choices[0]?.message?.content;\n      if (!answer) {\n        throw new Error(\"No response from AI\");\n      }\n\n      await logAudit(req, \"ai_query\", \"assistant\", undefined, { question, filters });\n\n      res.json({\n        question,\n        answer,\n        filters,\n        dataContext: {\n          totalVotes: summary.totalVotes,\n          totalParties: summary.totalParties,\n          totalCandidates: summary.totalCandidates,\n        },\n        generatedAt: new Date().toISOString(),\n      });\n    } catch (error: any) {\n      console.error(\"AI Assistant error:\", error);\n      res.status(500).json({ error: \"Failed to process question\" });\n    }\n  });\n\n  // AI Historical Prediction based on trends\n  app.post(\"/api/ai/predict-historical\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { filters, targetYear } = req.body;\n\n      // Get historical data\n      const availableYears = await storage.getAvailableElectionYears();\n      if (availableYears.length < 1) {\n        return res.status(400).json({ error: \"Insufficient historical data for predictions\" });\n      }\n\n      const historicalData: any[] = [];\n      for (const year of availableYears.slice(0, 4)) {\n        const data = await storage.getVotesByParty({ \n          year, \n          uf: filters?.uf, \n          electionType: filters?.electionType,\n          limit: 20 \n        });\n        historicalData.push({ year, parties: data });\n      }\n\n      const openai = new OpenAI();\n      const prompt = `Você é um analista político especializado em tendências eleitorais brasileiras.\nAnalise os dados históricos de votação abaixo e forneça previsões para futuras eleições.\n\nDADOS HISTÓRICOS:\n${historicalData.map((h) => `\nAno ${h.year}:\n${h.parties.map((p: any) => `- ${p.party}: ${p.votes.toLocaleString(\"pt-BR\")} votos (${p.candidateCount} candidatos)`).join(\"\\n\")}`).join(\"\\n\")}\n\nAnos Disponíveis: ${availableYears.join(\", \")}\nFiltros: ${JSON.stringify(filters || {})}\n\nResponda em JSON com a estrutura:\n{\n  \"analysis\": \"Análise detalhada das tendências observadas (2-3 parágrafos)\",\n  \"trends\": [\n    {\n      \"party\": \"sigla\",\n      \"trend\": \"crescimento\" | \"declínio\" | \"estável\",\n      \"changePercent\": número,\n      \"observation\": \"breve observação\"\n    }\n  ],\n  \"predictions\": [\n    {\n      \"party\": \"sigla\",\n      \"expectedPerformance\": \"forte\" | \"moderado\" | \"fraco\",\n      \"confidence\": número_0_a_1,\n      \"reasoning\": \"justificativa\"\n    }\n  ],\n  \"insights\": [\"insight 1\", \"insight 2\", \"insight 3\"]\n}`;\n\n      const completion = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n      });\n\n      const content = completion.choices[0]?.message?.content;\n      if (!content) {\n        throw new Error(\"No response from AI\");\n      }\n\n      const prediction = JSON.parse(content);\n      prediction.historicalYears = availableYears;\n      prediction.filters = filters;\n      prediction.generatedAt = new Date().toISOString();\n\n      await logAudit(req, \"ai_prediction\", \"historical\", undefined, { filters, years: availableYears });\n\n      res.json(prediction);\n    } catch (error: any) {\n      console.error(\"AI Historical Prediction error:\", error);\n      res.status(500).json({ error: \"Failed to generate historical prediction\" });\n    }\n  });\n\n  // AI Anomaly Detection in voting data\n  app.post(\"/api/ai/anomalies\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { filters } = req.body;\n\n      // Get data for anomaly analysis\n      const votesByParty = await storage.getVotesByParty({ ...(filters || {}), limit: 30 });\n      const topCandidates = await storage.getTopCandidates({ ...(filters || {}), limit: 50 });\n      const votesByMunicipality = await storage.getVotesByMunicipality({ ...(filters || {}), limit: 100 });\n      const summary = await storage.getAnalyticsSummary(filters || {});\n\n      // Calculate basic statistics for anomaly detection\n      const partyVotes = votesByParty.map((p) => p.votes);\n      const avgVotes = partyVotes.length > 0 ? partyVotes.reduce((a, b) => a + b, 0) / partyVotes.length : 0;\n      const stdDev = partyVotes.length > 0 \n        ? Math.sqrt(partyVotes.map((v) => Math.pow(v - avgVotes, 2)).reduce((a, b) => a + b, 0) / partyVotes.length)\n        : 0;\n\n      const municipalityVotes = votesByMunicipality.map((m) => m.votes);\n      const avgMuniVotes = municipalityVotes.length > 0 ? municipalityVotes.reduce((a, b) => a + b, 0) / municipalityVotes.length : 0;\n      const muniStdDev = municipalityVotes.length > 0\n        ? Math.sqrt(municipalityVotes.map((v) => Math.pow(v - avgMuniVotes, 2)).reduce((a, b) => a + b, 0) / municipalityVotes.length)\n        : 0;\n\n      // Statistical flags\n      const statisticalFlags = {\n        partyOutliers: votesByParty.filter((p) => Math.abs(p.votes - avgVotes) > 2 * stdDev).map((p) => ({\n          party: p.party,\n          votes: p.votes,\n          zScore: stdDev > 0 ? (p.votes - avgVotes) / stdDev : 0,\n        })),\n        municipalityOutliers: votesByMunicipality.filter((m) => Math.abs(m.votes - avgMuniVotes) > 2.5 * muniStdDev).slice(0, 10).map((m) => ({\n          municipality: m.municipality,\n          state: m.state,\n          votes: m.votes,\n          zScore: muniStdDev > 0 ? (m.votes - avgMuniVotes) / muniStdDev : 0,\n        })),\n        candidateConcentration: topCandidates.slice(0, 5).map((c) => ({\n          candidate: c.nickname || c.name,\n          party: c.party,\n          votes: c.votes,\n          percentOfTotal: summary.totalVotes > 0 ? ((c.votes / summary.totalVotes) * 100).toFixed(2) : 0,\n        })),\n      };\n\n      const openai = new OpenAI();\n      const prompt = `Você é um especialista em detecção de anomalias em dados eleitorais brasileiros.\nAnalise os dados estatísticos abaixo e identifique possíveis anomalias, padrões incomuns ou pontos que merecem investigação.\nNÃO afirme que há fraude - apenas aponte padrões estatisticamente incomuns que podem merecer verificação.\n\nDADOS ESTATÍSTICOS:\nTotal de Votos: ${summary.totalVotes.toLocaleString(\"pt-BR\")}\nMédia de votos por partido: ${avgVotes.toLocaleString(\"pt-BR\")}\nDesvio padrão (partidos): ${stdDev.toLocaleString(\"pt-BR\")}\n\nPartidos com votação fora do padrão (>2 desvios):\n${JSON.stringify(statisticalFlags.partyOutliers, null, 2)}\n\nMunicípios com votação atípica (>2.5 desvios):\n${JSON.stringify(statisticalFlags.municipalityOutliers, null, 2)}\n\nConcentração de votos (top 5 candidatos):\n${JSON.stringify(statisticalFlags.candidateConcentration, null, 2)}\n\nResponda em JSON:\n{\n  \"overallRisk\": \"baixo\" | \"médio\" | \"alto\",\n  \"summary\": \"Resumo da análise em 1-2 parágrafos\",\n  \"anomalies\": [\n    {\n      \"type\": \"partido\" | \"município\" | \"candidato\" | \"distribuição\",\n      \"severity\": \"baixa\" | \"média\" | \"alta\",\n      \"description\": \"descrição da anomalia\",\n      \"recommendation\": \"recomendação de verificação\"\n    }\n  ],\n  \"observations\": [\"observação 1\", \"observação 2\"]\n}`;\n\n      const completion = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n      });\n\n      const content = completion.choices[0]?.message?.content;\n      if (!content) {\n        throw new Error(\"No response from AI\");\n      }\n\n      const analysis = JSON.parse(content);\n      analysis.statistics = {\n        avgVotesPerParty: avgVotes,\n        stdDevParty: stdDev,\n        avgVotesPerMunicipality: avgMuniVotes,\n        stdDevMunicipality: muniStdDev,\n      };\n      analysis.rawFlags = statisticalFlags;\n      analysis.filters = filters;\n      analysis.generatedAt = new Date().toISOString();\n\n      await logAudit(req, \"ai_anomaly\", \"detection\", undefined, { filters, riskLevel: analysis.overallRisk });\n\n      res.json(analysis);\n    } catch (error: any) {\n      console.error(\"AI Anomaly Detection error:\", error);\n      res.status(500).json({ error: \"Failed to detect anomalies\" });\n    }\n  });\n\n  // AI Voter Turnout Prediction\n  app.post(\"/api/ai/turnout\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schema = z.object({\n        year: z.number().optional(),\n        uf: z.string().optional(),\n        electionType: z.string().optional(),\n        targetYear: z.number().optional()\n      });\n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request parameters\", details: parsed.error.errors });\n      }\n      \n      const { predictVoterTurnout } = await import(\"./ai-insights\");\n      const { year, uf, electionType, targetYear } = parsed.data;\n      \n      const cacheKey = `turnout_${year || 'all'}_${uf || 'all'}_${electionType || 'all'}_${targetYear || 'next'}`;\n      const cached = await storage.getAiPrediction(cacheKey);\n      if (cached && cached.validUntil && new Date(cached.validUntil) > new Date()) {\n        return res.json(cached.prediction);\n      }\n      \n      const prediction = await predictVoterTurnout({ year, uf, electionType, targetYear });\n      \n      await storage.saveAiPrediction({\n        cacheKey,\n        predictionType: 'turnout',\n        prediction,\n        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)\n      });\n      \n      await logAudit(req, \"ai_prediction\", \"turnout\", undefined, { year, uf, electionType, targetYear });\n      \n      res.json(prediction);\n    } catch (error: any) {\n      console.error(\"AI Turnout Prediction error:\", error);\n      res.status(500).json({ error: error.message || \"Failed to generate turnout prediction\" });\n    }\n  });\n\n  // AI Candidate Success Probability\n  app.post(\"/api/ai/candidate-success\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schema = z.object({\n        candidateNumber: z.number().optional(),\n        candidateName: z.string().optional(),\n        party: z.string().optional(),\n        year: z.number().optional(),\n        uf: z.string().optional(),\n        electionType: z.string().optional()\n      });\n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request parameters\", details: parsed.error.errors });\n      }\n      \n      const { candidateNumber, candidateName, party, year, uf, electionType } = parsed.data;\n      \n      const cacheKey = `candidate_${candidateNumber || 'all'}_${party || 'all'}_${year || 'all'}_${uf || 'all'}`;\n      const cached = await storage.getAiPrediction(cacheKey);\n      if (cached && cached.validUntil && new Date(cached.validUntil) > new Date()) {\n        return res.json(cached.prediction);\n      }\n      \n      const { predictCandidateSuccess } = await import(\"./ai-insights\");\n      const predictions = await predictCandidateSuccess({ \n        candidateNumber, \n        candidateName, \n        party, \n        year, \n        uf, \n        electionType \n      });\n      \n      await storage.saveAiPrediction({\n        cacheKey,\n        predictionType: 'candidate_success',\n        prediction: predictions,\n        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)\n      });\n      \n      await logAudit(req, \"ai_prediction\", \"candidate_success\", undefined, { party, year, uf });\n      \n      res.json(predictions);\n    } catch (error: any) {\n      console.error(\"AI Candidate Success error:\", error);\n      res.status(500).json({ error: error.message || \"Failed to generate candidate success predictions\" });\n    }\n  });\n\n  // AI Party Performance Prediction\n  app.post(\"/api/ai/party-performance\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schema = z.object({\n        party: z.string().optional(),\n        year: z.number().optional(),\n        uf: z.string().optional(),\n        electionType: z.string().optional(),\n        targetYear: z.number().optional()\n      });\n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request parameters\", details: parsed.error.errors });\n      }\n      \n      const { party, year, uf, electionType, targetYear } = parsed.data;\n      \n      const cacheKey = `party_${party || 'all'}_${year || 'all'}_${uf || 'all'}_${targetYear || 'next'}`;\n      const cached = await storage.getAiPrediction(cacheKey);\n      if (cached && cached.validUntil && new Date(cached.validUntil) > new Date()) {\n        return res.json(cached.prediction);\n      }\n      \n      const { predictPartyPerformance } = await import(\"./ai-insights\");\n      const predictions = await predictPartyPerformance({ party, year, uf, electionType, targetYear });\n      \n      await storage.saveAiPrediction({\n        cacheKey,\n        predictionType: 'party_performance',\n        prediction: predictions,\n        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)\n      });\n      \n      await logAudit(req, \"ai_prediction\", \"party_performance\", undefined, { party, year, uf });\n      \n      res.json(predictions);\n    } catch (error: any) {\n      console.error(\"AI Party Performance error:\", error);\n      res.status(500).json({ error: error.message || \"Failed to generate party performance predictions\" });\n    }\n  });\n\n  // AI Electoral Insights (comprehensive analysis)\n  app.post(\"/api/ai/electoral-insights\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schema = z.object({\n        year: z.number().optional(),\n        uf: z.string().optional(),\n        electionType: z.string().optional(),\n        party: z.string().optional()\n      });\n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request parameters\", details: parsed.error.errors });\n      }\n      \n      const { year, uf, electionType, party } = parsed.data;\n      \n      const cacheKey = `insights_${year || 'all'}_${uf || 'all'}_${electionType || 'all'}_${party || 'all'}`;\n      const cached = await storage.getAiPrediction(cacheKey);\n      if (cached && cached.validUntil && new Date(cached.validUntil) > new Date()) {\n        return res.json(cached.prediction);\n      }\n      \n      const { generateElectoralInsights } = await import(\"./ai-insights\");\n      const insights = await generateElectoralInsights({ year, uf, electionType, party });\n      \n      await storage.saveAiPrediction({\n        cacheKey,\n        predictionType: 'electoral_insights',\n        prediction: insights,\n        expiresAt: new Date(Date.now() + 12 * 60 * 60 * 1000)\n      });\n      \n      await logAudit(req, \"ai_prediction\", \"electoral_insights\", undefined, { year, uf, electionType });\n      \n      res.json(insights);\n    } catch (error: any) {\n      console.error(\"AI Electoral Insights error:\", error);\n      res.status(500).json({ error: error.message || \"Failed to generate electoral insights\" });\n    }\n  });\n\n  // AI Sentiment Analysis\n  app.post(\"/api/ai/sentiment\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schema = z.object({\n        newsArticles: z.array(z.object({\n          title: z.string(),\n          content: z.string(),\n          source: z.string().optional(),\n          publishedAt: z.string().optional()\n        })).optional(),\n        socialPosts: z.array(z.object({\n          content: z.string(),\n          platform: z.string().optional(),\n          author: z.string().optional(),\n          postedAt: z.string().optional()\n        })).optional(),\n        party: z.string().optional(),\n        dateRange: z.object({\n          start: z.string(),\n          end: z.string()\n        }).optional()\n      });\n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request parameters\", details: parsed.error.errors });\n      }\n      \n      const { newsArticles, socialPosts, party, dateRange } = parsed.data;\n      \n      const { analyzeElectoralSentiment } = await import(\"./ai-insights\");\n      const analysis = await analyzeElectoralSentiment({ \n        newsArticles: newsArticles?.map(a => ({ title: a.title, content: a.content, date: a.publishedAt || new Date().toISOString(), source: a.source || 'unknown' })),\n        socialPosts: socialPosts?.map(p => ({ text: p.content, date: p.postedAt || new Date().toISOString(), platform: p.platform || 'unknown' })),\n        party, \n        dateRange \n      });\n      \n      await logAudit(req, \"ai_prediction\", \"sentiment\", undefined, { party, articlesCount: newsArticles?.length || 0 });\n      \n      res.json(analysis);\n    } catch (error: any) {\n      console.error(\"AI Sentiment Analysis error:\", error);\n      res.status(500).json({ error: error.message || \"Failed to analyze sentiment\" });\n    }\n  });\n\n  // Projection Reports API - Query params validation schema\n  const projectionReportQuerySchema = z.object({\n    status: z.enum([\"draft\", \"published\", \"archived\"]).optional(),\n    scope: z.enum([\"national\", \"state\"]).optional(),\n    targetYear: z.string().optional().transform((val) => val ? parseInt(val) : undefined).pipe(\n      z.number().int().min(2000).max(2100).optional()\n    )\n  });\n\n  app.get(\"/api/projection-reports\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const validationResult = projectionReportQuerySchema.safeParse(req.query);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid query parameters\", \n          details: validationResult.error.issues \n        });\n      }\n      \n      const { status, targetYear, scope } = validationResult.data;\n      \n      const reports = await storage.getProjectionReports({ status, targetYear, scope });\n      res.json(reports);\n    } catch (error) {\n      console.error(\"Failed to fetch projection reports:\", error);\n      res.status(500).json({ error: \"Failed to fetch projection reports\" });\n    }\n  });\n\n  app.get(\"/api/projection-reports/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const report = await storage.getProjectionReportById(parseInt(req.params.id));\n      if (!report) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      res.json(report);\n    } catch (error) {\n      console.error(\"Failed to fetch projection report:\", error);\n      res.status(500).json({ error: \"Failed to fetch projection report\" });\n    }\n  });\n\n  // Zod schema for projection report creation\n  const createProjectionReportSchema = z.object({\n    name: z.string().min(1, \"Name is required\"),\n    targetYear: z.number().int().min(2000).max(2100),\n    electionType: z.string().min(1, \"Election type is required\"),\n    scope: z.enum([\"national\", \"state\"]),\n    state: z.string().optional(),\n    position: z.string().optional()\n  });\n\n  app.post(\"/api/projection-reports\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const validationResult = createProjectionReportSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Validation failed\", \n          details: validationResult.error.issues \n        });\n      }\n      \n      const { name, targetYear, electionType, scope, state, position } = validationResult.data;\n      \n      if (scope === \"state\" && !state) {\n        return res.status(400).json({ error: \"State is required when scope is 'state'\" });\n      }\n      \n      // Generate the projection report using AI\n      const { generateProjectionReport } = await import(\"./ai-insights\");\n      const aiReport = await generateProjectionReport({\n        name,\n        targetYear,\n        electionType,\n        scope,\n        state: scope === \"state\" ? state : undefined,\n        position\n      });\n      \n      // Save to database\n      const savedReport = await storage.createProjectionReport({\n        name,\n        targetYear,\n        electionType,\n        scope,\n        state: scope === \"state\" ? state : null,\n        executiveSummary: aiReport.executiveSummary,\n        methodology: aiReport.methodology,\n        dataQuality: aiReport.dataQuality,\n        turnoutProjection: aiReport.turnoutProjection,\n        partyProjections: aiReport.partyProjections,\n        candidateProjections: aiReport.candidateProjections,\n        scenarios: aiReport.scenarios,\n        riskAssessment: aiReport.riskAssessment,\n        confidenceIntervals: aiReport.confidenceIntervals,\n        recommendations: aiReport.recommendations,\n        validUntil: new Date(aiReport.validUntil),\n        status: \"draft\",\n        createdBy: req.user?.id,\n      });\n      \n      await logAudit(req, \"create\", \"projection_report\", String(savedReport.id), { name, targetYear, scope });\n      \n      res.json(savedReport);\n    } catch (error: any) {\n      console.error(\"Failed to create projection report:\", error);\n      res.status(500).json({ error: error.message || \"Failed to create projection report\" });\n    }\n  });\n\n  const updateProjectionReportSchema = z.object({\n    name: z.string().min(1).optional(),\n    status: z.enum([\"draft\", \"published\", \"archived\"]).optional()\n  });\n\n  app.put(\"/api/projection-reports/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid report ID\" });\n      }\n      \n      const validationResult = updateProjectionReportSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Validation failed\", \n          details: validationResult.error.issues \n        });\n      }\n      \n      const { status, name } = validationResult.data;\n      \n      const updated = await storage.updateProjectionReport(id, { status, name });\n      if (!updated) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      \n      await logAudit(req, \"update\", \"projection_report\", String(id), { status, name });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Failed to update projection report:\", error);\n      res.status(500).json({ error: \"Failed to update projection report\" });\n    }\n  });\n\n  app.delete(\"/api/projection-reports/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const deleted = await storage.deleteProjectionReport(id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      \n      await logAudit(req, \"delete\", \"projection_report\", String(id));\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Failed to delete projection report:\", error);\n      res.status(500).json({ error: \"Failed to delete projection report\" });\n    }\n  });\n\n  // Export projection report as CSV\n  app.get(\"/api/projection-reports/:id/export/csv\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const report = await storage.getProjectionReportById(parseInt(req.params.id));\n      if (!report) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      \n      // Generate CSV content\n      let csv = \"Relatório de Projeção Eleitoral\\n\";\n      csv += `Nome,${report.name}\\n`;\n      csv += `Ano Alvo,${report.targetYear}\\n`;\n      csv += `Tipo,${report.electionType}\\n`;\n      csv += `Escopo,${report.scope === \"national\" ? \"Nacional\" : report.state}\\n`;\n      csv += `Gerado em,${report.createdAt}\\n\\n`;\n      \n      // Turnout projection\n      const turnout = report.turnoutProjection as any;\n      if (turnout) {\n        csv += \"PROJEÇÃO DE COMPARECIMENTO\\n\";\n        csv += `Esperado,${turnout.expected}%\\n`;\n        csv += `Confiança,${(turnout.confidence * 100).toFixed(1)}%\\n`;\n        csv += `Margem de Erro,${turnout.marginOfError?.lower}% - ${turnout.marginOfError?.upper}%\\n\\n`;\n      }\n      \n      // Party projections\n      const parties = report.partyProjections as any[];\n      if (parties && parties.length > 0) {\n        csv += \"PROJEÇÕES POR PARTIDO\\n\";\n        csv += \"Partido,Sigla,Votos Esperados (%),Votos Min (%),Votos Max (%),Cadeiras Esperadas,Cadeiras Min,Cadeiras Max,Tendência,Confiança,Margem de Erro\\n\";\n        for (const p of parties) {\n          csv += `${p.party},${p.abbreviation},${p.voteShare?.expected},${p.voteShare?.min},${p.voteShare?.max},${p.seats?.expected},${p.seats?.min},${p.seats?.max},${p.trend},${(p.confidence * 100).toFixed(1)}%,${p.marginOfError}%\\n`;\n        }\n        csv += \"\\n\";\n      }\n      \n      // Candidate projections\n      const candidates = report.candidateProjections as any[];\n      if (candidates && candidates.length > 0) {\n        csv += \"PROJEÇÕES DE CANDIDATOS\\n\";\n        csv += \"Ranking,Nome,Partido,Cargo,Probabilidade de Eleição,Votos Esperados,Votos Min,Votos Max,Confiança\\n\";\n        for (const c of candidates) {\n          csv += `${c.ranking},${c.name},${c.party},${c.position},${(c.electionProbability * 100).toFixed(1)}%,${c.projectedVotes?.expected},${c.projectedVotes?.min},${c.projectedVotes?.max},${(c.confidence * 100).toFixed(1)}%\\n`;\n        }\n        csv += \"\\n\";\n      }\n      \n      // Confidence intervals\n      const confidence = report.confidenceIntervals as any;\n      if (confidence) {\n        csv += \"INTERVALOS DE CONFIANÇA\\n\";\n        csv += `Geral,${(confidence.overall * 100).toFixed(1)}%\\n`;\n        csv += `Comparecimento,${(confidence.turnout * 100).toFixed(1)}%\\n`;\n        csv += `Resultados Partidários,${(confidence.partyResults * 100).toFixed(1)}%\\n`;\n        csv += `Distribuição de Cadeiras,${(confidence.seatDistribution * 100).toFixed(1)}%\\n\\n`;\n      }\n      \n      // Recommendations\n      const recommendations = report.recommendations as string[];\n      if (recommendations && recommendations.length > 0) {\n        csv += \"RECOMENDAÇÕES\\n\";\n        recommendations.forEach((r, i) => {\n          csv += `${i + 1},${r}\\n`;\n        });\n      }\n      \n      res.setHeader(\"Content-Type\", \"text/csv; charset=utf-8\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"projecao-${report.name.replace(/\\s+/g, \"-\")}-${report.targetYear}.csv\"`);\n      res.send(\"\\ufeff\" + csv); // BOM for Excel compatibility\n    } catch (error) {\n      console.error(\"Failed to export projection report:\", error);\n      res.status(500).json({ error: \"Failed to export report\" });\n    }\n  });\n\n  app.get(\"/api/imports/tse\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const jobs = await storage.getTseImportJobs();\n      res.json(jobs);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch import jobs\" });\n    }\n  });\n\n  app.get(\"/api/imports/tse/queue/status\", requireAuth, requireRole(\"admin\"), async (_req, res) => {\n    try {\n      const status = getTseQueueStatus();\n      res.json(status);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch queue status\" });\n    }\n  });\n\n  app.get(\"/api/imports/tse/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const job = await storage.getTseImportJob(parseInt(req.params.id));\n      if (!job) {\n        return res.status(404).json({ error: \"Import job not found\" });\n      }\n      res.json(job);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch import job\" });\n    }\n  });\n\n  app.get(\"/api/imports/tse/:id/errors\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const errors = await storage.getTseImportErrors(parseInt(req.params.id));\n      res.json(errors);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch import errors\" });\n    }\n  });\n\n  // Import Batches API Endpoints\n  app.get(\"/api/imports/tse/:id/batches\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.id);\n      if (isNaN(jobId)) {\n        return res.status(400).json({ error: \"Invalid job ID\" });\n      }\n      const batches = await storage.getImportBatches(jobId);\n      const stats = await storage.getBatchStats(jobId);\n      res.json({ batches, stats });\n    } catch (error) {\n      console.error(\"Failed to fetch import batches:\", error);\n      res.status(500).json({ error: \"Failed to fetch import batches\" });\n    }\n  });\n\n  app.get(\"/api/imports/tse/:jobId/batches/:batchId\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.jobId);\n      const batchId = parseInt(req.params.batchId);\n      if (isNaN(jobId) || isNaN(batchId)) {\n        return res.status(400).json({ error: \"Invalid IDs\" });\n      }\n      \n      const batch = await storage.getImportBatch(batchId);\n      if (!batch || batch.importJobId !== jobId) {\n        return res.status(404).json({ error: \"Batch not found\" });\n      }\n      \n      const rows = await storage.getBatchRows(batchId);\n      const failedRows = rows.filter(r => r.status === \"failed\");\n      \n      res.json({ \n        batch, \n        rows,\n        summary: {\n          total: rows.length,\n          success: rows.filter(r => r.status === \"success\").length,\n          failed: failedRows.length,\n          skipped: rows.filter(r => r.status === \"skipped\").length,\n          pending: rows.filter(r => r.status === \"pending\").length,\n        }\n      });\n    } catch (error) {\n      console.error(\"Failed to fetch batch details:\", error);\n      res.status(500).json({ error: \"Failed to fetch batch details\" });\n    }\n  });\n\n  app.get(\"/api/imports/tse/:jobId/batches/:batchId/failed-rows\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const batchId = parseInt(req.params.batchId);\n      if (isNaN(batchId)) {\n        return res.status(400).json({ error: \"Invalid batch ID\" });\n      }\n      \n      const rows = await storage.getFailedBatchRows(batchId);\n      res.json(rows);\n    } catch (error) {\n      console.error(\"Failed to fetch failed rows:\", error);\n      res.status(500).json({ error: \"Failed to fetch failed rows\" });\n    }\n  });\n\n  app.post(\"/api/imports/tse/:jobId/batches/:batchId/reprocess\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.jobId);\n      const batchId = parseInt(req.params.batchId);\n      if (isNaN(jobId) || isNaN(batchId)) {\n        return res.status(400).json({ error: \"Invalid IDs\" });\n      }\n      \n      const batch = await storage.getImportBatch(batchId);\n      if (!batch || batch.importJobId !== jobId) {\n        return res.status(404).json({ error: \"Batch not found\" });\n      }\n      \n      if (batch.status !== \"failed\") {\n        return res.status(400).json({ error: \"Only failed batches can be reprocessed\" });\n      }\n      \n      // Reset failed rows for reprocessing\n      const resetCount = await storage.resetBatchRowsForReprocess(batchId);\n      \n      // Update batch status\n      await storage.updateImportBatch(batchId, { \n        status: \"pending\",\n        errorCount: 0,\n        processedRows: 0,\n        errorSummary: null,\n      });\n      \n      // Reprocess the batch asynchronously\n      reprocessBatch(batchId, jobId).catch(err => {\n        console.error(`Batch ${batchId} reprocessing failed:`, err);\n      });\n      \n      await logAudit(req, \"update\", \"tse_import_batch\", String(batchId), {\n        action: \"reprocess\",\n        jobId,\n        rowsReset: resetCount,\n      });\n      \n      res.json({ \n        success: true, \n        message: \"Batch reprocessing started\",\n        rowsToReprocess: resetCount\n      });\n    } catch (error) {\n      console.error(\"Failed to reprocess batch:\", error);\n      res.status(500).json({ error: \"Failed to reprocess batch\" });\n    }\n  });\n\n  app.post(\"/api/imports/tse/:id/batches/reprocess-all-failed\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.id);\n      if (isNaN(jobId)) {\n        return res.status(400).json({ error: \"Invalid job ID\" });\n      }\n      \n      const failedBatches = await storage.getFailedBatches(jobId);\n      if (failedBatches.length === 0) {\n        return res.status(400).json({ error: \"No failed batches to reprocess\" });\n      }\n      \n      let totalRowsReset = 0;\n      for (const batch of failedBatches) {\n        const resetCount = await storage.resetBatchRowsForReprocess(batch.id);\n        totalRowsReset += resetCount;\n        \n        await storage.updateImportBatch(batch.id, { \n          status: \"pending\",\n          errorCount: 0,\n          processedRows: 0,\n          errorSummary: null,\n        });\n        \n        // Reprocess each batch asynchronously\n        reprocessBatch(batch.id, jobId).catch(err => {\n          console.error(`Batch ${batch.id} reprocessing failed:`, err);\n        });\n      }\n      \n      await logAudit(req, \"update\", \"tse_import_job\", String(jobId), {\n        action: \"reprocess_all_failed\",\n        batchCount: failedBatches.length,\n        totalRowsReset,\n      });\n      \n      res.json({ \n        success: true, \n        message: `Reprocessing ${failedBatches.length} failed batches`,\n        batchCount: failedBatches.length,\n        totalRowsToReprocess: totalRowsReset\n      });\n    } catch (error) {\n      console.error(\"Failed to reprocess failed batches:\", error);\n      res.status(500).json({ error: \"Failed to reprocess failed batches\" });\n    }\n  });\n\n  // Data Validation API Endpoints\n  app.get(\"/api/imports/tse/:id/validation\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.id);\n      if (isNaN(jobId)) {\n        return res.status(400).json({ error: \"Invalid job ID\" });\n      }\n      \n      const { getValidationStatus } = await import(\"./data-validation\");\n      const status = await getValidationStatus(jobId);\n      res.json(status);\n    } catch (error) {\n      console.error(\"Failed to fetch validation status:\", error);\n      res.status(500).json({ error: \"Failed to fetch validation status\" });\n    }\n  });\n\n  app.post(\"/api/imports/tse/:id/validation/run\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.id);\n      if (isNaN(jobId)) {\n        return res.status(400).json({ error: \"Invalid job ID\" });\n      }\n      \n      const job = await storage.getTseImportJob(jobId);\n      if (!job) {\n        return res.status(404).json({ error: \"Import job not found\" });\n      }\n      \n      if (job.status !== \"completed\") {\n        return res.status(400).json({ error: \"Can only validate completed imports\" });\n      }\n      \n      const { runValidation } = await import(\"./data-validation\");\n      const result = await runValidation(jobId);\n      \n      await logAudit(req, \"create\", \"validation_run\", String(result.runId), {\n        jobId,\n        issuesFound: result.summary.issuesFound,\n      });\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Failed to run validation:\", error);\n      res.status(500).json({ error: \"Failed to run validation\" });\n    }\n  });\n\n  app.get(\"/api/validation-runs/:runId/issues\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const runId = parseInt(req.params.runId);\n      if (isNaN(runId)) {\n        return res.status(400).json({ error: \"Invalid run ID\" });\n      }\n      \n      const type = req.query.type as string | undefined;\n      const severity = req.query.severity as string | undefined;\n      const status = req.query.status as string | undefined;\n      \n      const issues = await storage.getValidationIssuesForRun(runId, { type, severity, status });\n      res.json(issues);\n    } catch (error) {\n      console.error(\"Failed to fetch validation issues:\", error);\n      res.status(500).json({ error: \"Failed to fetch validation issues\" });\n    }\n  });\n\n  // Retroactive import integrity validation endpoint\n  app.post(\"/api/imports/tse/:id/validate-integrity\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.id);\n      if (isNaN(jobId)) {\n        return res.status(400).json({ error: \"Invalid job ID\" });\n      }\n\n      const job = await storage.getTseImportJob(jobId);\n      if (!job) {\n        return res.status(404).json({ error: \"Import job not found\" });\n      }\n\n      if (job.status !== \"completed\") {\n        return res.status(400).json({ error: \"Só é possível validar importações concluídas\" });\n      }\n\n      // Determine import type from filename prefix and count from appropriate table\n      let dbRowCount: number;\n      const filename = job.filename || \"\";\n      if (filename.startsWith(\"[DETALHE]\")) {\n        dbRowCount = await storage.countTseElectoralStatisticsByJob(jobId);\n      } else if (filename.startsWith(\"[PARTIDO]\")) {\n        dbRowCount = await storage.countTsePartyVotesByJob(jobId);\n      } else {\n        // Default to candidate votes table for regular imports\n        dbRowCount = await storage.countTseCandidateVotesByJob(jobId);\n      }\n      \n      // Calculate expected count based on what we know\n      const totalFileRows = job.totalFileRows || job.processedRows || 0;\n      const skippedRows = job.skippedRows || 0;\n      const errorCount = job.errorCount || 0;\n      const expectedCount = job.processedRows || (totalFileRows - skippedRows - errorCount);\n      \n      const isValid = dbRowCount === expectedCount;\n      const validationMessage = isValid \n        ? `Validação OK: ${dbRowCount.toLocaleString(\"pt-BR\")} registros verificados no banco`\n        : `Discrepância detectada: esperado ${expectedCount.toLocaleString(\"pt-BR\")}, encontrado ${dbRowCount.toLocaleString(\"pt-BR\")} no banco`;\n\n      // Update job with validation results\n      await storage.updateTseImportJob(jobId, {\n        validationStatus: isValid ? \"passed\" : \"failed\",\n        validationMessage: validationMessage,\n        validatedAt: new Date(),\n        updatedAt: new Date(),\n      });\n\n      await logAudit(req, \"validate\", \"tse_import\", String(jobId), {\n        isValid,\n        dbRowCount,\n        expectedCount,\n        validationMessage\n      });\n\n      res.json({\n        success: true,\n        isValid,\n        dbRowCount,\n        expectedCount,\n        totalFileRows,\n        skippedRows,\n        errorCount,\n        validationMessage,\n        validatedAt: new Date().toISOString()\n      });\n    } catch (error: any) {\n      console.error(\"Failed to validate import integrity:\", error);\n      res.status(500).json({ error: \"Failed to validate import integrity\" });\n    }\n  });\n\n  // Cancel a running import job\n  app.post(\"/api/imports/tse/:id/cancel\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.id);\n      if (isNaN(jobId)) {\n        return res.status(400).json({ error: \"Invalid job ID\" });\n      }\n\n      const job = await storage.getTseImportJob(jobId);\n      if (!job) {\n        return res.status(404).json({ error: \"Import job not found\" });\n      }\n\n      const inProgressStatuses = [\"pending\", \"queued\", \"downloading\", \"extracting\", \"processing\"];\n      if (!inProgressStatuses.includes(job.status || \"\") && job.stage !== \"queued\") {\n        return res.status(400).json({ \n          error: \"Só é possível cancelar importações em andamento\",\n          currentStatus: job.status\n        });\n      }\n\n      // Remove from queue if still pending\n      removeFromTseQueue(jobId);\n\n      // Signal cancellation\n      const activeJob = activeImportJobs.get(jobId);\n      if (activeJob) {\n        activeJob.cancelled = true;\n        activeJob.abortController?.abort();\n      } else {\n        activeImportJobs.set(jobId, { cancelled: true });\n      }\n\n      await storage.updateTseImportJob(jobId, {\n        status: \"cancelled\",\n        stage: \"cancelled\",\n        completedAt: new Date(),\n        updatedAt: new Date(),\n        errorMessage: \"Importação cancelada pelo usuário\",\n      });\n\n      // Clean up temp files\n      const tmpDir = `/tmp/tse-import-${jobId}`;\n      await rm(tmpDir, { recursive: true, force: true }).catch(() => {});\n\n      await logAudit(req, \"cancel\", \"tse_import\", String(jobId), { previousStatus: job.status });\n\n      res.json({ success: true, message: \"Importação cancelada com sucesso\" });\n    } catch (error: any) {\n      console.error(\"Failed to cancel import:\", error);\n      res.status(500).json({ error: \"Failed to cancel import\" });\n    }\n  });\n\n  // Restart a failed/cancelled import job\n  app.post(\"/api/imports/tse/:id/restart\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.id);\n      if (isNaN(jobId)) {\n        return res.status(400).json({ error: \"Invalid job ID\" });\n      }\n\n      const job = await storage.getTseImportJob(jobId);\n      if (!job) {\n        return res.status(404).json({ error: \"Import job not found\" });\n      }\n\n      const restartableStatuses = [\"failed\", \"cancelled\"];\n      if (!restartableStatuses.includes(job.status || \"\")) {\n        return res.status(400).json({ \n          error: \"Só é possível reiniciar importações falhadas ou canceladas\",\n          currentStatus: job.status\n        });\n      }\n\n      // Check if it's a URL import\n      const isUrlImport = job.filename?.startsWith(\"[URL]\");\n      if (!isUrlImport) {\n        return res.status(400).json({ \n          error: \"Apenas importações via URL podem ser reiniciadas. Para arquivos, faça upload novamente.\"\n        });\n      }\n\n      // Delete existing votes for this job\n      await storage.deleteTseCandidateVotesByJob(jobId);\n      \n      // Delete existing errors\n      await storage.deleteTseImportErrorsByJob(jobId);\n\n      // Reset job state\n      activeImportJobs.delete(jobId);\n      await storage.updateTseImportJob(jobId, {\n        status: \"pending\",\n        stage: \"pending\",\n        downloadedBytes: 0,\n        totalRows: 0,\n        processedRows: 0,\n        skippedRows: 0,\n        errorCount: 0,\n        errorMessage: null,\n        totalFileRows: null,\n        validationStatus: \"pending\",\n        validationMessage: null,\n        validatedAt: null,\n        startedAt: null,\n        completedAt: null,\n        updatedAt: new Date(),\n      });\n\n      await logAudit(req, \"restart\", \"tse_import\", String(jobId), { previousStatus: job.status });\n\n      // Use stored sourceUrl for reliable restart\n      if (job.sourceUrl) {\n        processURLImport(jobId, job.sourceUrl);\n      } else {\n        // Fallback: try to reconstruct URL from filename (legacy support)\n        const urlMatch = job.filename?.match(/\\[URL\\] (.+)/);\n        if (urlMatch) {\n          const filename = urlMatch[1];\n          const url = `https://cdn.tse.jus.br/estatistica/sead/odsele/votacao_candidato_munzona/${filename}`;\n          processURLImport(jobId, url);\n        } else {\n          return res.status(400).json({ \n            error: \"URL de origem não encontrada. Faça upload do arquivo novamente.\"\n          });\n        }\n      }\n\n      res.json({ success: true, message: \"Importação reiniciada com sucesso\", jobId });\n    } catch (error: any) {\n      console.error(\"Failed to restart import:\", error);\n      res.status(500).json({ error: \"Failed to restart import\" });\n    }\n  });\n\n  // Delete an import job and its data\n  app.delete(\"/api/imports/tse/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.id);\n      if (isNaN(jobId)) {\n        return res.status(400).json({ error: \"Invalid job ID\" });\n      }\n\n      const job = await storage.getTseImportJob(jobId);\n      if (!job) {\n        return res.status(404).json({ error: \"Import job not found\" });\n      }\n\n      const inProgressStatuses = [\"pending\", \"downloading\", \"extracting\", \"processing\"];\n      if (inProgressStatuses.includes(job.status || \"\")) {\n        return res.status(400).json({ \n          error: \"Não é possível excluir importações em andamento. Cancele primeiro.\",\n          currentStatus: job.status\n        });\n      }\n\n      // Delete data associated with this job based on import type\n      const filename = job.filename || \"\";\n      if (filename.includes(\"[PARTIDO]\")) {\n        await storage.deleteTsePartyVotesByJob(jobId);\n        console.log(`[DELETE] Deleted party votes for job ${jobId}`);\n      } else if (filename.includes(\"[DETALHE]\")) {\n        await storage.deleteTseElectoralStatisticsByJob(jobId);\n        console.log(`[DELETE] Deleted electoral statistics for job ${jobId}`);\n      } else {\n        // Default: candidate votes\n        await storage.deleteTseCandidateVotesByJob(jobId);\n        console.log(`[DELETE] Deleted candidate votes for job ${jobId}`);\n      }\n      \n      // Delete batches associated with this job\n      await storage.deleteBatchesByJob(jobId);\n      \n      // Delete errors associated with this job\n      await storage.deleteTseImportErrorsByJob(jobId);\n\n      // Delete validation runs and issues associated with this job\n      await storage.deleteValidationRunsByJob(jobId);\n\n      // Delete the job itself\n      await storage.deleteTseImportJob(jobId);\n\n      // Clean up temp files if any\n      const tmpDir = `/tmp/tse-import-${jobId}`;\n      await rm(tmpDir, { recursive: true, force: true }).catch(() => {});\n\n      await logAudit(req, \"delete\", \"tse_import\", String(jobId), { filename: job.filename });\n\n      res.json({ success: true, message: \"Importação excluída com sucesso\" });\n    } catch (error: any) {\n      console.error(\"Failed to delete import:\", error);\n      res.status(500).json({ error: \"Failed to delete import\" });\n    }\n  });\n\n  // List downloaded files\n  app.get(\"/api/imports/files\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const baseDir = \"/tmp\";\n      const entries = await readdir(baseDir, { withFileTypes: true });\n      \n      const importDirs = entries.filter(entry => \n        entry.isDirectory() && entry.name.startsWith(\"tse-import-\")\n      );\n\n      const files: Array<{\n        jobId: number;\n        directory: string;\n        files: Array<{ name: string; size: number; modifiedAt: string }>;\n        totalSize: number;\n      }> = [];\n\n      for (const dir of importDirs) {\n        const jobIdMatch = dir.name.match(/tse-import-(\\d+)/);\n        if (!jobIdMatch) continue;\n\n        const jobId = parseInt(jobIdMatch[1]);\n        const dirPath = path.join(baseDir, dir.name);\n        \n        try {\n          const dirEntries = await readdir(dirPath);\n          const fileInfos: Array<{ name: string; size: number; modifiedAt: string }> = [];\n          let totalSize = 0;\n\n          for (const fileName of dirEntries) {\n            const filePath = path.join(dirPath, fileName);\n            try {\n              const fileStat = await stat(filePath);\n              if (fileStat.isFile()) {\n                fileInfos.push({\n                  name: fileName,\n                  size: fileStat.size,\n                  modifiedAt: fileStat.mtime.toISOString()\n                });\n                totalSize += fileStat.size;\n              }\n            } catch (e) {\n              // Skip files we can't stat\n            }\n          }\n\n          if (fileInfos.length > 0) {\n            files.push({\n              jobId,\n              directory: dir.name,\n              files: fileInfos,\n              totalSize\n            });\n          }\n        } catch (e) {\n          // Skip directories we can't read\n        }\n      }\n\n      // Also check /tmp/uploads for uploaded files\n      const uploadsDir = \"/tmp/uploads\";\n      try {\n        const uploadEntries = await readdir(uploadsDir);\n        const uploadFiles: Array<{ name: string; size: number; modifiedAt: string }> = [];\n        let uploadsTotalSize = 0;\n\n        for (const fileName of uploadEntries) {\n          const filePath = path.join(uploadsDir, fileName);\n          try {\n            const fileStat = await stat(filePath);\n            if (fileStat.isFile()) {\n              uploadFiles.push({\n                name: fileName,\n                size: fileStat.size,\n                modifiedAt: fileStat.mtime.toISOString()\n              });\n              uploadsTotalSize += fileStat.size;\n            }\n          } catch (e) {\n            // Skip files we can't stat\n          }\n        }\n\n        if (uploadFiles.length > 0) {\n          files.push({\n            jobId: 0,\n            directory: \"uploads\",\n            files: uploadFiles,\n            totalSize: uploadsTotalSize\n          });\n        }\n      } catch (e) {\n        // Uploads directory doesn't exist or can't be read\n      }\n\n      res.json(files);\n    } catch (error: any) {\n      console.error(\"Failed to list import files:\", error);\n      res.status(500).json({ error: \"Failed to list import files\" });\n    }\n  });\n\n  // Delete import files for a specific job\n  app.delete(\"/api/imports/files/:jobId\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.jobId);\n      \n      if (jobId === 0) {\n        // Delete all uploads\n        const uploadsDir = \"/tmp/uploads\";\n        await rm(uploadsDir, { recursive: true, force: true });\n        await mkdir(uploadsDir, { recursive: true });\n        \n        await logAudit(req, \"delete_files\", \"uploads\", \"all\", {});\n        \n        return res.json({ success: true, message: \"Arquivos de upload excluídos com sucesso\" });\n      }\n\n      if (isNaN(jobId)) {\n        return res.status(400).json({ error: \"Invalid job ID\" });\n      }\n\n      const tmpDir = `/tmp/tse-import-${jobId}`;\n      await rm(tmpDir, { recursive: true, force: true });\n\n      await logAudit(req, \"delete_files\", \"tse_import\", String(jobId), {});\n\n      res.json({ success: true, message: \"Arquivos excluídos com sucesso\" });\n    } catch (error: any) {\n      console.error(\"Failed to delete import files:\", error);\n      res.status(500).json({ error: \"Failed to delete import files\" });\n    }\n  });\n\n  app.patch(\"/api/validation-issues/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const issueId = parseInt(req.params.id);\n      if (isNaN(issueId)) {\n        return res.status(400).json({ error: \"Invalid issue ID\" });\n      }\n      \n      const { status } = req.body;\n      if (!status || ![\"open\", \"resolved\", \"ignored\"].includes(status)) {\n        return res.status(400).json({ error: \"Invalid status. Must be: open, resolved, or ignored\" });\n      }\n      \n      const user = req.user as any;\n      const updateData: any = { status };\n      \n      if (status === \"resolved\" || status === \"ignored\") {\n        updateData.resolvedBy = user?.id;\n        updateData.resolvedAt = new Date();\n      } else {\n        updateData.resolvedBy = null;\n        updateData.resolvedAt = null;\n      }\n      \n      const updated = await storage.updateValidationIssue(issueId, updateData);\n      if (!updated) {\n        return res.status(404).json({ error: \"Issue not found\" });\n      }\n      \n      await logAudit(req, \"update\", \"validation_issue\", String(issueId), { status });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Failed to update validation issue:\", error);\n      res.status(500).json({ error: \"Failed to update validation issue\" });\n    }\n  });\n\n  // Forecasting endpoints\n  const { createAndRunForecast, getForecastSummary, runForecast } = await import(\"./forecasting\");\n\n  app.get(\"/api/forecasts\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const targetYear = req.query.targetYear ? parseInt(req.query.targetYear as string) : undefined;\n      const status = req.query.status as string | undefined;\n      const forecasts = await storage.getForecastRuns({ targetYear, status });\n      res.json(forecasts);\n    } catch (error) {\n      console.error(\"Failed to fetch forecasts:\", error);\n      res.status(500).json({ error: \"Failed to fetch forecasts\" });\n    }\n  });\n\n  app.get(\"/api/forecasts/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid forecast ID\" });\n      }\n      \n      const summary = await getForecastSummary(id);\n      if (!summary) {\n        return res.status(404).json({ error: \"Forecast not found\" });\n      }\n      \n      res.json(summary);\n    } catch (error) {\n      console.error(\"Failed to fetch forecast:\", error);\n      res.status(500).json({ error: \"Failed to fetch forecast\" });\n    }\n  });\n\n  app.get(\"/api/forecasts/:id/results\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid forecast ID\" });\n      }\n      \n      const resultType = req.query.resultType as string | undefined;\n      const region = req.query.region as string | undefined;\n      \n      const results = await storage.getForecastResults(id, { resultType, region });\n      res.json(results);\n    } catch (error) {\n      console.error(\"Failed to fetch forecast results:\", error);\n      res.status(500).json({ error: \"Failed to fetch forecast results\" });\n    }\n  });\n\n  app.get(\"/api/forecasts/:id/swing-regions\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid forecast ID\" });\n      }\n      \n      const swingRegions = await storage.getSwingRegions(id);\n      res.json(swingRegions);\n    } catch (error) {\n      console.error(\"Failed to fetch swing regions:\", error);\n      res.status(500).json({ error: \"Failed to fetch swing regions\" });\n    }\n  });\n\n  app.post(\"/api/forecasts\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const user = req.user as any;\n      const { name, description, targetYear, targetPosition, targetState, targetElectionType, historicalYears, modelParameters } = req.body;\n      \n      if (!name || !targetYear) {\n        return res.status(400).json({ error: \"Name and target year are required\" });\n      }\n      \n      const forecastRun = await createAndRunForecast(user.id, {\n        name,\n        description,\n        targetYear,\n        targetPosition,\n        targetState,\n        targetElectionType,\n        historicalYears,\n        modelParameters,\n      });\n      \n      await logAudit(req, \"create\", \"forecast\", String(forecastRun.id), { name, targetYear });\n      \n      res.status(201).json(forecastRun);\n    } catch (error) {\n      console.error(\"Failed to create forecast:\", error);\n      res.status(500).json({ error: \"Failed to create forecast\" });\n    }\n  });\n\n  app.delete(\"/api/forecasts/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid forecast ID\" });\n      }\n      \n      const deleted = await storage.deleteForecastRun(id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Forecast not found\" });\n      }\n      \n      await logAudit(req, \"delete\", \"forecast\", String(id));\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Failed to delete forecast:\", error);\n      res.status(500).json({ error: \"Failed to delete forecast\" });\n    }\n  });\n\n  // Prediction Scenario endpoints\n  app.get(\"/api/prediction-scenarios\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const status = req.query.status as string | undefined;\n      const targetYear = req.query.targetYear ? parseInt(req.query.targetYear as string) : undefined;\n      const scenarios = await storage.getPredictionScenarios({ status, targetYear });\n      res.json(scenarios);\n    } catch (error) {\n      console.error(\"Failed to fetch prediction scenarios:\", error);\n      res.status(500).json({ error: \"Failed to fetch prediction scenarios\" });\n    }\n  });\n\n  app.get(\"/api/prediction-scenarios/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid scenario ID\" });\n      }\n      const scenario = await storage.getPredictionScenario(id);\n      if (!scenario) {\n        return res.status(404).json({ error: \"Prediction scenario not found\" });\n      }\n      res.json(scenario);\n    } catch (error) {\n      console.error(\"Failed to fetch prediction scenario:\", error);\n      res.status(500).json({ error: \"Failed to fetch prediction scenario\" });\n    }\n  });\n\n  app.post(\"/api/prediction-scenarios\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { name, description, targetYear, baseYear, pollingData, partyAdjustments, externalFactors, parameters } = req.body;\n      \n      if (!name || !targetYear || !baseYear) {\n        return res.status(400).json({ error: \"Name, target year, and base year are required\" });\n      }\n\n      const scenario = await storage.createPredictionScenario({\n        name,\n        description,\n        targetYear,\n        baseYear,\n        pollingData: pollingData || null,\n        partyAdjustments: partyAdjustments || null,\n        externalFactors: externalFactors || null,\n        parameters: parameters || { pollingWeight: 0.30, historicalWeight: 0.50, adjustmentWeight: 0.20, monteCarloIterations: 10000, confidenceLevel: 0.95 },\n        status: \"draft\",\n        createdBy: (req.user as any)?.id || null,\n      });\n\n      await logAudit(req, \"create\", \"prediction_scenario\", String(scenario.id));\n      res.status(201).json(scenario);\n    } catch (error) {\n      console.error(\"Failed to create prediction scenario:\", error);\n      res.status(500).json({ error: \"Failed to create prediction scenario\" });\n    }\n  });\n\n  app.patch(\"/api/prediction-scenarios/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid scenario ID\" });\n      }\n\n      const existing = await storage.getPredictionScenario(id);\n      if (!existing) {\n        return res.status(404).json({ error: \"Prediction scenario not found\" });\n      }\n\n      const updated = await storage.updatePredictionScenario(id, req.body);\n      await logAudit(req, \"update\", \"prediction_scenario\", String(id));\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Failed to update prediction scenario:\", error);\n      res.status(500).json({ error: \"Failed to update prediction scenario\" });\n    }\n  });\n\n  app.delete(\"/api/prediction-scenarios/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid scenario ID\" });\n      }\n\n      const deleted = await storage.deletePredictionScenario(id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Prediction scenario not found\" });\n      }\n\n      await logAudit(req, \"delete\", \"prediction_scenario\", String(id));\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Failed to delete prediction scenario:\", error);\n      res.status(500).json({ error: \"Failed to delete prediction scenario\" });\n    }\n  });\n\n  // Run prediction scenario with Monte Carlo simulation\n  app.post(\"/api/prediction-scenarios/:id/run\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid scenario ID\" });\n      }\n\n      const scenario = await storage.getPredictionScenario(id);\n      if (!scenario) {\n        return res.status(404).json({ error: \"Prediction scenario not found\" });\n      }\n\n      // Update status to running\n      await storage.updatePredictionScenario(id, { status: \"running\" });\n\n      // Create a forecast run based on this scenario\n      const forecast = await storage.createForecastRun({\n        name: `Previsão: ${scenario.name}`,\n        targetYear: scenario.targetYear,\n        status: \"running\",\n        createdBy: (req.user as any)?.id || null,\n      });\n\n      // Run forecasting in background\n      import(\"./forecasting\").then(async ({ runForecast }) => {\n        try {\n          await runForecast(forecast.id, { targetYear: scenario.targetYear });\n          await storage.updatePredictionScenario(id, { \n            status: \"completed\", \n            lastRunAt: new Date(),\n            forecastRunId: forecast.id \n          });\n        } catch (error) {\n          console.error(\"Forecast with scenario failed:\", error);\n          await storage.updatePredictionScenario(id, { status: \"failed\" });\n          await storage.updateForecastRun(forecast.id, { status: \"failed\" });\n        }\n      });\n\n      await logAudit(req, \"run\", \"prediction_scenario\", String(id));\n      res.json({ success: true, forecastId: forecast.id, message: \"Prediction scenario execution started\" });\n    } catch (error) {\n      console.error(\"Failed to run prediction scenario:\", error);\n      res.status(500).json({ error: \"Failed to run prediction scenario\" });\n    }\n  });\n\n  // ===== Candidate Comparison Predictions =====\n\n  // Get all candidate comparisons\n  app.get(\"/api/candidate-comparisons\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const comparisons = await db.select().from(candidateComparisons).orderBy(sql`created_at DESC`);\n      res.json(comparisons);\n    } catch (error) {\n      console.error(\"Failed to fetch candidate comparisons:\", error);\n      res.status(500).json({ error: \"Failed to fetch candidate comparisons\" });\n    }\n  });\n\n  // Create candidate comparison\n  app.post(\"/api/candidate-comparisons\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { name, description, candidateIds, state, position, targetYear, baseYear, compareMetrics, includeHistorical } = req.body;\n      \n      if (!name || !candidateIds || candidateIds.length < 2) {\n        return res.status(400).json({ error: \"Name and at least 2 candidates are required\" });\n      }\n\n      const [comparison] = await db.insert(candidateComparisons).values({\n        name,\n        description,\n        candidateIds,\n        state: state || null,\n        position: position || null,\n        targetYear: targetYear || new Date().getFullYear() + 2,\n        baseYear: baseYear || null,\n        compareMetrics: compareMetrics || { voteShare: true, electionProbability: true, trend: true },\n        includeHistorical: includeHistorical ?? true,\n        status: \"draft\",\n        createdBy: (req.user as any)?.id || null,\n      }).returning();\n\n      await logAudit(req, \"create\", \"candidate_comparison\", String(comparison.id));\n      res.status(201).json(comparison);\n    } catch (error) {\n      console.error(\"Failed to create candidate comparison:\", error);\n      res.status(500).json({ error: \"Failed to create candidate comparison\" });\n    }\n  });\n\n  // Run candidate comparison analysis\n  app.post(\"/api/candidate-comparisons/:id/run\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const [comparison] = await db.select().from(candidateComparisons).where(eq(candidateComparisons.id, id));\n      \n      if (!comparison) {\n        return res.status(404).json({ error: \"Comparison not found\" });\n      }\n\n      // Update status\n      await db.update(candidateComparisons).set({ status: \"running\" }).where(eq(candidateComparisons.id, id));\n\n      // Get candidate data\n      const candidateIds = comparison.candidateIds as string[];\n      const candidates = await storage.getCandidates();\n      const matchedCandidates = candidates.filter(c => \n        candidateIds.some(id => \n          c.id.toString() === id || \n          c.name.toLowerCase().includes(id.toLowerCase()) ||\n          c.nickname?.toLowerCase().includes(id.toLowerCase())\n        )\n      );\n\n      // Build comparison using AI\n      const openai = new OpenAI();\n      const prompt = `Você é um analista político especializado em eleições brasileiras.\nCompare os seguintes candidatos e forneça uma análise detalhada:\n\nCandidatos para comparação:\n${matchedCandidates.map(c => `- ${c.name} (${c.nickname || 'Sem apelido'}) - Partido ID: ${c.partyId}, Cargo: ${c.position}`).join('\\n')}\n\n${candidateIds.filter(id => !matchedCandidates.some(c => c.id.toString() === id || c.name.toLowerCase().includes(id.toLowerCase()))).length > 0 ? \n`Candidatos não encontrados no banco de dados (analisar com base em conhecimento geral): ${candidateIds.filter(id => !matchedCandidates.some(c => c.id.toString() === id || c.name.toLowerCase().includes(id.toLowerCase()))).join(', ')}` : ''}\n\nEstado: ${comparison.state || 'Nacional'}\nCargo: ${comparison.position || 'Geral'}\nAno alvo: ${comparison.targetYear}\n\nResponda em JSON:\n{\n  \"candidates\": [\n    {\n      \"name\": \"nome\",\n      \"party\": \"partido\",\n      \"projectedVoteShare\": número_percentual,\n      \"electionProbability\": número_0_a_1,\n      \"strengths\": [\"força1\", \"força2\"],\n      \"weaknesses\": [\"fraqueza1\"],\n      \"trend\": \"growing\" | \"declining\" | \"stable\",\n      \"historicalPerformance\": \"descrição breve\"\n    }\n  ],\n  \"headToHead\": [\n    { \"candidate1\": \"nome1\", \"candidate2\": \"nome2\", \"advantage\": \"nome do favorito\", \"margin\": número_percentual }\n  ],\n  \"overallWinner\": \"nome do candidato com maior probabilidade\",\n  \"keyDifferentiators\": [\"diferença1\", \"diferença2\"],\n  \"narrative\": \"Análise comparativa em 2-3 parágrafos em português\",\n  \"confidence\": número_0_a_1\n}`;\n\n      const completion = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n      });\n\n      const results = JSON.parse(completion.choices[0]?.message?.content || \"{}\");\n\n      await db.update(candidateComparisons).set({\n        status: \"completed\",\n        results,\n        narrative: results.narrative,\n        aiInsights: { headToHead: results.headToHead, keyDifferentiators: results.keyDifferentiators },\n        completedAt: new Date(),\n      }).where(eq(candidateComparisons.id, id));\n\n      const [updated] = await db.select().from(candidateComparisons).where(eq(candidateComparisons.id, id));\n      await logAudit(req, \"run\", \"candidate_comparison\", String(id));\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Failed to run candidate comparison:\", error);\n      res.status(500).json({ error: \"Failed to run candidate comparison\" });\n    }\n  });\n\n  // Delete candidate comparison\n  app.delete(\"/api/candidate-comparisons/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await db.delete(candidateComparisons).where(eq(candidateComparisons.id, id));\n      await logAudit(req, \"delete\", \"candidate_comparison\", String(id));\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Failed to delete candidate comparison:\", error);\n      res.status(500).json({ error: \"Failed to delete candidate comparison\" });\n    }\n  });\n\n  // ===== Event Impact Predictions =====\n\n  // Get all event impact predictions\n  app.get(\"/api/event-impacts\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const predictions = await db.select().from(eventImpactPredictions).orderBy(sql`created_at DESC`);\n      res.json(predictions);\n    } catch (error) {\n      console.error(\"Failed to fetch event impacts:\", error);\n      res.status(500).json({ error: \"Failed to fetch event impact predictions\" });\n    }\n  });\n\n  // Create event impact prediction\n  app.post(\"/api/event-impacts\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { \n        name, eventDescription, eventType, eventDate, affectedEntities, \n        state, position, targetYear, estimatedImpactMagnitude, impactDuration, impactDistribution \n      } = req.body;\n\n      if (!name || !eventDescription || !eventType || !affectedEntities) {\n        return res.status(400).json({ error: \"Name, event description, type, and affected entities are required\" });\n      }\n\n      const [prediction] = await db.insert(eventImpactPredictions).values({\n        name,\n        eventDescription,\n        eventType,\n        eventDate: eventDate ? new Date(eventDate) : null,\n        affectedEntities,\n        state: state || null,\n        position: position || null,\n        targetYear: targetYear || new Date().getFullYear() + 2,\n        estimatedImpactMagnitude: estimatedImpactMagnitude?.toString() || null,\n        impactDuration: impactDuration || \"medium-term\",\n        impactDistribution: impactDistribution || { direct: 0.7, indirect: 0.3 },\n        status: \"draft\",\n        createdBy: (req.user as any)?.id || null,\n      }).returning();\n\n      await logAudit(req, \"create\", \"event_impact_prediction\", String(prediction.id));\n      res.status(201).json(prediction);\n    } catch (error) {\n      console.error(\"Failed to create event impact prediction:\", error);\n      res.status(500).json({ error: \"Failed to create event impact prediction\" });\n    }\n  });\n\n  // Run event impact analysis\n  app.post(\"/api/event-impacts/:id/run\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const [prediction] = await db.select().from(eventImpactPredictions).where(eq(eventImpactPredictions.id, id));\n      \n      if (!prediction) {\n        return res.status(404).json({ error: \"Event impact prediction not found\" });\n      }\n\n      await db.update(eventImpactPredictions).set({ status: \"running\" }).where(eq(eventImpactPredictions.id, id));\n\n      const affected = prediction.affectedEntities as { parties?: string[]; candidates?: string[]; regions?: string[] };\n      \n      // Get baseline data\n      const parties = await storage.getParties();\n      const affectedParties = parties.filter(p => affected.parties?.includes(p.abbreviation));\n\n      const openai = new OpenAI();\n      const prompt = `Você é um analista político especializado em previsões eleitorais brasileiras.\nAnalise o impacto do seguinte evento nas eleições:\n\nEVENTO: ${prediction.eventDescription}\nTipo: ${prediction.eventType}\nData do evento: ${prediction.eventDate ? new Date(prediction.eventDate).toLocaleDateString('pt-BR') : 'Não especificada'}\nMagnitude estimada: ${prediction.estimatedImpactMagnitude || 'A determinar'}\nDuração do impacto: ${prediction.impactDuration}\n\nENTIDADES AFETADAS:\n- Partidos: ${affected.parties?.join(', ') || 'Nenhum especificado'}\n- Candidatos: ${affected.candidates?.join(', ') || 'Nenhum especificado'}\n- Regiões: ${affected.regions?.join(', ') || 'Nacional'}\n\nEscopo: ${prediction.state || 'Nacional'}, ${prediction.position || 'Geral'}\nAno alvo: ${prediction.targetYear}\n\nPartidos no sistema: ${affectedParties.map(p => `${p.abbreviation} (${p.name})`).join(', ') || 'Dados não disponíveis'}\n\nForneça projeções ANTES e DEPOIS do evento em JSON:\n{\n  \"beforeProjection\": {\n    \"parties\": [{ \"party\": \"sigla\", \"voteShare\": número, \"seats\": número, \"trend\": \"growing\"|\"stable\"|\"declining\" }],\n    \"overall\": { \"favoriteParty\": \"sigla\", \"competitiveness\": \"alta\"|\"média\"|\"baixa\", \"uncertainty\": número_0_a_1 }\n  },\n  \"afterProjection\": {\n    \"parties\": [{ \"party\": \"sigla\", \"voteShare\": número, \"seats\": número, \"trend\": \"growing\"|\"stable\"|\"declining\" }],\n    \"overall\": { \"favoriteParty\": \"sigla\", \"competitiveness\": \"alta\"|\"média\"|\"baixa\", \"uncertainty\": número_0_a_1 }\n  },\n  \"impactDelta\": {\n    \"biggestGainer\": { \"party\": \"sigla\", \"voteShareChange\": número, \"seatChange\": número },\n    \"biggestLoser\": { \"party\": \"sigla\", \"voteShareChange\": número, \"seatChange\": número },\n    \"totalVolatility\": número_percentual\n  },\n  \"confidenceIntervals\": {\n    \"overall\": número_0_a_1,\n    \"beforeAccuracy\": número_0_a_1,\n    \"afterAccuracy\": número_0_a_1\n  },\n  \"narrative\": \"Análise detalhada do impacto em 3-4 parágrafos em português, explicando as projeções antes e depois do evento\",\n  \"keyInsights\": [\"insight1\", \"insight2\", \"insight3\"]\n}`;\n\n      const completion = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n      });\n\n      const results = JSON.parse(completion.choices[0]?.message?.content || \"{}\");\n\n      await db.update(eventImpactPredictions).set({\n        status: \"completed\",\n        beforeProjection: results.beforeProjection,\n        afterProjection: results.afterProjection,\n        impactDelta: results.impactDelta,\n        confidenceIntervals: results.confidenceIntervals,\n        narrative: results.narrative,\n        aiAnalysis: { keyInsights: results.keyInsights },\n        completedAt: new Date(),\n      }).where(eq(eventImpactPredictions.id, id));\n\n      const [updated] = await db.select().from(eventImpactPredictions).where(eq(eventImpactPredictions.id, id));\n      await logAudit(req, \"run\", \"event_impact_prediction\", String(id));\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Failed to run event impact prediction:\", error);\n      res.status(500).json({ error: \"Failed to run event impact prediction\" });\n    }\n  });\n\n  // Delete event impact prediction\n  app.delete(\"/api/event-impacts/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await db.delete(eventImpactPredictions).where(eq(eventImpactPredictions.id, id));\n      await logAudit(req, \"delete\", \"event_impact_prediction\", String(id));\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Failed to delete event impact prediction:\", error);\n      res.status(500).json({ error: \"Failed to delete event impact prediction\" });\n    }\n  });\n\n  // ===== Scenario Simulations (What-If) =====\n\n  // Get all scenario simulations\n  app.get(\"/api/scenario-simulations\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const simulations = await db.select().from(scenarioSimulations).orderBy(sql`created_at DESC`);\n      res.json(simulations);\n    } catch (error) {\n      console.error(\"Failed to fetch scenario simulations:\", error);\n      res.status(500).json({ error: \"Failed to fetch scenario simulations\" });\n    }\n  });\n\n  // Create scenario simulation\n  app.post(\"/api/scenario-simulations\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { name, description, simulationType, baseScenario, modifiedScenario, parameters, scope, reportId } = req.body;\n\n      if (!name || !simulationType || !baseScenario || !modifiedScenario) {\n        return res.status(400).json({ error: \"Name, simulation type, base and modified scenarios are required\" });\n      }\n\n      const [simulation] = await db.insert(scenarioSimulations).values({\n        name,\n        description,\n        simulationType,\n        baseScenario,\n        modifiedScenario,\n        parameters: parameters || {},\n        scope: scope || {},\n        status: \"draft\",\n        reportId: reportId || null,\n        createdBy: (req.user as any)?.id || null,\n      }).returning();\n\n      await logAudit(req, \"create\", \"scenario_simulation\", String(simulation.id));\n      res.status(201).json(simulation);\n    } catch (error) {\n      console.error(\"Failed to create scenario simulation:\", error);\n      res.status(500).json({ error: \"Failed to create scenario simulation\" });\n    }\n  });\n\n  // Run scenario simulation\n  app.post(\"/api/scenario-simulations/:id/run\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const [simulation] = await db.select().from(scenarioSimulations).where(eq(scenarioSimulations.id, id));\n      \n      if (!simulation) {\n        return res.status(404).json({ error: \"Scenario simulation not found\" });\n      }\n\n      await db.update(scenarioSimulations).set({ status: \"running\" }).where(eq(scenarioSimulations.id, id));\n\n      const baseScenario = simulation.baseScenario as any;\n      const modifiedScenario = simulation.modifiedScenario as any;\n      const params = simulation.parameters as any;\n      const scope = simulation.scope as any;\n\n      const openai = new OpenAI();\n      const prompt = `Você é um analista político especializado em simulações eleitorais brasileiras.\nSimule o seguinte cenário \"E se...\":\n\nTIPO DE SIMULAÇÃO: ${simulation.simulationType}\n${simulation.description ? `Descrição: ${simulation.description}` : ''}\n\nCENÁRIO BASE (situação atual):\n${JSON.stringify(baseScenario, null, 2)}\n\nMODIFICAÇÃO PROPOSTA (o que mudaria):\n${JSON.stringify(modifiedScenario, null, 2)}\n\nPARÂMETROS:\n${JSON.stringify(params, null, 2)}\n\nESCOPO:\n${JSON.stringify(scope, null, 2)}\n\nAnalise o impacto dessa mudança hipotética e forneça:\n{\n  \"baselineResults\": {\n    \"parties\": [{ \"party\": \"sigla\", \"seats\": número, \"voteShare\": número }],\n    \"dominantParty\": \"sigla\",\n    \"competitiveness\": \"alta\"|\"média\"|\"baixa\"\n  },\n  \"simulatedResults\": {\n    \"parties\": [{ \"party\": \"sigla\", \"seats\": número, \"voteShare\": número, \"changeFromBaseline\": número }],\n    \"dominantParty\": \"sigla\",\n    \"competitiveness\": \"alta\"|\"média\"|\"baixa\"\n  },\n  \"impactAnalysis\": {\n    \"seatChanges\": [{ \"party\": \"sigla\", \"before\": número, \"after\": número, \"change\": número }],\n    \"voteShareChanges\": [{ \"party\": \"sigla\", \"before\": número, \"after\": número, \"change\": número }],\n    \"winners\": [\"partido1\", \"partido2\"],\n    \"losers\": [\"partido3\"],\n    \"overallImpact\": \"significativo\"|\"moderado\"|\"mínimo\",\n    \"confidence\": número_0_a_1\n  },\n  \"narrative\": \"Análise detalhada da simulação em 3-4 parágrafos em português, explicando o que aconteceria se a mudança ocorresse\",\n  \"recommendations\": [\"recomendação1\", \"recomendação2\"]\n}`;\n\n      const completion = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n      });\n\n      const results = JSON.parse(completion.choices[0]?.message?.content || \"{}\");\n\n      await db.update(scenarioSimulations).set({\n        status: \"completed\",\n        baselineResults: results.baselineResults,\n        simulatedResults: results.simulatedResults,\n        impactAnalysis: results.impactAnalysis,\n        narrative: results.narrative,\n        completedAt: new Date(),\n      }).where(eq(scenarioSimulations.id, id));\n\n      const [updated] = await db.select().from(scenarioSimulations).where(eq(scenarioSimulations.id, id));\n      await logAudit(req, \"run\", \"scenario_simulation\", String(id));\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Failed to run scenario simulation:\", error);\n      res.status(500).json({ error: \"Failed to run scenario simulation\" });\n    }\n  });\n\n  // Delete scenario simulation\n  app.delete(\"/api/scenario-simulations/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await db.delete(scenarioSimulations).where(eq(scenarioSimulations.id, id));\n      await logAudit(req, \"delete\", \"scenario_simulation\", String(id));\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Failed to delete scenario simulation:\", error);\n      res.status(500).json({ error: \"Failed to delete scenario simulation\" });\n    }\n  });\n\n  app.get(\"/api/analytics/historical-years\", requireAuth, async (req, res) => {\n    try {\n      const position = req.query.position as string | undefined;\n      const state = req.query.state as string | undefined;\n      \n      const years = await storage.getHistoricalVotesByParty({\n        years: [2002, 2006, 2010, 2014, 2018, 2022],\n        position,\n        state,\n      });\n      \n      const uniqueYears = Array.from(new Set(years.map(y => y.year))).sort((a, b) => b - a);\n      res.json(uniqueYears);\n    } catch (error) {\n      console.error(\"Failed to fetch historical years:\", error);\n      res.status(500).json({ error: \"Failed to fetch historical years\" });\n    }\n  });\n\n  app.post(\"/api/imports/tse\", requireAuth, requireRole(\"admin\"), upload.single(\"file\"), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      const electionYear = req.body.electionYear ? parseInt(req.body.electionYear) : null;\n      const uf = req.body.uf || null;\n      const electionType = req.body.electionType || null;\n      const parsedCargo = req.body.cargoFilter ? parseInt(req.body.cargoFilter) : NaN;\n      const cargoFilter = !isNaN(parsedCargo) ? parsedCargo : null;\n      \n      const existingImport = await storage.findExistingImport(\n        req.file.originalname,\n        electionYear,\n        uf,\n        electionType\n      );\n\n      if (existingImport) {\n        if (existingImport.isInProgress) {\n          return res.status(409).json({ \n            error: \"Importação em andamento\",\n            message: `Este arquivo já está sendo processado. Aguarde a conclusão da importação atual.`,\n            existingJob: existingImport.job,\n            isInProgress: true\n          });\n        } else {\n          const importDate = existingImport.job.completedAt \n            ? new Date(existingImport.job.completedAt).toLocaleDateString(\"pt-BR\") \n            : \"data desconhecida\";\n          return res.status(409).json({ \n            error: \"Dados já importados\",\n            message: `Este arquivo já foi importado com sucesso em ${importDate}. Foram processados ${existingImport.job.processedRows?.toLocaleString(\"pt-BR\") || 0} registros.`,\n            existingJob: existingImport.job,\n            isInProgress: false\n          });\n        }\n      }\n\n      const job = await storage.createTseImportJob({\n        filename: req.file.originalname,\n        fileSize: req.file.size,\n        status: \"pending\",\n        electionYear,\n        electionType,\n        uf,\n        cargoFilter,\n        createdBy: req.user?.id || null,\n      });\n\n      await logAudit(req, \"create\", \"tse_import\", String(job.id), { filename: req.file.originalname });\n\n      processCSVImport(job.id, req.file.path);\n\n      res.json({ jobId: job.id, message: \"Import started\" });\n    } catch (error) {\n      console.error(\"TSE import error:\", error);\n      res.status(500).json({ error: \"Failed to start import\" });\n    }\n  });\n\n  app.post(\"/api/imports/tse/url\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const { url, electionYear, electionType, uf, cargoFilter } = req.body;\n      \n      if (!url || typeof url !== \"string\") {\n        return res.status(400).json({ error: \"URL is required\" });\n      }\n\n      if (!url.startsWith(\"https://cdn.tse.jus.br/\") && !url.startsWith(\"https://dadosabertos.tse.jus.br/\")) {\n        return res.status(400).json({ error: \"URL must be from TSE domain (cdn.tse.jus.br or dadosabertos.tse.jus.br)\" });\n      }\n\n      if (!url.toLowerCase().endsWith(\".zip\")) {\n        return res.status(400).json({ error: \"URL must point to a .zip file\" });\n      }\n\n      const filename = path.basename(url);\n      const fullFilename = `[URL] ${filename}`;\n      const parsedYear = electionYear ? parseInt(electionYear) : null;\n\n      const existingImport = await storage.findExistingImport(\n        fullFilename,\n        parsedYear,\n        uf || null,\n        electionType || null\n      );\n\n      if (existingImport) {\n        if (existingImport.isInProgress) {\n          return res.status(409).json({ \n            error: \"Importação em andamento\",\n            message: `Esta URL já está sendo processada. Aguarde a conclusão da importação atual.`,\n            existingJob: existingImport.job,\n            isInProgress: true\n          });\n        } else {\n          const importDate = existingImport.job.completedAt \n            ? new Date(existingImport.job.completedAt).toLocaleDateString(\"pt-BR\") \n            : \"data desconhecida\";\n          return res.status(409).json({ \n            error: \"Dados já importados\",\n            message: `Estes dados do TSE já foram importados com sucesso em ${importDate}. Foram processados ${existingImport.job.processedRows?.toLocaleString(\"pt-BR\") || 0} registros.`,\n            existingJob: existingImport.job,\n            isInProgress: false\n          });\n        }\n      }\n\n      const job = await storage.createTseImportJob({\n        filename: fullFilename,\n        fileSize: 0,\n        status: \"pending\",\n        electionYear: parsedYear,\n        electionType: electionType || null,\n        uf: uf || null,\n        cargoFilter: cargoFilter && !isNaN(parseInt(cargoFilter)) ? parseInt(cargoFilter) : null,\n        sourceUrl: url,\n        createdBy: req.user?.id || null,\n      });\n\n      await logAudit(req, \"create\", \"tse_import_url\", String(job.id), { url, filename });\n\n      processURLImport(job.id, url);\n\n      res.json({ jobId: job.id, message: \"URL import started\" });\n    } catch (error) {\n      console.error(\"TSE URL import error:\", error);\n      res.status(500).json({ error: \"Failed to start URL import\" });\n    }\n  });\n\n  // Preview available files in a TSE ZIP\n  app.post(\"/api/imports/tse/preview-files\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const { url } = req.body;\n      \n      if (!url || typeof url !== \"string\") {\n        return res.status(400).json({ error: \"URL is required\" });\n      }\n\n      if (!url.startsWith(\"https://cdn.tse.jus.br/\") && !url.startsWith(\"https://dadosabertos.tse.jus.br/\")) {\n        return res.status(400).json({ error: \"URL must be from TSE domain\" });\n      }\n\n      const tmpDir = `/tmp/tse-preview-${Date.now()}`;\n      await mkdir(tmpDir, { recursive: true });\n\n      const response = await fetch(url);\n      if (!response.ok) {\n        throw new Error(`Failed to download: ${response.status} ${response.statusText}`);\n      }\n\n      const zipPath = path.join(tmpDir, \"data.zip\");\n      const fileStream = createWriteStream(zipPath);\n      \n      if (!response.body) throw new Error(\"No response body\");\n\n      const reader = response.body.getReader();\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n        fileStream.write(value);\n      }\n      fileStream.end();\n      await new Promise<void>((resolve, reject) => {\n        fileStream.on(\"finish\", resolve);\n        fileStream.on(\"error\", reject);\n      });\n\n      const directory = await unzipper.Open.file(zipPath);\n      const csvFiles = directory.files.filter(f => \n        (f.path.endsWith(\".csv\") || f.path.endsWith(\".txt\")) && !f.path.startsWith(\"__MACOSX\")\n      );\n\n      // Check for _BRASIL file\n      const brasilFile = csvFiles.find(f => \n        f.path.toUpperCase().includes(\"_BRASIL.CSV\") || f.path.toUpperCase().includes(\"_BRASIL.TXT\")\n      );\n\n      // Clean up\n      await unlink(zipPath).catch(() => {});\n      await rm(tmpDir, { recursive: true }).catch(() => {});\n\n      const files = csvFiles.map(f => ({\n        path: f.path,\n        name: path.basename(f.path),\n        size: f.uncompressedSize || 0,\n        isBrasil: f.path.toUpperCase().includes(\"_BRASIL\")\n      }));\n\n      res.json({\n        hasBrasilFile: !!brasilFile,\n        brasilFile: brasilFile ? path.basename(brasilFile.path) : null,\n        files: files.sort((a, b) => (b.isBrasil ? 1 : 0) - (a.isBrasil ? 1 : 0) || a.name.localeCompare(b.name))\n      });\n    } catch (error: any) {\n      console.error(\"TSE preview files error:\", error);\n      res.status(500).json({ error: error.message || \"Failed to preview files\" });\n    }\n  });\n\n  // Import Electoral Statistics (DETALHE_VOTACAO_MUNZONA) from TSE URL\n  app.post(\"/api/imports/tse/detalhe-votacao/url\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const { url, electionYear, electionType, uf, cargoFilter, selectedFile } = req.body;\n      \n      if (!url || typeof url !== \"string\") {\n        return res.status(400).json({ error: \"URL is required\" });\n      }\n\n      if (!url.startsWith(\"https://cdn.tse.jus.br/\") && !url.startsWith(\"https://dadosabertos.tse.jus.br/\")) {\n        return res.status(400).json({ error: \"URL must be from TSE domain\" });\n      }\n\n      const filename = path.basename(url);\n      const fullFilename = `[DETALHE] ${filename}`;\n      const parsedYear = electionYear ? parseInt(electionYear) : null;\n\n      const job = await storage.createTseImportJob({\n        filename: fullFilename,\n        fileSize: 0,\n        status: \"pending\",\n        stage: \"pending\",\n        downloadedBytes: 0,\n        totalRows: 0,\n        processedRows: 0,\n        skippedRows: 0,\n        errorCount: 0,\n        electionYear: parsedYear,\n        electionType: electionType || null,\n        uf: uf || null,\n        cargoFilter: cargoFilter || null,\n        sourceUrl: url,\n        createdBy: req.user!.id,\n      });\n\n      await logAudit(req, \"create\", \"tse_import_detalhe\", String(job.id), { url, filename, selectedFile });\n\n      processDetalheVotacaoImport(job.id, url, selectedFile);\n\n      res.json({ jobId: job.id, message: \"Electoral statistics import started\" });\n    } catch (error) {\n      console.error(\"TSE detalhe_votacao import error:\", error);\n      res.status(500).json({ error: \"Failed to start electoral statistics import\" });\n    }\n  });\n\n  // Import Party Votes (VOTACAO_PARTIDO_MUNZONA) from TSE URL\n  app.post(\"/api/imports/tse/partido/url\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const { url, electionYear, electionType, uf, cargoFilter, selectedFile } = req.body;\n      \n      if (!url || typeof url !== \"string\") {\n        return res.status(400).json({ error: \"URL is required\" });\n      }\n\n      if (!url.startsWith(\"https://cdn.tse.jus.br/\") && !url.startsWith(\"https://dadosabertos.tse.jus.br/\")) {\n        return res.status(400).json({ error: \"URL must be from TSE domain\" });\n      }\n\n      const filename = path.basename(url);\n      const fullFilename = `[PARTIDO] ${filename}`;\n      const parsedYear = electionYear ? parseInt(electionYear) : null;\n\n      const job = await storage.createTseImportJob({\n        filename: fullFilename,\n        fileSize: 0,\n        status: \"pending\",\n        stage: \"pending\",\n        downloadedBytes: 0,\n        totalRows: 0,\n        processedRows: 0,\n        skippedRows: 0,\n        errorCount: 0,\n        electionYear: parsedYear,\n        electionType: electionType || null,\n        uf: uf || null,\n        cargoFilter: cargoFilter || null,\n        sourceUrl: url,\n        createdBy: req.user!.id,\n      });\n\n      await logAudit(req, \"create\", \"tse_import_partido\", String(job.id), { url, filename, selectedFile });\n\n      processPartidoVotacaoImport(job.id, url, selectedFile);\n\n      res.json({ jobId: job.id, message: \"Party votes import started\" });\n    } catch (error) {\n      console.error(\"TSE partido import error:\", error);\n      res.status(500).json({ error: \"Failed to start party votes import\" });\n    }\n  });\n\n  // Get historical electoral data summary for scenario creation\n  app.get(\"/api/historical-elections\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf, cargo, turno } = req.query;\n      \n      const filters: any = {};\n      if (year) filters.anoEleicao = parseInt(year as string);\n      if (uf) filters.sgUf = uf as string;\n      if (cargo) filters.cdCargo = parseInt(cargo as string);\n      // Default to turno 1 to avoid double-counting voters across rounds\n      if (turno) filters.nrTurno = parseInt(turno as string);\n\n      const statistics = await storage.getElectoralStatisticsSummary(filters);\n      res.json(statistics);\n    } catch (error) {\n      console.error(\"Failed to fetch historical elections:\", error);\n      res.status(500).json({ error: \"Failed to fetch historical elections\" });\n    }\n  });\n\n  // Get available elections for dropdown\n  app.get(\"/api/historical-elections/available\", requireAuth, async (req, res) => {\n    try {\n      const elections = await storage.getAvailableHistoricalElections();\n      res.json(elections);\n    } catch (error) {\n      console.error(\"Failed to fetch available elections:\", error);\n      res.status(500).json({ error: \"Failed to fetch available elections\" });\n    }\n  });\n\n  // Get party votes for a specific election\n  app.get(\"/api/historical-elections/party-votes\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf, cargo, municipio } = req.query;\n      \n      if (!year || !cargo) {\n        return res.status(400).json({ error: \"Year and cargo are required\" });\n      }\n\n      const filters = {\n        anoEleicao: parseInt(year as string),\n        sgUf: uf as string || undefined,\n        cdCargo: parseInt(cargo as string),\n        cdMunicipio: municipio ? parseInt(municipio as string) : undefined,\n      };\n\n      const partyVotes = await storage.getHistoricalPartyVotes(filters);\n      res.json(partyVotes);\n    } catch (error) {\n      console.error(\"Failed to fetch party votes:\", error);\n      res.status(500).json({ error: \"Failed to fetch party votes\" });\n    }\n  });\n\n  const processURLImport = (jobId: number, url: string) => {\n    addToTseQueue({ \n      jobId, \n      type: \"url\", \n      url,\n      processor: () => processURLImportInternal(jobId, url)\n    });\n  };\n\n  const processURLImportInternal = async (jobId: number, url: string) => {\n    const tmpDir = `/tmp/tse-import-${jobId}`;\n    let csvPath: string | null = null;\n\n    // Track this job as active\n    activeImportJobs.set(jobId, { cancelled: false });\n\n    try {\n      // Check if cancelled before starting\n      if (isJobCancelled(jobId)) {\n        throw new Error(\"Importação cancelada\");\n      }\n\n      await storage.updateTseImportJob(jobId, { \n        status: \"downloading\", \n        stage: \"downloading\",\n        startedAt: new Date(),\n        updatedAt: new Date()\n      });\n      await mkdir(tmpDir, { recursive: true });\n\n      const response = await fetch(url);\n      if (!response.ok) {\n        throw new Error(`Failed to download: ${response.status} ${response.statusText}`);\n      }\n\n      const contentLength = response.headers.get(\"content-length\");\n      const totalBytes = contentLength ? parseInt(contentLength) : 0;\n      if (totalBytes > 0) {\n        await storage.updateTseImportJob(jobId, { fileSize: totalBytes });\n      }\n\n      const zipPath = path.join(tmpDir, \"data.zip\");\n      const fileStream = createWriteStream(zipPath);\n      \n      if (!response.body) {\n        throw new Error(\"No response body\");\n      }\n\n      const reader = response.body.getReader();\n      let downloadedBytes = 0;\n      let lastProgressUpdate = Date.now();\n      const PROGRESS_UPDATE_INTERVAL = 2000;\n      \n      while (true) {\n        // Check for cancellation during download\n        if (isJobCancelled(jobId)) {\n          reader.cancel();\n          fileStream.end();\n          throw new Error(\"Importação cancelada\");\n        }\n\n        const { done, value } = await reader.read();\n        if (done) break;\n        fileStream.write(value);\n        downloadedBytes += value.length;\n        \n        const now = Date.now();\n        if (now - lastProgressUpdate >= PROGRESS_UPDATE_INTERVAL) {\n          await storage.updateTseImportJob(jobId, { \n            downloadedBytes,\n            updatedAt: new Date()\n          });\n          lastProgressUpdate = now;\n        }\n      }\n      \n      await storage.updateTseImportJob(jobId, { \n        downloadedBytes,\n        updatedAt: new Date()\n      });\n      \n      fileStream.end();\n      await new Promise<void>((resolve, reject) => {\n        fileStream.on(\"finish\", resolve);\n        fileStream.on(\"error\", reject);\n      });\n\n      await storage.updateTseImportJob(jobId, { \n        status: \"extracting\",\n        stage: \"extracting\",\n        updatedAt: new Date()\n      });\n\n      const directory = await unzipper.Open.file(zipPath);\n      \n      const csvFiles = directory.files.filter(f => \n        (f.path.endsWith(\".csv\") || f.path.endsWith(\".txt\")) && !f.path.startsWith(\"__MACOSX\")\n      );\n      \n      if (csvFiles.length === 0) {\n        throw new Error(\"No CSV/TXT file found in ZIP\");\n      }\n      \n      const brasilFile = csvFiles.find(f => f.path.toUpperCase().includes(\"_BRASIL.CSV\") || f.path.toUpperCase().includes(\"_BRASIL.TXT\"));\n      const csvFile = brasilFile || csvFiles[0];\n      \n      console.log(`Found ${csvFiles.length} CSV files, using: ${csvFile.path}${brasilFile ? \" (prioritized _BRASIL file)\" : \"\"}`);\n      \n      if (!csvFile) {\n        throw new Error(\"No CSV/TXT file found in ZIP\");\n      }\n\n      csvPath = path.join(tmpDir, \"data.csv\");\n      await pipeline(csvFile.stream(), createWriteStream(csvPath));\n\n      // Check for cancellation before processing\n      if (isJobCancelled(jobId)) {\n        throw new Error(\"Importação cancelada\");\n      }\n\n      await storage.updateTseImportJob(jobId, { \n        status: \"processing\",\n        stage: \"processing\",\n        updatedAt: new Date()\n      });\n      await processCSVImportInternal(jobId, csvPath);\n\n      await unlink(zipPath).catch(() => {});\n      await unlink(csvPath).catch(() => {});\n\n      // Cleanup active job tracking on success\n      activeImportJobs.delete(jobId);\n    } catch (error: any) {\n      console.error(\"URL import error:\", error);\n      \n      // Only update to failed if not already cancelled\n      if (!isJobCancelled(jobId)) {\n        await storage.updateTseImportJob(jobId, {\n          status: \"failed\",\n          stage: \"failed\",\n          completedAt: new Date(),\n          updatedAt: new Date(),\n          errorMessage: error.message || \"Unknown error\",\n        });\n      }\n\n      // Cleanup active job tracking\n      activeImportJobs.delete(jobId);\n    }\n  };\n\n  const processCSVImportInternal = async (jobId: number, filePath: string) => {\n    const job = await storage.getTseImportJob(jobId);\n    const cargoFilter = job?.cargoFilter;\n    \n    let rowCount = 0;\n    let filteredCount = 0;\n    let insertedCount = 0;\n    let errorCount = 0;\n    const BATCH_SIZE = 5000; // Increased for better bulk insert performance\n\n    // Read first row to detect CSV structure (column count varies by year)\n    const firstRowPromise = new Promise<string[]>((resolve, reject) => {\n      const parser = createReadStream(filePath)\n        .pipe(iconv.decodeStream(\"latin1\"))\n        .pipe(parse({ delimiter: \";\", relax_quotes: true, skip_empty_lines: true, from_line: 2, to_line: 2 }));\n      parser.on(\"data\", (row: string[]) => resolve(row));\n      parser.on(\"error\", reject);\n      parser.on(\"end\", () => resolve([]));\n    });\n    const firstRow = await firstRowPromise;\n    const columnCount = firstRow.length;\n    console.log(`[CANDIDATO] Detected ${columnCount} columns in CSV file`);\n\n    // Field mappings vary by TSE file format version\n    // - Legacy (≤38 cols): 2002-2014 - simpler structure without julgamento/cassacao fields (38 cols)\n    // - Modern (>38 cols): 2018-2022+ - has julgamento/cassacao and federation fields (50 cols)\n    let fieldMap: { [key: number]: keyof InsertTseCandidateVote };\n\n    if (columnCount <= 38) {\n      // Legacy format (2014): 38 columns - NO julgamento/cassacao fields, NO federation\n      // Structure: DT_GERACAO, HH_GERACAO, ANO_ELEICAO, ..., SQ_CANDIDATO(18), NR_CANDIDATO(19), \n      // ... NM_SOCIAL_CANDIDATO(22), CD_SITUACAO_CANDIDATURA(23), DS_SITUACAO_CANDIDATURA(24),\n      // CD_DETALHE_SITUACAO_CAND(25), DS_DETALHE_SITUACAO_CAND(26), TP_AGREMIACAO(27),\n      // NR_PARTIDO(28), SG_PARTIDO(29), NM_PARTIDO(30), SQ_COLIGACAO(31), NM_COLIGACAO(32),\n      // DS_COMPOSICAO_COLIGACAO(33), CD_SIT_TOT_TURNO(34), DS_SIT_TOT_TURNO(35),\n      // ST_VOTO_EM_TRANSITO(36), QT_VOTOS_NOMINAIS(37)\n      fieldMap = {\n        0: \"dtGeracao\",\n        1: \"hhGeracao\",\n        2: \"anoEleicao\",\n        3: \"cdTipoEleicao\",\n        4: \"nmTipoEleicao\",\n        5: \"nrTurno\",\n        6: \"cdEleicao\",\n        7: \"dsEleicao\",\n        8: \"dtEleicao\",\n        9: \"tpAbrangencia\",\n        10: \"sgUf\",\n        11: \"sgUe\",\n        12: \"nmUe\",\n        13: \"cdMunicipio\",\n        14: \"nmMunicipio\",\n        15: \"nrZona\",\n        16: \"cdCargo\",\n        17: \"dsCargo\",\n        18: \"sqCandidato\",\n        19: \"nrCandidato\",\n        20: \"nmCandidato\",\n        21: \"nmUrnaCandidato\",\n        22: \"nmSocialCandidato\",\n        23: \"cdSituacaoCandidatura\",\n        24: \"dsSituacaoCandidatura\",\n        25: \"cdDetalheSituacaoCand\",\n        26: \"dsDetalheSituacaoCand\",\n        // NO julgamento/cassacao fields in 2014 (positions 27-32 in newer formats)\n        27: \"tpAgremiacao\",\n        28: \"nrPartido\",\n        29: \"sgPartido\",\n        30: \"nmPartido\",\n        31: \"sqColigacao\",\n        32: \"nmColigacao\",\n        33: \"dsComposicaoColigacao\",\n        34: \"cdSitTotTurno\",\n        35: \"dsSitTotTurno\",\n        36: \"stVotoEmTransito\",\n        37: \"qtVotosNominais\",\n      };\n      console.log(`[CANDIDATO] Using legacy format (2002-2014) field mapping - ${columnCount} columns`);\n    } else {\n      // Modern format (2018-2022+): 50 columns with julgamento/cassacao, federation and detailed coligacao\n      fieldMap = {\n        0: \"dtGeracao\",\n        1: \"hhGeracao\",\n        2: \"anoEleicao\",\n        3: \"cdTipoEleicao\",\n        4: \"nmTipoEleicao\",\n        5: \"nrTurno\",\n        6: \"cdEleicao\",\n        7: \"dsEleicao\",\n        8: \"dtEleicao\",\n        9: \"tpAbrangencia\",\n        10: \"sgUf\",\n        11: \"sgUe\",\n        12: \"nmUe\",\n        13: \"cdMunicipio\",\n        14: \"nmMunicipio\",\n        15: \"nrZona\",\n        16: \"cdCargo\",\n        17: \"dsCargo\",\n        18: \"sqCandidato\",\n        19: \"nrCandidato\",\n        20: \"nmCandidato\",\n        21: \"nmUrnaCandidato\",\n        22: \"nmSocialCandidato\",\n        23: \"cdSituacaoCandidatura\",\n        24: \"dsSituacaoCandidatura\",\n        25: \"cdDetalheSituacaoCand\",\n        26: \"dsDetalheSituacaoCand\",\n        27: \"cdSituacaoJulgamento\",\n        28: \"dsSituacaoJulgamento\",\n        29: \"cdSituacaoCassacao\",\n        30: \"dsSituacaoCassacao\",\n        31: \"cdSituacaoDconstDiploma\",\n        32: \"dsSituacaoDconstDiploma\",\n        33: \"tpAgremiacao\",\n        34: \"nrPartido\",\n        35: \"sgPartido\",\n        36: \"nmPartido\",\n        37: \"nrFederacao\",\n        38: \"nmFederacao\",\n        39: \"sgFederacao\",\n        40: \"dsComposicaoFederacao\",\n        41: \"sqColigacao\",\n        42: \"nmColigacao\",\n        43: \"dsComposicaoColigacao\",\n        44: \"stVotoEmTransito\",\n        45: \"qtVotosNominais\",\n        46: \"nmTipoDestinacaoVotos\",\n        47: \"qtVotosNominaisValidos\",\n        48: \"cdSitTotTurno\",\n        49: \"dsSitTotTurno\",\n      };\n      console.log(`[CANDIDATO] Using modern format (2022+) field mapping - ${columnCount} columns`);\n    }\n\n    const parseValue = (value: string, field: string): any => {\n      if (value === \"#NULO\" || value === \"#NE\" || value === \"\") {\n        return null;\n      }\n      // sq* fields (sqCandidato, sqColigacao) are text because they can exceed integer limits\n      if (field.startsWith(\"sq\")) {\n        return value;\n      }\n      if (field.startsWith(\"qt\") || field.startsWith(\"nr\") || field.startsWith(\"cd\")) {\n        const num = parseInt(value, 10);\n        return isNaN(num) ? null : num;\n      }\n      return value;\n    };\n\n    // Delete any previous batch records for this job\n    await storage.deleteBatchesByJob(jobId);\n\n    // Streaming batch processing with tracking\n    const parser = createReadStream(filePath)\n      .pipe(iconv.decodeStream(\"latin1\"))\n      .pipe(parse({\n        delimiter: \";\",\n        quote: '\"',\n        relax_quotes: true,\n        relax_column_count: true,\n        skip_empty_lines: true,\n        from_line: 2,\n      }));\n\n    let records: InsertTseCandidateVote[] = [];\n    let batchIndex = 0;\n    let batchFirstOriginalRow = 1;\n    let batchLastOriginalRow = 1;\n    let currentBatchRecord: TseImportBatch | null = null;\n    let batchInserted = 0;\n    let batchSkipped = 0;\n    let batchErrors = 0;\n    let duplicateCount = 0;\n\n    const finalizeBatch = async () => {\n      if (records.length === 0 && !currentBatchRecord) return;\n      \n      if (records.length > 0) {\n        try {\n          const actualInserted = await storage.bulkInsertTseCandidateVotes(records);\n          batchInserted = actualInserted;\n          batchSkipped = records.length - actualInserted;\n          insertedCount += batchInserted;\n          duplicateCount += batchSkipped;\n        } catch (err: any) {\n          console.error(`[CANDIDATO] Batch ${batchIndex + 1} insert error:`, err);\n          batchErrors = records.length;\n          errorCount += batchErrors;\n        }\n      }\n\n      if (currentBatchRecord) {\n        await storage.updateImportBatch(currentBatchRecord.id, {\n          status: batchErrors > 0 ? \"failed\" : \"completed\",\n          rowEnd: batchLastOriginalRow, // Update with actual last row index\n          totalRows: records.length,\n          processedRows: records.length,\n          insertedRows: batchInserted,\n          skippedRows: batchSkipped,\n          errorCount: batchErrors,\n          errorSummary: batchErrors > 0 ? \"Batch insert errors\" : undefined,\n          completedAt: new Date(),\n        });\n      }\n\n      // Update job progress\n      const totalSkipped = filteredCount + duplicateCount;\n      await storage.updateTseImportJob(jobId, { \n        processedRows: insertedCount,\n        skippedRows: totalSkipped,\n        errorCount,\n        updatedAt: new Date()\n      });\n\n      // Log progress\n      if ((batchIndex + 1) % 10 === 0) {\n        console.log(`[CANDIDATO] Batch ${batchIndex + 1}: ${insertedCount} inserted, ${duplicateCount} duplicates, ${filteredCount} filtered, ${errorCount} errors`);\n      }\n\n      records = [];\n      batchInserted = 0;\n      batchSkipped = 0;\n      batchErrors = 0;\n      batchIndex++;\n      batchFirstOriginalRow = 0;\n      batchLastOriginalRow = 0;\n      currentBatchRecord = null;\n      \n      // Yield to event loop to prevent CPU blocking\n      await new Promise(resolve => setImmediate(resolve));\n    };\n\n    for await (const row of parser) {\n      try {\n        rowCount++;\n        \n        // Check cargo filter first (before creating batch record)\n        const cdCargo = parseInt(row[16], 10) || null;\n        if (cargoFilter && cdCargo !== cargoFilter) {\n          filteredCount++;\n          continue;\n        }\n\n        // Track original row number for first row in batch\n        if (batchFirstOriginalRow === 0) {\n          batchFirstOriginalRow = rowCount;\n        }\n        batchLastOriginalRow = rowCount;\n\n        // Create batch record if needed\n        if (!currentBatchRecord) {\n          currentBatchRecord = await storage.createImportBatch({\n            importJobId: jobId,\n            batchIndex,\n            status: \"processing\",\n            rowStart: batchFirstOriginalRow,\n            rowEnd: batchFirstOriginalRow + BATCH_SIZE - 1,\n            totalRows: BATCH_SIZE,\n            processedRows: 0,\n            insertedRows: 0,\n            skippedRows: 0,\n            errorCount: 0,\n            startedAt: new Date(),\n          });\n        }\n\n        const record: Partial<InsertTseCandidateVote> = {};\n\n        for (const [index, field] of Object.entries(fieldMap)) {\n          const value = row[parseInt(index)];\n          if (value !== undefined) {\n            (record as any)[field] = parseValue(value, field);\n          }\n        }\n\n        if (record.anoEleicao && record.nrCandidato) {\n          record.importJobId = jobId;\n          records.push(record as InsertTseCandidateVote);\n        }\n\n        // Finalize batch when full\n        if (records.length >= BATCH_SIZE) {\n          await finalizeBatch();\n        }\n      } catch (err: any) {\n        batchErrors++;\n        errorCount++;\n        await storage.createTseImportError({\n          importJobId: jobId,\n          errorType: \"parse_error\",\n          rowNumber: rowCount,\n          errorMessage: err.message || \"Parse error\",\n          rawData: JSON.stringify(row).substring(0, 1000),\n        });\n      }\n    }\n\n    // Finalize last batch\n    if (records.length > 0 || currentBatchRecord) {\n      await finalizeBatch();\n    }\n\n    console.log(`[CANDIDATO] Completed: ${rowCount} total rows, ${insertedCount} inserted, ${filteredCount} filtered, ${errorCount} errors`);\n    \n    // Set totalFileRows now that we know the count\n    await storage.updateTseImportJob(jobId, { \n      totalFileRows: rowCount,\n      stage: \"processing\",\n      updatedAt: new Date()\n    });\n\n    // Sync parties from imported data before marking as complete\n    const partiesResult = await storage.syncPartiesFromTseImport(jobId);\n    console.log(`TSE Import ${jobId}: Synced parties - ${partiesResult.created} created, ${partiesResult.updated} updated, ${partiesResult.existing} existing`);\n    \n    // Validate import integrity\n    const dbRowCount = await storage.countTseCandidateVotesByJob(jobId);\n    const isValid = dbRowCount === insertedCount;\n    const validationMessage = isValid \n      ? `Validação OK: ${dbRowCount.toLocaleString(\"pt-BR\")} registros importados corretamente`\n      : `Discrepância detectada: esperado ${insertedCount.toLocaleString(\"pt-BR\")}, encontrado ${dbRowCount.toLocaleString(\"pt-BR\")} no banco`;\n\n    console.log(`TSE Import ${jobId}: Validation - ${validationMessage}`);\n\n    const totalSkipped = filteredCount + duplicateCount;\n    await storage.updateTseImportJob(jobId, {\n      status: \"completed\",\n      stage: \"completed\",\n      completedAt: new Date(),\n      updatedAt: new Date(),\n      totalFileRows: rowCount,\n      processedRows: insertedCount,\n      skippedRows: totalSkipped,\n      errorCount: errorCount,\n      validationStatus: isValid ? \"passed\" : \"failed\",\n      validationMessage: validationMessage,\n      validatedAt: new Date(),\n    });\n\n    // Trigger embedding generation for semantic search (if API key configured)\n    if (process.env.OPENAI_API_KEY) {\n      console.log(`TSE Import ${jobId}: Starting background embedding generation...`);\n      generateEmbeddingsForImportJob(jobId)\n        .then(result => {\n          console.log(`TSE Import ${jobId}: Embeddings generated - ${result.processed} processed, ${result.skipped} skipped, ${result.errors} errors`);\n        })\n        .catch(error => {\n          console.error(`TSE Import ${jobId}: Embedding generation failed:`, error);\n        });\n    }\n  };\n\n  // Process Detalhe Votacao (Electoral Statistics) Import\n  const processDetalheVotacaoImport = (jobId: number, url: string, selectedFile?: string) => {\n    addToTseQueue({ \n      jobId, \n      type: \"detalhe\", \n      url, \n      selectedFile,\n      processor: () => processDetalheVotacaoImportInternal(jobId, url, selectedFile)\n    });\n  };\n\n  const processDetalheVotacaoImportInternal = async (jobId: number, url: string, selectedFile?: string) => {\n    const tmpDir = `/tmp/tse-import-${jobId}`;\n    activeImportJobs.set(jobId, { cancelled: false });\n\n    try {\n      await storage.updateTseImportJob(jobId, { \n        status: \"downloading\", \n        stage: \"downloading\",\n        startedAt: new Date(),\n        updatedAt: new Date()\n      });\n      await mkdir(tmpDir, { recursive: true });\n\n      const response = await fetch(url);\n      if (!response.ok) {\n        throw new Error(`Failed to download: ${response.status} ${response.statusText}`);\n      }\n\n      const contentLength = response.headers.get(\"content-length\");\n      const totalBytes = contentLength ? parseInt(contentLength) : 0;\n      if (totalBytes > 0) {\n        await storage.updateTseImportJob(jobId, { fileSize: totalBytes });\n      }\n\n      const zipPath = path.join(tmpDir, \"data.zip\");\n      const fileStream = createWriteStream(zipPath);\n      \n      if (!response.body) throw new Error(\"No response body\");\n\n      const reader = response.body.getReader();\n      let downloadedBytes = 0;\n      \n      while (true) {\n        if (isJobCancelled(jobId)) {\n          reader.cancel();\n          fileStream.end();\n          throw new Error(\"Importação cancelada\");\n        }\n        const { done, value } = await reader.read();\n        if (done) break;\n        fileStream.write(value);\n        downloadedBytes += value.length;\n      }\n      \n      await storage.updateTseImportJob(jobId, { downloadedBytes, updatedAt: new Date() });\n      fileStream.end();\n      await new Promise<void>((resolve, reject) => {\n        fileStream.on(\"finish\", resolve);\n        fileStream.on(\"error\", reject);\n      });\n\n      await storage.updateTseImportJob(jobId, { status: \"extracting\", stage: \"extracting\", updatedAt: new Date() });\n\n      const directory = await unzipper.Open.file(zipPath);\n      const csvFiles = directory.files.filter(f => \n        (f.path.endsWith(\".csv\") || f.path.endsWith(\".txt\")) && !f.path.startsWith(\"__MACOSX\")\n      );\n      \n      if (csvFiles.length === 0) throw new Error(\"No CSV/TXT file found in ZIP\");\n      \n      // Use selectedFile if provided, otherwise prioritize _BRASIL file\n      let csvFile;\n      if (selectedFile) {\n        csvFile = csvFiles.find(f => f.path === selectedFile || path.basename(f.path) === selectedFile);\n        if (!csvFile) throw new Error(`Selected file not found: ${selectedFile}`);\n        console.log(`[DETALHE] Using user-selected file: ${csvFile.path}`);\n      } else {\n        const brasilFile = csvFiles.find(f => f.path.toUpperCase().includes(\"_BRASIL.CSV\") || f.path.toUpperCase().includes(\"_BRASIL.TXT\"));\n        csvFile = brasilFile || csvFiles[0];\n        console.log(`[DETALHE] Found ${csvFiles.length} CSV files, using: ${csvFile.path}${brasilFile ? \" (arquivo BRASIL consolidado)\" : \"\"}`);\n      }\n      \n      const csvPath = path.join(tmpDir, \"data.csv\");\n      await pipeline(csvFile.stream(), createWriteStream(csvPath));\n\n      await storage.updateTseImportJob(jobId, { status: \"processing\", stage: \"processing\", updatedAt: new Date() });\n\n      // Process Detalhe Votacao CSV\n      const job = await storage.getTseImportJob(jobId);\n      const cargoFilter = job?.cargoFilter;\n      \n      const records: any[] = [];\n      let rowCount = 0;\n      let cargoFilteredCount = 0;  // Rows filtered by cargo\n      let duplicateCount = 0;       // Rows that already exist in DB\n      let insertedCount = 0;        // Actually inserted rows\n      let errorCount = 0;\n      const BATCH_SIZE = 5000; // Increased for better bulk insert performance\n\n      // Field mapping for DETALHE_VOTACAO_MUNZONA\n      const fieldMap: { [key: number]: string } = {\n        0: \"dtGeracao\", 1: \"hhGeracao\", 2: \"anoEleicao\", 3: \"cdTipoEleicao\", 4: \"nmTipoEleicao\",\n        5: \"nrTurno\", 6: \"cdEleicao\", 7: \"dsEleicao\", 8: \"dtEleicao\", 9: \"tpAbrangencia\",\n        10: \"sgUf\", 11: \"sgUe\", 12: \"nmUe\", 13: \"cdMunicipio\", 14: \"nmMunicipio\",\n        15: \"nrZona\", 16: \"cdCargo\", 17: \"dsCargo\", 18: \"qtAptos\", 19: \"qtSecoesPrincipais\",\n        20: \"qtSecoesAgregadas\", 21: \"qtSecoesNaoInstaladas\", 22: \"qtTotalSecoes\",\n        23: \"qtComparecimento\", 24: \"qtEleitoresSecoesNaoInstaladas\", 25: \"qtAbstencoes\",\n        26: \"stVotoEmTransito\", 27: \"qtVotos\", 28: \"qtVotosConcorrentes\",\n        29: \"qtTotalVotosValidos\", 30: \"qtVotosNominaisValidos\", 31: \"qtTotalVotosLegValidos\",\n        32: \"qtVotosLegValidos\", 33: \"qtVotosNomConvrLegValidos\", 34: \"qtTotalVotosAnulados\",\n        35: \"qtVotosNominaisAnulados\", 36: \"qtVotosLegendaAnulados\", 37: \"qtTotalVotosAnulSubjud\",\n        38: \"qtVotosNominaisAnulSubjud\", 39: \"qtVotosLegendaAnulSubjud\", 40: \"qtVotosBrancos\",\n        41: \"qtTotalVotosNulos\", 42: \"qtVotosNulos\", 43: \"qtVotosNulosTecnicos\",\n        44: \"qtVotosAnuladosApuSep\"\n      };\n\n      const parseValue = (value: string | undefined, isNumeric: boolean = false): any => {\n        if (!value || value === \"#NULO\" || value === \"#NE\") return isNumeric ? 0 : null;\n        if (isNumeric) {\n          const parsed = parseInt(value.replace(/\"/g, \"\"), 10);\n          return isNaN(parsed) || parsed === -1 || parsed === -3 ? 0 : parsed;\n        }\n        return value.replace(/\"/g, \"\").trim();\n      };\n\n      const numericFields = [2, 3, 5, 6, 13, 15, 16, 18, 19, 20, 21, 22, 23, 24, 25, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44];\n\n      // Collect all rows first (synchronously), then process in batches\n      const allRows: string[][] = [];\n      await new Promise<void>((resolve, reject) => {\n        const parser = createReadStream(csvPath, { encoding: \"latin1\" })\n          .pipe(parse({ delimiter: \";\", relax_quotes: true, skip_empty_lines: true, from_line: 2 }));\n\n        parser.on(\"data\", (row: string[]) => {\n          allRows.push(row);\n        });\n        parser.on(\"end\", () => resolve());\n        parser.on(\"error\", reject);\n      });\n\n      console.log(`[DETALHE] Parsed ${allRows.length} rows, processing in batches...`);\n      \n      // Set totalFileRows for progress calculation\n      await storage.updateTseImportJob(jobId, { \n        totalFileRows: allRows.length,\n        stage: \"processing\",\n        updatedAt: new Date()\n      });\n\n      // Delete any previous batch records for this job (in case of re-import)\n      await storage.deleteBatchesByJob(jobId);\n      \n      // Pre-filter rows by cargo and prepare batch chunks\n      const filteredRows: { index: number; row: string[] }[] = [];\n      for (let i = 0; i < allRows.length; i++) {\n        const row = allRows[i];\n        const cdCargo = parseValue(row[16], true);\n        if (cargoFilter && cdCargo !== cargoFilter) {\n          cargoFilteredCount++;\n          continue;\n        }\n        filteredRows.push({ index: i, row });\n      }\n      \n      console.log(`[DETALHE] After cargo filter: ${filteredRows.length} rows to process (${cargoFilteredCount} filtered)`);\n      \n      // Calculate total batches\n      const totalBatches = Math.ceil(filteredRows.length / BATCH_SIZE);\n      \n      // Process rows in batches with tracking\n      for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {\n        const startIdx = batchIndex * BATCH_SIZE;\n        const endIdx = Math.min(startIdx + BATCH_SIZE, filteredRows.length);\n        const batchRows = filteredRows.slice(startIdx, endIdx);\n        \n        // Use original file row indices for audit trail (add 2 for 1-based + header row)\n        const originalRowStart = batchRows[0].index + 2;\n        const originalRowEnd = batchRows[batchRows.length - 1].index + 2;\n        \n        // Create batch record\n        const batchRecord = await storage.createImportBatch({\n          importJobId: jobId,\n          batchIndex,\n          status: \"processing\",\n          rowStart: originalRowStart,\n          rowEnd: originalRowEnd,\n          totalRows: batchRows.length,\n          processedRows: 0,\n          insertedRows: 0,\n          skippedRows: 0,\n          errorCount: 0,\n          startedAt: new Date(),\n        });\n        \n        let batchInserted = 0;\n        let batchSkipped = 0;\n        let batchErrors = 0;\n        let batchErrorSummary = \"\";\n        \n        try {\n          // Parse batch rows into records\n          const batchRecords: any[] = [];\n          for (const { row } of batchRows) {\n            rowCount++;\n            const record: any = { importJobId: jobId };\n            for (const [index, field] of Object.entries(fieldMap)) {\n              const idx = parseInt(index);\n              if (idx < row.length) {\n                record[field] = parseValue(row[idx], numericFields.includes(idx));\n              }\n            }\n            batchRecords.push(record);\n          }\n          \n          // Insert batch\n          const inserted = await storage.insertTseElectoralStatisticsBatch(batchRecords);\n          batchInserted = inserted;\n          batchSkipped = batchRecords.length - inserted;\n          insertedCount += batchInserted;\n          duplicateCount += batchSkipped;\n          \n          // Update batch record as completed\n          await storage.updateImportBatch(batchRecord.id, {\n            status: \"completed\",\n            processedRows: batchRows.length,\n            insertedRows: batchInserted,\n            skippedRows: batchSkipped,\n            errorCount: 0,\n            completedAt: new Date(),\n          });\n        } catch (err: any) {\n          console.error(`[DETALHE] Batch ${batchIndex + 1} error:`, err);\n          batchErrors = batchRows.length;\n          batchErrorSummary = err.message || \"Unknown error\";\n          errorCount += batchErrors;\n          \n          // Update batch record as failed\n          await storage.updateImportBatch(batchRecord.id, {\n            status: \"failed\",\n            processedRows: 0,\n            errorCount: batchErrors,\n            errorSummary: batchErrorSummary,\n            completedAt: new Date(),\n          });\n        }\n        \n        // Update job progress\n        const totalSkipped = cargoFilteredCount + duplicateCount;\n        await storage.updateTseImportJob(jobId, { \n          processedRows: insertedCount,\n          skippedRows: totalSkipped,\n          errorCount,\n          updatedAt: new Date()\n        });\n        \n        // Log progress every 10 batches\n        if ((batchIndex + 1) % 10 === 0 || batchIndex === totalBatches - 1) {\n          console.log(`[DETALHE] Batch ${batchIndex + 1}/${totalBatches}: ${insertedCount} inserted, ${duplicateCount} duplicates`);\n        }\n        \n        // Yield to event loop to prevent CPU blocking\n        await new Promise(resolve => setImmediate(resolve));\n      }\n\n      const totalSkipped = cargoFilteredCount + duplicateCount;\n      const validationMessage = insertedCount === 0 && duplicateCount > 0\n        ? `Dados já importados: ${duplicateCount.toLocaleString(\"pt-BR\")} registros duplicados encontrados`\n        : insertedCount > 0\n          ? `Importação concluída: ${insertedCount.toLocaleString(\"pt-BR\")} inseridos, ${duplicateCount.toLocaleString(\"pt-BR\")} duplicados`\n          : null;\n\n      console.log(`[DETALHE] Completed: ${rowCount} total, ${insertedCount} inserted, ${duplicateCount} duplicates, ${cargoFilteredCount} cargo-filtered, ${errorCount} errors`);\n\n      await storage.updateTseImportJob(jobId, {\n        status: \"completed\",\n        stage: \"completed\",\n        totalRows: rowCount,\n        processedRows: insertedCount,\n        skippedRows: totalSkipped,\n        errorCount,\n        completedAt: new Date(),\n        updatedAt: new Date(),\n        validationMessage: validationMessage,\n      });\n\n      await unlink(zipPath).catch(() => {});\n      await unlink(csvPath).catch(() => {});\n      activeImportJobs.delete(jobId);\n    } catch (error: any) {\n      console.error(\"Detalhe votacao import error:\", error);\n      if (!isJobCancelled(jobId)) {\n        await storage.updateTseImportJob(jobId, {\n          status: \"failed\", stage: \"failed\", completedAt: new Date(),\n          updatedAt: new Date(), errorMessage: error.message || \"Unknown error\",\n        });\n      }\n      activeImportJobs.delete(jobId);\n    }\n  };\n\n  // Process Partido Votacao (Party Votes) Import\n  const processPartidoVotacaoImport = (jobId: number, url: string, selectedFile?: string) => {\n    addToTseQueue({ \n      jobId, \n      type: \"partido\", \n      url, \n      selectedFile,\n      processor: () => processPartidoVotacaoImportInternal(jobId, url, selectedFile)\n    });\n  };\n\n  const processPartidoVotacaoImportInternal = async (jobId: number, url: string, selectedFile?: string) => {\n    const tmpDir = `/tmp/tse-import-${jobId}`;\n    activeImportJobs.set(jobId, { cancelled: false });\n\n    try {\n      await storage.updateTseImportJob(jobId, { \n        status: \"downloading\", stage: \"downloading\", startedAt: new Date(), updatedAt: new Date()\n      });\n      await mkdir(tmpDir, { recursive: true });\n\n      const response = await fetch(url);\n      if (!response.ok) throw new Error(`Failed to download: ${response.status} ${response.statusText}`);\n\n      const contentLength = response.headers.get(\"content-length\");\n      const totalBytes = contentLength ? parseInt(contentLength) : 0;\n      if (totalBytes > 0) await storage.updateTseImportJob(jobId, { fileSize: totalBytes });\n\n      const zipPath = path.join(tmpDir, \"data.zip\");\n      const fileStream = createWriteStream(zipPath);\n      \n      if (!response.body) throw new Error(\"No response body\");\n\n      const reader = response.body.getReader();\n      let downloadedBytes = 0;\n      \n      while (true) {\n        if (isJobCancelled(jobId)) {\n          reader.cancel();\n          fileStream.end();\n          throw new Error(\"Importação cancelada\");\n        }\n        const { done, value } = await reader.read();\n        if (done) break;\n        fileStream.write(value);\n        downloadedBytes += value.length;\n      }\n      \n      await storage.updateTseImportJob(jobId, { downloadedBytes, updatedAt: new Date() });\n      fileStream.end();\n      await new Promise<void>((resolve, reject) => {\n        fileStream.on(\"finish\", resolve);\n        fileStream.on(\"error\", reject);\n      });\n\n      await storage.updateTseImportJob(jobId, { status: \"extracting\", stage: \"extracting\", updatedAt: new Date() });\n\n      const directory = await unzipper.Open.file(zipPath);\n      const csvFiles = directory.files.filter(f => \n        (f.path.endsWith(\".csv\") || f.path.endsWith(\".txt\")) && !f.path.startsWith(\"__MACOSX\")\n      );\n      \n      if (csvFiles.length === 0) throw new Error(\"No CSV/TXT file found in ZIP\");\n      \n      // Use selectedFile if provided, otherwise prioritize _BRASIL file\n      let csvFile;\n      if (selectedFile) {\n        csvFile = csvFiles.find(f => f.path === selectedFile || path.basename(f.path) === selectedFile);\n        if (!csvFile) throw new Error(`Selected file not found: ${selectedFile}`);\n        console.log(`[PARTIDO] Using user-selected file: ${csvFile.path}`);\n      } else {\n        const brasilFile = csvFiles.find(f => f.path.toUpperCase().includes(\"_BRASIL.CSV\") || f.path.toUpperCase().includes(\"_BRASIL.TXT\"));\n        csvFile = brasilFile || csvFiles[0];\n        console.log(`[PARTIDO] Found ${csvFiles.length} CSV files, using: ${csvFile.path}${brasilFile ? \" (arquivo BRASIL consolidado)\" : \"\"}`);\n      }\n      \n      const csvPath = path.join(tmpDir, \"data.csv\");\n      await pipeline(csvFile.stream(), createWriteStream(csvPath));\n\n      await storage.updateTseImportJob(jobId, { status: \"processing\", stage: \"processing\", updatedAt: new Date() });\n\n      const job = await storage.getTseImportJob(jobId);\n      const cargoFilter = job?.cargoFilter;\n      \n      const records: any[] = [];\n      let rowCount = 0;\n      let cargoFilteredCount = 0;  // Rows filtered by cargo\n      let duplicateCount = 0;       // Rows that already exist in DB\n      let insertedCount = 0;        // Actually inserted rows\n      let errorCount = 0;\n      const BATCH_SIZE = 5000; // Increased for better bulk insert performance\n\n      // Read first row to detect CSV structure (column count varies by year)\n      const firstRowPromise = new Promise<string[]>((resolve, reject) => {\n        const parser = createReadStream(csvPath, { encoding: \"latin1\" })\n          .pipe(parse({ delimiter: \";\", relax_quotes: true, skip_empty_lines: true, from_line: 2, to_line: 2 }));\n        parser.on(\"data\", (row: string[]) => resolve(row));\n        parser.on(\"error\", reject);\n        parser.on(\"end\", () => resolve([]));\n      });\n      const firstRow = await firstRowPromise;\n      const columnCount = firstRow.length;\n      console.log(`[PARTIDO] Detected ${columnCount} columns in CSV file`);\n\n      // Field mappings vary by TSE file format version\n      // TSE has three main formats:\n      // - Legacy (≤23 cols): 2010 and earlier - no coligacao details\n      // - Intermediate (24-30 cols): 2014-2018 - has coligacao but no federation\n      // - Modern (>30 cols): 2022+ - has federation and detailed coligacao\n      let fieldMap: { [key: number]: string };\n      let numericFields: number[];\n\n      if (columnCount <= 23) {\n        // Legacy format (2010 and earlier): ~23 columns, minimal structure\n        // DT_GERACAO;HH_GERACAO;ANO_ELEICAO;CD_TIPO_ELEICAO;NM_TIPO_ELEICAO;NR_TURNO;CD_ELEICAO;DS_ELEICAO;DT_ELEICAO;TP_ABRANGENCIA;\n        // SG_UF;SG_UE;NM_UE;CD_MUNICIPIO;NM_MUNICIPIO;NR_ZONA;CD_CARGO;DS_CARGO;\n        // NR_PARTIDO;SG_PARTIDO;NM_PARTIDO;QT_VOTOS_NOMINAIS;QT_VOTOS_LEGENDA\n        fieldMap = {\n          0: \"dtGeracao\", 1: \"hhGeracao\", 2: \"anoEleicao\", 3: \"cdTipoEleicao\", 4: \"nmTipoEleicao\",\n          5: \"nrTurno\", 6: \"cdEleicao\", 7: \"dsEleicao\", 8: \"dtEleicao\", 9: \"tpAbrangencia\",\n          10: \"sgUf\", 11: \"sgUe\", 12: \"nmUe\", 13: \"cdMunicipio\", 14: \"nmMunicipio\",\n          15: \"nrZona\", 16: \"cdCargo\", 17: \"dsCargo\",\n          18: \"nrPartido\", 19: \"sgPartido\", 20: \"nmPartido\",\n          21: \"qtVotosNominaisValidos\", 22: \"qtVotosLegendaValidos\"\n        };\n        numericFields = [2, 3, 5, 6, 13, 15, 16, 18, 21, 22];\n        console.log(`[PARTIDO] Using legacy format (≤2010) field mapping - ${columnCount} columns`);\n      } else if (columnCount <= 30) {\n        // Intermediate format (2014-2018): 28 columns\n        // Has TP_AGREMIACAO and SQ_COLIGACAO but NO federation fields\n        // DT_GERACAO;HH_GERACAO;ANO_ELEICAO;CD_TIPO_ELEICAO;NM_TIPO_ELEICAO;NR_TURNO;CD_ELEICAO;DS_ELEICAO;DT_ELEICAO;TP_ABRANGENCIA;\n        // SG_UF;SG_UE;NM_UE;CD_MUNICIPIO;NM_MUNICIPIO;NR_ZONA;CD_CARGO;DS_CARGO;\n        // TP_AGREMIACAO;NR_PARTIDO;SG_PARTIDO;NM_PARTIDO;SQ_COLIGACAO;NM_COLIGACAO;DS_COMPOSICAO_COLIGACAO;\n        // ST_VOTO_EM_TRANSITO;QT_VOTOS_NOMINAIS;QT_VOTOS_LEGENDA\n        fieldMap = {\n          0: \"dtGeracao\", 1: \"hhGeracao\", 2: \"anoEleicao\", 3: \"cdTipoEleicao\", 4: \"nmTipoEleicao\",\n          5: \"nrTurno\", 6: \"cdEleicao\", 7: \"dsEleicao\", 8: \"dtEleicao\", 9: \"tpAbrangencia\",\n          10: \"sgUf\", 11: \"sgUe\", 12: \"nmUe\", 13: \"cdMunicipio\", 14: \"nmMunicipio\",\n          15: \"nrZona\", 16: \"cdCargo\", 17: \"dsCargo\", 18: \"tpAgremiacao\",\n          19: \"nrPartido\", 20: \"sgPartido\", 21: \"nmPartido\",\n          22: \"sqColigacao\", 23: \"nmColigacao\", 24: \"dsComposicaoColigacao\",\n          25: \"stVotoEmTransito\", 26: \"qtVotosNominaisValidos\", 27: \"qtVotosLegendaValidos\"\n        };\n        // Note: sqColigacao (22) is TEXT, not numeric - excluded from numericFields\n        numericFields = [2, 3, 5, 6, 13, 15, 16, 19, 26, 27];\n        console.log(`[PARTIDO] Using intermediate format (2014-2018) field mapping - ${columnCount} columns`);\n      } else {\n        // Modern format (2022+): 38 columns with federation and detailed coligacao\n        fieldMap = {\n          0: \"dtGeracao\", 1: \"hhGeracao\", 2: \"anoEleicao\", 3: \"cdTipoEleicao\", 4: \"nmTipoEleicao\",\n          5: \"nrTurno\", 6: \"cdEleicao\", 7: \"dsEleicao\", 8: \"dtEleicao\", 9: \"tpAbrangencia\",\n          10: \"sgUf\", 11: \"sgUe\", 12: \"nmUe\", 13: \"cdMunicipio\", 14: \"nmMunicipio\",\n          15: \"nrZona\", 16: \"cdCargo\", 17: \"dsCargo\", 18: \"tpAgremiacao\", 19: \"nrPartido\",\n          20: \"sgPartido\", 21: \"nmPartido\", 22: \"nrFederacao\", 23: \"nmFederacao\", 24: \"sgFederacao\",\n          25: \"dsComposicaoFederacao\", 26: \"sqColigacao\", 27: \"nmColigacao\", 28: \"dsComposicaoColigacao\",\n          29: \"stVotoEmTransito\", 30: \"qtVotosLegendaValidos\", 31: \"qtVotosNomConvrLegValidos\",\n          32: \"qtTotalVotosLegValidos\", 33: \"qtVotosNominaisValidos\", 34: \"qtVotosLegendaAnulSubjud\",\n          35: \"qtVotosNominaisAnulSubjud\", 36: \"qtVotosLegendaAnulados\", 37: \"qtVotosNominaisAnulados\"\n        };\n        // Note: sqColigacao (26) is TEXT, not numeric - excluded from numericFields\n        numericFields = [2, 3, 5, 6, 13, 15, 16, 19, 22, 30, 31, 32, 33, 34, 35, 36, 37];\n        console.log(`[PARTIDO] Using modern format (2022+) field mapping - ${columnCount} columns`);\n      }\n\n      // Get column indices for key fields based on format\n      const getFieldIndex = (fieldName: string): number => {\n        for (const [idx, name] of Object.entries(fieldMap)) {\n          if (name === fieldName) return parseInt(idx);\n        }\n        return -1;\n      };\n      \n      const idxAnoEleicao = getFieldIndex(\"anoEleicao\");\n      const idxCdEleicao = getFieldIndex(\"cdEleicao\");\n      const idxNrTurno = getFieldIndex(\"nrTurno\");\n      const idxSgUf = getFieldIndex(\"sgUf\");\n      const idxCdMunicipio = getFieldIndex(\"cdMunicipio\");\n      const idxNrZona = getFieldIndex(\"nrZona\");\n      const idxCdCargo = getFieldIndex(\"cdCargo\");\n      const idxNrPartido = getFieldIndex(\"nrPartido\");\n      const idxStVotoEmTransito = getFieldIndex(\"stVotoEmTransito\");\n\n      const parseValue = (value: string | undefined, isNumeric: boolean = false): any => {\n        if (!value || value === \"#NULO\" || value === \"#NE\") return isNumeric ? 0 : null;\n        if (isNumeric) {\n          const parsed = parseInt(value.replace(/\"/g, \"\"), 10);\n          return isNaN(parsed) || parsed === -1 || parsed === -3 ? 0 : parsed;\n        }\n        return value.replace(/\"/g, \"\").trim();\n      };\n\n      // Collect all rows first (synchronously), then process in batches\n      const allRows: string[][] = [];\n      await new Promise<void>((resolve, reject) => {\n        const parser = createReadStream(csvPath, { encoding: \"latin1\" })\n          .pipe(parse({ delimiter: \";\", relax_quotes: true, skip_empty_lines: true, from_line: 2 }));\n\n        parser.on(\"data\", (row: string[]) => {\n          allRows.push(row);\n        });\n        parser.on(\"end\", () => resolve());\n        parser.on(\"error\", reject);\n      });\n\n      console.log(`[PARTIDO] Parsed ${allRows.length} rows, processing in batches...`);\n      \n      // Set totalFileRows for progress calculation\n      await storage.updateTseImportJob(jobId, { \n        totalFileRows: allRows.length,\n        stage: \"processing\",\n        updatedAt: new Date()\n      });\n\n      // Delete any previous batch records for this job (in case of re-import)\n      await storage.deleteBatchesByJob(jobId);\n      \n      // Pre-filter rows by cargo and prepare batch chunks\n      const filteredRows: { index: number; row: string[] }[] = [];\n      for (let i = 0; i < allRows.length; i++) {\n        const row = allRows[i];\n        const cdCargo = parseValue(row[idxCdCargo], true);\n        if (cargoFilter && cdCargo !== cargoFilter) {\n          cargoFilteredCount++;\n          continue;\n        }\n        filteredRows.push({ index: i, row });\n      }\n      \n      console.log(`[PARTIDO] After cargo filter: ${filteredRows.length} rows to process (${cargoFilteredCount} filtered)`);\n      \n      // Deduplicate rows based on unique key fields before inserting\n      // Key: ano_eleicao + cd_eleicao + nr_turno + sg_uf + cd_municipio + nr_zona + cd_cargo + nr_partido + st_voto_em_transito\n      const seenKeys = new Set<string>();\n      const deduplicatedRows: { index: number; row: string[] }[] = [];\n      let csvDuplicateCount = 0;\n      \n      for (const item of filteredRows) {\n        const row = item.row;\n        const key = [\n          parseValue(row[idxAnoEleicao], true),   // anoEleicao\n          parseValue(row[idxCdEleicao], true),    // cdEleicao\n          parseValue(row[idxNrTurno], true),      // nrTurno\n          parseValue(row[idxSgUf], false),        // sgUf\n          parseValue(row[idxCdMunicipio], true),  // cdMunicipio\n          parseValue(row[idxNrZona], true),       // nrZona\n          parseValue(row[idxCdCargo], true),      // cdCargo\n          parseValue(row[idxNrPartido], true),    // nrPartido\n          idxStVotoEmTransito >= 0 ? parseValue(row[idxStVotoEmTransito], false) : \"N\", // stVotoEmTransito (may not exist in legacy format)\n        ].join('|');\n        \n        if (seenKeys.has(key)) {\n          csvDuplicateCount++;\n        } else {\n          seenKeys.add(key);\n          deduplicatedRows.push(item);\n        }\n      }\n      \n      if (csvDuplicateCount > 0) {\n        console.log(`[PARTIDO] Found ${csvDuplicateCount} duplicate rows in CSV file (exact same unique key), keeping ${deduplicatedRows.length} unique rows`);\n      }\n      \n      // Replace filteredRows with deduplicated version\n      const rowsToProcess = deduplicatedRows;\n      \n      // Calculate total batches using deduplicated rows\n      const totalBatches = Math.ceil(rowsToProcess.length / BATCH_SIZE);\n      \n      // Process rows in batches with tracking\n      for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {\n        const startIdx = batchIndex * BATCH_SIZE;\n        const endIdx = Math.min(startIdx + BATCH_SIZE, rowsToProcess.length);\n        const batchRows = rowsToProcess.slice(startIdx, endIdx);\n        \n        // Use original file row indices for audit trail (add 2 for 1-based + header row)\n        const originalRowStart = batchRows[0].index + 2;\n        const originalRowEnd = batchRows[batchRows.length - 1].index + 2;\n        \n        // Create batch record\n        const batchRecord = await storage.createImportBatch({\n          importJobId: jobId,\n          batchIndex,\n          status: \"processing\",\n          rowStart: originalRowStart,\n          rowEnd: originalRowEnd,\n          totalRows: batchRows.length,\n          processedRows: 0,\n          insertedRows: 0,\n          skippedRows: 0,\n          errorCount: 0,\n          startedAt: new Date(),\n        });\n        \n        let batchInserted = 0;\n        let batchSkipped = 0;\n        let batchErrors = 0;\n        let batchErrorSummary = \"\";\n        \n        try {\n          // Parse batch rows into records\n          const batchRecords: any[] = [];\n          for (const { row } of batchRows) {\n            rowCount++;\n            const record: any = { importJobId: jobId };\n            for (const [index, field] of Object.entries(fieldMap)) {\n              const idx = parseInt(index);\n              if (idx < row.length) {\n                record[field] = parseValue(row[idx], numericFields.includes(idx));\n              }\n            }\n            batchRecords.push(record);\n          }\n          \n          // Insert batch\n          const inserted = await storage.insertTsePartyVotesBatch(batchRecords);\n          batchInserted = inserted;\n          batchSkipped = batchRecords.length - inserted;\n          insertedCount += batchInserted;\n          duplicateCount += batchSkipped;\n          \n          // Update batch record as completed\n          await storage.updateImportBatch(batchRecord.id, {\n            status: \"completed\",\n            processedRows: batchRows.length,\n            insertedRows: batchInserted,\n            skippedRows: batchSkipped,\n            errorCount: 0,\n            completedAt: new Date(),\n          });\n        } catch (err: any) {\n          console.error(`[PARTIDO] Batch ${batchIndex + 1} error:`, err);\n          batchErrors = batchRows.length;\n          batchErrorSummary = err.message || \"Unknown error\";\n          errorCount += batchErrors;\n          \n          // Update batch record as failed\n          await storage.updateImportBatch(batchRecord.id, {\n            status: \"failed\",\n            processedRows: 0,\n            errorCount: batchErrors,\n            errorSummary: batchErrorSummary,\n            completedAt: new Date(),\n          });\n        }\n        \n        // Update job progress\n        const totalSkipped = cargoFilteredCount + duplicateCount;\n        await storage.updateTseImportJob(jobId, { \n          processedRows: insertedCount,\n          skippedRows: totalSkipped,\n          errorCount,\n          updatedAt: new Date()\n        });\n        \n        // Log progress every 10 batches\n        if ((batchIndex + 1) % 10 === 0 || batchIndex === totalBatches - 1) {\n          console.log(`[PARTIDO] Batch ${batchIndex + 1}/${totalBatches}: ${insertedCount} inserted, ${duplicateCount} duplicates`);\n        }\n        \n        // Yield to event loop to prevent CPU blocking\n        await new Promise(resolve => setImmediate(resolve));\n      }\n\n      // Sync parties from imported party votes data\n      const partiesResult = await storage.syncPartiesFromTseImport(jobId);\n      console.log(`TSE Import ${jobId} [PARTIDO]: Synced parties - ${partiesResult.created} created, ${partiesResult.updated} updated, ${partiesResult.existing} existing`);\n\n      const totalSkipped = cargoFilteredCount + duplicateCount + csvDuplicateCount;\n      const validationMessage = insertedCount === 0 && (duplicateCount > 0 || csvDuplicateCount > 0)\n        ? `Dados já importados: ${(duplicateCount + csvDuplicateCount).toLocaleString(\"pt-BR\")} registros duplicados encontrados`\n        : insertedCount > 0\n          ? `Importação concluída: ${insertedCount.toLocaleString(\"pt-BR\")} inseridos, ${csvDuplicateCount > 0 ? `${csvDuplicateCount.toLocaleString(\"pt-BR\")} duplicados CSV + ` : ''}${duplicateCount.toLocaleString(\"pt-BR\")} duplicados DB`\n          : null;\n\n      console.log(`[PARTIDO] Completed: ${allRows.length} total file rows, ${insertedCount} inserted, ${csvDuplicateCount} CSV duplicates removed, ${duplicateCount} DB duplicates, ${cargoFilteredCount} cargo-filtered, ${errorCount} errors`);\n\n      await storage.updateTseImportJob(jobId, {\n        status: \"completed\", stage: \"completed\", totalRows: rowCount,\n        processedRows: insertedCount, skippedRows: totalSkipped,\n        errorCount, completedAt: new Date(), updatedAt: new Date(),\n        validationMessage: validationMessage,\n      });\n\n      await unlink(zipPath).catch(() => {});\n      await unlink(csvPath).catch(() => {});\n      activeImportJobs.delete(jobId);\n    } catch (error: any) {\n      console.error(\"Partido votacao import error:\", error);\n      if (!isJobCancelled(jobId)) {\n        await storage.updateTseImportJob(jobId, {\n          status: \"failed\", stage: \"failed\", completedAt: new Date(),\n          updatedAt: new Date(), errorMessage: error.message || \"Unknown error\",\n        });\n      }\n      activeImportJobs.delete(jobId);\n    }\n  };\n\n  app.get(\"/api/tse/candidates\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf, cargo, limit = 100, offset = 0 } = req.query;\n      const candidates = await storage.getTseCandidateVotes({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n        cargo: cargo ? parseInt(cargo as string) : undefined,\n        limit: parseInt(limit as string),\n        offset: parseInt(offset as string),\n      });\n      res.json(candidates);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch TSE candidates\" });\n    }\n  });\n\n  app.get(\"/api/tse/stats\", requireAuth, async (req, res) => {\n    try {\n      const stats = await storage.getTseStats();\n      res.json(stats);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch TSE stats\" });\n    }\n  });\n\n  app.get(\"/api/tse/search\", requireAuth, async (req, res) => {\n    try {\n      const { q, year, uf, cargo } = req.query;\n      if (!q || typeof q !== \"string\" || q.length < 2) {\n        return res.json([]);\n      }\n      const candidates = await storage.searchTseCandidates(q, {\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n        cargo: cargo ? parseInt(cargo as string) : undefined,\n      });\n      res.json(candidates);\n    } catch (error) {\n      console.error(\"TSE search error:\", error);\n      res.status(500).json({ error: \"Failed to search TSE candidates\" });\n    }\n  });\n\n  const processCSVImport = async (jobId: number, filePath: string) => {\n    try {\n      await storage.updateTseImportJob(jobId, { \n        status: \"processing\", \n        stage: \"processing\",\n        startedAt: new Date(),\n        updatedAt: new Date()\n      });\n      \n      const job = await storage.getTseImportJob(jobId);\n      const cargoFilter = job?.cargoFilter;\n\n      const records: InsertTseCandidateVote[] = [];\n      let rowCount = 0;\n      let filteredCount = 0;\n      let errorCount = 0;\n      const BATCH_SIZE = 5000; // Increased for better bulk insert performance\n\n      const parser = createReadStream(filePath)\n        .pipe(iconv.decodeStream(\"latin1\"))\n        .pipe(parse({\n          delimiter: \";\",\n          quote: '\"',\n          relax_quotes: true,\n          relax_column_count: true,\n          skip_empty_lines: true,\n          from_line: 2,\n        }));\n\n      const fieldMap: { [key: number]: keyof InsertTseCandidateVote } = {\n        0: \"dtGeracao\",\n        1: \"hhGeracao\",\n        2: \"anoEleicao\",\n        3: \"cdTipoEleicao\",\n        4: \"nmTipoEleicao\",\n        5: \"nrTurno\",\n        6: \"cdEleicao\",\n        7: \"dsEleicao\",\n        8: \"dtEleicao\",\n        9: \"tpAbrangencia\",\n        10: \"sgUf\",\n        11: \"sgUe\",\n        12: \"nmUe\",\n        13: \"cdMunicipio\",\n        14: \"nmMunicipio\",\n        15: \"nrZona\",\n        16: \"cdCargo\",\n        17: \"dsCargo\",\n        18: \"sqCandidato\",\n        19: \"nrCandidato\",\n        20: \"nmCandidato\",\n        21: \"nmUrnaCandidato\",\n        22: \"nmSocialCandidato\",\n        23: \"cdSituacaoCandidatura\",\n        24: \"dsSituacaoCandidatura\",\n        25: \"cdDetalheSituacaoCand\",\n        26: \"dsDetalheSituacaoCand\",\n        27: \"cdSituacaoJulgamento\",\n        28: \"dsSituacaoJulgamento\",\n        29: \"cdSituacaoCassacao\",\n        30: \"dsSituacaoCassacao\",\n        31: \"cdSituacaoDconstDiploma\",\n        32: \"dsSituacaoDconstDiploma\",\n        33: \"tpAgremiacao\",\n        34: \"nrPartido\",\n        35: \"sgPartido\",\n        36: \"nmPartido\",\n        37: \"nrFederacao\",\n        38: \"nmFederacao\",\n        39: \"sgFederacao\",\n        40: \"dsComposicaoFederacao\",\n        41: \"sqColigacao\",\n        42: \"nmColigacao\",\n        43: \"dsComposicaoColigacao\",\n        44: \"stVotoEmTransito\",\n        45: \"qtVotosNominais\",\n        46: \"nmTipoDestinacaoVotos\",\n        47: \"qtVotosNominaisValidos\",\n        48: \"cdSitTotTurno\",\n        49: \"dsSitTotTurno\",\n      };\n\n      const parseValue = (value: string, field: string): any => {\n        if (value === \"#NULO\" || value === \"#NE\" || value === \"\") {\n          return null;\n        }\n        const intFields = [\n          \"anoEleicao\", \"cdTipoEleicao\", \"nrTurno\", \"cdEleicao\", \"cdMunicipio\",\n          \"nrZona\", \"cdCargo\", \"nrCandidato\", \"cdSituacaoCandidatura\",\n          \"cdDetalheSituacaoCand\", \"cdSituacaoJulgamento\", \"cdSituacaoCassacao\",\n          \"cdSituacaoDconstDiploma\", \"nrPartido\", \"nrFederacao\", \"qtVotosNominais\",\n          \"qtVotosNominaisValidos\", \"cdSitTotTurno\"\n        ];\n        if (intFields.includes(field)) {\n          const num = parseInt(value);\n          if (isNaN(num) || num === -1 || num === -3) return null;\n          return num;\n        }\n        return value;\n      };\n\n      for await (const row of parser) {\n        try {\n          rowCount++;\n          const record: any = { importJobId: jobId };\n\n          for (let i = 0; i < row.length; i++) {\n            const field = fieldMap[i];\n            if (field) {\n              record[field] = parseValue(row[i], field);\n            }\n          }\n\n          if (cargoFilter && record.cdCargo !== cargoFilter) {\n            filteredCount++;\n          } else {\n            records.push(record);\n          }\n\n          if (records.length >= BATCH_SIZE) {\n            await storage.bulkInsertTseCandidateVotes(records);\n            await storage.updateTseImportJob(jobId, { \n              processedRows: rowCount,\n              updatedAt: new Date()\n            });\n            records.length = 0;\n          }\n        } catch (err: any) {\n          errorCount++;\n          await storage.createTseImportError({\n            importJobId: jobId,\n            rowNumber: rowCount,\n            errorType: \"parse_error\",\n            errorMessage: err.message,\n            rawData: JSON.stringify(row).substring(0, 1000),\n          });\n        }\n      }\n\n      if (records.length > 0) {\n        await storage.bulkInsertTseCandidateVotes(records);\n      }\n\n      // Sync parties from imported data before marking as complete\n      const partiesResult = await storage.syncPartiesFromTseImport(jobId);\n      console.log(`TSE Import ${jobId}: Synced parties - ${partiesResult.created} created, ${partiesResult.updated} updated, ${partiesResult.existing} existing`);\n\n      await storage.updateTseImportJob(jobId, {\n        status: \"completed\",\n        stage: \"completed\",\n        totalRows: rowCount,\n        processedRows: rowCount,\n        errorCount,\n        completedAt: new Date(),\n        updatedAt: new Date(),\n      });\n\n      console.log(`TSE Import ${jobId} completed: ${rowCount} rows, ${errorCount} errors`);\n\n      // Trigger embedding generation for semantic search (if API key configured)\n      if (process.env.OPENAI_API_KEY) {\n        console.log(`TSE Import ${jobId}: Starting background embedding generation...`);\n        generateEmbeddingsForImportJob(jobId)\n          .then(result => {\n            console.log(`TSE Import ${jobId}: Embeddings generated - ${result.processed} processed, ${result.skipped} skipped, ${result.errors} errors`);\n          })\n          .catch(error => {\n            console.error(`TSE Import ${jobId}: Embedding generation failed:`, error);\n          });\n      }\n    } catch (error: any) {\n      console.error(`TSE Import ${jobId} failed:`, error);\n      await storage.updateTseImportJob(jobId, {\n        status: \"failed\",\n        stage: \"failed\",\n        errorCount: 1,\n        completedAt: new Date(),\n        updatedAt: new Date(),\n      });\n      await storage.createTseImportError({\n        importJobId: jobId,\n        rowNumber: 0,\n        errorType: \"fatal_error\",\n        errorMessage: error.message,\n        rawData: null,\n      });\n    }\n  }\n\n  // Data Analysis endpoints\n  app.get(\"/api/analytics/summary\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf, electionType } = req.query;\n      const summary = await storage.getAnalyticsSummary({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n        electionType: electionType as string | undefined,\n      });\n      res.json(summary);\n    } catch (error) {\n      console.error(\"Analytics summary error:\", error);\n      res.status(500).json({ error: \"Failed to fetch analytics summary\" });\n    }\n  });\n\n  app.get(\"/api/analytics/votes-by-party\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf, electionType, limit } = req.query;\n      const data = await storage.getVotesByParty({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n        electionType: electionType as string | undefined,\n        limit: limit ? parseInt(limit as string) : 20,\n      });\n      res.json(data);\n    } catch (error) {\n      console.error(\"Votes by party error:\", error);\n      res.status(500).json({ error: \"Failed to fetch votes by party\" });\n    }\n  });\n\n  app.get(\"/api/analytics/top-candidates\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf, electionType, limit } = req.query;\n      const data = await storage.getTopCandidates({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n        electionType: electionType as string | undefined,\n        limit: limit ? parseInt(limit as string) : 20,\n      });\n      res.json(data);\n    } catch (error) {\n      console.error(\"Top candidates error:\", error);\n      res.status(500).json({ error: \"Failed to fetch top candidates\" });\n    }\n  });\n\n  app.get(\"/api/analytics/votes-by-state\", requireAuth, async (req, res) => {\n    try {\n      const { year, electionType } = req.query;\n      const data = await storage.getVotesByState({\n        year: year ? parseInt(year as string) : undefined,\n        electionType: electionType as string | undefined,\n      });\n      res.json(data);\n    } catch (error) {\n      console.error(\"Votes by state error:\", error);\n      res.status(500).json({ error: \"Failed to fetch votes by state\" });\n    }\n  });\n\n  app.get(\"/api/analytics/votes-by-municipality\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf, electionType, limit } = req.query;\n      const data = await storage.getVotesByMunicipality({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n        electionType: electionType as string | undefined,\n        limit: limit ? parseInt(limit as string) : 50,\n      });\n      res.json(data);\n    } catch (error) {\n      console.error(\"Votes by municipality error:\", error);\n      res.status(500).json({ error: \"Failed to fetch votes by municipality\" });\n    }\n  });\n\n  app.get(\"/api/analytics/election-years\", requireAuth, async (req, res) => {\n    try {\n      const years = await storage.getAvailableElectionYears();\n      res.json(years);\n    } catch (error) {\n      console.error(\"Election years error:\", error);\n      res.status(500).json({ error: \"Failed to fetch election years\" });\n    }\n  });\n\n  // Election Simulation Endpoints\n  const { startElectionSimulation, pauseSimulation, resumeSimulation, cancelSimulation, getActiveSimulations } = await import(\"./election-simulation\");\n\n  app.post(\"/api/election-simulation/start\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { year, state, position, speed } = req.body;\n      if (!year) {\n        return res.status(400).json({ error: \"Year is required\" });\n      }\n      const result = await startElectionSimulation({ year, state, position, speed });\n      await logAudit(req, \"start\", \"election_simulation\", result.simulationId);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Failed to start election simulation:\", error);\n      res.status(500).json({ error: error instanceof Error ? error.message : \"Failed to start simulation\" });\n    }\n  });\n\n  app.post(\"/api/election-simulation/:id/pause\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const success = pauseSimulation(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Simulation not found or not running\" });\n      }\n      res.json({ success: true, message: \"Simulação pausada\" });\n    } catch (error) {\n      console.error(\"Failed to pause simulation:\", error);\n      res.status(500).json({ error: \"Failed to pause simulation\" });\n    }\n  });\n\n  app.post(\"/api/election-simulation/:id/resume\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const speed = req.body.speed || 1;\n      const success = resumeSimulation(req.params.id, speed);\n      if (!success) {\n        return res.status(404).json({ error: \"Simulation not found or not paused\" });\n      }\n      res.json({ success: true, message: \"Simulação retomada\" });\n    } catch (error) {\n      console.error(\"Failed to resume simulation:\", error);\n      res.status(500).json({ error: \"Failed to resume simulation\" });\n    }\n  });\n\n  app.post(\"/api/election-simulation/:id/cancel\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const success = cancelSimulation(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Simulation not found\" });\n      }\n      await logAudit(req, \"cancel\", \"election_simulation\", req.params.id);\n      res.json({ success: true, message: \"Simulação cancelada\" });\n    } catch (error) {\n      console.error(\"Failed to cancel simulation:\", error);\n      res.status(500).json({ error: \"Failed to cancel simulation\" });\n    }\n  });\n\n  app.get(\"/api/election-simulation/active\", requireAuth, async (req, res) => {\n    try {\n      const simulations = getActiveSimulations();\n      res.json(simulations);\n    } catch (error) {\n      console.error(\"Failed to get active simulations:\", error);\n      res.status(500).json({ error: \"Failed to get active simulations\" });\n    }\n  });\n\n  app.get(\"/api/analytics/states\", requireAuth, async (req, res) => {\n    try {\n      const { year } = req.query;\n      const states = await storage.getAvailableStates(year ? parseInt(year as string) : undefined);\n      res.json(states);\n    } catch (error) {\n      console.error(\"States error:\", error);\n      res.status(500).json({ error: \"Failed to fetch states\" });\n    }\n  });\n\n  app.get(\"/api/analytics/election-types\", requireAuth, async (req, res) => {\n    try {\n      const { year } = req.query;\n      const types = await storage.getAvailableElectionTypes(year ? parseInt(year as string) : undefined);\n      res.json(types);\n    } catch (error) {\n      console.error(\"Election types error:\", error);\n      res.status(500).json({ error: \"Failed to fetch election types\" });\n    }\n  });\n\n  // Advanced Segmentation - Municipalities\n  app.get(\"/api/analytics/municipalities\", requireAuth, async (req, res) => {\n    try {\n      const { uf, year } = req.query;\n      const municipalities = await storage.getMunicipalities({\n        uf: uf as string | undefined,\n        year: year ? parseInt(year as string) : undefined,\n      });\n      res.json(municipalities);\n    } catch (error) {\n      console.error(\"Municipalities error:\", error);\n      res.status(500).json({ error: \"Failed to fetch municipalities\" });\n    }\n  });\n\n  app.get(\"/api/analytics/votes-by-municipality\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf, position, party, municipality } = req.query;\n      const votes = await storage.getVotesByMunicipality({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n        position: position as string | undefined,\n        party: party as string | undefined,\n        municipality: municipality as string | undefined,\n      });\n      res.json(votes);\n    } catch (error) {\n      console.error(\"Votes by municipality error:\", error);\n      res.status(500).json({ error: \"Failed to fetch votes by municipality\" });\n    }\n  });\n\n  app.get(\"/api/analytics/positions\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf } = req.query;\n      const positions = await storage.getPositions({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n      });\n      res.json(positions);\n    } catch (error) {\n      console.error(\"Positions error:\", error);\n      res.status(500).json({ error: \"Failed to fetch positions\" });\n    }\n  });\n\n  // Custom Dashboards CRUD\n  app.get(\"/api/dashboards\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const dashboards = await storage.getCustomDashboards(userId);\n      res.json(dashboards);\n    } catch (error) {\n      console.error(\"Dashboards error:\", error);\n      res.status(500).json({ error: \"Failed to fetch dashboards\" });\n    }\n  });\n\n  app.get(\"/api/dashboards/public\", requireAuth, async (req, res) => {\n    try {\n      const dashboards = await storage.getPublicDashboards();\n      res.json(dashboards);\n    } catch (error) {\n      console.error(\"Public dashboards error:\", error);\n      res.status(500).json({ error: \"Failed to fetch public dashboards\" });\n    }\n  });\n\n  app.get(\"/api/dashboards/:id\", requireAuth, async (req, res) => {\n    try {\n      const dashboard = await storage.getCustomDashboard(parseInt(req.params.id));\n      if (!dashboard) {\n        return res.status(404).json({ error: \"Dashboard not found\" });\n      }\n      res.json(dashboard);\n    } catch (error) {\n      console.error(\"Dashboard error:\", error);\n      res.status(500).json({ error: \"Failed to fetch dashboard\" });\n    }\n  });\n\n  app.post(\"/api/dashboards\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const dashboard = await storage.createCustomDashboard({\n        ...req.body,\n        userId,\n      });\n      await logAudit(req, \"create\", \"custom_dashboard\", String(dashboard.id));\n      res.status(201).json(dashboard);\n    } catch (error) {\n      console.error(\"Create dashboard error:\", error);\n      res.status(500).json({ error: \"Failed to create dashboard\" });\n    }\n  });\n\n  app.patch(\"/api/dashboards/:id\", requireAuth, async (req, res) => {\n    try {\n      const dashboard = await storage.updateCustomDashboard(parseInt(req.params.id), req.body);\n      if (!dashboard) {\n        return res.status(404).json({ error: \"Dashboard not found\" });\n      }\n      await logAudit(req, \"update\", \"custom_dashboard\", req.params.id);\n      res.json(dashboard);\n    } catch (error) {\n      console.error(\"Update dashboard error:\", error);\n      res.status(500).json({ error: \"Failed to update dashboard\" });\n    }\n  });\n\n  app.delete(\"/api/dashboards/:id\", requireAuth, async (req, res) => {\n    try {\n      const success = await storage.deleteCustomDashboard(parseInt(req.params.id));\n      if (!success) {\n        return res.status(404).json({ error: \"Dashboard not found\" });\n      }\n      await logAudit(req, \"delete\", \"custom_dashboard\", req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Delete dashboard error:\", error);\n      res.status(500).json({ error: \"Failed to delete dashboard\" });\n    }\n  });\n\n  // AI Suggestions Endpoints\n  app.get(\"/api/ai/suggestions\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { type, dismissed } = req.query;\n      const suggestions = await storage.getAiSuggestions(userId, {\n        type: type as string | undefined,\n        dismissed: dismissed === \"true\" ? true : dismissed === \"false\" ? false : undefined,\n      });\n      res.json(suggestions);\n    } catch (error) {\n      console.error(\"AI suggestions error:\", error);\n      res.status(500).json({ error: \"Failed to fetch AI suggestions\" });\n    }\n  });\n\n  app.post(\"/api/ai/suggestions/:id/dismiss\", requireAuth, async (req, res) => {\n    try {\n      const success = await storage.dismissAiSuggestion(parseInt(req.params.id));\n      if (!success) {\n        return res.status(404).json({ error: \"Suggestion not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Dismiss suggestion error:\", error);\n      res.status(500).json({ error: \"Failed to dismiss suggestion\" });\n    }\n  });\n\n  app.post(\"/api/ai/suggestions/:id/apply\", requireAuth, async (req, res) => {\n    try {\n      const success = await storage.applyAiSuggestion(parseInt(req.params.id));\n      if (!success) {\n        return res.status(404).json({ error: \"Suggestion not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Apply suggestion error:\", error);\n      res.status(500).json({ error: \"Failed to apply suggestion\" });\n    }\n  });\n\n  // AI Generate Suggestions - analyzes current data and generates chart/report suggestions\n  app.post(\"/api/ai/generate-suggestions\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { filters } = req.body;\n\n      const summary = await storage.getAnalyticsSummary(filters);\n      const partyData = await storage.getVotesByParty({ ...filters, limit: 10 });\n      const stateData = await storage.getAvailableStates(filters?.year);\n\n      const openai = new (await import(\"openai\")).default({\n        apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n        baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n      });\n\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [\n          {\n            role: \"system\",\n            content: `Você é um analista de dados eleitorais especializado no sistema eleitoral brasileiro.\nAnalise os dados fornecidos e sugira gráficos e relatórios úteis.\nResponda em JSON com o seguinte formato:\n{\n  \"suggestions\": [\n    {\n      \"type\": \"chart\" | \"report\" | \"insight\",\n      \"title\": \"Título da sugestão\",\n      \"description\": \"Descrição detalhada\",\n      \"relevanceScore\": 0-100,\n      \"configuration\": {\n        \"chartType\": \"bar\" | \"line\" | \"pie\" | \"area\",\n        \"metrics\": [\"nome_da_metrica\"],\n        \"dimensions\": [\"dimensao\"],\n        \"filters\": {}\n      }\n    }\n  ]\n}`\n          },\n          {\n            role: \"user\",\n            content: `Dados disponíveis:\n- Total de votos: ${summary.totalVotes}\n- Total de candidatos: ${summary.totalCandidates}\n- Total de partidos: ${summary.totalParties}\n- Total de municípios: ${summary.totalMunicipalities}\n\nPartidos com mais votos: ${JSON.stringify(partyData.slice(0, 5))}\nEstados disponíveis: ${stateData.length}\n\nFiltros aplicados: ${JSON.stringify(filters || {})}\n\nSugira 3-5 visualizações e análises relevantes baseadas nestes dados.`\n          }\n        ],\n        response_format: { type: \"json_object\" },\n        max_completion_tokens: 1500,\n      });\n\n      const content = response.choices[0]?.message?.content;\n      if (!content) {\n        return res.status(500).json({ error: \"No AI response\" });\n      }\n\n      const parsed = JSON.parse(content);\n      const createdSuggestions = [];\n\n      for (const suggestion of parsed.suggestions || []) {\n        const created = await storage.createAiSuggestion({\n          userId,\n          suggestionType: suggestion.type,\n          title: suggestion.title,\n          description: suggestion.description,\n          configuration: suggestion.configuration,\n          relevanceScore: String(suggestion.relevanceScore || 50),\n          dataContext: filters || {},\n        });\n        createdSuggestions.push(created);\n      }\n\n      await logAudit(req, \"generate\", \"ai_suggestions\", String(createdSuggestions.length));\n      res.json({ suggestions: createdSuggestions });\n    } catch (error) {\n      console.error(\"Generate AI suggestions error:\", error);\n      res.status(500).json({ error: \"Failed to generate AI suggestions\" });\n    }\n  });\n\n  // ===== Sentiment Analysis Routes =====\n\n  // Run sentiment analysis - aggregates from multiple sources and analyzes with AI\n  app.post(\"/api/sentiment/analyze\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { entityType, entityId, days } = req.body;\n      const result = await runSentimentAnalysis({ entityType, entityId, days });\n      res.json(result);\n    } catch (error) {\n      console.error(\"Sentiment analysis error:\", error);\n      res.status(500).json({ error: \"Failed to run sentiment analysis\" });\n    }\n  });\n\n  // Get sentiment timeline for a specific entity\n  app.get(\"/api/sentiment/timeline\", requireAuth, async (req, res) => {\n    try {\n      const { entityType, entityId, days } = req.query;\n      if (!entityType || !entityId) {\n        return res.status(400).json({ error: \"entityType and entityId required\" });\n      }\n      const timeline = await getSentimentTimeline(\n        entityType as string,\n        entityId as string,\n        days ? parseInt(days as string) : 30\n      );\n      res.json(timeline);\n    } catch (error) {\n      console.error(\"Sentiment timeline error:\", error);\n      res.status(500).json({ error: \"Failed to get sentiment timeline\" });\n    }\n  });\n\n  // Get word cloud data\n  app.get(\"/api/sentiment/wordcloud\", requireAuth, async (req, res) => {\n    try {\n      const { entityType, entityId, limit } = req.query;\n      const data = await getWordCloudData(\n        entityType as string | undefined,\n        entityId as string | undefined,\n        limit ? parseInt(limit as string) : 100\n      );\n      res.json(data);\n    } catch (error) {\n      console.error(\"Word cloud error:\", error);\n      res.status(500).json({ error: \"Failed to get word cloud data\" });\n    }\n  });\n\n  // Get sentiment overview for all entities\n  app.get(\"/api/sentiment/overview\", requireAuth, async (req, res) => {\n    try {\n      const overview = await getEntitiesSentimentOverview();\n      res.json(overview);\n    } catch (error) {\n      console.error(\"Sentiment overview error:\", error);\n      res.status(500).json({ error: \"Failed to get sentiment overview\" });\n    }\n  });\n\n  // Dashboard summary of top sentiment entities\n  app.get(\"/api/sentiment/summary\", requireAuth, async (req, res) => {\n    try {\n      const results = await storage.getSentimentResults({ limit: 10 });\n      const entities = results.map(r => ({\n        name: r.entityName || `${r.entityType} ${r.entityId}`,\n        sentiment: parseFloat(r.sentimentScore) || 0,\n        type: r.entityType,\n      }));\n      res.json({ entities });\n    } catch (error) {\n      console.error(\"Sentiment summary error:\", error);\n      res.json({ entities: [] });\n    }\n  });\n\n  // Dashboard count of unacknowledged crisis alerts\n  app.get(\"/api/sentiment/alerts/count\", requireAuth, async (req, res) => {\n    try {\n      const alerts = await db.select()\n        .from(sentimentCrisisAlerts)\n        .where(eq(sentimentCrisisAlerts.isAcknowledged, false));\n      res.json({ unacknowledged: alerts.length });\n    } catch (error) {\n      console.error(\"Alerts count error:\", error);\n      res.json({ unacknowledged: 0 });\n    }\n  });\n\n  // Get available sentiment data sources\n  app.get(\"/api/sentiment/sources\", requireAuth, async (req, res) => {\n    try {\n      const sources = await fetchSentimentSources();\n      res.json(sources);\n    } catch (error) {\n      console.error(\"Sentiment sources error:\", error);\n      res.status(500).json({ error: \"Failed to get sentiment sources\" });\n    }\n  });\n\n  // Get historical sentiment results\n  app.get(\"/api/sentiment/results\", requireAuth, async (req, res) => {\n    try {\n      const { entityType, entityId, startDate, endDate, limit } = req.query;\n      const results = await storage.getSentimentResults({\n        entityType: entityType as string | undefined,\n        entityId: entityId as string | undefined,\n        startDate: startDate ? new Date(startDate as string) : undefined,\n        endDate: endDate ? new Date(endDate as string) : undefined,\n        limit: limit ? parseInt(limit as string) : 50,\n      });\n      res.json(results);\n    } catch (error) {\n      console.error(\"Sentiment results error:\", error);\n      res.status(500).json({ error: \"Failed to get sentiment results\" });\n    }\n  });\n\n  // ===== External Data Integration Routes =====\n\n  // Fetch external data (news, social trends)\n  app.get(\"/api/external-data/fetch\", requireAuth, async (req, res) => {\n    try {\n      const { keywords, maxArticles } = req.query;\n      const config: any = {};\n      \n      if (keywords) {\n        config.keywords = (keywords as string).split(\",\");\n      }\n      if (maxArticles) {\n        config.maxArticlesPerSource = parseInt(maxArticles as string);\n      }\n\n      const data = await fetchExternalData(config);\n      res.json(data);\n    } catch (error) {\n      console.error(\"External data fetch error:\", error);\n      res.status(500).json({ error: \"Failed to fetch external data\" });\n    }\n  });\n\n  // Fetch and analyze external data with persistence\n  app.post(\"/api/external-data/analyze\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { keywords, enableGoogleNews, enableTwitterTrends, maxArticlesPerSource } = req.body;\n      \n      const config: any = {};\n      if (keywords) config.keywords = keywords;\n      if (enableGoogleNews !== undefined) config.enableGoogleNews = enableGoogleNews;\n      if (enableTwitterTrends !== undefined) config.enableTwitterTrends = enableTwitterTrends;\n      if (maxArticlesPerSource) config.maxArticlesPerSource = maxArticlesPerSource;\n\n      const result = await fetchAndAnalyzeExternalData(config);\n      res.json(result);\n    } catch (error) {\n      console.error(\"External data analysis error:\", error);\n      res.status(500).json({ error: \"Failed to analyze external data\" });\n    }\n  });\n\n  // Get external data summary for reports\n  app.get(\"/api/external-data/summary\", requireAuth, async (req, res) => {\n    try {\n      const summary = await getExternalDataSummaryForReport();\n      res.json(summary);\n    } catch (error) {\n      console.error(\"External data summary error:\", error);\n      res.status(500).json({ error: \"Failed to get external data summary\" });\n    }\n  });\n\n  // Configure external data sources\n  app.get(\"/api/external-data/config\", requireAuth, async (req, res) => {\n    try {\n      const hasNewsApiKey = !!process.env.NEWS_API_KEY;\n      \n      res.json({\n        newsApiConfigured: hasNewsApiKey,\n        googleNewsEnabled: true,\n        twitterTrendsEnabled: true,\n        defaultKeywords: [\n          \"eleições brasil\",\n          \"política brasileira\", \n          \"candidatos eleições\",\n          \"PT partido\",\n          \"PL partido\",\n          \"MDB eleições\",\n          \"TSE eleições\",\n        ],\n        supportedCountries: [\"BR\", \"ES\", \"UK\", \"US\"],\n        supportedLanguages: [\"pt\", \"es\", \"en\"],\n      });\n    } catch (error) {\n      console.error(\"External data config error:\", error);\n      res.status(500).json({ error: \"Failed to get external data config\" });\n    }\n  });\n\n  // Comparison endpoint - compare data across years\n  app.get(\"/api/analytics/compare\", requireAuth, async (req, res) => {\n    try {\n      const { years, uf, position, party } = req.query;\n      const yearList = years ? (years as string).split(\",\").map(y => parseInt(y)) : [];\n      \n      if (yearList.length < 2) {\n        return res.status(400).json({ error: \"At least 2 years required for comparison\" });\n      }\n\n      const comparisonData = await Promise.all(yearList.map(async (year) => {\n        const partyVotes = await storage.getVotesByParty({\n          year,\n          uf: uf as string | undefined,\n          limit: 20,\n        });\n\n        const summary = await storage.getAnalyticsSummary({ year, uf: uf as string | undefined });\n\n        return {\n          year,\n          totalVotes: summary.totalVotes,\n          totalCandidates: summary.totalCandidates,\n          totalParties: summary.totalParties,\n          partyVotes: partyVotes.slice(0, 10),\n        };\n      }));\n\n      res.json({ years: yearList, data: comparisonData });\n    } catch (error) {\n      console.error(\"Comparison error:\", error);\n      res.status(500).json({ error: \"Failed to compare data\" });\n    }\n  });\n\n  app.get(\"/api/analytics/export/csv\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf, electionType, reportType } = req.query;\n      const filters = {\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n        electionType: electionType as string | undefined,\n      };\n\n      let data: any[];\n      let filename: string;\n\n      switch (reportType) {\n        case \"parties\":\n          data = await storage.getVotesByParty({ ...filters, limit: 10000 });\n          filename = \"votos_por_partido.csv\";\n          break;\n        case \"candidates\":\n          data = await storage.getTopCandidates({ ...filters, limit: 10000 });\n          filename = \"candidatos_mais_votados.csv\";\n          break;\n        case \"states\":\n          data = await storage.getVotesByState(filters);\n          filename = \"votos_por_estado.csv\";\n          break;\n        case \"municipalities\":\n          data = await storage.getVotesByMunicipality({ ...filters, limit: 10000 });\n          filename = \"votos_por_municipio.csv\";\n          break;\n        default:\n          return res.status(400).json({ error: \"Invalid report type\" });\n      }\n\n      if (data.length === 0) {\n        return res.status(404).json({ error: \"No data found for the specified filters\" });\n      }\n\n      const headers = Object.keys(data[0]);\n      const csvRows = [headers.join(\",\")];\n      for (const row of data) {\n        const values = headers.map((h) => {\n          const val = row[h];\n          if (val === null || val === undefined) return \"\";\n          const str = String(val);\n          return str.includes(\",\") || str.includes('\"') || str.includes(\"\\n\")\n            ? `\"${str.replace(/\"/g, '\"\"')}\"`\n            : str;\n        });\n        csvRows.push(values.join(\",\"));\n      }\n\n      await logAudit(req, \"export\", \"analytics_csv\", reportType as string, { filters, rowCount: data.length });\n\n      res.setHeader(\"Content-Type\", \"text/csv; charset=utf-8\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n      res.send(\"\\uFEFF\" + csvRows.join(\"\\n\"));\n    } catch (error) {\n      console.error(\"Analytics CSV export error:\", error);\n      res.status(500).json({ error: \"Failed to export data\" });\n    }\n  });\n\n  // Advanced filter endpoints\n  app.get(\"/api/analytics/positions\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf } = req.query;\n      const positions = await storage.getAvailablePositions({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n      });\n      res.json(positions);\n    } catch (error) {\n      console.error(\"Positions error:\", error);\n      res.status(500).json({ error: \"Failed to fetch positions\" });\n    }\n  });\n\n  app.get(\"/api/analytics/parties-list\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf } = req.query;\n      const parties = await storage.getAvailableParties({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n      });\n      res.json(parties);\n    } catch (error) {\n      console.error(\"Parties list error:\", error);\n      res.status(500).json({ error: \"Failed to fetch parties\" });\n    }\n  });\n\n  app.get(\"/api/analytics/advanced\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf, electionType, position, party, minVotes, maxVotes, limit } = req.query;\n      const result = await storage.getAdvancedAnalytics({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n        electionType: electionType as string | undefined,\n        position: position as string | undefined,\n        party: party as string | undefined,\n        minVotes: minVotes ? parseInt(minVotes as string) : undefined,\n        maxVotes: maxVotes ? parseInt(maxVotes as string) : undefined,\n        limit: limit ? parseInt(limit as string) : 100,\n      });\n      res.json(result);\n    } catch (error) {\n      console.error(\"Advanced analytics error:\", error);\n      res.status(500).json({ error: \"Failed to fetch advanced analytics\" });\n    }\n  });\n\n  app.post(\"/api/analytics/compare\", requireAuth, async (req, res) => {\n    try {\n      const { years, states, groupBy } = req.body;\n      if (!groupBy || ![\"party\", \"state\", \"position\"].includes(groupBy)) {\n        return res.status(400).json({ error: \"Invalid groupBy parameter\" });\n      }\n      const result = await storage.getComparisonData({\n        years: years?.map((y: string | number) => typeof y === \"string\" ? parseInt(y) : y),\n        states,\n        groupBy,\n      });\n      await logAudit(req, \"compare\", \"analytics\", undefined, { years, states, groupBy });\n      res.json(result);\n    } catch (error) {\n      console.error(\"Comparison error:\", error);\n      res.status(500).json({ error: \"Failed to get comparison data\" });\n    }\n  });\n\n  // ==================== DRILL-DOWN ANALYTICS ROUTES ====================\n\n  app.get(\"/api/analytics/drill-down/candidates-by-party\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf, party, position, limit } = req.query;\n      if (!party) {\n        return res.status(400).json({ error: \"Party parameter is required\" });\n      }\n      const candidates = await storage.getCandidatesByParty({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n        party: party as string,\n        position: position as string | undefined,\n        limit: limit ? parseInt(limit as string) : 100,\n      });\n      res.json(candidates);\n    } catch (error) {\n      console.error(\"Candidates by party error:\", error);\n      res.status(500).json({ error: \"Failed to fetch candidates by party\" });\n    }\n  });\n\n  app.get(\"/api/analytics/drill-down/party-by-state\", requireAuth, async (req, res) => {\n    try {\n      const { year, party, position } = req.query;\n      const data = await storage.getPartyPerformanceByState({\n        year: year ? parseInt(year as string) : undefined,\n        party: party as string | undefined,\n        position: position as string | undefined,\n      });\n      res.json(data);\n    } catch (error) {\n      console.error(\"Party by state error:\", error);\n      res.status(500).json({ error: \"Failed to fetch party performance by state\" });\n    }\n  });\n\n  app.get(\"/api/analytics/drill-down/votes-by-position\", requireAuth, async (req, res) => {\n    try {\n      const { year, uf } = req.query;\n      const data = await storage.getVotesByPosition({\n        year: year ? parseInt(year as string) : undefined,\n        uf: uf as string | undefined,\n      });\n      res.json(data);\n    } catch (error) {\n      console.error(\"Votes by position error:\", error);\n      res.status(500).json({ error: \"Failed to fetch votes by position\" });\n    }\n  });\n\n  // Saved Reports CRUD\n  app.get(\"/api/reports\", requireAuth, async (req, res) => {\n    try {\n      const reports = await storage.getSavedReports(req.user?.id);\n      res.json(reports);\n    } catch (error) {\n      console.error(\"Get reports error:\", error);\n      res.status(500).json({ error: \"Failed to fetch reports\" });\n    }\n  });\n\n  app.get(\"/api/reports/:id\", requireAuth, async (req, res) => {\n    try {\n      const report = await storage.getSavedReportById(parseInt(req.params.id));\n      if (!report) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      res.json(report);\n    } catch (error) {\n      console.error(\"Get report error:\", error);\n      res.status(500).json({ error: \"Failed to fetch report\" });\n    }\n  });\n\n  app.post(\"/api/reports\", requireAuth, async (req, res) => {\n    try {\n      const { name, description, filters, columns, chartType, sortBy, sortOrder } = req.body;\n      if (!name || !filters || !columns) {\n        return res.status(400).json({ error: \"Name, filters and columns are required\" });\n      }\n      const report = await storage.createSavedReport({\n        name,\n        description,\n        filters,\n        columns,\n        chartType: chartType || \"bar\",\n        sortBy,\n        sortOrder: sortOrder || \"desc\",\n        createdBy: req.user?.id,\n      });\n      await logAudit(req, \"create\", \"saved_report\", String(report.id), { name });\n      res.status(201).json(report);\n    } catch (error) {\n      console.error(\"Create report error:\", error);\n      res.status(500).json({ error: \"Failed to create report\" });\n    }\n  });\n\n  app.put(\"/api/reports/:id\", requireAuth, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const existing = await storage.getSavedReportById(id);\n      if (!existing) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      const { name, description, filters, columns, chartType, sortBy, sortOrder } = req.body;\n      const report = await storage.updateSavedReport(id, {\n        name,\n        description,\n        filters,\n        columns,\n        chartType,\n        sortBy,\n        sortOrder,\n      });\n      await logAudit(req, \"update\", \"saved_report\", String(id), { name });\n      res.json(report);\n    } catch (error) {\n      console.error(\"Update report error:\", error);\n      res.status(500).json({ error: \"Failed to update report\" });\n    }\n  });\n\n  app.delete(\"/api/reports/:id\", requireAuth, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const existing = await storage.getSavedReportById(id);\n      if (!existing) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      await storage.deleteSavedReport(id);\n      await logAudit(req, \"delete\", \"saved_report\", String(id), { name: existing.name });\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Delete report error:\", error);\n      res.status(500).json({ error: \"Failed to delete report\" });\n    }\n  });\n\n  // ==================== SEMANTIC SEARCH ROUTES ====================\n\n  app.post(\"/api/semantic-search\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { query, filters = {}, topK = 10 } = req.body;\n      \n      if (!query || typeof query !== \"string\" || query.trim().length < 3) {\n        return res.status(400).json({ error: \"Query must be at least 3 characters\" });\n      }\n      \n      const result = await processSemanticSearch(\n        query.trim(),\n        {\n          year: filters.year ? parseInt(filters.year) : undefined,\n          state: filters.state || undefined,\n          party: filters.party || undefined,\n          position: filters.position || undefined,\n        },\n        req.user?.id\n      );\n      \n      await logAudit(req, \"semantic_search\", \"semantic_search\", undefined, {\n        query: query.slice(0, 100),\n        filters,\n        resultCount: result.totalResults,\n      });\n      \n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Semantic search error:\", error);\n      if (error.message?.includes(\"OPENAI_API_KEY\")) {\n        return res.status(503).json({ \n          error: \"Semantic search requires an OpenAI API key. Please configure OPENAI_API_KEY in secrets.\" \n        });\n      }\n      res.status(500).json({ error: \"Failed to perform semantic search\" });\n    }\n  });\n\n  app.get(\"/api/semantic-search/stats\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const stats = await getEmbeddingStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Get embedding stats error:\", error);\n      res.status(500).json({ error: \"Failed to get embedding stats\" });\n    }\n  });\n\n  app.get(\"/api/semantic-search/history\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 10;\n      const queries = await getRecentQueries(limit);\n      res.json(queries);\n    } catch (error) {\n      console.error(\"Get search history error:\", error);\n      res.status(500).json({ error: \"Failed to get search history\" });\n    }\n  });\n\n  app.post(\"/api/semantic-search/generate-embeddings/:importJobId\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const importJobId = parseInt(req.params.importJobId);\n      const job = await storage.getTseImportJob(importJobId);\n      \n      if (!job) {\n        return res.status(404).json({ error: \"Import job not found\" });\n      }\n      \n      if (job.status !== \"completed\") {\n        return res.status(400).json({ error: \"Can only generate embeddings for completed import jobs\" });\n      }\n      \n      res.json({ message: \"Embedding generation started\", jobId: importJobId });\n      \n      generateEmbeddingsForImportJob(importJobId)\n        .then(result => {\n          console.log(`Embeddings generated for job ${importJobId}:`, result);\n        })\n        .catch(error => {\n          console.error(`Error generating embeddings for job ${importJobId}:`, error);\n        });\n      \n    } catch (error) {\n      console.error(\"Generate embeddings error:\", error);\n      res.status(500).json({ error: \"Failed to start embedding generation\" });\n    }\n  });\n\n  app.get(\"/api/semantic-search/check-api-key\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const hasKey = !!process.env.OPENAI_API_KEY;\n      res.json({ configured: hasKey });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to check API key\" });\n    }\n  });\n\n  // Database reset endpoint - requires admin and confirmation phrase\n  app.post(\"/api/admin/reset-database\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const { confirmationPhrase, preserveAdmin } = req.body;\n      const EXPECTED_PHRASE = \"CONFIRMO ZERAR BANCO DE DADOS\";\n\n      if (!confirmationPhrase || confirmationPhrase !== EXPECTED_PHRASE) {\n        return res.status(400).json({ \n          error: \"Frase de confirmação incorreta\",\n          expectedPhrase: EXPECTED_PHRASE,\n          message: \"Para confirmar a operação, digite exatamente a frase de confirmação.\"\n        });\n      }\n\n      // Get current admin user to preserve if requested\n      const currentAdminId = req.user?.id;\n      const currentUsername = req.user?.username;\n\n      // Delete in correct order (respecting foreign key constraints)\n      // Clear audit logs first so new entries won't be deleted\n      await db.delete(auditLogs);\n      \n      // Log the operation start (after clearing old logs)\n      await logAudit(req, \"reset_database_started\", \"system\", \"all\", { \n        preserveAdmin,\n        initiatedBy: currentUsername\n      });\n\n      // Delete dependent tables in correct order\n      await db.delete(forecastSwingRegions);\n      await db.delete(forecastResults);\n      await db.delete(forecastRuns);\n      await db.delete(importValidationIssues);\n      await db.delete(importValidationRuns);\n      await db.delete(aiSentimentData);\n      await db.delete(aiPredictions);\n      await db.delete(semanticSearchQueries);\n      await db.delete(semanticDocuments);\n      await db.delete(savedReports);\n      await db.delete(projectionReports);\n      await db.delete(tseImportErrors);\n      await db.delete(tseCandidateVotes);\n      await db.delete(tseImportJobs);\n      await db.delete(allianceParties);\n      await db.delete(alliances);\n      await db.delete(simulations);\n      await db.delete(scenarioCandidates);\n      await db.delete(scenarioVotes);\n      await db.delete(scenarios);\n      await db.delete(candidates);\n      await db.delete(parties);\n\n      // Delete IBGE data tables\n      await db.delete(ibgeImportJobs);\n      await db.delete(ibgePopulacao);\n      await db.delete(ibgeIndicadores);\n      await db.delete(ibgeMunicipios);\n\n      // Delete users except the current admin if preserveAdmin is true\n      if (preserveAdmin && currentAdminId) {\n        await db.delete(users).where(sql`${users.id} != ${currentAdminId}`);\n      } else {\n        await db.delete(users);\n      }\n\n      // Always create a completion audit log entry\n      await logAudit(req, \"reset_database_completed\", \"system\", \"all\", { \n        preserveAdmin,\n        adminPreserved: preserveAdmin && !!currentAdminId,\n        tablesCleared: 26,\n        completedAt: new Date().toISOString()\n      });\n\n      res.json({ \n        success: true, \n        message: \"Banco de dados zerado com sucesso\",\n        details: {\n          tablesCleared: 26,\n          adminPreserved: preserveAdmin && !!currentAdminId,\n          completedAt: new Date().toISOString()\n        }\n      });\n    } catch (error: any) {\n      console.error(\"Database reset error:\", error);\n      res.status(500).json({ \n        error: \"Falha ao zerar banco de dados\",\n        details: error.message\n      });\n    }\n  });\n\n  // Get database statistics for admin panel\n  app.get(\"/api/admin/database-stats\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const stats = await Promise.all([\n        db.select({ count: sql<number>`count(*)` }).from(users),\n        db.select({ count: sql<number>`count(*)` }).from(parties),\n        db.select({ count: sql<number>`count(*)` }).from(candidates),\n        db.select({ count: sql<number>`count(*)` }).from(scenarios),\n        db.select({ count: sql<number>`count(*)` }).from(simulations),\n        db.select({ count: sql<number>`count(*)` }).from(tseImportJobs),\n        db.select({ count: sql<number>`count(*)` }).from(tseCandidateVotes),\n        db.select({ count: sql<number>`count(*)` }).from(forecastRuns),\n        db.select({ count: sql<number>`count(*)` }).from(auditLogs),\n      ]);\n\n      res.json({\n        users: Number(stats[0][0]?.count || 0),\n        parties: Number(stats[1][0]?.count || 0),\n        candidates: Number(stats[2][0]?.count || 0),\n        scenarios: Number(stats[3][0]?.count || 0),\n        simulations: Number(stats[4][0]?.count || 0),\n        importJobs: Number(stats[5][0]?.count || 0),\n        candidateVotes: Number(stats[6][0]?.count || 0),\n        forecasts: Number(stats[7][0]?.count || 0),\n        auditLogs: Number(stats[8][0]?.count || 0),\n      });\n    } catch (error) {\n      console.error(\"Database stats error:\", error);\n      res.status(500).json({ error: \"Failed to get database stats\" });\n    }\n  });\n\n  // ========== REPORT TEMPLATES ==========\n  app.get(\"/api/report-templates\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const templates = await storage.getReportTemplates();\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Get report templates error:\", error);\n      res.status(500).json({ error: \"Failed to fetch report templates\" });\n    }\n  });\n\n  app.get(\"/api/report-templates/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const template = await storage.getReportTemplate(parseInt(req.params.id));\n      if (!template) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      console.error(\"Get report template error:\", error);\n      res.status(500).json({ error: \"Failed to fetch report template\" });\n    }\n  });\n\n  app.post(\"/api/report-templates\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const template = await storage.createReportTemplate({\n        ...req.body,\n        createdBy: req.user!.id,\n      });\n      await logAudit(req, \"create\", \"report_template\", String(template.id), { name: template.name });\n      res.json(template);\n    } catch (error) {\n      console.error(\"Create report template error:\", error);\n      res.status(500).json({ error: \"Failed to create report template\" });\n    }\n  });\n\n  app.patch(\"/api/report-templates/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const updated = await storage.updateReportTemplate(parseInt(req.params.id), req.body);\n      if (!updated) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      await logAudit(req, \"update\", \"report_template\", req.params.id);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Update report template error:\", error);\n      res.status(500).json({ error: \"Failed to update report template\" });\n    }\n  });\n\n  app.delete(\"/api/report-templates/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      await storage.deleteReportTemplate(parseInt(req.params.id));\n      await logAudit(req, \"delete\", \"report_template\", req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Delete report template error:\", error);\n      res.status(500).json({ error: \"Failed to delete report template\" });\n    }\n  });\n\n  // ========== REPORT SCHEDULES ==========\n  app.get(\"/api/report-schedules\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schedules = await storage.getReportSchedules();\n      res.json(schedules);\n    } catch (error) {\n      console.error(\"Get report schedules error:\", error);\n      res.status(500).json({ error: \"Failed to fetch report schedules\" });\n    }\n  });\n\n  app.get(\"/api/report-schedules/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schedule = await storage.getReportSchedule(parseInt(req.params.id));\n      if (!schedule) {\n        return res.status(404).json({ error: \"Schedule not found\" });\n      }\n      res.json(schedule);\n    } catch (error) {\n      console.error(\"Get report schedule error:\", error);\n      res.status(500).json({ error: \"Failed to fetch report schedule\" });\n    }\n  });\n\n  app.post(\"/api/report-schedules\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      // Calculate next run time\n      const nextRunAt = calculateNextRun(req.body.frequency, req.body.dayOfWeek, req.body.dayOfMonth, req.body.timeOfDay, req.body.timezone);\n      \n      const schedule = await storage.createReportSchedule({\n        ...req.body,\n        nextRunAt,\n        createdBy: req.user!.id,\n      });\n      await logAudit(req, \"create\", \"report_schedule\", String(schedule.id), { name: schedule.name, frequency: schedule.frequency });\n      res.json(schedule);\n    } catch (error) {\n      console.error(\"Create report schedule error:\", error);\n      res.status(500).json({ error: \"Failed to create report schedule\" });\n    }\n  });\n\n  app.patch(\"/api/report-schedules/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const updateData = { ...req.body };\n      \n      // Recalculate next run if scheduling parameters changed\n      if (req.body.frequency || req.body.dayOfWeek !== undefined || req.body.dayOfMonth !== undefined || req.body.timeOfDay) {\n        const existing = await storage.getReportSchedule(parseInt(req.params.id));\n        if (existing) {\n          updateData.nextRunAt = calculateNextRun(\n            req.body.frequency || existing.frequency,\n            req.body.dayOfWeek ?? existing.dayOfWeek,\n            req.body.dayOfMonth ?? existing.dayOfMonth,\n            req.body.timeOfDay || existing.timeOfDay,\n            req.body.timezone || existing.timezone\n          );\n        }\n      }\n      \n      const updated = await storage.updateReportSchedule(parseInt(req.params.id), updateData);\n      if (!updated) {\n        return res.status(404).json({ error: \"Schedule not found\" });\n      }\n      await logAudit(req, \"update\", \"report_schedule\", req.params.id);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Update report schedule error:\", error);\n      res.status(500).json({ error: \"Failed to update report schedule\" });\n    }\n  });\n\n  app.delete(\"/api/report-schedules/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      await storage.deleteReportSchedule(parseInt(req.params.id));\n      await logAudit(req, \"delete\", \"report_schedule\", req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Delete report schedule error:\", error);\n      res.status(500).json({ error: \"Failed to delete report schedule\" });\n    }\n  });\n\n  // ========== REPORT RUNS ==========\n  app.get(\"/api/report-runs\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const filters = {\n        scheduleId: req.query.scheduleId ? parseInt(req.query.scheduleId as string) : undefined,\n        templateId: req.query.templateId ? parseInt(req.query.templateId as string) : undefined,\n        status: req.query.status as string | undefined,\n        limit: req.query.limit ? parseInt(req.query.limit as string) : 50,\n      };\n      const runs = await storage.getReportRuns(filters);\n      res.json(runs);\n    } catch (error) {\n      console.error(\"Get report runs error:\", error);\n      res.status(500).json({ error: \"Failed to fetch report runs\" });\n    }\n  });\n\n  app.post(\"/api/report-runs/trigger/:templateId\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const templateId = parseInt(req.params.templateId);\n      const template = await storage.getReportTemplate(templateId);\n      \n      if (!template) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n\n      // Create a new run\n      const run = await storage.createReportRun({\n        templateId,\n        triggeredBy: \"manual\",\n        status: \"pending\",\n        createdBy: req.user!.id,\n      });\n\n      // Execute report generation asynchronously\n      executeReportRun(run.id, template, req.body.recipients || [])\n        .then(() => console.log(`Report run ${run.id} completed`))\n        .catch(err => console.error(`Report run ${run.id} failed:`, err));\n\n      await logAudit(req, \"trigger\", \"report_run\", String(run.id), { templateId, templateName: template.name });\n      res.json({ success: true, runId: run.id, message: \"Report generation started\" });\n    } catch (error) {\n      console.error(\"Trigger report run error:\", error);\n      res.status(500).json({ error: \"Failed to trigger report run\" });\n    }\n  });\n\n  // ========== REPORT RECIPIENTS ==========\n  app.get(\"/api/report-recipients\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const recipients = await storage.getReportRecipients();\n      res.json(recipients);\n    } catch (error) {\n      console.error(\"Get report recipients error:\", error);\n      res.status(500).json({ error: \"Failed to fetch report recipients\" });\n    }\n  });\n\n  app.post(\"/api/report-recipients\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const recipient = await storage.createReportRecipient({\n        ...req.body,\n        createdBy: req.user!.id,\n      });\n      await logAudit(req, \"create\", \"report_recipient\", String(recipient.id), { email: recipient.email });\n      res.json(recipient);\n    } catch (error) {\n      console.error(\"Create report recipient error:\", error);\n      res.status(500).json({ error: \"Failed to create report recipient\" });\n    }\n  });\n\n  app.patch(\"/api/report-recipients/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const updated = await storage.updateReportRecipient(parseInt(req.params.id), req.body);\n      if (!updated) {\n        return res.status(404).json({ error: \"Recipient not found\" });\n      }\n      await logAudit(req, \"update\", \"report_recipient\", req.params.id);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Update report recipient error:\", error);\n      res.status(500).json({ error: \"Failed to update report recipient\" });\n    }\n  });\n\n  app.delete(\"/api/report-recipients/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      await storage.deleteReportRecipient(parseInt(req.params.id));\n      await logAudit(req, \"delete\", \"report_recipient\", req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Delete report recipient error:\", error);\n      res.status(500).json({ error: \"Failed to delete report recipient\" });\n    }\n  });\n\n  // Email configuration status\n  app.get(\"/api/email/status\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const hasResendKey = !!process.env.RESEND_API_KEY;\n      res.json({\n        configured: hasResendKey,\n        provider: hasResendKey ? \"resend\" : null,\n        message: hasResendKey ? \"Email está configurado\" : \"Configure RESEND_API_KEY nos secrets para habilitar envio de email\"\n      });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to check email status\" });\n    }\n  });\n\n  // Electoral data by state endpoint for interactive map - uses real TSE data\n  app.get(\"/api/electoral-data/state/:stateCode\", requireAuth, async (req, res) => {\n    try {\n      const stateCode = req.params.stateCode?.toUpperCase();\n      if (!stateCode || stateCode.length !== 2) {\n        return res.status(400).json({ error: \"Invalid state code\" });\n      }\n\n      // Fetch real data from TSE imports filtered by state\n      const topCandidates = await storage.getTopCandidates({\n        uf: stateCode,\n        limit: 10,\n      });\n\n      const votesByParty = await storage.getVotesByParty({\n        uf: stateCode,\n        limit: 10,\n      });\n\n      // Get parties for color mapping\n      const parties = await storage.getParties();\n      const partyAbbrMap = new Map(parties.map(p => [p.abbreviation, p]));\n\n      const topParties = votesByParty.map(pv => ({\n        name: partyAbbrMap.get(pv.party)?.name || pv.party,\n        abbreviation: pv.party,\n        votes: pv.votes,\n        color: partyAbbrMap.get(pv.party)?.color || null,\n      }));\n\n      const candidatesWithVotes = topCandidates.map(c => ({\n        name: c.name,\n        party: c.party || \"N/A\",\n        votes: c.votes,\n      }));\n\n      const totalVotes = votesByParty.reduce((sum, pv) => sum + pv.votes, 0);\n      const totalCandidates = topCandidates.length;\n\n      // Map of state codes to names\n      const stateNames: Record<string, string> = {\n        AC: \"Acre\", AL: \"Alagoas\", AP: \"Amapá\", AM: \"Amazonas\",\n        BA: \"Bahia\", CE: \"Ceará\", DF: \"Distrito Federal\", ES: \"Espírito Santo\",\n        GO: \"Goiás\", MA: \"Maranhão\", MT: \"Mato Grosso\", MS: \"Mato Grosso do Sul\",\n        MG: \"Minas Gerais\", PA: \"Pará\", PB: \"Paraíba\", PR: \"Paraná\",\n        PE: \"Pernambuco\", PI: \"Piauí\", RJ: \"Rio de Janeiro\", RN: \"Rio Grande do Norte\",\n        RS: \"Rio Grande do Sul\", RO: \"Rondônia\", RR: \"Roraima\", SC: \"Santa Catarina\",\n        SP: \"São Paulo\", SE: \"Sergipe\", TO: \"Tocantins\", ZZ: \"Exterior\"\n      };\n\n      res.json({\n        code: stateCode,\n        name: stateNames[stateCode] || stateCode,\n        topCandidates: candidatesWithVotes.slice(0, 5),\n        topParties,\n        totalVotes,\n        totalCandidates,\n      });\n    } catch (error) {\n      console.error(\"Failed to fetch state electoral data:\", error);\n      res.status(500).json({ error: \"Failed to fetch state electoral data\" });\n    }\n  });\n\n  // ============================================\n  // SENTIMENT MONITORING & CRISIS ALERT ROUTES\n  // ============================================\n\n  // Create a new sentiment monitoring session\n  app.post(\"/api/sentiment/monitoring-sessions\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schema = z.object({\n        name: z.string().min(1),\n        description: z.string().optional(),\n        entities: z.array(z.object({\n          type: z.enum([\"party\", \"candidate\"]),\n          id: z.string(),\n          name: z.string()\n        })).min(1),\n        sourceFilters: z.object({\n          types: z.array(z.string()).optional(),\n          countries: z.array(z.string()).optional()\n        }).optional(),\n        dateRange: z.object({\n          start: z.string(),\n          end: z.string()\n        }).optional(),\n        alertThreshold: z.number().min(-1).max(0).optional()\n      });\n      \n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Dados inválidos\", details: parsed.error.issues });\n      }\n      \n      const userId = (req.user as any).id;\n      const session = await db.insert(sentimentMonitoringSessions).values({\n        userId,\n        name: parsed.data.name,\n        description: parsed.data.description,\n        entities: parsed.data.entities,\n        sourceFilters: parsed.data.sourceFilters || {},\n        dateRange: parsed.data.dateRange,\n        alertThreshold: parsed.data.alertThreshold?.toString() || \"-0.3\",\n        isActive: true,\n      }).returning();\n      \n      await logAudit(req, \"create_monitoring_session\", \"sentiment_monitoring\", session[0].id.toString(), \n        { name: parsed.data.name, entityCount: parsed.data.entities.length });\n      \n      res.json(session[0]);\n    } catch (error) {\n      console.error(\"Error creating monitoring session:\", error);\n      res.status(500).json({ error: \"Erro ao criar sessão de monitoramento\" });\n    }\n  });\n\n  // List user's monitoring sessions\n  app.get(\"/api/sentiment/monitoring-sessions\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const sessions = await db.select()\n        .from(sentimentMonitoringSessions)\n        .where(eq(sentimentMonitoringSessions.userId, userId))\n        .orderBy(desc(sentimentMonitoringSessions.createdAt));\n      \n      res.json(sessions);\n    } catch (error) {\n      console.error(\"Error fetching monitoring sessions:\", error);\n      res.status(500).json({ error: \"Erro ao buscar sessões de monitoramento\" });\n    }\n  });\n\n  // Get single monitoring session with snapshots\n  app.get(\"/api/sentiment/monitoring-sessions/:id\", requireAuth, async (req, res) => {\n    try {\n      const sessionId = parseInt(req.params.id);\n      const session = await db.select()\n        .from(sentimentMonitoringSessions)\n        .where(eq(sentimentMonitoringSessions.id, sessionId))\n        .limit(1);\n      \n      if (session.length === 0) {\n        return res.status(404).json({ error: \"Sessão não encontrada\" });\n      }\n      \n      const snapshots = await db.select()\n        .from(sentimentComparisonSnapshots)\n        .where(eq(sentimentComparisonSnapshots.sessionId, sessionId))\n        .orderBy(desc(sentimentComparisonSnapshots.snapshotDate))\n        .limit(30);\n      \n      res.json({ ...session[0], snapshots });\n    } catch (error) {\n      console.error(\"Error fetching monitoring session:\", error);\n      res.status(500).json({ error: \"Erro ao buscar sessão\" });\n    }\n  });\n\n  // Update monitoring session\n  app.patch(\"/api/sentiment/monitoring-sessions/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const sessionId = parseInt(req.params.id);\n      const schema = z.object({\n        name: z.string().optional(),\n        entities: z.array(z.object({\n          type: z.enum([\"party\", \"candidate\"]),\n          id: z.string(),\n          name: z.string()\n        })).optional(),\n        sourceFilters: z.object({\n          types: z.array(z.string()).optional(),\n          countries: z.array(z.string()).optional()\n        }).optional(),\n        isActive: z.boolean().optional(),\n        alertThreshold: z.number().optional()\n      });\n      \n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Dados inválidos\" });\n      }\n      \n      const updateData: Record<string, any> = { updatedAt: new Date() };\n      if (parsed.data.name) updateData.name = parsed.data.name;\n      if (parsed.data.entities) updateData.entities = parsed.data.entities;\n      if (parsed.data.sourceFilters) updateData.sourceFilters = parsed.data.sourceFilters;\n      if (parsed.data.isActive !== undefined) updateData.isActive = parsed.data.isActive;\n      if (parsed.data.alertThreshold !== undefined) updateData.alertThreshold = parsed.data.alertThreshold.toString();\n      \n      const updated = await db.update(sentimentMonitoringSessions)\n        .set(updateData)\n        .where(eq(sentimentMonitoringSessions.id, sessionId))\n        .returning();\n      \n      res.json(updated[0]);\n    } catch (error) {\n      console.error(\"Error updating monitoring session:\", error);\n      res.status(500).json({ error: \"Erro ao atualizar sessão\" });\n    }\n  });\n\n  // Delete monitoring session\n  app.delete(\"/api/sentiment/monitoring-sessions/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const sessionId = parseInt(req.params.id);\n      \n      await db.delete(sentimentComparisonSnapshots)\n        .where(eq(sentimentComparisonSnapshots.sessionId, sessionId));\n      \n      await db.delete(sentimentMonitoringSessions)\n        .where(eq(sentimentMonitoringSessions.id, sessionId));\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting monitoring session:\", error);\n      res.status(500).json({ error: \"Erro ao excluir sessão\" });\n    }\n  });\n\n  // Run multi-entity comparison analysis\n  app.post(\"/api/sentiment/compare\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schema = z.object({\n        entities: z.array(z.object({\n          type: z.enum([\"party\", \"candidate\"]),\n          id: z.string(),\n          name: z.string()\n        })).min(2).max(10),\n        sourceTypes: z.array(z.enum([\"news\", \"social\", \"blog\", \"forum\"])).optional(),\n        dateRange: z.object({\n          start: z.string(),\n          end: z.string()\n        }).optional(),\n        sessionId: z.number().optional()\n      });\n      \n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Dados inválidos\", details: parsed.error.issues });\n      }\n      \n      const { entities, sourceTypes, dateRange, sessionId } = parsed.data;\n      \n      const entityResults = [];\n      \n      for (const entity of entities) {\n        const results = await db.select()\n          .from(sentimentAnalysisResults)\n          .where(\n            and(\n              eq(sentimentAnalysisResults.entityType, entity.type),\n              eq(sentimentAnalysisResults.entityId, entity.id)\n            )\n          )\n          .orderBy(desc(sentimentAnalysisResults.analysisDate))\n          .limit(30);\n        \n        const latestResult = results[0];\n        const avgSentiment = results.length > 0 \n          ? results.reduce((sum, r) => sum + parseFloat(r.sentimentScore), 0) / results.length \n          : 0;\n        \n        const totalMentions = results.reduce((sum, r) => sum + (r.mentionCount || 0), 0);\n        \n        entityResults.push({\n          entityType: entity.type,\n          entityId: entity.id,\n          entityName: entity.name,\n          latestSentiment: latestResult ? parseFloat(latestResult.sentimentScore) : null,\n          avgSentiment,\n          sentimentLabel: latestResult?.sentimentLabel || \"neutral\",\n          totalMentions,\n          trend: results.length >= 2 \n            ? (parseFloat(results[0].sentimentScore) - parseFloat(results[results.length-1].sentimentScore)) > 0 \n              ? \"rising\" : \"falling\"\n            : \"stable\",\n          timeline: results.map(r => ({\n            date: r.analysisDate,\n            score: parseFloat(r.sentimentScore),\n            mentions: r.mentionCount\n          }))\n        });\n      }\n      \n      entityResults.sort((a, b) => (b.latestSentiment || 0) - (a.latestSentiment || 0));\n      \n      let comparisonAnalysis = \"\";\n      try {\n        const { analyzeElectoralSentiment } = await import(\"./ai-insights\");\n        const aiAnalysis = await analyzeElectoralSentiment({\n          party: entities.map(e => e.name).join(\", \"),\n          dateRange\n        });\n        comparisonAnalysis = (aiAnalysis as any).narrativeAnalysis || (aiAnalysis as any).overallSentiment || \"\";\n      } catch (e) {\n        console.log(\"AI analysis not available for comparison\");\n      }\n      \n      if (sessionId) {\n        await db.insert(sentimentComparisonSnapshots).values({\n          sessionId,\n          snapshotDate: new Date(),\n          entityResults,\n          comparisonAnalysis,\n          overallSentiment: (entityResults.reduce((sum, e) => sum + (e.avgSentiment || 0), 0) / entityResults.length).toString(),\n          sourceBreakdown: { types: sourceTypes || [\"all\"] }\n        });\n        \n        await db.update(sentimentMonitoringSessions)\n          .set({ lastAnalyzedAt: new Date() })\n          .where(eq(sentimentMonitoringSessions.id, sessionId));\n      }\n      \n      res.json({\n        entities: entityResults,\n        comparisonAnalysis,\n        analyzedAt: new Date().toISOString(),\n        filters: { sourceTypes, dateRange }\n      });\n    } catch (error) {\n      console.error(\"Error running comparison:\", error);\n      res.status(500).json({ error: \"Erro ao executar comparação\" });\n    }\n  });\n\n  // ============================================\n  // CRISIS ALERT ROUTES\n  // ============================================\n\n  // Get active crisis alerts\n  app.get(\"/api/sentiment/crisis-alerts\", requireAuth, async (req, res) => {\n    try {\n      const { severity, acknowledged, entityType, limit: queryLimit } = req.query;\n      \n      const conditions = [];\n      if (severity) conditions.push(eq(sentimentCrisisAlerts.severity, severity as string));\n      if (acknowledged === \"false\") conditions.push(eq(sentimentCrisisAlerts.isAcknowledged, false));\n      if (acknowledged === \"true\") conditions.push(eq(sentimentCrisisAlerts.isAcknowledged, true));\n      if (entityType) conditions.push(eq(sentimentCrisisAlerts.entityType, entityType as string));\n      \n      let query = db.select().from(sentimentCrisisAlerts);\n      \n      if (conditions.length > 0) {\n        query = query.where(and(...conditions)) as any;\n      }\n      \n      const alerts = await query\n        .orderBy(desc(sentimentCrisisAlerts.detectedAt))\n        .limit(parseInt(queryLimit as string) || 50);\n      \n      res.json(alerts);\n    } catch (error) {\n      console.error(\"Error fetching crisis alerts:\", error);\n      res.status(500).json({ error: \"Erro ao buscar alertas\" });\n    }\n  });\n\n  // Acknowledge crisis alert\n  app.patch(\"/api/sentiment/crisis-alerts/:id/acknowledge\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const alertId = parseInt(req.params.id);\n      const userId = (req.user as any).id;\n      \n      const updated = await db.update(sentimentCrisisAlerts)\n        .set({\n          isAcknowledged: true,\n          acknowledgedBy: userId,\n          acknowledgedAt: new Date()\n        })\n        .where(eq(sentimentCrisisAlerts.id, alertId))\n        .returning();\n      \n      await logAudit(req, \"acknowledge_crisis_alert\", \"crisis_alert\", alertId.toString(), \n        { alertTitle: updated[0]?.title });\n      \n      res.json(updated[0]);\n    } catch (error) {\n      console.error(\"Error acknowledging alert:\", error);\n      res.status(500).json({ error: \"Erro ao reconhecer alerta\" });\n    }\n  });\n\n  // Get crisis alert statistics\n  app.get(\"/api/sentiment/crisis-alerts/stats\", requireAuth, async (req, res) => {\n    try {\n      const now = new Date();\n      const dayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n      \n      const allAlerts = await db.select().from(sentimentCrisisAlerts);\n      \n      const stats = {\n        total: allAlerts.length,\n        unacknowledged: allAlerts.filter(a => !a.isAcknowledged).length,\n        last24h: allAlerts.filter(a => new Date(a.detectedAt) > dayAgo).length,\n        lastWeek: allAlerts.filter(a => new Date(a.detectedAt) > weekAgo).length,\n        bySeverity: {\n          critical: allAlerts.filter(a => a.severity === \"critical\").length,\n          high: allAlerts.filter(a => a.severity === \"high\").length,\n          medium: allAlerts.filter(a => a.severity === \"medium\").length,\n          low: allAlerts.filter(a => a.severity === \"low\").length\n        },\n        byType: {\n          negative_spike: allAlerts.filter(a => a.alertType === \"negative_spike\").length,\n          crisis: allAlerts.filter(a => a.alertType === \"crisis\").length,\n          trending_negative: allAlerts.filter(a => a.alertType === \"trending_negative\").length,\n          high_volume: allAlerts.filter(a => a.alertType === \"high_volume\").length\n        }\n      };\n      \n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching alert stats:\", error);\n      res.status(500).json({ error: \"Erro ao buscar estatísticas\" });\n    }\n  });\n\n  // ============================================\n  // FILTERED SENTIMENT ANALYSIS ROUTES\n  // ============================================\n\n  // Get sentiment with filters (source type, date range)\n  app.get(\"/api/sentiment/filtered\", requireAuth, async (req, res) => {\n    try {\n      const { \n        entityType, \n        entityId, \n        sourceType, \n        startDate, \n        endDate, \n        limit: queryLimit \n      } = req.query;\n      \n      const conditions = [];\n      \n      if (entityType) conditions.push(eq(sentimentAnalysisResults.entityType, entityType as string));\n      if (entityId) conditions.push(eq(sentimentAnalysisResults.entityId, entityId as string));\n      if (startDate) conditions.push(gte(sentimentAnalysisResults.analysisDate, new Date(startDate as string)));\n      if (endDate) conditions.push(lte(sentimentAnalysisResults.analysisDate, new Date(endDate as string)));\n      \n      let query = db.select().from(sentimentAnalysisResults);\n      \n      if (conditions.length > 0) {\n        query = query.where(and(...conditions)) as any;\n      }\n      \n      const results = await query\n        .orderBy(desc(sentimentAnalysisResults.analysisDate))\n        .limit(parseInt(queryLimit as string) || 100);\n      \n      let filteredResults = results;\n      if (sourceType) {\n        filteredResults = results.filter(r => {\n          const breakdown = r.sourceBreakdown as Record<string, number> || {};\n          return breakdown[sourceType as string] && breakdown[sourceType as string] > 0;\n        });\n      }\n      \n      res.json(filteredResults);\n    } catch (error) {\n      console.error(\"Error fetching filtered sentiment:\", error);\n      res.status(500).json({ error: \"Erro ao buscar dados filtrados\" });\n    }\n  });\n\n  // Get sentiment timeline with aggregation\n  app.get(\"/api/sentiment/timeline/:entityType/:entityId\", requireAuth, async (req, res) => {\n    try {\n      const { entityType, entityId } = req.params;\n      const { days } = req.query;\n      \n      const daysBack = parseInt(days as string) || 30;\n      const startDate = new Date();\n      startDate.setDate(startDate.getDate() - daysBack);\n      \n      const results = await db.select()\n        .from(sentimentAnalysisResults)\n        .where(\n          and(\n            eq(sentimentAnalysisResults.entityType, entityType),\n            eq(sentimentAnalysisResults.entityId, entityId),\n            gte(sentimentAnalysisResults.analysisDate, startDate)\n          )\n        )\n        .orderBy(sentimentAnalysisResults.analysisDate);\n      \n      const timeline = results.map(r => ({\n        date: r.analysisDate,\n        score: parseFloat(r.sentimentScore),\n        label: r.sentimentLabel,\n        mentions: r.mentionCount,\n        positive: r.positiveCount,\n        negative: r.negativeCount,\n        neutral: r.neutralCount,\n        sourceBreakdown: r.sourceBreakdown\n      }));\n      \n      const avgScore = timeline.length > 0 \n        ? timeline.reduce((sum, t) => sum + t.score, 0) / timeline.length \n        : 0;\n      \n      const trend = timeline.length >= 2\n        ? timeline[timeline.length - 1].score - timeline[0].score\n        : 0;\n      \n      res.json({\n        entityType,\n        entityId,\n        timeline,\n        summary: {\n          avgScore,\n          trend: trend > 0.1 ? \"improving\" : trend < -0.1 ? \"declining\" : \"stable\",\n          totalMentions: timeline.reduce((sum, t) => sum + (t.mentions || 0), 0),\n          dataPoints: timeline.length\n        }\n      });\n    } catch (error) {\n      console.error(\"Error fetching timeline:\", error);\n      res.status(500).json({ error: \"Erro ao buscar timeline\" });\n    }\n  });\n\n  // Get articles filtered by source type and sentiment\n  app.get(\"/api/sentiment/articles/filtered\", requireAuth, async (req, res) => {\n    try {\n      const { sourceType, sentiment, startDate, endDate, limit: queryLimit } = req.query;\n      \n      const conditions = [];\n      \n      if (sourceType) conditions.push(eq(sentimentArticles.sourceType, sourceType as string));\n      if (sentiment) conditions.push(eq(sentimentArticles.sentimentLabel, sentiment as string));\n      if (startDate) conditions.push(gte(sentimentArticles.publishedAt, new Date(startDate as string)));\n      if (endDate) conditions.push(lte(sentimentArticles.publishedAt, new Date(endDate as string)));\n      \n      let query = db.select().from(sentimentArticles);\n      \n      if (conditions.length > 0) {\n        query = query.where(and(...conditions)) as any;\n      }\n      \n      const articles = await query\n        .orderBy(desc(sentimentArticles.publishedAt))\n        .limit(parseInt(queryLimit as string) || 50);\n      \n      res.json(articles);\n    } catch (error) {\n      console.error(\"Error fetching filtered articles:\", error);\n      res.status(500).json({ error: \"Erro ao buscar artigos\" });\n    }\n  });\n\n  // GPT-4o Advanced Sentiment Classification\n  app.post(\"/api/sentiment/classify-articles\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schema = z.object({\n        articles: z.array(z.object({\n          id: z.number().optional(),\n          title: z.string(),\n          content: z.string(),\n          source: z.string()\n        })).min(1).max(20)\n      });\n      \n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Dados inválidos\", details: parsed.error.issues });\n      }\n      \n      const { batchClassifySentiment } = await import(\"./ai-insights\");\n      const result = await batchClassifySentiment(parsed.data.articles);\n      \n      const userId = (req.user as any).id;\n      await logAudit(req, \"batch_sentiment_classification\", \"sentiment_analysis\", \"batch\", \n        { articleCount: parsed.data.articles.length, summary: result.summary });\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error in batch sentiment classification:\", error);\n      res.status(500).json({ error: \"Erro ao classificar artigos\" });\n    }\n  });\n\n  // Classify single article with GPT-4o\n  app.post(\"/api/sentiment/classify-article\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schema = z.object({\n        title: z.string().min(1),\n        content: z.string().min(10),\n        source: z.string()\n      });\n      \n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Dados inválidos\" });\n      }\n      \n      const { classifyArticleSentiment } = await import(\"./ai-insights\");\n      const result = await classifyArticleSentiment(parsed.data);\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error classifying article:\", error);\n      res.status(500).json({ error: \"Erro ao classificar artigo\" });\n    }\n  });\n\n  // Generate comparison narrative with GPT-4o\n  app.post(\"/api/sentiment/comparison-narrative\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schema = z.object({\n        entities: z.array(z.object({\n          name: z.string(),\n          type: z.string(),\n          avgSentiment: z.number(),\n          totalMentions: z.number(),\n          trend: z.string()\n        })).min(2)\n      });\n      \n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Dados inválidos\" });\n      }\n      \n      const { generateComparisonNarrative } = await import(\"./ai-insights\");\n      const narrative = await generateComparisonNarrative(parsed.data.entities);\n      \n      res.json({ narrative });\n    } catch (error) {\n      console.error(\"Error generating narrative:\", error);\n      res.status(500).json({ error: \"Erro ao gerar narrativa\" });\n    }\n  });\n\n  // Detect crisis from sentiment changes\n  app.post(\"/api/sentiment/detect-crisis\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const schema = z.object({\n        entityType: z.string(),\n        entityId: z.string(),\n        entityName: z.string(),\n        currentSentiment: z.number(),\n        previousSentiment: z.number(),\n        mentionCount: z.number(),\n        avgMentionCount: z.number()\n      });\n      \n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Dados inválidos\" });\n      }\n      \n      const { detectCrisisFromSentiment } = await import(\"./ai-insights\");\n      const alert = await detectCrisisFromSentiment(parsed.data);\n      \n      if (alert && alert.shouldAlert) {\n        const userId = (req.user as any).id;\n        const sentimentChange = parsed.data.previousSentiment - parsed.data.currentSentiment;\n        \n        // Store the alert with correct column names\n        const stored = await db.insert(sentimentCrisisAlerts).values({\n          entityType: parsed.data.entityType,\n          entityId: parsed.data.entityId,\n          entityName: parsed.data.entityName,\n          alertType: alert.alertType!,\n          severity: alert.severity,\n          title: alert.title,\n          description: alert.description,\n          sentimentBefore: parsed.data.previousSentiment.toFixed(4),\n          sentimentAfter: parsed.data.currentSentiment.toFixed(4),\n          sentimentChange: sentimentChange.toFixed(4),\n          mentionCount: parsed.data.mentionCount\n        }).returning();\n        \n        // Add audit log\n        await logAudit(req, \"create_crisis_alert\", \"crisis_alert\", stored[0].id.toString(), \n          { severity: alert.severity, entityName: parsed.data.entityName });\n        \n        res.json({ alert: stored[0], detected: true });\n      } else {\n        res.json({ detected: false, message: \"Nenhuma crise detectada\" });\n      }\n    } catch (error) {\n      console.error(\"Error detecting crisis:\", error);\n      res.status(500).json({ error: \"Erro ao detectar crise\" });\n    }\n  });\n\n  // ===== NOTIFICATIONS API =====\n  \n  // Get user's notifications\n  app.get(\"/api/notifications\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const limit = parseInt(req.query.limit as string) || 20;\n      \n      const { getUserNotifications, getUnreadNotificationCount } = await import(\"./notification-service\");\n      const notifications = await getUserNotifications(userId, limit);\n      const unreadCount = await getUnreadNotificationCount(userId);\n      \n      res.json({ notifications, unreadCount });\n    } catch (error) {\n      console.error(\"Error fetching notifications:\", error);\n      res.status(500).json({ error: \"Erro ao buscar notificações\" });\n    }\n  });\n\n  // Get unread notification count\n  app.get(\"/api/notifications/unread-count\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const { getUnreadNotificationCount } = await import(\"./notification-service\");\n      const count = await getUnreadNotificationCount(userId);\n      res.json({ count });\n    } catch (error) {\n      console.error(\"Error fetching unread count:\", error);\n      res.status(500).json({ error: \"Erro ao contar notificações\" });\n    }\n  });\n\n  // Mark notification as read\n  app.post(\"/api/notifications/:id/read\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const notificationId = parseInt(req.params.id);\n      \n      const { markNotificationAsRead } = await import(\"./notification-service\");\n      await markNotificationAsRead(notificationId, userId);\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking notification as read:\", error);\n      res.status(500).json({ error: \"Erro ao marcar notificação\" });\n    }\n  });\n\n  // Mark all notifications as read\n  app.post(\"/api/notifications/mark-all-read\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const { markAllNotificationsAsRead } = await import(\"./notification-service\");\n      await markAllNotificationsAsRead(userId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking all notifications as read:\", error);\n      res.status(500).json({ error: \"Erro ao marcar notificações\" });\n    }\n  });\n\n  // ===== ALERT CONFIGURATIONS API =====\n  \n  // Get user's alert configurations\n  app.get(\"/api/alert-configurations\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const configs = await db.select()\n        .from(alertConfigurations)\n        .where(eq(alertConfigurations.userId, userId))\n        .orderBy(desc(alertConfigurations.createdAt));\n      res.json(configs);\n    } catch (error) {\n      console.error(\"Error fetching alert configurations:\", error);\n      res.status(500).json({ error: \"Erro ao buscar configurações\" });\n    }\n  });\n\n  // Create alert configuration\n  app.post(\"/api/alert-configurations\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const configSchema = z.object({\n        name: z.string().min(1),\n        isGlobal: z.boolean().optional(),\n        entityType: z.string().optional(),\n        entityId: z.string().optional(),\n        sentimentDropThreshold: z.number().min(0).max(1).optional(),\n        criticalSentimentLevel: z.number().min(-1).max(1).optional(),\n        mentionSpikeMultiplier: z.number().min(1).optional(),\n        timeWindowMinutes: z.number().min(1).optional(),\n        notifyEmail: z.boolean().optional(),\n        notifyInApp: z.boolean().optional(),\n        emailRecipients: z.array(z.string().email()).optional(),\n        minAlertIntervalMinutes: z.number().min(1).optional(),\n      });\n      \n      const parsed = configSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: parsed.error.message });\n      }\n      \n      const [config] = await db.insert(alertConfigurations).values({\n        userId,\n        name: parsed.data.name,\n        isGlobal: parsed.data.isGlobal || false,\n        entityType: parsed.data.entityType,\n        entityId: parsed.data.entityId,\n        sentimentDropThreshold: parsed.data.sentimentDropThreshold?.toString(),\n        criticalSentimentLevel: parsed.data.criticalSentimentLevel?.toString(),\n        mentionSpikeMultiplier: parsed.data.mentionSpikeMultiplier?.toString(),\n        timeWindowMinutes: parsed.data.timeWindowMinutes,\n        notifyEmail: parsed.data.notifyEmail ?? true,\n        notifyInApp: parsed.data.notifyInApp ?? true,\n        emailRecipients: parsed.data.emailRecipients || [],\n        minAlertIntervalMinutes: parsed.data.minAlertIntervalMinutes,\n        isActive: true,\n      }).returning();\n      \n      await logAudit(req, \"create_alert_configuration\", \"alert_configuration\", config.id.toString());\n      res.json(config);\n    } catch (error) {\n      console.error(\"Error creating alert configuration:\", error);\n      res.status(500).json({ error: \"Erro ao criar configuração\" });\n    }\n  });\n\n  // Update alert configuration\n  app.patch(\"/api/alert-configurations/:id\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const configId = parseInt(req.params.id);\n      \n      const existing = await db.select()\n        .from(alertConfigurations)\n        .where(and(\n          eq(alertConfigurations.id, configId),\n          eq(alertConfigurations.userId, userId)\n        ))\n        .limit(1);\n      \n      if (existing.length === 0) {\n        return res.status(404).json({ error: \"Configuração não encontrada\" });\n      }\n      \n      const updateData: Record<string, any> = { updatedAt: new Date() };\n      if (req.body.name) updateData.name = req.body.name;\n      if (typeof req.body.isGlobal === 'boolean') updateData.isGlobal = req.body.isGlobal;\n      if (typeof req.body.isActive === 'boolean') updateData.isActive = req.body.isActive;\n      if (req.body.entityType) updateData.entityType = req.body.entityType;\n      if (req.body.entityId) updateData.entityId = req.body.entityId;\n      if (typeof req.body.sentimentDropThreshold === 'number') updateData.sentimentDropThreshold = req.body.sentimentDropThreshold.toString();\n      if (typeof req.body.criticalSentimentLevel === 'number') updateData.criticalSentimentLevel = req.body.criticalSentimentLevel.toString();\n      if (typeof req.body.mentionSpikeMultiplier === 'number') updateData.mentionSpikeMultiplier = req.body.mentionSpikeMultiplier.toString();\n      if (typeof req.body.timeWindowMinutes === 'number') updateData.timeWindowMinutes = req.body.timeWindowMinutes;\n      if (typeof req.body.notifyEmail === 'boolean') updateData.notifyEmail = req.body.notifyEmail;\n      if (typeof req.body.notifyInApp === 'boolean') updateData.notifyInApp = req.body.notifyInApp;\n      if (Array.isArray(req.body.emailRecipients)) updateData.emailRecipients = req.body.emailRecipients;\n      if (typeof req.body.minAlertIntervalMinutes === 'number') updateData.minAlertIntervalMinutes = req.body.minAlertIntervalMinutes;\n      \n      const [updated] = await db.update(alertConfigurations)\n        .set(updateData)\n        .where(eq(alertConfigurations.id, configId))\n        .returning();\n      \n      await logAudit(req, \"update_alert_configuration\", \"alert_configuration\", configId.toString());\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating alert configuration:\", error);\n      res.status(500).json({ error: \"Erro ao atualizar configuração\" });\n    }\n  });\n\n  // Delete alert configuration\n  app.delete(\"/api/alert-configurations/:id\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const configId = parseInt(req.params.id);\n      \n      await db.delete(alertConfigurations)\n        .where(and(\n          eq(alertConfigurations.id, configId),\n          eq(alertConfigurations.userId, userId)\n        ));\n      \n      await logAudit(req, \"delete_alert_configuration\", \"alert_configuration\", configId.toString());\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting alert configuration:\", error);\n      res.status(500).json({ error: \"Erro ao excluir configuração\" });\n    }\n  });\n\n  // ============================================================\n  // IBGE Demographic Data Routes\n  // ============================================================\n\n  // Get IBGE data statistics\n  app.get(\"/api/ibge/stats\", requireAuth, async (_req, res) => {\n    try {\n      const stats = await ibgeService.getStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching IBGE stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch IBGE statistics\" });\n    }\n  });\n\n  // Get import job history\n  app.get(\"/api/ibge/import-jobs\", requireAuth, async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 10;\n      const jobs = await ibgeService.getImportJobs(limit);\n      res.json(jobs);\n    } catch (error) {\n      console.error(\"Error fetching IBGE import jobs:\", error);\n      res.status(500).json({ error: \"Failed to fetch import jobs\" });\n    }\n  });\n\n  // Start import of municipalities\n  app.post(\"/api/ibge/import/municipios\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const userId = req.user?.id;\n      const jobId = await ibgeService.createImportJob(\"municipios\", userId, {});\n      \n      await logAudit(req, \"IBGE_IMPORT_START\", \"ibge_import_jobs\", jobId.toString(), { type: \"municipios\" });\n      \n      res.json({ jobId, message: \"Import started\" });\n\n      // Run import in background\n      ibgeService.importMunicipios(jobId, userId).catch(err => {\n        console.error(\"Error in municipios import:\", err);\n      });\n    } catch (error) {\n      console.error(\"Error starting municipios import:\", error);\n      res.status(500).json({ error: \"Failed to start municipios import\" });\n    }\n  });\n\n  // Start import of population data\n  app.post(\"/api/ibge/import/populacao\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const userId = req.user?.id;\n      const ano = req.body.ano || 2024;\n      const jobId = await ibgeService.createImportJob(\"populacao\", userId, { ano });\n      \n      await logAudit(req, \"IBGE_IMPORT_START\", \"ibge_import_jobs\", jobId.toString(), { type: \"populacao\", ano });\n      \n      res.json({ jobId, message: \"Import started\" });\n\n      // Run import in background\n      ibgeService.importPopulacao(jobId, ano).catch(err => {\n        console.error(\"Error in populacao import:\", err);\n      });\n    } catch (error) {\n      console.error(\"Error starting populacao import:\", error);\n      res.status(500).json({ error: \"Failed to start population import\" });\n    }\n  });\n\n  // Start import of indicators data\n  app.post(\"/api/ibge/import/indicadores\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const userId = req.user?.id;\n      const jobId = await ibgeService.createImportJob(\"indicadores\", userId, {});\n      \n      await logAudit(req, \"IBGE_IMPORT_START\", \"ibge_import_jobs\", jobId.toString(), { type: \"indicadores\" });\n      \n      res.json({ jobId, message: \"Import started\" });\n\n      // Run import in background\n      ibgeService.importIndicadores(jobId).catch(err => {\n        console.error(\"Error in indicadores import:\", err);\n      });\n    } catch (error) {\n      console.error(\"Error starting indicadores import:\", error);\n      res.status(500).json({ error: \"Failed to start indicators import\" });\n    }\n  });\n\n  // Import all data (municipios + populacao + indicadores)\n  app.post(\"/api/ibge/import/all\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const userId = req.user?.id;\n      const ano = req.body.ano || 2024;\n      \n      // Create job for full import\n      const jobId = await ibgeService.createImportJob(\"all\", userId, { ano });\n      \n      await logAudit(req, \"IBGE_IMPORT_START\", \"ibge_import_jobs\", jobId.toString(), { type: \"all\", ano });\n      \n      res.json({ jobId, message: \"Full import started\" });\n\n      // Run imports sequentially in background\n      (async () => {\n        let totalImported = 0;\n        let totalErrors = 0;\n        const startTime = Date.now();\n        \n        try {\n          // Update parent job as running\n          await ibgeService.updateJobProgress(jobId, {\n            status: \"running\",\n            phase: \"import\",\n            phaseDescription: \"Importando municípios...\"\n          });\n          \n          // First import municipios\n          const munJobId = await ibgeService.createImportJob(\"municipios\", userId, {});\n          const munResult = await ibgeService.importMunicipios(munJobId, userId);\n          totalImported += munResult.imported;\n          totalErrors += munResult.errors;\n          \n          // Update parent progress\n          await ibgeService.updateJobProgress(jobId, {\n            phase: \"import\",\n            phaseDescription: \"Importando população...\"\n          });\n          \n          // Then import population\n          const popJobId = await ibgeService.createImportJob(\"populacao\", userId, { ano });\n          const popResult = await ibgeService.importPopulacao(popJobId, ano);\n          totalImported += popResult.imported;\n          totalErrors += popResult.errors;\n\n          // Update parent progress\n          await ibgeService.updateJobProgress(jobId, {\n            phase: \"import\",\n            phaseDescription: \"Gerando indicadores...\"\n          });\n\n          // Finally import indicators\n          const indJobId = await ibgeService.createImportJob(\"indicadores\", userId, {});\n          const indResult = await ibgeService.importIndicadores(indJobId);\n          totalImported += indResult.imported;\n          totalErrors += indResult.errors;\n          \n          // Mark parent job as completed\n          const duration = Math.round((Date.now() - startTime) / 1000);\n          await ibgeService.completeJob(jobId, totalImported, totalErrors, {\n            summary: {\n              totalProcessed: totalImported,\n              totalErrors,\n              duration: `${duration}s`,\n              successRate: totalImported > 0 ? `${((totalImported / (totalImported + totalErrors)) * 100).toFixed(1)}%` : \"0%\"\n            }\n          });\n          \n        } catch (err) {\n          console.error(\"Error in full IBGE import:\", err);\n          await ibgeService.failJob(jobId, err instanceof Error ? err.message : \"Erro na importação completa\");\n        }\n      })();\n    } catch (error) {\n      console.error(\"Error starting full IBGE import:\", error);\n      res.status(500).json({ error: \"Failed to start full import\" });\n    }\n  });\n\n  // Get municipality with demographic data\n  app.get(\"/api/ibge/municipio/:codigoIbge\", requireAuth, async (req, res) => {\n    try {\n      const { codigoIbge } = req.params;\n      const data = await ibgeService.getMunicipioWithData(codigoIbge);\n      \n      if (!data) {\n        return res.status(404).json({ error: \"Municipality not found\" });\n      }\n      \n      res.json(data);\n    } catch (error) {\n      console.error(\"Error fetching municipality data:\", error);\n      res.status(500).json({ error: \"Failed to fetch municipality data\" });\n    }\n  });\n\n  // Get demographic data for AI predictions\n  app.get(\"/api/ibge/demographic-data\", requireAuth, async (req, res) => {\n    try {\n      const { codigoIbge, uf, search } = req.query;\n      const data = await ibgeService.getDemographicDataForPrediction(\n        codigoIbge as string,\n        uf as string,\n        search as string\n      );\n      res.json(data);\n    } catch (error) {\n      console.error(\"Error fetching demographic data:\", error);\n      res.status(500).json({ error: \"Failed to fetch demographic data\" });\n    }\n  });\n\n  // Cancel IBGE import job\n  app.post(\"/api/ibge/import/:jobId/cancel\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.jobId);\n      await ibgeService.cancelJob(jobId);\n      await logAudit(req, \"IBGE_IMPORT_CANCEL\", \"ibge_import_jobs\", jobId.toString(), {});\n      res.json({ success: true, message: \"Job cancelado com sucesso\" });\n    } catch (error) {\n      console.error(\"Error cancelling IBGE import job:\", error);\n      res.status(500).json({ error: error instanceof Error ? error.message : \"Failed to cancel job\" });\n    }\n  });\n\n  // Restart IBGE import job\n  app.post(\"/api/ibge/import/:jobId/restart\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const oldJobId = parseInt(req.params.jobId);\n      const userId = req.user?.id;\n      \n      const originalJob = await ibgeService.getJob(oldJobId);\n      if (!originalJob) {\n        return res.status(404).json({ error: \"Job não encontrado\" });\n      }\n\n      const newJobId = await ibgeService.restartJob(oldJobId, userId);\n      await logAudit(req, \"IBGE_IMPORT_RESTART\", \"ibge_import_jobs\", newJobId.toString(), { originalJobId: oldJobId });\n\n      // Start the import in the background\n      (async () => {\n        try {\n          const type = originalJob.type;\n          const params = originalJob.parameters || {};\n\n          if (type === \"municipios\") {\n            await ibgeService.importMunicipios(newJobId, userId);\n          } else if (type === \"populacao\") {\n            await ibgeService.importPopulacao(newJobId, params.ano);\n          } else if (type === \"indicadores\") {\n            await ibgeService.importIndicadores(newJobId);\n          } else if (type === \"all\") {\n            await ibgeService.importMunicipios(newJobId, userId);\n            const popJobId = await ibgeService.createImportJob(\"populacao\", userId, { ano: params.ano || 2024 });\n            await ibgeService.importPopulacao(popJobId, params.ano || 2024);\n            const indJobId = await ibgeService.createImportJob(\"indicadores\", userId, {});\n            await ibgeService.importIndicadores(indJobId);\n          }\n        } catch (err) {\n          console.error(\"Error restarting IBGE import:\", err);\n        }\n      })();\n\n      res.json({ success: true, newJobId, message: \"Importação reiniciada\" });\n    } catch (error) {\n      console.error(\"Error restarting IBGE import job:\", error);\n      res.status(500).json({ error: error instanceof Error ? error.message : \"Failed to restart job\" });\n    }\n  });\n\n  // Get IBGE import job error report\n  app.get(\"/api/ibge/import/:jobId/report\", requireAuth, async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.jobId);\n      const report = await ibgeService.getJobErrorReport(jobId);\n      \n      if (!report) {\n        return res.status(404).json({ error: \"Job não encontrado\" });\n      }\n      \n      res.json(report);\n    } catch (error) {\n      console.error(\"Error fetching IBGE import report:\", error);\n      res.status(500).json({ error: error instanceof Error ? error.message : \"Failed to fetch report\" });\n    }\n  });\n\n  // Get single IBGE import job status\n  app.get(\"/api/ibge/import/:jobId\", requireAuth, async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.jobId);\n      const job = await ibgeService.getJob(jobId);\n      \n      if (!job) {\n        return res.status(404).json({ error: \"Job não encontrado\" });\n      }\n      \n      res.json(job);\n    } catch (error) {\n      console.error(\"Error fetching IBGE import job:\", error);\n      res.status(500).json({ error: error instanceof Error ? error.message : \"Failed to fetch job\" });\n    }\n  });\n\n  // =====================================================\n  // Campaign Insights AI Module\n  // =====================================================\n\n  // Get all campaign insight sessions\n  app.get(\"/api/campaign-insights/sessions\", requireAuth, async (req, res) => {\n    try {\n      const sessions = await campaignInsightsService.getSessions(req.user?.id);\n      res.json(sessions);\n    } catch (error) {\n      console.error(\"Error fetching sessions:\", error);\n      res.status(500).json({ error: \"Failed to fetch sessions\" });\n    }\n  });\n\n  // Create new campaign insight session\n  app.post(\"/api/campaign-insights/sessions\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { name, description, targetPartyId, targetCandidateId, electionYear, position, targetRegion } = req.body;\n      \n      if (!name || !electionYear) {\n        return res.status(400).json({ error: \"Name and election year are required\" });\n      }\n\n      const sessionId = await campaignInsightsService.createSession({\n        name,\n        description,\n        targetPartyId,\n        targetCandidateId,\n        electionYear,\n        position,\n        targetRegion,\n        createdBy: req.user?.id,\n      });\n\n      await logAudit(req, \"CAMPAIGN_INSIGHT_CREATE\", \"campaign_insight_sessions\", sessionId.toString(), { name, electionYear });\n\n      res.json({ id: sessionId, message: \"Session created successfully\" });\n    } catch (error) {\n      console.error(\"Error creating session:\", error);\n      res.status(500).json({ error: \"Failed to create session\" });\n    }\n  });\n\n  // Get session by ID with all data\n  app.get(\"/api/campaign-insights/sessions/:id\", requireAuth, async (req, res) => {\n    try {\n      const session = await campaignInsightsService.getSessionById(parseInt(req.params.id));\n      if (!session) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n      res.json(session);\n    } catch (error) {\n      console.error(\"Error fetching session:\", error);\n      res.status(500).json({ error: \"Failed to fetch session\" });\n    }\n  });\n\n  // Analyze high-impact segments\n  app.post(\"/api/campaign-insights/sessions/:id/analyze-segments\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const sessionId = parseInt(req.params.id);\n      const session = await campaignInsightsService.getSessionById(sessionId);\n      \n      if (!session) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n\n      const segments = await campaignInsightsService.analyzeHighImpactSegments({\n        sessionId,\n        electionYear: session.electionYear,\n        targetRegion: session.targetRegion,\n        targetPartyId: session.targetPartyId,\n      });\n\n      await logAudit(req, \"CAMPAIGN_SEGMENT_ANALYSIS\", \"high_impact_segments\", sessionId.toString(), { segmentCount: segments.length });\n\n      res.json({ segments, message: \"Segment analysis completed\" });\n    } catch (error) {\n      console.error(\"Error analyzing segments:\", error);\n      res.status(500).json({ error: \"Failed to analyze segments\" });\n    }\n  });\n\n  // Generate message strategies\n  app.post(\"/api/campaign-insights/sessions/:id/generate-messages\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const sessionId = parseInt(req.params.id);\n      const { segmentId } = req.body;\n\n      const strategies = await campaignInsightsService.generateMessageStrategies({\n        sessionId,\n        segmentId,\n      });\n\n      await logAudit(req, \"CAMPAIGN_MESSAGE_STRATEGY\", \"message_strategies\", sessionId.toString(), { strategyCount: strategies.length });\n\n      res.json({ strategies, message: \"Message strategies generated\" });\n    } catch (error) {\n      console.error(\"Error generating messages:\", error);\n      res.status(500).json({ error: \"Failed to generate message strategies\" });\n    }\n  });\n\n  // Predict campaign impact\n  app.post(\"/api/campaign-insights/sessions/:id/predict-impact\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const sessionId = parseInt(req.params.id);\n      const { investmentType, investmentAmount, targetSegmentIds, duration } = req.body;\n\n      if (!investmentType || !investmentAmount || !targetSegmentIds?.length || !duration) {\n        return res.status(400).json({ error: \"Investment details are required\" });\n      }\n\n      const prediction = await campaignInsightsService.predictCampaignImpact({\n        sessionId,\n        investmentType,\n        investmentAmount: parseFloat(investmentAmount),\n        targetSegmentIds,\n        duration: parseInt(duration),\n      });\n\n      await logAudit(req, \"CAMPAIGN_IMPACT_PREDICTION\", \"campaign_impact_predictions\", prediction.id.toString(), { investmentType, investmentAmount });\n\n      res.json({ prediction, message: \"Impact prediction generated\" });\n    } catch (error) {\n      console.error(\"Error predicting impact:\", error);\n      res.status(500).json({ error: \"Failed to predict impact\" });\n    }\n  });\n\n  // Generate executive report\n  app.post(\"/api/campaign-insights/sessions/:id/generate-report\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const sessionId = parseInt(req.params.id);\n      const report = await campaignInsightsService.generateExecutiveReport(sessionId, req.user?.id);\n\n      await logAudit(req, \"CAMPAIGN_REPORT_GENERATE\", \"campaign_insight_reports\", report.id.toString(), { reportType: \"executive\" });\n\n      res.json({ report, message: \"Report generated successfully\" });\n    } catch (error) {\n      console.error(\"Error generating report:\", error);\n      res.status(500).json({ error: \"Failed to generate report\" });\n    }\n  });\n\n  // ============ CAMPAIGN MANAGEMENT ROUTES ============\n\n  // Get all campaigns\n  app.get(\"/api/campaigns\", requireAuth, async (req, res) => {\n    try {\n      const { status, partyId } = req.query;\n      const campaigns = await storage.getCampaigns({\n        status: status as string | undefined,\n        partyId: partyId ? parseInt(partyId as string) : undefined,\n      });\n      res.json(campaigns);\n    } catch (error) {\n      console.error(\"Error fetching campaigns:\", error);\n      res.status(500).json({ error: \"Failed to fetch campaigns\" });\n    }\n  });\n\n  // Create a new campaign\n  app.post(\"/api/campaigns\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const { startDate, endDate, ...rest } = req.body;\n      const campaign = await storage.createCampaign({\n        ...rest,\n        startDate: new Date(startDate),\n        endDate: new Date(endDate),\n        createdBy: req.user?.id,\n      });\n      \n      await logAudit(req, \"CAMPAIGN_CREATE\", \"campaigns\", campaign.id.toString(), { name: campaign.name });\n      \n      res.status(201).json(campaign);\n    } catch (error) {\n      console.error(\"Error creating campaign:\", error);\n      res.status(500).json({ error: \"Failed to create campaign\" });\n    }\n  });\n\n  // Get campaign by ID with full details\n  app.get(\"/api/campaigns/:id\", requireAuth, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const result = await storage.getCampaignWithDetails(id);\n      \n      if (!result) {\n        return res.status(404).json({ error: \"Campaign not found\" });\n      }\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching campaign:\", error);\n      res.status(500).json({ error: \"Failed to fetch campaign\" });\n    }\n  });\n\n  // Update campaign\n  app.patch(\"/api/campaigns/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updated = await storage.updateCampaign(id, req.body);\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"Campaign not found\" });\n      }\n      \n      await logAudit(req, \"CAMPAIGN_UPDATE\", \"campaigns\", id.toString(), req.body);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating campaign:\", error);\n      res.status(500).json({ error: \"Failed to update campaign\" });\n    }\n  });\n\n  // Delete campaign\n  app.delete(\"/api/campaigns/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const deleted = await storage.deleteCampaign(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ error: \"Campaign not found\" });\n      }\n      \n      await logAudit(req, \"CAMPAIGN_DELETE\", \"campaigns\", id.toString(), {});\n      \n      res.json({ message: \"Campaign deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting campaign:\", error);\n      res.status(500).json({ error: \"Failed to delete campaign\" });\n    }\n  });\n\n  // Get campaign performance summary\n  app.get(\"/api/campaigns/:id/performance\", requireAuth, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const summary = await storage.getCampaignPerformanceSummary(id);\n      res.json(summary);\n    } catch (error) {\n      console.error(\"Error fetching performance:\", error);\n      res.status(500).json({ error: \"Failed to fetch performance summary\" });\n    }\n  });\n\n  // Link AI session to campaign\n  app.post(\"/api/campaigns/:id/link-ai-session\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { aiSessionId } = req.body;\n      \n      const updated = await storage.updateCampaign(id, { aiSessionId });\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"Campaign not found\" });\n      }\n      \n      await logAudit(req, \"CAMPAIGN_LINK_AI\", \"campaigns\", id.toString(), { aiSessionId });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error linking AI session:\", error);\n      res.status(500).json({ error: \"Failed to link AI session\" });\n    }\n  });\n\n  // ============ CAMPAIGN TEAM MEMBERS ============\n  \n  // Get team members for a campaign\n  app.get(\"/api/campaigns/:id/team\", requireAuth, async (req, res) => {\n    try {\n      const campaignId = parseInt(req.params.id);\n      const members = await storage.getCampaignTeamMembers(campaignId);\n      \n      // Enrich with user details\n      const enrichedMembers = await Promise.all(members.map(async (member) => {\n        const user = await storage.getUser(member.userId);\n        return {\n          ...member,\n          user: user ? { id: user.id, name: user.name, username: user.username, email: user.email, role: user.role } : null\n        };\n      }));\n      \n      res.json(enrichedMembers);\n    } catch (error) {\n      console.error(\"Error fetching team members:\", error);\n      res.status(500).json({ error: \"Failed to fetch team members\" });\n    }\n  });\n\n  // Add team member to campaign\n  app.post(\"/api/campaigns/:id/team\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const campaignId = parseInt(req.params.id);\n      const { userId, role, permissions, notes } = req.body;\n      \n      // Check if user already a member\n      const existing = await storage.getCampaignTeamMemberByUser(campaignId, userId);\n      if (existing) {\n        return res.status(400).json({ error: \"User is already a team member\" });\n      }\n      \n      const member = await storage.createCampaignTeamMember({\n        campaignId,\n        userId,\n        role: role || \"member\",\n        permissions: permissions || [],\n        notes,\n      });\n      \n      // Create notification for the added user\n      const campaign = await storage.getCampaign(campaignId);\n      if (campaign) {\n        await storage.createCampaignNotification({\n          campaignId,\n          type: \"team_added\",\n          recipientUserId: userId,\n          title: \"Adicionado à campanha\",\n          message: `Você foi adicionado à equipe da campanha \"${campaign.name}\" como ${role || \"membro\"}.`,\n          severity: \"info\",\n        });\n      }\n      \n      await logAudit(req, \"TEAM_MEMBER_ADD\", \"campaign_team_members\", member.id.toString(), { userId, role });\n      \n      res.status(201).json(member);\n    } catch (error) {\n      console.error(\"Error adding team member:\", error);\n      res.status(500).json({ error: \"Failed to add team member\" });\n    }\n  });\n\n  // Update team member\n  app.patch(\"/api/campaigns/:campaignId/team/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updated = await storage.updateCampaignTeamMember(id, req.body);\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"Team member not found\" });\n      }\n      \n      await logAudit(req, \"TEAM_MEMBER_UPDATE\", \"campaign_team_members\", id.toString(), req.body);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating team member:\", error);\n      res.status(500).json({ error: \"Failed to update team member\" });\n    }\n  });\n\n  // Remove team member\n  app.delete(\"/api/campaigns/:campaignId/team/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const deleted = await storage.deleteCampaignTeamMember(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ error: \"Team member not found\" });\n      }\n      \n      await logAudit(req, \"TEAM_MEMBER_REMOVE\", \"campaign_team_members\", id.toString(), {});\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing team member:\", error);\n      res.status(500).json({ error: \"Failed to remove team member\" });\n    }\n  });\n\n  // ============ ACTIVITY ASSIGNEES ============\n  \n  // Get assignees for an activity\n  app.get(\"/api/campaigns/:campaignId/activities/:activityId/assignees\", requireAuth, async (req, res) => {\n    try {\n      const activityId = parseInt(req.params.activityId);\n      const assignees = await storage.getActivityAssignees(activityId);\n      \n      // Enrich with team member and user details\n      const enrichedAssignees = await Promise.all(assignees.map(async (assignee) => {\n        const teamMember = await storage.getCampaignTeamMember(assignee.teamMemberId);\n        let user = null;\n        if (teamMember) {\n          user = await storage.getUser(teamMember.userId);\n        }\n        return {\n          ...assignee,\n          teamMember,\n          user: user ? { id: user.id, name: user.name, username: user.username } : null\n        };\n      }));\n      \n      res.json(enrichedAssignees);\n    } catch (error) {\n      console.error(\"Error fetching assignees:\", error);\n      res.status(500).json({ error: \"Failed to fetch assignees\" });\n    }\n  });\n\n  // Assign team member to activity\n  app.post(\"/api/campaigns/:campaignId/activities/:activityId/assignees\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const activityId = parseInt(req.params.activityId);\n      const campaignId = parseInt(req.params.campaignId);\n      const { teamMemberId, notes } = req.body;\n      \n      const assignee = await storage.createActivityAssignee({\n        activityId,\n        teamMemberId,\n        assignedBy: req.user?.id,\n        notes,\n      });\n      \n      // Create notification for the assigned user\n      const teamMember = await storage.getCampaignTeamMember(teamMemberId);\n      const activity = await storage.getCampaignActivity(activityId);\n      const campaign = await storage.getCampaign(campaignId);\n      \n      if (teamMember && activity && campaign) {\n        await storage.createCampaignNotification({\n          campaignId,\n          type: \"task_assigned\",\n          recipientUserId: teamMember.userId,\n          title: \"Nova tarefa atribuída\",\n          message: `Você foi atribuído à tarefa \"${activity.title}\" na campanha \"${campaign.name}\".`,\n          severity: \"info\",\n          relatedActivityId: activityId,\n        });\n      }\n      \n      await logAudit(req, \"ACTIVITY_ASSIGN\", \"activity_assignees\", assignee.id.toString(), { activityId, teamMemberId });\n      \n      res.status(201).json(assignee);\n    } catch (error) {\n      console.error(\"Error assigning to activity:\", error);\n      res.status(500).json({ error: \"Failed to assign to activity\" });\n    }\n  });\n\n  // Remove assignee from activity\n  app.delete(\"/api/campaigns/:campaignId/activities/:activityId/assignees/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteActivityAssignee(id);\n      \n      await logAudit(req, \"ACTIVITY_UNASSIGN\", \"activity_assignees\", id.toString(), {});\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing assignee:\", error);\n      res.status(500).json({ error: \"Failed to remove assignee\" });\n    }\n  });\n\n  // ============ AI KPI GOALS ============\n  \n  // Get KPI goals for a campaign\n  app.get(\"/api/campaigns/:id/kpi-goals\", requireAuth, async (req, res) => {\n    try {\n      const campaignId = parseInt(req.params.id);\n      const goals = await storage.getAiKpiGoals(campaignId);\n      res.json(goals);\n    } catch (error) {\n      console.error(\"Error fetching KPI goals:\", error);\n      res.status(500).json({ error: \"Failed to fetch KPI goals\" });\n    }\n  });\n\n  // Create KPI goal\n  app.post(\"/api/campaigns/:id/kpi-goals\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const campaignId = parseInt(req.params.id);\n      const { startDate, endDate, ...rest } = req.body;\n      \n      const goal = await storage.createAiKpiGoal({\n        ...rest,\n        campaignId,\n        startDate: startDate ? new Date(startDate) : undefined,\n        endDate: endDate ? new Date(endDate) : undefined,\n      });\n      \n      await logAudit(req, \"KPI_GOAL_CREATE\", \"ai_kpi_goals\", goal.id.toString(), { kpiName: goal.kpiName });\n      \n      res.status(201).json(goal);\n    } catch (error) {\n      console.error(\"Error creating KPI goal:\", error);\n      res.status(500).json({ error: \"Failed to create KPI goal\" });\n    }\n  });\n\n  // Update KPI goal\n  app.patch(\"/api/campaigns/:campaignId/kpi-goals/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const campaignId = parseInt(req.params.campaignId);\n      const { startDate, endDate, ...rest } = req.body;\n      \n      const updateData: any = { ...rest };\n      if (startDate) updateData.startDate = new Date(startDate);\n      if (endDate) updateData.endDate = new Date(endDate);\n      \n      const updated = await storage.updateAiKpiGoal(id, updateData);\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"KPI goal not found\" });\n      }\n      \n      // Check if goal achieved and send notification\n      if (updated.status === \"achieved\" || (updated.currentValue && updated.targetValue && \n          parseFloat(String(updated.currentValue)) >= parseFloat(String(updated.targetValue)))) {\n        const campaign = await storage.getCampaign(campaignId);\n        const teamMembers = await storage.getCampaignTeamMembers(campaignId);\n        \n        for (const member of teamMembers) {\n          await storage.createCampaignNotification({\n            campaignId,\n            type: \"kpi_alert\",\n            recipientUserId: member.userId,\n            title: \"Meta de KPI alcançada!\",\n            message: `A meta de \"${updated.kpiName}\" foi alcançada na campanha \"${campaign?.name}\".`,\n            severity: \"info\",\n            relatedKpiGoalId: id,\n          });\n        }\n      }\n      \n      await logAudit(req, \"KPI_GOAL_UPDATE\", \"ai_kpi_goals\", id.toString(), req.body);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating KPI goal:\", error);\n      res.status(500).json({ error: \"Failed to update KPI goal\" });\n    }\n  });\n\n  // Delete KPI goal\n  app.delete(\"/api/campaigns/:campaignId/kpi-goals/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteAiKpiGoal(id);\n      \n      await logAudit(req, \"KPI_GOAL_DELETE\", \"ai_kpi_goals\", id.toString(), {});\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting KPI goal:\", error);\n      res.status(500).json({ error: \"Failed to delete KPI goal\" });\n    }\n  });\n\n  // Generate AI recommendations for KPI goals\n  app.post(\"/api/campaigns/:id/kpi-goals/ai-recommendations\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const campaignId = parseInt(req.params.id);\n      const campaign = await storage.getCampaign(campaignId);\n      \n      if (!campaign) {\n        return res.status(404).json({ error: \"Campaign not found\" });\n      }\n      \n      const goals = await storage.getAiKpiGoals(campaignId);\n      const metrics = await storage.getCampaignMetrics(campaignId);\n      \n      const prompt = `Analise a campanha eleitoral \"${campaign.name}\" (cargo: ${campaign.position}, região: ${campaign.targetRegion}) e forneça recomendações de KPIs estratégicos.\n\nMetas atuais:\n${goals.map(g => `- ${g.kpiName}: Meta ${g.targetValue}, Atual ${g.currentValue || \"N/A\"}`).join(\"\\n\") || \"Nenhuma meta definida\"}\n\nMétricas históricas:\n${metrics.slice(0, 10).map(m => `- ${m.kpiName}: ${m.kpiValue} (${new Date(m.metricDate).toLocaleDateString()})`).join(\"\\n\") || \"Sem métricas\"}\n\nMeta de votos: ${campaign.targetVotes || \"Não definida\"}\nOrçamento: R$ ${campaign.totalBudget || 0}\n\nForneça até 5 recomendações de KPIs estratégicos no formato JSON:\n[\n  {\n    \"kpiName\": \"nome do KPI\",\n    \"suggestedTarget\": \"valor numérico sugerido\",\n    \"rationale\": \"justificativa breve\",\n    \"priority\": \"high/medium/low\",\n    \"confidence\": \"porcentagem de confiança\"\n  }\n]`;\n\n      const response = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Authorization\": `Bearer ${process.env.OPENAI_API_KEY}`,\n        },\n        body: JSON.stringify({\n          model: \"gpt-4o\",\n          messages: [\n            { role: \"system\", content: \"Você é um estrategista político especialista em campanhas eleitorais brasileiras. Responda apenas em JSON válido.\" },\n            { role: \"user\", content: prompt }\n          ],\n          temperature: 0.7,\n          max_tokens: 2000,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error(`OpenAI API error: ${response.status}`);\n      }\n\n      const data = await response.json();\n      const content = data.choices[0]?.message?.content || \"[]\";\n      \n      // Parse JSON from response\n      let recommendations = [];\n      try {\n        const jsonMatch = content.match(/\\[[\\s\\S]*\\]/);\n        if (jsonMatch) {\n          recommendations = JSON.parse(jsonMatch[0]);\n        }\n      } catch (e) {\n        console.error(\"Failed to parse AI recommendations:\", e);\n      }\n      \n      res.json({ recommendations });\n    } catch (error) {\n      console.error(\"Error generating AI recommendations:\", error);\n      res.status(500).json({ error: \"Failed to generate AI recommendations\" });\n    }\n  });\n\n  // ============ CALENDAR ACTIVITIES ============\n  \n  // Get activities for calendar view\n  app.get(\"/api/campaigns/:id/calendar\", requireAuth, async (req, res) => {\n    try {\n      const campaignId = parseInt(req.params.id);\n      const { startDate, endDate } = req.query;\n      \n      if (!startDate || !endDate) {\n        return res.status(400).json({ error: \"startDate and endDate are required\" });\n      }\n      \n      const activities = await storage.getCalendarActivities(\n        campaignId,\n        new Date(startDate as string),\n        new Date(endDate as string)\n      );\n      \n      res.json(activities);\n    } catch (error) {\n      console.error(\"Error fetching calendar activities:\", error);\n      res.status(500).json({ error: \"Failed to fetch calendar activities\" });\n    }\n  });\n\n  // ============ CAMPAIGN NOTIFICATIONS ============\n  \n  // Get campaign notifications\n  app.get(\"/api/campaigns/:id/notifications\", requireAuth, async (req, res) => {\n    try {\n      const campaignId = parseInt(req.params.id);\n      const notifications = await storage.getCampaignNotifications(campaignId);\n      res.json(notifications);\n    } catch (error) {\n      console.error(\"Error fetching campaign notifications:\", error);\n      res.status(500).json({ error: \"Failed to fetch notifications\" });\n    }\n  });\n\n  // Get user's campaign notifications across all campaigns\n  app.get(\"/api/user/campaign-notifications\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user?.id;\n      if (!userId) {\n        return res.status(401).json({ error: \"User not authenticated\" });\n      }\n      \n      const notifications = await storage.getUserCampaignNotifications(userId);\n      res.json(notifications);\n    } catch (error) {\n      console.error(\"Error fetching user campaign notifications:\", error);\n      res.status(500).json({ error: \"Failed to fetch notifications\" });\n    }\n  });\n\n  // ============ CAMPAIGN BUDGETS ============\n\n  // Get campaign budgets\n  app.get(\"/api/campaigns/:id/budgets\", requireAuth, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const budgets = await storage.getCampaignBudgets(id);\n      res.json(budgets);\n    } catch (error) {\n      console.error(\"Error fetching budgets:\", error);\n      res.status(500).json({ error: \"Failed to fetch budgets\" });\n    }\n  });\n\n  // Create budget allocation\n  app.post(\"/api/campaigns/:id/budgets\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const campaignId = parseInt(req.params.id);\n      const budget = await storage.createCampaignBudget({\n        ...req.body,\n        campaignId,\n      });\n      \n      await logAudit(req, \"BUDGET_CREATE\", \"campaign_budgets\", budget.id.toString(), { category: budget.category });\n      \n      res.status(201).json(budget);\n    } catch (error) {\n      console.error(\"Error creating budget:\", error);\n      res.status(500).json({ error: \"Failed to create budget\" });\n    }\n  });\n\n  // Update budget\n  app.patch(\"/api/campaigns/:campaignId/budgets/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updated = await storage.updateCampaignBudget(id, req.body);\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"Budget not found\" });\n      }\n      \n      await logAudit(req, \"BUDGET_UPDATE\", \"campaign_budgets\", id.toString(), req.body);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating budget:\", error);\n      res.status(500).json({ error: \"Failed to update budget\" });\n    }\n  });\n\n  // Delete budget\n  app.delete(\"/api/campaigns/:campaignId/budgets/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const deleted = await storage.deleteCampaignBudget(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ error: \"Budget not found\" });\n      }\n      \n      await logAudit(req, \"BUDGET_DELETE\", \"campaign_budgets\", id.toString(), {});\n      \n      res.json({ message: \"Budget deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting budget:\", error);\n      res.status(500).json({ error: \"Failed to delete budget\" });\n    }\n  });\n\n  // ============ CAMPAIGN RESOURCES ============\n\n  // Get campaign resources\n  app.get(\"/api/campaigns/:id/resources\", requireAuth, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const resources = await storage.getCampaignResources(id);\n      res.json(resources);\n    } catch (error) {\n      console.error(\"Error fetching resources:\", error);\n      res.status(500).json({ error: \"Failed to fetch resources\" });\n    }\n  });\n\n  // Create resource\n  app.post(\"/api/campaigns/:id/resources\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const campaignId = parseInt(req.params.id);\n      const resource = await storage.createCampaignResource({\n        ...req.body,\n        campaignId,\n      });\n      \n      await logAudit(req, \"RESOURCE_CREATE\", \"campaign_resources\", resource.id.toString(), { name: resource.name });\n      \n      res.status(201).json(resource);\n    } catch (error) {\n      console.error(\"Error creating resource:\", error);\n      res.status(500).json({ error: \"Failed to create resource\" });\n    }\n  });\n\n  // Update resource\n  app.patch(\"/api/campaigns/:campaignId/resources/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updated = await storage.updateCampaignResource(id, req.body);\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"Resource not found\" });\n      }\n      \n      await logAudit(req, \"RESOURCE_UPDATE\", \"campaign_resources\", id.toString(), req.body);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating resource:\", error);\n      res.status(500).json({ error: \"Failed to update resource\" });\n    }\n  });\n\n  // Delete resource\n  app.delete(\"/api/campaigns/:campaignId/resources/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const deleted = await storage.deleteCampaignResource(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ error: \"Resource not found\" });\n      }\n      \n      await logAudit(req, \"RESOURCE_DELETE\", \"campaign_resources\", id.toString(), {});\n      \n      res.json({ message: \"Resource deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting resource:\", error);\n      res.status(500).json({ error: \"Failed to delete resource\" });\n    }\n  });\n\n  // ============ CAMPAIGN METRICS ============\n\n  // Get campaign metrics\n  app.get(\"/api/campaigns/:id/metrics\", requireAuth, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { kpiName, startDate, endDate } = req.query;\n      \n      const metrics = await storage.getCampaignMetrics(id, {\n        kpiName: kpiName as string | undefined,\n        startDate: startDate ? new Date(startDate as string) : undefined,\n        endDate: endDate ? new Date(endDate as string) : undefined,\n      });\n      res.json(metrics);\n    } catch (error) {\n      console.error(\"Error fetching metrics:\", error);\n      res.status(500).json({ error: \"Failed to fetch metrics\" });\n    }\n  });\n\n  // Create metric\n  app.post(\"/api/campaigns/:id/metrics\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const campaignId = parseInt(req.params.id);\n      const { metricDate, ...rest } = req.body;\n      const metric = await storage.createCampaignMetric({\n        ...rest,\n        metricDate: new Date(metricDate),\n        campaignId,\n      });\n      \n      await logAudit(req, \"METRIC_CREATE\", \"campaign_metrics\", metric.id.toString(), { kpiName: metric.kpiName });\n      \n      res.status(201).json(metric);\n    } catch (error) {\n      console.error(\"Error creating metric:\", error);\n      res.status(500).json({ error: \"Failed to create metric\" });\n    }\n  });\n\n  // Update metric\n  app.patch(\"/api/campaigns/:campaignId/metrics/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updated = await storage.updateCampaignMetric(id, req.body);\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"Metric not found\" });\n      }\n      \n      await logAudit(req, \"METRIC_UPDATE\", \"campaign_metrics\", id.toString(), req.body);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating metric:\", error);\n      res.status(500).json({ error: \"Failed to update metric\" });\n    }\n  });\n\n  // Delete metric\n  app.delete(\"/api/campaigns/:campaignId/metrics/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const deleted = await storage.deleteCampaignMetric(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ error: \"Metric not found\" });\n      }\n      \n      await logAudit(req, \"METRIC_DELETE\", \"campaign_metrics\", id.toString(), {});\n      \n      res.json({ message: \"Metric deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting metric:\", error);\n      res.status(500).json({ error: \"Failed to delete metric\" });\n    }\n  });\n\n  // ============ CAMPAIGN ACTIVITIES ============\n\n  // Get campaign activities\n  app.get(\"/api/campaigns/:id/activities\", requireAuth, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { status, type } = req.query;\n      \n      const activities = await storage.getCampaignActivities(id, {\n        status: status as string | undefined,\n        type: type as string | undefined,\n      });\n      res.json(activities);\n    } catch (error) {\n      console.error(\"Error fetching activities:\", error);\n      res.status(500).json({ error: \"Failed to fetch activities\" });\n    }\n  });\n\n  // Create activity\n  app.post(\"/api/campaigns/:id/activities\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const campaignId = parseInt(req.params.id);\n      const { scheduledDate, ...rest } = req.body;\n      const activity = await storage.createCampaignActivity({\n        ...rest,\n        scheduledDate: scheduledDate ? new Date(scheduledDate) : undefined,\n        campaignId,\n        createdBy: req.user?.id,\n      });\n      \n      await logAudit(req, \"ACTIVITY_CREATE\", \"campaign_activities\", activity.id.toString(), { title: activity.title });\n      \n      res.status(201).json(activity);\n    } catch (error) {\n      console.error(\"Error creating activity:\", error);\n      res.status(500).json({ error: \"Failed to create activity\" });\n    }\n  });\n\n  // Update activity\n  app.patch(\"/api/campaigns/:campaignId/activities/:id\", requireAuth, requireRole(\"admin\", \"analyst\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updated = await storage.updateCampaignActivity(id, req.body);\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"Activity not found\" });\n      }\n      \n      await logAudit(req, \"ACTIVITY_UPDATE\", \"campaign_activities\", id.toString(), req.body);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating activity:\", error);\n      res.status(500).json({ error: \"Failed to update activity\" });\n    }\n  });\n\n  // Delete activity\n  app.delete(\"/api/campaigns/:campaignId/activities/:id\", requireAuth, requireRole(\"admin\"), async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const deleted = await storage.deleteCampaignActivity(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ error: \"Activity not found\" });\n      }\n      \n      await logAudit(req, \"ACTIVITY_DELETE\", \"campaign_activities\", id.toString(), {});\n      \n      res.json({ message: \"Activity deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting activity:\", error);\n      res.status(500).json({ error: \"Failed to delete activity\" });\n    }\n  });\n\n  return httpServer;\n}\n\n// Helper function to calculate next run time\nfunction calculateNextRun(\n  frequency: string,\n  dayOfWeek?: number | null,\n  dayOfMonth?: number | null,\n  timeOfDay: string = \"08:00\",\n  timezone: string = \"America/Sao_Paulo\"\n): Date {\n  const now = new Date();\n  const [hours, minutes] = timeOfDay.split(\":\").map(Number);\n  \n  let nextRun = new Date(now);\n  nextRun.setHours(hours, minutes, 0, 0);\n  \n  // If time already passed today, move to next occurrence\n  if (nextRun <= now) {\n    nextRun.setDate(nextRun.getDate() + 1);\n  }\n  \n  switch (frequency) {\n    case \"once\":\n      // Just use the calculated time\n      break;\n    case \"daily\":\n      // Already calculated above\n      break;\n    case \"weekly\":\n      const targetDay = dayOfWeek ?? 1; // Default to Monday\n      while (nextRun.getDay() !== targetDay) {\n        nextRun.setDate(nextRun.getDate() + 1);\n      }\n      break;\n    case \"monthly\":\n      const targetDate = dayOfMonth ?? 1;\n      nextRun.setDate(targetDate);\n      if (nextRun <= now) {\n        nextRun.setMonth(nextRun.getMonth() + 1);\n        nextRun.setDate(targetDate);\n      }\n      break;\n  }\n  \n  return nextRun;\n}\n\n// Reprocess a failed batch\nasync function reprocessBatch(batchId: number, jobId: number): Promise<void> {\n  try {\n    const batch = await storage.getImportBatch(batchId);\n    if (!batch) {\n      console.error(`Batch ${batchId} not found for reprocessing`);\n      return;\n    }\n\n    await storage.updateImportBatch(batchId, { \n      status: \"processing\", \n      startedAt: new Date() \n    });\n    \n    emitBatchStatus(jobId, batchId, batch.batchIndex, \"processing\", 0, batch.totalRows, 0);\n    \n    const rows = await storage.getBatchRows(batchId, \"pending\");\n    let processed = 0;\n    let inserted = 0;\n    let skipped = 0;\n    let errors = 0;\n    const errorMessages: string[] = [];\n    \n    for (const row of rows) {\n      try {\n        if (!row.parsedData) {\n          await storage.updateBatchRow(row.id, { \n            status: \"failed\", \n            errorType: \"parse_error\",\n            errorMessage: \"No parsed data available\"\n          });\n          errors++;\n          continue;\n        }\n        \n        const parsedRow = row.parsedData as Record<string, unknown>;\n        \n        // Insert the vote record\n        await db.insert(tseCandidateVotes).values({\n          importJobId: jobId,\n          ...mapParsedRowToVote(parsedRow),\n        });\n        \n        await storage.updateBatchRow(row.id, { status: \"success\" });\n        inserted++;\n      } catch (error: unknown) {\n        const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n        await storage.updateBatchRow(row.id, { \n          status: \"failed\", \n          errorType: \"insert_error\",\n          errorMessage\n        });\n        errors++;\n        if (errorMessages.length < 5) {\n          errorMessages.push(`Row ${row.rowNumber}: ${errorMessage}`);\n        }\n        \n        emitBatchError(jobId, batchId, row.rowNumber, \"insert_error\", errorMessage);\n      }\n      \n      processed++;\n      \n      // Emit progress every 100 rows\n      if (processed % 100 === 0) {\n        emitBatchStatus(jobId, batchId, batch.batchIndex, \"processing\", processed, rows.length, errors);\n      }\n    }\n    \n    const finalStatus = errors === 0 ? \"completed\" : (inserted > 0 ? \"completed\" : \"failed\");\n    \n    await storage.updateImportBatch(batchId, {\n      status: finalStatus,\n      processedRows: processed,\n      insertedRows: inserted,\n      skippedRows: skipped,\n      errorCount: errors,\n      errorSummary: errorMessages.length > 0 ? errorMessages.join(\"; \") : null,\n      completedAt: new Date(),\n    });\n    \n    emitBatchStatus(jobId, batchId, batch.batchIndex, finalStatus, processed, rows.length, errors);\n    \n    console.log(`Batch ${batchId} reprocessed: ${inserted} inserted, ${errors} errors`);\n  } catch (error) {\n    console.error(`Batch ${batchId} reprocessing error:`, error);\n    await storage.updateImportBatch(batchId, { \n      status: \"failed\", \n      errorSummary: error instanceof Error ? error.message : \"Reprocessing failed\"\n    });\n  }\n}\n\n// Map parsed row data to vote insert schema\nfunction mapParsedRowToVote(row: Record<string, unknown>): Record<string, unknown> {\n  return {\n    dtGeracao: row.DT_GERACAO as string,\n    hhGeracao: row.HH_GERACAO as string,\n    anoEleicao: parseInt(row.ANO_ELEICAO as string) || null,\n    cdTipoEleicao: parseInt(row.CD_TIPO_ELEICAO as string) || null,\n    nmTipoEleicao: row.NM_TIPO_ELEICAO as string,\n    nrTurno: parseInt(row.NR_TURNO as string) || null,\n    cdEleicao: parseInt(row.CD_ELEICAO as string) || null,\n    dsEleicao: row.DS_ELEICAO as string,\n    dtEleicao: row.DT_ELEICAO as string,\n    tpAbrangencia: row.TP_ABRANGENCIA as string,\n    sgUf: row.SG_UF as string,\n    sgUe: row.SG_UE as string,\n    nmUe: row.NM_UE as string,\n    cdMunicipio: parseInt(row.CD_MUNICIPIO as string) || null,\n    nmMunicipio: row.NM_MUNICIPIO as string,\n    nrZona: parseInt(row.NR_ZONA as string) || null,\n    cdCargo: parseInt(row.CD_CARGO as string) || null,\n    dsCargo: row.DS_CARGO as string,\n    sqCandidato: row.SQ_CANDIDATO as string,\n    nrCandidato: parseInt(row.NR_CANDIDATO as string) || null,\n    nmCandidato: row.NM_CANDIDATO as string,\n    nmUrnaCandidato: row.NM_URNA_CANDIDATO as string,\n    nmSocialCandidato: row.NM_SOCIAL_CANDIDATO as string,\n    cdSituacaoCandidatura: parseInt(row.CD_SITUACAO_CANDIDATURA as string) || null,\n    dsSituacaoCandidatura: row.DS_SITUACAO_CANDIDATURA as string,\n    cdDetalheSituacaoCand: parseInt(row.CD_DETALHE_SITUACAO_CAND as string) || null,\n    dsDetalheSituacaoCand: row.DS_DETALHE_SITUACAO_CAND as string,\n    cdSituacaoJulgamento: parseInt(row.CD_SITUACAO_JULGAMENTO as string) || null,\n    dsSituacaoJulgamento: row.DS_SITUACAO_JULGAMENTO as string,\n    cdSituacaoCassacao: parseInt(row.CD_SITUACAO_CASSACAO as string) || null,\n    dsSituacaoCassacao: row.DS_SITUACAO_CASSACAO as string,\n    cdSituacaoDconstDiploma: parseInt(row.CD_SITUACAO_DCONST_DIPLOMA as string) || null,\n    dsSituacaoDconstDiploma: row.DS_SITUACAO_DCONST_DIPLOMA as string,\n    tpAgremiacao: row.TP_AGREMIACAO as string,\n    nrPartido: parseInt(row.NR_PARTIDO as string) || null,\n    sgPartido: row.SG_PARTIDO as string,\n    nmPartido: row.NM_PARTIDO as string,\n    nrFederacao: parseInt(row.NR_FEDERACAO as string) || null,\n    nmFederacao: row.NM_FEDERACAO as string,\n    sgFederacao: row.SG_FEDERACAO as string,\n    dsComposicaoFederacao: row.DS_COMPOSICAO_FEDERACAO as string,\n    sqColigacao: row.SQ_COLIGACAO as string,\n    nmColigacao: row.NM_COLIGACAO as string,\n    dsComposicaoColigacao: row.DS_COMPOSICAO_COLIGACAO as string,\n    stVotoEmTransito: row.ST_VOTO_EM_TRANSITO as string,\n    qtVotosNominais: parseInt(row.QT_VOTOS_NOMINAIS as string) || null,\n    nmTipoDestinacaoVotos: row.NM_TIPO_DESTINACAO_VOTOS as string,\n    qtVotosNominaisValidos: parseInt(row.QT_VOTOS_NOMINAIS_VALIDOS as string) || null,\n    cdSitTotTurno: parseInt(row.CD_SIT_TOT_TURNO as string) || null,\n    dsSitTotTurno: row.DS_SIT_TOT_TURNO as string,\n  };\n}\n","path":null,"size_bytes":342306,"size_tokens":null},"client/src/components/brazil-map.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Loader2, Users, Building2, TrendingUp } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from \"recharts\";\n\ninterface StateData {\n  code: string;\n  name: string;\n  topCandidates: Array<{ name: string; party: string; votes: number }>;\n  topParties: Array<{ name: string; abbreviation: string; votes: number; color: string }>;\n  totalVotes: number;\n  totalCandidates: number;\n}\n\ninterface BrazilState {\n  name: string;\n  path: string;\n  region: \"norte\" | \"nordeste\" | \"centro-oeste\" | \"sudeste\" | \"sul\";\n  capital: string;\n  labelX?: number;\n  labelY?: number;\n}\n\nconst BRAZIL_STATES: Record<string, BrazilState> = {\n  AC: {\n    name: \"Acre\",\n    region: \"norte\",\n    capital: \"Rio Branco\",\n    path: \"M45,165 L55,160 L70,162 L82,170 L85,180 L80,190 L65,195 L50,192 L40,185 L42,172 Z\",\n    labelX: 62, labelY: 178\n  },\n  AL: {\n    name: \"Alagoas\",\n    region: \"nordeste\",\n    capital: \"Maceió\",\n    path: \"M418,158 L428,152 L438,154 L442,162 L435,168 L422,166 Z\",\n    labelX: 430, labelY: 160\n  },\n  AP: {\n    name: \"Amapá\",\n    region: \"norte\",\n    capital: \"Macapá\",\n    path: \"M268,25 L280,18 L295,22 L298,35 L290,50 L275,55 L262,48 L260,35 Z\",\n    labelX: 278, labelY: 38\n  },\n  AM: {\n    name: \"Amazonas\",\n    region: \"norte\",\n    capital: \"Manaus\",\n    path: \"M85,75 L120,70 L160,72 L195,78 L220,95 L218,125 L205,150 L175,165 L140,168 L100,165 L70,155 L55,135 L50,110 L60,85 Z\",\n    labelX: 138, labelY: 118\n  },\n  BA: {\n    name: \"Bahia\",\n    region: \"nordeste\",\n    capital: \"Salvador\",\n    path: \"M340,140 L380,135 L405,145 L420,160 L418,185 L405,210 L380,225 L355,230 L330,225 L315,205 L320,175 L325,150 Z\",\n    labelX: 365, labelY: 182\n  },\n  CE: {\n    name: \"Ceará\",\n    region: \"nordeste\",\n    capital: \"Fortaleza\",\n    path: \"M385,85 L410,78 L435,82 L445,95 L440,115 L420,125 L395,122 L380,110 L378,95 Z\",\n    labelX: 412, labelY: 102\n  },\n  DF: {\n    name: \"Distrito Federal\",\n    region: \"centro-oeste\",\n    capital: \"Brasília\",\n    path: \"M325,218 L335,214 L342,220 L338,228 L328,228 L322,222 Z\",\n    labelX: 332, labelY: 222\n  },\n  ES: {\n    name: \"Espírito Santo\",\n    region: \"sudeste\",\n    capital: \"Vitória\",\n    path: \"M395,238 L410,232 L418,242 L415,258 L402,265 L390,255 L388,245 Z\",\n    labelX: 403, labelY: 248\n  },\n  GO: {\n    name: \"Goiás\",\n    region: \"centro-oeste\",\n    capital: \"Goiânia\",\n    path: \"M280,195 L315,185 L345,195 L355,215 L345,240 L320,250 L290,248 L270,230 L268,210 Z\",\n    labelX: 310, labelY: 218\n  },\n  MA: {\n    name: \"Maranhão\",\n    region: \"nordeste\",\n    capital: \"São Luís\",\n    path: \"M305,75 L340,68 L370,75 L380,95 L375,120 L350,135 L320,138 L295,125 L290,100 L295,82 Z\",\n    labelX: 335, labelY: 105\n  },\n  MT: {\n    name: \"Mato Grosso\",\n    region: \"centro-oeste\",\n    capital: \"Cuiabá\",\n    path: \"M175,165 L220,158 L265,165 L280,195 L268,230 L235,245 L195,242 L165,225 L155,195 L160,175 Z\",\n    labelX: 218, labelY: 202\n  },\n  MS: {\n    name: \"Mato Grosso do Sul\",\n    region: \"centro-oeste\",\n    capital: \"Campo Grande\",\n    path: \"M235,245 L268,242 L285,260 L280,290 L255,310 L225,308 L200,290 L195,265 L210,250 Z\",\n    labelX: 240, labelY: 278\n  },\n  MG: {\n    name: \"Minas Gerais\",\n    region: \"sudeste\",\n    capital: \"Belo Horizonte\",\n    path: \"M320,225 L360,218 L390,230 L405,255 L395,285 L360,300 L320,298 L290,280 L285,255 L295,235 Z\",\n    labelX: 345, labelY: 260\n  },\n  PA: {\n    name: \"Pará\",\n    region: \"norte\",\n    capital: \"Belém\",\n    path: \"M195,55 L250,48 L290,55 L310,75 L305,110 L285,140 L250,155 L210,152 L175,140 L165,115 L170,85 L180,65 Z\",\n    labelX: 238, labelY: 102\n  },\n  PB: {\n    name: \"Paraíba\",\n    region: \"nordeste\",\n    capital: \"João Pessoa\",\n    path: \"M420,125 L445,120 L460,128 L458,140 L440,145 L418,142 Z\",\n    labelX: 440, labelY: 133\n  },\n  PR: {\n    name: \"Paraná\",\n    region: \"sul\",\n    capital: \"Curitiba\",\n    path: \"M280,310 L320,302 L355,310 L358,335 L340,355 L300,358 L270,345 L265,325 Z\",\n    labelX: 312, labelY: 332\n  },\n  PE: {\n    name: \"Pernambuco\",\n    region: \"nordeste\",\n    capital: \"Recife\",\n    path: \"M378,135 L420,128 L445,135 L450,150 L430,158 L395,160 L375,152 Z\",\n    labelX: 412, labelY: 145\n  },\n  PI: {\n    name: \"Piauí\",\n    region: \"nordeste\",\n    capital: \"Teresina\",\n    path: \"M350,95 L380,88 L395,105 L392,135 L375,150 L350,148 L335,130 L340,108 Z\",\n    labelX: 365, labelY: 120\n  },\n  RJ: {\n    name: \"Rio de Janeiro\",\n    region: \"sudeste\",\n    capital: \"Rio de Janeiro\",\n    path: \"M365,290 L395,282 L415,295 L410,315 L385,322 L360,312 L358,298 Z\",\n    labelX: 385, labelY: 302\n  },\n  RN: {\n    name: \"Rio Grande do Norte\",\n    region: \"nordeste\",\n    capital: \"Natal\",\n    path: \"M420,105 L448,98 L465,108 L462,122 L445,128 L422,125 L418,115 Z\",\n    labelX: 442, labelY: 113\n  },\n  RS: {\n    name: \"Rio Grande do Sul\",\n    region: \"sul\",\n    capital: \"Porto Alegre\",\n    path: \"M270,365 L310,358 L345,368 L348,400 L325,425 L285,428 L255,410 L250,380 Z\",\n    labelX: 300, labelY: 395\n  },\n  RO: {\n    name: \"Rondônia\",\n    region: \"norte\",\n    capital: \"Porto Velho\",\n    path: \"M130,168 L165,162 L185,178 L180,205 L155,218 L125,212 L115,190 L118,175 Z\",\n    labelX: 150, labelY: 190\n  },\n  RR: {\n    name: \"Roraima\",\n    region: \"norte\",\n    capital: \"Boa Vista\",\n    path: \"M148,25 L175,18 L198,28 L205,55 L195,78 L168,85 L145,75 L138,50 Z\",\n    labelX: 172, labelY: 52\n  },\n  SC: {\n    name: \"Santa Catarina\",\n    region: \"sul\",\n    capital: \"Florianópolis\",\n    path: \"M300,358 L340,352 L365,365 L362,388 L335,398 L300,392 L278,378 L280,362 Z\",\n    labelX: 322, labelY: 375\n  },\n  SP: {\n    name: \"São Paulo\",\n    region: \"sudeste\",\n    capital: \"São Paulo\",\n    path: \"M285,275 L330,265 L365,278 L375,305 L358,332 L315,342 L280,330 L268,305 L272,285 Z\",\n    labelX: 322, labelY: 305\n  },\n  SE: {\n    name: \"Sergipe\",\n    region: \"nordeste\",\n    capital: \"Aracaju\",\n    path: \"M418,168 L435,162 L445,172 L440,185 L425,188 L415,180 Z\",\n    labelX: 430, labelY: 175\n  },\n  TO: {\n    name: \"Tocantins\",\n    region: \"norte\",\n    capital: \"Palmas\",\n    path: \"M295,125 L325,118 L345,132 L348,165 L335,195 L305,200 L280,185 L275,155 L282,135 Z\",\n    labelX: 312, labelY: 158\n  }\n};\n\nconst REGION_COLORS = {\n  norte: { \n    default: \"#4CAF50\", \n    hover: \"#66BB6A\", \n    selected: \"#388E3C\",\n    label: \"Verde\"\n  },\n  nordeste: { \n    default: \"#FF9800\", \n    hover: \"#FFB74D\", \n    selected: \"#F57C00\",\n    label: \"Laranja\"\n  },\n  \"centro-oeste\": { \n    default: \"#FFEB3B\", \n    hover: \"#FFF176\", \n    selected: \"#FBC02D\",\n    label: \"Amarelo\"\n  },\n  sudeste: { \n    default: \"#2196F3\", \n    hover: \"#64B5F6\", \n    selected: \"#1976D2\",\n    label: \"Azul\"\n  },\n  sul: { \n    default: \"#9C27B0\", \n    hover: \"#BA68C8\", \n    selected: \"#7B1FA2\",\n    label: \"Roxo\"\n  }\n};\n\nconst REGION_NAMES: Record<string, string> = {\n  norte: \"Norte\",\n  nordeste: \"Nordeste\",\n  \"centro-oeste\": \"Centro-Oeste\",\n  sudeste: \"Sudeste\",\n  sul: \"Sul\"\n};\n\nexport function BrazilMap() {\n  const [hoveredState, setHoveredState] = useState<string | null>(null);\n  const [selectedState, setSelectedState] = useState<string | null>(null);\n  const [showDialog, setShowDialog] = useState(false);\n\n  const { data: stateData, isLoading: stateLoading } = useQuery<StateData>({\n    queryKey: [\"/api/electoral-data/state\", selectedState],\n    enabled: !!selectedState && showDialog,\n  });\n\n  const handleStateClick = (stateCode: string) => {\n    setSelectedState(stateCode);\n    setShowDialog(true);\n  };\n\n  const getStateColor = (code: string) => {\n    const state = BRAZIL_STATES[code];\n    if (!state) return \"#666\";\n    \n    const colors = REGION_COLORS[state.region];\n    if (selectedState === code) return colors.selected;\n    if (hoveredState === code) return colors.hover;\n    return colors.default;\n  };\n\n  const getStateBorderColor = (code: string) => {\n    if (hoveredState === code || selectedState === code) {\n      return \"#1a1a1a\";\n    }\n    return \"#ffffff\";\n  };\n\n  return (\n    <Card className=\"overflow-hidden\" data-testid=\"brazil-map-card\">\n      <CardHeader className=\"pb-2\">\n        <CardTitle className=\"flex items-center gap-2\">\n          <Building2 className=\"h-5 w-5\" />\n          Mapa Eleitoral do Brasil\n        </CardTitle>\n        <CardDescription>\n          Clique em um estado para ver os dados eleitorais\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"p-4\">\n        <div className=\"relative\">\n          <svg\n            viewBox=\"0 0 480 450\"\n            className=\"w-full h-auto max-h-[400px]\"\n            data-testid=\"brazil-map-svg\"\n            style={{ background: \"linear-gradient(180deg, #87CEEB 0%, #4A90A4 50%, #2E6B7E 100%)\" }}\n          >\n            <defs>\n              <filter id=\"stateShadow\" x=\"-20%\" y=\"-20%\" width=\"140%\" height=\"140%\">\n                <feDropShadow dx=\"1\" dy=\"1\" stdDeviation=\"2\" floodOpacity=\"0.3\" />\n              </filter>\n              <linearGradient id=\"oceanGradient\" x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\n                <stop offset=\"0%\" stopColor=\"#5DADE2\" />\n                <stop offset=\"50%\" stopColor=\"#3498DB\" />\n                <stop offset=\"100%\" stopColor=\"#2874A6\" />\n              </linearGradient>\n            </defs>\n            \n            <rect x=\"0\" y=\"0\" width=\"480\" height=\"450\" fill=\"url(#oceanGradient)\" />\n            \n            <g filter=\"url(#stateShadow)\">\n              {Object.entries(BRAZIL_STATES).map(([code, state]) => (\n                <path\n                  key={code}\n                  d={state.path}\n                  fill={getStateColor(code)}\n                  stroke={getStateBorderColor(code)}\n                  strokeWidth={hoveredState === code || selectedState === code ? \"2\" : \"1.2\"}\n                  strokeLinejoin=\"round\"\n                  className=\"cursor-pointer transition-all duration-150\"\n                  onMouseEnter={() => setHoveredState(code)}\n                  onMouseLeave={() => setHoveredState(null)}\n                  onClick={() => handleStateClick(code)}\n                  data-testid={`state-${code}`}\n                />\n              ))}\n            </g>\n            \n            {Object.entries(BRAZIL_STATES).map(([code, state]) => {\n              if (!state.labelX || !state.labelY) return null;\n              const isLargeState = [\"AM\", \"PA\", \"MT\", \"BA\", \"MG\", \"GO\", \"MS\", \"MA\", \"PI\", \"TO\", \"RO\", \"SP\", \"PR\", \"RS\", \"SC\"].includes(code);\n              if (!isLargeState) return null;\n              \n              return (\n                <text\n                  key={`label-${code}`}\n                  x={state.labelX}\n                  y={state.labelY}\n                  textAnchor=\"middle\"\n                  dominantBaseline=\"middle\"\n                  className=\"pointer-events-none select-none\"\n                  style={{\n                    fontSize: \"10px\",\n                    fontWeight: \"600\",\n                    fill: [\"MT\", \"GO\", \"MS\"].includes(code) ? \"#333\" : \"#fff\",\n                    textShadow: [\"MT\", \"GO\", \"MS\"].includes(code) \n                      ? \"0 0 2px rgba(255,255,255,0.8)\" \n                      : \"0 0 3px rgba(0,0,0,0.5)\"\n                  }}\n                >\n                  {code}\n                </text>\n              );\n            })}\n          </svg>\n          \n          {hoveredState && (\n            <div \n              className=\"absolute top-3 left-3 bg-card/95 backdrop-blur-sm border rounded-lg px-4 py-3 shadow-lg z-10\"\n              data-testid=\"state-tooltip\"\n            >\n              <div className=\"flex items-center gap-2 mb-1\">\n                <div \n                  className=\"w-3 h-3 rounded-full border border-white/50\"\n                  style={{ backgroundColor: getStateColor(hoveredState) }}\n                />\n                <span className=\"font-semibold text-foreground\">\n                  {BRAZIL_STATES[hoveredState]?.name}\n                </span>\n                <span className=\"text-muted-foreground\">({hoveredState})</span>\n              </div>\n              <div className=\"text-sm text-muted-foreground\">\n                Região {REGION_NAMES[BRAZIL_STATES[hoveredState]?.region]} - Capital: {BRAZIL_STATES[hoveredState]?.capital}\n              </div>\n            </div>\n          )}\n        </div>\n        \n        <div className=\"mt-4 flex flex-wrap justify-center gap-4\" data-testid=\"map-legend\">\n          {Object.entries(REGION_COLORS).map(([key, colors]) => (\n            <div key={key} className=\"flex items-center gap-2\">\n              <div \n                className=\"w-4 h-4 rounded border border-white/30\"\n                style={{ backgroundColor: colors.default }}\n              />\n              <span className=\"text-sm text-muted-foreground\">{REGION_NAMES[key]}</span>\n            </div>\n          ))}\n        </div>\n      </CardContent>\n\n      <Dialog open={showDialog} onOpenChange={setShowDialog} data-testid=\"dialog-state-summary\">\n        <DialogContent className=\"max-w-2xl max-h-[85vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-3\" data-testid=\"text-state-name\">\n              <Building2 className=\"h-5 w-5\" />\n              {selectedState && BRAZIL_STATES[selectedState]?.name} ({selectedState})\n              {selectedState && (\n                <Badge \n                  variant=\"secondary\"\n                  style={{ \n                    backgroundColor: REGION_COLORS[BRAZIL_STATES[selectedState]?.region]?.default,\n                    color: [\"centro-oeste\"].includes(BRAZIL_STATES[selectedState]?.region) ? \"#333\" : \"#fff\"\n                  }}\n                >\n                  {REGION_NAMES[BRAZIL_STATES[selectedState]?.region]}\n                </Badge>\n              )}\n            </DialogTitle>\n            <DialogDescription>\n              Resumo dos dados eleitorais do estado - Capital: {selectedState && BRAZIL_STATES[selectedState]?.capital}\n            </DialogDescription>\n          </DialogHeader>\n\n          {stateLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : stateData ? (\n            <div className=\"space-y-6\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <Card>\n                  <CardContent className=\"pt-4\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground mb-1\">\n                      <Users className=\"h-4 w-4\" />\n                      <span className=\"text-sm\">Total de Candidatos</span>\n                    </div>\n                    <p className=\"text-2xl font-bold\">{stateData.totalCandidates?.toLocaleString(\"pt-BR\") || 0}</p>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"pt-4\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground mb-1\">\n                      <TrendingUp className=\"h-4 w-4\" />\n                      <span className=\"text-sm\">Total de Votos</span>\n                    </div>\n                    <p className=\"text-2xl font-bold\">{stateData.totalVotes?.toLocaleString(\"pt-BR\") || 0}</p>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {stateData.topCandidates && stateData.topCandidates.length > 0 && (\n                <div>\n                  <h4 className=\"font-semibold flex items-center gap-2 mb-3\">\n                    <Users className=\"h-4 w-4\" />\n                    Candidatos Mais Votados\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {stateData.topCandidates.slice(0, 5).map((candidate, index) => (\n                      <div key={index} className=\"flex items-center justify-between p-2 bg-muted/50 rounded\">\n                        <div>\n                          <span className=\"font-medium\">{candidate.name}</span>\n                          <Badge variant=\"outline\" className=\"ml-2\">{candidate.party}</Badge>\n                        </div>\n                        <span className=\"text-muted-foreground\">\n                          {candidate.votes?.toLocaleString(\"pt-BR\")} votos\n                        </span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {stateData.topParties && stateData.topParties.length > 0 && (\n                <div>\n                  <h4 className=\"font-semibold flex items-center gap-2 mb-3\">\n                    <Building2 className=\"h-4 w-4\" />\n                    Partidos Mais Votados\n                  </h4>\n                  <div className=\"h-48\">\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\n                      <BarChart data={stateData.topParties.slice(0, 6)} layout=\"vertical\">\n                        <XAxis type=\"number\" tickFormatter={(v) => `${(v/1000).toFixed(0)}k`} />\n                        <YAxis type=\"category\" dataKey=\"abbreviation\" width={60} />\n                        <Tooltip \n                          formatter={(value: number) => [value.toLocaleString(\"pt-BR\") + \" votos\", \"Votos\"]}\n                          labelFormatter={(label) => `Partido: ${label}`}\n                        />\n                        <Bar dataKey=\"votes\" radius={[0, 4, 4, 0]}>\n                          {stateData.topParties.slice(0, 6).map((party, index) => (\n                            <Cell key={index} fill={party.color || `hsl(${index * 60}, 70%, 50%)`} />\n                          ))}\n                        </Bar>\n                      </BarChart>\n                    </ResponsiveContainer>\n                  </div>\n                </div>\n              )}\n\n              {(!stateData.topCandidates || stateData.topCandidates.length === 0) && \n               (!stateData.topParties || stateData.topParties.length === 0) && (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Building2 className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                  <p>Nenhum dado eleitoral disponível para este estado.</p>\n                  <p className=\"text-sm mt-1\">Importe dados do TSE para visualizar as estatísticas.</p>\n                </div>\n              )}\n            </div>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Building2 className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p>Nenhum dado disponível para este estado.</p>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </Card>\n  );\n}\n","path":null,"size_bytes":18905,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        success: {\n          DEFAULT: \"hsl(var(--success) / <alpha-value>)\",\n          foreground: \"hsl(var(--success-foreground) / <alpha-value>)\",\n        },\n        warning: {\n          DEFAULT: \"hsl(var(--warning) / <alpha-value>)\",\n          foreground: \"hsl(var(--warning-foreground) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4370,"size_tokens":null},"client/src/pages/audit.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { ClipboardList, Calendar, User, Eye, Filter } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { DataTable } from \"@/components/data-table\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport type { AuditLog, User as UserType } from \"@shared/schema\";\n\ntype AuditLogWithUser = AuditLog & { user?: UserType };\n\nexport default function Audit() {\n  const [selectedLog, setSelectedLog] = useState<AuditLogWithUser | null>(null);\n  const [actionFilter, setActionFilter] = useState<string>(\"all\");\n  const [entityFilter, setEntityFilter] = useState<string>(\"all\");\n\n  const { data: logs, isLoading } = useQuery<AuditLogWithUser[]>({\n    queryKey: [\"/api/audit\"],\n  });\n\n  const { data: users } = useQuery<UserType[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const actions = [\n    { value: \"all\", label: \"Todas as ações\" },\n    { value: \"create\", label: \"Criação\" },\n    { value: \"update\", label: \"Atualização\" },\n    { value: \"delete\", label: \"Exclusão\" },\n    { value: \"login\", label: \"Login\" },\n    { value: \"logout\", label: \"Logout\" },\n    { value: \"simulation\", label: \"Simulação\" },\n    { value: \"prediction\", label: \"Previsão IA\" },\n  ];\n\n  const entities = [\n    { value: \"all\", label: \"Todas as entidades\" },\n    { value: \"user\", label: \"Usuários\" },\n    { value: \"party\", label: \"Partidos\" },\n    { value: \"candidate\", label: \"Candidatos\" },\n    { value: \"scenario\", label: \"Cenários\" },\n    { value: \"simulation\", label: \"Simulações\" },\n    { value: \"session\", label: \"Sessões\" },\n  ];\n\n  const actionLabels: Record<string, string> = {\n    create: \"Criação\",\n    update: \"Atualização\",\n    delete: \"Exclusão\",\n    login: \"Login\",\n    logout: \"Logout\",\n    simulation: \"Simulação\",\n    prediction: \"Previsão IA\",\n  };\n\n  const actionVariants: Record<string, \"default\" | \"secondary\" | \"outline\" | \"destructive\"> = {\n    create: \"default\",\n    update: \"secondary\",\n    delete: \"destructive\",\n    login: \"outline\",\n    logout: \"outline\",\n    simulation: \"default\",\n    prediction: \"default\",\n  };\n\n  const entityLabels: Record<string, string> = {\n    user: \"Usuário\",\n    party: \"Partido\",\n    candidate: \"Candidato\",\n    scenario: \"Cenário\",\n    simulation: \"Simulação\",\n    session: \"Sessão\",\n  };\n\n  const filteredLogs = logs?.filter((log) => {\n    if (actionFilter !== \"all\" && log.action !== actionFilter) return false;\n    if (entityFilter !== \"all\" && log.entity !== entityFilter) return false;\n    return true;\n  });\n\n  const columns = [\n    {\n      key: \"createdAt\",\n      header: \"Data/Hora\",\n      sortable: true,\n      cell: (log: AuditLogWithUser) => (\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"font-mono text-sm\">\n            {new Date(log.createdAt).toLocaleString(\"pt-BR\")}\n          </span>\n        </div>\n      ),\n    },\n    {\n      key: \"user\",\n      header: \"Usuário\",\n      cell: (log: AuditLogWithUser) => {\n        const user = users?.find((u) => u.id === log.userId);\n        return (\n          <div className=\"flex items-center gap-2\">\n            <User className=\"h-4 w-4 text-muted-foreground\" />\n            <span>{user?.name || log.userId || \"Sistema\"}</span>\n          </div>\n        );\n      },\n    },\n    {\n      key: \"action\",\n      header: \"Ação\",\n      cell: (log: AuditLogWithUser) => (\n        <Badge variant={actionVariants[log.action] || \"outline\"}>\n          {actionLabels[log.action] || log.action}\n        </Badge>\n      ),\n    },\n    {\n      key: \"entity\",\n      header: \"Entidade\",\n      cell: (log: AuditLogWithUser) => (\n        <span>{entityLabels[log.entity] || log.entity}</span>\n      ),\n    },\n    {\n      key: \"entityId\",\n      header: \"ID\",\n      cell: (log: AuditLogWithUser) => (\n        <span className=\"font-mono text-sm text-muted-foreground\">\n          {log.entityId || \"-\"}\n        </span>\n      ),\n    },\n    {\n      key: \"actions\",\n      header: \"Detalhes\",\n      className: \"w-20\",\n      cell: (log: AuditLogWithUser) => (\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => setSelectedLog(log)}\n          data-testid={`button-view-log-${log.id}`}\n        >\n          <Eye className=\"h-4 w-4\" />\n        </Button>\n      ),\n    },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <PageHeader\n        title=\"Registro de Auditoria\"\n        description=\"Histórico completo de todas as operações realizadas no sistema\"\n        breadcrumbs={[\n          { label: \"Dashboard\", href: \"/\" },\n          { label: \"Auditoria\" },\n        ]}\n      />\n\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"flex flex-wrap items-end gap-4 mb-6\">\n            <div className=\"space-y-2\">\n              <Label className=\"flex items-center gap-1\">\n                <Filter className=\"h-3 w-3\" />\n                Ação\n              </Label>\n              <Select value={actionFilter} onValueChange={setActionFilter}>\n                <SelectTrigger className=\"w-48\" data-testid=\"select-audit-action\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {actions.map((action) => (\n                    <SelectItem key={action.value} value={action.value}>\n                      {action.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label className=\"flex items-center gap-1\">\n                <Filter className=\"h-3 w-3\" />\n                Entidade\n              </Label>\n              <Select value={entityFilter} onValueChange={setEntityFilter}>\n                <SelectTrigger className=\"w-48\" data-testid=\"select-audit-entity\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {entities.map((entity) => (\n                    <SelectItem key={entity.value} value={entity.value}>\n                      {entity.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setActionFilter(\"all\");\n                setEntityFilter(\"all\");\n              }}\n              data-testid=\"button-clear-filters\"\n            >\n              Limpar Filtros\n            </Button>\n          </div>\n\n          {!isLoading && (!filteredLogs || filteredLogs.length === 0) ? (\n            <EmptyState\n              icon={ClipboardList}\n              title=\"Nenhum registro encontrado\"\n              description=\"Não há registros de auditoria que correspondam aos filtros selecionados.\"\n            />\n          ) : (\n            <DataTable\n              data={filteredLogs || []}\n              columns={columns}\n              isLoading={isLoading}\n              searchable={false}\n              pageSize={15}\n              emptyMessage=\"Nenhum registro de auditoria\"\n            />\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={selectedLog !== null} onOpenChange={() => setSelectedLog(null)}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Detalhes do Registro</DialogTitle>\n            <DialogDescription>\n              ID: {selectedLog?.id} - {new Date(selectedLog?.createdAt || \"\").toLocaleString(\"pt-BR\")}\n            </DialogDescription>\n          </DialogHeader>\n          {selectedLog && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-muted-foreground\">Ação</Label>\n                  <p className=\"font-medium\">{actionLabels[selectedLog.action] || selectedLog.action}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Entidade</Label>\n                  <p className=\"font-medium\">{entityLabels[selectedLog.entity] || selectedLog.entity}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">ID da Entidade</Label>\n                  <p className=\"font-mono\">{selectedLog.entityId || \"-\"}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Usuário</Label>\n                  <p>{users?.find((u) => u.id === selectedLog.userId)?.name || selectedLog.userId || \"Sistema\"}</p>\n                </div>\n              </div>\n              {selectedLog.ipAddress && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Endereço IP</Label>\n                  <p className=\"font-mono\">{selectedLog.ipAddress}</p>\n                </div>\n              )}\n              {selectedLog.userAgent && (\n                <div>\n                  <Label className=\"text-muted-foreground\">User Agent</Label>\n                  <p className=\"text-sm text-muted-foreground truncate\">{selectedLog.userAgent}</p>\n                </div>\n              )}\n              {selectedLog.details && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Detalhes da Operação</Label>\n                  <pre className=\"mt-2 p-3 bg-muted rounded-md text-sm font-mono overflow-auto max-h-48\">\n                    {JSON.stringify(selectedLog.details, null, 2)}\n                  </pre>\n                </div>\n              )}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":10198,"size_tokens":null},"client/replit_integrations/audio/useVoiceRecorder.ts":{"content":"/**\n * React hook for voice recording using MediaRecorder API.\n * Records audio in WebM/Opus format for efficient streaming.\n */\nimport { useRef, useCallback, useState } from \"react\";\n\nexport type RecordingState = \"idle\" | \"recording\" | \"stopped\";\n\nexport function useVoiceRecorder() {\n  const [state, setState] = useState<RecordingState>(\"idle\");\n  const mediaRecorderRef = useRef<MediaRecorder | null>(null);\n  const chunksRef = useRef<Blob[]>([]);\n\n  const startRecording = useCallback(async (): Promise<void> => {\n    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n    const recorder = new MediaRecorder(stream, {\n      mimeType: \"audio/webm;codecs=opus\",\n    });\n\n    mediaRecorderRef.current = recorder;\n    chunksRef.current = [];\n\n    recorder.ondataavailable = (e) => {\n      if (e.data.size > 0) chunksRef.current.push(e.data);\n    };\n\n    recorder.start(100); // Collect chunks every 100ms\n    setState(\"recording\");\n  }, []);\n\n  const stopRecording = useCallback((): Promise<Blob> => {\n    return new Promise((resolve) => {\n      const recorder = mediaRecorderRef.current;\n      if (!recorder || recorder.state !== \"recording\") {\n        resolve(new Blob());\n        return;\n      }\n\n      recorder.onstop = () => {\n        const blob = new Blob(chunksRef.current, { type: \"audio/webm\" });\n        recorder.stream.getTracks().forEach((t) => t.stop());\n        setState(\"stopped\");\n        resolve(blob);\n      };\n\n      recorder.stop();\n    });\n  }, []);\n\n  return { state, startRecording, stopRecording };\n}\n\n","path":null,"size_bytes":1550,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/pages/tse-import.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Upload, FileText, CheckCircle, XCircle, Clock, Loader2, RefreshCw, Database, Link, Download, ShieldCheck, AlertTriangle, Info, StopCircle, RotateCcw, Trash2, FolderOpen, HardDrive, Layers, Wifi, WifiOff, Play, ChevronRight, RotateCw, FileSearch } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useImportWebSocket } from \"@/hooks/use-import-websocket\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Accordion,\n  AccordionContent,\n  AccordionItem,\n  AccordionTrigger,\n} from \"@/components/ui/accordion\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { PageHeader } from \"@/components/page-header\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport type { TseImportJob, TseImportError } from \"@shared/schema\";\n\ninterface ValidationStatus {\n  hasValidation: boolean;\n  runId?: number;\n  status?: string;\n  totalRecordsChecked?: number;\n  issuesFound?: number;\n  summary?: {\n    byType: Record<string, number>;\n    bySeverity: Record<string, number>;\n    sampleIssues: Array<{\n      type: string;\n      severity: string;\n      message: string;\n      suggestedFix?: {\n        action: string;\n        newValue?: string | number;\n        confidence: number;\n        reasoning: string;\n      };\n    }>;\n  };\n  aiAnalysis?: {\n    analysis?: string;\n    recommendations?: Array<{\n      issue: string;\n      severity: string;\n      suggestedAction: string;\n      confidence: number;\n    }>;\n    overallDataQuality?: {\n      score: number;\n      assessment: string;\n      keyFindings: string[];\n      risksIdentified: string[];\n    };\n  };\n  completedAt?: string;\n}\n\ninterface ValidationIssue {\n  id: number;\n  type: string;\n  severity: string;\n  category: string;\n  rowReference?: string;\n  field?: string;\n  currentValue?: string;\n  message: string;\n  suggestedFix?: {\n    action: string;\n    newValue?: string | number;\n    confidence: number;\n    reasoning: string;\n  };\n  status: string;\n}\n\ninterface QueueStatus {\n  isProcessing: boolean;\n  currentJob: number | null;\n  queueLength: number;\n  queue: Array<{\n    position: number;\n    jobId: number;\n    type: string;\n    isProcessing?: boolean;\n  }>;\n}\n\nconst UFS = [\n  \"AC\", \"AL\", \"AM\", \"AP\", \"BA\", \"CE\", \"DF\", \"ES\", \"GO\", \"MA\", \"MG\", \"MS\", \"MT\",\n  \"PA\", \"PB\", \"PE\", \"PI\", \"PR\", \"RJ\", \"RN\", \"RO\", \"RR\", \"RS\", \"SC\", \"SE\", \"SP\", \"TO\", \"BR\"\n];\n\nconst ELECTION_YEARS = Array.from({ length: 30 }, (_, i) => 2024 - i * 2).filter(y => y >= 1998);\n\nconst CARGOS = [\n  { code: 1, name: \"Presidente\" },\n  { code: 3, name: \"Governador\" },\n  { code: 5, name: \"Senador\" },\n  { code: 6, name: \"Deputado Federal\" },\n  { code: 7, name: \"Deputado Estadual\" },\n  { code: 8, name: \"Deputado Distrital\" },\n  { code: 11, name: \"Prefeito\" },\n  { code: 13, name: \"Vereador\" },\n];\n\nexport default function TseImport() {\n  const { hasPermission } = useAuth();\n  const { toast } = useToast();\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [electionYear, setElectionYear] = useState<string>(\"\");\n  const [uf, setUf] = useState<string>(\"\");\n  const [cargoFilter, setCargoFilter] = useState<string>(\"\");\n  const [errorsDialogJob, setErrorsDialogJob] = useState<TseImportJob | null>(null);\n  const [urlInput, setUrlInput] = useState<string>(\"\");\n  const [urlYear, setUrlYear] = useState<string>(\"\");\n  const [urlCargo, setUrlCargo] = useState<string>(\"\");\n  const [validationDialogJob, setValidationDialogJob] = useState<TseImportJob | null>(null);\n  const [validatingJobId, setValidatingJobId] = useState<number | null>(null);\n\n  const { data: jobs, isLoading: jobsLoading, refetch: refetchJobs } = useQuery<TseImportJob[]>({\n    queryKey: [\"/api/imports/tse\"],\n    refetchInterval: (query) => {\n      const data = query.state.data as TseImportJob[] | undefined;\n      const hasActive = data?.some(job => \n        [\"pending\", \"queued\", \"downloading\", \"extracting\", \"running\", \"processing\"].includes(job.status)\n      );\n      return hasActive ? 2000 : 10000;\n    },\n  });\n\n  const { data: stats } = useQuery<{\n    totalRecords: number;\n    years: number[];\n    ufs: string[];\n    cargos: { code: number; name: string }[];\n  }>({\n    queryKey: [\"/api/tse/stats\"],\n  });\n\n  const { data: jobErrors } = useQuery<TseImportError[]>({\n    queryKey: [\"/api/imports/tse\", errorsDialogJob?.id, \"errors\"],\n    enabled: !!errorsDialogJob,\n  });\n\n  const { data: validationStatus, refetch: refetchValidation, isLoading: validationLoading } = useQuery<ValidationStatus>({\n    queryKey: [\"/api/imports/tse\", validationDialogJob?.id, \"validation\"],\n    enabled: !!validationDialogJob,\n  });\n\n  const { data: validationIssues, isLoading: issuesLoading } = useQuery<ValidationIssue[]>({\n    queryKey: [\"/api/validation-runs\", validationStatus?.runId, \"issues\"],\n    enabled: !!validationStatus?.runId,\n  });\n\n  const { data: queueStatus } = useQuery<QueueStatus>({\n    queryKey: [\"/api/imports/tse/queue/status\"],\n    refetchInterval: (query) => {\n      const data = query.state.data as QueueStatus | undefined;\n      return data?.isProcessing || (data?.queueLength ?? 0) > 0 ? 2000 : 10000;\n    },\n  });\n\n  const [verifyingIntegrityJobId, setVerifyingIntegrityJobId] = useState<number | null>(null);\n  const [batchesDialogJob, setBatchesDialogJob] = useState<TseImportJob | null>(null);\n  const [reprocessingBatchId, setReprocessingBatchId] = useState<number | null>(null);\n  \n  // WebSocket for real-time updates\n  const { connected: wsConnected, lastEvent } = useImportWebSocket(true);\n  \n  // Show real-time connection status indicator\n  useEffect(() => {\n    if (lastEvent) {\n      console.log(\"WebSocket event:\", lastEvent);\n    }\n  }, [lastEvent]);\n\n  const runValidationMutation = useMutation({\n    mutationFn: async (jobId: number) => {\n      setValidatingJobId(jobId);\n      const response = await apiRequest(\"POST\", `/api/imports/tse/${jobId}/validation/run`);\n      return response.json();\n    },\n    onSuccess: async (_, jobId) => {\n      toast({ \n        title: \"Validação concluída\", \n        description: \"A análise dos dados foi realizada com sucesso.\" \n      });\n      await queryClient.invalidateQueries({ queryKey: [\"/api/imports/tse\", jobId, \"validation\"] });\n      if (validationDialogJob?.id === jobId) {\n        await refetchValidation();\n      }\n      setValidatingJobId(null);\n    },\n    onError: (error: Error) => {\n      toast({ \n        title: \"Erro na validação\", \n        description: error.message, \n        variant: \"destructive\" \n      });\n      setValidatingJobId(null);\n    },\n  });\n\n  const verifyIntegrityMutation = useMutation({\n    mutationFn: async (jobId: number) => {\n      setVerifyingIntegrityJobId(jobId);\n      const response = await apiRequest(\"POST\", `/api/imports/tse/${jobId}/validate-integrity`);\n      return response.json();\n    },\n    onSuccess: async (result, jobId) => {\n      toast({ \n        title: result.isValid ? \"Integridade OK\" : \"Discrepância detectada\",\n        description: result.validationMessage,\n        variant: result.isValid ? \"default\" : \"destructive\"\n      });\n      await queryClient.invalidateQueries({ queryKey: [\"/api/imports/tse\"] });\n      setVerifyingIntegrityJobId(null);\n    },\n    onError: (error: Error) => {\n      toast({ \n        title: \"Erro na verificação\", \n        description: error.message, \n        variant: \"destructive\" \n      });\n      setVerifyingIntegrityJobId(null);\n    },\n  });\n\n  const uploadMutation = useMutation({\n    mutationFn: async (formData: FormData) => {\n      const response = await fetch(\"/api/imports/tse\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        if (response.status === 409) {\n          throw new Error(error.message || \"Dados já importados\");\n        }\n        throw new Error(error.error || \"Upload failed\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Importação iniciada\", description: \"O arquivo está sendo processado em segundo plano.\" });\n      setSelectedFile(null);\n      setElectionYear(\"\");\n      setUf(\"\");\n      setCargoFilter(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/imports/tse\"] });\n    },\n    onError: (error: Error) => {\n      const isInProgress = error.message.includes(\"sendo processado\");\n      const isDuplicate = error.message.includes(\"já foi importado\");\n      toast({ \n        title: isInProgress ? \"Importação em andamento\" : (isDuplicate ? \"Dados já importados\" : \"Erro no upload\"), \n        description: error.message, \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const urlImportMutation = useMutation({\n    mutationFn: async (data: { url: string; electionYear?: string; cargoFilter?: string }) => {\n      const response = await fetch(\"/api/imports/tse/url\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        if (response.status === 409) {\n          throw new Error(error.message || \"Dados já importados\");\n        }\n        throw new Error(error.error || \"Falha na importação\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Download iniciado\", description: \"O arquivo está sendo baixado e processado.\" });\n      setUrlInput(\"\");\n      setUrlYear(\"\");\n      setUrlCargo(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/imports/tse\"] });\n    },\n    onError: (error: Error) => {\n      const isInProgress = error.message.includes(\"sendo processada\");\n      const isDuplicate = error.message.includes(\"já foram importados\");\n      toast({ \n        title: isInProgress ? \"Importação em andamento\" : (isDuplicate ? \"Dados já importados\" : \"Erro na importação\"), \n        description: error.message, \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  // Mutations for historical electoral data imports\n  const [historicalImportType, setHistoricalImportType] = useState<\"detalhe\" | \"partido\">(\"detalhe\");\n  const [historicalUrl, setHistoricalUrl] = useState(\"\");\n  const [historicalYear, setHistoricalYear] = useState(\"\");\n  const [historicalCargo, setHistoricalCargo] = useState(\"\");\n\n  const detalheImportMutation = useMutation({\n    mutationFn: async (data: { url: string; electionYear?: string; cargoFilter?: string; selectedFile?: string }) => {\n      const response = await fetch(\"/api/imports/tse/detalhe-votacao/url\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Import failed\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Importação iniciada\", description: \"Estatísticas eleitorais estão sendo importadas.\" });\n      setHistoricalUrl(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/imports/tse\"] });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro na importação\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const partidoImportMutation = useMutation({\n    mutationFn: async (data: { url: string; electionYear?: string; cargoFilter?: string; selectedFile?: string }) => {\n      const response = await fetch(\"/api/imports/tse/partido/url\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Import failed\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Importação iniciada\", description: \"Votos por partido estão sendo importados.\" });\n      setHistoricalUrl(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/imports/tse\"] });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro na importação\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  // File preview for selecting specific CSV file from ZIP\n  const [showFileSelector, setShowFileSelector] = useState(false);\n  const [availableFiles, setAvailableFiles] = useState<Array<{ path: string; name: string; size: number; isBrasil: boolean }>>([]);\n  const [selectedCsvFile, setSelectedCsvFile] = useState<string>(\"\");\n  const [pendingImportData, setPendingImportData] = useState<{ url: string; electionYear?: string; cargoFilter?: string } | null>(null);\n\n  const previewFilesMutation = useMutation({\n    mutationFn: async (url: string) => {\n      const response = await fetch(\"/api/imports/tse/preview-files\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ url }),\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to preview files\");\n      return response.json();\n    },\n    onSuccess: (result, url) => {\n      if (result.hasBrasilFile) {\n        // Has _BRASIL file, proceed directly with import\n        const data = {\n          url,\n          electionYear: historicalYear || undefined,\n          cargoFilter: historicalCargo && historicalCargo !== \"all\" ? historicalCargo : undefined,\n        };\n        if (historicalImportType === \"detalhe\") {\n          detalheImportMutation.mutate(data);\n        } else {\n          partidoImportMutation.mutate(data);\n        }\n      } else {\n        // No _BRASIL file, show file selector\n        setAvailableFiles(result.files);\n        setPendingImportData({\n          url,\n          electionYear: historicalYear || undefined,\n          cargoFilter: historicalCargo && historicalCargo !== \"all\" ? historicalCargo : undefined,\n        });\n        setShowFileSelector(true);\n      }\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro ao verificar arquivos\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const handleHistoricalImport = () => {\n    if (!historicalUrl) {\n      toast({ title: \"Digite uma URL\", variant: \"destructive\" });\n      return;\n    }\n    // First preview files to check for _BRASIL\n    previewFilesMutation.mutate(historicalUrl);\n  };\n\n  const handleFileSelection = () => {\n    if (!selectedCsvFile || !pendingImportData) {\n      toast({ title: \"Selecione um arquivo\", variant: \"destructive\" });\n      return;\n    }\n    const data = { ...pendingImportData, selectedFile: selectedCsvFile };\n    if (historicalImportType === \"detalhe\") {\n      detalheImportMutation.mutate(data);\n    } else {\n      partidoImportMutation.mutate(data);\n    }\n    setShowFileSelector(false);\n    setSelectedCsvFile(\"\");\n    setPendingImportData(null);\n  };\n\n  const generateHistoricalUrl = (year: string, type: \"detalhe\" | \"partido\") => {\n    if (type === \"detalhe\") {\n      return `https://cdn.tse.jus.br/estatistica/sead/odsele/detalhe_votacao_munzona/detalhe_votacao_munzona_${year}.zip`;\n    }\n    return `https://cdn.tse.jus.br/estatistica/sead/odsele/votacao_partido_munzona/votacao_partido_munzona_${year}.zip`;\n  };\n\n  const [activeTab, setActiveTab] = useState<\"imports\" | \"files\">(\"imports\");\n  const [cancellingJobId, setCancellingJobId] = useState<number | null>(null);\n  const [restartingJobId, setRestartingJobId] = useState<number | null>(null);\n  const [deletingJobId, setDeletingJobId] = useState<number | null>(null);\n  const [deletingFilesJobId, setDeletingFilesJobId] = useState<number | null>(null);\n\n  interface ImportFile {\n    jobId: number;\n    directory: string;\n    files: Array<{ name: string; size: number; modifiedAt: string }>;\n    totalSize: number;\n  }\n\n  const { data: importFiles, refetch: refetchFiles } = useQuery<ImportFile[]>({\n    queryKey: [\"/api/imports/files\"],\n    enabled: activeTab === \"files\",\n  });\n\n  const cancelJobMutation = useMutation({\n    mutationFn: async (jobId: number) => {\n      setCancellingJobId(jobId);\n      const response = await apiRequest(\"POST\", `/api/imports/tse/${jobId}/cancel`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Importação cancelada\", description: \"A importação foi cancelada com sucesso.\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/imports/tse\"] });\n      setCancellingJobId(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro ao cancelar\", description: error.message, variant: \"destructive\" });\n      setCancellingJobId(null);\n    },\n  });\n\n  const restartJobMutation = useMutation({\n    mutationFn: async (jobId: number) => {\n      setRestartingJobId(jobId);\n      const response = await apiRequest(\"POST\", `/api/imports/tse/${jobId}/restart`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Importação reiniciada\", description: \"A importação foi reiniciada com sucesso.\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/imports/tse\"] });\n      setRestartingJobId(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro ao reiniciar\", description: error.message, variant: \"destructive\" });\n      setRestartingJobId(null);\n    },\n  });\n\n  const deleteJobMutation = useMutation({\n    mutationFn: async (jobId: number) => {\n      setDeletingJobId(jobId);\n      const response = await apiRequest(\"DELETE\", `/api/imports/tse/${jobId}`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Importação excluída\", description: \"A importação e seus dados foram excluídos.\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/imports/tse\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tse/stats\"] });\n      setDeletingJobId(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro ao excluir\", description: error.message, variant: \"destructive\" });\n      setDeletingJobId(null);\n    },\n  });\n\n  const deleteFilesMutation = useMutation({\n    mutationFn: async (jobId: number) => {\n      setDeletingFilesJobId(jobId);\n      const response = await apiRequest(\"DELETE\", `/api/imports/files/${jobId}`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Arquivos excluídos\", description: \"Os arquivos temporários foram excluídos.\" });\n      refetchFiles();\n      setDeletingFilesJobId(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro ao excluir arquivos\", description: error.message, variant: \"destructive\" });\n      setDeletingFilesJobId(null);\n    },\n  });\n\n  // Query for batches when viewing batch dialog\n  interface BatchData {\n    batches: Array<{\n      id: number;\n      importJobId: number;\n      batchIndex: number;\n      status: string;\n      rowStart: number;\n      rowEnd: number;\n      totalRows: number;\n      processedRows: number | null;\n      insertedRows: number | null;\n      skippedRows: number | null;\n      errorCount: number | null;\n      errorSummary: string | null;\n      startedAt: string | null;\n      completedAt: string | null;\n    }>;\n    stats: {\n      total: number;\n      completed: number;\n      failed: number;\n      pending: number;\n      processing: number;\n      totalRows: number;\n      processedRows: number;\n      errorCount: number;\n    };\n  }\n\n  const { data: batchesData, refetch: refetchBatches, isLoading: batchesLoading } = useQuery<BatchData>({\n    queryKey: [\"/api/imports/tse\", batchesDialogJob?.id, \"batches\"],\n    enabled: !!batchesDialogJob,\n  });\n\n  const reprocessBatchMutation = useMutation({\n    mutationFn: async ({ jobId, batchId }: { jobId: number; batchId: number }) => {\n      setReprocessingBatchId(batchId);\n      const response = await apiRequest(\"POST\", `/api/imports/tse/${jobId}/batches/${batchId}/reprocess`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Reprocessamento iniciado\", description: \"O lote está sendo reprocessado.\" });\n      refetchBatches();\n      setReprocessingBatchId(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro no reprocessamento\", description: error.message, variant: \"destructive\" });\n      setReprocessingBatchId(null);\n    },\n  });\n\n  const reprocessAllFailedMutation = useMutation({\n    mutationFn: async (jobId: number) => {\n      const response = await apiRequest(\"POST\", `/api/imports/tse/${jobId}/batches/reprocess-all-failed`);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      toast({ \n        title: \"Reprocessamento em lote iniciado\", \n        description: `${data.batchCount} lotes estão sendo reprocessados.` \n      });\n      refetchBatches();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro no reprocessamento\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const isJobInProgress = (status: string) => {\n    return [\"pending\", \"queued\", \"downloading\", \"extracting\", \"processing\", \"running\"].includes(status);\n  };\n\n  const isJobRestartable = (status: string) => {\n    return [\"failed\", \"cancelled\"].includes(status);\n  };\n\n  const handleUrlImport = () => {\n    if (!urlInput) {\n      toast({ title: \"Digite uma URL\", variant: \"destructive\" });\n      return;\n    }\n    urlImportMutation.mutate({ \n      url: urlInput, \n      electionYear: urlYear || undefined,\n      cargoFilter: urlCargo && urlCargo !== \"all\" ? urlCargo : undefined\n    });\n  };\n\n  const generateTseUrl = (year: string) => {\n    return `https://cdn.tse.jus.br/estatistica/sead/odsele/votacao_candidato_munzona/votacao_candidato_munzona_${year}.zip`;\n  };\n\n  const handleQuickImport = (year: string) => {\n    const url = generateTseUrl(year);\n    setUrlInput(url);\n    setUrlYear(year);\n  };\n\n  const handleUpload = () => {\n    if (!selectedFile) {\n      toast({ title: \"Selecione um arquivo\", variant: \"destructive\" });\n      return;\n    }\n\n    const formData = new FormData();\n    formData.append(\"file\", selectedFile);\n    if (electionYear) formData.append(\"electionYear\", electionYear);\n    if (uf) formData.append(\"uf\", uf);\n    if (cargoFilter && cargoFilter !== \"all\") formData.append(\"cargoFilter\", cargoFilter);\n\n    uploadMutation.mutate(formData);\n  };\n\n  const getQueueInfo = (jobId: number): { position: number | null; isProcessing: boolean } => {\n    if (!queueStatus) return { position: null, isProcessing: false };\n    const item = queueStatus.queue.find(q => q.jobId === jobId);\n    if (!item) return { position: null, isProcessing: false };\n    return { \n      position: item.position > 0 ? item.position : null, \n      isProcessing: item.isProcessing ?? false \n    };\n  };\n\n  const getStatusBadge = (status: string, jobId?: number) => {\n    const queueInfo = jobId ? getQueueInfo(jobId) : { position: null, isProcessing: false };\n    \n    switch (status) {\n      case \"pending\":\n        if (queueInfo.isProcessing) {\n          return <Badge variant=\"default\"><Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />Iniciando...</Badge>;\n        }\n        if (queueInfo.position !== null) {\n          return <Badge variant=\"secondary\"><Clock className=\"h-3 w-3 mr-1\" />Na fila ({queueInfo.position}º)</Badge>;\n        }\n        return <Badge variant=\"secondary\"><Clock className=\"h-3 w-3 mr-1\" />Pendente</Badge>;\n      case \"queued\":\n        if (queueInfo.position !== null) {\n          return <Badge variant=\"secondary\"><Clock className=\"h-3 w-3 mr-1\" />Na fila ({queueInfo.position}º)</Badge>;\n        }\n        return <Badge variant=\"secondary\"><Clock className=\"h-3 w-3 mr-1\" />Na fila</Badge>;\n      case \"downloading\":\n        return <Badge variant=\"default\"><Download className=\"h-3 w-3 mr-1 animate-pulse\" />Baixando</Badge>;\n      case \"extracting\":\n        return <Badge variant=\"default\"><Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />Extraindo</Badge>;\n      case \"running\":\n      case \"processing\":\n        return <Badge variant=\"default\"><Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />Processando</Badge>;\n      case \"completed\":\n        return <Badge variant=\"outline\" className=\"text-green-600 border-green-600\"><CheckCircle className=\"h-3 w-3 mr-1\" />Concluído</Badge>;\n      case \"failed\":\n        return <Badge variant=\"destructive\"><XCircle className=\"h-3 w-3 mr-1\" />Falhou</Badge>;\n      case \"cancelled\":\n        return <Badge variant=\"secondary\"><StopCircle className=\"h-3 w-3 mr-1\" />Cancelado</Badge>;\n      default:\n        return <Badge variant=\"secondary\">{status}</Badge>;\n    }\n  };\n\n  const formatElapsedTime = (startDate: string | Date | null) => {\n    if (!startDate) return \"\";\n    const start = new Date(startDate).getTime();\n    const now = Date.now();\n    const elapsed = Math.floor((now - start) / 1000);\n    \n    if (elapsed < 60) return `${elapsed}s`;\n    if (elapsed < 3600) return `${Math.floor(elapsed / 60)}m ${elapsed % 60}s`;\n    return `${Math.floor(elapsed / 3600)}h ${Math.floor((elapsed % 3600) / 60)}m`;\n  };\n\n  const calculateProcessingSpeed = (job: TseImportJob) => {\n    if (!job.startedAt || !job.processedRows) return null;\n    const startTime = new Date(job.startedAt).getTime();\n    const now = Date.now();\n    const elapsedSeconds = (now - startTime) / 1000;\n    if (elapsedSeconds < 1) return null;\n    return Math.round(job.processedRows / elapsedSeconds);\n  };\n\n  const calculateETA = (job: TseImportJob, speed: number | null) => {\n    if (!speed || speed === 0) return null;\n    const totalRows = job.totalFileRows || job.totalRows || 0;\n    const processed = job.processedRows || 0;\n    const skipped = job.skippedRows || 0;\n    const remaining = Math.max(0, totalRows - processed - skipped);\n    if (remaining === 0) return null;\n    const seconds = Math.round(remaining / speed);\n    if (seconds < 60) return `~${seconds}s`;\n    if (seconds < 3600) return `~${Math.round(seconds / 60)}min`;\n    return `~${Math.floor(seconds / 3600)}h ${Math.round((seconds % 3600) / 60)}min`;\n  };\n\n  const getStageDescription = (job: TseImportJob) => {\n    const stage = job.stage || job.status;\n    switch (stage) {\n      case \"pending\": return \"Aguardando início\";\n      case \"downloading\": return \"Baixando arquivo...\";\n      case \"extracting\": return \"Extraindo ZIP...\";\n      case \"counting\": return \"Contando registros...\";\n      case \"processing\": return \"Processando dados...\";\n      case \"inserting\": return \"Inserindo no banco...\";\n      case \"validating\": return \"Validando dados...\";\n      case \"running\": return \"Processando...\";\n      default: return stage;\n    }\n  };\n\n  const getProgressDisplay = (job: TseImportJob) => {\n    const downloadedBytes = Number(job.downloadedBytes) || 0;\n    const speed = calculateProcessingSpeed(job);\n    const eta = calculateETA(job, speed);\n    \n    if (job.status === \"downloading\") {\n      if (job.fileSize > 0) {\n        const percent = Math.min(100, (downloadedBytes / job.fileSize) * 100);\n        const downloadSpeed = job.startedAt \n          ? Math.round(downloadedBytes / ((Date.now() - new Date(job.startedAt).getTime()) / 1000))\n          : 0;\n        return (\n          <div className=\"w-44 space-y-1\">\n            <Progress value={percent} className=\"h-2\" />\n            <div className=\"flex justify-between text-xs text-muted-foreground\">\n              <span className=\"font-medium\">{percent.toFixed(0)}%</span>\n              <span>{formatFileSize(downloadedBytes)} / {formatFileSize(job.fileSize)}</span>\n            </div>\n            <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n              {downloadSpeed > 0 && (\n                <span className=\"flex items-center gap-1\">\n                  <Download className=\"h-3 w-3\" />\n                  {formatFileSize(downloadSpeed)}/s\n                </span>\n              )}\n              {job.startedAt && <span>{formatElapsedTime(job.startedAt)}</span>}\n            </div>\n          </div>\n        );\n      }\n      return (\n        <div className=\"w-44 space-y-1\">\n          <Progress value={0} className=\"h-2 animate-pulse\" />\n          <p className=\"text-xs text-muted-foreground\">Iniciando download...</p>\n        </div>\n      );\n    }\n\n    if (job.status === \"extracting\") {\n      return (\n        <div className=\"w-44 space-y-1\">\n          <Progress value={100} className=\"h-2 animate-pulse\" />\n          <p className=\"text-xs text-muted-foreground font-medium\">Extraindo ZIP...</p>\n          {job.startedAt && (\n            <p className=\"text-xs text-muted-foreground\">{formatElapsedTime(job.startedAt)}</p>\n          )}\n        </div>\n      );\n    }\n\n    if (job.status === \"running\" || job.status === \"processing\") {\n      const processed = job.processedRows || 0;\n      const skipped = job.skippedRows || 0;\n      const totalRows = job.totalFileRows || job.totalRows || 0;\n      const totalProcessed = processed + skipped;\n      const percent = totalRows > 0 ? Math.min(100, (totalProcessed / totalRows) * 100) : 0;\n      \n      return (\n        <div className=\"w-44 space-y-1\">\n          {totalRows > 0 ? (\n            <>\n              <Progress value={percent} className=\"h-2\" />\n              <div className=\"flex justify-between text-xs\">\n                <span className=\"font-medium text-primary\">{percent.toFixed(1)}%</span>\n                <span className=\"text-muted-foreground\">\n                  {totalProcessed.toLocaleString(\"pt-BR\")} / {totalRows.toLocaleString(\"pt-BR\")}\n                </span>\n              </div>\n            </>\n          ) : (\n            <div className=\"flex items-center gap-1\">\n              <Loader2 className=\"h-3 w-3 animate-spin text-primary\" />\n              <span className=\"text-sm font-medium\">{processed.toLocaleString(\"pt-BR\")}</span>\n            </div>\n          )}\n          \n          <div className=\"flex flex-wrap gap-x-2 gap-y-0.5 text-xs text-muted-foreground\">\n            {speed && speed > 0 && (\n              <span className=\"flex items-center gap-0.5\">\n                <Play className=\"h-3 w-3\" />\n                {speed.toLocaleString(\"pt-BR\")}/s\n              </span>\n            )}\n            {eta && (\n              <span className=\"flex items-center gap-0.5\">\n                <Clock className=\"h-3 w-3\" />\n                {eta}\n              </span>\n            )}\n          </div>\n          \n          <div className=\"flex flex-wrap gap-x-2 gap-y-0.5 text-xs\">\n            {processed > 0 && (\n              <span className=\"text-green-600\">{processed.toLocaleString(\"pt-BR\")} inseridas</span>\n            )}\n            {skipped > 0 && (\n              <span className=\"text-amber-600\">{skipped.toLocaleString(\"pt-BR\")} ignoradas</span>\n            )}\n          </div>\n          \n          <p className=\"text-xs text-muted-foreground italic truncate\">\n            {getStageDescription(job)}\n          </p>\n        </div>\n      );\n    }\n\n    if (job.status === \"completed\") {\n      const duration = job.startedAt && job.completedAt \n        ? Math.floor((new Date(job.completedAt).getTime() - new Date(job.startedAt).getTime()) / 1000)\n        : null;\n      const processed = job.processedRows || 0;\n      const skipped = job.skippedRows || 0;\n      const avgSpeed = duration && duration > 0 ? Math.round((processed + skipped) / duration) : null;\n      const allDuplicates = processed === 0 && skipped > 0;\n      \n      return (\n        <div className=\"w-44 space-y-1\">\n          <div className=\"flex items-center gap-1\">\n            {allDuplicates ? (\n              <>\n                <AlertTriangle className=\"h-4 w-4 text-amber-500\" />\n                <span className=\"text-sm font-medium text-amber-600\">Já importado</span>\n              </>\n            ) : (\n              <>\n                <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                <span className=\"text-sm font-medium text-green-600\">Concluído</span>\n              </>\n            )}\n          </div>\n          <div className=\"flex flex-wrap gap-x-2 text-xs\">\n            {processed > 0 && (\n              <span className=\"text-green-600\">{processed.toLocaleString(\"pt-BR\")} inseridas</span>\n            )}\n            {skipped > 0 && (\n              <span className={allDuplicates ? \"text-amber-600\" : \"text-muted-foreground\"}>\n                {skipped.toLocaleString(\"pt-BR\")} {allDuplicates ? \"duplicadas\" : \"ignoradas\"}\n              </span>\n            )}\n          </div>\n          {job.validationMessage && (\n            <p className=\"text-xs text-muted-foreground italic truncate\" title={job.validationMessage}>\n              {job.validationMessage.substring(0, 50)}...\n            </p>\n          )}\n          {!job.validationMessage && duration !== null && (\n            <p className=\"text-xs text-muted-foreground\">\n              {duration < 60 ? `${duration}s` : `${Math.floor(duration / 60)}m ${duration % 60}s`}\n              {avgSpeed && ` • ${avgSpeed.toLocaleString(\"pt-BR\")}/s`}\n            </p>\n          )}\n        </div>\n      );\n    }\n\n    if (job.status === \"failed\") {\n      return (\n        <div className=\"w-44 space-y-1\">\n          <div className=\"flex items-center gap-1\">\n            <XCircle className=\"h-4 w-4 text-destructive\" />\n            <span className=\"text-sm font-medium text-destructive\">Erro</span>\n          </div>\n          {(job.processedRows || 0) > 0 && (\n            <p className=\"text-xs text-muted-foreground\">\n              {(job.processedRows || 0).toLocaleString(\"pt-BR\")} processadas\n            </p>\n          )}\n        </div>\n      );\n    }\n\n    if (job.status === \"pending\") {\n      return (\n        <div className=\"w-44 space-y-1\">\n          <div className=\"flex items-center gap-1\">\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"text-sm text-muted-foreground\">Aguardando</span>\n          </div>\n        </div>\n      );\n    }\n\n    return <span className=\"text-sm text-muted-foreground\">-</span>;\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n    return `${(bytes / (1024 * 1024 * 1024)).toFixed(2)} GB`;\n  };\n\n  const formatDate = (date: string | Date | null) => {\n    if (!date) return \"-\";\n    return new Date(date).toLocaleString(\"pt-BR\");\n  };\n\n  if (!hasPermission(\"manage_users\")) {\n    return (\n      <div className=\"p-6\">\n        <Card>\n          <CardContent className=\"p-6\">\n            <p className=\"text-muted-foreground\">Acesso restrito a administradores.</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <PageHeader\n          title=\"Importação de Dados TSE\"\n          description=\"Importe dados de candidatos de eleições passadas a partir dos arquivos CSV do TSE\"\n        />\n        <div className=\"flex items-center gap-2\">\n          {wsConnected ? (\n            <Badge variant=\"outline\" className=\"text-green-600 border-green-600\">\n              <Wifi className=\"h-3 w-3 mr-1\" />\n              Tempo Real\n            </Badge>\n          ) : (\n            <Badge variant=\"secondary\">\n              <WifiOff className=\"h-3 w-3 mr-1\" />\n              Offline\n            </Badge>\n          )}\n        </div>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Upload className=\"h-5 w-5\" />\n              Upload de Arquivo CSV\n            </CardTitle>\n            <CardDescription>\n              Selecione um arquivo CSV do repositório de dados abertos do TSE. \n              O arquivo deve estar no formato padrão com codificação Latin-1.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"file\">Arquivo CSV</Label>\n              <Input\n                id=\"file\"\n                type=\"file\"\n                accept=\".csv\"\n                onChange={(e) => setSelectedFile(e.target.files?.[0] || null)}\n                data-testid=\"input-csv-file\"\n              />\n              {selectedFile && (\n                <p className=\"text-sm text-muted-foreground\">\n                  {selectedFile.name} ({formatFileSize(selectedFile.size)})\n                </p>\n              )}\n            </div>\n\n            <div className=\"grid gap-4 sm:grid-cols-2\">\n              <div className=\"space-y-2\">\n                <Label>Ano da Eleição (opcional)</Label>\n                <Select value={electionYear} onValueChange={setElectionYear}>\n                  <SelectTrigger data-testid=\"select-election-year\">\n                    <SelectValue placeholder=\"Selecione o ano\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {ELECTION_YEARS.map((year) => (\n                      <SelectItem key={year} value={String(year)}>{year}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>UF (opcional)</Label>\n                <Select value={uf} onValueChange={setUf}>\n                  <SelectTrigger data-testid=\"select-uf\">\n                    <SelectValue placeholder=\"Selecione a UF\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {UFS.map((u) => (\n                      <SelectItem key={u} value={u}>{u}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Cargo (opcional)</Label>\n              <Select value={cargoFilter} onValueChange={setCargoFilter}>\n                <SelectTrigger data-testid=\"select-cargo\">\n                  <SelectValue placeholder=\"Todos os cargos\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Todos os cargos</SelectItem>\n                  {CARGOS.map((cargo) => (\n                    <SelectItem key={cargo.code} value={String(cargo.code)}>{cargo.name}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <p className=\"text-xs text-muted-foreground\">\n                Selecione para importar apenas dados de um cargo específico\n              </p>\n            </div>\n\n            <Button\n              onClick={handleUpload}\n              disabled={!selectedFile || uploadMutation.isPending}\n              className=\"w-full\"\n              data-testid=\"button-upload\"\n            >\n              {uploadMutation.isPending ? (\n                <><Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />Enviando...</>\n              ) : (\n                <><Upload className=\"h-4 w-4 mr-2\" />Iniciar Importação</>\n              )}\n            </Button>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Link className=\"h-5 w-5\" />\n              Importar via URL do TSE\n            </CardTitle>\n            <CardDescription>\n              Baixe e importe arquivos ZIP diretamente do repositório do TSE\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label>Importação Rápida</Label>\n              <div className=\"flex flex-wrap gap-2\">\n                {[2024, 2022, 2020, 2018].map((year) => (\n                  <Button\n                    key={year}\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleQuickImport(String(year))}\n                    data-testid={`button-quick-import-${year}`}\n                  >\n                    {year}\n                  </Button>\n                ))}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"url-input\">URL do Arquivo ZIP</Label>\n              <Input\n                id=\"url-input\"\n                type=\"url\"\n                placeholder=\"https://cdn.tse.jus.br/estatistica/...\"\n                value={urlInput}\n                onChange={(e) => setUrlInput(e.target.value)}\n                data-testid=\"input-tse-url\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Cole a URL de um arquivo .zip do repositório de dados abertos do TSE\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Ano da Eleição</Label>\n              <Select value={urlYear} onValueChange={setUrlYear}>\n                <SelectTrigger data-testid=\"select-url-year\">\n                  <SelectValue placeholder=\"Selecione o ano\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {ELECTION_YEARS.map((year) => (\n                    <SelectItem key={year} value={String(year)}>{year}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Cargo (opcional)</Label>\n              <Select value={urlCargo} onValueChange={setUrlCargo}>\n                <SelectTrigger data-testid=\"select-url-cargo\">\n                  <SelectValue placeholder=\"Todos os cargos\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Todos os cargos</SelectItem>\n                  {CARGOS.map((cargo) => (\n                    <SelectItem key={cargo.code} value={String(cargo.code)}>{cargo.name}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <p className=\"text-xs text-muted-foreground\">\n                Selecione para importar apenas dados de um cargo específico\n              </p>\n            </div>\n\n            <Button\n              onClick={handleUrlImport}\n              disabled={!urlInput || urlImportMutation.isPending}\n              className=\"w-full\"\n              data-testid=\"button-import-url\"\n            >\n              {urlImportMutation.isPending ? (\n                <><Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />Iniciando...</>\n              ) : (\n                <><Download className=\"h-4 w-4 mr-2\" />Baixar e Importar</>\n              )}\n            </Button>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Layers className=\"h-5 w-5\" />\n              Importar Dados Eleitorais Históricos\n            </CardTitle>\n            <CardDescription>\n              Importe estatísticas de votação e votos por partido para cálculo preciso de distribuição de vagas\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label>Tipo de Arquivo</Label>\n              <Select value={historicalImportType} onValueChange={(v) => setHistoricalImportType(v as \"detalhe\" | \"partido\")}>\n                <SelectTrigger data-testid=\"select-historical-type\">\n                  <SelectValue placeholder=\"Selecione o tipo\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"detalhe\">Detalhe Votação (Totais: aptos, votos válidos, brancos, nulos)</SelectItem>\n                  <SelectItem value=\"partido\">Votação Partido (Votos por partido/legenda)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Importação Rápida</Label>\n              <div className=\"flex flex-wrap gap-2\">\n                {[2024, 2022, 2020, 2018, 2016].map((year) => (\n                  <Button\n                    key={year}\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={() => {\n                      setHistoricalUrl(generateHistoricalUrl(String(year), historicalImportType));\n                      setHistoricalYear(String(year));\n                    }}\n                    data-testid={`button-historical-quick-${year}`}\n                  >\n                    {year}\n                  </Button>\n                ))}\n              </div>\n              <p className=\"text-xs text-muted-foreground\">\n                {historicalImportType === \"detalhe\" \n                  ? \"Dados de totais: eleitores aptos, comparecimento, votos válidos, brancos, nulos\"\n                  : \"Dados de votos: votos nominais e de legenda por partido, federações e coligações\"}\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>URL do Arquivo</Label>\n              <Input\n                placeholder=\"https://cdn.tse.jus.br/estatistica/sead/odsele/...\"\n                value={historicalUrl}\n                onChange={(e) => setHistoricalUrl(e.target.value)}\n                data-testid=\"input-historical-url\"\n              />\n            </div>\n\n            <div className=\"grid gap-4 sm:grid-cols-2\">\n              <div className=\"space-y-2\">\n                <Label>Ano da Eleição</Label>\n                <Input\n                  placeholder=\"Ex: 2022\"\n                  value={historicalYear}\n                  onChange={(e) => setHistoricalYear(e.target.value)}\n                  data-testid=\"input-historical-year\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Filtrar por Cargo</Label>\n                <Select value={historicalCargo} onValueChange={setHistoricalCargo}>\n                  <SelectTrigger data-testid=\"select-historical-cargo\">\n                    <SelectValue placeholder=\"Todos os cargos\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos os cargos</SelectItem>\n                    <SelectItem value=\"13\">Vereador (13)</SelectItem>\n                    <SelectItem value=\"11\">Prefeito (11)</SelectItem>\n                    <SelectItem value=\"7\">Deputado Federal (7)</SelectItem>\n                    <SelectItem value=\"8\">Deputado Estadual (8)</SelectItem>\n                    <SelectItem value=\"5\">Senador (5)</SelectItem>\n                    <SelectItem value=\"3\">Governador (3)</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <Button\n              onClick={handleHistoricalImport}\n              disabled={!historicalUrl || detalheImportMutation.isPending || partidoImportMutation.isPending || previewFilesMutation.isPending}\n              className=\"w-full\"\n              data-testid=\"button-import-historical\"\n            >\n              {previewFilesMutation.isPending ? (\n                <><Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />Verificando arquivos...</>\n              ) : (detalheImportMutation.isPending || partidoImportMutation.isPending) ? (\n                <><Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />Iniciando...</>\n              ) : (\n                <><Download className=\"h-4 w-4 mr-2\" />Importar Dados Históricos</>\n              )}\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* File Selection Dialog */}\n      {showFileSelector && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\" data-testid=\"dialog-file-selector\">\n          <Card className=\"w-full max-w-lg mx-4\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <FileSearch className=\"h-5 w-5\" />\n                Selecionar Arquivo CSV\n              </CardTitle>\n              <CardDescription>\n                O arquivo consolidado _BRASIL não foi encontrado. Selecione um dos arquivos disponíveis:\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"max-h-60 overflow-y-auto space-y-2\">\n                {availableFiles.map((file) => (\n                  <label \n                    key={file.path} \n                    className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors ${\n                      selectedCsvFile === file.path ? \"border-primary bg-primary/5\" : \"border-border hover:bg-muted\"\n                    }`}\n                    data-testid={`file-option-${file.name}`}\n                  >\n                    <input\n                      type=\"radio\"\n                      name=\"selectedCsvFile\"\n                      value={file.path}\n                      checked={selectedCsvFile === file.path}\n                      onChange={(e) => setSelectedCsvFile(e.target.value)}\n                      className=\"sr-only\"\n                    />\n                    <FileText className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium truncate\">{file.name}</p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {(file.size / 1024 / 1024).toFixed(2)} MB\n                      </p>\n                    </div>\n                    {selectedCsvFile === file.path && (\n                      <CheckCircle className=\"h-4 w-4 text-primary flex-shrink-0\" />\n                    )}\n                  </label>\n                ))}\n              </div>\n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => {\n                    setShowFileSelector(false);\n                    setSelectedCsvFile(\"\");\n                    setPendingImportData(null);\n                  }}\n                  className=\"flex-1\"\n                  data-testid=\"button-cancel-file-selection\"\n                >\n                  Cancelar\n                </Button>\n                <Button\n                  onClick={handleFileSelection}\n                  disabled={!selectedCsvFile}\n                  className=\"flex-1\"\n                  data-testid=\"button-confirm-file-selection\"\n                >\n                  <Download className=\"h-4 w-4 mr-2\" />\n                  Importar Arquivo\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      <div className=\"grid gap-6 md:grid-cols-1\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Database className=\"h-5 w-5\" />\n              Dados Importados\n            </CardTitle>\n            <CardDescription>\n              Estatísticas dos dados já importados no sistema\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {stats ? (\n              <div className=\"space-y-4\">\n                <div className=\"text-center p-4 bg-muted rounded-lg\">\n                  <p className=\"text-3xl font-bold font-mono\">{stats.totalRecords.toLocaleString(\"pt-BR\")}</p>\n                  <p className=\"text-sm text-muted-foreground\">Registros totais</p>\n                </div>\n                <div className=\"grid gap-2 sm:grid-cols-3\">\n                  <div className=\"text-center p-2 border rounded\">\n                    <p className=\"font-bold\">{stats.years.length}</p>\n                    <p className=\"text-xs text-muted-foreground\">Anos</p>\n                  </div>\n                  <div className=\"text-center p-2 border rounded\">\n                    <p className=\"font-bold\">{stats.ufs.length}</p>\n                    <p className=\"text-xs text-muted-foreground\">UFs</p>\n                  </div>\n                  <div className=\"text-center p-2 border rounded\">\n                    <p className=\"font-bold\">{stats.cargos.length}</p>\n                    <p className=\"text-xs text-muted-foreground\">Cargos</p>\n                  </div>\n                </div>\n                {stats.years.length > 0 && (\n                  <div>\n                    <p className=\"text-sm font-medium mb-1\">Anos disponíveis:</p>\n                    <div className=\"flex flex-wrap gap-1\">\n                      {stats.years.slice(0, 10).map((year) => (\n                        <Badge key={year} variant=\"outline\">{year}</Badge>\n                      ))}\n                      {stats.years.length > 10 && (\n                        <Badge variant=\"secondary\">+{stats.years.length - 10}</Badge>\n                      )}\n                    </div>\n                  </div>\n                )}\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Database className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                <p>Nenhum dado importado ainda</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as \"imports\" | \"files\")} className=\"w-full\">\n        <TabsList className=\"grid w-full max-w-md grid-cols-2\">\n          <TabsTrigger value=\"imports\" className=\"flex items-center gap-2\" data-testid=\"tab-imports\">\n            <FileText className=\"h-4 w-4\" />\n            Importações\n          </TabsTrigger>\n          <TabsTrigger value=\"files\" className=\"flex items-center gap-2\" data-testid=\"tab-files\">\n            <HardDrive className=\"h-4 w-4\" />\n            Arquivos\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"imports\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n              <div>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <FileText className=\"h-5 w-5\" />\n                  Histórico de Importações\n                </CardTitle>\n                <CardDescription>\n                  Acompanhe o status das importações em andamento e concluídas\n                </CardDescription>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                {queueStatus && (queueStatus.isProcessing || queueStatus.queueLength > 0) && (\n                  <Badge variant=\"outline\" className=\"text-blue-600 border-blue-600\">\n                    <Layers className=\"h-3 w-3 mr-1\" />\n                    Fila: {queueStatus.queueLength} aguardando\n                  </Badge>\n                )}\n                <Button variant=\"outline\" size=\"sm\" onClick={() => refetchJobs()} data-testid=\"button-refresh\">\n                  <RefreshCw className=\"h-4 w-4 mr-2\" />\n                  Atualizar\n                </Button>\n              </div>\n            </CardHeader>\n        <CardContent>\n          {jobsLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : jobs && jobs.length > 0 ? (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Arquivo</TableHead>\n                  <TableHead>Tamanho</TableHead>\n                  <TableHead>Ano</TableHead>\n                  <TableHead>UF</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead>Progresso</TableHead>\n                  <TableHead>Erros</TableHead>\n                  <TableHead>Integridade</TableHead>\n                  <TableHead>Validação IA</TableHead>\n                  <TableHead>Criado em</TableHead>\n                  <TableHead>Ações</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {jobs.map((job) => (\n                  <TableRow key={job.id}>\n                    <TableCell className=\"font-medium max-w-[200px] truncate\" title={job.filename}>\n                      {job.filename}\n                    </TableCell>\n                    <TableCell>{formatFileSize(job.fileSize)}</TableCell>\n                    <TableCell>{job.electionYear || \"-\"}</TableCell>\n                    <TableCell>{job.uf || \"-\"}</TableCell>\n                    <TableCell>{getStatusBadge(job.status, job.id)}</TableCell>\n                    <TableCell>\n                      {getProgressDisplay(job)}\n                    </TableCell>\n                    <TableCell>\n                      {(job.errorCount || 0) > 0 ? (\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          className=\"text-destructive\"\n                          onClick={() => setErrorsDialogJob(job)}\n                          data-testid={`button-view-errors-${job.id}`}\n                        >\n                          {job.errorCount} erros\n                        </Button>\n                      ) : (\n                        <span className=\"text-sm text-muted-foreground\">0</span>\n                      )}\n                    </TableCell>\n                    <TableCell>\n                      {job.status === \"completed\" ? (\n                        <div className=\"flex items-center gap-2\">\n                          {job.validationStatus === \"passed\" ? (\n                            <Badge variant=\"outline\" className=\"text-green-600 border-green-600\">\n                              <CheckCircle className=\"h-3 w-3 mr-1\" />\n                              OK\n                            </Badge>\n                          ) : job.validationStatus === \"failed\" ? (\n                            <Badge variant=\"destructive\">\n                              <XCircle className=\"h-3 w-3 mr-1\" />\n                              Falha\n                            </Badge>\n                          ) : (\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => verifyIntegrityMutation.mutate(job.id)}\n                              disabled={verifyingIntegrityJobId === job.id}\n                              data-testid={`button-verify-integrity-${job.id}`}\n                            >\n                              {verifyingIntegrityJobId === job.id ? (\n                                <Loader2 className=\"h-4 w-4 animate-spin\" />\n                              ) : (\n                                <>\n                                  <ShieldCheck className=\"h-4 w-4 mr-1\" />\n                                  Verificar\n                                </>\n                              )}\n                            </Button>\n                          )}\n                          {job.validationStatus && job.validationMessage && (\n                            <span className=\"text-xs text-muted-foreground max-w-[150px] truncate\" title={job.validationMessage}>\n                              {job.validationMessage.split(\":\")[0]}\n                            </span>\n                          )}\n                        </div>\n                      ) : (\n                        <span className=\"text-sm text-muted-foreground\">-</span>\n                      )}\n                    </TableCell>\n                    <TableCell>\n                      {job.status === \"completed\" ? (\n                        <div className=\"flex gap-1\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => setValidationDialogJob(job)}\n                            data-testid={`button-view-validation-${job.id}`}\n                          >\n                            <ShieldCheck className=\"h-4 w-4 mr-1\" />\n                            Ver\n                          </Button>\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => runValidationMutation.mutate(job.id)}\n                            disabled={validatingJobId === job.id}\n                            data-testid={`button-run-validation-${job.id}`}\n                          >\n                            {validatingJobId === job.id ? (\n                              <Loader2 className=\"h-4 w-4 animate-spin\" />\n                            ) : (\n                              \"Validar\"\n                            )}\n                          </Button>\n                        </div>\n                      ) : (\n                        <span className=\"text-sm text-muted-foreground\">-</span>\n                      )}\n                    </TableCell>\n                    <TableCell className=\"text-sm text-muted-foreground\">\n                      {formatDate(job.createdAt)}\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex gap-1\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => setBatchesDialogJob(job)}\n                          title=\"Ver lotes de importação\"\n                          data-testid={`button-view-batches-${job.id}`}\n                        >\n                          <Layers className=\"h-4 w-4 text-blue-500\" />\n                        </Button>\n                        {isJobInProgress(job.status) && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => cancelJobMutation.mutate(job.id)}\n                            disabled={cancellingJobId === job.id}\n                            title=\"Cancelar importação\"\n                            data-testid={`button-cancel-job-${job.id}`}\n                          >\n                            {cancellingJobId === job.id ? (\n                              <Loader2 className=\"h-4 w-4 animate-spin\" />\n                            ) : (\n                              <StopCircle className=\"h-4 w-4 text-orange-500\" />\n                            )}\n                          </Button>\n                        )}\n                        {isJobRestartable(job.status) && job.filename?.startsWith(\"[URL]\") && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => restartJobMutation.mutate(job.id)}\n                            disabled={restartingJobId === job.id}\n                            title=\"Reiniciar importação\"\n                            data-testid={`button-restart-job-${job.id}`}\n                          >\n                            {restartingJobId === job.id ? (\n                              <Loader2 className=\"h-4 w-4 animate-spin\" />\n                            ) : (\n                              <RotateCcw className=\"h-4 w-4 text-blue-500\" />\n                            )}\n                          </Button>\n                        )}\n                        {!isJobInProgress(job.status) && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => {\n                              if (confirm(`Excluir importação \"${job.filename}\" e todos os seus dados?`)) {\n                                deleteJobMutation.mutate(job.id);\n                              }\n                            }}\n                            disabled={deletingJobId === job.id}\n                            title=\"Excluir importação\"\n                            data-testid={`button-delete-job-${job.id}`}\n                          >\n                            {deletingJobId === job.id ? (\n                              <Loader2 className=\"h-4 w-4 animate-spin\" />\n                            ) : (\n                              <Trash2 className=\"h-4 w-4 text-red-500\" />\n                            )}\n                          </Button>\n                        )}\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <FileText className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n              <p>Nenhuma importação realizada ainda</p>\n            </div>\n          )}\n          </CardContent>\n        </Card>\n        </TabsContent>\n\n        <TabsContent value=\"files\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n              <div>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <HardDrive className=\"h-5 w-5\" />\n                  Arquivos Temporários\n                </CardTitle>\n                <CardDescription>\n                  Arquivos baixados e extraídos durante as importações\n                </CardDescription>\n              </div>\n              <Button variant=\"outline\" size=\"sm\" onClick={() => refetchFiles()} data-testid=\"button-refresh-files\">\n                <RefreshCw className=\"h-4 w-4 mr-2\" />\n                Atualizar\n              </Button>\n            </CardHeader>\n            <CardContent>\n              {!importFiles || importFiles.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <FolderOpen className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                  <p>Nenhum arquivo temporário encontrado</p>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {importFiles.map((group) => (\n                    <div key={group.directory} className=\"border rounded-lg p-4\">\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <div className=\"flex items-center gap-2\">\n                          <FolderOpen className=\"h-5 w-5 text-muted-foreground\" />\n                          <span className=\"font-medium\">\n                            {group.directory === \"uploads\" ? \"Uploads\" : `Job #${group.jobId}`}\n                          </span>\n                          <Badge variant=\"outline\">\n                            {group.files.length} arquivo(s)\n                          </Badge>\n                          <span className=\"text-sm text-muted-foreground\">\n                            {formatFileSize(group.totalSize)}\n                          </span>\n                        </div>\n                        <Button\n                          variant=\"destructive\"\n                          size=\"sm\"\n                          onClick={() => {\n                            if (confirm(`Excluir todos os arquivos de \"${group.directory}\"?`)) {\n                              deleteFilesMutation.mutate(group.jobId);\n                            }\n                          }}\n                          disabled={deletingFilesJobId === group.jobId}\n                          data-testid={`button-delete-files-${group.jobId}`}\n                        >\n                          {deletingFilesJobId === group.jobId ? (\n                            <Loader2 className=\"h-4 w-4 animate-spin\" />\n                          ) : (\n                            <>\n                              <Trash2 className=\"h-4 w-4 mr-1\" />\n                              Excluir\n                            </>\n                          )}\n                        </Button>\n                      </div>\n                      <Table>\n                        <TableHeader>\n                          <TableRow>\n                            <TableHead>Nome</TableHead>\n                            <TableHead>Tamanho</TableHead>\n                            <TableHead>Modificado</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {group.files.map((file) => (\n                            <TableRow key={file.name}>\n                              <TableCell className=\"font-mono text-sm\">{file.name}</TableCell>\n                              <TableCell>{formatFileSize(file.size)}</TableCell>\n                              <TableCell className=\"text-sm text-muted-foreground\">\n                                {new Date(file.modifiedAt).toLocaleString(\"pt-BR\")}\n                              </TableCell>\n                            </TableRow>\n                          ))}\n                        </TableBody>\n                      </Table>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={!!errorsDialogJob} onOpenChange={(open) => !open && setErrorsDialogJob(null)}>\n        <DialogContent className=\"max-w-4xl max-h-[85vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <XCircle className=\"h-5 w-5 text-destructive\" />\n              Relatório de Erros de Importação\n            </DialogTitle>\n            <DialogDescription>\n              Arquivo: {errorsDialogJob?.filename} | Ano: {errorsDialogJob?.electionYear || \"-\"} | UF: {errorsDialogJob?.uf || \"-\"}\n            </DialogDescription>\n          </DialogHeader>\n          \n          {jobErrors && jobErrors.length > 0 ? (\n            <div className=\"space-y-4\">\n              <Card className=\"border-destructive/50 bg-destructive/5\">\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-base flex items-center justify-between\">\n                    <span>Resumo de Discrepâncias</span>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => {\n                        const csvContent = [\n                          [\"Linha\", \"Tipo de Erro\", \"Mensagem\", \"Dados Brutos\"].join(\";\"),\n                          ...jobErrors.map(e => [\n                            e.rowNumber || \"\",\n                            e.errorType || \"\",\n                            `\"${(e.errorMessage || \"\").replace(/\"/g, '\"\"')}\"`,\n                            `\"${(e.rawData || \"\").replace(/\"/g, '\"\"')}\"`\n                          ].join(\";\"))\n                        ].join(\"\\n\");\n                        const blob = new Blob([\"\\ufeff\" + csvContent], { type: \"text/csv;charset=utf-8\" });\n                        const url = URL.createObjectURL(blob);\n                        const a = document.createElement(\"a\");\n                        a.href = url;\n                        a.download = `erros_importacao_${errorsDialogJob?.id}_${new Date().toISOString().split(\"T\")[0]}.csv`;\n                        a.click();\n                        URL.revokeObjectURL(url);\n                      }}\n                      data-testid=\"button-export-errors-csv\"\n                    >\n                      <Download className=\"h-4 w-4 mr-1\" />\n                      Exportar CSV\n                    </Button>\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4\">\n                    <div className=\"text-center p-3 rounded-lg bg-background\">\n                      <p className=\"text-2xl font-bold text-destructive\">{jobErrors.length}</p>\n                      <p className=\"text-xs text-muted-foreground\">Total de Erros</p>\n                    </div>\n                    <div className=\"text-center p-3 rounded-lg bg-background\">\n                      <p className=\"text-2xl font-bold\">{new Set(jobErrors.map(e => e.errorType)).size}</p>\n                      <p className=\"text-xs text-muted-foreground\">Tipos Diferentes</p>\n                    </div>\n                    <div className=\"text-center p-3 rounded-lg bg-background\">\n                      <p className=\"text-2xl font-bold\">\n                        {jobErrors.filter(e => e.rowNumber).length > 0 \n                          ? Math.min(...jobErrors.filter(e => e.rowNumber).map(e => e.rowNumber!))\n                          : \"-\"}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\">Primeira Linha</p>\n                    </div>\n                    <div className=\"text-center p-3 rounded-lg bg-background\">\n                      <p className=\"text-2xl font-bold\">\n                        {jobErrors.filter(e => e.rowNumber).length > 0 \n                          ? Math.max(...jobErrors.filter(e => e.rowNumber).map(e => e.rowNumber!))\n                          : \"-\"}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\">Última Linha</p>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <h4 className=\"text-sm font-medium\">Distribuição por Tipo de Erro:</h4>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {Object.entries(\n                        jobErrors.reduce((acc, e) => {\n                          acc[e.errorType || \"desconhecido\"] = (acc[e.errorType || \"desconhecido\"] || 0) + 1;\n                          return acc;\n                        }, {} as Record<string, number>)\n                      ).sort((a, b) => b[1] - a[1]).map(([type, count]) => (\n                        <Badge key={type} variant=\"destructive\" className=\"text-xs\">\n                          {type}: {count} ({((count / jobErrors.length) * 100).toFixed(1)}%)\n                        </Badge>\n                      ))}\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    <AlertTriangle className=\"h-4 w-4\" />\n                    Orientações para Resolução\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"text-sm space-y-2\">\n                  {Array.from(new Set(jobErrors.map(e => e.errorType))).slice(0, 5).map(errorType => (\n                    <div key={errorType} className=\"p-3 rounded-lg bg-muted/50\">\n                      <p className=\"font-medium text-destructive\">{errorType}</p>\n                      <p className=\"text-muted-foreground mt-1\">\n                        {errorType === \"parse_error\" && \"Verifique se o arquivo CSV está no formato correto do TSE. O separador deve ser ponto-e-vírgula (;) e a codificação Latin1 ou UTF-8.\"}\n                        {errorType === \"invalid_format\" && \"Alguns campos estão em formato inválido. Verifique se o arquivo corresponde ao layout esperado do TSE.\"}\n                        {errorType === \"missing_field\" && \"Campos obrigatórios estão ausentes. Certifique-se de que o arquivo possui todas as colunas necessárias.\"}\n                        {errorType === \"duplicate_entry\" && \"Registros duplicados foram detectados. Verifique se não há linhas repetidas no arquivo original.\"}\n                        {errorType === \"invalid_number\" && \"Valores numéricos inválidos foram encontrados. Verifique se os campos de votos e números de candidato estão corretos.\"}\n                        {errorType === \"encoding_error\" && \"Problemas de codificação detectados. Tente converter o arquivo para UTF-8 antes de importar.\"}\n                        {![\"parse_error\", \"invalid_format\", \"missing_field\", \"duplicate_entry\", \"invalid_number\", \"encoding_error\"].includes(errorType || \"\") && \n                          \"Revise os dados brutos das linhas afetadas para identificar o problema específico.\"}\n                      </p>\n                    </div>\n                  ))}\n                </CardContent>\n              </Card>\n\n              <Accordion type=\"single\" collapsible defaultValue=\"errors\">\n                <AccordionItem value=\"errors\">\n                  <AccordionTrigger className=\"text-base\">\n                    Detalhes dos Erros ({Math.min(100, jobErrors.length)} de {jobErrors.length})\n                  </AccordionTrigger>\n                  <AccordionContent>\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead className=\"w-20\">Linha</TableHead>\n                          <TableHead className=\"w-32\">Tipo</TableHead>\n                          <TableHead>Mensagem</TableHead>\n                          <TableHead className=\"w-48\">Dados Brutos</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {jobErrors.slice(0, 100).map((error) => (\n                          <TableRow key={error.id}>\n                            <TableCell className=\"font-mono text-sm\">{error.rowNumber || \"-\"}</TableCell>\n                            <TableCell>\n                              <Badge variant=\"destructive\" className=\"text-xs\">{error.errorType}</Badge>\n                            </TableCell>\n                            <TableCell className=\"text-sm\">{error.errorMessage}</TableCell>\n                            <TableCell className=\"text-xs font-mono text-muted-foreground max-w-[200px] truncate\" title={error.rawData || \"\"}>\n                              {error.rawData || \"-\"}\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                    {jobErrors.length > 100 && (\n                      <p className=\"text-sm text-muted-foreground mt-3 text-center\">\n                        Mostrando os primeiros 100 erros. Exporte o CSV para ver todos os {jobErrors.length} erros.\n                      </p>\n                    )}\n                  </AccordionContent>\n                </AccordionItem>\n              </Accordion>\n            </div>\n          ) : (\n            <div className=\"text-center py-8\">\n              <CheckCircle className=\"h-12 w-12 mx-auto mb-4 text-green-500 opacity-70\" />\n              <p className=\"text-muted-foreground\">Nenhum erro encontrado nesta importação.</p>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!validationDialogJob} onOpenChange={(open) => !open && setValidationDialogJob(null)}>\n        <DialogContent className=\"max-w-4xl max-h-[85vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <ShieldCheck className=\"h-5 w-5\" />\n              Validação de Dados\n            </DialogTitle>\n            <DialogDescription>\n              Arquivo: {validationDialogJob?.filename} | Ano: {validationDialogJob?.electionYear || \"-\"}\n            </DialogDescription>\n          </DialogHeader>\n          \n          {validationLoading || validatingJobId === validationDialogJob?.id ? (\n            <div className=\"flex flex-col items-center justify-center py-12\">\n              <Loader2 className=\"h-12 w-12 animate-spin text-muted-foreground mb-4\" />\n              <p className=\"text-muted-foreground\">\n                {validatingJobId === validationDialogJob?.id ? \"Executando validação com IA...\" : \"Carregando resultados...\"}\n              </p>\n            </div>\n          ) : validationStatus?.hasValidation ? (\n            <div className=\"space-y-6\">\n              <div className=\"flex justify-end\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => {\n                    const report = {\n                      arquivo: validationDialogJob?.filename,\n                      ano: validationDialogJob?.electionYear,\n                      uf: validationDialogJob?.uf,\n                      dataValidacao: validationStatus.completedAt,\n                      score: validationStatus.aiAnalysis?.overallDataQuality?.score,\n                      avaliacao: validationStatus.aiAnalysis?.overallDataQuality?.assessment,\n                      registrosVerificados: validationStatus.totalRecordsChecked,\n                      problemasEncontrados: validationStatus.issuesFound,\n                      descobertas: validationStatus.aiAnalysis?.overallDataQuality?.keyFindings,\n                      riscos: validationStatus.aiAnalysis?.overallDataQuality?.risksIdentified,\n                      analise: validationStatus.aiAnalysis?.analysis,\n                      recomendacoes: validationStatus.aiAnalysis?.recommendations,\n                      resumoPorSeveridade: validationStatus.summary?.bySeverity,\n                      resumoPorTipo: validationStatus.summary?.byType,\n                    };\n                    const blob = new Blob([JSON.stringify(report, null, 2)], { type: \"application/json\" });\n                    const url = URL.createObjectURL(blob);\n                    const a = document.createElement(\"a\");\n                    a.href = url;\n                    a.download = `validacao_ia_${validationDialogJob?.id}_${new Date().toISOString().split(\"T\")[0]}.json`;\n                    a.click();\n                    URL.revokeObjectURL(url);\n                  }}\n                  data-testid=\"button-export-validation-json\"\n                >\n                  <Download className=\"h-4 w-4 mr-1\" />\n                  Exportar Relatório\n                </Button>\n              </div>\n\n              {validationStatus.aiAnalysis?.overallDataQuality && (\n                <Card className={\n                  validationStatus.aiAnalysis.overallDataQuality.score >= 80 ? \"border-green-500/50 bg-green-500/5\" :\n                  validationStatus.aiAnalysis.overallDataQuality.score >= 60 ? \"border-yellow-500/50 bg-yellow-500/5\" :\n                  \"border-destructive/50 bg-destructive/5\"\n                }>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-lg flex items-center justify-between\">\n                      <span className=\"flex items-center gap-2\">\n                        {validationStatus.aiAnalysis.overallDataQuality.score >= 80 ? (\n                          <CheckCircle className=\"h-5 w-5 text-green-500\" />\n                        ) : validationStatus.aiAnalysis.overallDataQuality.score >= 60 ? (\n                          <AlertTriangle className=\"h-5 w-5 text-yellow-500\" />\n                        ) : (\n                          <XCircle className=\"h-5 w-5 text-destructive\" />\n                        )}\n                        Avaliação de Qualidade dos Dados\n                      </span>\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"text-sm text-muted-foreground\">Score:</span>\n                        <Badge \n                          variant={\n                            validationStatus.aiAnalysis.overallDataQuality.score >= 80 ? \"default\" :\n                            validationStatus.aiAnalysis.overallDataQuality.score >= 60 ? \"secondary\" :\n                            \"destructive\"\n                          }\n                          className=\"text-lg px-4 py-1\"\n                        >\n                          {validationStatus.aiAnalysis.overallDataQuality.score}/100\n                        </Badge>\n                      </div>\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-4\">\n                    <div className=\"p-4 rounded-lg bg-background border\">\n                      <p className=\"text-sm leading-relaxed\">{validationStatus.aiAnalysis.overallDataQuality.assessment}</p>\n                    </div>\n                    \n                    <div className=\"grid md:grid-cols-2 gap-4\">\n                      {validationStatus.aiAnalysis.overallDataQuality.keyFindings.length > 0 && (\n                        <div className=\"p-4 rounded-lg bg-blue-500/5 border border-blue-500/20\">\n                          <h4 className=\"font-medium mb-3 flex items-center gap-2 text-blue-700 dark:text-blue-400\">\n                            <Info className=\"h-4 w-4\" />\n                            Principais Descobertas\n                          </h4>\n                          <ul className=\"space-y-2\">\n                            {validationStatus.aiAnalysis.overallDataQuality.keyFindings.map((finding, i) => (\n                              <li key={i} className=\"text-sm flex items-start gap-2\">\n                                <span className=\"text-blue-500 mt-1\">•</span>\n                                <span>{finding}</span>\n                              </li>\n                            ))}\n                          </ul>\n                        </div>\n                      )}\n                      \n                      {validationStatus.aiAnalysis.overallDataQuality.risksIdentified.length > 0 && (\n                        <div className=\"p-4 rounded-lg bg-destructive/5 border border-destructive/20\">\n                          <h4 className=\"font-medium mb-3 flex items-center gap-2 text-destructive\">\n                            <AlertTriangle className=\"h-4 w-4\" />\n                            Riscos Identificados\n                          </h4>\n                          <ul className=\"space-y-2\">\n                            {validationStatus.aiAnalysis.overallDataQuality.risksIdentified.map((risk, i) => (\n                              <li key={i} className=\"text-sm flex items-start gap-2\">\n                                <span className=\"text-destructive mt-1\">!</span>\n                                <span>{risk}</span>\n                              </li>\n                            ))}\n                          </ul>\n                        </div>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              <div className=\"grid gap-4 grid-cols-2 md:grid-cols-4\">\n                <Card>\n                  <CardContent className=\"pt-4 text-center\">\n                    <p className=\"text-3xl font-bold\">{validationStatus.totalRecordsChecked?.toLocaleString(\"pt-BR\")}</p>\n                    <p className=\"text-xs text-muted-foreground\">Registros Verificados</p>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"pt-4 text-center\">\n                    <p className=\"text-3xl font-bold\">{validationStatus.issuesFound || 0}</p>\n                    <p className=\"text-xs text-muted-foreground\">Problemas Encontrados</p>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"pt-4 text-center\">\n                    <p className=\"text-3xl font-bold text-destructive\">\n                      {validationStatus.summary?.bySeverity?.[\"error\"] || 0}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Erros Críticos</p>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"pt-4 text-center\">\n                    <p className=\"text-3xl font-bold text-yellow-600\">\n                      {validationStatus.summary?.bySeverity?.[\"warning\"] || 0}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Avisos</p>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {validationStatus.summary && (\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base\">Distribuição de Problemas</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"grid md:grid-cols-2 gap-6\">\n                      <div>\n                        <h4 className=\"text-sm font-medium mb-3\">Por Severidade</h4>\n                        <div className=\"space-y-2\">\n                          {Object.entries(validationStatus.summary.bySeverity).sort((a, b) => {\n                            const order = { error: 0, warning: 1, info: 2 };\n                            return (order[a[0] as keyof typeof order] || 3) - (order[b[0] as keyof typeof order] || 3);\n                          }).map(([sev, count]) => (\n                            <div key={sev} className=\"flex items-center gap-2\">\n                              <Badge \n                                variant={sev === \"error\" ? \"destructive\" : sev === \"warning\" ? \"secondary\" : \"outline\"}\n                                className=\"w-20 justify-center\"\n                              >\n                                {sev === \"error\" ? \"Erro\" : sev === \"warning\" ? \"Aviso\" : \"Info\"}\n                              </Badge>\n                              <div className=\"flex-1 h-2 bg-muted rounded-full overflow-hidden\">\n                                <div \n                                  className={`h-full ${sev === \"error\" ? \"bg-destructive\" : sev === \"warning\" ? \"bg-yellow-500\" : \"bg-blue-500\"}`}\n                                  style={{ width: `${Math.min(100, (count / (validationStatus.issuesFound || 1)) * 100)}%` }}\n                                />\n                              </div>\n                              <span className=\"text-sm font-medium w-12 text-right\">{count}</span>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                      <div>\n                        <h4 className=\"text-sm font-medium mb-3\">Por Tipo de Problema</h4>\n                        <div className=\"flex flex-wrap gap-2\">\n                          {Object.entries(validationStatus.summary.byType)\n                            .sort((a, b) => b[1] - a[1])\n                            .slice(0, 8)\n                            .map(([type, count]) => (\n                              <Badge key={type} variant=\"outline\" className=\"text-xs\">\n                                {type.replace(/_/g, \" \")}: {count}\n                              </Badge>\n                            ))}\n                        </div>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              {validationStatus.aiAnalysis?.analysis && (\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <ShieldCheck className=\"h-4 w-4\" />\n                      Análise Detalhada da IA\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"p-4 rounded-lg bg-muted/50 border\">\n                      <p className=\"text-sm whitespace-pre-wrap leading-relaxed\">{validationStatus.aiAnalysis.analysis}</p>\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              {validationStatus.aiAnalysis?.recommendations && validationStatus.aiAnalysis.recommendations.length > 0 && (\n                <Card className=\"border-primary/30\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <Info className=\"h-4 w-4 text-primary\" />\n                      Recomendações de Ação\n                    </CardTitle>\n                    <CardDescription>\n                      Ações sugeridas pela IA para melhorar a qualidade dos dados\n                    </CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-3\">\n                      {validationStatus.aiAnalysis.recommendations.map((rec, i) => (\n                        <div key={i} className=\"p-3 rounded-lg border bg-background flex items-start gap-3\">\n                          <Badge variant={\n                            rec.severity === \"error\" ? \"destructive\" : \n                            rec.severity === \"warning\" ? \"secondary\" : \"outline\"\n                          } className=\"shrink-0 mt-0.5\">\n                            {rec.severity === \"error\" ? \"Crítico\" : rec.severity === \"warning\" ? \"Importante\" : \"Sugestão\"}\n                          </Badge>\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"font-medium text-sm\">{rec.issue}</p>\n                            <p className=\"text-sm text-muted-foreground mt-1\">{rec.suggestedAction}</p>\n                            {rec.confidence && (\n                              <p className=\"text-xs text-muted-foreground mt-2\">\n                                Confiança: {Math.round(rec.confidence * 100)}%\n                              </p>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              {validationIssues && validationIssues.length > 0 && (\n                <Accordion type=\"single\" collapsible className=\"w-full\">\n                  <AccordionItem value=\"issues\">\n                    <AccordionTrigger className=\"text-base\">\n                      Lista Completa de Problemas ({validationIssues.length})\n                    </AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"mb-3 flex justify-end\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => {\n                            const csvContent = [\n                              [\"Severidade\", \"Tipo\", \"Categoria\", \"Linha\", \"Campo\", \"Valor Atual\", \"Mensagem\", \"Ação Sugerida\", \"Confiança\"].join(\";\"),\n                              ...validationIssues.map(issue => [\n                                issue.severity,\n                                issue.type,\n                                issue.category || \"\",\n                                issue.rowReference || \"\",\n                                issue.field || \"\",\n                                `\"${(issue.currentValue || \"\").replace(/\"/g, '\"\"')}\"`,\n                                `\"${(issue.message || \"\").replace(/\"/g, '\"\"')}\"`,\n                                `\"${(issue.suggestedFix?.reasoning || \"\").replace(/\"/g, '\"\"')}\"`,\n                                issue.suggestedFix?.confidence ? `${Math.round(issue.suggestedFix.confidence * 100)}%` : \"\"\n                              ].join(\";\"))\n                            ].join(\"\\n\");\n                            const blob = new Blob([\"\\ufeff\" + csvContent], { type: \"text/csv;charset=utf-8\" });\n                            const url = URL.createObjectURL(blob);\n                            const a = document.createElement(\"a\");\n                            a.href = url;\n                            a.download = `problemas_validacao_${validationDialogJob?.id}_${new Date().toISOString().split(\"T\")[0]}.csv`;\n                            a.click();\n                            URL.revokeObjectURL(url);\n                          }}\n                          data-testid=\"button-export-issues-csv\"\n                        >\n                          <Download className=\"h-4 w-4 mr-1\" />\n                          Exportar CSV\n                        </Button>\n                      </div>\n                      <Table>\n                        <TableHeader>\n                          <TableRow>\n                            <TableHead className=\"w-24\">Severidade</TableHead>\n                            <TableHead className=\"w-32\">Tipo</TableHead>\n                            <TableHead>Mensagem</TableHead>\n                            <TableHead className=\"w-48\">Ação Sugerida</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {validationIssues.slice(0, 50).map((issue) => (\n                            <TableRow key={issue.id}>\n                              <TableCell>\n                                <Badge variant={\n                                  issue.severity === \"error\" ? \"destructive\" : \n                                  issue.severity === \"warning\" ? \"secondary\" : \"outline\"\n                                }>\n                                  {issue.severity === \"error\" ? \"Erro\" : issue.severity === \"warning\" ? \"Aviso\" : \"Info\"}\n                                </Badge>\n                              </TableCell>\n                              <TableCell className=\"text-sm\">\n                                {issue.type.replace(/_/g, \" \")}\n                              </TableCell>\n                              <TableCell className=\"text-sm\">\n                                <div>\n                                  <p>{issue.message}</p>\n                                  {issue.rowReference && (\n                                    <p className=\"text-xs text-muted-foreground mt-1\">Linha: {issue.rowReference}</p>\n                                  )}\n                                </div>\n                              </TableCell>\n                              <TableCell className=\"text-sm text-muted-foreground\">\n                                {issue.suggestedFix?.reasoning || \"-\"}\n                              </TableCell>\n                            </TableRow>\n                          ))}\n                        </TableBody>\n                      </Table>\n                      {validationIssues.length > 50 && (\n                        <p className=\"text-sm text-muted-foreground mt-3 text-center\">\n                          Mostrando os primeiros 50 de {validationIssues.length} problemas. Exporte o CSV para ver todos.\n                        </p>\n                      )}\n                    </AccordionContent>\n                  </AccordionItem>\n                </Accordion>\n              )}\n            </div>\n          ) : (\n            <div className=\"text-center py-8\">\n              <ShieldCheck className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n              <p className=\"text-muted-foreground mb-4\">\n                Nenhuma validação foi executada para esta importação.\n              </p>\n              <Button\n                onClick={() => {\n                  if (validationDialogJob) {\n                    runValidationMutation.mutate(validationDialogJob.id);\n                  }\n                }}\n                disabled={runValidationMutation.isPending}\n                data-testid=\"button-run-validation-dialog\"\n              >\n                {runValidationMutation.isPending ? (\n                  <><Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />Validando...</>\n                ) : (\n                  <><ShieldCheck className=\"h-4 w-4 mr-2\" />Executar Validação com IA</>\n                )}\n              </Button>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Batches Dialog */}\n      <Dialog open={!!batchesDialogJob} onOpenChange={(open) => !open && setBatchesDialogJob(null)}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Layers className=\"h-5 w-5\" />\n              Lotes de Importação\n            </DialogTitle>\n            <DialogDescription>\n              {batchesDialogJob?.filename} - Histórico detalhado de processamento por lotes\n            </DialogDescription>\n          </DialogHeader>\n          \n          {batchesLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : batchesData ? (\n            <div className=\"space-y-4\">\n              {/* Stats Summary */}\n              <div className=\"grid grid-cols-4 gap-4\">\n                <Card>\n                  <CardContent className=\"p-4 text-center\">\n                    <div className=\"text-2xl font-bold\">{batchesData.stats.total}</div>\n                    <div className=\"text-sm text-muted-foreground\">Total de Lotes</div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"p-4 text-center\">\n                    <div className=\"text-2xl font-bold text-green-600\">{batchesData.stats.completed}</div>\n                    <div className=\"text-sm text-muted-foreground\">Concluídos</div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"p-4 text-center\">\n                    <div className=\"text-2xl font-bold text-red-600\">{batchesData.stats.failed}</div>\n                    <div className=\"text-sm text-muted-foreground\">Falharam</div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"p-4 text-center\">\n                    <div className=\"text-2xl font-bold\">{batchesData.stats.processedRows.toLocaleString(\"pt-BR\")}</div>\n                    <div className=\"text-sm text-muted-foreground\">Linhas Processadas</div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Reprocess All Failed Button */}\n              {batchesData.stats.failed > 0 && (\n                <div className=\"flex justify-end\">\n                  <Button\n                    onClick={() => batchesDialogJob && reprocessAllFailedMutation.mutate(batchesDialogJob.id)}\n                    disabled={reprocessAllFailedMutation.isPending}\n                    variant=\"outline\"\n                    data-testid=\"button-reprocess-all-failed\"\n                  >\n                    {reprocessAllFailedMutation.isPending ? (\n                      <><Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />Reprocessando...</>\n                    ) : (\n                      <><RotateCw className=\"h-4 w-4 mr-2\" />Reprocessar Todos os Lotes Falhos</>\n                    )}\n                  </Button>\n                </div>\n              )}\n\n              {/* Batches Table */}\n              {batchesData.batches.length > 0 ? (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Lote</TableHead>\n                      <TableHead>Linhas</TableHead>\n                      <TableHead>Status</TableHead>\n                      <TableHead>Processadas</TableHead>\n                      <TableHead>Inseridas</TableHead>\n                      <TableHead>Erros</TableHead>\n                      <TableHead>Duração</TableHead>\n                      <TableHead>Ações</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {batchesData.batches.map((batch) => (\n                      <TableRow key={batch.id} data-testid={`row-batch-${batch.id}`}>\n                        <TableCell className=\"font-medium\">\n                          #{batch.batchIndex + 1}\n                        </TableCell>\n                        <TableCell>\n                          {batch.rowStart.toLocaleString(\"pt-BR\")} - {batch.rowEnd.toLocaleString(\"pt-BR\")}\n                          <span className=\"text-xs text-muted-foreground ml-1\">\n                            ({batch.totalRows.toLocaleString(\"pt-BR\")})\n                          </span>\n                        </TableCell>\n                        <TableCell>\n                          {batch.status === \"completed\" && (\n                            <Badge variant=\"outline\" className=\"text-green-600 border-green-600\">\n                              <CheckCircle className=\"h-3 w-3 mr-1\" />Concluído\n                            </Badge>\n                          )}\n                          {batch.status === \"failed\" && (\n                            <Badge variant=\"destructive\">\n                              <XCircle className=\"h-3 w-3 mr-1\" />Falhou\n                            </Badge>\n                          )}\n                          {batch.status === \"processing\" && (\n                            <Badge variant=\"default\">\n                              <Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />Processando\n                            </Badge>\n                          )}\n                          {batch.status === \"pending\" && (\n                            <Badge variant=\"secondary\">\n                              <Clock className=\"h-3 w-3 mr-1\" />Pendente\n                            </Badge>\n                          )}\n                        </TableCell>\n                        <TableCell>\n                          {(batch.processedRows ?? 0).toLocaleString(\"pt-BR\")}\n                        </TableCell>\n                        <TableCell>\n                          {(batch.insertedRows ?? 0).toLocaleString(\"pt-BR\")}\n                        </TableCell>\n                        <TableCell>\n                          {(batch.errorCount ?? 0) > 0 ? (\n                            <span className=\"text-red-600 font-medium\">{batch.errorCount}</span>\n                          ) : (\n                            <span className=\"text-muted-foreground\">0</span>\n                          )}\n                        </TableCell>\n                        <TableCell className=\"text-sm text-muted-foreground\">\n                          {batch.startedAt && batch.completedAt ? (\n                            (() => {\n                              const duration = Math.floor(\n                                (new Date(batch.completedAt).getTime() - new Date(batch.startedAt).getTime()) / 1000\n                              );\n                              return duration < 60 ? `${duration}s` : `${Math.floor(duration / 60)}m ${duration % 60}s`;\n                            })()\n                          ) : (\n                            \"-\"\n                          )}\n                        </TableCell>\n                        <TableCell>\n                          {batch.status === \"failed\" && (\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => batchesDialogJob && reprocessBatchMutation.mutate({ \n                                jobId: batchesDialogJob.id, \n                                batchId: batch.id \n                              })}\n                              disabled={reprocessingBatchId === batch.id}\n                              title=\"Reprocessar lote\"\n                              data-testid={`button-reprocess-batch-${batch.id}`}\n                            >\n                              {reprocessingBatchId === batch.id ? (\n                                <Loader2 className=\"h-4 w-4 animate-spin\" />\n                              ) : (\n                                <><RotateCw className=\"h-4 w-4 mr-1\" />Reprocessar</>\n                              )}\n                            </Button>\n                          )}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Layers className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                  <p>Nenhum lote registrado para esta importação.</p>\n                  <p className=\"text-sm mt-2\">\n                    Os lotes são criados durante o processamento de novas importações.\n                  </p>\n                </div>\n              )}\n\n              {/* Error Summary for Failed Batches */}\n              {batchesData.batches.filter(b => b.status === \"failed\" && b.errorSummary).length > 0 && (\n                <Accordion type=\"single\" collapsible className=\"w-full\">\n                  <AccordionItem value=\"error-details\">\n                    <AccordionTrigger className=\"text-sm\">\n                      <span className=\"flex items-center gap-2\">\n                        <AlertTriangle className=\"h-4 w-4 text-yellow-500\" />\n                        Detalhes dos Erros\n                      </span>\n                    </AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-2\">\n                        {batchesData.batches\n                          .filter(b => b.status === \"failed\" && b.errorSummary)\n                          .map((batch) => (\n                            <div key={batch.id} className=\"p-3 bg-muted rounded-md\">\n                              <div className=\"font-medium mb-1\">Lote #{batch.batchIndex + 1}</div>\n                              <div className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                                {batch.errorSummary}\n                              </div>\n                            </div>\n                          ))}\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n                </Accordion>\n              )}\n            </div>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <AlertTriangle className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n              <p>Erro ao carregar dados dos lotes.</p>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":110405,"size_tokens":null},"client/replit_integrations/audio/audio-playback-worklet.js":{"content":"/**\n * Reusable AudioWorklet for streaming PCM16 audio playback.\n * Place in public/ folder and load via audioContext.audioWorklet.addModule()\n */\nclass RingBuffer {\n  constructor(initialCapacity) {\n    this.capacity = initialCapacity;\n    this.buffer = new Float32Array(initialCapacity);\n    this.readIndex = 0;\n    this.writeIndex = 0;\n    this.availableData = 0;\n  }\n\n  push(data) {\n    const len = data.length;\n    // Auto-grow if needed\n    while (this.availableData + len > this.capacity) {\n      this.grow();\n    }\n    for (let i = 0; i < len; i++) {\n      this.buffer[this.writeIndex] = data[i];\n      this.writeIndex = (this.writeIndex + 1) % this.capacity;\n      this.availableData++;\n    }\n  }\n\n  grow() {\n    const newCapacity = this.capacity * 2;\n    const newBuffer = new Float32Array(newCapacity);\n    // Copy existing data maintaining order\n    for (let i = 0; i < this.availableData; i++) {\n      const srcIndex = (this.readIndex + i) % this.capacity;\n      newBuffer[i] = this.buffer[srcIndex];\n    }\n    this.buffer = newBuffer;\n    this.readIndex = 0;\n    this.writeIndex = this.availableData;\n    this.capacity = newCapacity;\n  }\n\n  pull(outputBuffer) {\n    const len = outputBuffer.length;\n    const available = Math.min(len, this.availableData);\n    for (let i = 0; i < available; i++) {\n      outputBuffer[i] = this.buffer[this.readIndex];\n      this.readIndex = (this.readIndex + 1) % this.capacity;\n    }\n    // Pad remaining with silence\n    for (let i = available; i < len; i++) {\n      outputBuffer[i] = 0;\n    }\n    this.availableData -= available;\n    return available > 0;\n  }\n\n  available() {\n    return this.availableData;\n  }\n\n  clear() {\n    this.readIndex = 0;\n    this.writeIndex = 0;\n    this.availableData = 0;\n  }\n}\n\nclass AudioPlaybackProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n    this.ringBuffer = new RingBuffer(24000 * 30); // 30s initial capacity\n    this.isPlaying = false;\n    this.streamComplete = false;\n\n    this.port.onmessage = (event) => {\n      const { type, samples } = event.data;\n      if (type === \"audio\") {\n        this.ringBuffer.push(samples);\n        this.isPlaying = true;\n      } else if (type === \"clear\") {\n        this.ringBuffer.clear();\n        this.isPlaying = false;\n        this.streamComplete = false;\n      } else if (type === \"streamComplete\") {\n        this.streamComplete = true;\n      } else if (type === \"stop\") {\n        this.isPlaying = false;\n        this.streamComplete = false;\n      }\n    };\n  }\n\n  process(inputs, outputs) {\n    const output = outputs[0];\n    if (!output || output.length === 0) return true;\n\n    const channel = output[0];\n    if (this.isPlaying) {\n      this.ringBuffer.pull(channel);\n      if (this.streamComplete && this.ringBuffer.available() === 0) {\n        this.isPlaying = false;\n        this.streamComplete = false;\n        this.port.postMessage({ type: \"ended\" });\n      }\n    } else {\n      channel.fill(0);\n    }\n    return true;\n  }\n}\n\nregisterProcessor(\"audio-playback-processor\", AudioPlaybackProcessor);\n\n","path":null,"size_bytes":3058,"size_tokens":null},"server/replit_integrations/chat/index.ts":{"content":"export { registerChatRoutes } from \"./routes\";\nexport { chatStorage, type IChatStorage } from \"./storage\";\n\n","path":null,"size_bytes":108,"size_tokens":null},"client/src/pages/ai-insights.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Label } from \"@/components/ui/label\";\nimport { \n  Brain, \n  TrendingUp, \n  Users, \n  Building2, \n  AlertTriangle,\n  Lightbulb,\n  BarChart3,\n  PieChart,\n  Target,\n  RefreshCw,\n  CheckCircle,\n  XCircle,\n  MinusCircle,\n  ArrowUp,\n  ArrowDown,\n  Minus,\n  Sparkles,\n  MessageSquare,\n  ThumbsUp,\n  ThumbsDown,\n  Newspaper\n} from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport {\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip as RechartsTooltip,\n  ResponsiveContainer,\n  PieChart as RechartsPie,\n  Pie,\n  Cell,\n  Legend,\n  RadarChart,\n  PolarGrid,\n  PolarAngleAxis,\n  PolarRadiusAxis,\n  Radar,\n  AreaChart,\n  Area,\n} from \"recharts\";\n\nconst CHART_COLORS = [\"#003366\", \"#FFD700\", \"#1E90FF\", \"#32CD32\", \"#FF6347\", \"#9370DB\", \"#20B2AA\", \"#FF69B4\"];\n\nconst BRAZIL_STATES: Record<string, string> = {\n  AC: \"Acre\", AL: \"Alagoas\", AP: \"Amapá\", AM: \"Amazonas\", BA: \"Bahia\",\n  CE: \"Ceará\", DF: \"Distrito Federal\", ES: \"Espírito Santo\", GO: \"Goiás\",\n  MA: \"Maranhão\", MT: \"Mato Grosso\", MS: \"Mato Grosso do Sul\", MG: \"Minas Gerais\",\n  PA: \"Pará\", PB: \"Paraíba\", PR: \"Paraná\", PE: \"Pernambuco\", PI: \"Piauí\",\n  RJ: \"Rio de Janeiro\", RN: \"Rio Grande do Norte\", RS: \"Rio Grande do Sul\",\n  RO: \"Rondônia\", RR: \"Roraima\", SC: \"Santa Catarina\", SP: \"São Paulo\",\n  SE: \"Sergipe\", TO: \"Tocantins\"\n};\n\nexport default function AIInsightsPage() {\n  const { user } = useAuth();\n  const [activeTab, setActiveTab] = useState(\"turnout\");\n  const [filters, setFilters] = useState<{\n    year?: number;\n    uf?: string;\n    electionType?: string;\n    party?: string;\n    targetYear?: number;\n  }>({});\n\n  const { data: availableYears } = useQuery<number[]>({\n    queryKey: [\"/api/analytics/election-years\"],\n  });\n\n  const { data: availableParties } = useQuery<{ abbreviation: string; name: string }[]>({\n    queryKey: [\"/api/analytics/parties-list\"],\n  });\n\n  const turnoutMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/ai/turnout\", filters);\n      return res.json();\n    },\n  });\n\n  const candidateSuccessMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/ai/candidate-success\", filters);\n      return res.json();\n    },\n  });\n\n  const partyPerformanceMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/ai/party-performance\", filters);\n      return res.json();\n    },\n  });\n\n  const insightsMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/ai/electoral-insights\", filters);\n      return res.json();\n    },\n  });\n\n  const sentimentMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/ai/sentiment\", { party: filters.party });\n      return res.json();\n    },\n  });\n\n  const formatNumber = (num: number) => {\n    if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;\n    if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;\n    return num.toLocaleString(\"pt-BR\");\n  };\n\n  const getConfidenceBadge = (confidence: number) => {\n    if (confidence >= 0.8) return <Badge className=\"bg-green-500\">Alta ({(confidence * 100).toFixed(0)}%)</Badge>;\n    if (confidence >= 0.5) return <Badge className=\"bg-yellow-500\">Média ({(confidence * 100).toFixed(0)}%)</Badge>;\n    return <Badge className=\"bg-red-500\">Baixa ({(confidence * 100).toFixed(0)}%)</Badge>;\n  };\n\n  const getTrendIcon = (trend: string) => {\n    if (trend === \"up\" || trend === \"growing\" || trend === \"positive\") return <ArrowUp className=\"h-4 w-4 text-green-500\" />;\n    if (trend === \"down\" || trend === \"declining\" || trend === \"negative\") return <ArrowDown className=\"h-4 w-4 text-red-500\" />;\n    return <Minus className=\"h-4 w-4 text-gray-500\" />;\n  };\n\n  const getImpactColor = (impact: string) => {\n    if (impact === \"positive\") return \"text-green-600\";\n    if (impact === \"negative\") return \"text-red-600\";\n    return \"text-gray-600\";\n  };\n\n  const canAnalyze = user?.role === \"admin\" || user?.role === \"analyst\";\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold flex items-center gap-2\" data-testid=\"page-title\">\n            <Brain className=\"h-8 w-8 text-primary\" />\n            Insights com IA\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Análises preditivas e insights baseados em inteligência artificial\n          </p>\n        </div>\n        <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n          <Sparkles className=\"h-3 w-3\" />\n          Powered by GPT-4\n        </Badge>\n      </div>\n\n      <Card data-testid=\"filters-card\">\n        <CardHeader>\n          <CardTitle className=\"text-lg\">Filtros de Análise</CardTitle>\n          <CardDescription>Configure os parâmetros para as análises de IA</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-5 gap-4\">\n            <div>\n              <Label>Ano Base</Label>\n              <Select\n                value={filters.year?.toString() || \"_all\"}\n                onValueChange={(value) => setFilters((prev) => ({ ...prev, year: value && value !== \"_all\" ? parseInt(value) : undefined }))}\n              >\n                <SelectTrigger data-testid=\"select-year\">\n                  <SelectValue placeholder=\"Todos\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"_all\">Todos</SelectItem>\n                  {availableYears?.map((year) => (\n                    <SelectItem key={year} value={year.toString()}>\n                      {year}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label>Estado</Label>\n              <Select\n                value={filters.uf || \"_all\"}\n                onValueChange={(value) => setFilters((prev) => ({ ...prev, uf: value && value !== \"_all\" ? value : undefined }))}\n              >\n                <SelectTrigger data-testid=\"select-state\">\n                  <SelectValue placeholder=\"Nacional\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"_all\">Nacional</SelectItem>\n                  {Object.entries(BRAZIL_STATES).map(([code, name]) => (\n                    <SelectItem key={code} value={code}>\n                      {code} - {name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label>Partido</Label>\n              <Select\n                value={filters.party || \"_all\"}\n                onValueChange={(value) => setFilters((prev) => ({ ...prev, party: value && value !== \"_all\" ? value : undefined }))}\n              >\n                <SelectTrigger data-testid=\"select-party\">\n                  <SelectValue placeholder=\"Todos\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"_all\">Todos</SelectItem>\n                  {availableParties?.map((party) => (\n                    <SelectItem key={party.abbreviation} value={party.abbreviation}>\n                      {party.abbreviation}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label>Tipo de Eleição</Label>\n              <Select\n                value={filters.electionType || \"_all\"}\n                onValueChange={(value) => setFilters((prev) => ({ ...prev, electionType: value && value !== \"_all\" ? value : undefined }))}\n              >\n                <SelectTrigger data-testid=\"select-election-type\">\n                  <SelectValue placeholder=\"Todos\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"_all\">Todos</SelectItem>\n                  <SelectItem value=\"Eleições Gerais\">Eleições Gerais</SelectItem>\n                  <SelectItem value=\"Eleições Municipais\">Eleições Municipais</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label>Ano Alvo (Previsão)</Label>\n              <Input\n                type=\"number\"\n                placeholder=\"Ex: 2026\"\n                value={filters.targetYear || \"\"}\n                onChange={(e) => setFilters((prev) => ({ ...prev, targetYear: e.target.value ? parseInt(e.target.value) : undefined }))}\n                data-testid=\"input-target-year\"\n              />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"grid w-full grid-cols-5\">\n          <TabsTrigger value=\"turnout\" className=\"flex items-center gap-2\" data-testid=\"tab-turnout\">\n            <Users className=\"h-4 w-4\" />\n            Comparecimento\n          </TabsTrigger>\n          <TabsTrigger value=\"candidates\" className=\"flex items-center gap-2\" data-testid=\"tab-candidates\">\n            <Target className=\"h-4 w-4\" />\n            Candidatos\n          </TabsTrigger>\n          <TabsTrigger value=\"parties\" className=\"flex items-center gap-2\" data-testid=\"tab-parties\">\n            <Building2 className=\"h-4 w-4\" />\n            Partidos\n          </TabsTrigger>\n          <TabsTrigger value=\"sentiment\" className=\"flex items-center gap-2\" data-testid=\"tab-sentiment\">\n            <MessageSquare className=\"h-4 w-4\" />\n            Sentimento\n          </TabsTrigger>\n          <TabsTrigger value=\"insights\" className=\"flex items-center gap-2\" data-testid=\"tab-insights\">\n            <Lightbulb className=\"h-4 w-4\" />\n            Insights\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"turnout\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <TrendingUp className=\"h-5 w-5\" />\n                    Previsão de Comparecimento Eleitoral\n                  </CardTitle>\n                  <CardDescription>\n                    Análise preditiva baseada em padrões históricos de votação\n                  </CardDescription>\n                </div>\n                <Button\n                  onClick={() => turnoutMutation.mutate()}\n                  disabled={!canAnalyze || turnoutMutation.isPending}\n                  data-testid=\"button-analyze-turnout\"\n                >\n                  {turnoutMutation.isPending ? (\n                    <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <Brain className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Analisar\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {turnoutMutation.isPending ? (\n                <div className=\"space-y-4\">\n                  <Skeleton className=\"h-20\" />\n                  <Skeleton className=\"h-[300px]\" />\n                </div>\n              ) : turnoutMutation.data ? (\n                <div className=\"space-y-6\">\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <Card className=\"bg-primary/5\">\n                      <CardContent className=\"pt-4\">\n                        <div className=\"text-center\">\n                          <p className=\"text-sm text-muted-foreground\">Comparecimento Previsto</p>\n                          <p className=\"text-4xl font-bold text-primary\">\n                            {turnoutMutation.data.predictedTurnout?.toFixed(1)}%\n                          </p>\n                        </div>\n                      </CardContent>\n                    </Card>\n                    <Card className=\"bg-secondary/5\">\n                      <CardContent className=\"pt-4\">\n                        <div className=\"text-center\">\n                          <p className=\"text-sm text-muted-foreground\">Confiança</p>\n                          <div className=\"mt-2\">\n                            {getConfidenceBadge(turnoutMutation.data.confidence || 0)}\n                          </div>\n                          <Progress value={(turnoutMutation.data.confidence || 0) * 100} className=\"mt-2\" />\n                        </div>\n                      </CardContent>\n                    </Card>\n                    <Card className=\"bg-accent/5\">\n                      <CardContent className=\"pt-4\">\n                        <div className=\"text-center\">\n                          <p className=\"text-sm text-muted-foreground\">Metodologia</p>\n                          <p className=\"text-sm mt-2\">{turnoutMutation.data.methodology || \"Análise de tendências históricas\"}</p>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  </div>\n\n                  {turnoutMutation.data.factors?.length > 0 && (\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Fatores de Influência</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-3\">\n                          {turnoutMutation.data.factors.map((factor: any, index: number) => (\n                            <div key={index} className=\"flex items-center justify-between p-3 border rounded-lg\">\n                              <div className=\"flex items-center gap-3\">\n                                {factor.impact === \"positive\" && <CheckCircle className=\"h-5 w-5 text-green-500\" />}\n                                {factor.impact === \"negative\" && <XCircle className=\"h-5 w-5 text-red-500\" />}\n                                {factor.impact === \"neutral\" && <MinusCircle className=\"h-5 w-5 text-gray-500\" />}\n                                <div>\n                                  <p className=\"font-medium\">{factor.factor}</p>\n                                  <p className=\"text-sm text-muted-foreground\">{factor.description}</p>\n                                </div>\n                              </div>\n                              <Badge variant=\"outline\">Peso: {(factor.weight * 100).toFixed(0)}%</Badge>\n                            </div>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  )}\n\n                  {turnoutMutation.data.historicalComparison?.length > 0 && (\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Comparativo Histórico</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <ResponsiveContainer width=\"100%\" height={250}>\n                          <AreaChart data={turnoutMutation.data.historicalComparison}>\n                            <CartesianGrid strokeDasharray=\"3 3\" />\n                            <XAxis dataKey=\"year\" />\n                            <YAxis domain={[0, 100]} />\n                            <RechartsTooltip />\n                            <Area type=\"monotone\" dataKey=\"turnout\" fill=\"#003366\" stroke=\"#003366\" fillOpacity={0.3} />\n                          </AreaChart>\n                        </ResponsiveContainer>\n                      </CardContent>\n                    </Card>\n                  )}\n                </div>\n              ) : (\n                <div className=\"flex flex-col items-center justify-center h-[300px] text-muted-foreground\">\n                  <Users className=\"h-12 w-12 mb-4 opacity-50\" />\n                  <p>Clique em \"Analisar\" para gerar previsão de comparecimento</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"candidates\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Target className=\"h-5 w-5\" />\n                    Probabilidade de Sucesso de Candidatos\n                  </CardTitle>\n                  <CardDescription>\n                    Análise de chances de eleição baseada em dados históricos\n                  </CardDescription>\n                </div>\n                <Button\n                  onClick={() => candidateSuccessMutation.mutate()}\n                  disabled={!canAnalyze || candidateSuccessMutation.isPending}\n                  data-testid=\"button-analyze-candidates\"\n                >\n                  {candidateSuccessMutation.isPending ? (\n                    <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <Brain className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Analisar\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {candidateSuccessMutation.isPending ? (\n                <div className=\"space-y-2\">\n                  {[...Array(5)].map((_, i) => <Skeleton key={i} className=\"h-16\" />)}\n                </div>\n              ) : candidateSuccessMutation.data?.length > 0 ? (\n                <ScrollArea className=\"h-[500px]\">\n                  <div className=\"space-y-3\">\n                    {candidateSuccessMutation.data.map((candidate: any, index: number) => (\n                      <Card key={index} className=\"hover:bg-muted/30\" data-testid={`candidate-prediction-${index}`}>\n                        <CardContent className=\"pt-4\">\n                          <div className=\"flex items-center justify-between\">\n                            <div className=\"flex items-center gap-4\">\n                              <div className=\"text-2xl font-bold text-muted-foreground w-10\">\n                                #{candidate.ranking || index + 1}\n                              </div>\n                              <div>\n                                <p className=\"font-semibold\">{candidate.candidateName}</p>\n                                <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                                  <Badge variant=\"outline\">{candidate.party}</Badge>\n                                  {candidate.position && <span>{candidate.position}</span>}\n                                </div>\n                              </div>\n                            </div>\n                            <div className=\"text-right\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-2xl font-bold\">\n                                  {((candidate.successProbability || 0) * 100).toFixed(0)}%\n                                </span>\n                                {getConfidenceBadge(candidate.confidence || 0)}\n                              </div>\n                              {candidate.projectedVotes && (\n                                <p className=\"text-sm text-muted-foreground\">\n                                  Projeção: {formatNumber(candidate.projectedVotes.min)} - {formatNumber(candidate.projectedVotes.max)} votos\n                                </p>\n                              )}\n                            </div>\n                          </div>\n                          {candidate.factors?.length > 0 && (\n                            <div className=\"mt-3 pt-3 border-t\">\n                              <p className=\"text-sm font-medium mb-2\">Fatores Chave:</p>\n                              <div className=\"flex flex-wrap gap-2\">\n                                {candidate.factors.slice(0, 4).map((factor: any, fIndex: number) => (\n                                  <Badge \n                                    key={fIndex} \n                                    variant=\"secondary\"\n                                    className={getImpactColor(factor.impact)}\n                                  >\n                                    {factor.factor}: {factor.value}\n                                  </Badge>\n                                ))}\n                              </div>\n                            </div>\n                          )}\n                          {candidate.recommendation && (\n                            <p className=\"text-sm text-muted-foreground mt-2 italic\">\n                              \"{candidate.recommendation}\"\n                            </p>\n                          )}\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                </ScrollArea>\n              ) : (\n                <div className=\"flex flex-col items-center justify-center h-[300px] text-muted-foreground\">\n                  <Target className=\"h-12 w-12 mb-4 opacity-50\" />\n                  <p>Clique em \"Analisar\" para gerar previsões de candidatos</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"parties\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Building2 className=\"h-5 w-5\" />\n                    Previsão de Desempenho Partidário\n                  </CardTitle>\n                  <CardDescription>\n                    Análise de tendências e projeções para partidos políticos\n                  </CardDescription>\n                </div>\n                <Button\n                  onClick={() => partyPerformanceMutation.mutate()}\n                  disabled={!canAnalyze || partyPerformanceMutation.isPending}\n                  data-testid=\"button-analyze-parties\"\n                >\n                  {partyPerformanceMutation.isPending ? (\n                    <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <Brain className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Analisar\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {partyPerformanceMutation.isPending ? (\n                <div className=\"space-y-4\">\n                  <Skeleton className=\"h-[300px]\" />\n                  <div className=\"grid grid-cols-3 gap-4\">\n                    {[...Array(3)].map((_, i) => <Skeleton key={i} className=\"h-24\" />)}\n                  </div>\n                </div>\n              ) : partyPerformanceMutation.data?.length > 0 ? (\n                <div className=\"space-y-6\">\n                  <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Projeção de Votação</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <ResponsiveContainer width=\"100%\" height={300}>\n                          <BarChart data={partyPerformanceMutation.data.slice(0, 10)} layout=\"vertical\">\n                            <CartesianGrid strokeDasharray=\"3 3\" />\n                            <XAxis type=\"number\" />\n                            <YAxis dataKey=\"party\" type=\"category\" width={60} />\n                            <RechartsTooltip />\n                            <Bar dataKey=\"predictedVoteShare\" fill=\"#003366\" radius={[0, 4, 4, 0]} />\n                          </BarChart>\n                        </ResponsiveContainer>\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Tendência dos Partidos</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <ResponsiveContainer width=\"100%\" height={300}>\n                          <RechartsPie>\n                            <Pie\n                              data={partyPerformanceMutation.data.slice(0, 8)}\n                              dataKey=\"predictedVoteShare\"\n                              nameKey=\"party\"\n                              cx=\"50%\"\n                              cy=\"50%\"\n                              outerRadius={100}\n                            >\n                              {partyPerformanceMutation.data.slice(0, 8).map((entry: any, index: number) => (\n                                <Cell key={entry.party} fill={CHART_COLORS[index % CHART_COLORS.length]} />\n                              ))}\n                            </Pie>\n                            <RechartsTooltip />\n                            <Legend />\n                          </RechartsPie>\n                        </ResponsiveContainer>\n                      </CardContent>\n                    </Card>\n                  </div>\n\n                  <ScrollArea className=\"h-[400px]\">\n                    <div className=\"space-y-3\">\n                      {partyPerformanceMutation.data.map((party: any, index: number) => (\n                        <Card key={index} data-testid={`party-prediction-${index}`}>\n                          <CardContent className=\"pt-4\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-4\">\n                                <div className=\"flex items-center gap-2\">\n                                  {getTrendIcon(party.trend)}\n                                  <span className=\"text-xl font-bold\">{party.party}</span>\n                                </div>\n                                <Badge \n                                  variant={party.trend === \"growing\" ? \"default\" : party.trend === \"declining\" ? \"destructive\" : \"secondary\"}\n                                >\n                                  {party.trend === \"growing\" ? \"Crescimento\" : party.trend === \"declining\" ? \"Declínio\" : \"Estável\"}\n                                </Badge>\n                              </div>\n                              <div className=\"text-right\">\n                                <p className=\"text-sm text-muted-foreground\">Projeção de Votos</p>\n                                <p className=\"text-lg font-bold\">{party.predictedVoteShare?.toFixed(1)}%</p>\n                                {party.predictedSeats && (\n                                  <p className=\"text-sm\">\n                                    {party.predictedSeats.min}-{party.predictedSeats.max} cadeiras\n                                  </p>\n                                )}\n                              </div>\n                            </div>\n                            <div className=\"grid grid-cols-2 gap-4 mt-4\">\n                              {party.keyFactors?.length > 0 && (\n                                <div>\n                                  <p className=\"text-sm font-medium text-green-600 mb-1\">Pontos Fortes:</p>\n                                  <ul className=\"text-sm text-muted-foreground list-disc list-inside\">\n                                    {party.keyFactors.slice(0, 3).map((f: string, i: number) => (\n                                      <li key={i}>{f}</li>\n                                    ))}\n                                  </ul>\n                                </div>\n                              )}\n                              {party.risks?.length > 0 && (\n                                <div>\n                                  <p className=\"text-sm font-medium text-red-600 mb-1\">Riscos:</p>\n                                  <ul className=\"text-sm text-muted-foreground list-disc list-inside\">\n                                    {party.risks.slice(0, 3).map((r: string, i: number) => (\n                                      <li key={i}>{r}</li>\n                                    ))}\n                                  </ul>\n                                </div>\n                              )}\n                            </div>\n                          </CardContent>\n                        </Card>\n                      ))}\n                    </div>\n                  </ScrollArea>\n                </div>\n              ) : (\n                <div className=\"flex flex-col items-center justify-center h-[300px] text-muted-foreground\">\n                  <Building2 className=\"h-12 w-12 mb-4 opacity-50\" />\n                  <p>Clique em \"Analisar\" para gerar previsões de desempenho partidário</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"insights\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Lightbulb className=\"h-5 w-5\" />\n                    Insights Estratégicos\n                  </CardTitle>\n                  <CardDescription>\n                    Análise abrangente com descobertas, riscos e recomendações\n                  </CardDescription>\n                </div>\n                <Button\n                  onClick={() => insightsMutation.mutate()}\n                  disabled={!canAnalyze || insightsMutation.isPending}\n                  data-testid=\"button-analyze-insights\"\n                >\n                  {insightsMutation.isPending ? (\n                    <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <Brain className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Analisar\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {insightsMutation.isPending ? (\n                <div className=\"space-y-4\">\n                  <Skeleton className=\"h-32\" />\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <Skeleton className=\"h-48\" />\n                    <Skeleton className=\"h-48\" />\n                  </div>\n                </div>\n              ) : insightsMutation.data ? (\n                <div className=\"space-y-6\">\n                  <Card className=\"bg-primary/5\">\n                    <CardHeader>\n                      <CardTitle className=\"text-lg\">Resumo Executivo</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <p className=\"whitespace-pre-line\">{insightsMutation.data.summary}</p>\n                    </CardContent>\n                  </Card>\n\n                  <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg flex items-center gap-2\">\n                          <Lightbulb className=\"h-5 w-5\" />\n                          Descobertas Principais\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <ScrollArea className=\"h-[250px]\">\n                          <div className=\"space-y-3\">\n                            {insightsMutation.data.keyFindings?.map((finding: any, index: number) => (\n                              <div \n                                key={index} \n                                className=\"flex items-start gap-3 p-3 border rounded-lg\"\n                              >\n                                <Badge \n                                  variant={finding.importance === \"high\" ? \"destructive\" : finding.importance === \"medium\" ? \"default\" : \"secondary\"}\n                                >\n                                  {finding.importance === \"high\" ? \"Alta\" : finding.importance === \"medium\" ? \"Média\" : \"Baixa\"}\n                                </Badge>\n                                <div>\n                                  <p className=\"text-sm\">{finding.finding}</p>\n                                  <Badge variant=\"outline\" className=\"mt-1 text-xs\">\n                                    {finding.category}\n                                  </Badge>\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </ScrollArea>\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg flex items-center gap-2\">\n                          <AlertTriangle className=\"h-5 w-5\" />\n                          Fatores de Risco\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <ScrollArea className=\"h-[250px]\">\n                          <div className=\"space-y-3\">\n                            {insightsMutation.data.riskFactors?.map((risk: any, index: number) => (\n                              <div key={index} className=\"p-3 border rounded-lg\">\n                                <div className=\"flex items-center justify-between mb-2\">\n                                  <p className=\"font-medium\">{risk.risk}</p>\n                                  <Badge \n                                    variant={risk.impact === \"high\" ? \"destructive\" : risk.impact === \"medium\" ? \"default\" : \"secondary\"}\n                                  >\n                                    {risk.impact === \"high\" ? \"Alto Impacto\" : risk.impact === \"medium\" ? \"Médio\" : \"Baixo\"}\n                                  </Badge>\n                                </div>\n                                <Progress value={(risk.probability || 0) * 100} className=\"mb-2\" />\n                                <p className=\"text-sm text-muted-foreground\">{risk.mitigation}</p>\n                              </div>\n                            ))}\n                          </div>\n                        </ScrollArea>\n                      </CardContent>\n                    </Card>\n                  </div>\n\n                  {insightsMutation.data.recommendations?.length > 0 && (\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Recomendações</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                          {insightsMutation.data.recommendations.map((rec: string, index: number) => (\n                            <div key={index} className=\"flex items-start gap-2 p-3 bg-muted/30 rounded-lg\">\n                              <CheckCircle className=\"h-5 w-5 text-green-500 mt-0.5\" />\n                              <p className=\"text-sm\">{rec}</p>\n                            </div>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  )}\n\n                  {insightsMutation.data.dataQuality && (\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Qualidade dos Dados</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"grid grid-cols-4 gap-4 text-center\">\n                          <div>\n                            <p className=\"text-3xl font-bold\">{((insightsMutation.data.dataQuality.completeness || 0) * 100).toFixed(0)}%</p>\n                            <p className=\"text-sm text-muted-foreground\">Completude</p>\n                          </div>\n                          <div>\n                            <p className=\"text-3xl font-bold\">{insightsMutation.data.dataQuality.yearsAnalyzed || 0}</p>\n                            <p className=\"text-sm text-muted-foreground\">Anos Analisados</p>\n                          </div>\n                          <div>\n                            <p className=\"text-3xl font-bold\">{formatNumber(insightsMutation.data.dataQuality.candidatesAnalyzed || 0)}</p>\n                            <p className=\"text-sm text-muted-foreground\">Candidatos</p>\n                          </div>\n                          <div>\n                            <p className=\"text-3xl font-bold\">{insightsMutation.data.dataQuality.partiesAnalyzed || 0}</p>\n                            <p className=\"text-sm text-muted-foreground\">Partidos</p>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  )}\n                </div>\n              ) : (\n                <div className=\"flex flex-col items-center justify-center h-[300px] text-muted-foreground\">\n                  <Lightbulb className=\"h-12 w-12 mb-4 opacity-50\" />\n                  <p>Clique em \"Analisar\" para gerar insights estratégicos</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"sentiment\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <MessageSquare className=\"h-5 w-5\" />\n                    Análise de Sentimento\n                  </CardTitle>\n                  <CardDescription>\n                    Análise de sentimento de notícias e mídias sociais sobre candidatos e partidos\n                  </CardDescription>\n                </div>\n                <Button\n                  onClick={() => sentimentMutation.mutate()}\n                  disabled={sentimentMutation.isPending}\n                  data-testid=\"button-analyze-sentiment\"\n                >\n                  {sentimentMutation.isPending ? (\n                    <>\n                      <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Analisando...\n                    </>\n                  ) : (\n                    <>\n                      <Sparkles className=\"h-4 w-4 mr-2\" />\n                      Analisar\n                    </>\n                  )}\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {sentimentMutation.isPending ? (\n                <div className=\"space-y-4\">\n                  <Skeleton className=\"h-24\" />\n                  <Skeleton className=\"h-48\" />\n                </div>\n              ) : sentimentMutation.data ? (\n                <div className=\"space-y-6\">\n                  {sentimentMutation.data.message ? (\n                    <Card className=\"bg-muted/50\">\n                      <CardContent className=\"pt-6\">\n                        <div className=\"flex items-start gap-4\">\n                          <Newspaper className=\"h-8 w-8 text-muted-foreground\" />\n                          <div>\n                            <h4 className=\"font-semibold mb-2\">Funcionalidade em Desenvolvimento</h4>\n                            <p className=\"text-muted-foreground\">{sentimentMutation.data.message}</p>\n                            <p className=\"text-sm text-muted-foreground mt-2\">\n                              Esta funcionalidade está preparada para receber notícias e posts de mídias sociais\n                              sobre candidatos e partidos para análise automática de sentimento.\n                            </p>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ) : (\n                    <>\n                      <div className=\"grid grid-cols-3 gap-4\">\n                        <Card>\n                          <CardContent className=\"pt-6 text-center\">\n                            <ThumbsUp className=\"h-8 w-8 mx-auto mb-2 text-green-500\" />\n                            <p className=\"text-2xl font-bold text-green-600\">{sentimentMutation.data.positiveSentiment || 0}%</p>\n                            <p className=\"text-sm text-muted-foreground\">Positivo</p>\n                          </CardContent>\n                        </Card>\n                        <Card>\n                          <CardContent className=\"pt-6 text-center\">\n                            <Minus className=\"h-8 w-8 mx-auto mb-2 text-gray-500\" />\n                            <p className=\"text-2xl font-bold text-gray-600\">{sentimentMutation.data.neutralSentiment || 0}%</p>\n                            <p className=\"text-sm text-muted-foreground\">Neutro</p>\n                          </CardContent>\n                        </Card>\n                        <Card>\n                          <CardContent className=\"pt-6 text-center\">\n                            <ThumbsDown className=\"h-8 w-8 mx-auto mb-2 text-red-500\" />\n                            <p className=\"text-2xl font-bold text-red-600\">{sentimentMutation.data.negativeSentiment || 0}%</p>\n                            <p className=\"text-sm text-muted-foreground\">Negativo</p>\n                          </CardContent>\n                        </Card>\n                      </div>\n\n                      {sentimentMutation.data.topics && (\n                        <Card>\n                          <CardHeader>\n                            <CardTitle className=\"text-lg\">Tópicos Principais</CardTitle>\n                          </CardHeader>\n                          <CardContent>\n                            <div className=\"flex flex-wrap gap-2\">\n                              {sentimentMutation.data.topics.map((topic: string, index: number) => (\n                                <Badge key={index} variant=\"outline\">{topic}</Badge>\n                              ))}\n                            </div>\n                          </CardContent>\n                        </Card>\n                      )}\n\n                      {sentimentMutation.data.summary && (\n                        <Card>\n                          <CardHeader>\n                            <CardTitle className=\"text-lg\">Resumo da Análise</CardTitle>\n                          </CardHeader>\n                          <CardContent>\n                            <p className=\"whitespace-pre-line\">{sentimentMutation.data.summary}</p>\n                          </CardContent>\n                        </Card>\n                      )}\n                    </>\n                  )}\n                </div>\n              ) : (\n                <div className=\"flex flex-col items-center justify-center h-[300px] text-muted-foreground\">\n                  <MessageSquare className=\"h-12 w-12 mb-4 opacity-50\" />\n                  <p>Clique em \"Analisar\" para realizar análise de sentimento</p>\n                  <p className=\"text-sm mt-2 text-center max-w-md\">\n                    Analise o sentimento de notícias e posts de mídias sociais sobre partidos e candidatos.\n                    Esta funcionalidade aceita dados externos para análise automatizada.\n                  </p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":44169,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"docker-compose.yaml":{"content":"version: \"3.8\"\n\nservices:\n  db:\n    container_name: simulavoto-db\n    image: pgvector/pgvector:pg16\n    ports:\n      - \"5433:5432\"\n    environment:\n      - POSTGRES_DB=simulavoto\n      - POSTGRES_USER=simulavoto\n      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}\n    volumes:\n      - simulavoto_pgdata:/var/lib/postgresql/data\n      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/01-init.sql\n    restart: unless-stopped\n    networks:\n      - simulavoto-net\n    logging:\n      driver: \"json-file\"\n      options:\n        max-size: \"10m\"\n        max-file: \"3\"\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U simulavoto -d simulavoto\"]\n      interval: 10s\n      timeout: 5s\n      retries: 10\n      start_period: 60s\n\n  simulavoto:\n    container_name: simulavoto\n    build:\n      context: .\n      dockerfile: Dockerfile\n    ports:\n      - \"5000:5000\"\n    depends_on:\n      db:\n        condition: service_healthy\n    environment:\n      - NODE_ENV=production\n      - PORT=5000\n      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}\n      - SESSION_SECRET=${SESSION_SECRET}\n      - OPENAI_API_KEY=${OPENAI_API_KEY:-}\n      - RESEND_API_KEY=${RESEND_API_KEY:-}\n    restart: unless-stopped\n    networks:\n      - simulavoto-net\n    logging:\n      driver: \"json-file\"\n      options:\n        max-size: \"10m\"\n        max-file: \"3\"\n    healthcheck:\n      test: [\"CMD\", \"wget\", \"--no-verbose\", \"--tries=1\", \"--spider\", \"http://localhost:5000/api/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 120s\n\nnetworks:\n  simulavoto-net:\n    driver: bridge\n\nvolumes:\n  simulavoto_pgdata:\n    driver: local\n","path":null,"size_bytes":1620,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1534,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    // Build URL from query key\n    // If the last element is an object, treat it as query params\n    let url: string;\n    const lastElement = queryKey[queryKey.length - 1];\n    \n    if (typeof lastElement === 'object' && lastElement !== null && !Array.isArray(lastElement)) {\n      // Last element is a params object\n      const basePath = queryKey.slice(0, -1).join(\"/\");\n      const params = new URLSearchParams();\n      for (const [key, value] of Object.entries(lastElement)) {\n        if (value !== undefined && value !== null && value !== '') {\n          params.append(key, String(value));\n        }\n      }\n      const queryString = params.toString();\n      url = queryString ? `${basePath}?${queryString}` : basePath;\n    } else {\n      // No params object, just join all parts\n      url = queryKey.join(\"/\") as string;\n    }\n    \n    const res = await fetch(url, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":2197,"size_tokens":null},"replit.md":{"content":"# SimulaVoto - Sistema de Simulação Eleitoral Brasileiro\n\n## Overview\nSimulaVoto is a comprehensive web system designed to simulate Brazilian proportional electoral results according to the TSE system. It calculates electoral quotients, distributes seats using the D'Hondt method, incorporates AI-powered predictions, provides role-based access control, and maintains a full audit trail. The project aims to offer advanced analytical capabilities for electoral data, including real-time import monitoring, automated report generation, AI-driven data validation, and predictive modeling for future elections. It targets market potential in political analysis, academic research, and electoral campaign strategizing by providing detailed insights, scenario analysis, and robust data management.\n\n## User Preferences\n- Usar TypeScript em todo o código\n- Seguir padrões do shadcn/ui para componentes\n- Validação com Zod schemas\n- Design institucional inspirado no TSE (cores: #003366 azul, #FFD700 dourado)\n- Suporte a tema claro/escuro\n\n## System Architecture\nThe application is built with a React + Vite + TailwindCSS + shadcn/ui frontend, an Express.js + TypeScript backend, and PostgreSQL with Drizzle ORM for the database. Authentication is handled via `passport-local` and `express-session`, implementing Role-Based Access Control (RBAC) with `admin`, `analyst`, and `viewer` roles.\n\n**Key Features and Implementations:**\n- **Electoral Calculation:** Implements the Brazilian proportional electoral system, including electoral quotient, party quotient, initial seat distribution, and D'Hondt method. Supports Federations and Coalitions.\n- **Data Import System:** Robust CSV import from TSE URLs with streaming, real-time progress updates via WebSockets, and re-processing of failed batches. Batch tracking with original file row indices for accurate audit trails. All three import types (PARTIDO, DETALHE, CANDIDATO) use consistent duplicate checking and row tracking. Includes an enhanced IBGE import system with detailed error reporting, real-time progress, and cancel/restart capabilities.\n  - **Dynamic CSV Format Detection:** The TSE changed CSV formats across election years. The system auto-detects column count and applies appropriate field mappings:\n    - **PARTIDO (votacao_partido_munzona):**\n      - Legacy (≤23 cols): 2010 and earlier - minimal structure\n      - Intermediate (24-30 cols): 2002-2014 - has coligação but NO federation (28 cols)\n      - Modern (>30 cols): 2018-2022+ - has federation fields (36-38 cols)\n    - **CANDIDATO (votacao_candidato_munzona):**\n      - Legacy (≤38 cols): 2002-2014 - NO julgamento/cassação fields, NO federation (38 cols)\n      - Modern (>38 cols): 2018-2022+ - has julgamento/cassação and federation fields (50 cols)\n    - **DETALHE (detalhe_votacao_munzona):** Consistent 47-column format across all years (2014-2022)\n- **AI-Powered Data Validation:** Integrates GPT-4o for quality scoring, risk assessment, and recommendations on imported data, alongside deterministic checks.\n- **Automated Reporting:** System for creating, scheduling, and generating reports (CSV/PDF) with various frequencies and types, supporting email delivery.\n- **Electoral Predictions & AI Insights:** Utilizes Monte Carlo simulations, historical trend analysis, and AI-generated narratives. Includes advanced predictive analytics for voter turnout, candidate success, and party performance, with new prediction types like Candidate Comparison, Event Impact, and What-If Scenarios.\n- **Semantic Search:** Implemented with `pgvector` for natural language queries on electoral data, using OpenAI `text-embedding-3-small` for embeddings.\n- **Dashboard & Analytics:** Interactive dashboard with a map of Brazil, consolidated metrics, and import status. Advanced analytics with customizable reports, historical comparisons, trend analysis, anomaly detection, and custom dashboards.\n- **System Administration:** Admin panel with database statistics, reset options, and detailed error reporting.\n- **Audit Trail:** Comprehensive logging of all user operations and system changes.\n- **UI/UX:** Adherence to shadcn/ui patterns, institutional design inspired by TSE colors, and support for light/dark themes.\n- **External Data Integration:** Real-time integration with external news sources (Google News RSS, NewsAPI) and social media (Twitter/X) for article enrichment and sentiment analysis.\n- **Advanced Sentiment Analysis:** Comprehensive system with multi-source data aggregation, GPT-4o powered analysis, entity-level tracking, interactive word clouds, temporal evolution charts, and multi-entity comparison. Includes a crisis alert system with severity levels and notifications.\n- **AI Suggestions System:** GPT-4o powered suggestions for charts, reports, and insights.\n- **Real-time Notification System:** In-app notifications with WebSocket delivery and email alerts for critical events.\n- **Campaign Insights AI Module:** AI-powered module for campaign strategy analysis including high-impact segment identification, message strategy generation, campaign impact prediction, and executive report generation.\n- **Campaign Management Module:** Comprehensive management with team roles, calendar visualization, AI-powered KPI goal tracking, and activity assignment.\n\n## External Dependencies\n- **OpenAI:** GPT-4o for AI integrations (validation, insights, sentiment, predictions, suggestions) and `text-embedding-3-small` for semantic search.\n- **Resend:** For sending automated reports and email alerts.\n- **PostgreSQL:** Primary database.\n- **Drizzle ORM:** Object-Relational Mapper.\n- **Passport.js (passport-local):** Authentication strategy.\n- **Bcrypt:** Password hashing.\n- **Express.js:** Web application framework.\n- **React, Vite, TailwindCSS, shadcn/ui:** Frontend development stack.\n- **csv-parse:** CSV parsing for data imports.\n- **pgvector:** PostgreSQL extension for vector similarity search.","path":null,"size_bytes":5952,"size_tokens":null},"server/replit_integrations/batch/utils.ts":{"content":"import pLimit from \"p-limit\";\nimport pRetry from \"p-retry\";\n\n/**\n * Batch Processing Utilities\n *\n * This module provides a generic batch processing function with built-in\n * rate limiting and automatic retries. Use it for any task that requires\n * processing multiple items through an LLM or external API.\n *\n * USAGE:\n * ```typescript\n * import { batchProcess, isRateLimitError } from \"./replit_integrations/batch\";\n *\n * const results = await batchProcess(\n *   artworks,\n *   async (artwork) => {\n *     // Your custom LLM logic here\n *     const response = await openai.chat.completions.create({\n *       model: \"gpt-5.1\",\n *       messages: [{ role: \"user\", content: `Categorize: ${artwork.name}` }],\n *       response_format: { type: \"json_object\" },\n *     });\n *     return JSON.parse(response.choices[0]?.message?.content || \"{}\");\n *   },\n *   { concurrency: 2, retries: 5 }\n * );\n * ```\n */\n\nexport interface BatchOptions {\n  /** Max concurrent requests (default: 2) */\n  concurrency?: number;\n  /** Max retry attempts for rate limit errors (default: 7) */\n  retries?: number;\n  /** Initial retry delay in ms (default: 2000) */\n  minTimeout?: number;\n  /** Max retry delay in ms (default: 128000) */\n  maxTimeout?: number;\n  /** Callback for progress updates */\n  onProgress?: (completed: number, total: number, item: unknown) => void;\n}\n\n/**\n * Check if an error is a rate limit or quota violation.\n * Use this in custom error handling if needed.\n */\nexport function isRateLimitError(error: unknown): boolean {\n  const errorMsg = error instanceof Error ? error.message : String(error);\n  return (\n    errorMsg.includes(\"429\") ||\n    errorMsg.includes(\"RATELIMIT_EXCEEDED\") ||\n    errorMsg.toLowerCase().includes(\"quota\") ||\n    errorMsg.toLowerCase().includes(\"rate limit\")\n  );\n}\n\n/**\n * Process items in batches with rate limiting and automatic retries.\n *\n * @param items - Array of items to process\n * @param processor - Async function to process each item (write your LLM logic here)\n * @param options - Concurrency and retry settings\n * @returns Promise resolving to array of results in the same order as input\n *\n * @example\n * // Process CSV artwork data with custom categorization\n * const categorized = await batchProcess(\n *   csvRows,\n *   async (row) => {\n *     const response = await openai.chat.completions.create({\n *       model: \"gpt-5.1\", // the newest OpenAI model\n *       messages: [{ role: \"user\", content: `Categorize artwork: ${row.name}` }],\n *       response_format: { type: \"json_object\" },\n *     });\n *     return { ...row, category: JSON.parse(response.choices[0]?.message?.content || \"{}\") };\n *   }\n * );\n */\nexport async function batchProcess<T, R>(\n  items: T[],\n  processor: (item: T, index: number) => Promise<R>,\n  options: BatchOptions = {}\n): Promise<R[]> {\n  const {\n    concurrency = 2,\n    retries = 7,\n    minTimeout = 2000,\n    maxTimeout = 128000,\n    onProgress,\n  } = options;\n\n  const limit = pLimit(concurrency);\n  let completed = 0;\n\n  const promises = items.map((item, index) =>\n    limit(() =>\n      pRetry(\n        async () => {\n          try {\n            const result = await processor(item, index);\n            completed++;\n            onProgress?.(completed, items.length, item);\n            return result;\n          } catch (error: unknown) {\n            if (isRateLimitError(error)) {\n              throw error; // Rethrow to trigger p-retry\n            }\n            // For non-rate-limit errors, abort immediately\n            throw new pRetry.AbortError(\n              error instanceof Error ? error : new Error(String(error))\n            );\n          }\n        },\n        { retries, minTimeout, maxTimeout, factor: 2 }\n      )\n    )\n  );\n\n  return Promise.all(promises);\n}\n\n/**\n * Process items sequentially with SSE progress streaming.\n * Use this when you need real-time progress updates to the client.\n *\n * @param items - Array of items to process\n * @param processor - Async function to process each item\n * @param sendEvent - Function to send SSE events to the client\n * @param options - Retry settings (concurrency is always 1 for sequential)\n */\nexport async function batchProcessWithSSE<T, R>(\n  items: T[],\n  processor: (item: T, index: number) => Promise<R>,\n  sendEvent: (event: { type: string; [key: string]: unknown }) => void,\n  options: Omit<BatchOptions, \"concurrency\" | \"onProgress\"> = {}\n): Promise<R[]> {\n  const { retries = 5, minTimeout = 1000, maxTimeout = 15000 } = options;\n\n  sendEvent({ type: \"started\", total: items.length });\n\n  const results: R[] = [];\n  let errors = 0;\n\n  for (let index = 0; index < items.length; index++) {\n    const item = items[index];\n    sendEvent({ type: \"processing\", index, item });\n\n    try {\n      const result = await pRetry(\n        () => processor(item, index),\n        {\n          retries,\n          minTimeout,\n          maxTimeout,\n          factor: 2,\n          onFailedAttempt: (error) => {\n            if (!isRateLimitError(error)) {\n              throw new pRetry.AbortError(\n                error instanceof Error ? error : new Error(String(error))\n              );\n            }\n          },\n        }\n      );\n      results.push(result);\n      sendEvent({ type: \"progress\", index, result });\n    } catch (error) {\n      errors++;\n      results.push(undefined as R); // Placeholder for failed items\n      sendEvent({\n        type: \"progress\",\n        index,\n        error: error instanceof Error ? error.message : \"Processing failed\",\n      });\n    }\n  }\n\n  sendEvent({ type: \"complete\", processed: items.length, errors });\n  return results;\n}\n\n","path":null,"size_bytes":5593,"size_tokens":null}},"version":2}